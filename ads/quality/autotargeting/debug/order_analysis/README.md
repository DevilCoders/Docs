# Краткий обзор
Скрипт позволяет посмотреть:
- Покрытие баннеров индексом СМ
- Воронку показов (сколько рассматривали баннеров в СМ, сколько отобрала СМ, сколько выиграло аукцион)
- Кому проигрывают баннера кампании на стадиях отбора Садовой Машины и аукциона
- Самые частые и редкие запросы, на которых мы проигрываем
- Характеристики баннеров-победителей и проигравших
- Статистику и примеры баннеров по запросам, на которых показался баннер из СМ с более низким ```PExact``` по сравнению с другими кандидатами кампании



# Как запустить  
- Откройте консоль и перейдите в папку со скриптом ```order_analysis.py```
- Соберите проект с помощью команды ```ya make```. Инструкция по установке ```ya```: https://docs.yandex-team.ru/devtools/intro/quick-start-guide#ya-setup
- Запустите файл ```order_analysis``` в консоли с нужными параметрами. Например: ```./order_analysis --order_id 159706246 --read_results --use_index_coverage --use_funnel --query_text "алиэкспресс|ali|али"```



# Параметры

### Как задать (в порядке убывания приоритета)
1. Через аргументы в консоли при вызове. Пример: ```./order_analysis --order_id 12345678```.
2. Через поля структуры в файле ```config.json```. Пример: ```"order_id": 12345678```.
3. Через значения переменных окружения. Работает не для всех параметров. См. названия нужных переменных в полях ```env``` параметров из ```config_settings.json```.
4. Через значения по-умолчанию (поля ```default_value```) из ```config_settings.json```.

### Значения параметров
- ```cluster``` - название кластера
- ```token``` - ваш YQL токен для выполнения запросов
- ```token_path``` - путь до YQL токена (можно не указывать, если вы явно задали ```token```)
- ```start_date``` - начальная дата по МСК для анализа (включительно)
- ```finish_date``` - конечная дата по МСК для анализа (включительно)
- ```order_id``` - БК ID кампании
- ```query_text``` - шаблон для текста запроса для [Hyperscan::Grep()](https://yql.yandex-team.ru/docs/yt/udf/list/hyperscan#grep), по которому будут подбираться запросы. Чтобы получить все запросы, оставьте пустую строку (значение по-умолчанию). Если нужно использовать несколько выражений, перечислите их через знак ```"|"```. Например: ```"алиэкспресс|ali|али"```
- ```result_folder``` - папка, в которой будут сохрянятся результаты работы скрипта и выжимки из логов
- ```generate_squeezes``` - считать ли выжимки из логов за выбранный период. Они обязательны для анализа, но считаются несколько часов, поэтому лучше сгенерировать их один раз и далее использовать уже готовые результаты
- ```read_results``` - флаг для использования посчитанных данных. Удобно использовать, когда ответ уже посчитан, но хочется посмотреть на результат в интерфейсе YQL, а не YT. Для перехода к YQL используйте ссылку из раздела "PROGRESS" во время выполнения скрипта.
- ```use_index_coverage```, ```use_funnel```, ```use_adv_losses```, ```use_auction_losses```, ```use_inexact_impressions``` - флаги для использования определенных вкладок
- ```banner_limit"``` - сколько баннеров выводить в топах по запросу (колонки ```Winners```, ```Losers```, ```Cands``` и т.д.)

Типы данных и значения по-умолчанию можно посмотреть в ```config_settings.json```.



# Рабочие вкладки #

### Result Path
Путь до папки с результатами вычислений

### Index Coverage
Показывает покрытие баннеров кампании Садовой Машиной

1. ```Banners```- кол-во баннеров, которые есть у кампании
2. ```InIndex``` - кол-во баннеров, которые есть в СМ
3. ```Coverage``` - доля баннеров, которые есть в СМ

### Funnel
Данные отсюда нужны для построения воронки баннеров от отбора СМ до показа. Учтите, что **в СМ логируются не все запросы**, поэтому полученные числа будут гораздо меньше, чем реальное кол-во запросов!

1. ```Day``` - дата в формате YYYY-MM-DD
2. ```TotalHits``` - кол-во запросов, по которым СМ рассматривала баннера кампании
3. ```PassedAdvHits``` - кол-во запросов, по которым прошел хотя бы один баннер кампании
4. ```PassedAuctionHits``` - кол-во запросов, по которым хотя бы один баннер выиграл аукцион (т.е. был показ)

### AdvMachine Losses Types Stats
Статистика по проигрышам в Садовой за указанный период.

1. ```TotalHits``` - как во вкладке ```Funnel```, только для за весь период
2. ```PassedAdvHits``` - как во вкладке ```Funnel```, только для за весь период
3. ```PassedAuctionHits``` - как во вкладке ```Funnel```, только для за весь период
4. ```TotalLost``` - всего проигрышей (уникальных ```SearchRequestID```) в Садовой
5. ```LostWorseExact``` - всего проигрышей типа ```LostWorseExact``` (у всех кандидатов кампании ```PExact``` хуже, чем у победителей)
6. ```LostButBetterExact``` - всего проигрышей типа ```LostButBetterExact``` (есть хотя бы один кандидат кампании с лучшим ```PExact```, чем у победителей)

### AdvMachine Losses Types Sample
Вкладка для сравнения баннеров-победителей на этапе отбора Садовой с баннерами кампании, не прошедшими отбор. Запросы отсортированы по убыванию ```LosingFreq```, баннера в колонках ```Winners``` и ```Losers``` отсортированы по убыванию ```PExact```.

1. ```SearchQuery``` - текст поискового запроса
2. ```TotalHits``` - как во вкладке ```Funnel```, только для конкретного запроса
3. ```PassedAdvHits``` - как во вкладке ```Funnel```, только для конкретного запроса
4. ```PassedAuctionHits``` - как во вкладке ```Funnel```, только для конкретного запроса
5. ```Type``` - тип проигрыша: ```LostWorseExact``` или ```LostButBetterExact```
6. ```LosingFreq``` - частота проигрышей по данному запросу
7. ```Winners``` - баннера, которые прошли отбор СМ
8. ```Losers``` - баннера кампании, которые не прошли отбор

##### Возможные поля у баннеров
- ```OrderID``` - ID кампании
- ```BannerTitle``` - заголовок баннера
- ```BannerText``` - текст баннера
- ```BannerURL``` - URL баннера
- ```PBroad``` - средняя вероятность того, что баннер имеет категорию ```BROAD```
- ```PExact``` - средняя вероятность того, что баннер имеет категорию ```EXACT```
- ```Phrase``` - фраза, по которой подобрался баннер
- ```SimDistance``` - номер алгоритма отбора рекламы
- ```ContextType``` - тип таргетинга: 1 - фразы, 3 - синонимы, 11 - автотаргетинг, 7 - ДО.
- ```SourceCost``` - исходная ставка баннера в аукционе в рублях
- ```RealCost``` - реальная ставка баннера в аукционе в рублях 

### Auction Losses Types Stats
Аналогично вкладке ```AdvMachine Losses Types Sample```, только для стадии Аукциона

### Auction Losses Types Sample
Аналогично вкладке ```AdvMachine Losses Types Sample```, только для стадии Аукциона

### Inexact Queries Stats
Статистика по запросам, на которых показался баннер из СМ с более низким ```PExact``` по сравнению с другими кандидатами **нашей кампании**.

1. ```TotalQueries``` - кол-во запросов, по которым был показ баннера кампании из СМ
2. ```InexactQueries``` - кол-во запросов, по которым был показан баннер кампании из СМ с более низким ```PExact```, чем у других кандидатов
3. ```InexactShare``` - отношение ```InexactQueries``` к ```TotalQueries```
   
### Inexact Queries Sample
Примеры баннеров по неточным запросам.

1. ```SearchQuery``` - текст запроса
2. ```PExactDelta``` - максимальная разница по PExact между более подходящим кандидатом и показанным баннером
3. ```ImpBanners``` - данные показанного баннера
4. ```Cands``` - данные более подходящих кандидатов