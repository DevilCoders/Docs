## Запуск скрипта
Скрипт позволяет удалять из базы/редактировать/искать в базе хинты или ханипоты. Для запуска скрипта нужно собрать его при помощи `ya make`, выбрать режим работы с через `--mode` и заполнить конфиг для соответствующего режима работы.

Примеры запуска:

`./edit_honeypots --mode edit --verbose --conf edit_honeypots_at.conf`

`./edit_honeypots --mode remove --conf edit_honeypots_at.conf --rewrite-base`

`./edit_honeypots --mode recalc_at_skill --conf edit_honeypots_hp_at.conf`


## Описание параметров
* `--yt_token` - токен для записи в таблицу на yt, по умолчанию `{user}_ml_engine_app_token`
* `--quota` - квота в нирване, по умолчанию `ads`
* `--no_start` - создать граф, но не запускать его
* `--verbose` - вывести найденные/удаленные/отредактированные ханипоты
* `--mode` - режим работы скрипта, `find`, `edit`, `remove`, `recalc_at_skill` для указанного режима должны быть прописаны параметры в конфиге
* `--rewrite-base` - явная команда перезаписать продовую базу ханипотов
* `--conf` - путь к файлу с конфигом

## Про базы хинтов и ханипотов
Элементы базы выглядят примерно так
```
  {
    "inputValues": {
      "bannerText": "зарядные устройства по низким ценам яндекс маркет оплачивайте баллами плюса",
      "bannerTitle": "зарядные устройства по низким ценам яндекс маркет",
      "exactMatch": false,
      "phrase": "зарядное устройство цена",
      "region": "Екатеринбург",
      "request": "зарядка для ноутбука lenovo купить",
    },
    "knownSolutions": [
      {
        "outputValues": {
          "match": "yes"
        }
      }
    ]
  },
```
В `inputValues` лежат поля со входными параметрами для ханипота (для каждого задания свой набор полей), в `knownSolutions` список `outputValues` правильных ответов на ханипот. Во всех наших заданиях на ханипот бывает только один правильный ответ, сейчас скрипт работает корректно на ханипотах с одним правильным ответом. Для базы хинтов кроме `inputValues` и `knownSolutions` добавится еще поле `hint` с комментарием к правильному ответу.

При редактировании баз хинтов и ханипотов мы перезаписываем продовые базы. Поэтому рекомендуется сначала посмотреть на то, как будет выглядеть ханипот после редактирования, а уже потом потом перезаписывать базу. Для этого можно запустить скрипт с `--verbose`, но без `--rewrite-base`, тогда вам покажется отредактированный ханипот, но база не перепишется. Перепишется только при явном указании `--rewrite-base`.

Еще один тнкий момент: в янге базы хинтов и ханипотов отличаются только наличием в базе хинтов специального поля, в котором хранится подсказка. Поэтмоу при редактировании хинтов очень важно указать в конфиге `hint_field` - название поля, в котором лежит подсказка. Если этого не сделать, граф упадет при попытке перезаписать базу хинтов без подсказок, превратив ее этим в базу ханипотов.

## Конфиг

### Общая часть
* `honeypots_base_name` - название базы, в которую редактируем
* `hint_field` - название поля с хинтом, нужно указывать при редактировании базы хинтов, если не указать, база не перезапишется

### Режим find
```
find:
  table_name: //home/bs/users/vechkasova/tmp/find_honeypots
  hp1:
    key_str: _.inputValues.phrase.toLowerCase().contains("цена")
```
В конфиге можно указать несколько ключей для каждой группы ханипотов, которую хотим найти (в примере один ключ `hp1`).
`key_str` - выражение для поиска ханипота на `groovy`. Тут https://wiki.yandex-team.ru/hitman/nirvana/json/#groovyjsonfilter можно подробнее почитать про синтаксис выражения.

В примере ищем все ханипоты, у которых во фразе из входных данных есть слово "цена".

`table_name` - если указать, в табличку по адресу запишутся ханипоты, которые были найдены.

Еще пример `key_str`, для автотаргетинга ищем все ханипоты, в которых в `broad` выбрано больше одной галки:

`_.knownSolutions[0].outputValues.keySet().size() > 2`

### Режим remove
Структура такая же, как и для `find`, только найденные ханипоты будут удалены их базы. Можно указать `table_name`.

### Режим edit
Структура такая же, как для `find` и `remove`, но добавляются еще поля `inputValues`, `outputValues` и `hint` с информацией для редактирования
* `key_str` - для редактирвания по выражению должен быть найден единственный ханипот, а не группа, как в других режимах
* `table_name` - для этого режима для каждого исправленного ханипота запишет его старые и новые значения `inputValues`, `knownSolutions` и `hint`
* `inputValues`
```
inputValues:
  region: Будапешт
```
можно указать любое поле из `inputValues` и его новое значение. Поля, не указанные в конфиге, останутся без изменений.
* `outputValues`
```
outputValues:
  estimation: broad
  competitor: true
```
для `outputValues` нужно указывать весь ответ на ханипот, `outputValues` полностью перезапишется.
* `hint`, `hint: Новое пояснение для этого ханипота`, подсказка перезапишется

### Режим recalc\_at\_skill
Для автотаргетинга мы сами считаем навык качества на ханипотах и можем его пересчитать в прошлое после исправления/удаления ханипотов. В этом режиме запустится `yql` для пересчета навыка.
```
recalc_at_skill:
    mode: edit
    fixed_hp_table: //home/bs/users/vechkasova/tmp/edited_at_honeypots
    skill_hp_table: //home/bs/users/vechkasova/assessors/autotargeting/quality_skill/honeypot_answers
    tmp_table: //home/bs/users/vechkasova/tmp/test_recalc_skill
```
* `mode` - после удаления или после редактирования нужно пересчитать навык, варианты `edit` и `remove`
* `skill_hp_table` - таблица, в которой лежат ответы всех асессоров на все ханипоты для вычисления навыка
* `fixed_hp_table` - таблица с удаленными/исправленными ханипотами, если указать `table_name` в соответствующих режимах, запишет табличку в нужном формате
* `tmp_table` - параметр для тестового запуска. Если указать, табличка с пересчитанными ответами на ханипоты запишется по указанному адресу, если нет, перепишется продовая табличка для пересчета навыка.
