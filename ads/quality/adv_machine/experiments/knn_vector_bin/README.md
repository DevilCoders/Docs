=== Устройство

Индекс состоит из двух частей: компакт вектора и непосредственно hnsw-файлы

Компакт-вектор -- это сущность, которая сохраняет эмбеды ровно в определённом формате с определённым сжатием, а также их дедуплицирует. Хранит внутри прямой и обратный индекс ItemId -> DocIds. НЕ СОДЕРЖИТ BannerID. DocId -- это порядковый номер документа в таблице (номер строки с 0).

Hnsw-индекс работает только с компакт вектором. Больше ничего не использует из индекса.

=== Как собрать и пострелять

==== Собрать всё

`./ya make --install ../test_knn ./ads/quality/adv_machine/tools/test_knn ./ads/quality/adv_machine/mr_index/ ./ads/quality/adv_machine/experiments/knn_vector_bin/ ads/quality/adv_machine/cluster_tools/worker_tools/prepare -r`

В папке `../test_knn` окажутся необходимые бинари и конфиги

Про файлы:
* `build_mr.json` -- как сгенерировать таблицу BannerID -> Embeddings. Какие эмбеды брать из Цезаря, и какой шард взять за основу
* `indexer.json` -- конфиг, который в 99% случаев менять не придётся
* `daemon.json` -- часть конфига демона, где указано, какие компакт вектора и kNN'ки ожидает демон (и индексатор должен их построить)
* `build.sh` -- простой скрипт, который в нужном порядке вызывает стадии построения индекса. В идеале, нужно через кластер мастер запускать, но и так сойдёт

==== Поправить конфиги так, как вам нужно

В примере создаётся 3 кворума по одной моделе: флотовая, сжатая в [-1;1] и в кастомный интервал. CodeType == UNIFORM -- это тот, что в Движке и в Цезаре Uniform.

==== Подготовить патроны (примерно 10 минут)

Для кворум машины так: `./am_prepare_worker_shooting prepare-ammo-for-service -o ammo_quorums_machine.bin -c 10000 --service adv-machine-rsya-quorums-machine -vvv`

`-c 10000` -- это количество строк, сколько сохранить. Слишком большое количество указывать не надо, 10k запросов уже 2.4 Гб весят

TODO: если всё-таки нужно больше, можно поддержать режим выкидывания лишнего.

==== Построить kNN'ки (15-20 минут на подготовку таблицы с векторами + минут 10-15 на построение kNN)

Можно так: `YT_POOL=ads-research bash ./build.sh`

Важно: при повторном запуске, если не нужно перегенерировать таблицу с векторами (например, только параметры сжатия в компакт векторе тюните), можно закомментировать `./test_knn prepare-dataset ...` в скрипте. Так сэкомите минут 15-20.

==== Скачать файлы

Можно так: `bash ./download.sh //home/advquality/users/$USER/test_hnsw/TestTier`

Появится папка `./0`, а в ней `compact_vectors` и `quorums`

==== Пострелять и получить отчёт

```
./am_knn_vector shoot-banner-hnsw \
    --shard-path ./0 \
    --ammo-path ~/ammos/ammo_quorums_machine.bin \
    --stage-name "Knn_1" \ // откуда брать QuorumID, QuorumSize и другие параметры. Смотри daemon.json
    --daemon-config-path ./daemon.json \
    --dst-report ./report.json
```

В `./report.json` будет JSON'ина такого вида:

```
{
    "Queries": [
        {
            "Docs": [
                {
                    "DocId": 1234,
                    "Dist": 0.456
                }
            ],
            "DoSeconds": 0.123
        }
    ]
}
```

`DoSeconds` -- это сколько времени выполнялся запрос. Первые N могут долго выполняться, пока кеши не разогреются.
