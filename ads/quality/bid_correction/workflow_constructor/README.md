# Примеры использования
## Обучить катбуст
`ads/quality/bid_correction/workflow_constructor$ ./workflow_constructor --mode cb --mx_task tasks/ab_conv/rsya/mx/rc.yml`

## Патчи
Можно наложить патчи на
- Все такси (опция `--tasks_patch` для одного патча или для списка через пробел)
- LM-таски (опция `--lm_tasks_patch`)
- MX-таски (опция `--mx_task_patch`)

В патч можно передать
- Строку, содержащую питоновский словарь
- Путь к yml-файлу
- Строку вида `$'k1.k2: v1\nk3.k4:v2'` (`$` нужен для того, чтобы bash правильно обработал перенос строки). Строка из примера будет проинтерпретирована как
```
k1:
  k2: v1
k3:
  k4: v2
```


## Указать диапазоны дат для обучения и валидации
- Ключ `days: <количество дней>` в yml-таске задаёт количество дней, которое нужно взять для обучения.
- Параметр командной строки `--last_log_date <дата в формате YYYY-MM-DD>` задаёт последний день в обучающем логе. По умолчанию возьмётся последний доступный лог.
- Параметр командной строки `--days_to_eval <количество дней>` задаёт количество дней для валидации (валидация начинается на следующий день после `--last_log_date`).

## Собрать матрикснетный пул
Для этого нужен режим `--mode mx_pools`.
Он принимает те же настройки, что и режим обучения матрикснета.
Единственное отличие -- опция `--save_pools_into` обязательна.

## Подать матрикснету кастомный пул
### 1. Использовать вместо JoinedYabar другие логи
Нужно указать по ключу `logs_mask` регулярку, которая подается на вход функции `get_logs_regexp_time()`.

### 2. Кастомное разбиение на трейн, валидацию и тест
(Внимание, дальше немного странный нейминг, который исторически сложился в workflow_constructor).

Нужно указать в yml-таске тип пула `final` (это значит, что не запускаются никакие мапперы или препроцессоры, а берется пул as is) и путь к четырем таблицам на YT:
```
pool:
  type: final
  train: //path/to/train
  test: //path/to/test
  train_next_days: //path/to/train_next_days
  test_next_days: //path/to/test_next_days
```
Семантика следующая. `train`/`test` -- это какое-нибудь псевдослучайное разбиение пула (например, по LogID, DomainID, etc.).
`next_days` означает, что эта часть пула -- из будущего.
С точки зрения нейминга, правильнее было бы объединить `train_next_days` и `test_next_days` и назвать это `test`,
а то что называется `test` в workflow_constructor назвать `validation`.

### 3. Подать в качестве логов произвольный yql-запрос
Достаточно указать в yml таске произвольный селект в секции `logs_yql_template`, обнулив при этом секцию `logs_mask`:
```
logs_mask: null
logs_yql_template: SELECT * FROM ...
```

## Переучить матрикснет из прода
Рекомендуемый способ -- использовать опцию `--mx_dump`, которая подхватит конфиг обучения матрикснета, сохранённый в процессе обучения в дамп на Sandbox (работает начиная с ревизии 5908580).

### Взять lmc из прода
Опция `--linear_set_id <ID>` означает "сгенерировать lmc из LinearSetID=<ID> и полученный результат подставить в таск матрикснета".
Можно комбинировать с опциями `--lm_tasks/--lm_slots`.

### Переобучить линейные модели, с которыми обучался прод
Для этого есть флаг `--get_lm_tasks_from_mx_dump`. Он работает так: если не указаны опции `--lm_tasks/--lm_slots` и указана опция `--mx_dump`, то взять `lm_tasks` и `lm_slots` из дампа.

## Запустить отбор признаков
Для отбора признаков используется алгоритм [CMICOT](https://wiki.yandex-team.ru/users/nstbezz/cmicot/).
Отбор признаков запускается почти с теми же опциями, что и обучение матрикснета, нужно поменять только `--mode feature_selection`.
Также можно указать дополнительные опции:
- `--cmicot_team_size` -- параметр алгоритма CMICOT.
- `--feature_selection_n_samples` -- сколько строк обучающего пула взять. Рекомендуется брать не очень много, несколько десятков тысяч.
- `--feature_selection_all_bt_counters` -- пропатчить секцию `lm_to_mx_dump` в конфиге матрикснета, добавив туда все существующие счётчики.
Это один их основных кейсов использования.
- `--feature_selection_n_free_slots` -- не использовать указанное количество слотов при генерации lmc.
- `--feature_selection_n_features` -- сколько фичей отобрать. По умолчанию равно количеству фичей в матрикснетной формуле.

## Отправить метрики в [Pulsar](pulsar.yandex-team.ru)
Сейчас метрики отправляются автоматически при указании опции `--save_pools_into <yt directory>`.
Для удобства можно указать `--pulsar_model_name` -- (короткое) имя модели, которое будет отображаться в интерфейсе.
Ещё есть опция `--pulsar_model_version`.

## Настроить мониторинг
Пример запуска мониторинга
`./workflow_constructor --mode monitoring --monitoring_task tasks/monitoring/bc/rsya/prgmg.yml --last_log_date 20191118 --schedule --prod`
Мониторинг будет пересчитан в прошлое, начиная с `--last_log_date`

## Запустить расчёт метрик для дебага проблемных заказов/пейджей/...

Если нужно посчитать метрики на срезе, которого нет в мониторинге,
можно запустить граф мониторинга из консоли.
Для ABConversion рекомендуется добавить нужный патч
в `tasks/monitoring/ab_conv/manual_run_patch.yml`
и запустить команду вида
```
./workflow_constructor --mode monitoring --monitoring_task tasks/monitoring/ab_conv/rsya/manual_run.yml --last_log_date 20210516 --no_graphite
```

Анализировать полученный результат можно из консоли, например так:
```
wget --header "Authorization: OAuth $NIRVANA_TOKEN" -O- https://nirvana.yandex-team.ru/api/ui/resultItem/6275de11-35ce-4df9-a652-602820c5e95b/64c94167-68f5-49b7-87bf-f961151898fc/data 2> /dev/null | grep 'mx.0' | grep OrderID
```

## Запустить eval feature
Eval feature запускается почти с теми же опциями, что и обучение матрикснета, нужно поменять только `--mode eval_feature`.
Также можно указать дополнительные опции:
- `--factors_to_test` -- какие фичи тестировать (через запятую). По умолчанию тестируются все фичи в формуле. Тестировать можно и те фичи, которых нет в формуле.
- `--how_to_test` -- способ тестировать фичу (по умолчанию `SEQ_ADD_WHOLE`)
  - `WHOLE_RANGE`: все факторы вместе
  - `SEQ_ADD`: каждый фактор по отдельности, остальные заигнорены
  - `SEQ_ADD_WHOLE`: комбинация двух предыдущих
  - `SEQ_REMOVE`: каждый фактор по отдельности, остальные __не__ заигнорены
- `--eval_feature_lm_param_grid`: yml-конфиг с сеткой параметров для линейной модели (см. ниже)

### Как задать большой диапазон факторов
Если факторов много, но они названы единообразно, то можно сгенерировать список факторов башем:
```
./workflow_constructor --mode eval_feature --factors_to_test $(seq -s, -f"FSomePrefix%g" 0 292)
```

### Перебор параметров линейных моделей по сетке
В режиме `eval_feature` можно подать на вход конфиг для линейной модели или YQL-счётчика (опция `--lm_tasks`)
и сетку параметров (опция `--eval_feature_lm_param_grid`).
Для каждой комбинации параметров сетки будет "спирально" обучена линейная модель,
для которой затем будут измерены попугаи.
Пример:
- [Конфиг линейной модели (YQL-счётчика)](https://a.yandex-team.ru/arc/trunk/arcadia/ads/quality/bid_correction/workflow_constructor/tasks/users/serkh/base_yql_booster.yml?rev=7222099)
- [Сетка параметров](https://a.yandex-team.ru/arc/trunk/arcadia/ads/quality/bid_correction/workflow_constructor/tasks/users/serkh/yql_booster_param_grid.yml?rev=7222099). Для сетки параметров можно указывать алиасы для сложных значений через тег `!alias:<name>`.

## Запустить обучение несколько катбустов на одном и том же пуле
Иногда хочется выучить несколько катбустов, которые отличаются незначительными изменениями: заигнорированы несколько факторов,
изменены гиперпараметры и т.д, но обучаться которые будут на одних и тех же данных за одни и те же дни.
В теории, Нирвана должна автоматически поддерживать выполнение одинаковых операций с помощью своих кешей,
однако на практике часто бывает не так - особенно, если в каком-то блоке имеется общая ошибка и вы редактируете параметры кубика вручную.
Кроме того, не всегда удобно следить за множеством графов по отдельности.

Можно запустить несколько тасок катбуста, которые будут учиться на одном и том же пуле и находиться в одном графе.
При запуске необходимо указать режим `--mode cb_unification`. В качестве `--mx_task` должна быть указана таска,
которая будет участвовать при подготовке пула. В `--cb_updates` необходимо передать таски, которые переопределяют настройки катбуста
(указывать через запятую без пробела). Эти таски будут накладываться по одной по очереди на основную. Во избежание ошибок,
желательно чтобы все они включали `!include` основной таски. Чтобы потом уметь различать обученные катбусты между собой,
можно в каждой таске определить свой уникальный `task_id`.

Пример:
```
~/arcadia/ads/quality/bid_correction/workflow_constructor/workflow_constructor \
--mode cb_unification \
--mx_task catboost.yml \
--cb_updates task1.yml,task2.yml,task3.yml
```

# Тестирование yml-тасок
## Как запустить
В директории `workflow_constructor` вызвать команду `ya make -rttt --checkout`
## Что тестируется
Тесты автоматически запускаются на все таски из "продакшн"-директорий.
Продакшеном считаются директории с конфигами катбустов и линейных моделей:
- `bc/vw/search`
- `bc/mx/search`
- `bc/vw/rsya`
- `bc/mx/rsya`
- `ab_conv/search/lm`
- `ab_conv/search/lm/counters`
- `ab_conv/search/mx`
- `ab_conv/rsya/lm`
- `ab_conv/rsya/lm/counters`
- `ab_conv/rsya/mx`

Если нужно добавить таск, который не нужно регулярно тестировать
(это обычно нужно для исследований), то рекомендуется этот таск добавлять не в
продакшн-директорию, а в свою директорию в `tasks/users`.
Альтернативный вариант -- назвать файл таска начиная с нижнего подчеркивания.

## Виды тестов
Есть два вида тестов
- **Канонические тесты**. Проверяют, что yml-конфиг не поменялся, падают при любом изменении.
Такие тесты нужны, чтобы избежать ненамеренных изменений в продакшн-тасках.
Если изменения ожидаемые, то их можно "принять", переканонизировав тесты командой `ya make -rttt -Z`.
- **Тесты на код внутри тасок**. Обычно в тасках есть описание мапперов и препроцессоров, которые нужно запускать при обработке данных.
Есть тесты, которые пробуют создать все объекты, задекларированные в yml-конфиге.
**NB**: код берется из локального транка, не из ревизии, указанной по дефолту в `--arcadia_revision`.

Все подробности можно посмотреть в коде: `workflow_constructor/test_tasks`.



Разное:
Если нужно развернуть таску в полный yml:
[LINK](https://a.yandex-team.ru/arc/trunk/arcadia/ads/quality/bid_correction/task_dumper)
