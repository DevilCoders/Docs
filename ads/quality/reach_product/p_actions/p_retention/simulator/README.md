# Симулятор `p_retention`

Симулятор для вычисления `retention` (запоминаемости) рекламных кампаний. Реализуются 2 режима работы: 

- Подсчет статистики на реальных логах; 
- Генерация виртуальных логов с заданной стратегией показов и подсчет статистики по ним (этот режим в процессе разработки).

При вызове бинаря строится граф в Нирване, который возвращает `json` файл с результатами.

Как пользоваться: собираем [бинарник](bin), пишем конфиг, запускаем командой `./simulator --config-yaml conf.yaml`.

## Аргументы

Схема аргументов находится в [протобуфе](lib/args/conf.proto).
Некоторые опции имеют заданные дефолты, но любой параметр можно переопределить.
Аргументы можно задавать либо в конфиге, либо в командной строке.

Пример [конфига](bin/conf.yaml).

#### Расшифровка аргументов:

 - `mode [str][default=calculate]` - режим симулятора из двух возможных:

   + `calculate` - подсчет статистики на реальных логах из `table_directory`;
   + `simulate` - генерация виртуальных логов с разными стратегиями показов баннеров;


 - `logs_type [string][default=hour]` - тип обрабатывааемых логов:
   + `day` - дневные логи, время необходимо задавать в формате `%Y-%m-%d`;
   + `hour` - почасовые логи, врем необходимо задавать в формате `%Y-%m-%dT%H:00:00`;
   

 - `start_time [string]` - время начала подсчета статистики в формате часовых либо дневных логов в зависимости от `logs_type`;
 - `end_time [string]` - время окончания подсчета статистики в формате часовых либо дневных логов в зависимости от `logs_type` (`start_time` и `end_time` не должны совпадать);
 - `yt_owner [string]` - понятно по названию;
 - `segments [[int]]` - список (**непустой**) `id` сегментов, которые будут участвовать в подсчете;
 - `control [int]` - `id` сегмента-контроля;
 - `segments_function [string]` - тело `yql` лямбда-функции, которая делит показы на сегменты, получает на  вход `TableRow` и возвращает `id` сегмента для поданного показа (подставляется в [`yql`-скрипт](lib/vh/filter.yql));
 - `table_directory [string]` - адрес директории в кластере, где лежат необходимые логи;
 - `alpha_decay [float]` - период полураспада для параметра альфа, которой применяется как `alpha = ln(2) / alpha_decay`, сам параметр альфа применяется при подсчете `retention` в функции [retention](lib/retention/retention.py);
 - `beta_decay [float]` - период полураспада для параметра бета, которой применяется как `beta = ln(2) / beta_decay`, сам параметр бета применяется при подсчете `retention` в функции [retention](lib/retention/retention.py);
 - `gamma [float]` - параметр при подсчете `retention` в функции [retention](lib/retention/retention.py);
 - `confidence_interval [[float]]` - сетка из доверительных интервалов, на которых проводятся стат. тесты (если пользователь вводит пустую сетку, то берется дефолтная сетка из [`CONFIDENCE_INTERVAL`](lib/args/__init__.py));
 - `use_uniq_id [bool][default=false]` - флаг для использования `UniqID` в качестве поля `UserID`, если он равен `false`, то используется `CryptaIDv2`;
 - `filter_conditions [string]` - тело `yql` лямбда-функции, которая отфильтровывает необходимые показы, получает на  вход `TableRow` и возвращает `true` или `false` в зависимости от фильтрующих условий (подставляется в [`yql`-скрипт](lib/vh/filter.yql)).


## Help

Вопросы и предложения к [@vlyukshin](https://staff.yandex-team.ru/vlyukshin).


