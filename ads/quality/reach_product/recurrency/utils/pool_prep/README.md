# Скрипт для построения таргета для задача предсказания возврата пользователя

Работает по JoinedEFH-логам следующим образом:
* Разбиваем все нефродовые непоисковые показы по пользователям (берём только показы с нетривиальным `UniqID` / `CryptaIDv2`);
* Сортируем их по времени, причём если было несколько строчек с одним таймстемпом - то берём одну случайную;
* Для каждой строки генерируем несколько окон времени t из логнормального распределения, для каждого считаем все показы в окне с экспоненциальным распадом по времени.

Аргументы:
* `--end-date` - правая граница пула в формате `YYYYMMDD` (невключительная, т.е. если `end_date = 20210612`, по последняя дата в пуле будет `2021-06-11T23:59:59`);
* `--days` - размер пуля в днях;
* `--dst` - куда на YT сложить результат;
* `--user-id` - идентификатор пользователя (вообще можно любой подставить, но вряд ли получится что-то осмысленное на чём-то кроме `UniqID` или `CryptaIDv2`);
* `--user-id-denominator` - фича для прореживания пула - берём только пользователей, для которых `hash(user_id + salt) % denominator == 0`, т.е. грубо говоря выбираем `1 / user_id_denominator` долю пользователей;
* `--hash-salt` - соль из предыдущего пункта;
* `--target-lookahead-means` и `--target-lookahead-stds` - матожидания и стандартные отклонения (в секундах) логнормального распределения для генерации окон при подсчёте таргета, списки целых числе одинаковой длины;
* `--lookahead-max` - максимальный размер окна (в секундах), окна размером больше этого значения игнорируются и в пул не попадают;
* `--show-half-life` - период полураспада показа (в секундах);
* `--max-shows-users` - максимальное число показов для одного пользователя, все пользователи, у которых за указанны период показов больше будут проигнорированы. К сожалению, для построения таргета нужно держать все показы пользователя в памяти, и если брать слишком много - `reduce`-операция может упасть;
* `--yt-pool`, `--yt-job-weight` и `--reducer-data-weight` - спецификации операций: пул, вес операции и вес данных для одного `reduce`-джоба;
* `--no-sort` - по умолчанию выходная табличка будет посортирована по пользователю, времени показа и размеру окна; этот флаг отключает сортировку.
