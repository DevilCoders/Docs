# Считалка zC для охватного продукта, v2

Новая версия, которая на самом деле очень похожа на старую.
Отличия:
+ Умеет считать zC правильно - контроль против дефолта и эксперимент против дефолта, итоговое zC вычисляется как отношение;
+ Нет зависимости от бинарника `apc_check` (берём все нужные функции из библиотеки);
+ [Пока что] Не поддерживает локальный режим - умеет считать только в Sandbox;
+ [Пока что] Не считает деньги и соответственно, cost * zC. Причин две:
  + В первой версии метод расчёта погрешности `cost_d` был полностью взят из `exp_stats`, где он является, вообще говорят, довольно сомнительным;
  + Для ускорения расчётов zC оптимизировали построение табличек, пришлось отказаться от нужных для предыдущего пункта полей;

В целом эта версия быстрее и правильнее, а выпил подсчёта денег не кажется большой потерей - пока их можно брать из АБшницы, которая делает это правильно.
Впрочем, задача вернуть деньги сюда - первой важности.

Считает zc по методологии, описанной [тут](https://wiki.yandex-team.ru/bannernajakrutilka/targetinggroup/apccheck/).

Терминология:
+ Контроль == эталон - выборка без проверяемых изменений;
+ Эксперимент - выборка с проверяемыми изменениями;
+ Дефолт - неявная выборка, в которую попадает всё, что не попало в первые две.

Для охватного видео вся статистика берётся из VideoCompletes лога, поэтому для него поддерживаются следующие действия:
+ показ (`start`)
+ квартили (`q1`, `q2`, `q3`, `complete`)
+ скипы и размьюты (`skip`, `unmute`)
+ LClick (`lclick`)

Для медийки доступен только LClick, статистика берётся из JoinedEFH лога.

Аргументы для вычисления zC:
+ `--range` - даты, для которых считается zC, в формате YYYYMMDD[HH] (например 20210421 или 2021042113). Можно задавать:
  + интервал (`20210416..2021042012`), обе границы - включительные;
  + интервал без правой границы (`20210416..`) - интервал до текущего момента времени (сколько есть логов);
  + одну дату (если без часа - то берётся весь день, иначе только указанный час);
+ `--product-types` - продукты, для которых считается zC (пока поддержаны только `media-creative-reach` и `video-creative-reach`);
+ `--ab-ticket` - айдишник тикета вида EXPERIMENTS-XXX, из которого можно достать тестиды выборок (первая считается контролем);
+ `--experiments` - тестиды выборок, поддерживается разбиение по ActiveTestIds (префикс `ab`), PcodeTestIds (префикс `pcode`) и YandexExpBoxes (префикс `yaexp`). Контроль сюда писать необязательно. Имеет приоритет на `--ab-ticket`;
+ `--control` - контрольный эксперимент (если не задавать - то будут сравниваться эксперименты против всего остального);
+ `--no-control` - с этим флагом из тикета не будет браться контроль (считаем, что его нет);
+ `--full-traffic-zc` - с этим флагом будут посчитаны zC для эксперимента и эталона отдельно, а затем вычислено их отношение (так правильнее);

Два последних аргумента комбинируются следущим образом:
+ задан `--control` и есть `--full-traffic-zc` - считаем zC для эксперимента против дефолта, для контроля (эталона) против дефолта и делим одно на другое;
+ задан `--control`, но нет `--full-traffic-zc` - считаем zC для эксперимента против контроля;
+ не задан `--control` и нет `--full-traffic-zc` - считаем zC для эксперимента против дефолта;
+ не задан `--control`, но есть `--full-traffic-zc` - недопустимая комбинация.

+ `--keys` - поля для формирования группы;
+ `--max-groups` - максимальное число групп (по умолчанию: 2^30);
+ `--conditions` - условия для грепа (пример: `--conditions PageID=1,2,3 ImpID=2`, поддерживаются условия `==` и `!=`). Условие `FraudBits == 0` добавляется автоматически, если нужна нетривиальная обработка фрода - то необходимо задать условие тут. Также не надо задавать здесь условия на продукты - оно формируется автоматически из `--product-types`;
+ `--commerce` и `--not-commerce` - если эти флаги активны, то будут браться только хиты с коммерцией (без);
+ `--action-coefficients` - формулы для вычисления действий, разделены пробелом, внутри формулы коэффициенты перечислены через запятую (пример: `--action-coefficients complete=1.0 lclick=1.0,complete=0.5`);
+ `--method` - метод вычисления zC (по умолчанию: BIDS_RATIO);
+ `--yt-pool` - пул для вычислений на YT;
+ `--yt-data-weight` - размер одной map-операции (оптимальные значения - 2-4 Гб);
+ `--bootstrap-iterations` - число итераций вычисления zC;
+ `--min-conversion-rate` - минимальная конверсионность группы для учитывания в вычислениях;
+ `--min-group-size` - минимальная размер группы для учитывания в вычислениях;
+ `--sandbox-owner` - владелец таски в Sandbox (и соответствующая квота);
+ `--sandbox-vault-secret` и `--sandbox-secret-key` - секрет с токеном и название токена с доступом к Sandbox и YT;
+ `--task-description` - кастомное описание таски в Sandbox.

Остальные аргументы нужны для дебага или управления подзадачами в Sandbox.

Примеры запуска:

Таска: (https://sandbox.yandex-team.ru/task/1062463780)
Команда: `./reach_zc_calculator --range 20210820 --ab-ticket EXPERIMENTS-77372 --product-types media-creative-reach video-creative-reach --keys OrderID --action-coefficients complete=1.0[EShowType==Completes],lclick=1.0[EShowType==LongClicks] --full-traffic-zc --commerce --yt-pool ads-research --yt-proxy hahn --sandbox-vault-secret alex-serov_ml_engine_app_token --sandbox-owner ML-ENGINE --task-description "All reach products" --yt-data-weight 2048 --min-conversion-rate 0.001 --min-group-size 100`
