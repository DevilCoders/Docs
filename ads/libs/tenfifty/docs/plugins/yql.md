# YQL
Плагин YQL пока содержит только одно действие — `RunYql`.

## Действие RunYql (`run_yql`)
Выполняет YQL-запрос.

**input:** список любых артефактов (на бэкенде Nirvana не более четырёх).

**output:** список артефактов, которые будут класса Dataset (на бэкенде Nirvana не более четырёх).

**parameters:**

* `query` (строка, обязательный) — текст запроса.

В тексте запроса могут встречаться конструкции `$$input[индекс]` и `$$output[индекс]`: например, `$$input[0]` или `$$output[1]`. Эти конструкции ещё до запуска запроса будут заменены на одно из двух выражений:

* на путь на Yt к артефакту с указанным индексом из списка входных (`input`) или выходных (`output`) артефактов, заключённый в обратные апострофы: ``‌`//some/path`‌``

или

* на выражение вида ``CONCAT(`//some/path/1`, `//some/path/2`, `//some/path/3`)`` (соединяемых путей может быть один или больше). Это происходит, только если артефакт входной и это Dataset, состоящий из нескольких таблиц.

Также в тексте запроса могут встречаться выражения вида `$$param.param_name`, они заменяются на `param_value` из `param` параметров действия.

Пример использования RunYql (входной датасет разделяется на два):

```yaml
split_pool:
    action: run_yql
    do_after: get_table
    input:
        dataset
    output:
        - train_dataset
        - test_dataset
    parameters:
        param:
            param_name: param_value
        query: |-
            -- Обратите внимание на WITH TRUNCATE
            $is_past = ($r) -> { RETURN $r.$$param.param_name };

            INSERT INTO $$output[0] WITH TRUNCATE
            SELECT * FROM $$input[0]
            WHERE f3 <= 0.5;

            INSERT INTO $$output[1] WITH TRUNCATE
            SELECT * FROM $$input[0]
            WHERE f3 > 0.5;
```

Писать запрос следует так, чтобы все выходные артефакты пересоздавались, если они уже существуют, так как иначе возможны проблемы, если действие придётся перезапустить. Также нужно убедиться, что запрос действительно создаёт все выходные артефакты и ни в коем случае не перезаписывает входные.


### Детали реализации

{% list tabs %}

- Nirvana

    Используется один из кубиков `YQL1 .. YQL4` (обладающий минимальным необходимым количеством входов-выходов) от ML Marines (см. [страницу в вики](https://wiki.yandex-team.ru/nirvana-ml/ml-marines/)). Tenfifty заменяет конструкции типа `$$input[0]`, `$$input[1]` и т.д. на `not_var{{concat_input1}}`, `not_var{{concat_input2}}` и т.д., а `$$output[0]`, `$$output[1]` — на `not_var{{output1}}`, `not_var{{output2}}` и т.д. (со смещением индекса на 1). Далее эти подстановки обрабатываются кубиком.

- Tape

    Подстановки путей делает сама tenfifty. Запрос запускается просто через `ads.libs.yql.run_yql_query`.

{% endlist %}

<!--- Реализация для Nirvana поддерживает параметр `param`, который [ДАННЫЕ УДАЛЕНЫ] -->
