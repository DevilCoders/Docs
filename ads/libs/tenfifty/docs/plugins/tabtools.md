# TabTools

{% note warning %}

Плагин TabTools работает на бэкенде tape только в сборке для Python 2, потому что используемые библиотеки пока ещё не работают на Python 3. На бэкенде Nirvana плагин работает и на Python 2, и на Python 3.

{% endnote %}

Плагин TabTools позволяет выполнять операции [yabs-mapreduce-modules](https://wiki.yandex-team.ru/BannernajaKrutilka/yabs-mapreduce-modules/) и некоторых других модулей `yabs` на tenfifty. На данный момент все действия являются отображениями интерфейсов yabs-mapreduce-modules фактически один в один, однако не всегда поддерживаются все возможные параметры.


## Действие DoJoin (`do_join`)
Соединяет (joins) две таблицы при помощи операции `yabs.tabtools.mr_do_join` с использованием `yabs.tabtools.Join`.

Параметры:

**input:**

* `left` (список Dataset'ов) — первая таблица или список таблиц
* `right` (список Dataset'ов) — вторая таблица или список таблиц

**output:** один Dataset

**parameters:**
  * `keys` (список строк) — названия колонок, по которым объединяются строки. Если отсутствует, то берутся все ключи первой (`left`) таблицы или списка таблиц.
  * `type` (строка, по умолчанию `inner`) — тип соединения: `inner`, `outer` (что означает *left outer*) или `full outer` (`full outer` считается экспериментальным).
  * На Нирване параметр `arcadia_revision`, см. [«Дополнительные параметры для Nirvana»](#nirvana_parameters).

### Детали реализации

{% list tabs %}

- Nirvana

    Используется кубик [mr_do_join by onymoth](https://nirvana.yandex-team.ru/alias/operation/mr_do_join_by_onymoth) (версию уточняйте в коде).

- Tape

    Вызывается `yabs.tabtools.mr_do_join`.

{% endlist %}


## Действие DoMap (`do_map`)
Выполняет операцию `yabs.tabtools.mr_do_map` (запуск операции map на YT с последовательным применением определённых питоновских функций к каждой строке входных таблиц).

**input:** ListOf(Dataset)

**output:** ListOf(Dataset) (для бэкэнда Nirvana не более двух датасетов)

**parameters:**
* `mappers` (список строк, обязательный): список выражений на Python, каждое из которых возвращает маппер (объект класса-наследника `yabs.tabtools.BasicMapper`).
* `exec` (строка): код, который нужно выполнить до создания мапперов. Выражения в `mappers` будут eval'иться после выполнения этого кода с сохранением переменных, которые он устанавливает (все друг за другом, без сброса переменных). В любом случае перед `exec` и `mappers` сначала будет выполнена строчка `from yabs.tabtools import *`. Если `exec` отсутствует, то `mappers` выполняются сразу после этого импорта.
* [Дополнительные параметры для Nirvana](#nirvana_parameters).

### Детали реализации

{% list tabs %}

- Nirvana

    Если выход один, то используется кубик [mr_do_map_by_mstlebedev](https://nirvana.yandex-team.ru/alias/operation/mr_do_map_by_mstebelev), а если два, то [mr_do_map_2dst](https://nirvana.yandex-team.ru/alias/operation/mr_do_map-2dst) (версии уточняйте в коде).

- Tape

    «Подготовительный код» вызывается через `exec`, мапперы конструируются через `eval`, затем вызывается `yabs.tabtools.mr_do_map`.

{% endlist %}


## Действие DoPreprocess (`do_preprocess`)
Конструирует инстанс класса-наследника `yabs.matrixnet.BasicPreprocessor` (см. [код yabs.matrixnet в Аркадии](https://a.yandex-team.ru/arc/trunk/arcadia/ads/libs/py_ml_factors/matrixnet)) и запускает его. Результат зависит от выбранного препроцессора.

**input:** список Dataset'ов или Log.

**output:** один Dataset.

**parameters:**

* `preprocessors` (строка или список строк, обязательный) — выражения на Python, возвращающие препроцессоры. На Нирване поддерживается только одна строка-выражение, на tape поддерживается также список строк (они будут «обёрнуты» в `yabs.matrixnet.learn_preprocessors.PipelinePreprocessor(...)`, для совместимости с Нирваной это можно сделать самостоятельно).
* `exec` (строка, необязательный) — код, который нужно выполнить до создания препроцессоров. Выражения в `preprocessors` будут eval'иться после выполнения этого кода с сохранением переменных, которые он устанавливает (все друг за другом, без сброса переменных). В любом случае перед `exec` и `preprocessors` сначала будет выполнена строчка `from yabs.matrixnet.learn_preprocessors import *`. Если `exec` отсутствует, то `preprocessors` выполняются сразу после этого импорта.
* [Дополнительные параметры для Nirvana](#nirvana_parameters).


### Детали реализации

{% list tabs %}

- Nirvana

    Используется кубик [[ML_ENGINE] Arbitrary preprocessor](https://nirvana.yandex-team.ru/alias/operation/ml_engine-arbitrary-preprocessor_by_mstebelev-cyjv) (версию уточняйте в коде).

- Tape

    Инстансы препроцессоров создаются и запускаются локально. Большинство из них выполняют тяжёлые операции «в облаке» (на YT или через YQL), но некоторые из них всё же требовательны к ресурсам (особенно памяти) даже на той машине, где запускаются.

{% endlist %}


## Действие DoSort (`do_sort`)

{% note warning %}

DoSort пока что не поддерживается на tape. Кроме того, он работает неинтуитивно. Возможно, в будущем он будет заменён на другое действие.

{% endnote %}

**input:** один Dataset (состоящий из одной таблицы).

**output:** один Dataset.

**parameters:** не поддерживаются.

Сортирует таблицу **in-place** в лексикографическом порядке по колонке `key` (которая должна присутствовать). Выходной Dataset будет той же таблицей, что и входной (но отсортированной после действия).

### Детали реализации

- Nirvana

    Используется кубик [sort table by a-evseev](https://nirvana.yandex-team.ru/alias/operation/sort-table_by_a-evseev) (версию уточняйте в коде).


## Дополнительные параметры для Нирваны     {#nirvana_parameters}
Если в описании действия из этого плагина указано, что оно поддерживает дополнительные параметры для Нирваны, то имеются в виду следующие параметры. Все они необязательные и на других бэкендах игнорируются.

* `arcadia_revision` (положительное целое число): ревизия Аркадии для операций, которые ходят в Аркадию. По умолчанию используются определённые захардкоженные версии.
* `max_ram` (положительное целое число): максимальный объём RAM для операций на Нирване, **в мегабайтах**. По умолчанию выбирается определённое захардкоженное ограничение.
* `memory_limit` (положительное целое число): максимальный объём памяти для операций, запускаемых на YT, **в байтах**.
* `yt_spec` (словарь YAML): `yt_spec`, спецификация для операций на Yt. Пока что только для Nirvana, впоследствии скорее всего будет учитываться и на бэкенде tape.
