# Регулярное обучение на NIRVANA_REGULAR_PROCESS

{% note alert %}

Регулярное обучение на данный момент является экспериментальной функцией. Интерфейс, описанный здесь, может в любой момент поменяться.

{% endnote %}

Обучение этим способом проходит на [бэкенде Nirvana](../backends/nirvana.md). Делается следующее:

* Вы запускаете утилиту ``setup_scheduler``, которая создаёт планировщик в [Sandbox](https://sandbox.yandex-team.ru/) для запуска задач типа ``NIRVANA_REGULAR_PROCESS``.
* Планировщик запускается раз в какое-то время (``--scheduler_interval``) и запускает утилиту tenfifty с указанным вами файлом конфигурации, передавая ему в [секцию data](../configuration/parser.md#parametrization) по выбранному ключу (``--timestamp_data_key``) определённую метку времени (в виде целого числа секунд Unix time). При этом метки времени, которые передаются в конфигурацию, не связаны напрямую с временем запуска планировщика: NIRVANA_REGULAR_PROCESS, запустившись, ищет свой файл состояния (см. ниже) и по нему определяет, за какое время нужно запустить графы. Первая метка времени определяется параметром ``--first_timestamp``, последующие создаются через каждый период времени, задаваемый ``--period``.
* Запущенный файл конфигурации должен отработать, как обычно, чтобы создался граф для Nirvana. Использовать переданную метку времени можно любым способом (например, как время последнего лога, по которому надо работать). Планировщик может запускать одновременно несколько процессов tenfifty с разными метками времени — они должны к этому быть приспособлены. Скорее всего, такому графу не обойтись без [секции exec](../configuration/parser.md#exec).
* Если граф создать не удастся (например, потому что секция exec бросила исключение или просто ошибка в графе), граф будет считаться несозданным ("UNEXISTED"), и это засчитывается как неудачная попытка запуска.
* Планировщик хранит в Sandbox файл состояния, где ведёт учёт всем запущенным графам. При каждом запуске он проверяет, что произошло с графами, котоыре были запущены и ещё не завершились. Если граф упал, он перезапускается (без перезапуска tenfifty), если же он вовсе не был создан, снова запускается tenfifty с тем же timestamp. Если освободились слоты для графов (см. ``--max_count_of_running_flows``), запускаются графы за следующие временные точки.
* Конфигурация должна сама записать результаты своей работы (модели и прочее), куда нужно, при помощи имеющихся действий. Планировщик никакой дополнительной функциональности для этого не предоставляет.

{% note info %}

На данный момент конфигурации не запускаются за время, которое на момент запуска планировщика ещё не наступило.

{% endnote %}


## Обновление конфигурации и утилиты    {#updates}

**Файл конфигурации берётся из транка Аркадии.** При обновлении конфигурации в Аркадии планировщик подхватит новый граф. Сделать планировщик для конфигураций, которых нет в Аркадии, нельзя.

Утилита tenfifty tool для регулярного обучения берётся из Sandbox. На данный момент к планировщику прикрепляется конкретная сборка tenfifty (которая может меняться в новых версиях ``setup_scheduler``), но в скором времени планируется сделать регулярное обновление и самой tenfifty tool. В целом мы собираемся следовать принципу «зелёного транка»: если при обновлении конфигурации или утилиты что-то ломается, надо это сразу чинить.

Используется сборка tenfifty для Python 3, соответственно, [секции exec](../configuration/parser.md#exec) в графах запускаются под Python 3.


## Как запускать ``setup_scheduler``    {#how_to_run_tool}

**Для начала нужно пойти в [Sandbox Vault](https://sandbox.yandex-team.ru/admin/vault) и создать там секрет с произвольным названием, где в качестве значения — ваш ML_ENGINE_TOKEN,** если вы ещё этого не сделали.

Утилита находится в ``ads/libs/tenfifty/bin/setup_scheduler``.

Для создания планировщика на NIRVANA_REGULAR_PROCESS надо запустить:

``./setup_scheduler create_nrp <параметры> <путь к конфигурации в Аркадии>``

где путь к конфигурации в Аркадии — это путь от корня Аркадии к файлу, который нужно запускать.

**Обязательные параметры:**

* ``--channel КАНАЛ``: канал обновлений tenfifty. Пока есть только один — ``experimental``, он работает, как указано [выше](#updates).
* ``--period ИНТЕРВАЛ``: период времени, который проходит от одной метки времени до следующей. Указывается как, например, ``1h``, ``1d`` или ``27s``. Число может быть любым, а допустимые буквы — ``s`` (секунды), ``m`` (минуты), ``h`` (час), ``d`` (день). ``--period`` не определяет, как часто планировщик, собственно, запускается (это делает ``--scheduler_interval``), ``--period`` обрабатывается самим кодом NIRVANA_REGULAR_PROCESS.
* ``--scheduler_interval ИНТЕРВАЛ``: период времени между двумя запусками планировщика.
* ``--timestamp_data_key КЛЮЧ``: ключ, куда записывать метку времени в секции data.
* ``--sandbox_ml_engine_token НАЗВАНИЕ``: название секрета в Sandbox Vault, содержащего ваш ML_ENGINE_TOKEN, либо просто так ``fedor-uvarov_ml_engine_app_token``, либо с именем владельца ``fedor-uvarov@my_ml_engine_app_token``.
* ``--yt_work_dir``: рабочая директория в YT.
* ``--no_check``: на данный момент обязательно указать этот параметр, так как в будущем, надеемся, можно будет проверять корректность графа перед созданием планировщика.

**Важные необязательные параметры:**

* ``--author``: автор шедулера. Чаще всего выставлять не надо.
* ``--owner``: владелец шедулера. Вот это бывает нужно установить, например, если шедулером будет владеть какая-либо группа (например, ``AUTOBUDGET``) вместо одного человека.
* ``-D`` или ``--data KEY VALUE``: то же, что одноимённый параметр ``tenfifty tool``
* ``--first_timestamp ВРЕМЯ``: первая метка времени, с которой запускать граф. Время указывается в виде Unix timestamp или в виде даты/времени типа "2022-06-17" или "2022-06-17T12:00:00".
* ``--max_attempts_per_flow ЧИСЛО``: максимальное количество попыток выполнения графа. Неудачной попыткой считается ошибка при создании графа (в этом случае он пересоздаётся) либо падение графа (тогда он перезапускается). Повторные попытки происходят только при новых запусках планировщика.
* ``--max_count_of_running_flows ЧИСЛО``: сколько графов за разные графы могут работать одновременно.
* ``--priority КЛАСС:ПОДКЛАСС``: приоритет планировщика, например, ``SERVICE:NORMAL``.

**Другие параметры** довольно очевидны, их можно прочитать в ``./setup_scheduler --help``.
