# Пользователю
## Getting started
- Дать доступ роботу robot-ml-standuper@ на чтение к своему нирвана-токену.
 Это нужно, чтобы отправлять метрики в Пульсар.
- Указать в качестве VENV-переменной или в .bashrc NIRVANA_TOKEN: 
    
    `NIRVANA_TOKEN='YOUR_TOKEN_HERE'`

## Примеры запуска
### Запустить обучение ml_spending_model (прогноза C)
```
./ml_pipeline ml_spending_model.yml
```

### Запустить обучение ml_action_model (прогноза X)
```
./ml_pipeline ml_action_model.yml
```

# Разработчику
## Конфигурация

Придерживаемся следующего правила: никаких захардкоженных опций в коде быть не должно.
Код описывает структуру графа на Нирване, а опциями нужно управлять через конфиг или _немногочисленные_ аргументы командной строки (например, токены доступа к YT/YQL).

Блоки на Нирване конфигурируются по block code (можно, но не рекомендуется, конфигурировать по guid)
в секции `nirvana.blocks`.
Глобальные параметры конфигурируются в секции `nirvana.global_options`.

## Как создать свою операцию

1. Отнаследоваться от `ads.nirvana.pipeline.core.operation.Operation` и описать свою операцию (входы, выходы, параметры, ресурсы).
Для операций, выполняющих вычисления на YT, удобно наследоваться от `lib.BidderOperation`.
2. Создать скрипт для паковки операции в Нирване. Рекомендуется сделать в два этапа
   1. Рядом с определением класса операции создать пакующую функцию: `pack_your_operation = YourOperation.pack`.
   Это нужно, чтобы дальше написать скрипт паковки, состоящий из одного `ya.make` файла, который вызывает функцию `pack_your_operation`.
   Есть тикет на девтулз, который позволит избежать этого boilerplate-кода, но пока вот так.
   2. Написать скрипт, который состоит из `ya.make`, где в PY_MAIN указана функция `pack_your_operation`,
3. С помощью скрипта из предыдущего пункта запаковать операцию, пользуясь [официальной инструкцией от Нирваны](https://wiki.yandex-team.ru/nirvana/manual/create_operation/#sozdanieoperaciiizkoda).

## Общий дизайн
- При построении пайплайна придерживаемся функционального стиля.
- Операция - это функция, которая возвращает блок.
- Основной функцией, в которой создается граф, является [функция run](https://a.yandex-team.ru/arc/trunk/arcadia/ads/autobudget/ml_pipeline/lib/run_pipeline.py?rev=r8505566#L744).
- Описание частей полученного нирвановского графа можно найти [здесь](https://nirvana.yandex-team.ru/flow/9ea3b671-544c-473d-9d9c-3871db4a3a2c/).
