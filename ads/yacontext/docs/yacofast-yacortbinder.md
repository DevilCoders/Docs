# Организация Yacofast и YacoRTbinder

На схеме ниже представлена информация о внутреннем устройстве и взаимодействии Yacofast и YacoRTbinder.

![](images/yacortbinder.png)

Веб-сервер lighttpd (1) распределяет входящие запросы Баннерокрутилки между модулями FastCGI. Запросы содержат URL-адрес и и текст (часть страницы, загруженная браузером пользователя до того, как был вызван код рекламного блока).

Основная логика Yacofast реализуется параллельно работающими FastCGI-модулями (2), которые выполняют следующие задачи:

* нормализация URL-адреса, то есть приведение его к единому виду с учетом информации о зеркалах и незначимых параметрах (query_args), хранящейся в базах данных `quargs.db` и `master_mirrors.db` (3);
* отправка в memcached (4) запроса, содержащего нормализованный URL-адрес;
* отправка привязок/быстрых привязок в веб-сервер lighttpd и, соответственно, Баннерокрутилку.

Приложение [memcached](http://ru.wikipedia.org/wiki/Memcached) получает запросы FastCGI и производит поиск привязок. Memcached хранит как привязки, сформированные Yacobot-серверами, так и менее точные быстрые привязки, сформированные YacoRTbinder. Поиск привязок в memcached осуществляется по нормализованному URL-адресу:

* если при поиске по URL-адресу была найдена привязка, сформированная Yacobot-сервером, то она сразу передается в Баннерокрутилку;
* если при поиске по URL-адресу была найдена быстрая привязка, то производится сверка `hash` от текста, если `hash` от текст не совпадает, то считается, что привязки не найдены;
* если привязки не найдены, то FastCGI отправляет запрос в YacoRTbinder для формирования быстрых привязок для этого URL-адреса.

{% note info %}

`Hash` используется для того, чтобы убедиться, что текст для URL-адреса, присланный в очередном запросе, совпадает с текстом, для которого в memcached сохранена быстрая привязка. Сверка hash производится в интересах защиты информации, которая находится на странице и может быть недоступна части посетителей сайта, так как при несовпадении `hash` быстрая привязка формируется заново, что исключает вероятность показа поситетелю «чужой» рекламы.

{% endnote %}


Каждый FastCGI-модуль для установки соединения с binder_worker (6) обращается к модулю TCP Balancer (5). TCP Balancer направляет входящее соединение к одному из TCP-портов, связанному с определенным binder_worker, так что к каждому binder_worker не может быть установлено более одного входящего соединения.

Формирование быстрых привязок в режиме реального времени выполняется модулями binder_worker с использованием onrop_server (технология [Onrop](onrop.md)). Модуль cclients используется для ограничения количества фраз в привязке на основании числа рекламодателей (7). Сформированные привязки сразу же отправляются в FastCGI-модуль для передачи в Баннерокрутилку.

Кроме того, все сформированные быстрые привязки должны быть также отправлены в memcached. Отправку быстрых привязок в memcached осуществляет mc_load_server (8).

О том, как реализовано взаимодействие между различными группами Yacofast в разных дата-центрах, подробнее рассказывается в разделе [Взаимодействие между Yacofast в разных дата-центрах](yacofast-datacenter.md).

Из лог-файлов веб-сервера lighttpd формируется очередь, содержащая URL-адреса и текст (9), на основе которой в компоненте Yacotitles (10) формируется база весов сегментов segments.db. Эта база весов сегментов аналогична используемой Шаблонизатором (подробнее в разделе [Yacobots: скачивание, классификация и привязка](yacobots.md)), но если база весов сементов для Yacobot-сервера строится по документам доменов, то база Yacotitles строится на основе анализа текста, переданного вместо с URL-адресами,а сегменты определяются по HTML-тегу и предложению.

