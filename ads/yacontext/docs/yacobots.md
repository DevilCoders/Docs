# Скачивание, классификация и привязка

## Раздел рассказывает об основных функциях Фокусирощика, реализуемых кластером Yacobot-серверов {#about}

Основная функциональность Фокусировщика реализована на кластере Yacobot-серверов. Каждый Yacobot-сервер (или Yacobot) в составе кластера выполняет следующие задачи для определенной части доменов сайтов РСЯ:

* скачивание содержимого (веб-страниц) по полученному с Master Server списку URL-адресов;
* классификация страниц — присвоение им категорий с помощью классификатора страниц;
* формирование привязок и заглушек для страниц сайтов партнеров в соответствии с содержимым скачанных страниц и присвоенной категорией;
* передача данных (привязок, заглушек, а также незначимых query_args) в Баннерокрутилку.

Все URL-адреса, для которых формируются привязки, хранятся в базе данных Yacobot-сервера. Перепривязка посещаемых URL-адресов производится регулярно с учетом приоритета `download_prio` по следующему принципу:

* в очередь попадают только такие URL-адреса, для которых количество накопленных с последней привязки хитов не равно нулю; количество хитов влияет на позицию URL-адреса в очереди;
* в очередь на формирование привязок попадают такие URL-адреса, для которых поле `next_indexed` (дата следующей привязки) меньше либо равно текущей дате;
* в поле `next_indexed` хранится минимальная дата из следующих двух:
    
    * дата последней привязки + количество дней до получения нового словаря (если до получения словаря осталось меньше одного дня, то количество дней считается равным одному; если словарь не обновлялся больше, чем указано в параметре `Url.DictAge`, используется параметр `Url.ReindexPeriod`);
    * дата последней привязки + количество дней в поле `steady_level` (период перескачивания, отражает то, насколько часто меняется содержимое URL-адреса);
    
* новые URL-адреса записываются в очередь с количеством хитов, накопленным с момента первого появления в `reflog`, умноженным на 3.
* приоритет на перепривязку (`download_prio`) для URL-адреса равен значению `hits` (количеству хитов со времени последнего скачивания);
* для новых URL-адресов (которые еще ни разу не были скачаны) приоритет на перепривязку рассчитывается как `hits` * `NEW_URL_BOOST`, где:
    
    * `hits` — количество хитов, накопленных с момента появления в базе;
    * `NEW_URL_BOOST` — константа, дающая новым URL-адресам преимущество перед теми, которые привязывались хотя бы один раз (в текущей реализации `NEW_URL_BOOST=3`).

Необходимость скачивать заново содержимое URL-адреса определяется значением поля `steady_level` (если с даты предыдущего скачивания прошло меньше дней, чем указано в `steady_level`, то документ не скачивается).

Так как постоянно появляются новые баннеры и, соответственно, новые ключевые фразы, необходимо перепривязывать URL-адреса, которые посещаются достаточно часто, даже если их содержание не изменяется.

Схема ниже в общем виде представляет логическое устройство Yacobot-сервера, отражает движение потоков данных и взаимодействие с внешними компонентами.

![](images/yacobot-data.png)

Список URL-адресов для формирования привязок каждый Yacobot-сервер получает с Master Server (подробнее об этом рассказывается в разделе [Master Server: распределение URL-адресов](master-server.md)).

Для скачивания содержимого URL-адресов в Фокусировщике используется [Zora: Spider Proxy Balancer](http://wiki.yandex-team.ru/Robot/Manual/Zora?ncrnd=763410) (1).

Все скачанные документы (веб-страницы) хранятся в архиве Yacobot-сервера. При сохранении документам присваивается идентификатор (2). Документы из архива могут использоваться, если URL-адрес необходимо перепривязать, но нет необходимости перескачивать документ, так как его содержимое редко меняется или он был скачан недавно.

Модуль MultiDoc предназначен для обработки скачанных документов: 

* на первом этапе (3) документ разбивается на контентные блоки или сегменты (подробнее в подразделе [Сегнотатор](segnotator.md)); информация о сегментах передается в Шаблонизатор;
* на втором этапе с помощью Шаблонизатора (4) вычисляются веса сегментов документа (подробнее в подразделе [Шаблонизатор](templater.md)); веса отражают значимость и уникальность определенных блоков контента страницы (например, сегменты навигационного меню имеют низкий вес, а сегменты, содержащие текст новостной статьи — высокий);
    
    {% note info %}
    
    Для вычисления весов сегментов конкретного документа Шаблонизатор использует базу весов сегментов. В базе данных для каждого домена хранится информация о частотности сегментов, вычисленной по документам домена, доступным в Архиве (для каждого домена отдельная таблица в MySQL).
    
    {% endnote %}
    
* на следующем этапе Токенайзер (5) разбивает сегменты на слова, и веса сегментов проецируются на слова (вес слова внутри сегмента равен весу сегмента);
* по URL-адресу и на основании контента (слова и веса слов) определяются категории документа (6); в качестве классификатора страниц используется [Наивный байесовский классификатор](http://ru.wikipedia.org/wiki/%D0%9D%D0%B0%D0%B8%D0%B2%D0%BD%D1%8B%D0%B9_%D0%B1%D0%B0%D0%B9%D0%B5%D1%81%D0%BE%D0%B2%D1%81%D0%BA%D0%B8%D0%B9_%D0%BA%D0%BB%D0%B0%D1%81%D1%81%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%82%D0%BE%D1%80).

Изначально классификаторы присваивают всем документам категории Яндекс.Каталога произвольной глубины вложенности, которые далее приводятся к определенному уровню вложенности для использования в привязках разного типа.

Для формирования привязок на основании информации о документе, полученной из MultiDoc, используются модули типа Binder (7). Для каждого типа привязок (Яндекс&nbsp;Директ, Яндекс&nbsp;Маркет и привязки для медийно-контекстных баннеров) используется отдельный Binder. Подробнее о внутреннем устройстве этих модулей рассказывается в разделе [Формирование привязок](yacobot-binders.md).

На выходе каждый Binder выдает список фраз и категорий по соответствующему словарю ключевых фраз и категорий. Для каждой фразы также рассчитывается релевантность. В модуле Коллектор часть фраз отфильтровывается (8) на основании:

* релевантности;
* ограничений на размер привязки (например, не более 20 фраз в привязке для Яндекс&nbsp;Директа);
* вложенности (вложенные фразы отбрасываются);
* количества рекламодателей (только для Яндекс&nbsp;Директа).

Для определения степени трагичности контента документа (9) используется Трагический фильтр (подробнее в подразделе [Трагический фильтр](tragic-context.md)). На страницах с признаком трагичности равным 1 контекстная реклама не показывается.

Все привязки и признак трагичности сохраняются в базе данных Yacobot-сервера (10) и Архиве привязок (11). Для передачи в Баннерокрутилку и Yacofast привязки конвертируются в соответствующий формат (12).

Модуль Path Binder (13) каждые два часа формирует заглушки для разделов сайтов. В заглушку входят самые частотные фразы и категории из привязок URL-адресов, входящих в этот раздел. Если в разделе недостаточно URL-адресов, для которых сохранены привязки, заглушка не формируется.

