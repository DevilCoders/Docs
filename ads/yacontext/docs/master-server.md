# Master Server: распределение URL-адресов

## Данный раздел рассказывает о распределении потока URL-адресов по Yacobot-серверам {#about}

Основная задача Master Server состоит в том, чтобы на основании домена распределить поток URL-адресов из файла формата reflog по Yacobot-серверам так, чтобы один и тот же адрес не скачивался и не привязывался разными yacobot-серверами, а также назначить Yacobot-серверы новым доменам. В настоящее время физически реализовано два независимых, полностью дублирующих друг друга Master Server. Если один из серверов не отвечает, то используется другой.

### Формат reflog {#reflog}

В общем виде формат `reflog` может быть представлен следующим образом:

```no-highlight
<unknown field>
<batch_id> \t <priority> \t <timestamp> \t <page_id> \t <url> \t <hits> \t <updatetag>
```

Описание обрабатываемых полей:

* `<batch_id>` — идентификатор пачки;
* `<priority>` — приоритет (в настоящее время не используется);
* `<timestamp>` — время обращения к URL-адресу;
* `<page_id>` — идентификатор рекламной площадки;
* `<url>` — полный URL-адрес;
* `<hits>` — количество хитов (в рамках одной пачки);
* `<updatetag>` — изменилось ли содержание урла.

Пример:

```no-highlight
2011072806593795        5       20110727200841  2310    
http://fatalenergy.com.ru/power/index.php?newsid=1185458796     1       0

2011072806593795        5       20110727200853  4599    
http://astroma.net/week/02.htm  1       0

2011072806593795        5       20110727200844  1038    
http://www.3dnews.ru/search/index.php?query=canon%20600d&method=and&orderby=1&order=1   
1
```

### Схема обработки потока URL-адресов {#url-scheme}

Схема ниже описывает процесс распределения потока URL-адресов по Yacobot-серверам.

![](images/master-server.png)

Master Server получает от Баннерокрутилки список URL-адресов в формате `reflog`.

(1) Скрипт `analyze_dump` в каждом полученом файле `reflog` присваивает каждому URL-адресу идентификатор (`hash` от URL-адреса), выделяет домен и выполняет сортировку по идентификатору (`id`) и времени обращения (`timestamp`). Сортировка необходима для выполнения операции `JOIN`.

(2) Скрипт `group_sum` группирует одинаковые URL-адреса, суммируя значения их хитов (`hits`). В поле `update_tag` для сгруппированной строки записывается последнее непустое значение `update_tag`. Результаты этих операций сохраняются в файле формата `incoming_log`.

(3) Выполняется операция `JOIN` по `id` для `incoming_log` и файла формата `current_log`, который содержит информацию об URL-адресах, поступивших на Master Server за последний час, и также отсортирован по `id` (как именно формируется `current_log`, рассказывается в пункте (4). Файл формата `current_log` необходим для того, чтобы не отправлять на Yacobot-серверы одни и те же URL-адреса чаще, чем раз в 1 час.

В результате выполнения `JOIN` образуется новый набор данных об URL-адресах, в частности, значения `timestamp` из обоих файлов, вида:

```
<url>  ...  <c_log timestamp>  <i_log timestamp>  <c_log updatetag>  <i_log updatetag> 
URL_A  ...  -                  time1              -                  updatetag1 
URL_B  ...  time2              -                  updatetag2         -
URL_C  ...  time3              time4              updatetag3         updatetag4 
```

(4) На данном этапе скриптом `filter_url` производится фильтрация URL-адресов для того, чтобы уменьшить поток, отправляемый на Yacobot-серверы. Одни и те же URL-адреса не отправляются на Yacobot-серверы чаще, чем раз в 1 час. Кроме того, данные о повторно приходящих URL-адресах (последние значения `timestamp`, `updatetag` и суммированные `hits`) хранятся Master Server до 10 часов.

Фильтрация производится по следующему принципу (на примере результата выполнения `JOIN` в пункте (3)):

* если URL-адрес присутствует в `incoming_log`, но отсутствует в `current_log` (т.е. пришел первый раз за последний час, пример `URL_A`), этот адрес записывается в новый `current_log`, а также в файл формата `filtered_log`, адреса из которого будут распределяться по Yacobot-серверам;
* если URL-адрес присутствует в `current_log`, но отсутствует в `incoming_log` (т.е. не приходил в последнем `reflog`, пример `URL_B`), то этот URL-адрес записывается в новый `current_log`, только если `timestamp` (`time2`) находится в пределах часа от текущего времени;
* если URL-адрес присутствует как в `current_log`, так и в `incoming_log` (пример `URL_C`), то рассматривается разница между `timestamp` по `incoming_log` и `current_log` (`time4-time3`), а также изменение `updatetag`:
    
    * записывается в новый `current_log` с `timestamp=time4` и `updatetag=updatetag4` и в `filtered_log`, если `time4-time3` более 1 часа или изменился `updatetag` (`updatetag3≠updatetag4`);
    * записывается в новый `current_log` с `timestamp=time3` и не записывается в `filtered_log`, если `time4-time3` менее 1 часа и не изменился `updatetag` (`updatetag3=updatetag4`).

(5) Скрипт `domains_from_db` на основе данных таблицы `partner_domain` собирает файл `domain_map`, описывающий соответствие домен – идентификатор Yacobot-сервера.

(6) Выполняется операция `JOIN` по домену для `filtered_log` и `domain_map`, в результате чего каждому URL-адресу из `filtered_log` приписывается идентификатор Yacobot-сервера. 

{% note info %}

Среди URL-адресов из `filtered_log` также могут быть такие адреса, домены которых еще не приписаны к определенному Yacobot-серверу. Скрипт `upload_domains` присваивает новым доменам из `filtered_log` идентификаторы наименее загруженных Yacobot-серверов и сохраняет информацию об этих доменах в базе данных. Также информация о новых доменах добавляется в файл `domain_map`.

{% endnote %}

(7) Скрипт `logsaver` записывает URL-адреса в очереди соответствующих Yacobot-серверов.

Подробно логика записи URL-адресов в базу данных Yacobot-сервера с учетом содержащихся в его составе параметров (query_args) описана в подразделе [Сохранение query_args в базе данных](queryargs-database.md).

