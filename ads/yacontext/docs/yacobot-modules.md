# Описание модулей

## В подразделе представлено описание программных модулей Yacobot-сервера {#about}

На схеме ниже отражены связи между основными функциями Yacobot-сервера и программными компонентами, их реализующими.

Логика работы Yacobot-сервера подробно описана в разделе [Yacobots: скачивание, классификация и привязка](yacobots.md).

![](images/yacobot-modules.png)

(1-3) Логика записи URL-адресов в таблицу с учетом значимости query_args из таблицы `path_arg_name` подробно описана в подразделе [Сохранение query_args в базе данных](queryargs-database.md). Эта логика реализуется процессами urls fetcher и queryargs fetcher.

Feeder — процесс, который выбирает из базы данных URL-адреса (4) и составляет из них очередь для привязки (urls_fqueue), одновременно отмечая эти URL-адреса в базе как находящиеся в обработке (поле `being_updated`).

Основная логика, скачивание – классификация – привязка, реализуется параллельными процессами типа Worker (5). Worker направляет запросы на скачивание в модуль Zora-client, обрабатывает документы (MultiDoc), формирует привязки (Binders). Все скачанные документы сохраняются в Архиве (6).

(7) Документы в скачивании которых было отказано, сохраняются в очереди discarded_fqueue. Процесс Discarder (8) снимает в базе данных отметку о том, что эти URL-адреса находятся в обработке (поле `being_updated`), для того чтобы они снова могли быть поставлены в очередь процессом Feeder.

Все привязанные документы сохраняются в очереди bound_docs_fqueue, откуда направляются в Коллектор (9). Из Коллектора привязки направляются в базу данных Yacobot-сервера (10), где обновляются следующие таблицы:

* `doc` — сохраняются свойства документа;
* `doc_cat`— сохраняется связь документ – категория;
* `context` — сохраняются привязки Яндекс&nbsp;Директа, Яндекс&nbsp;Маркета и признак трагичности;
* `url` — обновляются данные об URL-адресах (снимается отметка `being_updated`, обновляются даты последней привязки и/или скачивания, значение хитов выставляется равным нулю).

В очередь bindings_fqueue (11) направляются все привязки (включая привязки МКБ, которые не хранятся в базе данных), а также признак трагичности. Конвертер yaml2bs (12) конвертирует привязки в соответствующий формат для передачи в Yacofast и Баннерокрутилку (очередь export_fqueue (14)).

Очередь external_fqueue (13) может быть использована для того, чтобы передать в Баннерокрутилку привязки от внешних источников (например, экспериментальные или сформированные вручную). Процесс external BS reader забирает привязки из очереди external_fqueue и ставит их в очередь export_fqueue (14) для передачи в Баннерокрутилку.
(15-16) Simple_rpc_server и Apache CGI используются для обеспечения взаимодействия с Yacotools и интерфейсом Procontext (передача привязок, статистики, доступ к API экспериментов).
