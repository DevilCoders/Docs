# Балансировка

Есть один вариант балансировки:

1) Мастер-балансировка
  <br> В этом случае каждая CS регистрируется в динтаблице на YT (и при регистрации сообщает свое множество шардов).
  <br> А мастер-балансировщик (один из кандидатов разбросаных по разным хостам, который сумел захватить мастер-лок на маркове) смотри на таблицу регистраций и делает таблицу назначений.
  <br> И на YT выглядит это так https://yt.yandex-team.ru/markov/navigation?path=//home/bigb_resharded_queues/ReshardingConsumingSystemMaster&.
  Или так (эта ссылка должна для всех работать) https://yt.yandex-team.ru/pythia/navigation?path=//home/bigb/test/buzzard_master_balancing .
  <br> Мастер-балансировка умеет работать с несколькими CS работающими поверх одного набора хостов.
  <br> Она пытается распределить шарды более умным образом:
    1) разделить шарды отдельных CS по возможности поровну между хостами;
    2) попытаться сделать так, чтобы на каждом хосте было примерно одинаковое количество шардов суммарно по всем CS

Настройка балансировки:
https://a.yandex-team.ru/arc/trunk/arcadia/ads/bsyeti/big_rt/lib/consuming_system/config/config.proto?rev=r8910612#L72



Еще немного про мастер-балансировку.
Мастер общается с подчиненными CS исключительно через YT.
Это сделано для того, чтобы было достаточно просто разрабатывать
некоего супер-мастера
(например, чтобы мастера для контура можно было запускать и отлаживать на дев-машинке),
который бы учитывал мессадж-лаги,
и индивидуальную пропускную способность хостов.
Сейчас же можно пользоваться мастером встроенным в CS
(внутри CS поднимается мастер-кандидат, который пытается стать общим мастером, захватив лок).


## Разрозненное


Каждая CS свое количество шардов говорит при регистрации


Nick Lavrenov -O3, [4 июня 2020 г., 19:43:52]:
возможно глупый вопрос, но я немного запутался. Насколько я знаю, у вас есть решардер, который работает на big_rt и перекладывает из кучи топиков LB в QYT. Разве поддержка нескольких сапплаеров не для этого сделана? То есть вы для каждого топика отдельно запускаете CS? Тогда мне интересно, что используете для их балансировки по машинкам (медиатор это же только про шарды внутри одного CS, верно?). На всех машинках для каждого топика по CS запускаете, или самогоном разделяете машинки для конкретных топиков?

Egor Khairullin, [4 июня 2020 г., 19:46:29]:
у нас много CS. На каждой машинке все CS. Балансировка - мастер, она все CS'ы балансирует совместно. Это нормально, что CS'ы разные - так как суть CS'а рулить шардами. Если логи шардированы одинаково и их нужно обрабатывать совместно в одном контексте - нужно запихивать в одну CS. Если нет - не нужно :-) Юра, поправь меня если я где-то ошибся.

Yuri Pechatnov, [4 июня 2020 г., 19:52:39]:
Да, все правильно

По сути поддержка нескольких сапплаеров сделана с заделом на то, чтобы мы смогли написать buzzard (stateful сервис) на big_rt
А там важно обрабатывать соответствующие шарды из разных логов совместно (иначе просто ничего работать не будет)

Задача одной CS - менеджить одну шардированную систему, можно так сказать

Задача мастер-балансировщика - менеджить много CS - то есть много шардированных систем

Пойду  допишу это в доке)

Nick Lavrenov -O3, [4 июня 2020 г., 19:57:25]:
уточни, а мастер балансировщик оперирует CS или шардами CS?

Yuri Pechatnov, [4 июня 2020 г., 19:59:16 (4 июня 2020 г., 20:00:22)]:
Это по сути отдельный сервис (но одна его реализация встроена в CS), который знает, какие есть CS и какие есть воркеры
Выдает предписания какой шард какой CS на какого воркера назначить. Все управляемые CS следуют предписаниям

Nick Lavrenov -O3, [4 июня 2020 г., 20:01:24]:
“отдельный сервис” — это про деплой, или про то, что это не часть big_rt?
А общение через что, кстати? YT или http?

Yuri Pechatnov, [4 июня 2020 г., 20:02:06]:
Не, это часть bigrt и встроена в CS
Но она изолирована и общается со всеми CS через YT

«Отдельный сервис» - неудачное выражение. Но все CS взаимодействуют с мастер-балансировщиком, как будто это отдельный сервис.
В текущей реализации (хотя так скорее всего всегда и будет) мастер-балансировщик на самом деле запущен одной из многих CS на хостах

(Каждая CS, если это явно не отключено в опциях, запускает мастер-кандидата, который пытается стать мастером, захватив лок на YT)

Nick Lavrenov -O3, [4 июня 2020 г., 20:06:15]:
угу, теперь точно понятно

Egor Khairullin, [4 июня 2020 г., 20:07:07]:
мне кажется, это надо в доку прописать

Yuri Pechatnov, [4 июня 2020 г., 20:07:13]:
Ага

Сейчас как минимум скопирую в .md-шки

Nick Lavrenov -O3, [4 июня 2020 г., 20:10:28]:
ща, а все CS через что объединяются? Общая в конфиге настройка про путь до мастера? CS-мастер же управляет и CS над другими конфигурациями топика, но он как минимум количество шардов должен знать. Просто смотрит на YT параметры в “доке”?

Yuri Pechatnov, [4 июня 2020 г., 20:11:36]:
Общая в конфиге настройка про путь до мастера - да
