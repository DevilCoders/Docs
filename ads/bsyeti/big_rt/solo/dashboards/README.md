# Универсальный генератор дашборда с BigRT метриками

Универсальный генератор дашборда с BigRT метриками позволяет создать дашборд, составленный из  
различных слоев метрик в зависимости от наличия данных слоев в проекте. Под слоем понимается набор  
метрик характерных для какого-либо определенного процесса или сущности. Целью использования данного  
генератора является создание единообразных нагрузочных дашбордов для сервисов, которые пользуются  
библиотекой BigRT. Данный генератор использует технологии solo для генерации объекта дашборда.  
  
У данного генератора присутствует следующий список слоев и подслоев:  
  
+ BigRT специфичные метрики
  + Basic метрики
  + Метрики stateless processor'а
  + Метрики stateful processor'а
  + Swift метрики
+ Resharder специфичные метрики
+ Perfomance
  + YT сенсоры
  + Samogon сенсоры
+ YT (cpu wait, logging сенсоры)
+ Samogon
  + Versions метрики
  + Net метрики
+ Bsyeti слой с метрикой Young/Old сервиса
+ Caesar Worker специфичные метрики

## Архитектура генератора

Генератор имеет 4 основные компоненты:

+ Скрипт с генератором дашборда (`generate_big_rt_dashboards.py`)
+ Классы объектов для слоев/подслоев/метрик (`base.py`)
+ Базовые слои (`layers.py`)
+ Пользовательский скрипт solo с параметрами дашборда

В скрипте генератора дашборда имеется входная функция generate_dashboard(), которая принимает  
следующие параметры:

1. project_id (str) - имя проекта в соломоне, например, bigb_jaylog или yabs_stat

2. layers (List[Object]) - лист объектов-слоев, например, [bigrt.basic, bigrt.swift, perfomance.samogon, ...]

3. dashboard_name (str) - название сгенерированного дашборда, например Caesar Load Dashboard
4. selector_tags (Dict[str, str]) - словарь пар тэг - значение тэга для дополнительных 
селекторов дашборда.

`layers.py` содержит набор слоев, перечисленный выше. В каждом слое содержится набор подслоев,  
входящих в него, а в каждом подслое перечислен набор метрик, которые содержат характерные для них  
теги. В качестве list параметра layers указывается набор объектов Sublayer, которые экспортируются  
из данного файла.  
  
Для каждого слоя существуют тэги `cluster`, `service` и `host`.  Эти теги также являются и  
**базовыми селекторами** для дашборда, создаваемого универсальным генератором.  
  
Помимо базовых сервисам может потребоваться определение дополнительных тэгов и тэгов-селекторов.  
Для этого в пользовательском скрипте описываются и применяются эти дополнения (см. использование  
генератора) для каждого слоя, а затем передаются в генератор.  

Таким образом, используя только базовый набор тэгов для каждого слоя без дополнений, любой сервис  
может построить себе основу дашборда, а затем уже дополнять любыми тэгами какой-либо слой.  
Данные слои для дашборда возможно собирать как конструктор в зависимости от их наличия в сервисе.  

## Использование генератора

Для использования генератора пользователь сперва должен определить, какие слои метрик экспортирует  
сервис. Порядок следования слоев на дашборде определяется порядком их перечисления в пользовательском  
скрипте. Существует канонический порядок, который необходимо соблюдать для единообразия дашбордов.  

1. Perfomance (cpu, rss)

2. Samogon (versions)

3. BigRT basic, stateless processor, stateful processor, swift

4. Any service specific layer (resharder, caesar, bigstart, ...)

5. YT (cpu wait, logging)

6. Bsyeti (old/young versions)

7. Sysmon (net inbound/outbound)

Если какой-то из слоев в сервисе отсутствует, то он пропускается.  

Сервису необходимо создать у себя в проекте структуру проекта solo по [рекомендуемому примеру](https://a.yandex-team.ru/arc/trunk/arcadia/library/python/monitoring/solo/example/example_project).  
И в пользовательском скрипте, находяшемуся по пути registry/dashboard/dashboard_name.py определить  
требуемые параметры генератора и вызвать с ними функцию generate_dashboard(). Функция вернет объект  
Dashboard в терминах solo, который сервис экспортирует, собирает solo cli и вызывает creator для  
создания объектов непосредственно в соломоне.  

### Пример одного из пользовательских скриптов

Подробный пример пользователького скрипта с комментариями приведен для 
[Resharder](https://a.yandex-team.ru/arc/trunk/arcadia/ads/bsyeti/tools/solo/registry/dashboard/resharder_load.py):

Больше примеров пользовательских скриптов можно найти для:

+ [Caesar Resharder Load](https://a.yandex-team.ru/arc/trunk/arcadia/ads/bsyeti/tools/solo/registry/dashboard/caesar_resharder_load.py)

+ [Caesar Worker Load](https://a.yandex-team.ru/arc/trunk/arcadia/ads/bsyeti/tools/solo/registry/dashboard/caesar_worker_load.py)

+ [Bigstart](https://a.yandex-team.ru/arc/trunk/arcadia/yabs/stat/bigrt/infra/solo/registry/dashboard/yabs_stat_bigstart_dashboard.py)
