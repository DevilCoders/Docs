# Скрипт для экспорта данных для сложных развязок

> Сначала лучше прочитать https://wiki.yandex-team.ru/users/yaigor/complexjunctions/

## Преамбула

Для работы со сложными развязкми и разметки их на картах был использован веб-интерфейс, позволяющий нарисовать на карте полигоны и заэкспортировать данные в формате .kml

Кроме этого для работы с траекториями было придумано использовать отдельный json файл, в котором описан экспорт также из веб интерфейса, но уже в ручном режиме, данный файл обязан иметь следующий формат:
```
{
    "cj_enter_polygon_id_1": [
        "# trajectory 1",
        "# trajectory 2",
        ...
        "# trajectory n"
    ],
    "cj_enter_polygon_id_1": [
        ...
    ]
    ...
}
```
Где именем поля данного объекта является идентификатор полигона въезда на сложную развязку, а внутри массива для каждого идентификатора лежат все траектории привязанные к этому полигоу.

Данный скрипт обрабатывает эти данные и экспортирует их в виде json'ов, с которыми может работать Навигатор.

## Формат входных данных
Про работу с траекториями было описано выше, тут рассмотрим формат данных в `.kml` файле.

В экспортированном файле находятся полигоны нужные для сложных рязвязок, названия полигонов будут обозначать зависимости между ними:
- если название полигона начинается с `#poly`, тогда данный полигон будет большим полигоно накрывающим сложную развязку
- если название полигона начинается с `#junc`, тогда данный полигон будет расцениваться как въезд в сложный участок развязки, причем данный полигон будет ассоциирован с полигоном типа `#poly` и именем `#poly{name w/o #junc prefix}`, если такой был найден в данных.

## Версионирование

В данный момент скрипт поддерживает экспорт в двух форматах:
- v1 для старых клиентов Навигатора (версия >= 5.50)
- v2 для новых клиентов Навигатора (версия >= 6.55)

### v1
В данном формате Навигатор ожидал два файла:
- файл с полигонами накрывающими сложную развязку
- файл с полигонами въездов в сложный участок какой-то сложной развязки, а также траектории привязанные к каждому въезду

### v2
Для новых клиентов решили обединить эти данные в один файл (это решение позволит делать некоторые оптимизации)
В этой версии файл экспорта выглядит так:
```
{
    "polygons": [
        {
            "logId": "Идентификатор для логгирования",
            "polygon": [...], // Точки полигона всей развязки
            "enterPolygons": [ // Полигоны въездов для данной развязки (их может быть несколько - см. Вики)
                "logId": "Идентификатор для логгирования",
                "polygon": [...],
                "trajectories": [
                    // траектории привязанные к данному въезду
                ]
            ]
        }
    ]
}
```

## Гарантии скрипта
- Скрипт не будет падать если не все названия полигонов соответствуют формату
- Если для полигона въезда не был найден накрывающий полигон сложной развязки
- При иных опечатках в данных

При этом скрипт будет завершаться с ошибкой, если скрипту не удастся получить корректное представление файлов (некорректный `json` или `xml`), в остальных же случаях в логах будет описано какие данные были корректно прожкспортированны, а какие нет и почему.

## Пример запуска
```
./complex_junctions.py /path/to/kml/export.kml /path/to/trajectories/export/trajectories.json
```
