# Логистический Диспатч

### Полезные ссылки

Трекер: [DISPATCH](https://st.yandex-team.ru/DISPATCH)

### Среды

Тестинг: [logistic-dispatcher.taxi.tst.yandex.net](http://logistic-dispatcher.taxi.tst.yandex.net)
Продакшен: [logistic-dispatcher.taxi.yandex.net](http://logistic-dispatcher.taxi.yandex.net)


### Модель

Запрос `TRequest` - это заявка от пользователя. Он состоит из
- набор ресурсов, каждый из которых имеет вес, размер и прочие характеристики. К характеристикам ресурса относятся атрибуты курьеров, которые могут этот ресурс доставлять. Ресурсы можно объединять в группы через композитные ресурсы.
- граф доставки этого набора ресурсов. Граф доставки - это набор узлов `TNode` и трансферов `TTransfer`.

Узел `TNode` - это начальная, либо конечная точка доставки, или сортировочный центр (например, ПВЗ). Где происходит перераспределение ресурсов. Узлом может выступать распределяющий центр, клиент, точка встречи двух курьеров для передачи заказа (из рук в руки). Узлы задаются в процессе формирования запроса или могут создаваться алгоритмом диспатча в процессе построения маршрутных листов.

Трансфер `TTransfer` - это
- ресурс (может быть композитный ресурс, если хотим перевозить все сразу)
- пара действий `TAction` взять (в узле A) и отдать (в узел B)
- политика возврата (пока описывается локацией, куда вернуть). Одним из свойств экшена является временной интервал, в который его нужно выполнить.


### Фичи (Features)

Алгоритмы Диспатча оценивают выгодность назначения отдельного заказа на отдельного исполнителя с помощью функции от вектора фичей (от англ. feature). Каждая фича - численная характеристика, описывающая добавление заказа исполнителю. На данный момент поддержаны следующие фичи:
- Изменение длительности маршрута курьера при оптимальной вставке заказа в маршрутный лист этого курьера
- Средняя длительность до момента, когда все заказы из маршрутного листа будут доставлены всем клиентам
- Наибольшее время ожидания заказа из маршрутного листа (другими словами, через какое время будет доставлен последний заказ)
- Тип транспорта. Всего поддержано шесть типов транспорта: пеший, вело, электровело, мотоцикл, автомобиль, ровер. Так как это категориальная фича, она разбита по принципу one-hot encoding на шесть булевых фичей, по одной на тип транспорта
- Работает ли водитель по режиму driver fix - фиксированный доход за нахождение в заданной зоне в заданный промежуток времени
- Время до дедлайна по принятию решения для включения трансфера в маршрутный лист
- Приоритет Еды. Сущестует несколько типов приоритетов: совпала лог. группа курьера и заказа, совпала метагруппа курьера и заказа, курьер находится на на плановой смене, курьер находится на свободной смене, требование смены Еды и смены курьера несовместимы.
- Признак, может ли курьер брать батч-заказы.
- Суммарное опоздание.
- Признак того, что заказ батчевый.
- Признак того, что хотя бы на одну точку заказа будет опоздание.
- Признак того, что хотя бы одна точка заказа не попала в идеальный временной интервал.
- Время подлета.
- Батч является чистым таксишным батчем.


### Диагностика

На примере тестинга. Логи в Кибане размечаются параметрами:
- order_id - события по заказу: запросы от лукапа, сброс и поиски кандидатов (дополнительно размечены driver_id)
- driver_id (в формате <park_id>_<driver_id>)
- task_id (в формате <task_type>-<task_id>)

Возможны два типа тасок
- p2p тогда в качестве идишника таски выступает transfer_id
- route-proposition тогда в качестве идишника выступает идентификатор маршрутного листа

Когда создается заказа (сегмент), создается трансфер и создается p2p таска. Если во время обещния с лукапом происходит смена контрактора, то для заданного маршрутного листа для поиска нового исполнителя создаются
route-proposition таски.

Чтобы отфильтровать только размеченные запросы с LD `ngroups :taxi_logistic-dispatcher_testing`

Примеры:
1. История взаимодействий с лукапом, а также связанные с заказом операции
`ngroups :taxi_logistic-dispatcher_testing and order_id: "489a23c1f1c05a74aeb846c40d8b8b80"`
2. История обработки конкретного водителя (матчинг его на таски назначения, причины несоответсвий, ответы в лукапе, отказы)
`ngroups :taxi_logistic-dispatcher_testing and driver_id: "a3608f8f7ee84e0b9c21862beef7e48d_61a2859fa6ae4953bdfa91efe8212453"`
3. Логи назначения на конкретную логистическую таску
`ngroups :taxi_logistic-dispatcher_testing and task_id: "p2p-33d2ce92-6c16-45ae-915f-d17df6ac0fe0"`
4. Последние логи по обработке тасок
`ngroups :taxi_logistic-dispatcher_testing and task_id : *`

5. Последние алерты
`ngroups :taxi_logistic-dispatcher_testing and level: ALERT`