# Движение по маршрутному листу

Маршрутный лист - это упорядоченный набор actions, в процессе исполнения маршрутного листа курьер последовательно выполняет эти action.
Когда курьер принимает первый маршрутный лист в системе Диспатча, у него появляется сессия. В сессии фиксируются выполненные курьером actions.
Существует два способа передать в Диспатч информацию о перемещениях курьеров синхронный и асинхронный. Это два разных подхода, они не могут использвоваться параллельно.

### Синхронная модель

- TODO: Отправка acсept
- TODO: Отправка cancel
- TODO: Получение текущего положения курьера в модели Диспатча

### Асинхронная модель

Следование данной модели подразумевает аккуратное соблюдение точек синхронизации системы.

Синхронизция состояний идет через журнал. Диспатч может вычитывать журнал со следующими типами событий.

1. accept - движение по маршрутному листу. Передается в паре с `session_id`
2. cancel - oтмена заказа.  Передается в паре с `request_code`

{% note warning %}

Обязанность партнера - обеспечивать корректынй порядок записей в журнале (например, то, что после cancel не может следовать accept никакого action в рамках этой сессии).

{% endnote %}

В схеме, когда работа идет через журнал важно обеспечить корректную обработку propositions. Каждый proposition приходит в связке с `session_id` и `current_action_id`.
Это означат, что он построен из соображений, что курьер находится на определенном этапе прохождения текущего маршрутного листа.
Если в системе партнера курьер продвинулся по маршрутному листу дальше, то обрабатывать такой proposition некорректно. Нужно отправить в Диспатч команду `reject_expired`.
Если состояние партнера синхронизировано с состоянием proposition, то можно приступить к его обработке.

{% note alert %}

Перед началом обработки proposition партнеру следует заблокировать все движения по маршрутному листу.
Команда accept для proposition должна происходить строго при условии полно синхронизации состояния курьера в Диспатче и у партнера.

{% endnote %}
