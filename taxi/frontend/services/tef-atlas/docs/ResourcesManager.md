## Проблема

В атласе классификаторы загружаются (загружались) отдельно в каждом контейнере, т.е. если юзер переходит из Pixel на Leaderboad, а потом на Taximap, то ручку метрик он дёрнет 3 раза. При этом есть кейсы, когда нужно иметь возможность получать свежие данные с бэка, загружать каждый ресурс в рамках одного пейджа независимо.

## Цели

1. Оптимизировать время загрузки пэйджей, т.е. снизить число запросов за классификаторами в период пользовательской сессии. _Note: пользы не будет для сценариев, когда юзер заходит на одну пейджу в сессии._

## Задачи

1. Сделать так, чтобы каждый .load* метод класса ресурса должен встречаться в коде проекта один раз.
2. Если ресурс уже был загружен, не загружать его снова.
3. Уметь сбрасывать кеш на отдельных контейнерах.
4. Поддержать обязательность / опциональность ресурса.

## Реализация

1. Весь код лежит в `static/api/resources`.
2. Точка входа для клиентского кода `static/api/resources/index`. Предполагается, что для использования не понадобится ходить в другие файлы `api/resources`. В  `index.ts` доступны:
    1. Типы ResourceType и ResourcesConfigType
    2. ResourceManager с одним публичным методом — `loadResources(types: ResourceType[])`. По умолчанию будут загружены все описанные в конфиге пейджа ресурсы.
3. Есть 3 сущности:
    1. ResourcesManager — порождает набор Resources пэйджи и умеет инициировать процесс загрузки через `resourcesManager.loadResources(types: ResourceType[])`. Нотифицирует, если при загрузке что-то пошло не так, и / или кидает ошибку, если не был загружен обязательный ресурс.
    2. Resource — умеет брать ресурс из ResourcesCache либо загружать с бэкенда.
    3. ResourcesCache. Служебный общий кеш, используется в Resource, чтобы понять, надо ли ходить в бэкенд за свежими данными, а также для сохранения данных в память. 

_Note: на каждую пэйджу создаётся свой инстанс ResourcesManager со своим набором правил._ 

### Чтобы добавить новый ресурс

1. Расширяем `ResourceType` в `api/resources/types`
2. Добавляем лоадер в `api/resources/loaders`

## Как пользоваться

На данный момент доступны такие ресурсы:

```typescript
export const enum ResourceType {
    CLASSES = 'classes',
    CITIES = 'cities',
    PRESET_CITIES = 'preset_cities',
    METRICS = 'metrics',
    TIMEZONES = 'timezones',
    TAGS = 'tags',
    YMAPS = 'ymaps'
}
```

1. Заводим конфиг в `containers/#name#/config.ts`

```javascript
import {ResourcesConfigType, ResourceType} from 'api/resources';

export const resourcesConfig: ResourcesConfigType = [
    {
        type: ResourceType.METRICS,
        required: true,
        cache: true
    },
    {
        type: ResourceType.YMAPS,
        required: true,
        cache: false
    },
    {
        type: ResourceType.CLASSES,
        required: true,
        cache: true
    },
    {
        type: ResourceType.PRESET_CITIES,
        required: false,
        cache: true
    }
];
```

Каждый ресурс описывается так:

```typescript
export type ResourcesConfigItemType = {
    type: ResourceType;
    required: boolean;
    cache: boolean;
    params?: ParamsType;
    ttl?: number;
}
```

2. Добавляем `resourcesConfig` конфиг в asPage: 

```javascript
export const pageConfig = {
    ...rest,
    resourcesConfig
};
```

3. В `container/#name#/preloader.js` получаем инстанс `resourcesManager` из params и дёргаем `loadResources`:

```javascript
import {ResourceType} from 'api/resources';

// если в конфиге пэйджа не было ключа resourcesConfig, то и resourcesManager не будет доступен
.then(() => resourcesManager.loadResources([
    ResourceType.YMAPS,
    ResourceType.CLASSES,
    ResourceType.CITIES,
    ResourceType.TAGS
]))
.then(...)
```

## Фичи

1. Можно указывать список ресурсов, необходимых странице.
2. Можно минимально настраивать кеширование (включение / выключение и ttl). 
3. Ключ кеша складывается из типа ресурса и переданных параметров (для случаев, когда какой-то ресурс загружается с разными аргументами).
4. Можно указывать обязательность / опциональность ресурса. Например, пейджи могут работать и без пресетов городов (в большей части кейсов), но метрики нужны всегда. Если зафейлилась загрузка обязательного ресурса, то дальнейшая пейджа не будет загружена и юзер увидит соответствующее сообщение об ошибке. Если зафейлилась загрузка опционального ресурса, то юзер увидит сообщение с варнингом, но загрузка продолжится.
5. Можно накатывать постепенно, старое апи не менялось.
6. В некоторых случаях нужно инвалидировать кеш (например, на Fabric и Graph, так как там мы вероломно влезаем в state.metrics). Для этого можно использовать `resourcesManager.deleteResources(types: ResourceType[])` или `resourcesManager.deleteCache(types: ResourceType[])`. Первый чистит весь ресурс в контексте менеджера, включая кеш, второй просто чистит кеш (на случай, если на этой пэйдже не сконфигурирован тот ресурс, который надо почистить).

## Проблемы

1. Сейчас ресурсы загружаются при монтировании модала. Нужно сделать ревизию модалов и в тех контейнерах, которые используют модалы с ресурсами, добавить в прелоад загрузку нужных ресурсов. Либо использовать МР в модалах.
2. Сейчас используется внутри asPage, который сам требует переработки.
3. Сейчас кеш хранится в оперативке. Возможно, стоит сделать поддержку длительного хранения. https://github.com/localForage/localForage ?
4. В Pixel полигоны подгружаются внутри мапа, в Areas — внутри preloader.
5. В Areas вообще своё апи для загрузки полигонов.
6. Не трогал Settings, там своя атмосфера, да и слишком уж редко используется всё равно.

## Фич-реквесты

1. Поддержка прогресс-бара.
2. Persistent-storage.
3. Сейчас ResourceManager используется для определения факта того, валиден кеш или нет. Для каких-то случаев (например, в Fabric, где мы перезаписываем metrics), может понадобится добывать "настоящие" данные и перезаписывать их в редакс стор.
4. Отрефакторить хранение классификаторов со стороны редакса. Завести общий state.resources и т.п.
