Потребовалось отобразить метрику поездок по Москве в виде гексагонов и квадкеев, с целью пользовательских исследований. В ходе реализации такой карты, удалось собрать некоторые интересные данные про работу с шестиугольниками в сравнении с квадкеями.  
В качестве библиотеки индекса гексагонов используется библиотека [h3-js](https://github.com/uber/h3-js)  

Были выгружены по Москве и МО в форматах:  
QuadKeys - 15 resolution
![](https://jing.yandex-team.ru/files/csilence/quadkeys.png)
H3 - 8 resolution
![](https://jing.yandex-team.ru/files/csilence/hexagons.png)

Как оказалось, 8-е разрешение H3 приблизительно совпадает с 15 разрешением QK.

### Гексагоны более трудоёмкие в работе
Например такие операции, как расчёт координат по индексу **h3** занимает в ~6 раз больше времени, чем расчёт координат по индексу **qk**.

Замеры:  
QK | 100k элементов | **~250ms**  
H3 | 100k элементов | **~1400ms**

### Рендерить гексагоны сложнее

Квадкеи очень хорошо оптимизируются по рендеру за счёт соответствия координат относительно тайловой сетки и простой квадратной формы.

Гексагоны же не имеют константных данных (например размера, как у квадкеев) относительно локальной CRS (локальная пространственная система координат. пиксели по сути). В конечном итоге отрисованные гексагоны являются неправильными шестиугольниками. Параметры соседникх шестиугольников могут отличаться.
Приходится пользоваться методами пространственными индекса H3 при рендере каждого шестиугольника, дла расчёта координат каждого угла.

Рендер производился по схожей логике как гексагонов, так и квадкеев.
1. Индексируем объекты в KD-tree по lat,lng.
2. На каждый тайл создаём canvas
3. С помощью KD-tree при рендере тайла опрашиваем объекты, которые попадают в bounds тайла.
4. Определяем координаты всех углов объекта
5. Рисуем объект с помощью canvas

Замеры времени рендера тайла:  
Квадкеи - 5-7мс  
Гексагоны - 9-11мс  

![](https://jing.yandex-team.ru/files/eugenest/2020-02-14T07%3A06%3A31Z.png)
![](https://jing.yandex-team.ru/files/eugenest/2020-02-14T07%3A05%3A30Z.png)

Даже не оптимизируя render конкретно под QuadKeys, они выигрывают по времени. В данном случае просто потому, что форма проще, углов меньше.  

### В итоге
Несмотря на то, что работать с гексагонами более трудозатратно чем с квадкеями, их вполне можно использовать для отображения тепловых карт. Нагрузка на браузер больше, но совершенно не критично. Пользователь не заметит разницу в производительности.

![](https://jing.yandex-team.ru/files/csilence/hexagons.gif)