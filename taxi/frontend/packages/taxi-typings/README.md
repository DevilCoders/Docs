# taxi-typings

- [taxi-typings](#taxi-typings)
    - [Установка](#установка)
    - [CLI опции](#cli-опции)
    - [Конфиг](#конфиг)
    - [Плагины](#плагины)
    - [Использование](#использование)
      - [Дефолтный запуск](#дефолтный-запуск)
      - [Запуск отдельных репозиториев](#запуск-отдельных-репозиториев)
      - [Запуск отдельных частей репозитория](#запуск-отдельных-частей-репозитория)
    - [Список поддерживаемых фич OpenApi](#список-поддерживаемых-фич-openapi)
    - [Резолв референсов](#резолв-референсов)
      - [strong resolve](#strong-resolve)
      - [local resolve](#local-resolve)
      - [weak resolve](#weak-resolve)
    - [debug](#debug)
    - [Использование на бэкенде](#использование-на-бэкенде)

### Установка

`npm i -D taxi-typings`

### CLI опции

| option              | required |       default       |                                                                                                                                                                                                                                                  description |
| :------------------ | :------: | :-----------------: | -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------: |
| `--help`            |  false   |          -          |                                                                                                                                                                                                                              Выводит описание опций утилиты. |
| `--context`         |  false   |   `process.cwd()`   |                                                                                                                                                                                                                              Определяет контекст исполнения. |
| `--noCheckout`      |  false   |        false        |                                                                                                                                                                                          Если `true`, то шаг обновления репозиториев из гита будет пропущен. |
| `--config`<br/>`-c` |  false   | `types.config.json` |                                                                                                                                                                                          Путь до файла конфигурации.<br/>Указывается относительно контекста. |
| `--scope`           |  false   |          -          |                                                                                                                                                                                                      Ограничние на то какую часть конфига надо обрабатывать. |
| `--strict`          |  false   |        false        | Если `true`, то при наличии типов или референсов, которые не удалось распознать (трансформировались в `unknown`) процесс генерации завершится ошибкой. Также в этом режиме не будет происходить `weak resolve` референсов (см. раздел про резолв референсов) |
| `--noEmit`          |  false   |        false        |                                                                                                                                                                                                             Если `true`, то `.ts` файлы создаваться не будут |

### Конфиг

| option                       | required | default |                                                                                                                                                                                                                                                                       description |
| :--------------------------- | :------: | :-----: | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------: |
| `specsDir`                   |  false   | `specs` |                                                                                                                                                                                                                      Папка, содержащая спеки. Указывается относительно контекста. |
| `typingsDir`                 |  false   | `types` |                                                                                                                                                                                  Папка, куда будет происходить запись сгенерированных файлов. Указывается относительно контекста. |
| `mountDir` | false | - | Папка, куда (будет) смонтирована Аркадия, требуется, если нужны спеки из нее |
| `plugins` | false | [] | Список плагинов (см секцию про плагины) |
| `repositories`               |   true   |    -    |                                                                                                                                                                                                                               Массив настроек для репозиториев, содержащих спеки. |
| `repositories.vcs` | false | `git` | Используемая система контроля версий, может быть `git` или `arc` |
| `repositories.name`          |   true   |    -    |                                                                                                                                                                                                                       Имя папки внутри `typingsDir`, куда будут записываться типы. |
| `repositories.branch`        |   true   |    -    |                                                                                                                                                                                                                                       Ветка, из которой будет происходить чекаут. |
| `repositories.targets`       |   true   |    -    | Объект для генерации типов, где ключами являются условные названия для групп взаимосвязанных спек, а значения являются массивом папок репозитория. Каждая группа должна содержать все папки необходимые для резолва референсов. Папки указываются относительно корня репозитория. |
| `repositories.roots`         |  false   |   []    |                                                                                                                                                                                                        Дополнительные папки, относительно которых можно резолвить пути из `$ref`. |
| `repositories.typesMap`      |  false   |    -    |                                                                                                                                                                                                                                     Мапинг кастомных названий типов на дефолтные. |
| `repositories.useShortPaths` |  false   |  true   |                 Если `true`, то при генерации тайпингов промежуточные папки, которые можно удалить без риска создания конфликта имен, будут удалены для более коротких путей при импортах. В противном случае структура папок в точности повторит структуру папок из репозитория. |

Для Git

| option                       | required | default |                                                                                                                                                                                                                                                                       description |
| :--------------------------- | :------: | :-----: | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------: |
| `repositories.url`           |   true   |    -    |                                                                                                                                                                                                                                                              URL git-репозитория. |
| `repositories.checkout`      |   true   |    -    |                                                                                                                                                                                            Список папок которые надо чекаутить. Папки указываются относительно корня репозитория. |

Для Arc

| option                       | required | default |                                                                                                                                                                                                                                                                       description |
| :--------------------------- | :------: | :-----: | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------: |
| `repositories.path`           |   true   |    -    |                                                                                                                                                                                                                                                              Путь до нужной папки внутри монорепы |

пример:

```json
{
    "specsDir": "./result/specs",
    "typingsDir": "./result/types",
    "mountDir": "~/arc/arcadia",
    "repositories": [
        {
            "name": "backend-py3",
            "url": "https://github.yandex-team.ru/taxi/backend-py3",
            "branch": "develop",
            "checkout": ["services", "libraries"],
            "targets": {
                "service1": ["services/service1", "libraries/lib1"],
                "service2": ["services/service2", "libraries/lib2"]
            },
            "roots": ["libraries"],
            "typesMap": {
                "integer": "number",
                "float": "number",
                "double": "number",
                "bool": "boolean",
                "date-time": "string"
            }
        },
        {
            "vcs": "arc",
            "name": "uservices",
            "path": "taxi/uservices",
            "targets": {
                "all": ["services", "libraries"],
            },
            "roots": ["libraries"],
        }
    ]
}
```

Полный пример настройки можно найти [тут](https://a.yandex-team.ru/arcadia/taxi/frontend/packages/taxi-typings/e2e).

### Плагины

Если конфиг написан как `js` файл, то можно передать в поле `plugins` массив плагинов, которые будут некоторым образом кастомизировать обработку спек

На текущий момент плагин - объект, который реализует интерфейс

```ts
interface PluginApi {
    dispose(): Promise<void>;
    prepare(): Promise<void>;
    transformYaml(yamlObj: YamlObj): Promise<YamlObj>;
}
```

и соответсвенно можно указывать кастомные трансформации `yaml` спек перед тем, как они будут переработаны в `TypeScript`.

Плагины применяются в порядке указанном в конфиге.

Пример:
```js
// MyCustomPlugin.js
class MyCustomPlugin {
    transformYaml(origin) { ... }
}

// types.config.js
{
    specsDir: '...',
    ...,
    plugins: [
        new MyCustomPlugin()
    ]
}
```

### Использование

#### Дефолтный запуск

-   `./node_modules/.bin/taxi-typings`
-   `npx taxi-typings`

#### Запуск отдельных репозиториев

`npx taxi-typings --scope "repo1 repo2"`

`repo1`, `repo2` соответствуют значениям из конфига `repositories.name`

#### Запуск отдельных частей репозитория

`npx taxi-typings --scope "repo1:target1 repo2:target2"`

`target1`, `target2` соответствуют ключам из конфига `repositories.targets`

### Список поддерживаемых фич OpenApi

-   В качесте источника типов рассматриваются только объекты `definitions` или `components.schemas`
-   Список поддерживаемых типов: `array`, `object`, `string`, `boolean`, `number`, `null` + типы указанные в мапинге через опцию конфига `typesMap`
-   Для типа `object` поддерживается:
    1. `properties`
    2. `required`, но только в виде массива строк
    3. `additionalProperties`, как в форме boolean значения, так и в форме описания нового типа
-   Для типа `array` поддерживается только `items`
-   Для типов `string` и `number` поддерживается `enum` в виде массива соответсвующих типу значений
-   Поддерживается `oneOf`
-   Поддерживается `allOf`
-   Поддерживается `anyOf` в виде фолбека на `oneOf`, если хотя бы один из типов является простым (`string`, `boolean`, `number`), и на `allOf` в противном случае
-   Поддерживается массив строк для `types` в виде фолбека на `oneOf`
-   Поддерживается `$ref`, подробнее про то, как происходит резолв, можно найти далее по тексту
-   Поддерживается `description` для полей объектов и типов описанных в `definitions` и `components.schemas`

Все незнакомые ключи в спеке игнорируются, а в случае если не удалось распознать ничего о типе, то он считается неизвестным (`unknown`).

Типовые кейсы для такого исхода:

-   Не удалось разрезолвить референс
-   Не указан `items` для типа `array`
-   В описании объекта нет ничего кроме `type: 'object'`
-   В спеке используется неподдерживаемые тип и/или структура описания типа

### Резолв референсов

-   Резолв начинается после того, как собрана информация о всех локальных типах во всех файлах в текущем айтеме из `repositories.targets`
-   При резолве референсов игнорируется путь к типу после знака `#`, все типы в любом случае ищутся в `definitions` или `components.schemas` и уже собраны на предыдущем шаге

Далее резолв можно разделить на три стадии `strong resolve`, `local resolve`, `weak resolve`

#### strong resolve

-   В первую очередь референс резолвится как относительный путь от текущей папки, в том числе так может разрезолвится текущий файл, т.е. ссылка на локальный тип
-   Если файл не найден, то как относительный путь от каждой родительской папки поэтапно поднимаясь вверх по каталогам
-   Если файл не найден, то как относительный путь от папок описанных в опции конфига `repositories.roots`, например там может быть путь до библиотек
-   Если файл не найден, то процедура повторяется но только без учета `/docs/yaml`, тк бэкенд имеет соглашение на то, что эту часть пути можно опускать

#### local resolve

-   Если файл не найден, то тип ищется среди описанных в текущем файле

#### weak resolve

-   Не используется с опцией `strict`
-   Если файл не найден, то начинается поиск типа по всем известным файлам в текущем таргете из `repositories.targets` начиная с файлов в текущей папке, затем в дочерних, затем в родительских, затем в остальных

Если тип не найден, то резолв останавлевается а тип указывается как `unknown`

### debug

Утилита работает по принципу игнорирования исключений, по этому в случае, если какой-то yaml не удалось распарсить, или структура спеки привела к падению, то утилита продолжает работу, а информацию об ошибках выведет в конце работы по возможности с указанием в каком файле и каком типе произошла ошибка.

Также выводится информация о референсах, которые пришлось резолвить путем поиска по всем файлам, тк обычно это означает, что в спеке ошибка.

Также для всех файлов содержащих `unknown` типы выводится трейс для каждого типа с указанием места, которое привело к такому результату в формате `Type.properties.b.oneOf.0.items`.

### Использование на бэкенде

Утилиту можно использовать для проверки совместимости спек бекенда с фронтом. Например, создав дополнительны билд в тимсити, который будет запускаться на ПР выставляя статус для разрешения мерджа.

Возможный формат команды:

```
npm i --registry=https://npm.yandex-team.ru taxi-typings &&
npx taxi-typings --noCheckout --noEmit --strict
```

-   `--noCheckout` - чекаут не нужен тк тимсити его уже сделает
-   `--noEmit` - нужно только проверить спеки, файлы с тайпингами фронта создавать не надо
-   `--strict` - чтобы при наличии косяков в спеках билд падал

Конфиг для утилиты можно создавать динамически отдельным скриптом, определяя по дифу гита, какие сервисы были заафекчены в ПР, например.
