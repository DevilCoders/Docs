# Дежурство

В данном разделе разберём флоу диагностирования проблем сервиса. 

**Дежурство** – это мониторинг проблем на продакшне и отслеживание корректности данных, работоспособность в релизном flow.

Подробней о дежурстве описано на [вики](https://wiki.yandex-team.ru/taxi/backend/duty/#vazhnoponimatchemdezhurstvonejavljaetsja).

**График дежурства** - по очереди, за неделю до дежурства и в день начала дежурства приходит сообщение на почту сотрудника.

## Подготовка

У каждого критичного сервиса должен быть дежурный или группа дежурных. Если это не так: нужно завести [сервис в abc](https://wiki.yandex-team.ru/taxi-ito/dutygenerator/) и назначить ответственных. указать эту группу в [service.yaml вашего сервиса](https://wiki.yandex-team.ru/taxi/backend/architecture/yandex.lavka/duty-yandex.lavka/kak-smenit-dezhurnogo-servisa/#porjadokdejjstvijj)

## Общий случай

Рассмотрим ситуацию, вас призывают в чат со словами "всё сломалось".

- Уточняем детали, параллельно выполняем следующие шаги:
- Оцениваем масштаб проблемы. Идём в [графану](https://grafana.yandex-team.ru) и смотрим график вашего сервиса, сколько там bad_rps и какие это коды.
- Если видим всплеск ошибок на графике, ищем причину (если это совпадает с релизом свежей версии) – лучше откатить релиз и дальше разбираться в причинах.
Для этого идём на вкладку "выкатки" и перевыкатываем прошлую успешную версию
{% cut "screen" %}

![](https://jing.yandex-team.ru/files/twin/releases2.png)

{% endcut %}

- Ищем причину: идём на машинку сервиса и смотрим логи nginx и nodejs

```bash
tail -n 2000 /var/log/nginx/error.log
```

```bash
tail -n 2000 /var/log/supervisor/{project}.log
```

- Делаем фикс

## DDoS

Внешние сервисы не застрахованы от DDoS атак. Как правило, в случаи с фронтовыми сервисами страдает в первую очередь CPU на NodeJS начиная таймаутить на запросы и тем самым выключаясь из-под трафика балансера, далее CPU на балансере.
DDoS атаку отлично видно на графиках балансера сервиса. 

**Самый быстрый**, но временный фикс это увеличить CPU в проблемных местах. Паралельно начать процесс по подключению антиробота на балансер

- [Антиробот](https://wiki.yandex-team.ru/jandekspoisk/sepe/antirobotonline/)
- [Пример включение на awacs](https://wiki.yandex-team.ru/taxi-ito/antirobot/)

Так же часть ручек можно закрыть за капчу

## Продакшен упал

Если страдает критичный сервис и живые пользователи, то необходимо завести инцидент, решить его в ближайшее время.

{% note info %}

Общий, для ridetech, флоу разбора инцидентов описан [здесь](https://wiki.yandex-team.ru/taxi/backend/inc/)

{% endnote %}