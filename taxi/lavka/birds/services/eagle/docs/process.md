# Процесс разработки

Здесь описаны основные шаги в процессе разработки и тестирования Орла.

---
## Flow

### Development
1. **Разработчик** переводит тикет в статус `In Progress` и начинает писать код.
2. Когда код готов,
    - **разработчик** создает PR в аркануме,
    - **автоматика** переводит статус тикета в `In Review`.
3. После получения аппрувов в PR **разработчик**
    - [выкатывает свою ветку на анстейбл](#release-unstable),
    - дожидается, пока код полностью задеплоится,
    - переводит статус тикета в `Ready For Testing`.
4. Если **тестировщики** находят в реализации проблемы, они
    - переводят тикет в `In Progress`,
    - дожидаются, пока **разработчик** поправит код, передеплоит его и опять переведет статус в `Ready For Testing`,
    - повторяют цикл, пока баги не кончатся.
5. После того, как **тестировщики** считают, что задача готова и протестирована, они переводят статус тикета в `Tested` — это значит, что PR можно коммитить в транк.
6. После того, как PR в Аркануме закоммитился, **автоматика** переводит тикет в статус `Commited`.

### Release
1. На последнем/предпоследнем стендапе перед релизом
    - **команда** решает, какие задачи успевают в релиз,
    - **ведущий синка** создает [новую версию](https://st.yandex-team.ru/EAGLE/versions) и добавляет в нее тикеты.
2. После того, как все задачи из релиза протестированы, **тестировщики** просят [**дежурного**](https://abc.yandex-team.ru/services/lavkaeagle/duty/) выкатить [версию на тестинг](#release-testing).
3. Когда релиз доезжает до тестинга, **дежурный**
    - переводит статусы тикетов в `Testing at RC`
    - пишет тестировщикам, что можно начинать регресс.
4. Найденные во время регресса баги
    - либо фиксятся в рамках текущих тикетов в релизе,
    - либо под них создаются новые тикеты, которые в зависимости от критичности
        - или фиксятся сразу,
        - или откладываются в бэклог.
5. После того, как в релизе не осталось критичных проблем, **тестировщики**
    - пишут в чат, что можно катить продакшен,
    - переводят статусы в `Ready For Release`.
6. **Дежурный**
    - запускает продакшен-релиз в [Тимсити](https://teamcity.taxi.yandex-team.ru/buildConfiguration/YandexTaxiProjects_Lavka_Birds_Releases_AutoRelease?mode=builds),
    - проверяет, что в версии из пункта (1) есть все тикеты, прилинкованные к релизному тикету в `TAXIREL`,
    - добавляет в комментарий версии ссылку на релизный тикет.
7. **_Если в релизе нужна миграция._** **Дежурный**
    - создает на себя тикет в очереди [TAXIBACKEND](https://st.yandex-team.ru/TAXIBACKEND) с названием "Миграция в базе сервиса lavka_eagle до версии V<номер версии>",
    - добавляет ему компонент "Запуск скрипта",
    - линкует с релизным тикетом как блокирующий,
    - катит продакшен-миграцию, как описано в [доке про БД](db.md#migrations),
    - после успешного завершения миграции закрывает тикет `TAXIBACKEND`.
8. Когда релиз собрался,
    - **таксишный робот** присылает в релизный тикет отбивку, что можно катить престейбл,
    - **дежурный**
        - убеждается, что миграция докатилась и тикет `TAXIBACKEND` закрыт,
        - катит релиз в престейбл.
9. После того как престейбл выехал, **дежурный**
    - убеждается, что
        - в логах нет новых ошибок,
        - интерфейс работает как ожидается,
    - *просит* других разработчиков окнуть выкатку остальных хостов продакшена.
        - **NB** Важно, что другие разработчики не идут запускать выкатку сами, а ждут, пока дежурный проверит, что на престейбле все ОК.
10. Когда релиз доезжает до прода, **дежурный**
    - проверяет, что в логах продакшена нет новых ошибок,
    - интерфейс работает как ожидается.
11. Когда все проверено, **дежурный**
    - переводит релизный тикет в статус `Deployed`,
    - закрывает все тикеты, которые выехали в релизе,
    - проверяет, что все тикеты в версии закрыты,
    - переводит статусы версии `Open` -> `Submit for release` -> `Archive`.
12. Profit!

## How to

### Release unstable

0. [Накатить миграции](db.md#migrations), если они есть, на базу в анстейбле.
1. Добавить к PR в Аркануме тег `taxi/deploy:unstable` (или `taxi/deploy:unstable2` для `unstable2`).
2. Запустить сборку в [Тимсити](https://teamcity.taxi.yandex-team.ru/buildConfiguration/YandexTaxiProjects_Lavka_Birds_Customs_CustomUnstable?mode=builds):
    - для `unstable`: нажать кнопку `Run` и выбрать в визарде запуска ветку `eagle` на вкладке `Changes`;
    - для `unstable2`: нажать кнопку с тремя точками рядом с кнопкой `Run` (кастомная сборка) и дополнительно к указанию ветки `eagle` в визарде на вкладке `Parameters` поправить параметр `rtc_dest` на `unstable2`.
3. Убедиться, что билд закончился успешно:
    - могут быть проблемы со сборкой из-за того, что ее сломал какой-то из PR, отправленных на анстейбл — надо по логам понять, какой PR принес ошибки, убрать его из анстейбла и запустить выкатку еще раз;
    - какие-то из PR, отправленных на анстейбл, могут иметь конфликты по коду — в этом случае надо перевесить свой PR на другой анстейбл и попробовать собрать его.
4. Проверить, что [нужное окружение в rtc](https://tariff-editor.taxi.yandex-team.ru/services/35/edit/355864/branches) полностью раскатилось.

### Release testing

0. [Накатить новые миграции](db.md#migrations), если они есть, на базу в тестинге.
1. Запустить сборку в [Тимсити](https://teamcity.taxi.yandex-team.ru/buildConfiguration/YandexTaxiProjects_Lavka_Birds_Customs_CustomTesting?mode=builds).
2. Убедиться, что билд закончился успешно.
3. Убедиться, что [нужное окружение в rtc](https://nanny.yandex-team.ru/ui/#/services/catalog/lavka_eagle_testing/) полностью раскатилось.
