# Тестирование

## Как это работает?
### e2e
Для снятия скриншотов используется библиотека `jest-image-snapshot`. Но при несовпадении скриншотов она делает снимок диффа.

В директории с тестом создается директория `__image_snapshots__`, в которую попадают все сриншоты при создании. При повторном
прогоне теста, эти сриншоты являются эталонными и с ними происходит сравнение.

При запуске с флагом `-u` скриншоты в `__image_snapshots__` перезаписываются, таким образом обновляя эталон.

При несовпадении скриншотов в директории с тестом создается директория `__diff__`, в которую попадает результат сравнения скриншотов,
представляющий из себя конкатенацию трех изображений: было, разница (подсвечивается красным), стало.

Что происходит при `eagle test e2e`?
1. Чистим директории `__diff__`, оставшиеся от старых прогонов.
2. Стартуем `chromium`, приложение и запускаем прогон тестов.
3. Без флага `-u` `jest-image-snapshot` сравнивает новые скриншоты с эталонными из папки `__image_snapshots__`. Если эталонного сриншота для теста нет - он будет создан, а тест будет считаться пройденным. C флагом - скриншоты будут перезаписаны, и тест так же
будет считаться пройденным.
4. После прогона всех тестов, копируем диффы в папку с репортами `.dev/reports`, чтобы была возможность посмотреть их как артефакты CI.


## Запуск тестов

* Unit тесты

```bash
eagle test unit
```

* e2e тесты
```bash
eagle dev --e2e // Поднимаем стенд с флагом для e2e тестирования
```

Можно управлять каждым флагом отдельно, полный вариант команды запуска для тестов:
```bash
VERSION=latest eagle dev --authMocks --imageMocks --noAnalytics --transactionControl --mockDates --noHttps
```

```bash
eagle test e2e --env dev // Запускаем тесты
```

## Параметры

### Общие (unit + e2e)

#### Путь до тестовых файлов
Параметр `--pathList`, `-p`
```bash
eagle test e2e -p tests/suites/Menu
eagle test unit -p src/service/helper/delay
```

### e2e
#### Обновление скриншотов
Параметр `--update`, `-u`
```bash
eagle test e2e --update
```

Если требуется обновить скриншот для конкретного теста, то необходимо использовать флаг `--test`, `-t`.
```bash
eagle test e2e -t 'Test that i want to update' -u
```

Значение опции - это имя теста в блоке `test` (первый аргумент)
```js
test('<копировать отсюда>', () => {...})
```

#### Время ожидания
```bash
eagle test e2e --timeout 30000
```

#### Количество запусков для упавших тестов
```bash
eagle test e2e --retry 3
```

#### Окружение
Параметр `--env`

* testing (по-умолчанию)
```bash
eagle test e2e --env testing
```

Puppeteer будет ходить в https://eagle.tst.lavka.yandex-team.ru

* dev
```bash
eagle test e2e --env dev
```

Перед выполнением этой команды необходимо поднять приложение локально
Puppeteer будет ходить в https://eagle.lavka.dev.yandex-team.ru:3000

* Любой другой адрес
```bash
eagle test e2e --env http://localhost:3000
```

Перед выполнением этой команды необходимо поднять приложение локально
Puppeteer будет ходить в http://localhost:3000

## Отчеты

Сейчас после запуска тестов отчеты лежат в `.dev/reports/unit-test-report.html` и `.dev/reports/e2e-test-report.html`
