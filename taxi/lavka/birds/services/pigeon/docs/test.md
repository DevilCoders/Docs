# Тестирование

## Как это работает?

### unit
Тесты выполняются в `jest`, все стандартно и общепринято.

Тесты будут обращаться в БД с именем из переменной окружения `PG_DATABASE_UNIT_TEST`, база изначально пустая.

Каждый тест выполняется в транзакции, по завершению теста - транзакция откатывается, поэтому все данные необходимые для теста нужно
готовить в самом тесте, или в lifecycle блоках `beforeEach` / `afterEach`.

**ВАЖНО!**

Так как в проекте используется `jest` и `hermione` (`Mocha`), возникают коллизии глобальных типов (оба фреймворка определяют свои глобальные типы для функций `describe`, `it`, `test` и пр.)

Данные коллизии дают неверные подсказки по типам в IDE, а также могут привести к ошибкам при проверке кода на этапе линтинга, поэтому все глобальные функции `jest` при написании тестов необходимо экспортировать из модуля:
```js
import {describe, expect, it, beforeAll, afterAll, beforeEach, afterEach} from 'tests/jest.globals';
```

### e2e
Тесты выполняются раннером `hermione`, который под капотом использует фреймворки `WebdriverIO` и `Mocha`.

Для выполнения скриншотов и их сравнения используется `look-same`, который уже интегрирован в `hermione`.

Для выполнения assert'ов используется `chai` (по мере необходимости).

`Hermione` соединяется с `selenoid` (быстрая имплементация `selenium grid` на `Go`), который запущен в докер контейнере, по протоколу `webdriver`.

При входящем запросе, `selenoid` запускает докер контейнер(ы) с браузером(ами) и проксирует дальнейшие запросы на них.
Команды, использующиеся в тестах, используют [WebdriverIO API](https://webdriver.io/docs/api).

Одновременно с этим запускается тестируемое приложение. Приложение будет смотреть в БД с именем из переменной окружения `PG_DATABASE_E2E_TEST`, база изначально заполняется тестовыми данными.

При запуске `hermione` отправляется запрос в приложение, который активирует контроллер транзакций (он патчит некоторые объекты `typeORM` чтобы каждый e2e тест выполнялся в транзакции и не создавал в БД записей, которые увидят другие e2e тесты).

В начале выполнения каждого теста посылается запрос в приложение для регистрации уникального идентификатора (uuid) теста в контроллере транзакций (т.е. для этого теста мы создаем изолированное соединение с БД).

В процессе выполнения теста, в момент открытия страницы, устанавливается специальная кука с уникальным идентификатором теста, таким образом приложение знает какое соединение с БД использовать для обработки данного запроса.

После выполнения / падения теста, посылается запрос в приложение, который откатывает транзакцию и закрывает созданное соединение с БД для данного теста.

После выполнения всех тестов посылается запрос в приложения для деактивация контроллера транзакций.

Если тесты выполняются локально, то дополнительно будет поднят контейнер с `selenoid-ui` по адресу http://localhost:8081, в котором можно посмотреть какие браузеры подняты, насколько загружен `selenoid`, а также посмотреть live screen браузера в котором выполняется тест.

**ВАЖНО!**

Для того чтобы сработала вся черная магия, необходимо совершение следующих ритуалов:

 - Каждый тест должен быть описан в блоке `it ()`, а не `test ()`, и в качестве колбека должна быть использована регулярная функция, а не стрелочная:
```js
describe('Тут можно и так и так', () => {
    it('А тут обязательно должна быть регулярная функция', function() {
        ...
    })
})
```

- Контейнеры с браузерами должны быть спулены вручную, `selenoid` их сам не пулит, поэтому перед самым первым запуском тестов на своей машине необходимо будет выполнить `docker-compose pull`.

**ВАЖНО!**

Так как в проекте используется `jest` и `hermione` (`Mocha`), возникают коллизии глобальных типов (оба фреймворка определяют свои глобальные типы для функций `describe`, `it`, `test` и пр.)

Данные коллизии дают неверные подсказки по типам в IDE, а также могут привести к ошибкам при проверке кода на этапе линтинга, поэтому все глобальные функции `hermione` / `Mocha` при написании тестов необходимо экспортировать из модуля:
```js
import {describe, expect, it} from 'tests/hermione.globals';
```
**ВАЖНО!**

Правила написания тестов:
* у каждой страницы своя директория с тестами;
* тесты должны быть "атомарными": один тест – одна проверка;
* ```describe``` – существительное указывающее на сущность или раздел Голубя;
* ```it```, название теста, которое копируем из задачи (торг уместен);
* не делаем скриншоты полной страницы (если это отдельно не оговорено в задаче);
* в каждом тесте делаем скриншот проверяемой области, кроме тестов, проверяющих url, переход на сторонние ресурсы, внутреннюю логику импорта и экспорта;
* в каждый pr по автотестам призываем тестировщика для ревью.

## Запуск тестов

* Unit тесты

```bash
pigeon test unit
```

* e2e тесты
```bash
pigeon dev --e2e // Поднимаем стенд с флагом для e2e тестирования
```

Можно управлять каждым флагом отдельно, полный вариант команды запуска для e2e тестов:
```bash
VERSION=latest PG_DATABASE=pigeon_e2e_test pigeon dev --seedDb --authMocks --imageMocks --noAnalytics --transactionControl --mockDates --noHttps --noDevTools
```

```bash
pigeon test e2e // Запускаем сами тесты
```

## Параметры

### Общие (unit + e2e)

#### Путь до тестовых файлов
Параметр `--pathList`, `-p`
```bash
pigeon test e2e -p tests/suites/menu/menu.hermione.ts
pigeon test unit -p src/service/helper/delay
```

### unit

Параметр `--noCompile`, `-C`
```bash
pigeon test unit -C -p src/service/helper/delay
```
Пропускает компиляцию исходников, т.к. при локальной разработке они уже скомпилированы и нет смысла тратить на это время.

### e2e

#### Название теста
Параметр `--test`, `-t`
```bash
pigeon test e2e -t 'Should create master category'
```

Значение опции - это имя теста в блоке `test` (первый аргумент)
```js
it('<копировать отсюда>', function () {...})
```

#### Запуск графической оболочки
Параметр `--gui`
```bash
pigeon test e2e --gui
```

Запускает графическую оболочку, в которой можно запустить тесты на выполнение, посмотреть результат выполнения тестов и обновить скриншоты.

#### Обновление скриншотов
Параметр `--update`, `-u`
Не рекомендуется использовать на постоянной основе - только если для получения первичного скриншота теста, совместно с опцией `--test`, `-t`
```bash
pigeon test e2e -t 'Test that i want to update' -u
```

Для штатного обновления скриншотов лучше использовать опцию `--gui`

#### Таймаут выполнения теста
```bash
pigeon test e2e --timeout 30000
```

#### Количество перезапусков для упавших тестов
```bash
pigeon test e2e --retry 3
```
## Отчеты

После завершения тестов отчеты лежат в `.dev/reports/pigeon-unit-test-report.html` (для unit тестов) и `.dev/reports/pigeon-hermione-reports/index.html` (для e2e тестов)
Для просмотра отчета по e2e тестам можно воспользоваться командой
```bash
pigeon test e2e --gui
```

## Обновление скриншотов из отчетов в CI

Если e2e тесты упали при прогоне на CI, и надо обновить скриншоты, то можно воспользоваться командой
```bash
pigeon test e2e-accept
```

**ВАЖНО!**

 - Необходимо находиться в ветке того же PR, для которого упали e2e тесты на CI, скриншоты к которым мы хотим обновить.
 - Необходимо иметь OAuth токен для доступа к API teamcity.taxi.yandex-team.ru, прописанный в конфигурационном файле оболочки.
 - Необходимо иметь OAuth токен для доступа к API arcanum.yandex.net, прописанный в конфигурационном файле оболочки.

Данная команда берет `commit sha` последнего коммита в текущей ветке и находит соответствующий ему билд в team-city.
После чего скачивает артефакты к этому билду, распаковывает и запускает `npx hermione gui`.

В браузере открывается интерфейс в котором можно обновить скриншоты, после чего их остается только закоммитить и запушить вручную в текущую ветку.

### Как установить OAuth токен для доступа к teamcity API?
- Необходимо перейти по [ссылке](https://oauth.yandex-team.ru/authorize?response_type=token&client_id=f16eb806b8a5468a91038e3384cbea66) и авторизоваться.
- После авторизации на экране должен появиться токен вида `AQAD-<токен>`, который необходимо скопировать и добавить в конфигурацию терминала.

    Для bash
    ```bash
        echo 'export TEAM_CITY_TAXI_API_TOKEN="AQAD-<токен>"' >> ~/.bash_profile
    ```

    Для zsh
    ```bash
        echo 'export TEAM_CITY_TAXI_API_TOKEN="AQAD-<токен>"' >> ~/.zshrc
    ```

### Как установить OAuth токен для доступа к arcanum API?
- Необходимо перейти по [ссылке](https://a.yandex-team.ru/oauth/token) и авторизоваться.
- После авторизации на экране должен появиться токен вида `AQAD-<токен>` (в поле access_token), который необходимо скопировать и добавить в конфигурацию терминала.

    Для bash
    ```bash
        echo 'export ARC_API_TOKEN="AQAD-<токен>"' >> ~/.bash_profile
    ```

    Для zsh
    ```bash
        echo 'export ARC_API_TOKEN="AQAD-<токен>"' >> ~/.zshrc
    ```
