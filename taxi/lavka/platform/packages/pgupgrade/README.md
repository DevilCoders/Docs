# Утилита pgupgrade

## Введение

Утилита предназначена для выполнения апгрейдов и даунгрейдов баз данных
с шардингом и без оного. В чем смысл

1. миграции апгрейдов могут затрагивать данные
2. миграции могут писаться на Python, Perl, SQL
3. миграции хранятся в выделенной директории

Отличия от pgmigrate:

1. возможность запуска своих скриптов миграций
2. возможность даунгрейда
3. возможность параллельной работы нескольких разработчиков над ветками
с разными апгрейдами
4. Поддерживается работа со схемами (можно мигрировать отдельные схемы в БД)

## Опции командной строки

* `-d|--dsn` - коннект к БД. Опция может повторяться для нескольких шардов
* `-l` - где расположены миграции (по умолчанию в каталоге `migrations`)

## Команды

### Создание шаблона новой миграции

```
pgupgrade migrate
```

Создаёт каталог с миграцией. Назначает валидное имя каталогу.
Например

```
2019-09-06_18.55.19_@unera_update_history_index
```

В начале каталога устанавливается временная метка (время через точки - для
совместимости с Windows), а так же указывается логин пользователя, вызвавшего
`pgupgrade migrate`, затем указывается краткое название миграции.


### Апгрейд БД

```
pgupgrade up
```

Выполнить апгрейд баз данных (всех шардов).

Можно выполнять апгрейд только ДО указанной миграции:

```
pgupgrade up 2019-09-06_18.55.19_@unera_update_history_index
```

При апгрейде каталог миграции читается и выполняются в алфавитном порядке все
файлы заканчивающиеся на `up.sql`, `up.py`, `up.pl`. В случае, если миграция
содержит Python или Perl программу, то эта программа может анализировать
переменные окружения для того чтобы присоединиться к БД:

* `PGHOST` - хост
* `PGPORT` - порт
* `PGUSER` - пользователь
* `PGPASSWORD` - пароль
* `PGDATABASE` - имя базы данных (это же имя дублируется
   первым аргументом командной строки)
* `XPGSCHEMA` - схема (если используется)

### Донгрейд БД

```
pgupgrade down
pgupgrade down 2019-09-06_18.55.19_@unera_update_history_index
```

Выполняет донгрейд БД. При этом в каждой миграции (включая указанную)
выполняются в алфавитном порядке все файлы, заканчивающиеся на `down.sql`,
`down.py`, `down.pl`.


### Реинициализация структуры

```
pgupgrade reinit
```

Иногда требуется просто переинициализировать таблицу `migrations` на хосте,
в этом случае можно использовать эту команду.

### Запуск консоли БД

```
pgupgrade login
```

Можно использовать для того чтобы получить консоль (`psql`) в БД.
Используется или для проверки правильности `dsn` или в админских
целях.


### Переиндексирование всех таблиц в БД

```
pgupgrade reindex
```

Перестраивает все индексы (кроме первичных и с констрейнтами) во всей
схеме public (или указанной schema).

## Формат `dsn` - коннект к БД

Через пробелы разделяются пары ключ-значение:

* `host=h1,h2` - список хостов к БД (если указано более одного, программа
сперва выясняет кто из них является мастером)
* `port=5432` - порт
* `dbname=mydb` - имя базы данных
* `user=usr` - имя пользователя
* `password=pwd` - пароль пользователя
* `schema=abc` - имя схемы

### Работа со схемами

Если имя схемы задано, то таблица `migrations` в которой хранится стейт
апгрейдов будет создаваться в этой схеме. SQL-файлы и Python/Perl программы
должны самостоятельно указывать имя схемы в своих запросах.
