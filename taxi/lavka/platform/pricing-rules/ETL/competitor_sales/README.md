# Модуль подготовки данных для отчётов в Tableau

Модуль состоит из двух частей:
* обработка данных парсинга
* формирование таблиц для отчетов в Tableau

## Обработка данных парсинга

В зависимости от источника данных скрипты по обработке лежат в соответствующих директориях:
* lavka -- данные по продажам, продуктам, точкам Лавки
* samokat -- данные парсинга приложения Самоката
* x5 -- данные парсинга приложения ОКОЛО

В каждой папке структура файлов одинаковая и готовит таблицы следующего содержания:
* assortment -- каталог товаров и дерево категорий
* sales -- данные по продажам (в основном вычисленные на основе остатков). Для X5 ещё и данные по ценам пишутся в отдельную таблицу.
* shops -- данные по магазинам

### Assortment

Результатом работы скрипта являются 2 таблицы: каталог товаров и категорийное дерево, размотанное в длинную таблицу.

**Каталог товаров (actual_products)**

Принимается, что ID товара является уникальным для всей сети (ключ). Данные каталога обновляются каждую неделю. 
Данные по тем товарам, которые продавались последнюю неделю обновляются, остальные товары остаются в таблице для истории.

|Поле|Тип|Значение|Комментарий|
|----|---|--------|-----------|
|barcode_list|LIST(String)|Список баркодов||
|brand_name|String|Название бренда, если оно есть||
|description|String|Описание товара||
|sku_id|String|ID товара||
|sku_name|String|Название товара||
|sku_values|String|Характеристика товара|В основном это вес, но может быть и объём, в зависимости от источника и товара|
|stm|Bool|Флаг СТМ товара||
|update_utc_dt|String|Дата последнего обновления информации||
|urls|String|Список ссылок на картинки товара||
|category_id|Int|Используется для внутренних нужд|Только для Х5|
|plu|String|Внутренний ID сети (артикул)|Только для Х5|

**Категорийное дерево (actual_categories)**

Дерево фронтовых категорий. Ключа у таблицы нет, так как любой товар может находится более чем в одном категорийном дереве.
Категории проставляются в разрезе SKU-магазин из-за предположения, что в разных городах 
товар может относиться к различным категориям.

Данные по подкатегориям перезаписываются каждую неделю. При этом, формируются только по данным парсинга последней недели. 
Для каждой пары товар-магазин выбирается самое актуальное категорийное дерево.

Теоретичести, товары могут иметь уровни категорий больше 
подкатегории четвёртого уровня, но они отбрасываются в силу избыточности информации.

|Поле|Тип|Значение|Комментарий|
|----|---|--------|-----------|
|category|String|Категория||
|shop_id|Int, String|Id магазина|тип данных может меняться в зависимости от источника, но согласуется с типом всего источника|
|sku_id|String|Id товара||
|subcategory|String|Подкатегория первого уровня||
|subcategory2|String|Подкатегория второго уровня||
|subcategory3|String|Подкатегория третьего уровня||
|subcategory4|String|Подкатегория четвёртого уровня||
|update_utc_dt|String|Дата последнего обновления информации||

### Sales (saily_sales, daily_prices)

Данные по продажам. Для конкурентов вычисляются на основе остатков, для Лавки на основе заказов. Продажи расчитываются за весь месяц, в который попадает период расчёта (сейчас период расчёта неделя, так как обновление еженедельное). Если период расчёта захватывает 2 месяца то продажи пересчитываются за оба. Продажи каждого месяца пишутся в свою таблицу с названием ГГГГ-ММ-01.
Ключ таблицы товар-магазин-дата.

|Поле|Тип|Значение|Комментарий|
|----|---|--------|-----------|
|gmv|Double|Дневной GMV||
|gmv_with_disc|Double|Дневной GMV с учётом скидки|Есть не для всех источников|
|price|Double|Последняя цена, встретившаяся за день||
|price_wo_disc|Double|Последняя цена без учёта скидки, встретившаяся за день||
|sales|Double|Дневные продажи||
|shop_id|Int, String|Id магазина|тип данных может меняться в зависимости от источника, но согласуется с типом всего источника|
|sku_id|String|Id товара||
|utc_dt|String|Дата||

При парсинге ОКОЛО (x5) периодичность парсинга цен (раз в день) расходится с периодичность парсинга остатков (раз в полчаса). Поэтому для X5 отдельно пишутся таблицы дневных цен. Структура аналогична таблицам дневных продаж.

|Поле|Тип|Значение|Комментарий|
|----|---|--------|-----------|
|price|Double|Последняя цена, встретившаяся за день||
|price_wo_disc|Double|Последняя цена без учёта скидки, встретившаяся за день||
|shop_id|Int, String|Id магазина|тип данных может меняться в зависимости от источника, но согласуется с типом всего источника|
|sku_id|String|Id товара||
|utc_dt|String|Дата||

### Shops (shops)

Данные по точкам продаж. Данные по актуальным точкам. Старые точки туда могут не попадать. Ключ -- Id магазина.

|Поле|Тип|Значение|Комментарий|
|----|---|--------|-----------|
|address|String|Адрес магазина||
|city|String|Город|Для Лавки из словаря, для самоката из характеристики zone, для ОКОКЛО из координат магазина и библиотеки GEO|
|coverage|List(String)|Список Id зон покрытия|Только для самоката|
|coverage_ids|List(List(List(Double)))|Список полигонов зон покрытия|Каждый полигон является списком списков (широта, долгота)|
|lat|Double|Широта||
|lon|Double|Долгота||
|shop_id|String, Int|Id магазина|тип данных может меняться в зависимости от источника, но согласуется с типом всего источника|
|update_utc_dt|String|Дата обновления таблицы||

## Формирование таблиц для отчётов в Tableau

Таблицы формируются для 2 основных отчётов и одного второстепенного:
* Сравнение продаж до матчинга
* Сравнение продаж после матчинга
* Сравнение продаж после матчинга для Москвы в разрезе магазина (adhock)

### Сравнение продаж до матчинга (unmatched_sales/half_year)

Берутся все данные из таблиц магазинов, товаров, категорий и продаж за последние 90 дней, джойнятся между собой и аггрегируются в разрезе товар-город-дата. Данные по всем конкурентам объединяются в 1 таблицу.

|Поле|Тип|Значение|Комментарий|
|----|---|--------|-----------|
|comp_sku_id|String|Id товара конкурента||
|sku_name|String|Название товара||
|city|String|Город||
|comp_name|String|Название конкурента||
|source|String|Источник данных||
|category|String|Категория товара||
|subcategory|String|Подкатегория первого уровня||
|subcategory2|String|Подкатегория второго уровня||
|subcategory3|String|Подкатегория третьего уровня||
|subcategory4|String|Подкатегория четвёртого уровня||
|gmv|Double|Дневной GMV товара в городе||
|sales|Double|Дневные продажи товара в городе||
|last_price|Double|Медиана цены по городу||
|last_promo_price|Double|Медиана промо цены по городу|В случае, если товар продавался по регулярной цене -- NULL|
|stm|Bool|Признак СТМ||
|utc_dt|String|Дата||

### Сравнение продаж после матчинга (matched_sales/tableau_data)

Формируется таблица заматченных товаров во всех городах, где продаёт Лавка (есть костыль, на добавление к продажам лавки цен в тех города, куда ещё не вышли). Затем к таблице джойнятся данные по продажам из первой главы всех конкурентов за период расчета (на данный момент неделя). Все данные агрегируются за период.

Данные в итоговую таблицу дозаписываются, а не перезаписываются. В дальнейшем нужно рассмотреть возможность автоматической подчистки таблицы.

|Поле|Тип|Значение|Комментарий|
|----|---|--------|-----------|
|calc_period_end_date|String|Дата начала периода вычислений||
|calc_period_start_date|String|Дата конца периода вычислений||
|category|String|Категория товара||
|city|String|Город||
|gmv|Double|Суммарный GMV конкурента товара в городе за период||
|lavka_id|String|Id товара Лавки|Если аналога не было -- NULL|
|original_name|String|Оригинальное название товара||
|price|Double|Последняя цена конкурента в городе за период расчёта||
|price_with_disc|Double|Последняя промо цена конкурента в городе за период расчёта||
|sales|Double|Продажи товара конкурента в городе за период расчёта||
|shop_name|String|Название конкурента|Лавка в том числе|
|sku_id|String|Id товара| из таблицы matched|
|sku_name|String|Название товара| из таблицы matched|
|some_price|Double|Цена Лавки для SKU_ID, если цены лавки нет, то Самоката минимаркета, в противном случае Супермаркета||
|some_price_perc_033|Double|33% перцентиль some_price в городе||
|some_price_perc_067|Double|67% перцентиль some_price в городе||
|subcategory|String|Подкатегория первого уровня||
|subcategory2|String|Подкатегория второго уровня||
|subcategory3|String|Подкатегория третьего уровня||
|subcategory4|String|Подкатегория четвёртого уровня||

### Сравнение продаж после матчинга по Москве в разрезе магазина (_over_shops)

Скрипт аналогичен предыдущему, со следующими измененими:
* данные продаж фильтруются только по москве
* к магазинам лавки присоединяются данные по продажам точек самоката, с которыми конкурирует лавка. Затем, если конкурентов у одной лавки получилось больше одного, то данные усредняются. Это то самое слабое место, которое мешает добавить скрипт в прод. Данные по сопоставлениям точек лавки и самоката не обновляются.
* далее алгоритм остаётся таем же, но в качестве города теперь выступает Id Лавки.
