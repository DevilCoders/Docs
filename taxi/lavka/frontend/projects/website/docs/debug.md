# Отладка

Для отладки в проекте используется query-параметр debug с различными значениям, например: `debug=message,robot` или `debug=message&debug=robot`.

Некоторые `debug`-параметры используются для логирования действий на сервере (доступны только из внутренней сети):

| Имя         | Функционал                                            |
| ----------- | ----------------------------------------------------- |
| `request`   | Сетевые запросы в бэкенды                             |
| `message`   | Свои данные - `req.debug.push('message', {})`         |
| `system`    | Cистемная информация (версия, имя пода, ...)          |
| `all`       | Все вышеперечисленные                                 |

Другие `debug`-параметры используются для симуляции различных браузеров и режимов:

| Имя         | Функционал                              |
| ----------- | --------------------------------------- |
| `mobile`    | Включение вида для мобильного браузера  |
| `desktop`   | Включение вида для десктопного браузера |
| `robot`     | Включение вида для поискового краулера  |

## Заголовок

Для отладки отдельных запросов в api, можно использовать заголовок - `X-Lavka-Debug`.
Значения принимает такие же, что и query-параметр debug.

## Где и как смотреть вывод debug данных

Всю информации по времени поступления можно разделить на две части: SSR и отдельный запрос к API из браузера.

### SSR
Содержит отладочную информацию о том, что происходило на BFF во время SSR. Выводится в консоль браузера.
Содержит три поля:
  - `DEBUG` - секция с `request`, `message`, `system` сообщениями.
  - `PAGE_PROPS` - данные, которые были инициализированы/созданы на BFF и считается, что они нужны браузеру.
  - `REACT_QUERY_STATE` - конечное состояние state manager для BFF и начальное для браузера. Замечание: дальнейшие изменения состояния не будут отображаться в этом объекте.

### API
В ответе API приходит два поля:
  - `data` - ответ ручки.
  - `debug` - секция с `request`, `message`, `system` сообщениями.

## Рекомендации
1. Поставить расширение браузера `modHeader` и по умолчанию накинуть заголовок `X-Lavka-Debug: all`.
Тогда если вы, вдруг, захотите что-то посмотреть, то не придётся перезагружать страницу и заново проделывать все шаги.
2. Посмотреть [видео](https://frontend.vh.yandex.ru/player/4dafb3f63f42c4b7bde287fd92c750a9?from=partner&mute=0&autoplay=1&tv=0&no_ad=false&loop=false&play_on_visible=false) про отладку.
3. Если есть понимание, что какой-то информации не хватает, то попросить разработчика добавить её.

P.S. Если добавлять заголовок через расширение `modHeader`, то, иногда, в этом случае могут блокироваться запросы на другие адреса. К примеру, прямой поход из браузера на https://grocery-authproxy.lavka.tst.yandex.ru блокируется из-за CORS политики. В этом случае просто отключите добавление заголовка. Пример ошибки:
```
Access to fetch at 'https://grocery-authproxy.lavka.tst.yandex.ru/csrf_token' from origin 'https://grocery-frontend-standalone.lavka.tst.yandex.ru' has been blocked by CORS policy: Request header field x-lavka-debug is not allowed by Access-Control-Allow-Headers in preflight response.
```
