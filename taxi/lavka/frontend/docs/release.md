# Релизы

{% note info %}

Наш проект в CI расположен [здесь](https://a.yandex-team.ru/projects/lavkafrontend/ci).

{% endnote %}

В CI поддержан релизный флоу - [https://docs.yandex-team.ru/ci/release](https://docs.yandex-team.ru/ci/release)

## Типы релизов
В CI поддержаны два типа (флоу) релизов:
* Из транка;
* Из релизной ветки.

Мы используем флоу с релизной веткой. Преимущества:
* Фиксируем все фичи текущего релиза;
* После отведения нового релиза Транк может жить своей жизнью и не влиять на релиз;
* Стабилизируем релиз, баг-фиксы влияют точечно только на релизную ветку.

По мере развития автотестов хочется отказаться от флоу с релизными ветками в пользу сборки сразу из транка.

Вкратце флоу работает следующим образом:
* CI хранит у себя версию релиза;
* При новом мажорном релизе отводится релизная ветка и мажорная версия увеличивается на 1;
* При минорном релизе мажорная версия не меняется, а увеличивается минорная;
* В итоге каждый релиз имеет версию вида {major}.{minor} , например `17.4`.

Это означает, что в рамках релиза 17 было 5 сборок - `17.0 → 17.1 → 17.2 → 17.3 → 17.4`.

## Релизные ветки
Релизные ветки - это специальный тип веток в Arc.

У нас заведен префикс `releases/lavka/frontend/`.

Пример релизной ветки - `releases/lavka/frontend/release-webview-37`.

{% note info %}

Больше информации о релизных ветках [тут](https://docs.yandex-team.ru/devtools/src/arc/branches#release-branches) и [тут](https://docs.yandex-team.ru/ci/release#branches)

{% endnote %}

## Как запустить релиз

### Мажорный
В левом меню найти проект и выбрать ветку trunk.
После чего справа нажать на Run release:
![Старт нового мажорного релиза](_images/release/major-start.png "Старт нового мажорного релиза")

В данном примере запустится релиз 12 сервиса dev-api.

На таймлайне (выделено в центре) видны новые коммиты, которые войдут в этот релиз.

После запуска в левом меню появится новый пункт, в данном случае `releases/lavka/frontend/release-dev-api-12`.

В него можно перейти и посмотреть флоу, какие кубики запустились:
![Посмотреть кубики релиза](_images/release/show-jobs.png "Посмотреть кубики релиза")

### Минорный
Нужно привезти новые коммиты в нужную релизную ветку.

Это можно сделать двумя путями:
1) Влить изменения в транк, после чего в интерфейсе сделать cherry-pick (предпочтительный способ);

{% cut "Скриншот" %}

![Черри-пик в релиз](_images/release/cherry-pick.png "Черри-пик в релиз")

{% endcut %}

2) Делать пулл-реквесты сразу в релизную ветку.

{% note warning %}

Если коммиты попали в релизную ветку по пути №2, то после выкладки релиза нужно не забыть принести их в trunk.

{% endnote %}

## Несколько релизов сразу
Есть возможность запускать несколько релизов одного сервиса одновременно.

Usecase - в тестинге проверили `Релиз #1` и готовы катить в прод.
Но уже поздно (или начались учения) и выкладку в прод решили отложить до завтра.
Но в тестинг хочется собрать новый `Релиз #2` и начать тестировать, чтобы не терять время.

Чтобы понять как это работает, рассмотрим стадии релиза. Релизы поделены на стадии.

В Лавке выделяем 4 стадии:
- Prepare. Создание релизного тикета, подвязывание changelog;
- Testing. Сборка и выкладка в тестинг, запуск чекеров и нагрузочного;
- Production. Выкладка в pre_stable и stable. Сборка production артефакта происходит на стадии testing, для ускорения;
- After_production. Выкладка на unstable, закрытие тикетов и прочие мелочи.

По-умолчанию в CI новый релиз может начать выполнять какую-то стадию, только если предыдущий релиз прошел эту стадию.

Например, `Релиз #1` прошел стадию prepare и testing, остановился на ожидании manual trigger на стадии production.

`Релиз #2` в таком случае можно собрать и он пройдет стадии prepare и testing, но далее остановится, ожидая завершения стадии production у `Релиза #1`.

![Ожидание другого релиза](_images/release/wait-another-release.png "Ожидание другого релиза")

Если по какой-то причине `Релиз #N-1` упал на какой-то стадии и его решили не продолжать, а просто дропнуть в пользу `Релиз #N`, то нужно отменить `Релиз #N-1` через интерфейс.

После этого `Релиз #N` пойдет дальше.

![Отмена релиза](_images/release/cancel.png "Отмена релиза")

{% note warning %}

Вся машинерия про релизы и стадии хорошо описаны [в документации](https://docs.yandex-team.ru/ci/release)

{% endnote %}

{% note alert %}

Если `Релиз #N-1` уже дошел до минимум pre_stable, то лучше его не дропать, это может сломать Clownductor и заблокировать последующие релизы.

Лучше всё же сделать нужный фикс и докатить его до прода в рамках `Релиза #N-1`.

{% endnote %}
