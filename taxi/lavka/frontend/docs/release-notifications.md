# JNS

## Сводка

**JNS** - система, позволяющая другим системам уведомлений отправлять нотификации разным получателям и в разном в формате через единый API.

Для заведенного в JNS проекта (lavkaweb, lavka-front, lavkafrontenddevapi) для понимания происходящего стоит различать 2 сущности: *каналы/channels* (получатели) и *шаблоны/templates* (формат отправляемых уведомлений).

**Каналы**. Канал - объект с настройками, который указывает, куда будут отправляться уведомления. На каналы есть ограничение - в рамках одного канал можно использовать один транспорт. То есть если вы хотите отправлять сообщение в формате определенного шаблона, например, в telegram и на email, будет необходимо завести 2 канала и отправить одинаковые данные, указав один и тот же шаблон в каждый канал по отдельности. Ограничений на количество получателей в рамках одного канала не накладывается - уведомление может быть отправлено хоть в 23 telegram-чата и 19 пользователям. [Подробнее про каналы](https://docs.yandex-team.ru/jns/channels)

**Шаблоны**. Шаблон - это схема, которая описывает, как должно выглядеть конечное уведомление, отправляемое в канал. Шаблоны делает полезными возможность указания параметров [различных типов](https://docs.yandex-team.ru/jns/sources#shablony), которые в дальнейшем могут быть использованы для формирования уведомления. Параметры представляют из себя компоненты конечного уведомления (готовый текст, сообщения об ошибках, сырые данные, которые могут быть обработаны непосредственно в шаблоне или просто вставлены в него), передаются вместе с указанным именем шаблона (важно ознакомиться с п. 3 *наших соглашений при работе с JNS*). Для шаблонизации в JNS используется [handlebars 3.0](https://handlebarsjs.com/guide/), расширенный на уровне JNS полезной вспомогательной функцией `split`, фактически позволяющей обрабатывать приходящие в параметры шаблона данные любым образом. [Подробнее про шаблоны](https://docs.yandex-team.ru/jns/sources#shablony)

[Подробнее про JNS](https://docs.yandex-team.ru/jns)

## Мотивация (какую проблему решает JNS)

- JNS позволяет объединять сырые или же готовые к отображению для конечного пользователя данные из разных источников и не завязываться на формате, в котором эти данные хочет видеть получатель при отправке - то есть давать возможность решить, как обрабатывать (и отображать) данные и в каком формате это нужно делать прямо на месте.

- JNS позволяет централизовать работу с уведомлениями - при отправке уведомлений в JNS посредством тасклетов в CI/API напрямую необходимо указать лишь JNS проект, канал и шаблон, которые определят, какое уведомление будет отправлено и куда оно будет отправлено - если необходимо будет изменить формат сообщения, не придется править код, в котором происходит отправка уведомления - можно будет сделать это в рамках проекта JNS. При добавлении уведомления в коде (в случае CI - в a.yaml) придется лишь попололнять перечень существующих в проекте каналов и шаблонов.

- JNS позволяет изменять существующие уведомления непосредственно разработчикам проекта, отвязывая формат уведомлений от CI и оставляя за последним только необходимость передачи параметров в обозначенные каналами с указанными шаблонами.

## Примеры, как JNS может быть использован в CI

Сейчас используется [кубик, возвращающий ченжлог релиза](https://a.yandex-team.ru/arcadia/ci/registry/common/misc/README.md#common/misc/get_changelog). Кубик возвращает строку, передаваемую в кубик JNS *(кубик умеет работать только со строками)*. Для простоты понимания можно сказать, что коммит представлен номером тикета, хэшем коммита и автором коммита, разделенными строкой `_INTERNAL_A_`, а коммиты разделены строками `_INTERNAL_B_`. В шаблонах JNS можно разделить строку по данным "внутренним" разделителям и получить массив, элементы которого можно будет использовать для формирования уведомления. Таким образом, не приходится писать посреднического кода для форматирования коммитов - можно управлять форматом прямо из JNS.

## Как мы используем JNS

Сейчас мы используем JNS в основном в релизных нотификациях. Для каждого из проектов заведены отдельные JNS-проекты: lavkaweb, lavka-front, lavkafrontenddevapi.

```yaml
projects: # Juggler/JNS projects
  website: &jns_website_project lavkaweb
  webview: &jns_webview_project lavka-front
  dev-api: &jns_dev-api_project lavkafrontenddevapi
```

В flow-vars мы передаем шаблоны `templates`, которые могут быть выбраны в кубике - для нового типа нотификаций добавляется новый шаблон, даже если он дублирует какой-то из существующих - отдельный шаблон отвечает за отдельную нотификацию:

```yaml
templates: &jns_templates_release
  release_started: release-started
  testing_deploy_started: testing-deploy-started
  testing_deploy_finished: testing-deploy-finished
  prestable_deploy_prepared: prestable-deploy-prepared
  prestable_deploy_approved: prestable-deploy-approved
  prestable_deploy_finished: prestable-deploy-finished
  stable_deploy_approved: stable-deploy-approved
  stable_deploy_finished: stable-deploy-finished
  previous_release_deploy_finished: previous-release-deploy-finished
```

На данный момент используется только один канал:

```yaml
channels:
  release_notifications:
    telegram: &jns_channel_release_notifications_telegram release-notifications-telegram
```

Если в уведомлениях понадобится несколько каналов, вероятно, удобнее всего будет указать канал по умолчанию и перечень каналов, а в нотификациях, в которых будет недостаточно телеграма, отправку в несколько каналов можно будет разрулить через директиву `multiply`/`by`.

## Соглашений, которых нужно придерживаться при работе с JNS

1. Имена всех заводимых шаблонов должны состоять из строчных букв и быть в kebab-case (за исключением префиксов/суффиксов);

2. **при добавлении или удалении новых уведомлений или при изменении количества транспортов уже существующих необходимо добавлять соответсвующие каналы в JNS/удалять более не используемые**;

3. В каждом шаблоне необходимо указывать все "Template params", которые шаблон будет получать (к примеру, все параметры, отправляемые через тасклет) - **даже если они не используются**, иначе произойдет ошибка и уведомление не отправится!

4. При создании **всех без исключения** шаблонов для уведомлений из Arcadia CI, имя заводимых шаблонов иметь префикс "`ci-`";

5. При создании **всех без исключения** каналов (`Channels`) в JNS необходимо в имя сущности добавлять суффикс "`-<TRANSPORT_TYPE>`":

- email
- telegram
- sms
- slack
- webhook
- yachats
- tracker
- phone
