## Админка
### Как работает сейчас
Сейчас у админки динамическая форма, с одной стороны это удобно - быстро и легко добавить новые external поля. External поля - это метаданные серии промокода, которые используются для валидации. С другой стороны динамическая админка не поддерживает весь функционал, который хочется, например, загрузка набора плейсов через csv файлы.

[Админка в тестинге](https://tariff-editor.taxi.tst.yandex-team.ru/eats-promocodes/codes)

Настройка формы:
[Конфиг в тестинг](https://tariff-editor.taxi.tst.yandex-team.ru/dev/configs/edit/COUPONS_SERVICE_MAP_SERIES_EDIT_FORM_SCHEMAS?group=coupons&name=schem)

[Дока по описанию динамической формы](https://rjsf-team.github.io/react-jsonschema-form/) (не вся функциональность поддерживается) 

### Как будет работать

[Макет новой админки](https://miro.com/app/board/uXjVOz0mDQQ=/) (за доступом к [Даше](https://staff.yandex-team.ru/dtarishkina))

Динамическая админка позволяет сделать почти все из коробки кроме некоторых пунктов, которые надо либо сделать, либо переделать. А именно:
1. Список пользователей. Этот параметр отвечает за то, чтобы промокод работал только на указаных yandex_uid-ах. Сейчас это работает так: серии промокода заводится параметра user_list, после этого этот user_list описывается в конфиге [EATS_COUPONS_USERS_LISTS](https://tariff-editor.taxi.yandex-team.ru/dev/configs/edit/EATS_COUPONS_USERS_LISTS), а точнее там прописывается путь до YT таблицы с yandex_uid-ами. Хочется упростить этот процесс, поэтому предлагаю этот путь до YT таблицы явно прописывать в параметре серии, таким образом мы сократим время разработчика, который занимается исправлением конфига и сделаем создании подобных промокодов проще. Параметр, который будем заполнять предлагаю назвать users_list_yt_path. [Обрабатывать параметр user_list_yt_path](https://st.yandex-team.ru/EDAJAM-633) Также есть проблема доступности таблиц в YT - если отключиться кластер Hahn(с которого мы читаем user_list) и сервис будет перезапущен, то кэш данных не сможет обновиться, поэтому я предлагаю вычитывать данные из YTя и сохранять их постгрес. Мы будем хранить в постгресе списки людей для которых промокд актуален, и периодически очищать эту базу(когда у промокодов будет истекать срок действия). Это предлагаю делать в отдельной задаче [Повысить надежность user_list промокодов](https://st.yandex-team.ru/EDAJAM-639)
2. Проверка количества заказа пользователя. Некоторые промокоды хотят давать только на первый заказ в сервисе/places/brands/и прочее. Сейчас для этого создается объект first_order, в котором записана информация о places/brands. Предлагаю это переделать, потому что помимо этого объекта также есть просто places/brands (промокоды, которые действуют только на эти плейсы/бренды) и это может привести к путанице, потому что информацию надо будет дублировать в first_order и в самих places/brands. Также предлагаю сразу расширить функционал - применять промокод, если у пользователя от X до Y заказов. Это позволит как явно выделять новичков от 0 до 0, так и делать более сложные проверки. Ддя надо оставить два поля places/brands/прочее и начать хранить в метаинформации промокода счетчики, например, places_order_cnt_from/to, shipping_type_order_cnt_from/to. И написать новый валидатор по этим флагам(код можно переиспользовать из уже существующих валидаторов на новичковость, правда они не сейчас не работают:)). Новый валидатор будет ходить в сервис статистики, агрегировать результат по нужным слоям и проверять новичковость. Хочу заметить, что если в поле places выбрано несколько place_ids и указаны счетчики новичковости, то это означает, что считать количество заказов мы будем по всем place_ids, которые указаны. То есть новичком будет считаться только тот человек, который не заказывал ни в одном из выбранных ресторанов. [Валидатор на новичковость пользователя](https://st.yandex-team.ru/EDAJAM-634)
3. Статистика пользователей. Сейчас статистика берется из коры, и это не правильно, потому что кора хранит данные всего за пол года. Нужно перейти на сервис eats-order-stats и агрегировать информацию оттуда(как в скидках). Единственная проблема перехода - это то, что сервис купонов оперирует yandex_uid-ами, а не eater_ids. Поэтому предлагаю сначала ходить в eats-eaters, чтобы получить по yandex_uid-ам eater_ids, а дальше идти с ними в сервис статистики. [Перейти на сервис eats-order-stats](https://st.yandex-team.ru/EDAJAM-635)
4. Применять промокод только на нужной платформе. В ручку валидации приходит авторизационный контекст, оттуда надо вытаскивать платформу(поле platform) и валидировать ее. [Валидатор на плаформы](https://st.yandex-team.ru/EDAJAM-617)
5. Применять промокод по place_business. Сейчас такого нет. Надо прокидывать в payload валидаторов информацию о place_business, эта информация есть в eats-cart, надо просто начать прокидывать. Ну и конечно написать валидатор. [Валидатор на place_business](https://st.yandex-team.ru/EDAJAM-631)
6. Применять промокод по shipping_type. Аналогично place_business. [Валидатор на shipping_type](https://st.yandex-team.ru/EDAJAM-616)
7. Применять к плейсам. Уже есть и работает.
8. Применять к брендам. Уже есть, но пока не запущен. Проверю в рамках тикета [Проверить текущие валидаторы](https://st.yandex-team.ru/EDAJAM-602)



Давайте также разберем АПИ создания серии


Поля, которые мы заполняем:
- series_id 
- start 
- finish 
- services - по дефолту всегда 'eats'
- external_meta 
- descr 
- usage_per_promocode 
- user_limit
- is_unique
- country
- value
- count 
- percent 


Поля, которые можно было бы начать использовать:
- percent_limit_per_trip - ограничение на один заказ
- is_volatile - для волатильных промокодов
- bin_ranges - бины
- bank_name - Название банка, чьи диапазоны хранятся в bin_ranges
- first_usage_by_payment_methods - первое использование по СО
- payment_methods - СО
- creditcard_only - оплата только картой

Поля, которые мы не используем:
- cities 
- classes 
- first_usage_by_classes 
- requires_activation_after 
- for_support 
- external_budget 
- first_limit
- applications


А также давайте поговорим о полях, которые будут хранится в json external_meta:
- db_validation - поле нужно, чтобы перезаписывать данные серии для некоторых промокодов при генерации, например, для сори-промокодов. Сама серия живет несколько лет, а промокод должен жить пару недель.
- business_type - поле для обработки логики типов промокодов. Например, если в нем выбран тип paid, то при также появляются дополнительные поля для отчетов.
- description_tanker_key - танкерный ключ описания промокода
- users-list - название листа, с помощью которого будем брать путь до YT из конфига(deprecated после [Обрабатывать параметр user_list_yt_path](https://st.yandex-team.ru/EDAJAM-633) )
- users_list_yt_path - непосрдественно путь для YT таблицы с yandex_uid
- place_ids - плейсы, в которых применяется промокод
- brand_ids - бренды, в которых применяется промокод
- shipping_types - способы доставки, в которых применяется промокод
- place_business - типы бизнеса, в которых применяется промокод
- platforms - платформы, в которых применяется промокод
- place_ids_order_cnt_from, place_ids_order_cnt_to - счетчики для статистики, при которых будут срабатывать промокоды. Аналогичные названия для eats(сервиса), shipping_types, place_business, platforms, brand_ids
- external поя для paid промокодов: 
    - payment_scheme - enum prepayment/postpayment
    - VAT_rate - ставка НДС
    - side_VAT_rate - НДС на стороне
    - agent_implementation - bool, реализация через агента
    - agent_commission - комиссия агента
    - sale_discount - скидка на продажу
 
## Антифрод

Основная хотелка антифрода, чтобы мы брали статистику по склеинным yandex_uid-ам. Склеинные юиды мы уже обрабатываем, в [задаче про статистику](https://st.yandex-team.ru/EDAJAM-635) они будут учтены

Также хочется уметь в онлайне как-то помечать device_id, cart_id, eater_id, personal_phone_id фродовыми, если мы замечаем у них фрод деятельность. Эта проработка будет в отдельном тикете.

Также замечу, что сейчас нет возможности использовать промокод на СО "наличка" - мы здесь ничего трогать не будем.


## Баг без которого ничего не заработает
Очень важно сделать задачу [Починить работу с валидаторами их купонлиста без контекста](https://st.yandex-team.ru/EDAJAM-626), этот баг с большим количеством сайд-эффектов, например, использованные промокоды не удаляются, в супераппе нет кнопки "использовать промокод" на экране промокодов, нельзя активировать промокод в супераппе на странице промокодов.


Тикет | Оценка 
------ | ------ 
[Обрабатывать параметр user_list_yt_path](https://st.yandex-team.ru/EDAJAM-633) | 2d
[Валидатор на новичковость пользователя](https://st.yandex-team.ru/EDAJAM-634) | 2d
[Перейти на сервис eats-order-stats](https://st.yandex-team.ru/EDAJAM-635) | 3d
[Валидатор на плаформы](https://st.yandex-team.ru/EDAJAM-617)| 2d
[Валидатор на place_business](https://st.yandex-team.ru/EDAJAM-631) | 2d
[Валидатор на shipping_type](https://st.yandex-team.ru/EDAJAM-616) | 2d
[Починить работу с валидаторами их купонлиста без контекста](https://st.yandex-team.ru/EDAJAM-626) | 3d
[Проверить текущие валидаторы](https://st.yandex-team.ru/EDAJAM-602) | 2d
[Повысить надежность user_list промокодов](https://st.yandex-team.ru/EDAJAM-639) | 3d