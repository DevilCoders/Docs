### Как работает сейчас
Сейчас при заведении серии промокодов, можно в настройках серии указать список валидации (user-list). В этом списке yandex_uid-ы пользователей, для которых промокод применим. 

Список валидации - это строка, которая является ключом в конифиге [EATS_COUPONS_USERS_LISTS](https://tariff-editor.taxi.yandex-team.ru/dev/configs/edit/EATS_COUPONS_USERS_LISTS)
Этот конфиг содержит массив ключ/значение, где ключ это список валидации(который указывается в серии), а значение - это путь к табличке YT 
//home/eda-analytics/crm/crm-team/communication-databases/*

Чтение из YT производит [компонента](https://a.yandex-team.ru/arcadia/taxi/uservices/services/eats-coupons/src/components/users_lists.hpp), которая хранит в памяти эти валидационные списки

У такой реализации несколько минусов
- компонента ходит в YT раз в n минут, поэтому списки валидации доезжают долго
- при обовлении списков валидации, он какое то время не дает использовать промокоды, так как кэш какое то время пустой
Минусы текущей реализации уже всплыли. Для их решения предлагается хранить валидационные списки в PG [Тикет](https://st.yandex-team.ru/EDAJAM-674)

### Есть 2 варианта добавления в список валидации:

1. Класть в YT таблицы необходимые yandex_uid
Плюсы:
- Ничего не нужно делать в сервисе eats-coupons и все будет работать даже сейчас
Минусы:
- Так как мы хотим раздавать промокоды из CRM, после раздачи может следом уйти пуш или смс, который проинформирует о промокоде. А работать эти списки будут только после того, как компонента прочитает yt. 
- Останется ручная часть, которая требует добавления в конфиг пути до таблицы со списками пользователей

2. Класть в PG через специальную ручку
Плюсы:
- Не будет лага при обновлении списков
- Достаточно просто реализовать со стороны CRM поход в ручку перед активацией промокода
- PG собираются в любом случае прикручивать к сервису и хранить валидационные списки там
Минусы:
- Нужно писать ручку


Исходя из пплюсов и минусов, предлагаю делать ручку с сохранением в pg

Ручка post /internal/series/users-list
Request:
    type: object
    additionalProperties: false
    required:
        - user_list
        - yandex_uids
    properties:
        series_id:
            description: Серия промокода, для которой добавляем пользователей
            type: string
            minLength: 1
        yandex_uids:
            description: Список yandex uid, которые нужно добавить в валидационный список
            type: array
            minItems: 1
            items:
                type: string
                minLength: 1

Ручка будет проверять существование валидационного списка в серии и добавлять пользователей в pg (естесвенно без поворов).
В случае успешного добавления будет возвращать пустой ответ 200
В случае ошибки валидации 404

В ручку будем ходить из сервиса crm-hub, такими же пачками пользователей, как и stq генераии и активации промокода (Под конфигом по 250 пользователей)

Как хранить списки в PG:

    CREATE TABLE eats_coupons.promocodes_users_lists (
        id BIGSERIAL PRIMARY KEY,
        series_id TEXT NOT NULL,
        yandex_uid TEXT NOT NULL,
        created_at timestamptz NOT NULL
    );

    CREATE UNIQUE INDEX users_lists_series ON eats_coupons.promocodes_users_lists (series_id, yandex_uid);

При работе периодика, будем проверять серии из таблицы eats_coupons.promocodes_users_lists и будем удалять те записи, серии которых просрочены. Под конфигом бдудт задано время, через которое необходио удалить после завершения серии (Поставим недели 2).
Дату окончания действия серии промокодов можно получить в ручке сервиса coupons /internal/series/info

Валидация будет производиться через новый валидатор. Новый валидатор будет делать запрос в таблицу promocodes_users_lists с yandex_uid и series_id. 
Из админки нужно выпилить users_list и сделать bool параметр, включающий валидацию по пользователем.

Также нужно реализовать скрипт, который будет вставлять новые записи в таблицу eats_coupons.promocodes_users_lists.
Скрипт должен на вход принимать серию и yandex_uid-ы. yandex_uid-ы можно передавать как путь до таблицы YT, так и массивом строк.
Существующие списки перевезем в PG как раз с помощью этого скрипта.

Старую реализацию оставим, до того момента пока не будет сделана новая. Потом отключим старый валидатор и выпилим код.
