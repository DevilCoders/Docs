# Непрерывная стоимость доставки

## Как сейчас

Корзина

![cart_now](./img/cart_now.svg)

<!--
@startuml img/cart_now.svg

"eats-cart" -> "eats-catalog": Получение инофрмации о заведении
"eats-catalog" -> "eda-delivery-price": Получение трешхолдов и суржа
"eda-delivery-price" -> "eats-catalog"
"eats-catalog" -> "eats-catalog"
note right
Применяет сурж к трешхолдам
и ограничивает максимальную
стоимость доставки
end note
"eats-catalog" -> "eats-cart"

@enduml
-->

Слаг

![slug_now](./img/slug_now.svg)

<!--
@startuml img/slug_now.svg

"eats-catalog" -> "eda-delivery-price": Получение трешхолдов и суржа
"eda-delivery-price" -> "eats-catalog"
"eats-catalog" -> "eats-catalog"
note right
Применяет сурж к трешхолдам
и ограничивает максимальную
стоимость доставки
end note

@enduml
-->

## Как предлагается MVP

### Корзина

Прайсинг на своей стороне расчитывает
функуцию стоимости доставки, сурж и ограничение максимальной стоимости
доставки.
Принимает в отдельной ручке текущую стоимость корзины,
а возвращаеьт цену доставки.

ВАЖНО: на стороне корзины необходим эксперимент только
по переносу цен из каталога в либу, сам эксп
с непрерывной ценой будет на стороне прайсинга и эта схема
должна скрывать от корзины
работаем мы с трешхолдами или с более сложной функцией

![cart_mvp](./img/cart_mvp.svg)

<!---
@startuml img/cart_mvp.svg

"eats-cart" -> "eats-catalog": Передаем флаг, что в прайсинг ходить не нужно
"eats-catalog" -> "eats-surge-resolver"
"eats-surge-resolver" -> "eats-catalog": Сурж радиусом
"eats-catalog" -> "eats-cart": Возвращает информацию о заведении
"eats-cart" -> "eda-delivery-price": Передает сумму текущей корзины
"eda-delivery-price" -> "eda-delivery-price"
note right
Расчитывает стоимость доставки и сурж,
применяет ограничение max цены
end note
"eda-delivery-price" -> "eats-cart": Цена доставки и сурж

@enduml
-->

### Цены на слаге

Для MVP решения, кажется достаточно только на стороне прайсинга
подменять трешхолды на реперные точки функции цены доставки.
Однако, у нас нет технической возможности изменять цену доставки на слаге
при обновлении корзины. Поэтому при сурже, придется отрисовывать фиксированную стоимость
доставки. Для этого нужно будет получать эту стоимость в явном виде
в каталоге от прайсинга, то есть перенести прибавление суржа к трешхолду
на сторону прайсинга.

## От MVP до PROD

### Доработки корзины

Отображать прогресс бар с реперными точками, сам прогресс бар
должен попадать на фронт из корзины.
Но в таком случае есть два сценария.
Если корзина пуста, то на слаге должны отображаться трешхолды из каталога
по логике описанной в MVP решении.

Если корзина не пуста, то в ручке /v1/cart возвращается
объект описывающий прогресс бар, который корзина пробрасывает
как есть из прайсинга.

![cart_prod](./img/cart_prod.svg)

<!--
@startuml img/cart_prod.svg

"client" -> "eats-cart": Модифицирующий запрос корзины
"eats-cart" -> "eda-delivery-price": Запрос цены доставки и прогрессбара
"eda-delivery-price" -> "eats-cart": Возвращает прогресс бар как additionalProperties
"eats-cart" -> "eats-cart": Сохраняет цену и прогресс бар в базу
"eats-cart" -> "client": Отдает цену и прогресс бар

@enduml
-->

На немодифицирующие запросы корзины, поход в прайсинг не нужен

![cart_prod_get](./img/cart_prod_get.svg)

<!--
@startuml img/cart_prod_get.svg

"client" -> "eats-cart": Получение корзины
"eats-cart" -> "eats-cart": Достает цену и прогресс бар из базы
"eats-cart" -> "client": Отдает цену и прогресс бар

@enduml
-->

## Слаг

Без изменений
