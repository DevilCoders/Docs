## Опросник для ревью комитетом

> Этот опросник нужен для [архитектурного ревью комитетом](https://forms.yandex-team.ru/surveys/25357/). Его можно будет скопировать.

> После его написания можно пробежаться по списку из [этой статьи](https://stackoverflow.blog/2020/04/06/a-practical-guide-to-writing-technical-specs/). Он подскажет, какие аспекты еще стоит осветить.

**Название сервиса**

eats-robocall

**Какую продуктовую проблему решает сервис?**

Еда активно использует робоколл, например:
- Оповещение ресторана о непринятом заказе
- Оповещение об отмене заказа по вине курьера или ресторана
- Оповещение курьера о неправильном поведении

Хотим использовать записи реального голоса, IVR и переадресации.

**Почему нельзя решить эту задачу без разработки нового сервиса существующими решениями?**

Доработка в Коре требует ПХП-кода, текущая архитектура плохо приспособлена к добавлению новых сценариев, 
а также каждый сценарий с живым голосом или IVR требует доработки на стороне Октоноды.

**Как именно сервис будет решать поставленные перед ним задачи?**

1. Предоставляет простое продуктовое апи для вызова наших сценариев.
2. Сокрывает сложность использования IVR-framework.
3. Использует актуальное решение для робоколла вместо устаревшего АПИ Октоноды.

**Разрабатывается один сервис или система?**

Один сервис

**Сколько и какие сервисы входят в систему?**

—

**С кем взаимодействует сервис?**

1. ivr-dispatcher
2. eats-proactive-support
3. eda-core
 
**Какие базы использует?**

PostgreSQL для истории звонков.

**Какие периодические процессы?**

—

**Прикрепите схему того, где этот сервис находится в текущей инфраструктуре**

Схема в [документации](https://wiki.yandex-team.ru/eda/dev/backend/services/eats-robocall/#kartaservisov).

**Какие данные и по какой схеме сервис будет хранить в базе?**

```sql
CREATE SCHEMA eats_robocall;

-- таблица с данными истории звонков
CREATE TABLE IF NOT EXISTS eats_robocall.calls
(
    call_external_id TEXT PRIMARY KEY,
    ivr_flow_id TEXT NOT NULL,
    personal_phone_id TEXT NOT NULL,
    order_nr TEXT,
    claim_id TEXT,
    claim_alias TEXT,
    eater_id TEXT,
    place_id TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX calls_created_at_idx ON eats_robocall.calls (created_at);
CREATE INDEX calls_updated_at_idx ON eats_robocall.calls (updated_at);
```

**Какой объем данных будет храниться и какой объем будет изменяться в единицу времени?**

До 8 МБ в день. Обновление в секунду: ~ 30 КБ
Данные храним 3 месяца, то есть будет храниться объём данных: 0.75 - 1 ГБ

В будущем количество звонков будет увеличено минимум втрое от текущего количества, 
то есть эквивалентно вырастет и объём данных.

**Какие операции над данными заложены?**

- Сохранение данных в виде истории звонков
- Передача данных в админку

**Есть ли какой-то стейт в памяти, как он обновляется и валидируется?**

Динамические данные, необходимые для выбора сценария саппорта, данные ответа абонента.

**Какая нагрузка ожидается?**

- Запрос звонков: 0.25 rps от проактивки, закладываем 0.75 rps
- Внутри сценария звонка ivr-dispatcher: 0.25 - 1 rps

Возможен рост нагрузки с ростом проактивного саппорта.
    
**Какие фолбеки предусмотрены на сам этот сервис?**

1. Если сервис откажет в момент запроса звонка, то звонок не создастся
2. Если сервис откажет во время звонка, то звонок будет удержан и абонент будет слушать тишину

**Какие фолбеки предусмотрены внутри этого сервиса на взаимодействие с другими сервисами?**

- Если откажет база, то не сохраним звонок в историю
- Если откажет ivr-dispatcher в момент создания звонка, то не создадим звонок
- Если откажет ivr-dispatcher в момент активного звонка, то после выполнения 
всех заданных сценариев абонент будет слушать тишину

**Какие возможности масштабируемости закладываются?**

Наращивание количества инстансов сервиса при увеличении нагрузки.

**Какие точки отказа есть в сервисе?**

- Потеря связности с сервисом ivr-dispatcher
- База данных

**Укажите ключевые продуктовые метрики сервиса, за которыми планируете следить**

- Количество звонков(принятых, непринятых)
- Средняя продолжительность звонка

**Укажите технические метрики**

- Все ответы от сервиса в логах для дебага
- Серверные метрики (CPU, RAM, i/o и т.д.)
- Ошибки в логах

**Какая функциональность ожидается в сервисе в будущем?**

Добавление новых сценариев проактивного саппорта, 
прозвонов по масс-найму и согласования «заказа у двери» вместо звонка от курьера.

**Какое изменение нагрузки планируется?**

Пропорционально росту проактивного саппорта.

**Активно ли будет изменяться сервис?**

Да.

**Язык, на котором пишется сервис**

C++

**API**

Ручка /create-call для запроса звонка
Ручка /v1/ivr-framework/call-notify для сценария звонка

**Пример конфига сценария**

```json
{
  "actions": [
    {
      Экшен нужен в случае, если звонок инициируют не с помощью ручки create_call.
      (приводится просто как пример, не надо так делать) 
      "id" : "originate_action",
      "next_action_id" : "playback_action_speak",
      "action_body" : {
        "originate" : {
          "phone_number" : "+375445571982",
          "timeout_sec" : 2000
        }
      }
    },
    {
      --Первым идёт экшен, который должен сыграть, как только человек поднимет трубку.
      (как мне посоветовали это должен быть wait на пару секунд для того, чтобы человек не пропустил первые слова)
      "id" : "playback_action_speak",
      "next_action_id" : "playback_action_play",
      "action_body" : {
        "playback" : {
            "speak" : {
                "text": "Привет. Как дела?"
            }
        }
      }
    },
    {
      "id" : "playback_action_play",
      "next_action_id" : "ask_action_dtmf",
      "action_body" : {
        "playback" : {
          "play" : {
            "id": "happy_music",
            "path": "s3:/voices/happy_music.wav"
          }
        }
      }
    },
    {
      "id": "ask_action_dtmf",
      "next_action_id": "",
      "action_body": {
        "ask": {
          "playback": {
            "play": {
              "id": "question1",
              "path": "s3:/voices/question1.wav"
            }
          },
          "input_mode": "dtmf",
          "allowed_dtmf": "123",
          "action_after_answer": {
            "1": {
              "next_action_id": "ask_action_text"
            },
            "2": {
              "next_action_id": "ask_action_text"
            },
            "3": {
              "next_action_id": "ask_action_text"
            },
            "__default__": {
              "next_action_id": "ask_action_dtmf"
            }
          },
          "no_input_timeout_ms": 15000,
          "immediate_input": false
        }
      }
    },
    {
      "id": "ask_action_text",
      "next_action_id": "",
      "action_body": {
        "ask": {
          "playback": {
            "play": {
              "id": "question2",
              "path": "s3:/voices/question2.wav"
            }
          },
          "input_mode": "text",
          "action_after_answer": {
            "Я не знаю": { "next_action_id": "wait_action" },
            "Да": { "next_action_id": "hangup_action" },
            "Нет": { "next_action_id": "hold_action" },
            "__default__": { "next_action_id": "ask_action_text" }
          },
          "no_input_timeout_ms": 15000,
          "immediate_input": true
        }
      }
    },
    {
      "id": "hold_action",
      "next_action_id": "forward_action",
      "action_body": {
        "hold": {
          "cause": "Пытаемся найти свободного оператора"
        }
      }
    },
    {
      "id": "wait_action",
      "next_action_id": "hangup_action",
      "action_body": {
        "wait": {
          "timeout_sec": 15
        }
      }
    },
    {
      "id": "forward_action",
      "next_action_id": "hangup_action",
      "action_body": {
        "forward" : {
          "phone_number" : "+79156579359",
          "timeout_sec" : 15
        }
      }
    },
    {
      "id" : "hangup_action",
      "next_action_id" : "",
      "action_body" : {
        "hangup" : {
          "cause" : "normal-clearing"
        }
      }
    }
  ]
}
```
<hr>
