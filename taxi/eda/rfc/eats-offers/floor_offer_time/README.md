# Округление времени офера

## Какую проблему решаем (глобально)

Сейчас при запросе в главный экран,  каталог для всех ресторанов доступных для
пользователя запрашивает факт наличия суржа в них. На это тратиться примерно
160ms и делается несколько параллельных запросов по 1000 ресторанов за раз.

Так как сурж рестораноцентричен и зависит только от времени офера и самого
заведения, хотим кэшировать сурж в LRU-кэше на уровне каталога.

### Как сейчас

![now](./img/now.jpg)

### Как будет

![want](./img/want.jpg)

## Какую проблему решаем в оферах

Так как offer_time сейчас совпадает с временем запроса в сервис оферов на
создание офера, это очень точное время, включающее доли секунд. Из-за этого
такой кэш будет не эффективным.

Однако, если округлить время офера до минут, то hit-rate значительно
повышается. Во всех ручках каталога мы дополнительно (пока, но в рамках
глобальной задачи перестанем) ходим отдельно за суржом радиусом с теми же
параметрами (offer_time, place_id), так как сурж радиусом влияет только на
резолв зон доставок, который происходит только в каталоге, тут мы использовали
округление времени офера на стороне каталога. И получили хороший результат от
кэширования -
[Результаты](https://st.yandex-team.ru/EDACAT-2543#623323619f218404473f669a)

Но денежный сурж используется не только в каталоге, но еще и в
- eda_core
- eats-surge-notifier

Если так же для денежного суржа округлять время только на уровне каталога, то
возникнет рассинхрон времени для которого зафиксирован сурж в разных сервисах,
и сурж начнет флапать.

Поэтому округление времени офера предлагается сделать на стороне сервиса оферов
для потребителей оферов спека не будет изменена, изменения будут только в коде
оферов.
