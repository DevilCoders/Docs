# Идемпотентность чекаута
## Проблемы:
1. Таймаут сервиса eda_core во время создания заказа (POST api/v1/orders) приводит к значительным проблемам:
     - на стороне бэкенд eda_core заказ создается, но пользователь этого не знает
     - фронты делают ретрай с корзиной, которая по факту может быть уже удалена (закрыта для изменений) и получают ошибку
     - фронты делают ретрай конкурентно созданию другого заказа. В таких случаях создается новый заказ, а старый отменяется специальным механизмом поиска дубликатов, создавая дополнительную нагрузку на сервис

2. Имеется дополнительная задача которую хотим решить идемпотентностью: матчинг офферов пользователя. Сейчас, фронт вместо идентификатора оффера присылает платежную информацию и сумму к оплате. По этим данным на стороне бэка мы пытаемся найти подходящий оффер и применить его. Хочется уйти от этой схемы, в пользу передачи идентификатора оффера в явном виде, тогда задачу матчинга не нужно будет решать вовсе

## Решение:
1. Модифицируем ответ /go-checkout сервиса eda_core. Ответ /go-checkout возвращает список предложений по способам оплаты и доставки заказа. Для каждого предложения добавляем свой уникальный идентификатор
2. Бэк гарантирует уникальность данного идентификатора
3. Идентификатор формируется на основе платежных данных и идентификатора контекста. Идентификатором контекста для новой корзины может служить id корзины + номер ревизии
4. Во время запроса в POST api/v1/orders принимаем этот идентификатор от фронта и связываем его с заказом. Код создания заказа переписываем с применением компонента [ExecutionSchema](https://wiki.yandex-team.ru/users/pivchenberg/executionschemabundle/). Он обеспечит необходимую блокировку для этого процесса и выполнит каждый фрагмент кода идемпотентно. Если фронтенд не дождался ответа и ретраит свой запрос, конкуретный запрос упрется в блокировку и будет ожидать завершения первого запроса. После того как создание заказа завершится в первом запросе, конкуретный получит order_nr и вернет его фронтам, без повторного создания заказа.

## Изменение в API:
1. сервис: eda_core, ручка: api/v2/cart/go-checkout, добавим в объект ответа offers[0..n].requestId, string, nullable
2. сервис: eda_core, ручка: POST api/v1/orders, добавим в объект запроса requestId, string, nullable




   
