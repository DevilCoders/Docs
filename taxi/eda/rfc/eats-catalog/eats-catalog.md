
# Table of Contents

1.  [Схема текущего каталога](#org3d6c2a7)
    1.  [Клиентские ручки](#orgbcf1867)
        1.  [/api/v2/catalog](#org01e35ec)
        2.  [/api/v2/catalog/carousel](#org7935580)
        3.  [/api/v2/catalog/popular](#orgb5dee70)
        4.  [/api/v2/catalog/{slug}](#org48fb3bc)
        5.  [/api/v2/catalog/pickup-list](#orgc983198)
        6.  [/api/v2/catalog-stores](#orgc77d829)
        7.  [/eats/v1/catalog/v1/brands/place-search](#orgfd58c4a)
    2.  [Серверные ручки](#org5c0ad07)
        1.  [Wizard](#org7adeeaa)
        2.  [Layout constructor](#org586f79d)
        3.  [Корзина](#orgf1cf42a)
        4.  [Коллекции](#orga59d319)
        5.  [Misc](#org6e730d0)
    3.  [Кеши](#orgb4cbf1f)
        1.  [Зоны доставки](#orgdaebd13)
        2.  [Быстрые фильтры](#orgfd10ef1)
        3.  [Настройки курьеров](#orgdf10c84)
        4.  [Настройки рейтинга](#orgfc88e05)
        5.  [Настройки условий доставки (устарело)](#org195869c)
        6.  [Промоакции](#orgba7e0d3)
        7.  [Регионы](#org4af1aed)
        8.  [Полигоны](#orge53d1e6)
2.  [eats-catalog](#orgf23930f)
    1.  [Резолв зон](#org6902cee)
        1.  [resolve as a service](#org7624218)
        2.  [resolve без состояния](#org4a8f7a4)
        3.  [resolve как "прокся"](#org087f54b)
        4.  [resolve as library](#org97d4837)
        5.  [resolve как часть eats-catalog-storage](#org5be5285)
    2.  [Вспомогательные ручки](#org8072c23)
        1.  [Ручка /eats/v1/catalog/v1/brands/place-search](#org4a769ef)
        2.  [Ручка /api/v2/catalog-stores](#org7fe870e)
        3.  [Ручка /api/v2/availability](#orga6bf1fb)
        4.  [Ручка /api/v2/catalog-polygons](#org10eea26)
    3.  [Слаг](#orgde9c2a5)
        1.  [Переезд /api/v2/catalog/{slug}](#org1036982)
        2.  [Не перевозить /api/v2/catalog/{slug}](#org90d894d)
    4.  [Колдунщик](#org08f455d)
    5.  [Каталог](#org74d2462)
    6.  [Откуда будут браться данные?](#org405c36a)
        1.  [Кэш](#org45c837c)



<a id="org3d6c2a7"></a>

# Схема текущего каталога


<a id="orgbcf1867"></a>

## Клиентские ручки

Краткое описание клиентских ручек каталога. Большая часть этих
ручек не требует переноса в новые сервис так как их функционал уже
частично или полностью заменен сервисом `eats-layout-constructor`.


<a id="org01e35ec"></a>

### /api/v2/catalog

-   [Спека](https://bb.yandex-team.ru/projects/EDA/repos/spec-api/browse/specs/client_core_v2/spec.yml#55)

До BDU являлась основной клиентской ручкой каталога. Основная
задача данной ручки заключается в том чтобы вернуть список
заведений доступных пользователю на указанный момент времени
и в указанном месте.
Вместе со списком заведений ручка возвращает мета информацию о
выдаче и возможных опциях фильтрации и сортировки, примерами
такой мета информации являются таймпикер, список быстрых фильтров
и список сортировок.

Данную ручку можно оставить в текущем Go каталоге потому что весь
ее функционал становится ненужным при полном переходе всех
фронтендов на `eats-layout-constructor` и `eats-full-text-search`.

**Нагрузка:** ~90rps - должна упасть почти до 0 при переходе всех
фронтендов на BDU

![img](img/api-v2-catalog.png)

---


<a id="org7935580"></a>

### /api/v2/catalog/carousel

-   [Спека](https://bb.yandex-team.ru/projects/EDA/repos/spec-api/browse/specs/client_core_v2/spec.yml#55)

Предоставляет список заведений для карусели "Акции и новинки".
На текущий момент эта ручка уже весьма устарела - поскольку клиент
делал два отдельных запроса на получение каталога и получение
карусели это создавало проблемы синхронизации, так как два разных
запроса могли поступить в разные поды и результат фильтрации,
сортировки и дедупликации мог получиться разным для отдельных
заведений из-за подобных проблем различные карусели давно проросли
в ручку `/api/v2/catalog`. В добавок к этому ручка становится
излишней в свете возможностей, которые предоставляет
`eats-layout-constructor`.

Схема работы ручки почти ничем не отличается от схемы работы ручки
`/api/v2/catalog` за исключением того, что из выдачи ручки
фильтруются все заведения, которые не содержат промоакций и
новых, и результат обрезается до 200 заведений.

**Нагрузка:** ~90rps - должна упасть почти до 0 при переходе всех
фронтендов на BDU

---


<a id="orgb5dee70"></a>

### /api/v2/catalog/popular

-   [Спека](https://bb.yandex-team.ru/projects/EDA/repos/spec-api/browse/specs/client_core_v2/spec.yml#59)

Предоставляет список заведений без указания геопозиции
пользователя. Данная ручка используется фронтендами, в которые
пользователь может попасть не передавая свою геопозицию - в
основном десктопный вэб.
Данная ручка может принимать идентификатор региона Еды и
возвращать список из 50 наиболее популярных заведений.

Схема работы ручки гораздо более простая по сравнению с ручкой
`/api/v2/catalog` однако из-за того что она должна отсортировать по
популярности все заведения в регионе она может потреблять
большее количество ресурсов.

Кажется, что переносить эту ручку в новый каталог не требуется - 
поиск заведений по региону, без указания геопозиции, планируется
имплементировать в `eats-layout-constructor`.

**Нагрузка:** ~20rps

![img](img/api-v2-catalog-popular.png)

---


<a id="org48fb3bc"></a>

### /api/v2/catalog/{slug}

-   [Спека](https://bb.yandex-team.ru/projects/EDA/repos/spec-api/browse/specs/client_core_v2/spec.yml?at=c4b200ce15701326cd7d8174f89ae63d6fd93c3c#67)

Предоставляет информацию о заведении по уникальному текстовому
идентификатору "slug".
Это единственная клиентская ручка, которая требует переноса из
старого каталога, без изменений - все фронтенды, в данный момент,
завязаны на эту ручку.

**Нагрузка:** ~70rps

![img](img/api-v2-catalog-slug.png)

---


<a id="orgc983198"></a>

### /api/v2/catalog/pickup-list

-   [Спека](https://bb.yandex-team.ru/projects/EDA/repos/spec-api/browse/specs/client_core_v2/spec.yml?at=c4b200ce15701326cd7d8174f89ae63d6fd93c3c#79)

Предоставляет список заведений доступных для самовывоза. При
изначальном проектировании самовывоза планировалось добавлять
большое количество функционала, которого не было в основной ручке
каталога поэтому листинг заведений самовывоза вынесли в отдельную
ручку, которая идет примерно по тому же флоу, что и
`/api/v2/catalog`, но с небольшими отличиями - у самовывоза свой
список сортировок, своя логика построения таймпикера и он не
нуждается в запросе суржа и ранжировании в ML.
На текущий момент, вся логика этой ручки уже перенесена под
`eats-layout-constructor` поэтому переносить ее в новый сервис нет
необходимости.

**Нагрузка:** <1rps

![img](img/api-v2-pickup-list.png)

---


<a id="orgc77d829"></a>

### /api/v2/catalog-stores

-   [Спека](https://bb.yandex-team.ru/projects/EDA/repos/spec-api/browse/specs/server_catalog-service_v1/spec.yml?at=b60330ca6c1d78009cf8ab657c9c0f069c19b66e#83)

Данная ручка была сделана при запуске Лавки для поиска ближайшей
доступной Лавки по геопозиции пользователя или просто наиболее
популярной лавки в регионе на случай если пользователь пришел в
Лавку без геопозиции на вэбе.
Необходимость переноса данной ручки надо обсудить с разработчиками
фронтенда - на момент написания данного документа, в ручку
поступает ~2rps трафика.

**Нагрузка:** 2rps

![img](img/api-v2-catalog-stores.png)

---


<a id="orgfd58c4a"></a>

### /eats/v1/catalog/v1/brands/place-search

-   [Спека](https://bb.yandex-team.ru/projects/EDA/repos/spec-api/browse/specs/server_catalog-service_v1/spec.yml?at=b60330ca6c1d78009cf8ab657c9c0f069c19b66e#85)

Ручка очень похожа по своей функции на [/api/v2/catalog-stores](#orgc77d829), но
ищет не только Лавки, а любые заведения по текстовому
идентификатору бренда и оциональной геолокации для того чтобы 
вернуть наиболее подходящее/популярное заведение и данная ручка не
использует сурдж для поиска наиболее подходящего заведения.
Возможно стоит переселить фронтенд с ручки [/api/v2/catalog-stores](#orgc77d829) 
на эту и перенести исключительно ее, однако есть и другая
альтернатива.

**Нагрузка:** 100 - 200rps

![img](img/eats-v1-catalog-v1-brands-place-search.png)

---


<a id="org5c0ad07"></a>

## Серверные ручки


<a id="org7adeeaa"></a>

### Wizard

Ручки для поискового колдунщика.
Данный набор ручек является одной из самых стабильных частей
каталога - изменения в данных ручках почти не производятся.


<a id="org04e8b11"></a>

#### /api/v2/catalog/wizard

-   [Спека](https://bb.yandex-team.ru/projects/EDA/repos/spec-api/browse/specs/client_core_v2/spec.yml?at=refs%2Fheads%2Ffeature%2FEDACAT-128-add-shops-to-availability#63)

Возвращает список заведений доступных по геопозиции или
идентификатору региона, в случае если есть что-то из
пересиленного, в противном случае, возвращает произвольный список
заведений.
Ручка использует для фильтрации специальный быстрый фильтр,
ориентированы на колдунщика.
Данный список, насколько мне известно отображается на
поиске как карусель заведений доступных пользователю для
перехода.

Насколько я помню, у ручки колдунщика есть строгое ограничение
на время ответа - 200ms.

**Нагрузка:** ~5rps

---


<a id="org0dcb210"></a>

#### /api/v2/catalog/wizard/filters

-   [Спека](https://bb.yandex-team.ru/projects/EDA/repos/spec-api/browse/specs/client_core_v2/spec.yml?at=refs%2Fheads%2Ffeature%2FEDACAT-128-add-shops-to-availability#65)

Возвращает список быстрых фильтров доступных для колдунщика Еды -
по сути дела ручка просто проксирует колдунщику фильтры, которые
запрашиваются из `eda_core/server/api/v1/export/quick-filters` и
сохраняются в кеше.

**Нагрузка:** <1rps

---


<a id="org586f79d"></a>

### Layout constructor

Ручки для `eats-layout-constructor`.


<a id="org1205901"></a>

#### /v1/internal/catalog-for-layout

-   [Спека](https://bb.yandex-team.ru/projects/EDA/repos/spec-api/browse/specs/server_catalog-service_v1/spec.yml?at=b60330ca6c1d78009cf8ab657c9c0f069c19b66e#94)

Ручка объединяет под собой логику старых ручек каталога:

-   /api/v2/catalog
-   /api/v2/catalog/carousel
-   /api/v2/catalog/pickup-list

Возвращает набор "блоков" заведений для `eats-layout-constructor`, 
которые в последствии встраиваются в `Layout` для отображения
пользователю.

**Нагрузка:** ~200rps

![img](img/v1-internal-catalog-for-layout.png)

---


<a id="orgf1cf42a"></a>

### Корзина

Ручки для корзины.


<a id="org7a99a50"></a>

#### /api/v1/delivery-zones/resolve

-   [Спека](https://bb.yandex-team.ru/projects/EDA/repos/spec-api/browse/specs/server_catalog-service_v1/spec.yml?at=b60330ca6c1d78009cf8ab657c9c0f069c19b66e#94)

Данная ручка по сути дела экспортирует алгоритм выбора зоны
доставки заведения, которую использует каталог это позволяет нам 
избегать багов из-за расхождения зон доставок между корзиной и
каталогом.
Данная ручка достаточно проста, но при этом имеет требования к
времени выполнения запроса - целевое время ответа должно быть 
меньше 100мс поэтому, в данный момент, из нее исключаются любые
сетевые запросы.

**Нагрузка:** ~100rps

---


<a id="orga59d319"></a>

### Коллекции

Ручки для `eats-collections`.


<a id="orga63fc80"></a>

#### /api/v2/collections/search

-   [Спека](https://bb.yandex-team.ru/projects/EDA/repos/spec-api/browse/specs/server_catalog-service_v1/spec.yml?at=b60330ca6c1d78009cf8ab657c9c0f069c19b66e#88)

Возвращает список заведений для отображения в коллекции
используя различные запрограммированные стратегии для поиска 
заведений, например по бренду, идентификатору, новизне или
наличию промоакций.
Данная отличается от обычной ручки каталога в основном тем, что
она возвращает несколько списков заведений, без учета сложных
расчетов требующих сетевых походов, таких как расчет сруджа или
сортировка с помощью ML.
Ручка сделана специально для того чтобы сервис `eats-collections`
мог за один запрос получить информацию о всех заведениях, которые
входят во все коллекции, которые отобразились пользователю, а так
же отобразить отдельную коллекцию.

Внедрение `eats-layout-constructor`  привело нас к пониманию того,
что создание коллекций с помощью самого `eats-layout-constructor`
может быть гораздо удобнее и динамичней и кроме того позволяет
отображать в коллекции те же заведения, что и в каталоге за счет
того что выборка может производиться из того же самого списка
заведений. Поэтому на текущий момент разрабатывается частичный
перенос функционала сервиса `eats-collections` в
`eats-layout-constructor`.

**Нагрузка:** ~200rps

---


<a id="org6e730d0"></a>

### Misc

Ручки, которые образовались в какой-то момент времени
для нужд встраивания Еды в приложение Такси.


<a id="orgca04362"></a>

#### /api/v2/availability

-   [Спека](https://bb.yandex-team.ru/projects/EDA/repos/spec-api/browse/specs/server_catalog-service_v1/spec.yml?at=b60330ca6c1d78009cf8ab657c9c0f069c19b66e#29)

Возвращает список доступных сервисов Еды в данной геопозиции, 
список сервисов очень небольшой:

-   Рестораны Еды
-   Лавки
-   Магазины
-   Аптеки

Данная ручка была разработана для того чтобы отображать или
скрывать, в приложении Такси, кнопки перехода на вкладки Еды,
Лавки итд.
На момент написания спецификации эта ручка одна из самых
нагруженных ручке каталога

Схема работы ручки очень проста - производится обход всех зон
доставки доступных ресторанов в переданной геопозиции до тех пор
пока не будет найдено хотя бы одного открытого заведения
каждого типа или не будет достигнута последняя зона. 

**Список сервисов, которые используют ручку:**

-   eda-shortcuts

**Нагрузка:** 1200rps в пике

---


<a id="orgc884fac"></a>

#### /api/v2/shortlist

-   [Спека](https://bb.yandex-team.ru/projects/EDA/repos/spec-api/browse/specs/server_catalog-service_v1/spec.yml?at=b60330ca6c1d78009cf8ab657c9c0f069c19b66e#79)

Возвращает список заведений доступных на точку, предоставляя
минимальный набор данных о заведении:

-   Идентификатор
-   Название
-   Слаг
-   Бренд
-   Геопозиция
-   Тип
-   Время доставки
-   Список промоакций

**Список сервисов, которые используют ручку:**

-   inapp-communications
-   eats-communications
-   eda-shortcuts

**Нагрузка:** 1200rps в пике

---


<a id="orgfde166f"></a>

#### /api/v2/catalog-polygons

-   [Спека](https://bb.yandex-team.ru/projects/EDA/repos/spec-api/browse/specs/server_catalog-service_v1/spec.yml?at=b60330ca6c1d78009cf8ab657c9c0f069c19b66e#81)

Возвращает полигоны зон доставок Лавки и склеенный полигон зон
доставок Еды по идентификатору региона Еды.

**Список сервисов, которые используют ручку:**

-   persuggest

**Нагрузка:** 30rps в пике

---


<a id="orgb4cbf1f"></a>

## Кеши


<a id="orgdaebd13"></a>

### Зоны доставки

Кеш зон доставок является основным кешом в каталоге - поверх него
построен весь функционал каталога. Кеш получает свои данные из
файла в S3, который регулярно обновляется сервисом
`eat-catalog-storage`. Данный файл содержит все зоны доставки Еды,
которые доступны на момент загрузки файла - одна строка одна зона
доставки. После скачивания файла каталог проходит по каждой зоне
доставки и проверяет изменилась ли она с помощью поля `indexed_at` -
если зона изменилась, то зона обновляется в кеше. Удаление зон из
кеша происходит путем сохранения полного списка идентификаторов
зон с предыдущей итерации обновления и сопоставления с ним нового 
списка.

Помимо самих зон кеш хранит набор "индексов", который позволяет
осуществлять быстрый поиск по кешу без полного перебора всех зон.

Список индексов:

-   Гео индекс, использующий [H3](https://eng.uber.com/h3/)
-   Индекс по быстрым фильтрам колдунщик
-   Индекс по быстрым фильтрам API
-   Индекс по слагам заведений
-   Индекс по идентификатору бренда
-   Индекс по слагу бренда
-   Индекс по идентификатору региона
-   Индекс по типу заведения
-   Индекс по идентификатору заведения
-   Индекс по поддержек брендом предзазказа


<a id="orgfd10ef1"></a>

### Быстрые фильтры

Кеш быстрых фильтров содержит список быстрых фильтров Еды - их
названия, изображения, порядок, статус активности из ручки 
`eda_core/server/api/v1/export/quick-filters`.
Кеш используется в клиентских ручках каталога для проверки
статуса быстрого фильтра в запросе пользователя и фильтров
заведений для отображения списка активных быстрых фильтров.


<a id="orgdf10c84"></a>

### Настройки курьеров

Кеш настроек курьеров содержит словарь типов курьеров к скорости
доставки в 4 различных типа зона, разделенных по расстоянию от
курьера. 
Кеш обновляется из ручки `eda_core/server/api/v1/export/settings/couriers-stats`.
Данная ручка используется в клиентских ручках каталога при запросе
с геопозицией для расчета времени доставки в зависимости от того,
в которую попал пользователь.


<a id="orgfc88e05"></a>

### Настройки рейтинга

Кеш содержит значение минимального количества оценок заведения и
минимального рейтинга для того чтобы отличать заведения с хорошим
рейтингом от других при сортировке.
Кеш пополняется из ручки `eda_core/server/api/v1/export/settings/options-dump`.


<a id="org195869c"></a>

### Настройки условий доставки (устарело)

Кеш содержит условия доставки, которые регулируют стоимость
доставки в зависимости от цены корзины. Кеш позволяет получить
условие доставки по идентификатору, которое хранилось в старом
дампе зон.
Содержание кеша перезапрашивается регулярно из ручки
`eda_core/server/api/v1/export/settings/delivery-conditions`.

На настоящий момент условия доставки содержатся в дампе зон
доставки, поэтому данный кеш больше не используется и будет удален.


<a id="orgba7e0d3"></a>

### Промоакции

Кеш содержит список всех доступных промоакций для всех заведений с
сурджом и без. Для обновления кеша используется ручка
`eda_core/server/api/v1/export/promos`, которая регулярно
опрашивается с полным список всех заведений из кеша зон доставок.
Данный кеш используется в клиентских ручках каталога и ручке
[/api/v2/shortlist](#orgc884fac) для отображения доступных промоакций.


<a id="org4af1aed"></a>

### Регионы

Кеш регионов содержит список всех регионов Еды - их названия,
временные зоны, баунднг боксы и прочее. Кеш используется в основном
для метрик и для кеша полигонов.
Кеш заполняется ответом ручки `eda_core/server/api/v1/export/regions`.


<a id="orge53d1e6"></a>

### Полигоны

Данный кеш завязан на кеш зон доставок, он регулярно собирает
список всех полигонов зон доставок по региону Еды и склеивает в
один полигон для передачи в ручке [/api/v2/catalog-polygons](#orgfde166f).


<a id="orgf23930f"></a>

# eats-catalog

Существует набор старых ручек каталога, которые не требуется
переносить вообще и можно оставить в сервисе на Go до тех пор пока
трафик в них не спадет до 0, такими ручками являются:

-   [/api/v2/catalog](#org01e35ec)
-   [/api/v2/catalog/carousel](#org7935580)
-   [/api/v2/catalog/popular](#orgb5dee70)
-   [/api/v2/catalog/pickup-list](#orgc983198)
-   [/api/v2/collections/search](#orga63fc80)

Далее перечислены логические части каталога в том порядке, в котором
их имеет смысл перевозить в uservices.

Первым этапом может быть перевоза должен быть алгоритм резолва зон
так как большая часть логики каталога полагается на алгоритм
резолва. 
В качестве альтернативы можно начать перенос с [вспомогательных ручек](#org8072c23),
которые не полагаются на кеши и алгоритм резолва.


<a id="org6902cee"></a>

## Резолв зон

Резолв зон представляет из себя алгоритм, который позволяет
определить какую зону доставки необходимо использовать для
расчетов стоимости доставки заведения - данный алгоритм
используется (будет использоваться) не только в каталоге поэтому
его требуется перенести таким образом чтобы другие сервисы могли
его использовать.
На текущий момент можно представить как минимум три клиента для
этого функционала: `eda_core` (корзина), `eats-catalog`, 
`eats-full-text-search`.


<a id="org7624218"></a>

### resolve as a service

Для резолвинга зон можно сделать отдельный сервис, в котором
можно имплементировать примерно ту же логику, которая существует
в ручке [/api/v1/delivery-zones/resolve](#org7a99a50) и обращаться к ней из
других сервисов.
Для резолва массива заведений можно сделать ручку `bulk_resolve`,
которая принимает массив идентификаторов заведений и возвращает
для каждого идентификатор зоны доставки.

Однако тут появляется проблема во взаимодействии сервисов.

![img](img/eats-resolve-problem.png)

Каждому запросу в сервис резолва, будет скорее всего
предшествовать запрос к `eats-catalog-storage` для получения
заведений с зонами.
Эту проблему можно решить несколькими способами:

-   [resolve без состояния](#org4a8f7a4)
-   [resolve как "прокся"](#org087f54b)
-   [resolve как часть eats-catalog-storage](#org5be5285)

Основной проблемой подобного сервиса станет то, что он должен
будет иметь доступность близкую к 100% и держать суммарно не
меньше 600rps после переезда всех сервисов на его использование.


<a id="org4a8f7a4"></a>

### resolve без состояния

Ручки сервиса могут принимать в запросе массив зон доставок,
найденных для заведения и осуществлять резолвинг среди них, что
значительно увеличивает количество передаваемых по сети данных,
но гарантирует что клиент всегда получит в ответ зону, о которой
он действительно знает.

![img](img/eats-resolve-no-state.png)


<a id="org087f54b"></a>

### resolve как "прокся"

Можно сделать `eats-resolve` своеобразной проксей к
`eats-catalog-storage` - все запросы требующие резолвинга зон
могут быть отправлены напрямую в `eats-resolve` сервис, который
уже вернет искомые заведения с уже зарезолвленными зонами.

![img](img/eats-resolve-proxy.png)


<a id="org97d4837"></a>

### resolve as library

Так как логика резолвинга зон достаточно скромная можно просто
вынести эту логику в отдельную библиотеку uservices, которая будет
получать на вход массив зон и возвращать ту которая подходит под
запрос пользователя.
Переход на эту библиотеку не может быть осуществлен сразу же
поскольку все еще будут существовать ручки go каталога, которые
завязаны на этот алгоритм, а так же корзина на PHP. 
С этим решением может быть ряд проблем:

-   Не все сервисы сразу смогут переехать на использование
    библиотеки в uservices - так как большинство клиентов резолвера
    написаны на Go и PHP, что может повлечь за собой баги в виде
    расхождения результата резова в разных частях сервиса.
-   Обновление логики резолвинга будет требовать одновременной
    выкатки множества сервисов. Данную проблему кажется можно решить
    с помощью какой-то централизованной конфигурации библиотеки
    (taxi-config), но такая разработка может быть дороже.


<a id="org5be5285"></a>

### resolve как часть eats-catalog-storage

Возможно лучшим решением будет перенести логику резолва зон на
сторону `eats-catalog-storage` так как это процесс, который должен
происходить почти при каждом поиск заведений.
Таким образом мы можем избавиться от проблем связанных с
синхронизацией алгоритма между разными сервисами, а так же
позволит нам не совершать лишних сетевых запросов, для которых
потребуется фолбэк.


<a id="org8072c23"></a>

## Вспомогательные ручки

Есть набор ручек, который не требует никаких кешей и резолва зон - 
данные ручки могут быть перенесены в uservices по сути дела в любой
момент после того как в `eats-catalog-storage` появится возможность
поиска заведений.

-   [/eats/v1/catalog/v1/brands/place-search](#orgfd58c4a)
-   [/api/v2/catalog-stores](#orgc77d829)
-   [/api/v2/availability](#orgca04362)
-   [/api/v2/catalog-polygons](#orgfde166f)


<a id="org4a769ef"></a>

### Ручка [/eats/v1/catalog/v1/brands/place-search](#orgfd58c4a)

Для имплементации требует функционал поиска заведений по слагу
бренда, геопозиции и региону в `eats-catalog-storage`.


<a id="org7fe870e"></a>

### Ручка [/api/v2/catalog-stores](#orgc77d829)

Для имплементации требует функционал поиска заведений по типу
бренда, геопозиции и региону в `eats-catalog-storage`.


<a id="orga6bf1fb"></a>

### Ручка [/api/v2/availability](#orgca04362)

Для имплементации требует функционал поиска всех заведений по
геопозиции.

Все вышеперечисленные ручки могут быть временно имплементированы
поверх более простой версии ручки поиска в `eats-catalog-storage`,
которая позволит получить все заведения по геопозиции или региону,
всю остальную фильтрацию можно сделать на стороне `eats-catalog`.


<a id="org10eea26"></a>

### Ручка [/api/v2/catalog-polygons](#orgfde166f)

Для имплементации требует функционал поиска всех заведений по
региону и список всех регионов еды, который на деле может быть
просто конфигом.

Наибольшая сложность этой ручки будет состоять в том чтобы склеить
полигоны в один, однако насколько мне известно Boost
передоставляет [такую возможность](https://www.boost.org/doc/libs/1_58_0/libs/geometry/doc/html/geometry/reference/algorithms/union_.html).


<a id="orgde9c2a5"></a>

## Слаг

Можно выделить набор ручек каталога, которые содержат логику
определения необходимого пользователю заведения по геопозиции или
региону:

-   [/api/v2/catalog/{slug}](#org48fb3bc)

Каждая ручка в этом наборе делает достаточно простой запрос к базе
данных - по координатам и идентификатору бренда или заведения
поэтому сервис может делать прямые запросы на поиск к `eats-catalog-storage`.

Для перевоза [/api/v2/catalog/{slug}](#org48fb3bc) потребуются следующий кеши:


<a id="org1036982"></a>

### Переезд /api/v2/catalog/{slug}

Вслед за переездом резолва, можно отделить от текущего каталога
ручку [/api/v2/catalog/{slug}](#org48fb3bc).
Для переноса ручки слага придется перенести некоторые кеши:

-   [Настройки курьеров](#orgdf10c84)
-   [Настройки рейтинга](#orgfc88e05)
-   [Промоакции](#orgba7e0d3)

Необходимо так же иметь ручку на стороне `eats-catalog-storage`,
которая позволит получать данные заведения по слагу заведения.


<a id="org90d894d"></a>

### Не перевозить /api/v2/catalog/{slug}

Несмотря на то что ручка [/api/v2/catalog/{slug}](#org48fb3bc) является одной из
старых ручек каталога, которые все еще используются всем
фронтендами, возможно есть смысл оставить ее в текущем go каталоге и
вместо этого заняться разработкой BDU-like API для отображения
отдельного заведения, в котором источником данных будет
`eats-catalog` и при необходимости текущий слаг каталога.
Подобный поход позволит нам перенести логику слага без legacy
решений и возможно переиспользовать текущий каталог ускорения
разработки функционала, который окажется сложно перенести на C++
сразу.

![img](img/bdu-like-slug.png)


<a id="org08f455d"></a>

## Колдунщик

-   [/api/v2/catalog/wizard](#org04e8b11)
-   [/api/v2/catalog/wizard/filters](#org0dcb210)

Кажется вполне логичным вынести ручки колдунщика в отдельный
сервис, который будет обрабатывать исключительно потребности
поискового колдунщика. Насколько мне известно, поисковый колдунщик
работает не только по заведениям, но и по блюдам и эта логика все
еще содержится в eda<sub>core</sub>, возможно стоит пересмотреть
взаимодействие с колдунщиком во всей Еде.

Единственная внешняя зависимость ручек wizard - это ручка экспорта
быстрых фильтров `eda_core/server/api/v1/export/quick-filters` -
быстрые фильтры могут быть активированы для отображения в
колдунщике через админку Еды. Возможно запрос быстрых фильтров в
runtime'е ручки при таких малых нагрузках не будет критичным, но
кажется более логичным сохранить ее ответ в кеш для того чтобы
иметь возможность ответить даже случае падения `eda_core`.

Для переноса логики wizard ручек не требуется резолвинг зон, однако
требуется осуществлять поиск заведений по координатам и региону -
на этих ручках будет достаточно удобно отработать сценарии поиска
массива заведений с помощью `eats-catalog-storage` и понять нужно ли
осуществлять кеширование заведений на стороне сервиса.


<a id="org74d2462"></a>

## Каталог

Кажется одним из самых логичных способов переноса каталога будет
перенос по домену. Тут просто стоит ответить на вопрос - что есть
домен каталога? И ответ на этот вопрос достаточно просто - каталог
это список, в нашем случае это список заведений. Таким образом в
ответственность сервиса `eats-catalog` должна входить передача
списка заведений и в эту зону ответственности достаточно просто
вписываются ручки:

-   [/v1/internal/catalog-for-layout](#org1205901)
-   [/api/v2/shortlist](#orgc884fac)
-   [/api/v2/catalog/wizard](#org04e8b11)
-   [/api/v2/catalog/wizard/filters](#org0dcb210)

В данный список включены только те ручки, существующего, каталога,
которые, действительно имеет смысл переносить в новый сервис в том
или ином виде.
Перенос, [/v1/internal/catalog-for-layout](#org1205901) требует переноса в uservices
следующего набора кешей, которые используются в данных ручках:

-   [Быстрые фильтры](#orgfd10ef1)
-   [Настройки курьеров](#orgdf10c84)
-   [Настройки рейтинга](#orgfc88e05)
-   [Промоакции](#orgba7e0d3)

В последствии, кажется, вполне возможным перенести, некоторые кеши
в отдельные сервисы.

**NOTE**: кажется логичным держать чтобы список за управление списком
быстрых, в последствии, отвечал либо сам `eats-catalog`, либо
`eats-catalog-storage`.


<a id="org405c36a"></a>

## Откуда будут браться данные?

В данный момент уже существует хранилище данных заведений в виде
сервиса `eats-catalog-storage` - в самом простом сценарии
`eats-catalog` может запрашивать данные напрямую из
`eats-catalog-storage`.

**Плюсы:**

-   Это вариант достаточно удобен в смысле простоты переноса логики
    каталога, единственным блокером тут является имплементация
    ручки поиска заведений в `eats-catalog-storage`.
-   Гарантирует минимальный лаг по времени обновления данных заведения.

**Вопросы:**

-   Какую нагрузку может выдержать `eats-catalog-storage`?

**Проблемы:**

-   В случае, если мы решим ходить на каждый запрос к `eats-catalog`
    в `eats-catalog~storage` заключается в том, что
    `eats-catalog-storage` станет центральной точкой отказа при чем
    его отказ может стать причиной проблем не только в каталоге, но
    и в других сервисах, которые полагаются на
    `eats-catalog-storage`.
-   Изменение в логике каталога, а именно в логике поиска заведений
    может требовать изменений в коде сразу двух сервисов -
    `eats-catalog` и `eats-catalog-storage`.
-   Пока у нас нет ручки `eats-catalog-storage`, которая бы позволила
    реализовать функционал данных ручек.


<a id="org45c837c"></a>

### Кэш

В качестве альтернативы поиску в `eats-catalog-stroage` можно
создать базу данных принадлежащую исключительно сервису
`eats-catalog`, которая будет пополняться при помощи периодика.
Тут так же есть несколько разных вариантов: база данных может
быть как реальная база данных так и какое-то in-memory решение,
возможно даже пополам.

**Плюсы:**

-   Отказоустойчивость - отдельная база для `eats-catalog` позволит
    нам не полагаться на доступность `eats-catalog-storage`.
-   Возможность оптимизировать запросы без необходимости
    модификации кода других сервисов.

**Вопросы:**

-   Для in-memory решения потребуется использовать какой-то гео
    индекс, нужно сделать research по тому есть ли какое-то
    решение, которое уже используется для этого в uservices.

**Проблемы:**

-   Увеличивается лаг по времени доезда обновлений до
    `eats-catalog`. Возможно, что это решение стоит использовать для
    отдельных ручек, для которых актуальность данных не настолько
    важна.
-   Потенциальные баги синхронизации.
-   Больше железа (особенно если брать настоящую базу)? Хотя
    кажется имея отдельную базу мы сможем более гранулярно
    контролировать ресурсы.

