# Получение ресторанов для баннеров из eats-catalog

## Введение
Имеется потребность в более гибкой настройке получения баннеров из eats-communications, а именно фильтрации заведений по предикатам (пример задачи: https://st.yandex-team.ru/EDACAT-1973). Сейчас для создания набора баннеров сервис eats-communications получает список фидов из feeds и ищет их пересечение со списком всех ресторанов на точку, полученным из eda-catalog. Сервис eda-catalog признан устаревшим, его доработка не имеет большого смысла, а так же имеется проблема в отстутсвии достаточного кол-ва Go разработчиков. В рамках задачи https://st.yandex-team.ru/EDACAT-1899 предлагается переход на использование C++ каталога, вместо go каталога для получение списка ресторанов для формирования набора баннеров.

Так же есть проблема в том, что сейчас сами коллекции и баннеры к ним формируются по разной логике. В будущем хотелось бы прийти к единой логике, чтобы не было проблем с отображением баннеров недоступных коллекций.

## Задачи

* https://st.yandex-team.ru/EDACAT-1899
* https://st.yandex-team.ru/EDACAT-2108
* https://st.yandex-team.ru/EDACAT-2109
* https://st.yandex-team.ru/EDACAT-2128

## Ответственные

* [egor-sorokin@](https://staff.yandex-team.ru/egor-sorokin)

## Требования к реализации

* возможность фильтрации набора ресторанов по предикатам
* возможность запроса набора ресторанов блоками (как это сделано в ручке /catalog-for-layout)
* расширяемость решения для нужд eats-communications

## Возможная реализация

Можно было бы переиспользовать ручку **/catalog-for-layout** (далее CFL) для получения списка ресторанов, так как в ней уже есть фильтрация и блочные запросы. Но логика этой ручки черезчур избыточна для реализации текущей задачи. В частности, кажется что нет нужды в навешивании на заведения фич, тегов, фильтров, получении рекламных аукционов и т.д. Так же дальнейшее развитие ручки CFL может разойтись с потребностями eats-communications, что усложнит ее доработку и поддержку в будущем.

## Предлагаемая реализация

Предлагается завести в сервисе eats-catalog новую ручку **/catalog-for-communications** (далее CFC), предназначенную для упрощенного получения списка баннеров сервисом коммуникаций. Ручка будет получать набор блоков с предикатами фильтрации и отдавать блоки заполненные ресторанами. Предварительная спеку ручки можно найти в **./api.yaml**. Частично это будет дублировать логику CFL, однако не всю и будет возможность развивать ее независимо. Большая часть дублируемого кода уже вынесена в отдельные модули внутри eats-catalog. В текущей реализации предлагается оставить в ручке следующую логику:

* поиск заведений по набору предикатов
* сортировка заведений
* дедупликация заведений
* получение данных суржа, плюса и т.д. (если необходимо)
* формирование итоговой выдачи, раскладывание заведений по блокам

Формирование лэйаута коллекции в eats-layout-constructor сейчас задействует ручку CFL для получения ресторанов коллекции. Впоследствии можно перенести получение ресторанов для коллекций на ручку CFC для того, чтобы локализовать логику подбора ресторанов для коллекции и её баннера в одном месте. Так же можно будет перевести коллекции целиком на блоки с предикатами, вместо searchStrategy.

Со стороны сервиса eats-communications это требует небольшой доработки, а именно добавления логики по формирования запроса в eats-catalog, вместо eda-catalog и применение результатов для формирования набора баннеров. В данный момент баннеры могут быть типа info, collection, place и brand. Для последних двух можно формировать запрос с отдельным блоком на каждый баннер, указывая в предикате place_id, или brand_id. У такого подхода есть недостаток в том, что запрос в каталог придется выполнять синхронно после получения набора фидов, так как нужно сформировать блоки с предикатами для запроса (сейчас запросы в feeds и каталог выполняются параллельно).

![Схема взаимодействия](./schema.png)

<!--
@startuml
participant "eats-layout-constructor" as lc
participant "eats-communications" as comms
participant "feeds" as feeds
participant "eats-collections" as colls
participant "eda-catalog" as gocat
participant "eats-catalog" as cat

== Current implementation ==
lc -> comms : /eats-communications/v1/layout/banners
note left: запрашиваем блоки\nс banners_carousel
comms -> feeds : /v1/fetch
note left: получаем фиды с баннерами
comms -> colls : /internal/v1/collections
note left: получаем коллекции
colls -> gocat : /v1/collections/search
gocat -> colls
comms -> gocat : /v1/_internal/banner-places
note left: получаем все заведения\nна локацию
feeds -> comms
colls -> comms
gocat -> comms
comms -> comms : матчим баннеры c полученными\nзаведениями и коллекциями
comms -> comms : заполняем блоки\nbanners_carousel баннерами
comms -> lc

== Suggested implementation ==
lc -> comms : /eats-communications/v1/layout/banners
note left: запрашиваем блоки\nс banners_carousel
comms -> feeds : /v1/fetch
note left: получаем фиды с баннерами
feeds -> comms
comms -> comms : для баннеров типа place и brand\nдостаем place_id и brand_id/\nЗатем формируем из них блоки\nзапроса и предикаты по id
comms -> cat : /catalog-for-communications
note left: сейчас нам неоткуда получить дополнительные условия\nдля формирования предикатов баннеров,\nно в будущем их можно добавить в админку LC
note right: новая ручка
cat -> cat: получаем все рестораны
cat -> cat: ранжируем
cat -> cat: дедуплицируем
cat -> cat: опционально запрашиваем сурж\n(если есть предикат на это)
cat -> cat: раскладываем заведения по блокам ответа
cat -> comms
comms -> colls : /internal/v1/collections
note left: получаем коллекции
colls -> colls : Достаем searchStrategy для\nколлекции и собираем по ней\nпредикаты запроса в каталог
colls -> cat : /catalog-for-communications
note left: Новую ручку так же можно\n задействовать для получения плейсов\n коллекций из  eats-collections.
note right: новая ручка
cat -> colls
colls -> comms
comms -> comms : матчим баннеры с полученными\nблоками заведений и коллекциями
comms -> comms : заполняем блоки\nbanners_carousel баннерами
comms -> lc
@enduml
-->

## Шаги реализации

1. Использование новой ручки для получение баннеров заведений
* убедиться что eats-catalog готов к лишним ~40-50 rps, которые сейчас идут в eda-catalog
* написать новую ручки /catalog-for-communications
* добавить в eats-communications альтернативный сценарий похода в eats-catalog, вместо eda-catalog (под экспериментом)
* постепенно перевести трафик на eats-catalog
* удалить из eats-communications старый сценарий похода в eda-catalog
* (опционально) закопать ручку баннеров в eda-catalog, если в нее больше нет трафика
2. Использование новой ручки для получения коллекций в eats-collections
* добавить в eats-collections альтернативный сценарий похода в CFC за ресторанами для коллекций (под экспериментом)
* перевести трафик в новую ручку
* убрать лишний код в eats-collections
3. (опционально) Объединить баннеры и остальные коммуникации в одну ручку для LC и научить ее принимать блоки с предикатами. Таким образом можно будет управлять выдачей коммуникаций на уровне LC.

## Note

Данные изменения впоследствии помогут прийти к более гибкому управлению коллекциями и баннерами. Как вариант - сделать админку коллекций, основанную на предикатах каталога. Рестораны для коллекций и их баннеров будут собираться из этих предикатов по единой логике. Админка может быть встроена в админку layout-constructor, или же создана отдельно.