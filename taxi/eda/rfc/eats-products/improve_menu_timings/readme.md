# Основная логика

## Запрос на главной странице магазина
Фронт делает запрос дерева всех категорий, указав maxDepth = 100. (Сейчас в запросе maxDepth = 1)
`
{
    "slug": "ashan_gipermarket_bagrationovskij_proezd_5",
    "maxDepth": 100
}
`

Тайминги:
| maxDepth | Тайминг |
| -------- | ------- |
|     1    |  160ms  |
|    100   |  250ms  |

В случае запроса без поля "category" в ответе ручки для каждой top-level категории будут добавлены 2 флага:
1. ```optional boolean request_first_leaf_early``` - флаг, позволяющий фронту понимать, использовать ли подход с двумя запросами:
* true - можно использовать 2 запроса для получения этой категории
* false или null - не нужно использовать 2 запроса для получения этой категории
2. ```optional boolean has_discounts``` - флаг, позволяющий фронту понимать, есть ли в этой top-level категории товары со скидками. Подробнее ниже в "Фейк-категория "Скидки" внутри top-level категорий"

## Запрос конкретной категории
Так как после запроса всех рут категорий на фронте знают все дерево, категорий, то можно сделать 2 запроса одновременно.

### Запрос самого левого листа текущей категории
`
{
    "slug": "ashan_gipermarket_bagrationovskij_proezd_5",
    "maxDepth": 100,
    "category": 10312
}
`

Тайминг левого листа 10312 (Туалетная бумага) ~ 250ms

После получения этого ответа, фронт может отображать страницу категории для пользователя. Если пользователь скроллит ниже прогруженных товаров или переходит в непрогруженную категорию, то нужно показывать загрузку и ждать ответа тяжелого запроса.

### Запрос текущей категории
`
{
    "slug": "ashan_gipermarket_bagrationovskij_proezd_5",
    "maxDepth": 100,
    "category": 3374
}
`

Тайминги категории 3374 (Красота и гигена) ~ 2.5s

### Фейк-категория "Скидки" внутри top-level категорий
Сейчас на мобильных клиентах в каждой top-level категории есть карусель скидок, которая строится на фронте, при этом в нее можно перейти и откроется фейк-категория "Скидки" по этой top-level категории со всеми товарами со скидкой.

В процессе ресерча выяснилось, что прямо сейчас перенести эту логику на бэк будет проблематично и в этой итерации есть смысл оставить логику ее формирования на фронте.

Для того, чтобы не ухудшать пользовательский опыт, то фронт будет использовать флаг has_discounts:
* true: в top-level категории есть скидки, потому необходимо отобразить шиммер вместе карусели скидок. После получения ответа по всей категории, скидки можно отобразить
* false или null: в top-level категории нет скидок, шиммер отображать не нужно

(окнуто с Никитой Апыхтиным и Сергеем Бредихиным)

Если для получения категории использовался всего один запрос, то этот флаг можно игнорировать.

### Логика нахождения левого листа

После запроса дерева всех категорий найти левый лист довольно просто: проходим от нужной категории вглубь всегда выбирая самый первый элемент в списке. Когда элемент оказывается листом(нет подкатегорий), то самый левый лист найден.

## Пример

![Картинка для примера](categories_example.png)

В магазине две top-level категории: 1 и 2. Для категории 1 левым листом будет категория 7. Для категории 2 левым листом будет категория 5. Таким образом, при заходе в категорию 1, будет выполняться 2 запроса: для категории 7 и категории 1. А при заходе в категорию 2 запросы: категория 5 и категория 2.

# Плюсы:
1. простота реализации
2. для пользователя будет почти незаметно даже в случая тяжелых категорий (Получение листа 10312 на примере тяжелой категории 3374 ~ 250ms, а самой категории ~ 2.5s)
# Минусы:
1. увеличение rps на количество top-level категорий (как в eats-products, так и в eats-nomenclature)
2. долгая загрузка скидочной категории ( как и любой листовой категории с огромным количеством товаров) (будет решать отдельно)
3. при применении фильтра потребуется перезапрашивать категорию со всему подкатегориями и товарами

# Разработка

## Бэкенд

### Заполнение флага request_first_leaf_early
Хранить в кэше данные о количестве доступных товаров в top-level категориях по каждому магазину. На основе экспа и этого означения заполнять флаг

### Заполнение флага has_discounts
Хранить в кэше данные о количестве доступных товаров со скидкой в top-level категориях по каждому магазину и на основе этого заполнять флаг
