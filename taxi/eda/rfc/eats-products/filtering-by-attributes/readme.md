# Фильтрация товаров на стороне eats-

## Дано

Сейчас фильтрация осуществляется по единственному аттрибуту "Бренд". Фильтры, которые можно применить возвращаются в поле `filters` ручки `/api/v2/menu/goods`. Поле `filter` является массивом объектов типа Filter.

## Задача

Необходимо реализовать фильтрацию продуктов по множеству аргументов. Так же необходимо поддержать кастомные фильтры вида "Товары со скидкой".

## Решение

### Обычные категории

Поддержать возможность изменения положения блока сортировок в bottom sheet на стороне клиента.
Вместо ручки `v1/nomenclature` использовать ручку `/v1/place/category_products/filtered` и `v1/place/products/info`.
Ручка `/v1/place/category_products/filtered` [(rfc)](https://a.yandex-team.ru/review/2500837/details) принимает фильтры и возвращает статическую информацию о товарах с привязкой к категориям, и применимые к категории фильтры.
Передавать полученные от пользователя фильтры в ручку `/v1/place/category_products/filtered`.

Сервис eats-nomenclature отвечает за: 
- привязку фильтров к категориям
- порядок фильтров в зависимости от категории и бренда
- порядок опций фильтров
- минимальный процент заполненных товаров для показа фильтра

### Динамические категории

Для динамических категорий поддержать фильтр "Товары со скидкой".

## Ограничения

Так как фильтры для обычных категорий приходят из eats-nomenclature, а динамические категории формируются на стороне eats-products, то фильтры для таких категорий тоже должны быть реализованы на стороне eats-products.

## Требуемые изменения 

### На стороне eats-nomenclature

Для экономии трафика для ручки `/v1/place/category_products/filtered` добавить параметр запроса `only_categories` типа `boolean`.
При `only_categories == true` не возвращать товары в категориях. По умолчанию false.

### На стороне eats-products

#### Первый этап (3-5 дней)

- расширить enum `types` типа `Filters` значением `select`
- расширить тип `Filters` опциональным полем `icon`, которое служит для возврата url иконок с привязкой к теме и имеет следующую структуру:

    ```yaml
    Icon:
        type: object
        description: Иконка
        additionalProperties: false
        required:
            - light
            - dark
        properties:
            light:
                type: string
                description: url иконки для светлой темы
            dark:
                type: string
                description: url иконки для тёмной темы
    ```

- расширить опции фильтра полем `is_available` типа `boolean`, в котором будет отображаться есть ли товары с таким атрибутом
- расширить эксперимент `eats_products_sort_types` полем `sorting_block_position` типа enum с значениями `before_filters` и `after_filters`.
- в ручке menu/goods расширить поле `sorts` полем `position` типа enum с значениями `before_filters` и `after_filters`, в котором будет возвращаться позиция для блока сортировок, полученная из эксперимента
- расширить структуру запроса ручки menu/goods опциональным полем `include_products`
- передавать значение `include_products` как параметр запроса `include_products` в ручку номенклатуры
- передавать полученные от клиентов фильтры в ручку номенклатуры
- возвращать полученные из ответа номенклатуры фильтры клиентам
- устанавливать фильтрам и их значениям is_applied
- возвращать top N популярных значения фильтров в поле `top_values`
- возвращать все выбранные пользователем фильтры (is_applied==true,) в поле `top_values` перед популярными, вытесняя их
- возвращать новые фильтры только поддерживаемым версиям клиентов
- сортировать фильтры в поле `values` по алфавиту для упрощения поиска
- возвращать количество продуктов после фильтрации в поле `goods_count` объекта `payload`

#### Второй этап. Поддержка фильтра "Товары со скидкой" (2-3 дня)

Поддержать фильтр "Товары со скидкой" как кастомный фильтр, по аналогии с динамическими категориями. 

- создать эксперимент `eats_products_discounts_filter`, который будет управлять параметрами возврата фильтра. Если эксперимент не определён, фильтр не возвращается.
- если в эксперименте определены поля min_products или min_products_percent, то фильтр возвращается при достижении необходимого количества продуктов
- в случае если фильтр "Товары со скидкой" включён в конфиге, добавлять его к полученным из номенклатуры фильтрам в позицию `position` с типом `select`.
- при получении в списке фильтров фильтра с query, который указан в эксперименте `eats_products_discounts_filter` как `id` не передавать его в номенклатуру
- при значении фильтра `true` отфильтровать товары без скидок из результата

### На стороне фронта

#### Первый этап

- блок сортировок устанавливается на позицию, `sorts.position` или остаётся сверху если `sorts.position` не вернулся
- при получении ответа от `menu/goods`, при непустом поле `filters`, отображать иконку фильтров вместо иконки сортировки
- при нажатии на иконку фильтров отображать bottom sheet с сортировками и фильтрами
- фильтры и их значения отображать в порядке, в котором они были получены в массиве `filters`
- на стороне клиента запоминаются выбранные фильтры в привязке к категории. При переходе к родительской категории фильтры сбрасываются. При переходе к дочерним сохраняются.
- при выборе нескольких значений в фильтрах с типом `multiselect` в бабле отображать текст в виде "Название фильтра - количество_выбранных_значений"
- поддержать фильтр типа `select` и иконку для фильтров из поля `icon`, дизайн на скринах в [prd](https://wiki.yandex-team.ru/users/apykhtinn/filtres/#sortirovkapobrendu)
- выбранные пользователем фильтры передаются в поле `filters`
- при каждом изменении фильтров пользователем выполнять запрос в `menu/goods` и актуализировать доступность выбора опций фильтров используя поле `is_available`. Опции с `is_available == false` недоступны для выбора и отображаются серыми
- при нажатии кнопки "Применить" выполнять запрос в `menu/goods` и отобразить изменения
- не использовать поле `top_index` значения фильтра
- использовать поле `goods_count` из `payload` для отображения количества продуктов на кнопке "Показать"

Пример запроса с передачей фильтров в ручке `menu/goods`:

```json
{
    "category_uid": "1111",
    "shippingType": "pickup",
    "slug": "slug",
    "filters": {
        "color": ["red", "green"],
        "discount": true
    }
}
```
