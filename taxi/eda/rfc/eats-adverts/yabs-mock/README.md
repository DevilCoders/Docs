# Проблема

У баннерной крутилки (далее по тексту БК) нет тестового кластера и поэтому тестирование объектов с рекламными ссылками было не удобным поскольку некому эти самые ссылки вернуть
Предлагается написать ручки в eats-misc/новый сервис повторяющие ручки БК в которые будут ходить сервисы:
Кажется в нынешних условиях <b> легче и лучше всего впилить эти ручки в [eats-misc aka eats-region-points ](https://a.yandex-team.ru/arc/trunk/arcadia/taxi/backend-py3/services/eda-region-points)</b> 

- eats-catalog
- eats-full-text-search
- eats-communications

# Как будем ходить

В [этом месте](https://a.yandex-team.ru/arc/trunk/arcadia/taxi/schemas/schemas/services/yabs/client.yaml?rev=r9368092) можно поменять хоста с https://an.yandex.ru на хоста нового сервиса/eats-misc
Спека новых ручек должна совпадать с спекой yabs в проде и поэтому управлять ответом через запрос к ручке нельзя
Значит в этом случае придется смотреть в сторону конфигов с гибкими условиями и управлять ответами ручек через них

# Ручки и конфиги

## page/{page_id}

### Ранжирование

Ручка page умеет принимать баннеры с banner_id
Ранжируются баннеры по формуле ```A * relevance + B + bid * C``` , где  ```relevance = bid * ctr - threshold ```

По спеке мы можем послать коэффициенты A,B и C, в случае если не пошлем то берем дефолтные ``` A=1, B=0, C=0 ``` как в БК

Далее значения от нас не зависящие, это bid, ctr и threshold

Так как bid это ставка для каждого баннера предлагается использовать banner_id для генерации bid,
во всяком случае это значение таким образом будет понятно клиенту

ctr и threshold предлагается задавать через <b>конфиг</b>

### Количество баннеров

Также так как не все баннеры могут выиграть аукцион кажется количество отдаваемых баннеров нужно уметь подрезать что также можно отправить в <b> конфиг </b>

Итого получается конфиг ```eats_misc_yabs_mock_settings```
с значениями:

```ctr, threshold и banners_amount```

## meta_bannerset/{page_id}

По спеке надо вернуть:
а) linkHead - Часть ссылки на счетчик просмотров, опять берем из ```eats_misc_page_settings```

б) отсортированные баннеры с ссылками
Таким образом для пункта б) надо решить две проблемы.

### Как сортировать

По формуле БК но с стандартными коэффициентами, ```bid``` снова из пришедших banner_id баннеров, ```ctr``` из конфига ```eats_misc_yabs_mock_settings```

### Как резать

Снова предлагается резать баннеры по количеству потому что для пользователя это самый очевидный способ понять сколько баннеров ожидается от мока и собственно брать значение banners_amount из конфига ```eats_misc_yabs_mock_settings```


# Как сервис будет генерировать урлы

БК возвращает баннеры в двух форматах

Старый формат:

- url - Ссылка на счетчик кликов (переходов)
- link_head - Начало ссылки на счетчик показов/просмотров.  
- link_tail - Конец ссылки на счетчик показов/просмотров.  

Новый формат:

- bid - ID баннера
- url - Ссылка на счетчик кликов (переходов). 
- link_tail - Конец ссылки на счетчик показов (просмотров).

Нужно будет добавить ручку count в которую пользователь будет попадать если он перешел по рекламной ссылке

Для того чтобы залогировать проход пользователя по рекламной ссылке в ручке logad в ссылке можно закодировать через base64 информацию о переходе а именно json в формате

```json
{
    banner_id:
		type: string
    	example: "13124125125"
   	url_type:
    	type: string
    	enum:
			- view
			- click
}
```

Таким образом url счетчика кликов это закодированный json представленный выше
а ссылка показов это link_head + закодированный через base64 json выше
