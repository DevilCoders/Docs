# Сохранение товаров в корзине при смене адреса

## Суть проблемы

Сейчас если добавить товары в корзину и сменить адрес на тот, который будет обслуживать другой магазин бренда будет выведено сообщение о том, что корзина будет очищена и если согласиться, то пользователю придётся заново наполнять корзину. Очистка корзины происходит даже в том случае, когда товар есть в магазине по новому адресу.

## Как работает сейчас

При смене адреса `GET cart` продолжает возвращать старую корзину, в дизайне без нижнего бара в мобильных клиентах или в вэб-клиенте она скрыта. В дизайне с нижним баром можно получить доступ к корзине. 
Смена адреса корзиной никак не обрабатывается. Если вернуть старый адрес корзина становится доступна. При добавлении нового товара на стороне корзины происходит сравнение placeSlug добавляемого продукта с тем, который сохранён в корзине если она существует. В случае если placeSlug не совпадает происходит сброс корзины, добавление товара и применение нового placeSlug, после чего корзина соответствует новому магазину. Если совпадает, то товар добавляется.

## Новый алгоритм работы

1. Пользователь открывает магазин, имея наполненную корзину в другом месте.
2. На тех экранах, которые потенциально относятся к другому магазину, с которых можно добавлять продукты нужно вызывать `GET cart` и передавать `placeSlug`. И в случае, если необходимо обновление магазина в корзине перед добавлением товара, `GET cart` возвращает в `change_dialog` текст и кнопки для диалога.
3. Пользователь добавляет товар в корзину.
4. На стороне клиента если представлено поле `change_dialog` отображается диалог с текстом description и кнопками buttons в порядке слева направо. 
   a) Если перенос продуктов невозможен, в том числе если плейс относится к другому бренду, отображается следующий диалог, построенный из `change_dialog`, который сохраняет текущее поведение.

        "change_dialog": {
            "description": "Все ранее добавленные товары из магазина {Магазин} будут удалены из корзины.",
            "buttons": [
                {
                    "title": {
                        "color": [
                            {
                                "theme": "light",
                                "value": "#000000"
                            },
                            {
                                "theme": "dark",
                                "value": "#ffffff"
                            }
                        ],
                        "text": "Стоп"
                    },
                    "id": "cancel_button",
                    "action": "cancel"
                },
                {
                    "title": {
                        "color": [
                            {
                                "theme": "light",
                                "value": "#000000"
                            },
                            {
                                "theme": "dark",
                                "value": "#ffffff"
                            }
                        ],
                        "text": "Давайте"
                    },
                    "id": "ok_button",
                    "action": "add_item"
                }
            ]
        }

    b) Если перенос продуктов возможен  (на стороне сервиса cart выполнена проверка соответствия брендов нового и сохранённого плейса), отображается следующий диалог, построенный из `change_dialog`.

        "change_dialog": {
            "description": "Товары, которых нет в этом магазине будут удалены из корзины.",
            "buttons": [
                {
                    "title": {
                        "color": [
                            {
                                "theme": "light",
                                "value": "#000000"
                            },
                            {
                                "theme": "dark",
                                "value": "#ffffff"
                            }
                        ],
                        "text": "Стоп"
                    },
                    "id": "cancel_button",
                    "action": "cancel"
                },
                {
                    "title": {
                        "color": [
                            {
                                "theme": "light",
                                "value": "#000000"
                            },
                            {
                                "theme": "dark",
                                "value": "#ffffff"
                            }
                        ],
                        "text": "Собрать самому"
                    },
                    "id": "delete_button",
                    "action": "add_item"
                },
                {
                    "title": {
                        "color": [
                            {
                                "theme": "light",
                                "value": "#000000"
                            },
                            {
                                "theme": "dark",
                                "value": "#ffffff"
                            }
                        ],
                        "text": "Давайте"
                    },
                    "id": "ok_button",
                    "action": "move_cart"
                }
            ]
        }

5. При нажатии на кнопку выполняется действие в зависимости от значения action кнопки. Возможные action:
   - cancel - закрывает диалог, отменяет действие
   - add_item - добавляет товар в корзину ручкой `POST cart`
   - move_cart - переносит корзину ручкой `POST /api/v1/cart/change_place` (`Алгоритм обновления корзины`), затем добавляет товар в корзину ручкой `POST cart`, в корзине отображаются перенесённые и добавленный продукты.


## Доработки

### Доработки на стороне сервиса cart

Создаётся эксперимент `eats_cart_update_cart_place`, который активен начиная с определённых версий клинта.

#### Ручка `GET cart`

В ручке `GET cart` добавляется опциональные параметры `placeSlug`. 
Если `placeSlug` переданного и сохранённого магазина совпадают или `placeSlug` не передан, то поведение старое.
Если `placeSlug` переданного и сохранённого магазина не совпадают, то проверяются `brandSlug`; если они одинаковые, то в поле `change_dialog` прокидывается текст и кнопки из секции `move_dialog` эксперимента `eats_cart_update_cart_place`.
Если `placeSlug` и `brandSlug` переданного и сохранённого магазина не совпадают, то в поле `change_dialog` прокидывается текст и кнопки из секции `clear_dialog` эксперимента `eats_cart_update_cart_place`.

#### Ручка `POST /api/v1/cart/change_place`

Добавляется новая ручка `POST /api/v1/cart/change_place`, которая при вызове будет выполнять алгоритм обновления корзины, который описан в разделе "Алгоритмы".

Ручка `POST /api/v1/cart/change_place` будет принимать slug нового магазина и будет возвращать новую корзину в случае успешного завершения или ошибку (MoveCartErrorResponse) если перемещение корзины невозможно.

Ручка получает на вход слаг нового магазина и стандартные query-параметры корзины (Latitude, Longitude, ShippingType, DeliveryTime):
```json
{"new_place_slug": "azbukavkusa_1"}
```

В случае если текущий плейс корзины такой же, как и запрошенный - возвращается текущий стейт корзины (чтобы операция была идемпотентна).


##### MoveCartErrorResponse

Пример ошибки ручки при несоответствии бренда
```json
        {
            "code": 200,
            "domain": "UserData",
            "err": "error.brands_differ"
        }
```

### Доработки на стороне клиентов

При получении корзины через `GET cart` отправлять `placeSlug`.
При добавлении товара проверять поле `change_dialog` из ответа корзины, если поле не null, то перед добавлением товара отображается новый диалог, элементы для которого вернулись в `change_dialog`. Подробнее в `Новый алгоритм работы`. Использовать ручку `POST /api/v1/cart/change_place` для перемещения корзины в новый плейс, ручка переносит только имеющиеся в корзине товары.

Для вэб-клиента при смене адреса внутри магазина нужно выполнять запрос `GET cart` с параметрами `placeSlug` нового магазина. И вместо текущего диалога отображать диалог элементы для которого вернулись в `change_dialog`.

## Алгоритмы

### Алгоритм обновления корзины

- проверить к какому бренду относится новый магазин выполнением запроса в `catalog`, если к другому, то алгоритм завершается с ошибкой;
- получить маппинг `public_id` в `core_id` маппинг можно получить из сервиса `eats-products` `/internal/v2/products/core_id`;
- сбросить корзину;
- обновить `placeSlug` корзины, (функция SetPlace);
- выполнить добавление элементов в корзину по полученным выше идентификаторам в том количестве, которое было в прошлой корзине. Если в прошлой корзине товар был по акции 1 + 1, а на новый магазин акция не распространяется, то товар товар добавляется по полной стоимости. Или наоборот, половина товара становится бесплатной, если в новом магазине на него распространяется акция 1 + 1;
- выполнить алгоритм контроля стоков.
