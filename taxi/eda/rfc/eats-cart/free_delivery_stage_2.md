# Проработка бесплатной доставки: этап 2.
Основными задачами второго этапа бесплатной доставки были:
1. Объединение скидок. Сейчас если в ресторане есть скидка от нас и от плейса, то будет отображаться две скидки. Надо сделать так, чтобы отображалась одна лучшая скидка.
1. Софинанс. Необходимо было создать инструмент, с помощью которого можно будет в отдельном порядке заводить скидки, которые оплачиваются софинансированно с плейсами.
1. Перенос скидок "Бесплатная доставка для новичка сервиса". Необходимо перенести такие скидки из сервиса delivery-pricing. Это позволит некоторые первые бесплатные доставки для новичков делать за счет плейсов, а также мы вынесем лишнюю логику из сервиса delivery-pricing.


## Объединение скидок

Для решения этой проблемы нам надо сделать следующие задачи:
- Парсинг табличных скидок в либе для бесплатной доставки. (3 дня) [Тикет](https://st.yandex-team.ru/EDAJAM-409)
- На стороне рестаппа начинаем заводить партнерские акции, как табличные. По эксперименту. (3 дня) [Тикет](https://st.yandex-team.ru/EDAPARTNERS-889)
- Миграция существующих скидок бесплатной доставки на табличные значения (??) [Тикет](https://st.yandex-team.ru/EFFICIENCYDEV-17589)
- Переход на ручку v3/fetch-discounts в eats-discounts-applicator (4 дня) [Тикет](https://st.yandex-team.ru/EDAJAM-379)
- В либе (в методе для каталога) смотреть на табличные значения скидок и выдавать наименьший порог для корзины. Если будет один и тот же порог у скидки от Яндекса и от партнера, то выбираем партнерскую скидку(на самом деле это неважно, но поведение надо сделать константным). Такое будет стабильно встречаться при софинансе, будут заведены две скидки с разными процентными скидками, при этом отображать мы будем только одну. (3 дня) [Тикет](https://st.yandex-team.ru/EDAJAM-410)

Также техдолг после этих задач:
- [Убрать из иерархий слой check в админке](https://st.yandex-team.ru/TEFADMIN-2311)
- [Выпилить слой check на бекенде](https://st.yandex-team.ru/EFFICIENCYDEV-16878)
## Софинанс

Для поддержания софинанса надо сделать немного, т.к изначально мы учитывали его. И сейчас уже есть возможность создавать софинансовые скидки. Единственная существенная проблема это "Как правильно заводить скидки для софинанса?". Я предлагаю сделать отдельную форму в нашей админке. По факту при создании такой скидки будет создаваться две скидки с одинаковыми условиями в разные иерархии. При матчинге они будут находиться, и мы будем склеивать их в одну скидку. Также раньше мы перемножали проценты, а их все таки надо склалывать(20% от нас, 80% от плейса)

Тогда необходимо сделать два тикета:
- [Заведение через админку](https://st.yandex-team.ru/TEFADMIN-2370)

Единственная явная ошибка заведения может быть если у нас % партнера + % яндекса < 100%. В этом случае, скидка будет применятсья, но стоимость доставки не будет бесплатной.  

## Перенос скидок "Бесплатная доставка для новичка сервиса"

Основная сложность переноса этой скидки заключается в том, что у нас нет постоянных правил по "бесплатная доставка для новичков", периодически условия доставки меняются, а также проводятся эксперименты, чтобы определить какие условия эффективнее. Поэтому нам так же надо поддержать эту возможность делить пользователей по экспериментам. Для этого во всех яндексовых иерархиях есть аргумент experiments, в который мы будем посылать значение эксперимента(всех пользователей делят на группы). Таким образом для разных групп пользователей будет матчиться разные скидки.

Также сейчас идет эксперимент по показу бейджика "Бесплатная доставка". Надо поддержать отключение экшена акции на главном экране, если включен этот бейджик. 

Необходимо сделать три тикета:
- Начать брать статистику по eater_id + phone_id, для уменьшения фрода (2 дня) [Тикет](https://st.yandex-team.ru/EDAJAM-411)
- Внедрить эксперимент для разделения пользователей в либу (3 дня) [Тикет](https://st.yandex-team.ru/EDAJAM-413)
- В eats-discounts создать таблицу типы акций + прокидывать эту инфу в ручки. С помощью этого мы сможем явно отдельно разные типы скидок на доставку. Например, скидка для новичков, скидка "фиксированная доставка"(в будущем) и т.д [Тикет](https://st.yandex-team.ru/EFFICIENCYDEV-17639)
- На каталоге правильно отображать скидки из иерархии бесплатная доставка - если тип акции равен доставке для новичков, то по эксперименту отображаем либо бейджик, либо экшн скидки(3 дня) [Тикет](https://st.yandex-team.ru/EDAJAM-414)
- Поправить логику ухудшающего эксперимента в каталоге - если тип акции бесплатной доставки "для новичков", то скидку не скрываем, даже если эксп говорит об этом (2 дня) [Тикет](https://st.yandex-team.ru/EDAJAM-430) 
- В админке сделать возможность настраивать [приоритеты поля experiments](https://st.yandex-team.ru/TEFADMIN-2371), а также [добавить это поле в формы создания](https://st.yandex-team.ru/TEFADMIN-2319)
