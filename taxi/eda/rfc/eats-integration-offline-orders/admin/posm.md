# Генерация ПОСМ в админке сервиса Чек

## Общее описание

ПОСМ - ПОСадочный Материал, карточки/тейблтенты с qr-кодом и информацией о
столе, которые партнер выставляет на столах ресторана.  В qr-код зашита
уникальная ссылка на uuid стола.

ПОСМ формируется по шаблону (pdf), в который по указанным дизайнером координатам
вставляется изображение с qr-кодом и текстовым описанием (обычно, номером
стола).

В общем случае процесс генерации выглядит так:
- генерируется изображение с qr-кодом
- считывается шаблон
- считываются настройки
- в шаблон в соответствии с настройками вставляется qr
- в шаблон в соответствии с настройками вставляется указанный текст
- итоговый файл сохраняется в pdf

Требуется:
- уметь генерить ПОСМы по заранее загруженным шаблонам и настройкам шаблонов
(координаты и тп) -> уметь загружать шаблоны и настройки
- уметь выгружать ПОСМы для всех столов ресторана единым архивом
- уметь просматривать ПОСМ для конкретного стола
- уметь генерить ПОСМы как для ресторана (все столы), так и для конкретных
столов ресторана (а потенциально и без привязки к ресторану, просто для uuid)
- уметь скачивать отдельно qr-код (когда ПОСМы не нужны)

### Концепция
- генерируем ПОСМы сразу для всего ресторана
- генерируем ПОСМы в фоне, а не в ручке
- генерация завязана на place_id + template_id
- для place_id + template_id храним не более N генераций не более K дней
(конфигурируется). При этом на последнюю успешную генерацию храним без лимита
по времени
- формируем архив с файлами "на лету", т.е. не храним его отдельно в S3
- генерации отображаем на отдельной вкладке (примерно как тут
https://tariff-editor.taxi.yandex-team.ru/logs-load)
- для каждой генерации в таблице будет возможность скачать архив или отдельные
файлы
- если после генерации добавился/удалился стол - показываем об этом сообщение
с подтверждением намерений скачивания
- на кнопке генерации должен быть токен идемпотентности
- кнопка "скачать архив" не производит генерацию, а лишь упаковывает в архив
ранее сгенерированные ПОСМы
- вместе с шаблоном храним "рекомендованные" настройки, при этом даем
пользователю поменять их при каждой генерации
- вводится понятие "версия генерации" - каждое нажатие кнопки "сгенерировать"
увеличивает версию генерации (если дошло до записи в бд)
- количество одновременных генераций ограничено и управляется конфигом

### Шаги пользователя

#### Генерация и скачивание
1. Пользователь заходит на вкладку с генерациями (ПОСМ?)
2. Пользователю показывается история генераций и кнопка "сгенерировать"
   - в таблице с историей отображаются генерации для этого ресторана с
   датой создания и актуальным статусом, а так же возможностью посмотреть
   более подробную информацию о генерации (какие были настройки, какие столы
   были сгенерированы, возможность скачать определенный ПОСМ и тп)
   - "сгенерировать" - запускает процесс генерации для всех столов ресторана
3. Пользователь нажимает "сгенерировать"
   - показывается модальное окно с предложением выбрать шаблон и настройки
   - при выборе шаблона в редактируемой форме показываются рекомендуемые
   настройки
   - после проверки/правок настроек пользователь нажимает "сгенерировать"
   в модальном окне
   - в таблице появляется новая запись со статусом "создана"
   - при повторном нажатии на "сгенерировать" появится ошибка
4. Статус поменяется на in-progress, а затем на Done, на строке с генерацией
появляется кнопка "скачать"
5. Если в ходе генерации произошла ошибка - статус выставляется в error,
на фронте статус "ошибка" с красной подсветкой (можно показывать причину в
отдельном поле)

#### Работа с шаблонами
1. на отдельной вкладке админки показывать имеющиеся шаблоны и их настройки,
с возможностью создания/редактирования/удаления
2. шаблон может быть как глобальный (видимый из всех ресторанов), так и для
конкретного ресторана/ресторанов/brand_id
3. шаблоны ресторана, возможно, стоит вынести на страничку ресторана

### Технические шаги
1. шаблоны и N версий ПОСМов храним в S3
2. Нужны CRUD ручки по работе с шаблонами и настройками + список доступных
шаблонов
3. историю генераций храним в отдельной таблице со связью на ресторан и шаблон
4. при нажатии на "сгенерировать" в таблицу с историей генераций записывается
новая строка со статусом created
5. крон-таской раз в минуту проверяем наличие строк со статусом created, а так
же со статусом in-progress. Если кол-во in-progress меньше, чем значение в
конфиге - ставим stq-задачу и переводим в статус scheduled
6. сама генерация будет происходить в stq-таске, id - идентификатор из таблицы
истории генераций
7. новые файлы пишем с отдельным префиксом (содержит идентификатор генерации)
8. Старые файлы подчищаем крон-таской (настройки задаем конфигом)
9. В случае падения stq-таски - делать несколько ретраев, но не более N
(задавать конфигом)
10. ручка постановки задачи на генерацию (с сохранением логина вызвавшего)
11. Ручка проверки архива перед скачиванием (присутствуют ли файлы для всех
столов заведения)
12. ручка формирования и скачивания архива
13. ручка с историей генераций (как минимум с фильтром по заведению)
14. возможно ручка-прокси на s3 (если время жизни ссылки s3 ограничено)

### Предварительные изменения в БД
```postgresql
-- статусы для генераций
CREATE TYPE posm_version_status AS ENUM (
    'created',
    'in-progress',
    'done',
    'error',
    'deleted'
);

CREATE TYPE posm_owner AS ENUM (
    'global',
    'restaurant',
    'brand'
);

-- Новая таблица с шаблонами и настройками
CREATE TABLE posm_templates (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    template_link TEXT NOT NULL,  -- ссылка/идентификатор на S3
    settings JSONB NOT NULL DEFAULT '{}',  -- рекомендованные настройки
    visibility posm_owner NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    deleted_at TIMESTAMPTZ
);

-- таблица для связи плейс - шаблон
CREATE TABLE restaurants_posm_templates (
    template_id BIGINT REFERENCES posm_templates (id) NOT NULL,
    restaurant_id BIGINT REFERENCES restaurants (id) NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    deleted_at TIMESTAMPTZ
); -- для брендов будет отдельная таблица (когда их заведем)

-- уникальный индекс по template_id+restaurant_id и не выставленному deleted_at
CREATE UNIQUE INDEX restaurants_posm_templates_template_id_restaurant_id_unique
    ON restaurants_posm_templates (template_id, restaurant_id)
    WHERE deleted_at IS NOT NULL
;

CREATE INDEX restaurants_posm_templates_restaurant_id_index
    ON restaurants_posm_templates (restaurant_id);

-- Новая таблица с версиями:
CREATE TABLE restaurants_posm_versions (
    id SERIAL PRIMARY KEY,
    restaurant_id BIGINT REFERENCES restaurants (id) NOT NULL,  -- или place_id
    template_id BIGINT REFERENCES posm_templates (id) NOT NULL,
    status posm_version_status NOT NULL,
    version BIGINT NOT NULL,
    author TEXT NOT NULL, -- логин запустившего генерацию
    comment TEXT, -- поле для информации, например, о причине ошибки
    posm_template_settings JSONB NOT NULL,
    -- поле под маппинг стол - id из S3. Возможно, достаточно будет просто
    -- списка столов (id стола должен входить в идентификатор S3)
    tables JSONB NOT NULL DEFAULT '{}',
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    deleted_at TIMESTAMPTZ
);

CREATE INDEX restaurants_posm_versions_restaurant_id_index
    ON restaurants_posm_versions (restaurant_id);

-- уникальный индекс на restaurant_id+template_id+version
CREATE UNIQUE INDEX restaurants_posm_versions_restaurant_id_version_unique
    ON restaurants_posm_versions (template_id, restaurant_id, version)
;
```

![img.png](img.png)

<!--

%%(plantuml)
@startuml

participant Фронт
participant Чек
participant БД
participant Крон
participant stq
participant S3


Фронт -> Чек: генерация
Чек -> БД: Новая генерация (created)
Фронт <- Чек: Статус created

... Ожидание запуска крона 1 min max ...

БД -> Крон: проверка статусов
Крон -> stq: задача на генерацию

... Ожидание старта stq...

stq -> БД: выставление статуса in-progress
loop uuid
  stq -> S3: новый файл
end
stq -> БД: выставление статуса done

...
Фронт -> Чек: проверка архива
Чек <- БД: актуальные столы
Чек <- БД: столы в генерации
Фронт <- Чек: статус (ок, warn)
Фронт -> Чек: скачивание архива
Чек <- БД: id на S3
loop table_id
  Чек <- S3: получение содержимого + архивация
end
Фронт <- Чек: архив

@enduml
%%
-->
