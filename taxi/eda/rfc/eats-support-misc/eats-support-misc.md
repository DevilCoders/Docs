## Опросник для ревью комитетом

> Этот опросник нужен для [архитектурного ревью комитетом](https://forms.yandex-team.ru/surveys/25357/). Его можно будет скопировать.

> После его написания можно пробежаться по списку из [этой статьи](https://stackoverflow.blog/2020/04/06/a-practical-guide-to-writing-technical-specs/). Он подскажет, какие аспекты еще стоит осветить.

**Название сервиса**

eats-support-misc

**Какую продуктовую проблему решает сервис?**

Автоматизация обработки обращений по заказам в Чаттербоксе. Для этого нужно собирать мету по заказу, отдавать её в Чаттербокс, а тот будет обмениваться ею с Support AI. На основе меты будут создаваться правила автоматизации

**Почему нельзя решить эту задачу без разработки нового сервиса существующими решениями?**

* Вне коры сейчас отсутствует сервис, который бы мог предоставлять данные саппорт-меты для чаттербокса.
Отдельный сервис помог бы минимизировать необходимость доработок в коре при появлении новых продуктовых задач

**Как именно сервис будет решать поставленные перед ним задачи?**

1. Сервис получает данные из Коры
2. Из других сервисов получает допольнительные данные
3. Формирует ответ для чаттербокса из полученных данных

**Разрабатывается один сервис или система?**

Один сервис

**Сколько и какие сервисы входят в систему?**

Кора и на первом этапе Карго

**С кем взаимодействует сервис?**

- Чаттербокс получает необходимую саппорт-мету по заказу
- Монолит Еды:
    - сервис получает данные саппорт-меты из эндпоинта коры
- Сервис Карго:
    - сервис получает данные о курьере и заказе из карго. Например, статус посещения точки, eta

**Какие базы использует?**

PostgreSQL.

**Какие периодические процессы?**

Периодическая очистка данных в БД от устаревшего кэша.
Кэш курьеров - 12 часов.

**Прикрепите схему того, где этот сервис находится в текущей инфраструктуре**

Схема в [документации](https://wiki.yandex-team.ru/eda/dev/backend/services/eats-support-misc/#kartaservisov).

**Какие данные и по какой схеме сервис будет хранить в базе?**

```sql
CREATE SCHEMA eats_support_misc;

-- таблица с мета данными для саппорта
CREATE TABLE IF NOT EXISTS eats_support_misc.support_meta
(
  order_nr TEXT PRIMARY KEY,
  courier_support_meta JSONB,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
CREATE INDEX support_meta_created_at_idx ON eats_support_misc.support_meta (created_at);
CREATE INDEX support_meta_updated_at_idx ON eats_support_misc.support_meta (updated_at);
```

**Какой объем данных будет храниться и какой объем будет изменяться в единицу времени?**

До 10 мб в сутки, при этом устаревшие данные будут удаляться.
Обновление данных: 20-30 кб в секунду

**Какие операции над данными заложены?**

Данные курьеров будут кэшироваться на 12 часов.

Удаление устаревшего кэша (для курьеров - 12 часов).

**Есть ли какой-то стейт в памяти, как он обновляется и валидируется?**

Статические данные курьеров на 12 часов, а также динамические данные курьеров на 45 секунд.
Обновляются по запросу сервиса.

**Какая нагрузка ожидается?**

- До 10 RPS на ручку /get-support-meta

Возможен рост нагрузки с ростом количества заказов в Еде и обращений в КЦ.

**Какие фолбеки предусмотрены на сам этот сервис?**

Если сервис откажет, то чаттербокс не получит саппорт-мету по заказу

**Какие фолбеки предусмотрены внутри этого сервиса на взаимодействие с другими сервисами?**

- Если откажет Монолит, то сервис не сможет отдавать данные в чаттербокс.
- Если откажет Карго, то сервис будет брать данные из базы. После восстановления Карго сервис обновит данные по запросу.

**Какие возможности масштабируемости закладываются?**

Наращивание количества инстансов сервиса при увеличении нагрузки.

**Какие точки отказа есть в сервисе?**

- БД
- Потеря связности с Монолитом и сервисом Карго

**Укажите ключевые продуктовые метрики сервиса, за которыми планируете следить**

- Количество саппорт-меты, отданных чаттербоксу, в единицу времени

**Укажите технические метрики**

- Все ответы от сервиса в логах для дебага
- Серверные метрики (CPU, RAM, i/o и т.д.)
- Ошибки в логах

**Какая функциональность ожидается в сервисе в будущем?**

Добавление новых данных, выводимых в сервисе. Планируется писать код, агрегирующий данные для отображения в админках, не только Чаттербоксе, чтобы не писать более сложные клиенты и логику в Коре.

**Какое изменение нагрузки планируется?**

Пропорционально росту количества заказов в Еде.

**Активно ли будет изменяться сервис?**

Возможно, будет добавляться агрегация новых данных, выводимых в сервисе.

<hr>

### API

[Здесь.](docs/api/)
