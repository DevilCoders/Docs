# Алерты по ритейлу

## Проблема

Регулярно происходят проблемы в сервисе, о которых ответственные менеджеры узнают с запозданием (отмены, опоздания, падения ассортимента и тд).

Нужен единый инструмент, который бы оповещал об экстренных ситуациях всех ответственных в Telegram и позволил бы уменьшить время реакции и решений.

Алерты в Telegram ожидаются примерно в таком формате:
```
❗️Курьерские отмены Вкусвилл - 5,1% (23 заказа)
Топ города по горению:
- Москва - 7%
- СПб - 6%
- Краснодар -2%
Топ точки по горению:
- 158321 - 13%
- 143624 - 11,5%
- 149584 - 10,3%
@artptrnn @.. @.. (список ответственных)
```

## Возможные варианты решения

1. Использовать готовые метрики и алерты и перенаправить их в отдельный канал.
    * Плюсы:
        * Не требуется разработка новых инструментов, достаточно воспользоваться Juggler для алертов и метриками Solomon.
        * Для новых алертов достаточно добавить метрики для них и сам алерт.
    * Минусы:
        * Недостаточная детализация (лимиты Solomon и Juggler не позволяют добавлять слишком много значений меток у метрик). Так, например, не будет **списка магазинов с проблемами**.
        * Алерты Juggler позволяет читать не более 100 значений метрики (т.е. детализация по алертам должна быть достаточная, чтобы значений было меньше). Например, если при детализации по бренду будет больше 100 различных значений, то надо добавить разделение алертов еще и по регионам.
        * Вместо русских названий будет транслит (например, Vkusvill), т.к. Solomon не поддерживает кириллицу.
        * Текст алертов будет в типичном для Juggler виде, т.е. не в бизнесовом, а в формате:
          ```
            eats-retail-alerts-courier-cancels: CRIT

            Текст алерта

            Subalert URL: ...
          ```
        * Конфигурировать трешхолды для алертов можно будет только через разработку.
2. Разработать новый сервис в uservices, который будет сам собирать нужные метрики и отправлять алерты в телеграм:
    * Плюсы:
        * Алерты могут быть настолько детализированы, насколько это потребуется (в рамках разумного). Т.е. например, можно будет выводить ТОП-3 магазинов с проблемами.
        * Текст алертов будет на русском и в более читабельном для бизнеса виде.
        * Можно будет удобно конфигурировать параметры алертов: трешхолды, список ответственных, шаблон сообщения и т.д.
    * Минусы:
        * На текущий момент в uservices не поддерживается чтение из Mysql/Solomon/Prometheus, т.е. для того, чтобы сервис мог собирать метрики, надо написать клиент на C++ (что потребует достаточно много времени для разработки и согласования клиента с командой TAXICOMMON).
3. Разработать новый сервис в backend-py3, который будет сам собирать нужные метрики из реплики БД Коры и отправлять алерты в телеграм:
   * Плюсы:
       * Те же, что в варианте с uservices.
       * Клиенты для отправки алерт в Telegram и чтения данных из Mysql уже есть (и даже использовались - на примере сервиса eats-supply-orders-bot).
   * Минусы:
       * Чтение данных из реплики БД Коры для сбора метрик могут не согласовать в СБ.

## Предлагаемый вариант решения

### Первый этап

Подготовить алерты на основе текущих метрик, при необходимости добавляя недостающие метрики и метки (если это технически возможно и влезает в ограничения Соломона).
Для этого нужно:
0. Завести отдельный канал eats-retail-alerts для алертов Ритейла.
1. Подготовить алерты по отменам на основе метрики [eda_cancel_retail](https://solomon.yandex-team.ru/?project=eda&cluster=nanny_eda-core*&service=eda_app_order&l.host=cluster_sum&l.sensor=order_cancel_retail&l.region_name=Moskva&graph=auto), на основе которой можно будет собрать алерты примерно следующего формата (**без процентов и без детализации по магазинам**):
```
Курьерские отмены Vkusvill: 15 отмен
Топ города по отменам:
[Moskva: 12 отмен]
[Krasnodar: 2 отмен]
[Astrakhan: 1 отмен]
```
Пример алерта [в песочнице](https://solomon.yandex-team.ru/admin/projects/TaxiSandbox/alerts/5426e060-2380-4101-9d46-625a40929ad5).
2. Сейчас в этой метрике нет метки бренда, чтобы она появилась, нужно:
   * Либо добавить ТОП бренды (если достаточно получать алерты только по ним) в конфиг ```EDA_CORE_ORDER_CANCEL_METRIC_CONFIG```.
   * Либо добавить в эту метрику метку brand_name для всех брендов (если хотим получать алерты по всем).
3. Чтобы в алертах появился процент относительно всех заказов, а также для добавления алертов по количеству заказов (падение WoW) нужно:
   * Добавить в [backend_service_metrics](https://bb.yandex-team.ru/projects/EDA/repos/backend_service_metrics/browse) метрики кол-ва заказов в Ритейле с метками ```brand_slug, brand_name, region_id, region_name```. [Пример аналогичной метрики](https://bb.yandex-team.ru/projects/EDA/repos/backend_service_metrics/browse/src/metrics-market-integration.php) для заказов Маркета в Ритейле (но там другой набор меток).
   * Добавить для метрики ```eda_cancel_retail``` метку ```region_id``` (там уже есть метка ```region_name```, так что это не должно повлиять на кол-во значений метрики).
4. Часть алертов по ассортиментам (не обновляется меню больше 3 суток, не обновляются остатки больше суток) перевести в новый канал.

### Второй этап

1. Завести архревью по сервису в backend-py3. Общее описание сервиса:
   * В сервисе будет крон-таска раз в X минут подсчитывать побрендовые метрики по отменам на основе данных из реплики БД Коры и сохранять подсчитанные метрики в таблицы БД сервиса.
   * Затем другая крон-таска будет собирать все бренды, по которым согласно трешхолдам надо отправить алерт, и кидать по ним таски в stq отправки алертов.
   * STQ отправки алертов будет собирать текст алерта и отправлять в Telegram.
   * В конфигах будут описываться шаблоны для алертов, в которые будут подставляться нужные метки (бренды, регионы, магазины) и значения метрик.
2. Реализовать сервис и начать переводить алерты из первого этапа на этот сервис.
