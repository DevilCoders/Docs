Сторизы:

# Задача
[PRD](https://wiki.yandex-team.ru/users/apykhtinn/open-stories-url/)

Хотим показывать пользователю сторизы в следующих случаях:
1. Пользователь открывает магазин какого-то бренда
2. Пользователь открывает категорию в магазине

Условия показа сториз:
- Количество заказов пользователя в бренде X
- Список пользователей (по personal_phone_id или по eater_id)
- По группе нахождения в экспе (Решается через соль экспериментов)
- brand_id
- place_id
- версия приложения
- по городу (решается через координаты пользователя)
- ограничение показа коммуникации 1 раз на пользователя (решается через отметку коммуникации просмотренной)

Не в рамках MVP:
- Иметь возможность настраивать таймаут счетчика показа сториз
  (время через которое сториз по условиям выше можно показать повторно пользователю, который её уже видел).
  Так как сейчас такого функционала нет, и потребуется большие доработки для него
- Сторизы в приложении Го.
  Сторизы в Го заводятся через отдельную админку, требуются отдельные доработки для этого функционала


# Что уже есть сейчас
В сервисе ```eats-communications``` уже есть механизм получения сторизов по актуальному контексту пользователя.
За это ответчает ручка ```/eats/v1/eats-communications/v1/stories```, которая сейчас в том числе принимает контекст пользователя (экран, на котором хотят показать сторизы и тип заведения)
Большая часть необходимых условий показа уже есть в текущей реализации.

Сервис получает коммуникации (в том числе сторизы) из сервиса feeds, а сами коммуникацию задаются и редактируются через админку. 
Более подробно текущая схема расписана в [./informers.md](./informers.md)

# Решение
Так как параллельно с сторизами делаются информеры, то есть смысл рассматривать эти коммуникаци в одном скоупе.
Потому есть 2 варианта решения:
1. Получение сторизов на фронте отдельным механизом

Плюсы:
- Легче разграничить сторизы для Го и сторизы для Еды
- Уже есть ручка получения сториз, которой пользуется фронт

Минусы:
- Два отдельных источника коммуникаций
- Усложенение логики получения сториз на фронте (дополнительные запросы)
- Сложность расширения новых условий отображения

2. Получение коммуникаций (информеры+сториз) вместе
Плюсы:
- Один источник коммуникаций для фронта
- Логика получения сосредоточена на бэке, на фронте лишь нужно отобразить полученное
- Удобство расширения новых условий (Например, количество товаров с каким-то признаком)

Минусы:
- Нужно будет разграничивать получение сториз в Го, так как они отличаются источником данных (Еда - eats-communications, Го - inapp-communications) и форматом

Плюсы получения коммуникаций вместе превышают минусы, потому дальше будет рассматриваться именно этот вариант

Для решения задачи показа сториз при открытии категории магазина будет использоваться ручка ```/eats-communications/v1/categories/communications```, 
которая позволит получить список сториз в привязке к запрошенным категориям.

Так же потребуется сделать доработки в админке коммуникаций, так как сейчас нельзя определить, какой категории соответствует сториз.
Для решения этой задачи есть 2 варианта:

1. Задавать id категорий в экспериментах, тогда нужно пробрасывать название эксперимента в структуре сториз

   Плюсы: 
    - централизация условий (все условия показа будут задаваться в эксперименте, соответствующем сторизу)

   Минусы: 
    - менее понятно и для пользователя и в коде

2. Задавать id категорий в админке
   
   Плюсы: 
    - явно задаются категории
    - более явная логика фильтрации на стороне eats-communications

   Минусы: 
    - условия для отображения сториз будут раскиданы на 2 места: часть будет задаваться в эксперименте, часть в админке

Было решено использовать вариант с id категорий в админке, так как он более удобен
Для этого решения необходимо будет доработать админку (Добавить новый тип сториз и поле с категориями), а так же сервис, с которым админка взаимодействует

Для решения задачи показа сториз при открытии магазина, если в запросе сторизов будет указан brand_id, то необходимо 
будет получать количество заказов пользователя в этом бренде (user_orders_in_brand_count) и прокидывать это в эксп.
Таким образом, в самом эксперименте можно будет настраивать условия ```brand_id == X && user_orders_in_brand_count > N```, 
чтобы регулировать условие количеста заказов в указанном бренде.


# Доработки на бэке

## eats-communications

Реализовать ручки ```/eats-communications/v1/screen/communications``` и  ```/eats-communications/v1/categories/communications``` с ```type``` = ```stories```.
[Спеки ручек ./handlers.yaml](./handlers.yaml)

Для этого нужно:
1. Если указан brand_id получать количество заказов пользователя в указаннном бренде из ```eats-order-stats``` (есть смысл по конфигу включать/отключать этот поход)
2. Добавить в кварг билдер eats-communications/stories поля brand_id, place_id, category_id, user_orders_in_brand_count и заполнять их
3. Для сториз с ```recipient_type``` = ```category``` фильтровать полученные сторизы пересечением запрошенных id категорий и id категорий в сториз

## eats-products

Формат сториз в eats-products
```
communications:
   type: object
   additionalProperties: false
   properties:
      story:
         description: Стори, которую при наличии необходимо показать пользователю до отображения текущего экрана
         $ref: '#/components/schemas/ResponseStory'
```
Формат ResponseStory идентичен сторизам в eats-communications: [ResponseStory](https://a.yandex-team.ru/arc_vcs/taxi/uservices/services/eats-communications/docs/yaml/api/stories.yaml?rev=r9301850#L142)

### Сторизы в магазине

При получении от фронта запроса ```/api/v2/menu/goods``` без указания категории, нужно сходить в ручку ```eats-communications``` ```/eats-communications/v1/screen/communications```
c ```screen``` = ```shop_main_page```, ```type``` = ```stories```, ```brand_id```, ```place_id```

В ответе ручки ```/api/v2/menu/goods``` в поле ```payload.communications.story``` перемапить полученные сторизы из eats-communications. Брать только первую(наиболее приоритетную)

### Сторизы в категориях меню

При получении от фронта запроса ```/api/v2/menu/goods``` с указанием категории, нужно после получения всех данных о товарах и категориях из номенклатуры сходить в
ручку ```eats-communications``` ```/eats-communications/v1/categories/communications```
с ```screen``` = ```shop_category```, ```type``` = ```stories```, ```brand_id```, ```place_id```. А в поле ```categories``` вписать нужные данные по всем категориям.

В ответе ручки ```/api/v2/menu/goods``` в поле ```payload.categories.communications.story``` перемапить полученные по каждой категории из ответа eats-communications. Брать только первую(наиболее приоритетную)


## feeds-admin
Добавить StoryCategorySettings в StorySettings в ручках:
- ```/v1/eats-promotions/create```
- ```/v1/eats-promotions/update```
- ```/v1/eats-promotions/get```
```
    StoryCategorySettings:
        description: 'Дополнительные параметры для сториз категорий'
        type: object
        additionalProperties: false
        required:
          - recipient_type
          - category_ids
        properties:
            recipient_type:
                description: 'Тип сториз'
                type: string
                enum:
                  - category
            category_ids:
                type: array
                description: 'Массив идентификаторов категорий'
                items:
                    type: string
                minItems: 1
```

## Админка коммуникаций
Добавить новый тип Категории, где можно будет задавать список id категорий и при выборе этого типа заполнять поле StorySettings объектом StoryCategorySettings


# Фронт

1. При открытии пользователем страницы показывать страницу магазина только после получения ответа от ```/api/v2/menu/goods```. 
   Если в ```payload.communications``` есть поле ```story```, то показать эту стори пользователю.
   После закрытия стори показать главную магазина.

2. При открытии пользователем категории верхнего уровня в магазине после получения ответа от ```/api/v2/menu/goods``` запомнить стори
   для каждой категории из полей ```payload.categories.communications.story``` (если поле ```story``` есть). Когда пользователь переходит в категорию, 
   в которой есть стори, отображать сначала стори, а после закрытия стори, отображать уже саму категорию.

3. При просмотре пользователем сториз необходимо вызывать ручку ```/eats/v1/eats-communications/v1/viewed``` c id этой сториз (offer.shortcut_id), type = story,
   чтобы отметить сториз просмотренной. Если пользователь вернулся на экран с уже показанной сториз делать дополнительный запрос не нужно и 
   показывать снова просмотренную сториз тоже не нужно.
   [Ссылка на спеку ручки](https://a.yandex-team.ru/arc_vcs/taxi/uservices/services/eats-communications/docs/yaml/api/viewed.yaml)
