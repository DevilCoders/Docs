# Получение и отображение скидок для пользователей ПЛ ВкусВилла

Цель: отображать скидки, полученные от Вкусвилла, только для пользователей, у которых активирована программа лояльности ВВ.

Поскольку карты лояльности не хранятся в Еде, то в данном случае мы считаем, что пользователи, которые поставили согласие на плашке бонусов ВВ, имеют эту карту (т.к. ВВ в любом случае её создаст при получении согласия пользователя).

Модель движения данных:
- Партнер (ВкусВилл) -> integrations -> eats-discounts-collector (new) -> eats-discounts -> eats-discount-applicator (с походом в eats-tags) -> eats-products, eats-cart -> frontend

Мы будем помечать пользователей с данным согласием тегом в сервисе eats-tags, дальше он автоматически будет подхватываться в eats-products и eats-cart при получении скидок из eats-discount-applicator, поэтому ни там, ни на фронте доп. изменений делать не нужно.

Т.о. основные задачи - это:
1. помечать пользователей с согласием тегом скидок ВкусВилла
2. прогружать скидки от партнера в eats-discounts

Вне скоупа задачи:
  - eats-full-text-search - в апи есть структура для отображения скидок, но на данный момент скидки туда не пробрасываются (будет делаться в отдельном эпике).

Некоторые моменты:
1. Как сборщики партнера будут понимать, по какой цене надо брать товары - им будут выдавать карту лояльности, которой они должны будут воспользоваться, если заказ был сделан от пользователя с согласием?
- **Ответ:** уточнять и согласовывать надо с ВВ, здесь никаких дополнительных изменений с нашей стороны не нужно, т.к. мы уже передаем им данные о согласии пользователя.
2. Передает ли интеграция цены со скидками в заказе при передаче партнеру? И если да, то берет ли она их из eats-discounts, или нужна будет доработка, чтобы она брала их оттуда?
- **Ответ:** Передает, но eats-dicsounts уже отправляет скидки в Кору, так что здесь доп.изменений не нужно.

### Планируемые изменения:

#### 1. Правки в api партнеров для добавления возможности отправлять нам товарные акции.

В рамках задачи https://st.yandex-team.ru/EDADEV-44915 была разработана спецификация ручки скидок для партнеров `/discounts/{place_id}`.
В текущем варианте спека поддерживает только скидки товарами, поэтому для ВВ нужно предложить расширенный вариант со скидками деньгами.

Формат получаемых от ВкусВилла данных должен быть такой **или приводимый к такому** (учитывая, что здесь не все поля обязательные):
```json
{
    "discounts": [
        {
            "money_value": {
                "value_type": "fraction",
                "value": "10.0",
                "maximum_discount": "121.0" // необязательное поле
            },
            "origin_ids": [
                "8365776835",
                "8365776836",
                "8365776837"
            ],
            "schedule": {
                "from": "10-11-2021 00:00:00",
                "to": "11-11-2021 00:00:00"
            },
            "type": "price_discount"
        },
        {
            "money_value": {
                "value_type": "absolute",
                "value": "121.0"
            },
            "origin_ids": [
                "948472729"
            ],
            "schedule": {},
            "type": "price_discount"
        }
    ],
    "place_id": "123456"
}
```
Где:
  - `place_id` - партнерский id магазина
  - `schedule` - расписание действия скидки, пока поддерживаем только UTC время начала и конца в формате DD-MM-YYYY HH:MM:SS. Если оно не прислано, то в качестве расписания берутся текущие сутки.
  - `origin_ids` - список, содержащий идентификаторы товаров которые подпадают под скидку
  - `discounts` - массив скидок на группы товаров
  - `money_value` - объект значения скидки (абсолютное/процентное)
  - `value_type` - тип значения скидки (absolute/fraction)
  - `value` - значение скидки (абсолютное или в процентах)
  - `maximum_discount` - максимальное абсолютное значение скидки (для скидки в процентах), необязательное поле
  - `type` - тип скидки (для ВВ это только price_discount; для других партнеров уже делался тип скидки товарами product_discount)

#### 2. Изменения в сервисах интеграций.

В сервисах второй интеграции нужно сделать спецификации для апи скидок ВкусВилла.
Для этого надо использовать реализованный (https://st.yandex-team.ru/EDADEV-44444) в ручке /v1/tasks новый тип задачи "discount", который будет запускать скачивание скидок от партнеров.
Однако в текущем варианте эти таски умеют получать только скидки товарами (M=N), поэтому нужно расширить спецификацию для получения в том числе скидок деньгами.
Для этого в дискриминатор Discount (https://a.yandex-team.ru/arc_vcs/taxi/backend-py3/services/eats-retail-retail-parser/docs/yaml/definitions.yaml?rev=r8883343#L50) надо добавить тип скидки деньгами (описан в файле price_discount.yaml).
Пример получаемых скидок указан выше.

#### 3. Реализовать новый сервис для передачи скидок из integrations в eats-discounts (eats-discounts-collector).

В новом сервисе требуется реализовать логику для постановки и отслеживания поставленных задач в интеграциях.
Он будет работать аналогично сервису eats-nomenclature-collector, но ставить таски будет только по скидкам и ходить только в eats-discounts.
По расписанию цен плейс-группы (достается из ручки Коры) он будет получать файл со скидками из S3, парсить его, преобразовывать к виду eats-discounts и отправлять в eats-discounts.

Мы хотим реализовать механизм, при котором ретейлер отправляет все существующие скидки внутри плейса.
Для этого сервис будет дергать ручку eats-discounts `/v1/robot/discounts/replace`.
Ручка на стороне eats-discounts ожидает public_ids, для преобразования понадобится маппинг origin_id - public_id (маппинг берется из ручки eats-products `v2/products/public_id_by_origin_id`).
При вызове ручки нужно будет указать признак, по которому можно понять, какие скидки нужно заменить - в нашем случае это place_id, все старые скидки в этом магазине будут удалены и вместо них будут добавлены новые.

Также при вызове этой ручки для скидок ВкусВилла сервис должен будет прокидывать в ручку тег ВкусВилла (будет браться из побрендового конфига).

Подробности по ручке есть в https://st.yandex-team.ru/EFFICIENCYDEV-16008.

Эпик нового сервиса https://st.yandex-team.ru/RETAILDEV-1101.

#### 4. Изменения в eats-discounts.

- Добавить отдельный тег в сервисе тегов для скидок ВкусВилла.
- Переименовать иерархию скидок place_menu_discounts в retail_menu_discounts.
- Заменить использование PlaceMenuDiscountMeta на DiscountMeta
- Добавить слой тегов для иерархии retail_menu_discounts
Эти изменения можно сделать, т.к. скидок в этой иерархии пока нет.

Теги уже интегрированы в сервисы eats-products, eats-cart в задаче https://st.yandex-team.ru/EDAGROWTH-342, прокидывать их отдельно не нужно будет (они достаются по eater_id, personal_phone_id в самой либе eats-dicsounts-applicator).

#### 5. Изменения в Коре

Нужно научиться для пользователей, которые дают согласие на плашке ВВ (мы считаем это равным активной ПЛ ВВ у пользователя), добавлять их в тег в сервисе тегов.
Для этого нужно будет добавить клиент сервиса eats-tags в Кору и при получении этого согласия вызывать ручку POST /v2/upload из eats-tags (подробности в вики https://wiki.yandex-team.ru/taxi/backend/architecture/tags/faq/#naznachattegiizsvoegoservisa).

Получение согласия делалось в эпике https://st.yandex-team.ru/EDADEV-37840, можно ориентироваться на него при поиске места, куда нужно добавить добавление тега.

Также нужно будет единоразово для всех текущих пользователей с согласием добавить их в тег скидок ВВ (а новые будут добавляться уже автоматически).
