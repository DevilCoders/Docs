# Получение скидок от ретейлеров
  
Цель: отображать скидки полученные напрямую от ретейлеров.  
На первом этапе хотим добавить возможность отображения только товарных скидок (например "3 по цене 2").

Модель движения данных такая:  
Ретейлеры -> integrations -> eats-disounts-collector (new) -> eats-discounts -> eats-discount-applicator -> eats-products -> UI

Вне скоупа задачи:
  - eats-cart - сейчас отображают только иконку подарочка, без конкретики, поэтому пока оставляем без изменений
  - eats-full-text-search - в апи есть структура для отображения скидок, но на данный момент скидки туда не пробрасываются

## Товарные скидки
  
Сейчас у нас есть возможность заводить акции на товары только руками через админку такси. Проблема в том, что не хватает ресурсов для заведения всех актуальных акций на календарный день. Дополнительно, при создании скидки нет возможности указать текст для отображения на бейджике, только иконку.
  
### Планируемые изменения:
  
#### 1. Правки в api партнеров для добавления возможности отправлять нам товарные акции.

На первой итерации хотелось бы сделать максимально простую структуру, которую:
 - можно было бы легко превращать в сущности сервиса eats-disounts;
 - можно было бы легко расширить.

Запросы скидок будут выполняться поплейсово, для каждого плейса отдельный запрос.

Максимальное возможное количество данных для одного плейса (в случае если в самом большом магазине все товары со скидками):
100 000 товаров * 40 байт максимальная длина id товара =~ 4МБ
В среднем ожидается не более 1МБ

Формат получаемых данных должен быть такой или приводимый к такому, указанные поля нам обязательно нужны (описание полей и примеры см. ниже):
```json
    {
      "place_id": 0,
      "menu_hierarchy":[
        {
          "product_discount": {
            "discount_value": 0,
            "bundle": 0
          },
          "schedule": {
            "from": "",
            "to": ""
          }
          "origin_ids": []
        }
      ]
    }
```
Где:
  - `brand_id` - id бренда
  - `place_ids` - массив идентификаторов мест в которых есть указанные скидки, если этот массив пуст, то скидки применятся для всех магазинов бренда.
  - `menu_hierarchy` - иерархия скидок, содержит скидки на конкретные товары, для начала только одна, содержит список скидок
  - `product_discount` - скидка "товарного" типа (в качестве скидки клиент получает товары), содержит информацию для применения скидки
  - `discount_value` - значение скидки в процентах, целое число (см. примеры ниже)
  - `bundle` - количество товаров для срабатывания скидки (см. примеры ниже)
  - `meta` - поле для метаиинформации скидок
  - `schedule` - расписание действия скидки, пока поддерживаем только UTC время начала и конца в формате DD-MM-YYYY HH:MM:SS.
  - `origin_ids` - список, содержащий идентификаторы товаров которые подпадают под акцию

Примеры значений `discount_value` и `bundle`:
 - для "2 по цене 1" в поле discount_value будет 100, в поле bundle 2
 - для "3 по цене 2" в поле discount_value будет 100, в поле bundle 3
 - для "4 по цене 2" в поле discount_value будет 200, в поле bundle 4
  
#### 2. Изменения в сервисах интеграций.

В сервисах интеграций требуется сделать спецификации для апи каждого из партнеров, а также для нашей контрактной api.
Реализовать логику получения и сохранения скидок в S3.
В сервисе eats-place-groups-replica в ручку /v1/tasks добавить новый тип задачи, который будет запускать скачивание скидок от партнеров.

#### 3. Реализовать новый сервис для передачи скидок из integrations в eats-discounts (eats-discounts-collector).

В новом сервисе требуется реализовать логику для постановки и отслеживания поставленных задач в интеграциях.
Добавить возможность получать файл со скидками из S3, парсить его, преобразовывать к виду eats-discounts и отправлять в eats-discounts.
Мы хотим реализовать механизм при котором ретейлер отправляет все существующие скидки внутри плейса. А на нашей стороне в eats-discounts будет работать механизм удаляющий все старые скидки для плейса и создающий все вновь полученные. 
Для этого на стороне eats-discounts будет реализована ручка `/v1/partners/discounts/replace`. 
Ручка на стороне eats-discounts бует ожидать public_ids, для преобразования понадобится маппинг origin_id - public_id, который должен быть реализован в сервисе eats-products в ручке `v2/products/public_id_by_origin_id`.
Также, при конвертации скидки к формату eats-discounts требуется из значений в полях `discount_value` и `bundle` генерировать текст и пробрасывать его в метадату скидки.
Правило по формированию текста такое: "%bundle_count по цене %discount_value / 100". Текст "по цене" можно положить в конфиг как есть, в будущем возможно потребуется заменить на ключ Танкера, но пока мы не поддерживаем локализацию текстов на бэкенде.
При вызове ручки из eats-discounts требуется указать признак по которому можно понять какие скидки нужно заменить - в нашем случае это place_id, все старые скидки в этом магазине будут удалены и вместо них будут добавлены новые.

Примеры запросов-ответов можно посмотреть в тестах eats-discounts https://a.yandex-team.ru/arc/trunk/arcadia/taxi/uservices/services/eats-discounts/testsuite/tests_eats_discounts/static/test_partners_discounts_create

#### 4. Изменения в eats-discounts.

Добавить отдельный тип скидок/иерархию для скидок от ретейлеров для того чтобы отличать их от скидок, созданных через нашу админку.
Для новой иерархии скидок добавить поле в метадату text.
Добавить ручку `/v1/partners/discounts/replace`, логика работы ручки такая - при вызове ручки для указанного place_id удаляются все старые скидки и создаются новые взамен старых.
Сервис eats-discounts-collector будет вызывать эту ручку с place_id, и перечислением активных скидок.

Изменения в админку скидок вноситься не будут.

#### 5. Изменения в eats-discount-applicator.

Поддержать новую иерархию скидок, которая будет сделана для скидок, полученных от партнеров. 
На первом этапе ожидается, что объекты новой иерархии будут почти полностью дублировать соответствующие скидки из наших иерархий, единственное ожидаемое отличие - наличие поля text в метадате.
Скидки из нашей иерархии приоритетнее скидок полученных от ретейлеров.
Изменить формат ответа для скидок типа `product_promo` и добавить в объекты этого типа поле `text`, получаемое из метадаты скидки.

#### 6. Изменения в eats-products.

Добавить ручку для получения списка public_id по place_id и списку origin_id. Название ручки `v2/products/public_id_by_origin_id.
Поддержать изменения в eats-discount-applicator - в объекты скидок типа product_promo добавить поле text.
Пробросить полученное поле text в ручки `/api/v2/menu/goods/get-categories/`, `/api/v2/menu/goods`, `/api/v2/menu/product`

#### 7. Изменения на фронтах.

Получать и отображать скидки в новом формате от eats-products для ручек `/api/v2/menu/goods/get-categories/`, `/api/v2/menu/goods`, `/api/v2/menu/product`
Поддержать для скидок типа `product_promo` новое поле `text`, пример:
```json
    {
      "type": "product_promo",
      "id": 1,
      "name": "1 + 1",
      "pictureUri": "https://eda.yandex/uploads/promos/5b73/5b73e9d999e2a.png",
      "detailedPictureUrl": "https://eda.yandex/uploads/promos/5b73/5b73e9d999e2b.png"
      "detailedPictureUrl": "https://eda.yandex/uploads/promos/5b73/5b73e9d999e2b.png",
      "text": "2 по цене 1"
    }
```
Механизм работы: если в полученном объекте есть поле `text`, то выводить текст на фоне как для скидок типа `price_discount`. Если поле
`text` отсутствует - отображать картинку из `pictureUri`. У элементов обязательно должно быть хотя бы одно из двух 
полей: `text` или `pictureUri`. Если в объекте оказывается и поле `text` и поле `pictureUri`, то поле `text` считать более 
приоритетным.