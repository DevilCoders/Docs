# Механизм притягивания точек к графу
Краткая схема классов, участвующих в притягивании, приведена на UML-диаграмме ниже:\
!["Диаграмма классов, участвующих в притягивании"](https://jing.yandex-team.ru/files/m-korobkov/matcher_pipeline_uml.drawio.png)\
Сырые точки подаются через какой-либо стрим (InputReader) внутри [TMatcherManager](https://a.yandex-team.ru/arc/trunk/arcadia/taxi/graph/libs/matcher_framework/matcher_manager.h?rev=r8696155#L30).
Метод [MatchChunk](https://a.yandex-team.ru/arc/trunk/arcadia/taxi/graph/libs/matcher_framework/matcher_manager.inl?rev=r8696155#L50) читает этот стрим и вызывает метод [AppendSignal](https://a.yandex-team.ru/arc/trunk/arcadia/taxi/graph/libs/matcher_framework/matcher_manager.inl?rev=r8696155#L98) для сырых точек из этого стрима. Этот метод, в свою очередь, проверяет, что у новой поступившей точки Timestamp больше или равен последней притянутой (Timestamp берется из матчера), и если это условие выполняется, передает сырую точку матчеру в метод матчера AppendSignal, который притягивает и сохраняет у себя притянутую точку (матчер — класс-притягиватель, в нашем случае [TMatcher](https://a.yandex-team.ru/arc/trunk/arcadia/taxi/graph/libs/mapmatcher/matcher.h?rev=r8696155) или [TGuidance](https://a.yandex-team.ru/arc/trunk/arcadia/taxi/graph/libs/mapmatcher/guidance.h?rev=r8696155)).\
После того, как точка притянулась, менеджер вызывает метод OnAppended или OnRejected у провайдера (объект, реализующий интерфейс [IMatcherManagerConsumer](https://a.yandex-team.ru/arc/trunk/arcadia/taxi/graph/libs/matcher_framework/matcher_manager_consumer.h?rev=r8696155#L10), в нашем случае [TYagaProvider](https://a.yandex-team.ru/arc/trunk/arcadia/taxi/graph/libs/matcher_framework/yaga_provider.h?rev=r8697298#L103) или [TYagaGuidanceProvider](https://a.yandex-team.ru/arc/trunk/arcadia/taxi/graph/libs/matcher_framework/yaga_guidance_provider.h?rev=r8697306#L8)).
Провайдер преобразует данные из матчера в нужный формат и передает их [консьюмеру](https://a.yandex-team.ru/arc/trunk/arcadia/taxi/graph/libs/matcher_framework/yaga_consumer.h?rev=r8697306#L30) в метод [OnAdjustedPosition](https://a.yandex-team.ru/arc/trunk/arcadia/taxi/graph/libs/matcher_framework/yaga_consumer.h?rev=r8697306#L33). Консьюмер отвечает за то, что делать с очередной притянутой точкой, будь то запись в стрим или добавление в список/вектор, и его реализация зависит от поставленной задачи.