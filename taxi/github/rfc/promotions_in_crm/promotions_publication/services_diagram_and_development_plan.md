### Схема взаимодействия сервисов 

#### Состояние до реинтеграции

![](../img/services_diagram.png)

#### Возможное состояние после реинтеграции

![](../img/services_diagram_new.png)

### Предварительный список новых ручек и значительных доработок существующей логики на стороне продукта

Первый этап:
- новая ручка публикации [`communications-audience`]
- ручка снятия с публикации [`communications-audience` + возможная доработка на клиентах, api надо проработать]
- ручка статуса разметки [`communications-audience`, продуктовые потребности и api обсуждаются]
- тестовая публикация [доработка ручки публикации в `communications-audience` + доработка на клиентах]
- сохранение времени регулярных кампаний [`promotions`, api надо проработать]
- получение попадания пользователя в кампанию [`inapp-communications`, api надо проработать]

Второй этап:
- поддержка контекстной фильтрации [`communications-audience`]
- сохранение эксперимента для контекстной фильтрации [`promotions`]
- проверка попадания в эксперимент [`inapp-communications`]
- персонализация коммуникаций [пока не прорабатываем]

Третий этап:
- ручка, возвращающая доступные для публикации коммуникации [`promotions`]
- проверка экрана публикации для фуллскринов из пушей
- отдавать информацию о том, что фуллскрин уже опубликован по другим экспериментам
- редактирование содержимого опубликованного фуллскрина без перепубликации 
(например, для тех, кто ещё не видел)
- ручка создания драфта коммуникации с возможностью клонирования уже опубликованной коммуникации

Вне этапов, когда есть время:
- настройка отслеживания продуктовых и технических метрик и алертов

### Про разметку аудитории

Каждая часть аудитории, на которую будет отправлена коммуникация, получает уникальную метку кампании.
Этим мы заодно решаем такие задачи:
1. Снятие публикации с части аудитории. Можно подготовить новую аудиторию с новой меткой, 
убрать уже опубликованную с публикации полностью и опубликовать по новой метке. 
Можно и снимать с публикации по имеющейся метке и делать удаление из базы.
2. Регулярные публикации на часть аудитории. Сразу разбиваем аудиторию на части метками, 
каждая часть аудитории соответствует уникальной коммуникации с датами публикации и меткой. 

#### Возможные проблемы при реализации на стороне продукта

1. Пользователю приходит слишком много коммуникаций.

На первом этапе не решаем.

2. Пользователи открывают коммуникацию, например, содержащую ссылку, одновременно.

На первом этапе не решаем.

3. Может не хватить железа для хранения коммуникаций, если коммуникаций станет больше.

Скорее всего, такого не случится на первом этапе. Если коммуникация одна на весь список пользователей - проблемы точно нет, 
потому что запуск каждой кампании - отдеьный процесс с согласованием, их точно не будет много. 
Про персональные коммуникации и их возможное количество подумаем отдельно. 
Но если они заводятся руками - их тоже не должно быть много.
