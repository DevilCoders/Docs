# backend

languge: php

## dependencies

### cache
1. redis
2. memcached
3. [dynamodb](https://aws.amazon.com/dynamodb/)

### queue
1. [sqs](https://aws.amazon.com/ru/sqs/features/)
2. redis
3. [beanstalkd](https://beanstalkd.github.io/)

### db
1. sqlite
2. mysql
3. pgsql
4. mongodb - участвует в цикле заказа
5. sql server

### extenrnal dependencies
1. [mailgun](https://www.mailgun.com/)
2. postmark
3. [ses](https://aws.amazon.com/ru/ses/)
4. [sparkpost](https://www.sparkpost.com/)
5. [stripe](https://stripe.com/)
6. [pusher](https://pusher.com/)


### Notes:

#### Довольно много внешних зависимостей, 

#### Отсутствуют тесты

#### Недостаточно индексов
- [Запрос истрии поездок делается не по индексу](https://bb.yandex-team.ru/projects/TAXI/repos/tada-api/browse/app/Http/Controllers/V1/OfferController.php#183)
Для коллекции `offers`, имеется индекс только на поле `offer_guid`, судя по скриптам миграции(возможно миграции были и ручные). 

- [/offer/setPassengerSeenOfferScreen - можно сделать более оптимальный индекс](https://bb.yandex-team.ru/projects/TAXI/repos/tada-api/browse/app/Http/Controllers/V1/OfferController.php#294)
см. описание предыдущей проблемы

#### Кажется, что в некоторых местах, в транзакции обернули больше кода чем нужно
- [раз](offerPriceChange - публикация внутри транзакции)
- [два](CALLBACK_ACTION_POSITION_UPDATE - обновляем координату водителя в 2х коллекциях)
- [три](logDriverPosition - обновляем координату водителя в 2х коллекциях)
- [четыре](createPendingBid - публикация внутри транзакции)

Вероятно, занисением публикации внутри транзакции, решали проблему с отправкой события. Давая гарантию того что если действие произошло - должно быть отправлено уведомление.

#### Использование ORM, в свою очередь, способствует скрытию возможных проблем с запросами (таймауты, ретраи)

#### pub/sub система поллинга
Исходя из результатов личного тестирования, выглядит так что клиенты не очень хорошо работают с данной системой. 

### Резюме
1. Код рабочий, хоть и имеет недостатки
2. При наличии адекватной нагрузки, mongodb без индексов, будет себя очень плохо чувствовать, тем самым будет аффектить цикл заказа
3. В какой-то момент без тестов, скорость разработки может снизиться
4. Мы не имеем опыта работы с механизмом pub/sub для взаимодействия между клиентом и сервером, скорее всего наша инфраструктура не готова к таким решениям + непонятно, как это работает на большом масштабе. Поэтому, вероятно, придётся переписать данный подход на short polling + специальные функции для аукциона и отмен(нужно консультироваться с инфраструктурой, конечно). Это в свою очередь, значит, что мы будем вынуждены и переписать клиентский код.
