### Терминология

**Родитель** - пользователь, который приглашает другого пользователя в сервис

**Ребёнок** - пользователь, которого приглашают в сервис

**Код** - реферальный код, который идентифицирует родителя

## Коды

### Создание

В качестве кода будем генерировать 6-и символьную регистронезависимую строку из букв и цифр. На случай коллизий будем повторять пару-тройку раз генерацию. Если не получается - пятисотим. Если будем часто пятисотить, модифицируем схему генерации кодов.

### Хранение

Будем хранить сгенерированные коды в postgres в табличке users. Код пользователя положим в поле own_referral_code, код, по которому зарегестрировался пользователь (если такой есть) - parent_referral_code. На оба поля навесим индексы.

### Получение

[Ручка](https://st.yandex-team.ru/RIDABACKEND-188#621f6c5c4b090a7d5b30f707). Если у пользователя нет кода - генерируем.

Пассажир будет получать код на экране заказа такси ([задача](https://st.yandex-team.ru/RIDAANDROID-422)). Пока договорились, что на экране будет символ подарка, при нажатии на который будет отображаться вся инфа из этой ручки.

Водитель пока непонятно как будет получать эту инфу.

### Применение

[Ручка](https://st.yandex-team.ru/RIDABACKEND-187#621f4afb26cc633d19976138). Просто заполняем поле parent_referral_code. 

Стоит как-нибудь убедиться, что пользователь действительно новый. К примеру, что у него не было ещё не одного заказа.

Ввод кода будет происходить во время регистрации, на этапе ввода имени, и не будет блокировать регистрацию ([задача](https://st.yandex-team.ru/RIDAANDROID-423)).

При ошибке ввода кода, пользователь будет получать соответствтующее сообщение красным текстом под полем ввода.

## Аналитика и выплаты

Будем искать кому платить через yt, новое поле попросим реплицировать в dwh.
