**Название сервиса**
fleet-drivers-scoring
fleet-drivers-scoring-reports

**Какую продуктовую проблему решает сервис?**

Позволит по ВУ собирать данные о водителе из всех таксопарков, в которых он зарегестрирован. 
Это позволит таксопаркам принимать решение о найме водителя или выдачи машины в аренду.

Будет бесплатный и платный отчет:
В бесплатной версии будет:
 - имя водителя
 - телефон(маскируется)
 - информацию о текущей машине
 - есть ли задолжность в таксопарке
 - пройден ли контроль ВУ
 - текущий рейтинг водителя.

В платной добавляется:
 - статистика по заказам
 - динамика рейтинга водителя
 - статистика отзывов пользователя
 - статистика по манере вождения
 - из внеших источников(судимость, штрафы, лишение прав)

Может еще что-то будет добавляться по согласованию с Юристами.

**Почему нельзя решить эту задачу без разработки нового сервиса существующими решениями?**

Сейчас функциональность бесплатного скоринга реализована на С#.
Мы хотим ее перенести на с++ и расширить дополнительной инфой.


**Как именно сервис будет решать поставленные перед ним задачи?**

fleet-drivers-scoring-reports - сервис на python, который будет переодически запускать расчеты статистик на yt и складывать результаты в дин-таблицы.

fleet-drivers-scoring - сервис на c++. будет отвечать за:
  - Сбор ответа для бесплатного скоринга по другим микросервисам
  - Сбор ответа для платного скоринга по другим микросервисам, дин-таблицам, и внешним сервисам
  - Хранение истории запросов платного скоринга, чтобы потом бесплатно показать при повторном запросе
  - Ограничения числа запросов от одного таксопарка

Платный скоринг сделаю асинхронным. Будет состоять из двух ручек и задачи в stq:
  - ручка заказать проверку, которая ставит задачу в stq
  - ручка получить проверку, которая возвращает статус pending пока проверка не готова
  - задача в stq, которая собирает ответ, записывает в историю, списывает деньги через биллинг

**Разрабатывается один сервис или система?**

Система сервисов

**С кем взаимодействует сервис?**
fleet-drivers-scoring будет ходить в:
  stq(для асинхронного подготовки ответа)
  yt
  billing
  driver-profiles,
  unique-drivers,
  fleet-vehicles,
  fleet-parks,
  taximeter-xservice(для проверки прохождения контроля ВУ, потом отдельный микросервис)
  personal,
  dispatcher-access-control(в будущем для проверки прав),
  какие-то другии микросервисы в зависимости от того, что захочет менеджер.

fleet-drivers-scoring-reports будет выполнять yql запросы

**Какие базы использует?**
Заведу postgres


**Какие периодические процессы?**
fleet-drivers-scoring:
  Удаление или перенос в yt старых проверок из истории

fleet-drivers-scoring-reports:
  Расчет различных статистик по водителю


**Планируется обработка персональных данных**
Да


**Какие данные и по какой схеме сервис будет хранить в базе?**
Будем хранить все платные проверки. Старые будем либо удалять, либо переносить в yt.

**Какой объем данных будет храниться и какой объем будет изменяться в единицу времени?**
Текущая на аналогичную ручку в C# меньше 1rps. На платный скоринг тоже, наверное, не больше 1rps будет.
Одна проверка не больше 10кб весит. 
Если год хранить проверки, то получается:
24 * 3600 * 365.0 * (1024 * 10) / 10e9 = 33Гб. С двойным запасом нужно 66Гб
За один день:
24 * 3600 * (1024 * 10) / 10e6 = 89Мб 

**Какие операции над данными заложены?**
поиск по ВУ данных водителя.
Сохранение истории платных проверок.
Обновление rate-limiter.

**Есть ли какой-то стейт в памяти, как он обновляется и валидируется?**
нет


**Какая нагрузка ожидается?**
Текущая на аналогичную ручку в C# меньше 1rps.
Менеджер предлагает лимит на один таксопарк 100 запросов в день. Это с учетом 200k таксопарков даст 232rps, но это явно сильно завышенная верхняя граница.


**Какие фолбеки предусмотрены на сам этот сервис?**

не предусмотрены


**Какие фолбеки предусмотрены внутри этого сервиса на взаимодействие с другими сервисами?**

Обсудим с менеджером, возможно при отказе каких-то микросервисов, в которые ходим, не будем отдавать клиенту блок с соответствующей информацией.


**Какие возможности масштабируемости закладываются?**

Увелечений числа серверов/cpu. Попарковое шардирование базы. Но не похоже, что нужно будет масштабироваться.


**Какие точки отказа есть в сервисе?**
Для бесплатного:
 - рейт-лимитер
 - driver-profiles, unique-drivers

Для платного: 
 - рейт-лимитер
 - stq


**Укажите ключевые продуктовые метрики сервиса, за которыми планируете следить**
Статистика по тому какие таксопарки сколько каких(платных/бесплатных) запросов сделали. 


**Укажите технические метрики**
rps
размер postgres c историей проверок


**Какая функциональность ожидается в сервисе в будущем?**
Расширение возвращаемой инфы о водителе.


**Какое изменение нагрузки планируется?**
x2 ближайший год


**Активно ли будет изменяться сервис?**
В ближайшее время будет активно расширяться отдаваемая информация


**Комментарий**

