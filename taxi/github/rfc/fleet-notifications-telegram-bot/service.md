**Название сервиса**

fleet-notifications-telegram-bot

**Какую продуктовую проблему решает сервис?**

Предоставление пользователям диспетчерской возможности получать оповещения через бота в Telegram.

**Почему нельзя решить эту задачу без разработки нового сервиса существующими решениями?**

Есть запрос от парков на оповещения в мессенджеры, так как это более удобное средство взаимоействия, чем почта и колокольчик. Сервиса или другой возможности отправки оповещений в ТГ нет. Сейчас есть уведомления на почту, однако для оповещений в ТГ нужен совершенно другой флоу, так как необходимо использовать бота и API Telegram. Сервис будет использоваться в сервисе fleet-notifications, но логика работы с ТГ и чатами в нем – это отдельный контекст и failure-домен, поэтому она выносится в отдельный сервис.

**Как именно сервис будет решать поставленные перед ним задачи?**

- Старт
  - Для точного сопоставления telegram_id и user_id в админке используется deep linking.
  - В диспетчерской будет кнопка добавления ТГ в качестве средства получения уведомлений.
  - За этой кнопкой – ссылка на бота с query: start=<токен идентификации, соответствующий user_id>.
  - Когда пользователь запустит бота, telegram_id сохранится в ПД, во fleet-notifications-telegram-bot придет токен идентификации, по которой сохраним связку user_id, telegram_pd_id.
  - Из fleet-notifications-telegram-bot через сервис dispatcher-access-control сохраняем возможность отправки уведомлений пользователю через ТГ.
- Флоу работы
  - В сервис fleet-notifications приходит запрос на отправку уведомления пользователю.
  - fleet-notifications проверяет через dispatcher-access-control, есть ли возможность отправки уведомлений пользователю через ТГ.
  - Если есть, fleet-notifications отправляет запрос в fleet-notifications-telegram-bot с текстом уведомления и user_id.
  - fleet-notifications-telegram-bot достает telegram_id из ПД по telegram_pd_id и отправляет уведомление.
- Удаление связки
  - Пользователь удаляет связку с ТГ в диспетчерской.
    - Убираем возможность отправки уведомлений пользователю через ТГ.
    - Запись в базе fleet-notifications-telegram-bot (user_id, telegram_pd_id) удаляем, так как появится возможность запросить новую ссылку на бота.
  - Пользователь остановил бота.
    - Ничего не делаем, так как сообщения сами перестанут отправляться
    - Новая ссылка в этом случае не нужна, достаточно рестарта.
    - Удалять пару user_id, telegram_pd_id нельзя, так как в случае рестарта бот не получает инфу deep linking'а.
  - Пользователь уволен из парка.
    - Убираем возможность отправки уведомлений пользователю через ТГ.
    - Запись в базе fleet-notifications-telegram-bot (user_id, telegram_pd_id) удаляем.
- Токен идентификации
  - Токен – случайная строка
  - Записываем ее в базу fleet-notifications-telegram-bot
  - Записываем в базу fleet-notifications-telegram-bot время, до которого эта строка валидна

**Разрабатывается один сервис или система?**

Один сервис.

**С кем взаимодействует сервис?**

1. fleet-notifications-telegram-bot <-> dispatcher-access-control
2. fleet-notifications-telegram-bot <-> personal
3. fleet-notifications-telegram-bot <-> fleet-notifications
4. fleet-notifications-telegram-bot <-> proxy GoZora <-> api.telegram.org <-> Клиент Telegram

**Какие базы использует?**

Postgres в PGaaS.

**Какие периодические процессы?**

Нет.

**Планируется обработка персональных данных**

Да, на этапе старта бот получает telegram_id и сохраняет его в ПД.

**Какие данные и по какой схеме сервис будет хранить в базе?**

```javascript
clients
{
  "user_id": "id пользователя диспетчерской",
  "telegram_pd_id": "id telegram_id в ПД",
  "updated_at": "время последнего изменения telegram_id_pd_id",
}

tokens
{
  "user_id": "id пользователя диспетчерской",
  "token": "токен регистрации пользователя",
  "time_until_token_valid": "время окончания действия токена регистрации"
}
```



**Какой объем данных будет храниться и какой объем будет изменяться в единицу времени?**

Одна запись в таблице соответствует одному уникальному пользователю в одном парке.
Количество парков ~ 700.000
Количество пользователей в парке ~ 10-100
Тогда строк в таблице будет 7М ~ 70М
Если взять средний размер строки 100 байт, получим оценку 700 МБ - 7 ГБ.

Предполагается, что объем данных, которые будут изменяться за 1 секунду не будет превышать 1 мегабайта.

**Какие операции над данными заложены?**

CRUD

**Есть ли какой-то стейт в памяти, как он обновляется и валидируется?**

Нет.

**Какая нагрузка ожидается?**

От SignalQ rps не превосходит 0.01 на данный момент.  
Ожидается не больше 10 rps на старте, сильный рост не ожидается.

**Какие фолбеки предусмотрены на сам этот сервис?**

Если сервис недоступен, уведомления в ТГ не приходят, но продолжают приходить другими средствами(почта, колокольчик).

**Какие фолбеки предусмотрены внутри этого сервиса на взаимодействие с другими сервисами?**

Если fleet-notifications недоступен, уведомлений нет.  
Если Telegram API недоступен, нельзя запустить бота/уведомления продолжают приходить другими средствами(почта, колокольчик).  
Если dispatcher-access-control недоступен, нельзя запустить бота/уведомления продолжают приходить другими средствами(почта, колокольчик).
Если personal недоступен, нельзя запустить бота/уведомления продолжают приходить другими средствами(почта, колокольчик).

**Какие возможности масштабируемости закладываются?**

- Увеличение ram/cpu на инстансе.
- Увеличение количества инстансов сервиса.
- Появление кэшей в сервисе (с данными из базы, например), при сильном росте нагрузки.
**Какие точки отказа есть в сервисе?**

- Отказ Telegram API.
- Отказ dispatcher-access-control.
- Отказ fleet-notifications.
- Отказ personal.

**Укажите ключевые продуктовые метрики сервиса, за которыми планируете следить**

Количеством уведомлений, отправляемых разными сервисами.

**Укажите технические метрики**

- Количество запросов.
- Максимальное и среднее время ответа на запрос.
Под запросом понимается использование ручки, которую дернул ТГ с помощью webhook.

**Какая функциональность ожидается в сервисе в будущем?**

Не ожидается другой функциональности.

**Какое изменение нагрузки планируется?**

Не планируется значительного изменения нагрузки.

**Активно ли будет изменяться сервис?**

Активных изменений не планируеся, так как задумана простая логика. И текст, и получатели приходят от fleet-notifications. То есть бот запланирован в качестве простого пердатчика сообщений.
