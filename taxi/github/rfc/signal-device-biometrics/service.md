**Название сервиса**

signal-device-biometrics

**Какую продуктовую проблему решает сервис?**

Определяет водителя, пользующегося камерой signalq.

**Почему нельзя решить эту задачу без разработки нового сервиса существующими решениями?**

Нет полностью подходящего нам решения, надо собрать его по кусочкам из уже работающих сервисов.
В целом работа с изображениями водителей тянет на отдельный связанный контекст.

Важно отметить: signalq используют не только таксопарки и наша база лиц отличается от базы лиц антифрода Такси.

**Как именно сервис будет решать поставленные перед ним задачи?**

Сервис преобразовывает фотографии в векторы (features) с помощью сервиса cbir (разработан в CV большого яндекса).
Эти векторы мы cкладываем в свою БД (вместе с необходимой мета-информацией о водителе, типа его идентификаторов).
Оттуда реплицируем их в YT и запускаем воркфлоу в Нирване, который из таблички векторов (и мета-данных) в YT варит индекс и запихивает его в saas.

После этого тыкаем через специальную ручку в свой индекс в saas и находим ближайших соседей по векторам приходящих нам от камер фотографий.

Воркфлоу в Нирване и индексы в SaaS разрабатывают люди из Поиска, мы переиспользуем решение (антифрод делает так же).

Зачем нужна своя БД и почему не сразу в YT:

Есть неприятный нюанс: сейчас нет операции, позволяющей в индекс в SaaS добавить один элемент. Индекс всегда нужно перестраивать целиком.
Нет проблемы, если водитель перед камерой начнет определяться через условный час после того, как в админке добавили его фотографию, но есть другая: мы хотим, при последовательном добавлении пользователем фотографий, сразу же проверять, что водителя с таким лицом еще нет в его парке. Надо уметь тыкать в водителей, которых добавляли несколько секунд назад (блокировать пользователю добавление на много минут, пока мы перестраиваем индекс, как и в целом перестраивать его по каждой единичной операции – не ОК). Нам пока не могут предложить хорошее и быстрое решение со стороны SaaS, так что для последних "горячих" водителей мы построим свой кусок логики – будем проверять их сходство перебором друг с другом в рамках парка (ожидаем всегда не более 100 записей для такой проверки).

Если со стороны разработчиков индексов в saas появится подходящее нам решение, позволяющее не делать часть поиска на своей стороне, сразу на него переедем.

**Разрабатывается один сервис или система?**

Один сервис.

**С кем взаимодействует сервис?**

Исходящие запросы:

- к сервису cbir для извлечения векторов фичей из фотографий.

Входящие запросы:

- из админки при добавлении новых водителей
- из signal-device-api для определения водителя, который сейчас сидит перед заданной камерой

**Какие базы использует?**

Новый postgres signal_device_biometrics.

**Какие периодические процессы?**

Нет в сервисе, появится воркфлоу в нирване.

**Планируется обработка персональных данных**

Храним числовые векторы фичей, полученные преобразованиями фотографий водителей. Наружу из сервиса их не отдаём.

**Какие данные и по какой схеме сервис будет хранить в базе?**

park_id, driver_id, <вектор вещественных чисел>

**Какой объем данных будет храниться и какой объем будет изменяться в единицу времени?**

Меньше Гб. Будет расти пропорционально числу водителей у партнеров, пользующихся камерами signalq.

Изменений меньше 1 мб/с.

**Какие операции над данными заложены?**

read, write

**Есть ли какой-то стейт в памяти, как он обновляется и валидируется?**

Нет

**Какая нагрузка ожидается?**

30 rps на определение водителя на фотографии

Меньше 1 rps на добавление новых фотографий водителей партнерами.

**Какие фолбеки предусмотрены на сам этот сервис?**

Перестаем надежно определять водителей перед камерами (умеем в качестве фоллбэка это делать только для водителей Такси по статусам Про).
Не даем загружать фотографии новых водителей (но создавать водителей при этом можно).

**Какие фолбеки предусмотрены внутри этого сервиса на взаимодействие с другими сервисами?**

Если отваливается pg, деградируем: определяем водителей за рулем камер, но не даем добавлять фотки для новых.

Если отваливается cbir или saas, сервис не работает работать.

За пределами сервиса, но связано с ним: если отваливается Нирвана, растет задержка между событиями "парк добавил фотку водителя" – "мы начали узнавать его за рулем машины".

**Какие возможности масштабируемости закладываются?**

Увеличение базы, увеличение ram/cpu на инстансе, увеличение количество инстансов сервиса.
Добавление квот в cbir/Нирвану/SaaS.

**Какие точки отказа есть в сервисе?**

Отказ cbir, отказ saas.
Частично: отказ pg.

**Укажите ключевые продуктовые метрики сервиса, за которыми планируете следить**

- Количество загруженных фотографий водителей по паркам
– Количество неправильно определенных водителей для событий, зафиксированных камерами

**Укажите технические метрики**

- Среднее время ответа на запрос.
- Среднее время на перестройку индекса
- Размер индекса
– Время до попадания новой записи в индекс

**Какая функциональность ожидается в сервисе в будущем?**

Все связанное с определением водителей, пользующихся камерами signalq.


**Какое изменение нагрузки планируется?**

Прямо пропорционально количеству активных камер усталости (почти весь rps будет от камер).

**Активно ли будет изменяться сервис?**

Может появиться работа с какими-то данными о водителях кроме фотографий. Сейчас сложно сказать.
