# Рекомендация детского тарифа в саджесте

Корневой тикет: [TAXIMOBILEDEV-511](https://st.yandex-team.ru/TAXIMOBILEDEV-511)

## Постановка задачи 

Эксперимент в убере показал, что что есть просадка в тарифе детский, 
скорее всего из-за того, что часть пользователей не знают о таком тарифе, или не понимают, как его вызвать.

Поэтому предлагается в качестве одного из решений в саджесте рекомендовать тариф детский,
если пользователь использовал адрес организации, где чаще всего заказывают тариф детский.

### Дизайн

<img src="https://jing.yandex-team.ru/files/vasiukevich/uberkids_suggest_design.png" width="350"/>



## API

Для отображения подсказки по детскому тарифу модифицируем ответ следующих ручек сервиса persuggest:
- `/4.0/persuggest/v1/zerosuggest`;
- `/4.0/persuggest/v1/suggest`;
- `/4.0/persuggest/v1/finalsuggest`.

#### Пример запроса:
```(json)
{
  "action": "user_input",
  "id": "ad40b0aa52774e5db8f3d56ab9e22e0b",
  "part": "детс",
  "type": "b",
  "state": {
    "accuracy": 18,
    "bbox": [
      37.46687270699647,
      55.73532182916523,
      37.47064312634569,
      55.738613595920725
    ],
    "fields": [
      ...
    ],
    "location": [
      37.4686322,
      55.7370214
    ]
  }
}
```

#### Пример ответа:
```(json)
{
  "results": [
    {
      "pos": "37.4585610000,55.7194860000",
      "method": "geosuggest",
      "lang": "rus",
      "log": "{\"suggest_reqid\":\"1612532047755138-2686319601-suggest-maps-hamster-yp-4\",\"user_params\":{\"request\":\"детс\",\"ll\":\"37.468700,55.737099\",\"spn\":\"0.00248718,0.002491\",\"ull\":\"37.468700,55.737099\",\"lang\":\"ru\"},\"server_reqid\":\"1612532047755138-2686319601-suggest-maps-hamster-yp-4\",\"pos\":1,\"type\":\"org1\",\"what\":{\"id\":\"1159451328\"},\"uri\":\"ymapsbm1://org?oid=1159451328\"}",
      "text": "Детская поликлиника № 30, филиал № 3",
      "title": {
        "text": "Детская поликлиника № 30, филиал № 3",
        ...
      },
      "subtitle": {
        "text": "Детская поликлиника · улица Артамонова, 6",
        ...
      },
      "action": "search",
      "uri": "ymapsbm1://org?oid=1159451328",
      "distance": {
        "text": "2.1 км",
        "value": 2052.393364
      },
      "suggested_tariff": {
        "tariff_class": "uberkids",
        "button_title": "Выбрать тариф $TARIFF$",
        "show_policy": {
          “id”: “uberkids_suggest_button”,
          “max_show_count”: 5,
          “max_widget_usage_count”: 1
        }
      }
    },
    ...
  ],
  "part": "детс",
  "suggest_reqid": "1612532047755138-2686319601-suggest-maps-hamster-yp-4"
}
```

То есть в объекты предложений, передаваемые в списке results мы добавили поле suggested_tariff со схемой:
```yaml
properties:
    ...
    suggested_tariff:
        $ref: '#/definitions/SuggestedTariff'


definitions:
    ShowPolicy:
        type: object
        additionalProperties: false
        description: |
            Информация о политике показа элемента интерфейса: количество показов, количество переходов и т.д.
        required:
            - id
        properties:
            id:
                type: string
                description: ID сохраняемого на клиентах счётчика показов/нажатий
                example: "uberkids_suggest_button"
            max_show_count:
                type: integer
                minimum: 0
                description: |
                    | Максимальное число показов объекта, после достижения значения объект скрывается.
                    | Отсутствие значения означает отсутствие ограничений на число показов.
                example: 5
            max_widget_usage_count:
                type: integer
                minimum: 0
                description: |
                    | Максимальное число взаимодействий (тапов), после достижения значения объект скрывается.
                    | Отсутствие значения означает отсутствие ограничений на число взаимодействий.
                example: 1

    SuggestedTariff:
        type: object
        additionalProperties: false
        description: Рекомендуемый тариф на строчке саджеста
        required:
            - tariff_class
            - button_title
            - show_policy
        properties:
            tariff_class:
                type: string
                description: рекомендуемый класс поездки
                example: "uberkids"
            button_title:
                type: string
                description: Строка рекомендации тарифа
                example: "Выбрать тариф $TARIFF$"
            show_policy:
                $ref: '#/definitions/ShowPolicy'
```

Рекомендация тарифа добавляется только в первый подходящий объект.

Иконка и название тарифа на кнопке берётся по id из ответа zoneinfo, как и для тарифов на саммари.
С бэкенда приходит только id тарифа (uberkids), заголовок для кнопки и политика показа кнопки
(клиенты хранят счётчики показов/взаимодействий по id пришедшим, в show_policy).



## Реализация на клиентах

### Клиентский флоу саджеста

<p float="left">
  <img src="https://jing.yandex-team.ru/files/vasiukevich/screen_1.png" width="200" />
  <img src="https://jing.yandex-team.ru/files/vasiukevich/screen_2.png" width="200" /> 
  <img src="https://jing.yandex-team.ru/files/vasiukevich/screen_3.png" width="200" />
  <img src="https://jing.yandex-team.ru/files/vasiukevich/screen_4.png" width="200" />
</p>

1. После открытия приложения вызывается `finalsuggest`,
из ответа которого заполняется дефолтное значение для точки А (скриншот 1);
2. Подсказки для точки Б берутся из `zerosuggest` (скриншот 2);
3. Если пользователь вводит текст, то вызывается `suggest` для точек Б или А (скриншоты 3 и 4);
4. После того, как выбраны обе точки делается возврат на саммари.

### Требования к реализации на клиентах

1. Если у клиента уже выбран тариф детский, то показывать рекомендации не нужно (обязательно);
2. Если в начальном предсказании точки А (скриншот 1) пришла рекомендация детского тарифа,
то надо отобразить эту рекомендацию, когда пользователь будет потом выбирать точку Б (или А) (обсуждаемо).

### Возможные реализации на клиентах

#### Вариант 1

1. Клиент всегда отображает кнопку, когда она приходит с бэкенда.

`+` просто  
`-` не получится скрывать кнопку после тапа;  
`-` не получится скрывать кнопку при уже выбранном детском тарифе;  
`-` не получится отобразить кнопку, если она пришла в начальном `finalsuggest` для точки А

#### Вариант 2

1. Клиент не отображет кнопку, если пользователем уже выбран детский тариф;
2. клиент сохраняет информацию о тапе и о поездке на детском;
3. клиент сохраняет информацию о предложенном тарифе из `finalsuggest` для точки А 
и отображает кнопку с рекомендацией в suggest/zerosuggest, даже если она не пришла с бэкенда.

`+` получится скрывать кнопку после тапа;  
`+` получится скрывать кнопку при уже выбранном детском тарифе;  
`+` получится отобразить кнопку, если она пришла в начальном `finalsuggest` для точки А;  
`-` сложная логика отображения кнопки на клиентах
(надо забывать сохранённую информацию о рекомендованном тарифе, если клиент изменил точку А;
надо прокидывать информацию в ответы ручек zerosuggest/suggest).

#### Вариант 3

Аналогично решению 2, только П.3 изменён: 
клиент сохраняет у себя id рекомендованного тарифа `finalsuggest` для точки А 
и при запросе zerosuggest/suggest для точки Б передаёт id на бэкенд в необязательном
параметре `suggested_tariff_id`.
Бекенд при наличии такого параметра в запросе всегда вернёт рекомендацию этого тарифа
в ответе (в первом предложенном объекте).

Решение обладает всеми плюсами и минусами решения 2, и ещё одним минусом:  
`-` дополнительно усложняется реализация на бэкенде, хотя реализация на клиенте не упрощается

### Итоговое решение на клиентах

1. Клиент не отображет кнопку, если пользователем уже выбран детский тариф;
2. Клиент сохраняет счётчики показов кнопки и тапов по кнопке (для `id`, пришедшего в `show_policy`);
3. Если рекомендация пришла в `finalsuggest` при выборе точки назначения пином на карте,
   то рекомендация не учитывается и кнопка не отображается.
   В частности, если пришла рекомендация на начальную позицию пользователя (скриншот 1),
   то она никак не обрабатывается.

`+` получится скрывать кнопку после тапа;  
`+` получится скрывать кнопку после нескольких просмотров;  
`+` получится скрывать кнопку при уже выбранном детском тарифе;  
`+` естественная логика отображения кнопки на клиентах 
    (кнопка отображается если (она пришла с бэкенда)
    И (пользователем не выбран рекомендуемый тариф)
    И (счётчкики показов/тапов не превысили максимальные значения переданные в `show_policy`));  
`-` не получится отобразить кнопку, если она пришла в начальном `finalsuggest` для точки А;  
`-` рекомендация не отобразится при выборе точки А/Б через пин на карте.  


## Реализация на бэкенде

На бекенде заводится эксперимент `suggested_tariffs_settings` который
включает и отключает функционал отдачи рекомендаций по тарифам,
задаёт `button_title` и параметры показа `show_policy`.
 
Также заводится конфиг suggested_tariff_matching_rules который 
задаёт параметры матчинга рекомендаций тарифов для объектов 
(сейчас тариф будет uberkids, но в будущем возможно добавить другие).

Для получения информации по координатам и тексту от пользователя
ручки persuggest ходят в клиент карт,
откуда получает список рекомендуемых объектов и их свойства.

#### Пример запроса:
```(bash)
curl --location --request GET 'https://suggest-maps.yandex.ru/suggest-geo?callback=json_cb&_=1291031713190&ll=37.588628%2C55.734046&spn=1.234589%2C1.070104&part=%D0%B4%D0%B5%D1%82&search_type=taxi&v=9'
```

#### Пример ответа:
```(json)
{
  "part": "дет",
  ...
  "results": [
    {
      "type": "business",
      "search_query": "{\"text\":\"Центральный Детский магазин\",\"what\":[{\"text\":\"Центральный Детский магазин\",\"attr_name\":\"organization_id\",\"attr_values\":[\"74657555402\"]}]}",
      "lang": "rus",
      "title": {
        "text": "Центральный Детский магазин",
      },
      "subtitle": {
        "text": "Торговый центр · Тверской район, Театральный проезд, 5с1",
      },
      "text": "Центральный Детский магазин",
      "tags": [
        "malls"
      ],
      ...
    },
    ...
  ]
}
```

В качестве начального решения по рекомендациям детского тарифа,
разумно строить рекомендацию по наличию ключевых слов в названии огранизации (`детск.*`),
типу организации и по наличию тэгов (например, "baby shop" или "medicine").
Таким способом будет включена рекомендация для детских больниц, магазинов и т п.

NB. Исходя из реализации на клиентах можно не модифицировать ответ `finalsuggest`,
так как рекомендация оттуда не будет использоваться на клиентах.

### Аналитика по распределению поездок в зависимости от типа организации

TODO


### Рекомендация самого частотного тарифа по конкретному адресу

TODO



## Проведение экспериментов

Предлагается сравнить 2 стратегии показа рекомендации в саджесте: 
1. **outdated:** ~~показываем до тех случаев пока не тапнули, или не сделали заказ по детскому тарифу;~~  
   **actual:** показываем с ограничениями на число тапов/число просмотров кнопки;
2. всегда показываем рекомендацию по тарифу детский, если адрес подходит для этого.

Для реализации таких экспериментов предлагается использовать эксперимент 
`suggested_tariffs_settings`.

Пример значения эксперимента enable_suggested_tariff (для стратегии показа 1): 
```json
{
  "suggested_tariffs": [
    {
      "enabled": true,
      "show_policy": {
        "id": "uberkids_suggest_button",
        "max_show_count": 5,
        "max_widget_usage_count": 1
      },
      "tariff_class": "uberkids",
      "button_title_key": "persuggest.uberkids_suggest_button_title"
    }
  ]
}
```

Для стратегии показа 2 значение будет следующим:
```json
{
  "suggested_tariffs": [
    {
      "enabled": true,
      "show_policy": {
        "id": "uberkids_suggest_button"
      },
      "tariff_class": "uberkids",
      "button_title_key": "persuggest.uberkids_suggest_button_title"
    }
  ]
}
```

Поле `enabled` включает отдачу рекомендаций по тарифу с данным `tariff_class`.
Значение из поля `show_policy` без изменений отдаётся на клиенты в ответе ручки, и обрабатывается там.

Схема эксперимента:
```yaml
name: suggested_tariffs_settings
type: experiment
value:
    schema:
        type: object
        additionalProperties: false
        description: |
            | Эксперимент управляет активацией и показом рекомендаций тарифов в саджесте
        required:
            - suggested_tariffs
        properties:
            suggested_tariffs:
                type: array
                description: Список тарифов для рекомендации
                items:
                    $ref: '#/definitions/SuggestedTariffSettings'
        
        definitions:
            ShowPolicy:
                type: object
                additionalProperties: false
                description: |
                    Информация о политике показа элемента интерфейса: количество показов, количество переходов и т.д.
                required:
                    - id
                properties:
                    id:
                        type: string
                        description: ID сохраняемого на клиентах счётчика показов/нажатий
                        example: "uberkids_suggest_button"
                    max_show_count:
                        type: integer
                        minimum: 0
                        description: |
                            | Максимальное число показов объекта, после достижения значения объект скрывается.
                            | Отсутствие значения означает отсутствие ограничений на число показов.
                        example: 5
                    max_widget_usage_count:
                        type: integer
                        minimum: 0
                        description: |
                            | Максимальное число взаимодействий (тапов), после достижения значения объект скрывается.
                            | Отсутствие значения означает отсутствие ограничений на число взаимодействий.
                        example: 1

            SuggestedTariffSettings:
                type: object
                additionalProperties: false
                description: |
                    | Настройки рекомендации конкретного тарифа
                required:
                    - tariff_class
                    - enabled
                    - button_title_key
                    - show_policy
                properties:
                    tariff_class:
                        type: string
                        description: рекомендуемый класс поездки
                        example: "uberkids"
                    enabled:
                        type: boolean
                        description: включена ли рекомендация по тарифу
                        example: true
                    button_title_key:
                        type: string
                        description: Ключ строки рекомендации тарифа
                        example: "Выбрать тариф $TARIFF$"
                    show_policy:
                        description: Политика отображения рекомендации, отдаваемая на клиенты
                        $ref: '#/definitions/ShowPolicy'

```
