# Отображение времени окончания предложения по скидке на саммари

Рабочее название: "Убегающие" скидки / runaway_discounts

## Что нужно:
1. Общее время жизни скидки (для отрисовки прогрес бара)
2. Точное время окончания действия скидки (вычислим текущее состояние прогресс бара)
3. Список тарифов, для которых работает данная скидка

![](https://jing.yandex-team.ru/files/ulturgashev/runaway_discounts.jpg)


## Вариант реализации на основе случайных скидок

Имеется [реализация случайных скидок](https://github.yandex-team.ru/taxi/rfc/blob/6f27d808ee7eb9a02fec30ab8dfea415c0463e7c/discount-notifications/random_discounts.md).

### В ответ ручки roll и status добавим поля:
```(json)
{
    "show_runaway_discount": true|false,
    "expire_at": "2016-02-07T19:45:00.922+00:00", // optional
    "discount_ttl_min": 6 // время жизни промокода в минутах, optional
    "supported_classes": ["econom"] // optional
    
    "button_info": {
        "title_message": "Заказать со скидкой 10%",
        "description_message": "Истекает через $TIMER$"
        "background_color": "#00CA50",
        "clip_color": "#00CA50"
    }
}
```

### Передаём информаци о времени жизни промокода для отрисовки банера

`expire_at` - время истечения промокода
`discount_ttl_min` - период жизни промокода в минутах

### Для того чтобы передать на клиент информацию о тарифах, для которых может примениться данная скидка:

Добавляем в ручку `/roll` и `/status` список поддерживаемых тарифов данной скидкой в поле `supported_classes`

Если поля нет в ответе, значит скидка действует для всех классов, иначе, только на классы из списка

### Включение логики может осуществлятся, различными механизмами, обсуждаемо:

Управление через ручки `/roll` и `/status` c добавлением в ответ поля `show_runaway_discout` - позволит в одном эксперименте на бэке(или их можно будет помержить по тэгу), управлять поведением клиента.

### Текст для кнопки заказа

Вся информаци о текстах на кнопке, будет приходить в `button_info`.

### Плюсы:
+ Изолируем всю логику с рандомными скидками в одном месте, не меняю логики других сервисов
+ Используем защиты от фрода сервиса рандомных скидок (привязки промокодов к phone_id + yandex_uid)

### Минусы:
- Мы очень сильно интегрируемся со случайными скидками

## Клиентская логика:

1. На клиентах, при `show_runaway_discout = true` показываем на саммари убегающие скидки
2. Для того чтобы рисовать таймер, обязательно нужно использовать серверное время, которое получает клиент из ответа `launch`

## Корнер кейс
В случае получения скидки, затем, выгрузки приложения, нужно будет передёргивать ручку статуса.
Если же ручка не отвечает, тогда пользователь не увидит продолжение таймера.
Решили что пока будем жить с таким поведением, и будем собирать аналитику(тут вопрос как?) по таких кейсам.
