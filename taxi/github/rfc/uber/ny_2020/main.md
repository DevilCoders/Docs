# Новый год в убере 2021

## flow
1. заказывает машину
2. выплывает карточка апгрейда тарифа, говорящая что приедет другая машина на заказ
3. пользователь соглашается (готово), далее может отменить если хочет обычную машину, или стандартный сценарий исполнения заказа.

+ на карточке поездки появляется кнопка для открытия новогоднего банера, который зависит от наличия апгрейда на новодний автомобиль(?)

[дизайн](https://www.figma.com/file/zINKRa9tkvlnmyAtLWlTD5/%D0%9D%D0%BE%D0%B2%D1%8B%D0%B9-%D0%B3%D0%BE%D0%B4)

## условия

1. тарифа с данными машинами на селекторе тарифов не будет, только через апгерйд.
2. если произошла отмена, то нужно не давать пользователю данную машину при заказе второй раз.
3. отмена машины для пользователя бесплатная.
4. возможность завести все культовые машины на один тариф, но менять картинки в зависимости от того, какая машина приехала пользователю. Пока не непонятно, будет одна машина на город, или в одном городе несколько разных машин
5. подумать о возможности ограничение кол-ва заказ с такими машинами на одного пользователя 

## Проблемы которые нужно решить

1. Как матчить новогодние машины - Самый просто вариант, будет матчинг по номеру машины(plate).
2. Проблемы с повторным назначением машины на заказ - в процессе выяснения

## Варианты реализации

- решение проблемы с повторным назначением только что отменённой машины https://tariff-editor.taxi.yandex-team.ru/dev/configs/edit/DRIVER_EXCLUSION_TIME

### 1. Доработка в totw поля повышеного класса

1. Реализовываем логику подмены картинки и текстов на основе эксперимента ниже в order-parts
2. После получения заказа в totw делаем запрос в нашу ручку(с кэшированием в api-proxy)
3. Запуск только для убера
4. Выносим в отдельный сервис (order-parts) код связаный с выдачей повышеных классов (возможно что-то ещё придётся перенести в данный парт, но позже)

api

```json
{
    "higher_class_dialog": {
        "image": "class_business_car",
        "title": "Заголовок поздравления",
        "text": "Вы поедете по тарифу «Эконом» на машине из «Комфорта»",
        "class_after_upgrade": "business",
        "show_tariff_info": true // новое поле, показывающее, нужно ли показывать кнопку "подробнее" на карточке апгрейда
    }
}
```

experiment:

```json
{
    "rules": [
        {
            "banner": "ac3ea3f3b6e14ca2826192305a3d6102",
            "image": "image_id",
            "title": "weqweqwe",
            "text": "qweqweqweqwe",
            "plate_numbers": [
                "B222WXW",
                "B111WXW"
            ]
        }
    ]
}
```

Минусы:
- Выглядит так что `higher_class_dialog` - не совсем отражает логику которая в этом поле подразумевается и мы эксплуатируем особенности реализации данного поля. Как будто, оно должно называться `found_car_promotion`. И содержать в себе ещё и id фулсрина для того чтобы можно было промоутить машины раными способами.

#### Банер

1. Попробовать использовать сторизы вместо банера
   + На клиентах уже имеется реализация сторизов
   - Нужна будет кастомная логика для сторизов на бэке
2. Добавим в тело ответа totw новое поле

```json
{
    "banner": {
        "content": {
            "title": "xxx",
            "details": "yyy",
            "image": "image_tag" // optional
        },
        "styles": {
            "background_color": "#FFC5CC",
            "title_text_color": "#21201F",
            "details_text_color": "#A68387"
        },
        "action": {
            "media": {
                "promo_id": "ac3ea3f3b6e14ca2826192305a3d6103"
            }
        }
    }
}
```

- Нужны дефолтные цвета
- Конкурирует со сторизами в поездке, нужен продуктовый ок, что в убере будет данный способ промотирования
- Появляется ещё один, специализированый для убера, способ промотирования в поездке

### 2. Клиентский эксперимент в totw

Берём за основу эксперимент https://tariff-editor.taxi.yandex-team.ru/experiments3/experiments/edit/plus_kinopoisk

```json
{
    "default_banner": "ac3ea3f3b6e14ca2826192305a3d6101",
    "rules": [
        {
            "banner_ids": {
                "promo": "ac3ea3f3b6e14ca2826192305a3d6102",
                "congrac": "ac3ea3f3b6e14ca2826192305a3d6103"
            },
            "plate_numbers": [
                "B222WXW",
                "B111WXW"
            ]
        }
    ]
}
```

### 3. Клиенсткий эксперимент в totw (матчинг на бэкенде) - winner

Название: `ny2021_cars_promotion`

```json
{
    "banner": { // optional
        "content": {
            "title": "xxx",
            "details": "yyy", // optional ?
            "image": "image_tag" // optional
        },
        "styles": { // optional (нужно уточнить дефолт у дизайна)
            "background_color": "#FFC5CC",
            "title_text_color": "#21201F",
            "details_text_color": "#A68387"
        },
        "action": {
            "deeplink": "yandextaxi://banner?id=3d68b39dfb044e86af8e5328eb3fae3a"
        }
    },
    "congratulation_deeplink": "yandextaxi://banner?id=3d68b39dfb044e86af8e5328eb3fae3d", // optional
    "l10n": [
        {
            "key": "xxx",
            "tanker": {
                "key": "title.key",
                "keyset": "client_messages"
            },
            "default": "Еда"
        },
        {
            "key": "yyy",
            "tanker": {
                "key": "details.key",
                "keyset": "client_messages"
            },
            "default": "app_super_splash_eats_ru"
        }
    ]
}
```

Логика работы:
- Если пришёл `congratulation_deeplink` - показываем фулскрин с поздравлением о приезде новогодней машины,
- Если пришёл `banner` - на карточке поездки, нужно отобразить банер
- Поле `congratulation_deeplink` должно придти одновременно с назначением водителя, и должно быть показано 1 раз за поездку
- Поле `banner` - может придти и на поиске, но контент может поменяеться после того как водитель найдётся(кажется не критично, так как мы не видим карточку во время поиска)
- Наличие `banner` в ответе напрямую влияет на его отображение на клиентах(перестал приходить во время поездки - убирается с карточки)

Доработки на бэкенде:
- Добавить новый кварг `plates` в totw (1-3d)
