# Запуск экспериментов на новичков и низкочастотных пользователей

##  Кого мы можем считать новичками?

-  Пользователи совершившие N заказов в сервисе, где N - зависит от фичи
-  По дате регистрации

## Кого мы можем считать низкочастотными пользователями?

- Пользователи, совершившие N поездок за последние M дней, где N << M + пользователи K дней не совершали поездку

Все коэффициенты очень индивидуальны, каждый может подобрать под свою задачу

## Как эту задачу решали?

Имеется [проработка](https://github.yandex-team.ru/taxi/rfc/pull/584) и [реализация](https://github.yandex-team.ru/taxi/uservices/pull/18753/files) Андрея.

## Источники данных

1. Получить число заказов по YandexUID/PhoneId/DeviceId/CardPersistentId из `user-statistics` счётчиков.
В таком случае мы получим число заказов в зависимости от выбранного нами идентификатора.
Из особенностей: получить дату регистрации - мы не сможем, но вместо неё можно использовать дату первого заказа.

2. Получить число заказов по PhoneID из `user-api`.
В таком случае мы получим все заказы пользователя с данного телефона,
но возможно упустим заказы с его прежних номеров.

3. Аналитический расчёт и загрузка "старичков" в сервис тэгов

## Варианты реализации

### Использования `user-statistics`

1. Реализуем библиотеку для получения данных из источника и их преобразования для использования в качестве кваргов эксперимента
2. Внедряем данную библиотеку в routestats и др сервисы

Преимущества:
- Получаем актуальные данные пользователя
- Можем получать количество заказов сделанных пользователем в определённом интервале времени
- Можем получать заказы пользователя с разбиением по тарифам

Сложности:
- Нужно будет переписать логику формирования данных в routestats, так как сейчас формирование экспериментов происходит до вызовов остальных сервисов

Минусы:
- Нет информации о регистрации пользователя

### Использование `user-api`

Этапы внедрения практически не отличаются от предыдущего варианта

Преимущества:
- Получаем дату регистрации

Минусы:
- Вероятно, получение статистики из данного источника будет задепрекейчено
- Нет возможности явно определить низкочастотных пользователей

### Использование сервиса тегов

1. Формируем yql скрипт для определения "старых" / "новых" пользователей для сервиса тегов
2. Получаем тэги по пользователю там где они нужны
3. Используем их как кварги экспериментов или по своему усмотрению

Преимущества:
- Мы отдаём на откуп аналитикам логику по определению новичков

Проблемы:
- Логика определения новичка одинакова для всех фичей, либо увеличивать количество тэгов
- Независимо от того, размечаем мы старых или новых, мы получаем проблему устаревания данных в кэше
- Если размечаем "старых" пользователей, тогда новый пользователь сможет получать бенефиты несколько раз
- Если размечаем "новых" пользователей, тогда новый пользователь(который был создан после тегирования), не получит бенефитов, до следующего перетеггирования
- Если используем логику "старых" пользователей для Go, 80кк пользователей(возможно уже больше) не влезут скорее всего в кэш.

### Добавление флага новичка в PA

Данный вариант, решает проблемы сразу во всех ручках, но это требует сформированного понимания сущности новичка, либо передачи статистики в заголовках в конечные эндпоинты в чистом виде. 
Статистику в чистом виде передавать - сложно/странно/неудобно, и кто такой новичок - все отвечают по разному.
Поэтому, стоит выработать общее понимание по этому вопросу, чтобы внедрять глобально данный признак.

## Итог

- Выглядит всё так, что запрос за тэгами/статистикой придётся делать в любой реализации, но в случае с тэгами, мы ещё получаем проблему актуальности данных
- По причине того что `user-statistics` сейчас является сервисом в котором хранится актуальная информация о статистике заказов пользователя + есть возможность определить низкочастотных пользоваталей, склоняюсь к использованию данного источника

## Реализация на базе сервиса `user-statistics`

Для обобщения работы с сервисом статистики будет написана маленькая библиотека/компонент предоставляющая доступ к статистике пользователя.

На данный момент, в сервисе, имеются две ручки `/v1/orders` и `/v1/recent-orders`.

`/v1/orders` - возвращает полную статистику пользователя по заданному идентификатору(или комбинации идентификаторов), с возможностью группировки и фильтрации по различным параметрам(метод оплаты/тариф/бренд).

`/v1/recent-orders` - возвращает статистику пользователя по заданному идентификатору(или комбинации идентификаторов) и в пределах указаного интервала времени с возможностью группировки и верификации как и в ручке `/v1/orders`. В ручке есть ограничение, что подробная статистика хранится всего за последние 32 дня.

В идеале, для общего решения, хотелось бы иметь батчовый интерфейс, чтобы можно было запросить кастомную статистику для разных функциональностей (например, в `routestats`, модификаторам нужно знать количество заказов за последний месяц, а для брендинга грузового нужно знать количество заказов за последнюю неделю именно для тарифа грузовой)

### Что предлагается:

На текущем этапе, предлагаю сделать интерфейс для запроса одного вида статистики(один запрос в сервис).
В `routestats`, при желании реализовать получение статистики для разных сценариев, на текущем этапе, можно предложить использовать эксперимент/конфиг 3.0, для параметризации вызова.

Также в `routestats` придётся научиться, ходить в сервис статистики одновременно с запросом в протокол(только full routestats) и перенести логику формирования контекста(как минимум экспериментов), после получения ответа от протокола.

#### Notes
- Тайминги сервиса статистики: 30мс в 99prc (смотрел по клиенту сервиса купонов)
- Статистика пользователя, является необязательной информацией для работы ручек

#### Future

По мере использования данного функционала, и понимания что есть необходимость с одновременно нескольких сценариях, будут выполняться доработки по реализации по батчовой ручки статистики и доработка библиотеки

## Логика определения новичка-низкочастотника аналитиками

- Есть информация, что новичек-низкочастотник определяется как пользователь который не делал заказов за последний месяц
