## Ссылка на доставку

Необходимо реализовать возможность делиться ссылкой на доставку между пользователями бизнес аккаунтов (БА) и их клиентами. 
Ссылка должна быть привязана к конкретному заказу и должна быть возможность отслеживания статуса заказа по этой ссылке. 

На первом этапе решили делать флоу только через клиентские мобильные приложения. В дальнейшейм будет веб версия.


## Cценарии

Сейчас я вижу следующие сценарии, каждый из которых дальше опишу отдельно:

1. Пользователь БА создаёт заказ и делится ссылкой на его доставку
2. Клиент получает ссылку, открывает её в приложении такси, указывает точку Б и заказывает доставку
3. Производится доставка: пользователь БА и получатель доставки это видят 
4. Заказ завершён: отчётность у пользователя БА и получателя доставки


## Варианты реализации
1. Вся информация о привязке БА-заказа к такси заказу хранится в shared_payments и мы ходим в этот сервис в тех местах, где необходимо понять привязку (`/launch`, `/taxiontheway`).
2. Добавляем поле привязки `business_account_id` в request в db.orders. Поход в shared_payments будет только для заказов с этим полем (добавление поля согласовано с @vitja).

Вариант 2 выглядит более удачным, потому что он не увеличивает тайминги критических ручек. Дальше буду описывать его.


## Ограничения
1. Оплачивать заказ может только клиент БА, а не сам пользователь БА.
Описание решения с оплатой через аккаунт сделано в отдельном пункте.
2. Пока никак не прорабатывалась фича сокрытия точки А для получателя. 
В первой реализации решили отказаться от этого.


### Вопросы, которые вынесены за рамки этой проработки
1. "Закончился товар": курьер приехал, но товар кончился или дверь закрыта или ещё какие то проблемы у владельца магазина? Что делать? Надо штрафовать владельца БА аккаунта? У получателя не должно быть списания?
> @jvkazachenko: даже не уверена что это вообще нужно.
Решили пока закрывать эти проблеммы саппортом.


### Сценарий 1: Формирование заказа и ссылки
Клиент должен в интерфейсе БА создать заказ и получить возможность его расшарить. 

БА данные о заказе (дальше будут называться БА-данные):
- Аккаунт БА автора заказа
- Название заказа (указывает владелец БА)
- Точка А (откуда отправляем)
- Кто оплатит: получатель (recipient) или владелец БА (owner)
- Тариф, по которому будет доставка (express или delivery)

Предлагается для работы с этим набором данных сделать новый хэндлер в `shared_payments/4.0/coop_account/order`, как в наиболее близком по смыслу сервисе.
В случае недоступности сервиса не будет возможности сделать заказ по переданной ссылке. Фоллбэка не предусмотрено.

В UI будет отдельный view, в котором будет отображаться список БА заказов со статусами. 

[Примерно так:](#orders-list)
- Заказ 4343, Статус: создан, Действителен до: 23:59:59 31.08.2020 [Поделиться ссылкой] [Отменить заказ]
- Заказ 4344, Статус: создан, Истёк: 23:59:59 31.08.2020 [Отменить заказ]
- Заказ 1111, Статус: доставка [Отменить заказ]

Завершённые заказы будут попадать в историю поездок вместе с остальными заказами.
Редактировать заказы нельзя, можно только отменять и пересоздавать. 

Каждый из заказов - это строка в таблице orders. У каждого заказа есть статус (создан, доставка, доставлен) и возможность поделиться ссылкой на этот заказ.


У пользователя БА:
- При открытии списка БА заказов будет делаться запрос в `GET shared_payments/4.0/coop_account/order/active` для отображения текущего списка активных заказов со статусами.


### Нагрузка
Нагрузка будет напрямую зависеть от количества БА заказов, сделанных через ссылку на доставку. 
Сейчас количество таких заказов не известно. Допустим, их будет 100k в сутки, это примерно 1 заказ каждую секунду.

Нагрузка на ручки протокола не изменится, изменения будут только в shared-payments.
При создании и подтверждении заказа на каждый заказ будет делаться 2-5 запроса на запись/чтение/подтверждение (в случае оплаты владельцем БА).

При трекинге заказа нагрузки на shared-payments не будет. Сценариями с просмотром истории поездок и списка БА заказов предлагаю принебречь, они достаточно редкие и не будут давать особой нагрузки.

Итого: при оценке 100к заказов в сутки нагрузка на shared-payments увеличится на 5rps.


#### Формат ссылки 
Сейчас, когда есть возможность работы только через приложение, то формат будет ввиде диплинка: 
`yandextaxi://delivery?id=order-906bf0d132fde176696f8b2514d53f61`. 
Id - это рандомный UUID4. Предполагается, что вероятность совпадения ключа слишком низкая, чтобы волноваться о возможности его подбора.

Позже при появлении других клиентов (web) нужно будет его менять и делать какой то механизм редиректа (через adjust?), поэтому формат ссылки должен быть кастомизируем через конфиг.


#### Время жизни ссылки и действительность заказа
При создании ссылки указывается время её жизни. Значение должно браться из конфига.
После того, как время жизни вышло обращение к `GET shared_payments/4.0/coop_account/order?order_id={order_id}` должно возвращать код `410 Gone`. Клиенты дальше могут интерпретировать это как то, что ссылка больше недействительна. В списке заказов будет указываться, что ссылка больше не действительна.
При этом заказы, которые истекли удаляться не будут. Возможно нужно будет в будущем продумать механизм очистки таких заказов.


### Отмена заказа
В случае отмены важно разделять два заказа: 
1) Заказ БА аккаунта, который хранится в shared_payments
2) Такси заказ на доставку

Возможность отменить заказа БА аккаунта (1) должна быть только у владельца БА аккаунта при клике на "Отменить заказ". Возможность отменить сам такси заказ (2) на доставку может быть только у того, кто его сделал.

Отмену заказа у БА можно сделать в БА-аккаунте нажав на кнопку [Отменить заказ] в списке заказов.
В этом случае будет сделан запрос `DELETE shared_payments/4.0/coop_account/order` в котором:
1) Проверяем статус отменяемого такси заказа и если он в процессе доставки и сделан владельцем БА аккаунта, то отменяем его, иначе не делаем ничего
2) В таблице `orders` в `shared_payments` проставляется поле `deleted_at` текущей датой и в будущем клиент должен получать `404 Not Found` на этот заказ.

Отмена начатого заказа у клиента: 
1) Клиент нажимает Cancel, у такси заказа делается статус "cancelled"
2) Статус отображается в списке заказов у БА


#### Описание API для работы с заказами в сервисе shared_payments
#### POST shared_payments/4.0/coop_account/order
Метод сохраняет первичную информацию о заказе. В ответ прийдёт ссылка, по которой можно будет ввести точку Б и остальные данные о заказе.

Пример запроса:
```json
{
  "account_id": "business-454397acd5734593af6ce8de4adb3f18",
  "name": "Заказ 3456, букет 'Дочки-пирожочки'",
  "from": [30.323673805301326, 60.079573645750706],
  "payment_method": "recipient",
  "tariff": "express"
}
```

Пример ответа:
```json
{
  "id": "order-906bf0d132fde176696f8b2514d53f61",
  "link": "yandextaxi://delivery?id=order-906bf0d132fde176696f8b2514d53f61",
  "account_id": "business-454397acd5734593af6ce8de4adb3f18",
  "name": "букет 'Дочки-пирожочки'",
  "from": [30.323673805301326, 60.079573645750706],
  "payment_method": "recipient",  
  "tariff": "express",            
}
```

Заказы будут храниться в отдельной таблице orders.
```sql
CREATE TABLE orders (
    id               TEXT PRIMARY KEY,
    account_id       TEXT NOT NULL UNIQUE,      --- coop account id
    taxi_order_id    UUID UNIQUE,               --- id заказа поездки

    name            TEXT NOT NULL,
    from            POINT[],         --- точка А
    payment_method  TEXT NOT NULL,   --- recipient - платит получатель, owner - платит владелец БА
    tariff          TEXT,            --- опциональное, заполняется только в случае если платит owner

    idempotency_token TEXT,
    
    created_at  TIMESTAMPTZ NOT NULL,
    deleted_at  TIMESTAMPTZ,         --- если это поле не NULL, то заказ был удалён и на клиенте не отображается
    valid_until TIMESTAMPTZ          --- до какой даты\времени действительна ссылка и заказ. если NULL, то бессрочный
);

```

Для контроля за идемпотентностью запросов будет необходимо со стороны клиента передавать хедер `X-Idempotency-Token`. 

#### GET shared_payments/4.0/coop_account/order/active
Получить список всех активных (созданные, в процессе доставки, не удалённые, не завершённые) заказов по БА.

Пример запроса:
```
/order/list?account_id=business-454397acd5734593af6ce8de4adb3f18
```
Ответ:
```json
{
  "orders": [ 
    {
      "id": "order-906bf0d132fde176696f8b2514d53f61",
      "link": "yandextaxi://delivery?id=order-906bf0d132fde176696f8b2514d53f61",
      "account_id": "business-454397acd5734593af6ce8de4adb3f18",
      "name": "букет 'Дочки-пирожочки'",
      "from": [30.323673805301326, 60.079573645750706],
      "payer": "recipient",
      "tariff": "express",
      "valid_until": 1570107730, # Если поля нет, то заказ бессрочный
      "state": "created"
    },
    {
      "id": "order-906bf0d132fde176696f8b2514d53f61",
      "link": "yandextaxi://delivery?id=order-906bf0d132fde176696f8b2514d53f61",
      "account_id": "business-454397acd5734593af6ce8de4adb3f18",
      "name": "букет 'Дочки-пирожочки'",
      "from": [30.323673805301326, 60.079573645750706],
      "payer": "owner",
      "tariff": "express",
      "valid_until": 1570107731, 
      "state": "transporting"
    } 
  ]
}
```

#### GET shared_payments/4.0/coop_account/order
Возвращает данные заказа.

Возможные параметры:
`order_id` - id БА заказа
`taxi_order_id` - id такси заказа

Передать можно любой и по нему будет выбран заказ.

Запрос:
```
/order?order_id=order-906bf0d132fde176696f8b2514d53f61
```

Ответ:
```json
{
  "account_id": "business-454397acd5734593af6ce8de4adb3f18",
  "order_id": "order-906bf0d132fde176696f8b2514d53f61",
  "taxi_order_id": "806bf0d132fde176696f8b2514d53f61",
  "name": "букет 'Дочки-пирожочки'",
  "from": [30.323673805301326, 60.079573645750706],
  "payment_method": "recipient",
  "tariff": "express",
  "status": "transporting"
}
```

Запрос:
```
/order?taxi_order_id=806bf0d132fde176696f8b2514d53f61
```

Ответ:
```json
{
  "account_id": "business-454397acd5734593af6ce8de4adb3f18",
  "order_id": "order-906bf0d132fde176696f8b2514d53f61",
  "name": "букет 'Дочки-пирожочки'",
  "taxi_order_id": "806bf0d132fde176696f8b2514d53f61",
  "from": [30.323673805301326, 60.079573645750706],
  "payment_method": "recipient",
  "tariff": "express",
  "status": "transporting"
}
```

Статус заказа определяется так:
- Когда заказ только создан статус выставляется в "created"
- Дальше статус берётся из статуса заказа из сервиса order-core: `POST /v1/tc/order-info`, поле `status`

Если заказ не найден, то необходимо вернуть `404 Not Found`.

#### DELETE shared_payments/4.0/coop_account/order
Помечает заказ как удалённый. В базе он при этом остаётся.

Запрос:
```
/order?order_id=order-906bf0d132fde176696f8b2514d53f61
```

Ответ:
```json
{
  "account_id": "business-454397acd5734593af6ce8de4adb3f18",
  "name": "букет 'Дочки-пирожочки'",
  "from": [30.323673805301326, 60.079573645750706],
  "payment_method": "recipient",
  "tariff": "express",
  "status": "transporting"
}
```


### Сценарий 2: Заказ доставки на клиенте
В этом сценарии клиент делает следующие действия:
1. По открытию диплинка делает запрос `GET shared_payments/4.0/coop_account/order?order_id={order_id}`, который по id выдаёт инфо о заказе:
  - Проверяется валидна ли ссылка, не истекло ли время её жизни
  - Если заказа уже доставляется, то надо его открыть
  - Если заказ уже доставлен, то надо открыть какую то заглушку или открыть сам заказ в приложении
3. Делает запрос в `/routestats` с указанными данными по тарифу, from и to и отображает цену на кнопке
3.1 Надо ли ещё раз проверить, что ссылка не истекла? Форма может быть открыта долго.
4. Заказ делается по стандартному флоу `orderdraft`/`oredrcommit`

TODO: Где то здесь надо передать сокрытие точки А в totw

4. Привязка заказа БА к заказу доставки. Есть 3 возможных варианта реализации этого:
  - После того, как будет выполнен ordercommit вызывается `POST shared_payments/4.0/coop_account/order` с:
  ```json
  {
    "order_id": "order-906bf0d132fde176696f8b2514d53f61",
    "taxi_order_id": "d9d208ee8cda15107075219ff7e53c3f"
  }
  ```
  - Альтернативным решением может быть отправлять эту информацию из ordercommit, но у этого решения есть минусы:
    - нагружать логику монолита хождением в сервис, который не имеет отношения к флоу заказа
    плюсы:
    - уменьшает вероятность ошибки, когда клиент не отправил подтверждение о том, что пользователь сделал заказ

  - **Наиболее правильный вариант**: через processing2.0 добавить на событие заказа "created" stq таску с событием, обрабатываемым в сервисе shared-payments, при возникновении которого будет происходить обновление таблицы orders


### Сценарий 3: Производится доставка: пользователь БА и получатель доставки это видят
Принадлежность заказа к бизнес аккаунту будет определяться по тому есть ли в `db.orders.request` поле `business_account_id`. Для этого в `orderdraft` необходимо это поле добавлять в `db.orders.request`.
В `/launch` при запросе заказов из mongo нужно будет добавить дополнительное условие: "Если business_account_id у заказа существует и равен текущему, то выдать этот заказ в ответ".

Для получателя доставки: 
- В `/launch` заказ появляется в общем списке заказов как активный.
- БА-данные (которые необходимо отобразить где то в UI) будут браться отдельным запросом к `GET shared_payments/4.0/coop_account/order` (TODO какие будет ясно позже, когда будут утверждены макеты).

Отображение активного заказа у пользователя БА: 
- Главный экран: заказ должен возвращаться в `/launch` в массиве `orders` как активный.
- Список БА заказов: список активных заказов будет браться из `GET shared_payments/4.0/coop_account/order/active`, там есть все необходимые для отображения поля.
- Отображение трекинга заказа по клику на заказ со статусом "доставляется": в код `/taxiontheway` и `/taxiroute` добавим в проверку на то "наш" ли это заказ условие о том, что если в заказе есть поле `business_account_id`, то этот заказ можно трэкать, а не запрещать, как для других заказов, сделанных с другого аккаунта.


### Сценарий 4: Заказ завершён: отчётность у пользователя БА и получателя доставки
Для получателя доставки и для пользователя БА в истории заказов: 
- Заказ должен перестать возвращаться из `/launch` и `GET shared_payments/4.0/coop_account/order/active`, потому что он больше не "активный".
- Заказ должен попадать в ответ `4.0/orderhistory/v2/list` и отображаться в истории заказов. Для этого нужно будет ходить в `shared_payments/4.0/coop_account/ridehistory_list` за завершёнными заказами и там заказы по ссылке подмешивать к остальным БА заказам. Так же можно ввести отдельный "сервис" в `OrderHistoryListItem` с соответствующим названием `business_account_order`, чтобы добавить возможность фильтровать БА заказы.


Отчёт для пользователя БА: 
- При формировании отчёта по cron или по запросу в `shared_payments/4.0/coop_account/reports`: мы выбираем необходимые заказы по `account_id` и подмешиваем их в отчёт.


### Оплата заказа БА аккаунтом
В решении выше описано как будет работать, если заказ оплачивает получатель доставки. В случае если доставку оплачивает владелец БА аккаунта, то возникают следующие вопросы:

- Можно ли оплатить заказ другого пользователя своим способом оплаты? Вроде есть на это проверка.

Чтобы решить эту проблему можно воспользоваться [предзаказом](https://wiki.yandex-team.ru/taxi/backend/product-team-3/preorder-service/). 
Я пока не представляю как это должно быть визуально решено, так как макетов ещё нет. По идее после устного согласования даты\времени с получателем доставки нужно при создании заказа ввести это в соответствующие поля в форме заказа и будет сделан предзаказ, который владелец БА предоплатит. Получателем у заказа будет получатель доставки.

Нужно прорабатывать: **2d**


- Будет ли прорастать заказ для получателя доставки?

Да, будет прорастать. Чтобы это случилось необходимо сделать заказ на доставку и указать телефон получателя. Для этого необходимо будет:
1) Заменить кнопку "Сделать заказ" на "Подтвердить доставку"
2) После того, как получатель ввёл точку Б и нажал "Подтвердить доставку" сохранять телефон или `phone_id` или `yandex_uid` получателя в `shared_payments` в таблице `orders`
3) Этот телефон передаётся клиенту в форму в БА аккаунте, а он в свою очередь возвращает его в `orderdraft`/`ordercommit` и у этого пользователя появится заказ. Само прорастание делается через processing2.0.


- Получатель доставки выбрал точку Б. Как валидировать стоимость заказа у владельца БА после указания точки Б?

Нужно будет показывать форму заказа с указанной точкой Б и рассчитанной стоимостью у владельца БА аккаунта. Данные о стоимости и точке Б можно сохранять в `shared_payments` в таблицу `orders`. Пользователю БА должна либо приходить нотификация (push?) об этом, либо при следующем обновлении списка заказов он увидит эту стоимость. 

Нужно прорабатывать: **1d**


- Есть понятие: B2С и С2С доставка. Разница в тестовках, в первом случае "магазин вам доставляет", во втором "вам заказана доставка". Какой вариант подходит в нашем случае?

Нужно прорабатывать: **1d**



Грубая оценка по дальнейшей более детальной проработке этого решения: **4d**


### Миграция текущих заказов
TODO: заказы через БА без ссылки доставки: добавить в эту же табличку истории заказов. Сейчас выборка идёт по paymentmethod.
Нужно будет пробатывать это отдельно. Следует помнить об этом при разработке этой задачи.


### Задачи
Примерная разбивка по задачам.
1. Сделать ручки в сервисе shared_payments
  - сделать миграцию бд
  - написать обработчики (order, order/active) и код работы с БД
  - логи
2. Завести stq таску для связки id и обработчик в shared_payments
3. Реализовать логику по работе с business_account_id в /launch, /totw, /taxiroute, /routestats, /orderdraft
4. Добавлять новые заказы по ссылке в общую историю поездок
