**Название сервиса**

Геозоны (geoareas)

**Какую продуктовую проблему решает сервис?**

На продукт напрямую не влияет. Менеджмент геозон: добавление, удаление, модификация. Аудит удалений зон, в будущем мониторинг обращений к зонам.

**Почему нельзя решить эту задачу без разработки нового сервиса существующими решениями?**

До создания сервиса была коллекция `dbtaxi.geoareas`, в которую ходило множество существующих сервисов. По понятным причинам это чревато проблемами:
- сложности с разработкой, легко допустить баг - сервисы ходят через библиотеки в backend-cpp и uservices, их надо вместе поддерживать в актуальном состоянии
- сложности с синхронизацией
- невозможность аудита, нормального контроля изменений
- невозможность правильного мониторинга обращений к зонам
- отсутствие защиты от добавлений некорректных зон, дублей и прочей неконсистентности базы (пример: TAXIDUTY-11099)

**Как именно сервис будет решать поставленные перед ним задачи?**

Сервис будет выступать в роли прокси на пути к базе. Все обращения будут проходить не напрямую к базе, а через сервис geoareas. Так станет проще контроллировать, вставлять дополнительные проверки на корректность зон, консистентность базы и т.д.

**Разрабатывается один сервис или система?**

Один сервис

**С кем взаимодействует сервис?**

Потребители - протоколы, persuggest, админка, discounts, ucommunications, supply-diagnostics, reposition-relocator, pricing-data-preparer.

**Идемпотентность**

Добавление зоны будет идемпотентно (за исключением времени обновления) - при двух
одинаковых запросах в базе окажутся две копии, просто старая сразу станет архивной.

Повторная попытка перенести зону архив - по своей сути noop.

**Консистентность**

MongoDB не позволяет делать полноценные мультидокументные транзакции до 4.0
(до 4.2 on shared clusters).

План таков:
- Если у нас достаточно современная монга и нам подходят транзакции, юзаем их и радуемся
- В ином случае сначала добавляем новую версию геозоны, затем помечаем старую архивной.
  В случае наличия двух не-архивных зон с одним именем считаем более новую за истинную.

**Какие базы использует?**

mongo: dbtaxi.geoareas


**Какие периодические процессы?**

Их нет

**Прикрепите схему того, где этот сервис находится в текущей инфраструктуре**

1. _Как технически проект влияет на цикл заказа_ - если сервис лежит,
   а потребитель не закэшировал зоны, то возможность заказа блокируется
2. _Кто будет потребителями сервиса_ - только другие сервисы

**Какие данные и по какой схеме сервис будет хранить в базе?**

Геозоны. Схема: https://github.yandex-team.ru/taxi/schemas/blob/master/schemas/mongo/geoareas.yaml

Схема, а также место хранения коллекции остаются без изменений.

**Какой объем данных будет храниться и какой объем будет изменяться в единицу времени?**

На данный момент описания 2741 зон в проде.
Вместе с удаленными - 10137.
Общий объем с удаленными - порядка 30Мб json.

Больших изменений единовременных не будет, все делается вручную из админки

**Какие операции над данными заложены?**

- добавление/редактирование зоны (TAXIBACKEND-25620)
- удаление зоны (TAXIBACKEND-25624)
- получение списка зон (TAXIBACKEND-25614)

**Есть ли какой-то стейт в памяти, как он обновляется и валидируется?**

Нет

**Какая нагрузка ожидается?**

Не больше 10 RPS от бэкэндов?

Однако, загрузка всех зон (в админке) - тяжелая операция - по 5 секунд на подгрузку и отправку ответа клиенту

**Какие фолбеки предусмотрены на сам этот сервис?**

Если клиент (протокол и прочие сервисы, ходящие в базу) в какой-то момент времени не может достучаться до сервиса, то он просто использует закэшированное значение

**Какие фолбеки предусмотрены внутри этого сервиса на взаимодействие с другими сервисами?**

Кроме базы взаимодействий нет. На взаимодействие с базой фоллбек вашать смысла нет, т.к. сами клиенты будут заниматься этим, в т.ч. как следствие кеширования

**Какие возможности масштабируемости закладываются?**

Можно легко горизонтально масштабировать вместе с базой - архитектура сервиса максимально проста

**Какие точки отказа есть в сервисе?**

Отказ базы mongo dbtaxi, потеря доступа до базы

**Укажите технические метрики**

- rps
- успешные/неудачные операции с базой
- размер коллекции

**Какая функциональность ожидается в сервисе в будущем?**

Этапы разработки:

- поддержка зон с дырками (TAXIBACKEND-24419)

**Какое изменение нагрузки планируется?**

Нагрузка пропорциональна количеству инстансов протокола и прочих сервисов, которые к нам ходят. При их росте будет расти нагрузка и на нас

**Активно ли будет изменяться сервис?**

На этапе готовности - нет. После непосредственно переноса существующей функциональности
планируется допилить ручку получения данных для админки - добавить фильтрацию по bbox'у например

<hr>

## Архитектура

### Админка

В админке потребуются незначительные изменения для перевода на новый API

### Сервисы

Обращение к геозонам выполняется через две версии библиотеки в uservices (geoareas и zone-geoindex), а также общий код в backend-cpp. Этот код умеет по точке определять геозону.
Библиотеки (или общий код) поддерживают в своем кеше все зоны, используют геохеширование.

Надо перевести все это добро на использование нового сервиса

### Технические ограничения

Чем мы осознанно жертвуем: алертами, отсутствием запаса под xN рост, редкие гонки, отсутутвие необходимого рефакторинга и тп. ВСЕ должно быть четко описано и скоммуницировано менеджеру и ревьюеру архитектуры.

### Как раскатываем

1. Бекэнд
  - выкатываем сервис, переводим на него uservices, backend-cpp тестинга
  - в прод (конфиг?)
2. Админка
  - ждем перехода на новое API со стороны админки
3. Не должно остаться прямых хождений в `dbtaxi.geoareas`
4. Развиваем дальше - впиливаем доп. проверки, реализуем

### Безопасность

Персональных данных нет
