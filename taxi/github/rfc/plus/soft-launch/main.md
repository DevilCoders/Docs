# Soft-launch нового Плюса в Такси

## Обновления
> После этого документа будет полезно почитать [это](./plus-and-country.md)

## Термины

- *Подписка* - синоним **Плюса**.
- *Старая подписка* - текущая версия **Плюса**, по которой мы предоставляем скидку.
- *Новая подписка* - новый **Плюс** (версия `1.5+`), в которой вместо скидки мы предоставляем кэшбек. 
  Подробнее см. проработки [Дани](https://github.yandex-team.ru/taxi/rfc/pull/283) (базовая проработка) и [Руслана](https://github.yandex-team.ru/taxi/rfc/pull/397) (актуальная проработка).
- *Баллы* - синоним **кэшбека**.
- *Маркетинговые баллы* - кэшбек, который можно получить без подписки.

## Продуктовые требования

> Подробнее с концепцией новой подписки и soft-launch можно ознакомиться в [презентации](https://jing.yandex-team.ru/files/erakli00/Wallet%20concept%20-%202020-05-14.pdf).
> Зачем нужен soft-launch - слайд 48.

> Базовые правила также описаны в [вики](https://wiki.yandex-team.ru/users/grukhani/Soft-lonch-koshelka-v-taksi/).

- В зависимости от того, какой принят оффер у пользователя, мы должны поддерживать разное поведение (применять скидку или начислять кэшбек, показывать соответствующий интерфейс).
- Кэшбечные скидки (маркетинговый кэшбек) остаются и не затрагиваются мягким запуском, могут быть начислены всем.
- При покупке плюса после "дня X", пользователю записывается новая версия подписки.
- Тратить баллы можно только при наличии новой подписки.
- Пользователь со старой подпиской должен самостоятельно согласиться с новым оффером. 
  До этого момента для него действуют условия старой подписки (скидки в Такси).

## Анамнез (вводные данные)

На текущий момент по результатам [эпика](https://st.yandex-team.ru/TAXIBACKEND-26985) была частично внедрена поддержка нового Плюса.
Переключение на новый Плюс происходит по эксперименту `cashback_for_plus` (заведён только в тестинге).
Основные потребители данного эксперимента:

- `backend-cpp/protocol`:
  - ручка `/3.0/routestats`
  - функция `orderkit::Commit()`
- `uservices`
  - сервис `pricing-data-preparer` (PDP)

> [Вики](https://wiki.yandex-team.ru/users/rgnlax/Proekt-Podpiska/) по проделанной работе.

Таким образом, дополнив проверку данного эксперимента проверкой версии подписки у пользователя, мы сможем удовлетворить продуктовым требованиям.
Эксперимент имеет смысл оставить, чтобы запускать поддержку новой подписки по странам.

### Признак кэшбечной подписки в Паспорте

Со стороны Паспорта [будет](https://st.yandex-team.ru/PASSP-28275) добавлен новый бинарный атрибут (точное название будет добавлено позже):

```
account.plus_cashback_user
```

Признак принимает следующие значения:

- `false` - пользователь не соглашался с новым оффером
- `true` - пользователь согласился с новым оффером Плюса

Для нас это означает, что мы будем воспринимать пользователя как **старого плюсовика**, если в аттрибутах пользователя будет следующий набор:

- `account.have_plus`: 1
- `account.plus_cashback_user`: 0 или отсутствие признака

В случае, если `account.plus_cashback_user` равен 1, то мы считаем, что пользователь согласился с новым оффером.
Данный пользователь будет получать кэшбек вместо скидок.

### Виды пользователей

Начиная с запуска новой подписки у нас будет 3 вида пользователей:
- без подписки
- старый подписчик
- новый подписчик

Вид пользователя будет влиять на то, как мы взаимодействуем с пользователем.
Ниже приведена матрица различий разных подписок.

|                                        | без подписки | старый подписчик | новый подписчик |
|----------------------------------------|:------------:|:----------------:|:---------------:|
| `dbusers.users.has_plus`               |   `false`    |      `true`      |     `true`      |
| `dbusers.users.has_cashback_plus` [1]  |   `false`    |     `false`      |     `true`      |
| бонус от подписки                      |     нет      |      скидка      |     кэшбек      |
| может копить *маркетинговые баллы*     |      да      |        да        |       да        |
| может тратить баллы (в т.ч. кэшбек)    |     нет      |       нет        |       да        |
| картинки, брендинг Плюса [2]           |    новые     |      старые      |      новые      |
| видит UI кошелька                      |      да      |       нет        |       да        |
| кошелёк доступен как способ оплаты [2] |     нет      |       нет        |       да        |

Примечания:

1. Будет рассмотрено далее.
2. Предварительно, будет уточнено после появления дизайна и в отдельной проработке.

## Цель изменений

Поддержать разные версии подписки на Плюс у пользователей с возможностью добровольного апгрейда со старой подписки на новую.

## Задачи

Задачи можно условно разделить на следующие группы:
- **core** - то, без чего soft-launch в Такси будет невозможен
- версионирование - поддержка разной логики в зависимости от версии подписки
- апгрейд подписки
- остальное - задачи второго порядка

Таким образом мы имеем следующую картину:

1. Core
   1. Протащить версию подписки в бэкенды Такси.
   2. Заменить проверку эксперимента `cashback_for_plus` проверкой версии подписки.
2. Версионирование
   1. Добавить поддержку со стороны Еды, Лавки, etc (`eda-payments`, etc).
   2. Присылать разные версии картинок в зависимости от версии подписки.
   3. Научить админку отличать заказы, сделанные по разным версиям Плюса.
3. Апгрейд подписки
   1. Добавить возможность **добровольного** апгрейда со старой подписки на новую.

Далее рассмотрим план решения задач из **core**-группы.

> Остальные группы задач будут разобраны в отдельных проработках.

## Предлагаемый план

У нас есть несколько основных мест, куда мы должны протащить новый признак:
- потребители `SwitchPlusDiscountToCashback()`
  - `routestats`
  - `orderkit::Commit()`
- потребители PDP
  - `routestats`
  - `ordersestimate` (`integration-api`)
  - `orderkit::Commit()` (с недавнего времени)

Новый прайсинг (PDP) сейчас активно выпиливает использование старого калькулятора из монолита (поэтому есть пересечения между потребителями).
Как следствие, достаточно, чтобы прайсинг поддержал новый признак у себя.
Благодаря этому, мы автоматически получим soft-launch практически во всех местах, связанных с ценами.

По словам Иоанна Волкова, PDP уже ходит в `user-api` на каждый запрос с неанонимным пользователем (а это по определению пользователи с подпиской).
Поэтому ничего протаскивать к потребителям PDP не нужно, всё уже сделано за нас и при этом централизовано.

Отдельная история с `orderkit::Commit()`.
Сейчас он использует `SwitchPlusDiscountToCashback()`, но только для старого калькулятора, причём его вычисления используются только для сравнения с новым прайсингом.
Также его вычисления используются, когда PDP ничего не вернул, но как я понял, это редкая ситуация.
По этой причине, в `orderkit::Commit()` ничего нового протаскивать не требуется, так как оно в скором времени отомрёт.
Не хочется делать правки в тех местах, которые скоро вообще не будут использоваться.

![orderkit::Commit()](./images/3-commit.svg)

Остаётся `routestats`, в котором на сегодняшний день уже [есть](https://github.yandex-team.ru/taxi/backend-cpp/blob/75bfb19c66a6f2da53e2aa165881ac42634b86cf/protocol/lib/src/views/routestats/routestats.cpp#L1079) две версии ручки - полная и легковесная (новая).
В легковесной используется PDP, а в старой есть проверка на `SwitchPlusDiscountToCashback()`.
Выходит так, что это единственное место, куда нужно будет протащить новый признак.

`routestats` сейчас находится за `passenger-authorizer` (PA).
PA ходит в BlackBox и напрямую в `dbusers.users`.
Чтобы не добавлять лишний поход за признаком из `routestats`, предлагается добавить новый хедер со стороны PA.

Таким образом решение сводиться к следующим шагам.

### Новое поле в `dbusers.users`

> Чтобы не ломать существующие API, старые поля `has_plus` и `has_ya_plus` оставляем как есть.

Добавляем новое поле в коллекцию `dbusers.users` (синтаксис соответствует [описанию](https://github.yandex-team.ru/taxi/schemas/blob/3b519866328bd4c87c282ce1875a391a2e2f26a4/schemas/mongo/users.yaml) коллекции):

```yaml
has_cashback_plus:
    type: boolean
    description: Пользователь согласился с кэшбечным оффером Плюса 
```

> Сошлись на том, что делать что-то сложнее, чем булевый флаг - оверкилл.
> Данный флаг в Паспорте - временное решение на время soft-launch, дальше все подписки будут кэшбечными.
> Хранить какую-то мета-информацию о подписке сейчас рановато, а информацию о кэшбеке имеет смысл в самом сервисе `cashback`.

#### Запись флага

Сейчас запись авторизационной информации (и информации по Плюсу в частности) из Паспорта в `dbusers.users` происходит в нескольких местах:
- `user-api`
- ручка `/3.0/launch` - [`CreateUserDoc()`](https://github.yandex-team.ru/taxi/backend-cpp/blob/212b5ab627f05b7a64daf6ac1da68b1259361312/protocol/lib/src/views/launch.cpp#L1188) 
- ручка `int-api/profile` - [`UpdateUserHasYaPlus()`](https://github.yandex-team.ru/taxi/backend-cpp/blob/6bb8446afa9b2cc15d7598838c275f891c9c69cd/protocol/lib/src/integration/profile.cpp#L260)

Со стороны сервиса `user-api` требуется добавить новое поле `has_cashback_plus`:
- во всех ручках `/v3/*`, где присутствует поле `has_ya_plus`
- в ответе ручки `/users/get`

Помимо прочего, есть две ручки в монолите, которые пишут напрямую в `dbusers.users`.
Команда `user-api` постепенно выпиливает эти места, но сейчас на них тоже нужно обратить внимание.

В `launch` есть один кейс, когда будет произведена запись в базу: когда пришёл хедер `X-Yandex-Auth-Confirmed: false` и в `dbusers.users` нет записи об этом пользователе.
Сейчас этот кейс не актуален, так как в `api-proxy` принудительно [присылается](https://tariff-editor.taxi.yandex-team.ru/control-api-proxy/endpoints/show/LzMuMC9sYXVuY2g%3D) `X-Yandex-Auth-Confirmed: true`.

Также обновление записи о Плюсе происходит в `int-api/profile`.
Там происходит подтягивание информации, если запрос пришёл от Алисы.
Важно, что запрос на получение информации о Плюсе делается с помощью отдельного [метода blackbox](https://wiki.yandex-team.ru/passport/blackbox/#19.03.2018methodcheckhasplus) `check_has_plus`.

Есть два варианта, как можно решить этот момент:
- тянуть через `userinfo`, если там уже есть такой запрос
- попросить Паспорт добавить в ответ `method=check_has_plus` новый флаг (уточнил у Паспорта этот момент) и изменять интерфейс функции `clients::passport::Client::HasYandexPlus()`

Как это будет сделано в конечном итоге, зависит от команды `user-api` и ответа Паспорта.

### Сохраняем версию подписки при авторизации (`zalogin`)

![Получение версии подписки](./images/1-save-plus-version.svg)

В ручке `/v1/launch/auth` поддерживаем новое поле:
- парсим новое поле в ответе BlackBox
- добавляем новое поле в запросы к `user-api`

Таким образом, мы будем записывать признак версии подписки в `dbusers.users` при авторизации пользователя (`/3.0/launch`).
Причём как нового, так и существующего.

Новое поле сохраняем под экспериментом `cashback_for_plus`.
Таким образом, при открытии приложения в странах, где подписка не должна быть кэшбечной, в базу будет записано значение `has_cashback_plus = False`.
Как результат, нам достаточно закрыть экспериментом только запись.

### Отправляем признак текущей версии из `passenger-authorizer`

Со стороны PA нужно поддержать новый признак из BlackBox/базы `dbusers.users` (сейчас там нет поддержки `user-api`).
Новый признак будем пробрасывать через хедеры в ручки, которые [спрятаны](https://tariff-editor.taxi.yandex-team.ru/dev/configs/edit/PASS_AUTH_ROUTER_RULES_2) за PA (`routestats`).

Новый признак будем добавлять в `X-YaTaxi-Pass-Flags`:
- `ya-plus,cashback-plus` - присутствие флага означает, что пользователь имеет новую подписку
- `ya-plus` - у пользователя имеется старая подписка (скидочный Плюс)

### Добавляем признак в `pricing-data-preparer`

- добавляем новое поле в `lang::variables::UserData`
- ожидаем новый признак в запросах к PDP
- обновляем [правило преобразования](https://tariff-editor.taxi.yandex-team.ru/price-conversion-rules/view/250):

    Вместо
    ```
    ...
    if (fix.user_data.has_yaplus && good_type) {
        if (fix.category_data.yaplus_coeff as yaplus_coeff) {
        if (fix.experiments as exp) {
            if ("cashback_for_plus" in exp) {
    ...
    ```

    делаем что-то в таком духе

    ```
    ...
    if (fix.user_data.has_yaplus && fix.user_data.has_cashback_plus && good_type) {
        if (fix.category_data.yaplus_coeff as yaplus_coeff) {
    ...
    ```

### Используем признак в `protocol`

В протоколе есть метод `SwitchPlusDiscountToCashback()`.
Нужно добавить в данный метод проверку признака кэшбечной подписки у пользователя.

Проверку осуществляем по признаку `user.has_cashback_plus`.

В `routestats` признак можно получить из хедеров со стороны PA.
Нужно будет протянуть его в функцию `LoadPriceModifiers()`.

![Получение цен](./images/2-get-prices.svg)

## Aрхитектура

Конечная схема взаимодействия:

![Высокоуровневая схема](./images/data-flow-main.svg)

## Этапы

> Здесь рассмотрены только core-задачи.
> Остальные этапы будут расписаны в отдельных проработках.

### 1. Core

Задачи раскиданы по разным сервисам, поэтому за их выполнения должны будут взяться ответственные.
Задачи должны быть выполнены в порядке объявления.

Группа обработки и хранения данных:
- Добавить новое поле в `dbusers.users`
- Поддержать признак в `user-api`
- Поддержать признак в ручке `/v1/launch/auth` (`zalogin`)
- Обновлять признак из `/int-api/profile`

Группа общих компонент:
- Добавить новый флаг в `passenger-authorizer`

Прайсинг:
- Добавить признак в `lang::variables::UserData`
- Обновить преобразование

Продукт:
- Прорастить признак в `routestats`
