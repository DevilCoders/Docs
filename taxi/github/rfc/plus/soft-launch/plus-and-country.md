## Проблема
Сейчас мы в залогине всех юзеров с кешбечной подпиской дополнительно фильтруем по стране и по приложению: если по IP кешбечный юзер в России, то он получает флаг `has_cashback_plus` в `db.users`. А если нет - то не получает.
Это происходит в launch, там точки А нет, поэтому страну мы определяем мы по IP.

**NB**  
Там же есть и фильтрация по версии приложения: пользователи со старой версией не получат флаг кешбечной подписки. Это менять в рамках этой задачи мы не будем.
UPD - 7го марта оторвали и эту проверку.

**NB2**  
Сервисы в `uservices` и `py3` используют флаг от `passenger-authoriser`, в нем нет никакой фильтрации и каждый сервис фильтрует сам, если считает нужным. Где-то тоже по IP, где-то есть точка, где-то никак.

И поэтому у нас есть две проблемы:
- Большая проблема А - флоу кешбека в некоторых сервисах основано на стране по IP, а не точки А. В частности в протоколе.
- Проблема поменьше Б - выбор между скидкой и кешбеком на основе IP, а не точки А.

### Решение
Делать будем в три+ этапа

**Первый этап**
1. Убрать проверку страны из определения флага кешбечности. Там будет состояние подписки как в паспорте + фильтрация по приложению.
2. В протоколе, где мы сейчас используем этот флаг - проверяем флаг и страну по IP. Итог получится ровно такой, как есть сейчас.
3. Кроме прайсинга и старого калькулятора - они будут проверять только флаг. Таким образом мы решим проблему с ВПН.

**Второй и последующие этапы**
1. Забрать куски флоу кешбека в те ручки, где есть позиция, или добавить позицию в существующие ручки.

**Отдельно**
1. Оторвать и проверку приложения тоже. Нужно будет продумать, как расставить проверки в нашем коде, чтобы не сломать старые приложения.

## Теперь проблема целиком
### Что у нас есть для юзера и от чего зависит
- плюс в методах оплаты - `paymentmethods`
- скидка на заказ или кешбек на заказ - `pricing`
- бейдж в профиле пользователя - `launch`
- бейдж в карточке тарифа - `zoneinfo`
- вход в домик на саммари сверху справа - был в `paymentmethods`, сейчас в `SDK`. Какое-то количество клиентов с `paymentmethods` еще есть.
- вход в домик на саммари из меню - `personal-wallet/available-accounts`
- тумблер использования баллов в домике - `paymentmethods` и `zoneinfo`
- сторизы в нативном домике - `inapp-communications`

### Параметры со стороны плюсового юзера
- IP в России или нет
- Точка А в России или нет
- у юзера свежее приложение или нет
- у юзера есть кешбечная подписка или нет

### Какие юзеры бывают
 - "классический" - IP в России, точка А в России, приложение свежее, кешбечная подписка есть
 - "старый подписчик" - юзеры, намеренно выбравшие скидку
 - "старое приложение" - юзеры со старыми приложениями.
 - "в Израиле" - недавно купил подписку и не в России. IP к примеру в Израиле, точка А в Израиле, приложение свежее, кешбечная подписка.
 - "VPN" - включил VPN на телефоне. IP к примеру в Израиле, точка А в России, приложение свежее, кешбечная подписка.
 - "прокрутил карту в Израиль" - запустил приложение в России и прокрутил карту в Израиль. IP в России, точка А в Израиле, приложение свежее, кешбечная подписка есть.

### Что кому показать
Уточнения:
- Cторизы в нативном домике обдумать и обсудить не успели, и не факт, что это вообще нужно: нативный домик уже оторвали. И я не знаю кстати где и как их увидеть. На первом этапе я это не задену, а если будем делать дальше - нужно будет посмотреть на них внимательнее.
- Тумблер использования баллов в домике - кажется, он всегда есть в домике. При этом, если Плюс использовать нельзя, он отправляет в список методов оплаты. То есть он вторичен и зависит от доступных методов оплаты и его можно не рассматривать отдельно.
- По плюсу в других странах мы можем или давать скидку или не давать ничего. С точки зрения кешбека для нас это ничего не меняет, будем считать, что взеде скидка.

**Как сейчас**
|                                        | классический | старый подписчик 	|старое приложение| в Израиле  		|      VPN     | прокрутил карту |
|----------------------------------------|:------------:|:-----------------:|:---------------:|:---------------:|:------------:|:---------------:|
|плюс в методах оплаты					 |     есть     |не знаю, скорее нет|       нет       |     нет    		|     нет      | недоступен 	 |
|на заказ: скидка или кешбек		 	 |    кешбек    |     скидка       	|     скидка      |		скидка		|    скидка    | 	скидка		 |
|бейдж в профиле						 |  10% кешбек  |    10% скидка    	|    10% скидка	  |	10% скидка		| 10% скидка   |  10% кешбек	 |
|бейдж в карточке тарифа				 |  10% кешбек  |    10% скидка    	|    10% скидка	  |	10% скидка		| 10% скидка   |  10% кешбек	 |
|вход в домик на саммари и в меню 		 |     есть     |  не знаю     	   	|        нет      |     нет			|     нет 	   |	  есть		 |

Уточнения:
- Я не сбрасывал себе подписку, поэтому как что выглядит у старых подписчиков не знаю

**Как будет после этапа 1**
|                                        | классический | старый подписчик 	|старое приложение| в Израиле  		|      VPN     | прокрутил карту |
|----------------------------------------|:------------:|:-----------------:|:---------------:|:---------------:|:------------:|:---------------:|
|плюс в методах оплаты					 |     есть     |не знаю, скорее нет|       нет       |     нет    		|     нет      | недоступен 	 |
|на заказ: скидка или кешбек		 	 |    кешбек    |     скидка       	|     скидка      |		скидка		| **кешбек**   | 	скидка		 |
|бейдж в профиле						 |  10% кешбек  |    10% скидка    	|    10% скидка	  |	10% скидка		| 10% скидка   |  10% кешбек	 |
|бейдж в карточке тарифа				 |  10% кешбек  |    10% скидка    	|    10% скидка	  |	10% скидка		|**10% кешбек**|  10% кешбек	 |
|вход в домик на саммари и в меню 		 |     есть     |  не знаю     	   	|        нет      |     нет			|     нет 	   |	  есть		 |


**Как будет в идеале когда-нибудь**
|                                        | классический | старый подписчик | старое приложение| в Израиле  		|      VPN     | прокрутил карту |
|----------------------------------------|:------------:|:----------------:|:----------------:|:---------------:|:------------:|:---------------:|
|плюс в методах оплаты					 |     есть     |    недоступен    |       нет        |     нет    		|     есть     |	   нет 		 |
|на заказ: скидка, кешбек, ничего	 	 |    кешбек    |     скидка       |     кешбек       |скидка/ничего	|    кешбек    | скидка/ничего	 |
|бейдж в профиле						 |  10% кешбек  |    10% скидка    |    10% кешбек	  |10% скидка/ничего| 10% кешбек   |  10% скидка	 |
|бейдж в карточке тарифа				 |  10% кешбек  |    10% скидка    |    10% кешбек	  |10% скидка/ничего| 10% кешбек   |  10% скидка	 |
|вход в домик на саммари и в меню 		 |     есть     |        есть      |        нет       |     нет    		|     есть     |	  нет		 |

Уточнения:
- Табличка выше это идеальное состояние после всех этапов: мы научимся правильно определять страну и разберемся с версией приложения.
- Возможно, какие-то пункты мы или не сможем реализовать или наши текущие договоренности окажутся неправильными.

## Как делать

### Как делать этап 1
1. Заводим конфиг `CASHBACK_FOR_PLUS_COUNTRIES`
2. В протоколе одна точка проверки для проверки при создании заказа, брендингов в `launch` и `zoneinfo`- `ShouldPayCashbackForPlus`.  Начинаем из ручек передавать в нее страну и меняем в ней `user.has_cashback_plus` на `user.has_cashback_plus && country in CASHBACK_FOR_PLUS_COUNTRIES`
3. В залогине меняем проверку эксперимента `cashback_for_plus` на `cashback_for_plus_by_app`, оставляем в нем только проверку приложения.

**Протокол**  
У нас есть remote_ip в запросах, можем определять по IP.

Где что делаем:
- брендинг композитки в routestats - можем и нужно определять по IP
- загрузка модифаеров в ShouldPayCashbackForPlusByLocation для `routestats` - тут как раз не нужна проверка по IP, так как это модифаеры для старого калькулятора и ответа `routestats`
- загрузка модифаеров в calcinfo_processing для `ordetcommit` при протухших заказах - тут как раз не нужна проверка по IP, так как это модифаеры для старого калькулятора
- доступность оплаты Плюсом в `ordercommit` - кажется, что не получится создать заказ с оплатой Плюсом под ВПНом. Но на всякий случай будем проверять страну и здесь можно спокойно проверять страну по зоне.
- загрузка брендингов в GetPlusPropertiesForUser. Они используются для бейджа "10% скидка"/"10% кешбек"
  - в `launch` - там уже есть страна, определяемая по IP. Это бейдж в профиле пользователя.
  - `BuildDiscount` в `zoneinfo` - бейдж в карточке тарифа. Думаю, можно использовать страну по точке. Да, будет расхождение с бейджем в профиле пользователя, но зато будет правда.


**JFYI**
- У старых клиентов плюс в методах оплаты теряется от версий приложений в экспе personal_wallet, который в апи прокси проверяется.

**JFYI2 - список сервисов, которые смотрят на флаг кешбечности подписки из PA**
- `v1/available-accounts` - использует флаг из PA + проверка экспа `personal_wallet_visible`
- сервис `card-filter` - использует флаг из PA + проверка экспа `cashback_for_plus`
- сервис `inapp-communications` - использует флаг из PA
- сервис `plus-sweet-home` - использует флаг из PAP + проверка своих экспов
- сервис `plus` -  использует флаг из PA + проверка экспов, включая `cashback_for_plus`. В разбивке для тотва тоже PA.
- сервис `eats-plus` - он сам ходит в паспорт
- сервис `taxi-stories` в py2 - использует флаг из PA 

### Что входит в этап 2
1. Добавить в домик резолвинг по точке
2. Забрать пункт меню из `availavle-accounts` в домик Плюса
3. Забрать пункт из профиля пользователя в домик Плюса
4. Клиентский эксп cashback перепридумать. Потому что он сейчас приходит из `launch`, где только IP. И его отсутствие банит, к примеру, показ кешбека ВПНщикам на саммари.
5. Дождаться переезда на 4.0/paymentmethods и сделать метод оплаты кошелек по точке. Тогда можно будет оторвать резолвин по IP из брендинга routestats с предложением потратить баллы.
