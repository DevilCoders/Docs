# Апгрейд подписки

- [Меню на сегодня](#меню-на-сегодня)
- [Слово от шефа](#слово-от-шефа)
- [Ингредиенты](#ингредиенты)
- [Рецепт](#рецепт)
  - [Блюдо первое. Ручка апгрейда](#блюдо-первое-ручка-апгрейда)
  - [Блюдо второе. Признак возможности апгрейда](#блюдо-второе-признак-возможности-апгрейда)
  - [Десерт первый. Псевдо-нотификация на доме Плюса](#десерт-первый-псевдо-нотификация-на-доме-плюса)
  - [Десерт второй. Переключение сторизов в доме Плюса](#десерт-второй-переключение-сторизов-в-доме-плюса)

## Меню на сегодня

Мы должны научиться определять, что пользователь может апгрейднуть свой плюсовый оффер со скидки на кэшбек.
Для пользователей, которые могут осуществить апгрейд мы должны предоставить соответствующую ручку.

На десерт мы должны предоставить продуктовый "счётчик нотификаций" для домика Плюса.
Также бизнес хочет уметь обрабатывать кейс "Скидочный подписчик без баллов не видит кэшбечные сторизы в доме Плюса".

## Слово от шефа

На [встрече](https://calendar.yandex-team.ru/event?event_id=51612804) мы закоммитились на следующее:
- чтобы реализовать все продуктовые требования, которые должны быть к запуску, нам необходимо иметь информацию о наличии баллов у пользователя
- сейчас получать баллы на беке выглядит не целесообразным, так как архитектура кошелька не готова к дополнительной нагрузке
- для того, чтобы запуститься, мы договорились, что для удовлетворения продуктовых требований мы готовы реализовать часть логики на клиентах
- для домика Плюса и любой информации о подписки необходимо будет создать новую архитектуру (кэш над балансом, ручка для домика Плюса), так как сейчас информация получается из разных мест для формирования одной сущности
- при создании так называемой архитектуры для домика Плюса, мы выпилим логику из клиентов и полностью перенесём её на бек

О переезде на новую архитектуру читайте в следующих проработках, а мы приступаем сегодняшнему званному ужину.

## Ингредиенты

- мы предлагаем апгрейд только в странах с новым оффером (Россия)
- мы предлагаем апгрейд только для пользователей со скидочной подпиской
- пользователь может совершить апгрейд только в одну сторону: скидка -> кэшбек
- условия показа счётчика:
  - пользователь впервые получил баллы
  - пользователь до этого не нажимал на дом Плюса
- если у пользователя нет баллов, мы ему не показываем признаки новой подписки
- в качестве MVP не делаем отдельную ручку для домика Плюса, а используем существующие ручки

## Рецепт

> Дизайн запуска доступен по [ссылке][link-figma].

[link-figma]: https://www.figma.com/file/zWSt3vNWyrVQPQYX7YI23B/%D0%9F%D0%BB%D1%8E%D1%81%3A-%D0%B2%D0%B0%D0%BB%D1%8E%D1%82%D0%B0-%D0%B8-%D0%BF%D0%BE%D0%B4%D0%BF%D0%B8%D1%81%D0%BA%D0%B0?node-id=15857%3A83066

У нас есть три сценария, которые мы должны уметь обрабатывать:
- неподписчик
- скидочный плюсовик с баллами (основной сценарий)
- скидочный плюсовик без баллов

Для неподписчика на сегодняшний день ничего не меняется.
Начиная с запуска:
- мы меняем продукт, который можно нативно купить, на новую подписку
- клиенты запрашивают сторизы для кэшбечного флоу
- мы возвращаем псевдо-нотификацию всегда

Основной задачей является работа с подписчиками.
Мы будем отличать сценарии подписчиков по наличию баллов на счету.

Вот как должен выглядеть домик Плюса для подписчика в зависимости от наличия баллов.

| ![Есть баллы][image-discount-plus-with-points] | ![Нет баллов][image-discount-plus-without-points] |
| :--------: | :--------: |
| Есть баллы | Нет баллов |

[image-discount-plus-with-points]: https://jing.yandex-team.ru/files/erakli00/discount-plus-with-points.png
[image-discount-plus-without-points]: https://jing.yandex-team.ru/files/erakli00/discount-plus-without-points.png

С учётом ранее сказаного за переключение между этими сценариями будут отвечать клиенты (в качестве MVP). 

### Блюдо первое. Ручка апгрейда

Добавляем новую клиентскую ручку в сервис `plus` со следующим протоколом:

```
POST /4.0/plus/v1/subscriptions/upgrade

Headers:
- X-Yandex-UID
- X-Remote-IP
- X-YaTaxi-Pass-Flags

Request body:
{
}
```

Ответы:
- 200: Обновление прошло успешно
- 409: Апгрейд не может быть осуществлён
- 500: Скорее всего сломался МБ

> Полная спецификация [прилагается](./subscription-upgrade/api.yaml).

Алгоритм работы:
- проверяем, что у пользователя есть подписка (в `pass-flags` есть `ya-plus`)
  - если нет, то -> отвечаем 409
- проверяем эксперимент `cashback_for_plus` по стране (из `X-Remote-IP`)
  - если не активен, то -> отвечаем 409
- проверяем, что пользователь ещё не осуществлял апгрейд (в `pass-flags` нет `cashback-plus`)
  - если осуществлял, то -> отвечаем 409
- делаем запрос в МБ `POST api.mediabilling.yandex.net/billing/cashback-status?uid=<yandex_uid>&status=enabled`
  - если ответ не 200 -> отвечаем 500
- отвечаем 200

> Опционально можем делать перезапрос к МБ при ответе 409/429

### Блюдо второе. Признак возможности апгрейда

Если подписчик может осуществить апгрейд до кэшбечной подписки, то мы должны отобразить ему соответствующую кнопку в домике Плюса.

По дизайну предполагается, что кнопка может иметь несколько состояний:

| ![Состояния кнопки апгрейда][image-upgrade-button-states] |
| :-----------------------: |
| Состояния кнопки апгрейда |

[image-upgrade-button-states]: https://jing.yandex-team.ru/files/erakli00/upgrade-button-states.png

Добавляем в ответ `launch` новые поля в поле `subscriptions`:

```yaml
properties:
    could_upgrade_plus:
        type: boolean
        description: >
            Можно предложить пользователю перейти на кэшбечный
            оффер Плюса.
    upgrade_info:
        $ref: '#/components/schema/UpgradeInfo'
required:
- could_upgrade_plus

components:
    schemas:
        UpgradeInfo:
            type: object
            description: Информация для апгрейда подписки.
            properties:
                upgrade_button:
                    $ref: '#/components/schema/UpgradeButton'
            required:
            - upgrade_button
        
        UpgradeButton:
            type: object
            description: Информация для кнопки апгрейда в домике плюса.
            properties:
                title:
                    type: string
                    description: Заголовок над кнопкой
                    example: "Кэшбек вместо скидки"
                subtitle:
                    type: string
                    description: Подпись под заголовком
                    example: "10% остаются с вами"
                action_text:
                    type: string
                    description: >
                        Текст первого состояния кнопки (для совместимости с 
                        полем `$.allowed_subscriptions.purchase_info`).
                    example: "Активировать баллы"
                states:
                    type: array  # либо как объект
                    description: Состояния кнопки.
                    items:
                        $ref: '#/components/schema/State'
            required:
            - title
            - subtitle
            - states
        
        State:
            type: object
            properties:
                state:
                    type: string
                    enum:
                    - pending
                    - activating
                    - activated
                    - error
                text:
                    type: string
            required:
            - state
            - text
```

Поле `subscriptions` подмешивается в ответ `launch` через `api-proxy`.
Данные для поля `subscriptions` формируются из внутренней ручки `/internal/v1/subscriptions/list` (сервис `plus`).

Предлагается расширить ответ этой ручки новыми полями, описанными выше, тем самым добавив их в ответ `launch`.
Чтобы вся история работала, необходимо добавить обязательный хедер `X-YaTaxi-Pass-Flags` со стороны PA в запрос к ручке.

Таким образом протокол следующий (на примере ответа `launch`):

```json5
{
  "subscriptions": {
    // существующие поля
    "manage_info": {},
    "active_subscriptions": [],
    "allowed_subscriptions": [],
    "promoted_subscriptions": [],
    "pending_purchases": [],
    // новые поля
    "could_upgrade_plus": true,  // required
    "upgrade_info": {            // optional
      "upgrade_button": {
        "title": "Кэшбек вместо скидки",
        "subtitle": "10% остаются с вами",
        "action_text": "Активировать баллы",  // для совместимости
        "states": [  // либо как объект
          {
            "state": "pending",
            "text": "Активировать баллы"
          },
          {
            "state": "activating",
            "text": "Баллы активируются..."
          },
          {
            "state": "activated",
            "text": "Баллы активированы"
          },
          {
            "state": "error",
            "text": "Произошла ошибка"
          }
        ]
      }
    }
  }
}
```

Алгоритм вычисления значения поля `could_upgrade_plus` (все те же проверки, что и в ручке апгрейда):
- проверяем, что у пользователя есть подписка (в `pass-flags` есть `ya-plus`)
  - если нет, то -> false
- проверяем эксперимент `cashback_for_plus` по стране (из `X-Remote-IP`)
  - если не активен, то -> false
- проверяем, что пользователь ещё не осуществлял апгрейд (в `pass-flags` нет `cashback-plus`)
  - если осуществлял, то -> false
- возвращаем true, добавляем `upgrade_info`

Кнопка апгрейда добавляется в домик Плюса только в случае, если `could_upgrade_plus: true` и пришёл `upgrade_info`.

### Десерт первый. Псевдо-нотификация на доме Плюса

На домик Плюса необходимо добавить значок нотификации в случае, если
- это неподписчик
- скидочный подписчик и у него есть баллы

Как это должно выглядеть:

| !["Нотификации" присутствуют][image-counter-active] | !["Нотификации" отсутствуют][image-counter-disabled] |
| :------------------------: | :-----------------------: |
| "Нотификации" присутствуют | "Нотификации" отсутствуют |

[image-counter-active]: https://jing.yandex-team.ru/files/erakli00/counter-active.png
[image-counter-disabled]: https://jing.yandex-team.ru/files/erakli00/counter-disabled.png

Предлагается добавить в ответ ручки `/v1/available-accounts` (сервис `personal-wallet`) новое поле:

```json
{
  "notification_counter": 1
}
```

Что означает наличие так называемой "нотификации" на домике Плюса.
На данный момент имеются следующие договорённости: 
- клиенты отображают на домике Плюса значок нотификации, если получили `notification_counter` в ответе `/v1/available-accounts`
- при нажатии на домик Плюса с нотификацией клиенты запоминают факт того, что нотификация была "прочитана"
- ответственность клиентов больше не показывать 

Данное поле будет носить временный характер до переезда на новую архитектуру Плюса.
На момент запуска мы добавляем его сюда, так как в `/v1/available-accounts` мы уже имеем информацию о наличии балов у пользователя.

> На данном этапе мы имеем следующую **машину состояний**:
> - пользователь не может тратить баллы, пока не сделает апгрейд подписки
> - как только он получил баллы, мы начинаем отображать ему нотификацию
> - если он новый подписчик, мы также отобржаем нотификацию сразу, с момента запуска
> - если пользователь открыл домик Плюса, клиенты больше не показывают эту нотификацию
> - как только пользователь совершил апгрейд, мы больше не присылаем каунтер

Алгоритм, по которому поле добавляется:
- проверяем эксперимент `cashback_for_plus` по стране (из `X-Remote-IP`)
  - если не активен, то ничего не добавляем
- проверяем, что у пользователя есть подписка (в `pass-flags` есть `ya-plus`)
  - если нет, то добавляем каунтер
- проверяем, что пользователь ещё не осуществлял апгрейд (в `pass-flags` нет `cashback-plus`)
  - если не осуществлял, то добавляем каунтер
 - иначе, ничего не добавляем

### Десерт второй. Переключение сторизов в доме Плюса

Требуется для скидочных подписчиков без баллов показывать скидочные сторизы.
Во всех остальных случаях должны отображаться кэшбечные сторизы.

| ![Скидочные сторизы][image-stories-discount] | ![Кэшбечные сторизы][image-stories-cashback] |
| :------------------------: | :-----------------------: |
| Скидочные сторизы | Кэшбечные сторизы |

[image-stories-discount]: https://jing.yandex-team.ru/files/erakli00/stories-discount.png
[image-stories-cashback]: https://jing.yandex-team.ru/files/erakli00/stories-cashback.png

Предлагается следующий план действий:
- добавляем набор скидочных сториз
- добавляем новый контекст в сервис taxi-stories - `discount`
- клиенты запрашивают соответствующий контекст по следющей логике:
    - если `could_upgrade_plus: true` и баланс нулевой - контекст скидочный
    - иначе кэшбечный
