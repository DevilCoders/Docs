# Задача
## Поддержать в Такси оплату картой Финтеха.
Карту можно выбрать для оплаты поездки
Логика антифрода и сброса на кэш аналогична обычной карте
## Выдавать дополнительный кэшбэк на поездки, оплаченные картой Финтеха.
+5% на любые заказы

# Терминология
Кошелёк финтеха, карта финтеха, yandex_card — пополняемый счёт в финтехе Яндекса.
Дополнительный кэшбэк — маркетинговый кэшбэк, который складывается с существующим в заказе кэшбэком.
Например, можно получить 2% кэшбэка по скидке, и ещё 5% даст Финтех.

# Карта финтеха как способ оплаты
Есть два варианта поддержать карту Финтеха как способ оплаты:
1. Добавить к существующему способу оплаты card признак, указывающий на то, что это карта Финтеха
2. Сделать в Такси новый способ оплаты yandex_card

Рассмотрим подробнее примерный скоуп изменений в каждом случае

## Новый признак у card
В этом случае мы рассматриваем карту Финтеха как обычную карту с дополнительным признаком `is_yandex_card`.

### paymentmethods
Клиент должен отличать обычную карту от карты Финтеха, поэтому в схему карты в paymentmethods нужно добавить `is_yandex_card`.  
paymentmethods получает карты из сервиса cardstorage, который, в свою очередь получает их из ручки /bindings в Трасте.  
Карта Финтеха — это не полноценная карта, поэтому она будет приходить в отдельном поле ручки /v1/payment_methods Траста. cardstorage нужно будет перевести на использование /v1/payment_methods.  
Возможно, карты финтеха придётся кэшировать вместе с остальными картами.  

Изменения затронут: cardstorage, api-proxy

### Верификации
Флоу верификации обычных карт живёт в Такси. Карта Финтеха будет верифицироваться исключительно в SDK Финтеха. Её нужно будет каким-то образом исключить из обычного флоу верификации.

Изменения затронут: card-antifraud, cardfilter

### routestats
API routestats принимает карту в виде
```
"payment": {
  "payment_method_id": "card-x6936",
  "type": "card"
}
```
routestats должен уметь отличать обычную карту от карты Финтеха, поэтому клиент должен либо передать признак `is_yandex_card` в запросе, либо routestats должен каким-то запросом в cardstorage определить, что карта принадлежит Финтеху.
В первом случае API routestats придётся расширить, во втором — routestats добавит 1–1.5K RPS  в cardstorage.

Кроме этого признак придётся прокинуть в pricing-data-preparer, чтобы его можно было использовать в преобразованиях.

Изменения затронут: routestats в backend-cpp, routestats в uservices, cardstorage (опционально),  pricing-data-preparer

### orderdraft
Флаг `is_yandex_card` нужно будет сохранить в драфт заказа  

Изменения затронут: orderdraft в backend-cpp

### ordercommit
В ordercommit нужно проверить, что
- карта существует
- карта действительно принадлежит Финтеху
- пользователь попадает в эксперимент

Изменения затронут: ordercommit

### totw
В totw нужно расширить API — добавить поле `is_yandex_card` в ответ и научиться принимаеть его в запросе на смену способа оплаты.

Изменения затронут: api-proxy, taxiontheway, фолбэк totw в order-core

### Процессинг заказа
В MVP заказа с картой Финтеха не будет отличаться от обычной карты.
В будущем заказы с картой финтеха могут процесситься по-другому, например, вместо сброса на кэш заказ будет переключаться на обычную карту.
Для этого в order_proc и order нужно хранить флаг `is_yandex_card`

Изменения затронут: processing py2

### Оплата заказа
Оплата заказа картой финтеха в update_transactions и transactions не будет отличаться от обычной карты.

### Биллинг
Комиссии и субсидии по заказам с картой Финтеха не будут отличаться от обычной карты

### Админка
В админке заказов нужно будет поддержать отображение признака `is_yandex_card`

### Остальное
Множество мест во py2 рассчитывают на дополнительные параметры у карты, например, платёжную систему, блокировки, номер, и так далее.


Итого:
Достоинства:
- нет правок в update_transactions, оплата фактически работает из коробки
- нет правок в биллинге
- нет правок в transactions
- смена способа оплаты и оплата долга работает из коробки

Недостатки:
- много правок в протоколе
- правки в прайсинге
- новое поле в order_proc/order
- правки в верификации карт
- изменения в админке
- множество потенциальных изменений, чтобы заставить существующий код считать картой способ оплаты без карточных атрибутов

## Новый способ оплаты
В этом случае в Такси появляется новый способ оплаты.

Новый способ оплаты нужно поддержать в цикле заказа, оплате и биллинге.  
Эпик: https://st.yandex-team.ru/TAXIBACKEND-36910
### Цикл заказа
#### backend-cpp
Добавить yandex_card в enum способов оплаты.  
https://st.yandex-team.ru/TAXIBACKEND-36911
#### 3.0/zoneinfo
В zoneinfo нужно по эксперименту возвращать yandex_card в списке способов оплаты, если он есть в зоне.  
В каждую зону добавить yandex_card [скриптом](https://github.yandex-team.ru/taxi/tools-py3/blob/master/taxi_tariffs/add_payment_method.py)
#### 3.0/paymentmethods
Новый протокол в отдельном [RFC](https://github.yandex-team.ru/taxi/rfc/pull/878)  
Тикет: https://st.yandex-team.ru/TAXIBACKEND-36928
#### api-proxy
Проксировать список карт из cardstorage
#### cardstorage
1. Перейти на метод v1/payment_methods Траста в cardstorage
   https://st.yandex-team.ru/TAXIBILLING-3874
2. Возвращать карты финтеха в cardstorage/v1/payment_methods
3. Опционально, кэшировать карты финтеха в cardstorage
### 3.0/routestats
Для поддержки способа оплаты изменения не потребуются.

Для повышенного кэшбэка нужно будет аналогично мастеркарду присылать специальный брендинг на клиент в зависимости от меты прайсинга. Схема брендинга ещё не прорабатывалась.
### 3.0/taxiontheway
Не присылать yandex_card в доступных способах для смены оплаты.
### 3.0/orderdraft
Изменения не потребуются
### 3.0/ordercommit
- Проверять, что yandex_card в request.payment существует запросом в cardstorage
- Разрешать делать заказ по эксперименту
### processing
Закрывать заказы с оплатой yandex_card подобно обычной карте и кооп. аккаунту. 
Это значит, что в обработчике завершения заказа в py2 нужно добавить yandex_card в условие, которое вызовет впоследствии `_close_with_card`.
### antifraud
Заработает из коробки
### Оплата заказа
#### update_transactions
Передавать yandex_card в transactions/v2/invoice/create и transactions/v2/invoice/update аналогично карте, кооп аккаунту и оплате через агента.
Это означает, что везде, где проверяется способ оплаты нужно добавить yandex_card в одно условие с card и applepay/googlepay.
#### transactions
https://st.yandex-team.ru/TAXIBACKEND-36996  
Принимать yandex_card и передавать в Траст аналогично картам.
Масштаб правок — около 20 строк. Отдельный платёжный гейтвей не нужен, id карты будет передаваться в Траст аналогично обычной карте.
### Биллинг
#### Комиссии
Продуктово не нужны отдельные комиссии на yandex_card, поэтому способ оплаты будет подменяться на карту в billing-subventions.  
Аналогично делали для агентской оплаты: https://st.yandex-team.ru/TAXIBILLING-4506
#### Субсидии
Продуктово не нужны отдельные субсидии на yandex_card.  
TODO: уточнить про использование способов оплаты в существующих субсидиях.
#### Tlog и OEBS
Добавить yandex_card в конфиг https://tariff-editor.taxi.yandex-team.ru/dev/configs/edit/BILLING_PAYMENT_ADAPTER_PAYMENT_TYPES

### Итого
Достоинства:
- более очевидное отличие карты Финтеха от обычных карт
- небольшое число правок в backend-cpp
- добавление способа оплаты — очевидная задача, недавно такое сделали для агенсткой оплаты, это легко повторить

Недостатки:
- мелкие правки в разных сервисах, которые смотрят на способы оплаты
- правки в update_transactions и py2
- правки в transactions, хоть и тривиальные
- нужно заменить способ оплаты в субсидиях
- смена способа оплаты и оплата долга потребует дополнительных правок
- способ оплаты придётся добавить скриптом во все зоны

### Срезанные углы
#### Смена способа оплаты
Смена способа оплаты с yandex_card и на yandex_card в MVP будет невозможен.
#### Сброс на карту вместо кэша
Есть продуктовая идея вместо кэша сбрасывать на последнюю использованную карту


# Итог
Первый вариант требует меньше правок в py2, но гораздо больше правок в протоколе и цикле заказа и больше согласований с разными командами: прайсинг, биллинг, инфраструктура цикла заказа.

Правки в py2 во втором варианте точечные и не являются проблемой.  

В итоге мы выбрали второй вариант — новый способ оплаты yandex_card.
