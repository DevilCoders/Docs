# Условия показа шильдика

## Что есть сейчас?

### Что поддерженно на клиентах
- Настройка по экранам, на которым можем показывать шильдик (screens): summary, ride, multiorder, complete
- Настройка по тарифам, на которых показываем шильдик (tariffs): comfortplus, vip, ultimate, minivan, maybach, cargo, child_tariff, econom, bussines
- Настройка по показанным typed-экранам: unseen_typed_screens, если бы увиден хотя бы один из экранов из поля unseen_typed_screens, то шильдик не показываем


### Что есть на беке, но не поддержано на клиентах
- Настройка по order_states (по состояниям заказа): transporting, complete, riding и другие, которые есть

### Параметры показа
- show_after: он есть в настройках, но в новом гибком шильдике не поддерживаем его, так как продуктовой применимости ему не нашли и не использовали его.
- close_after: Через какое время (в секундах) необходимо скрыть шильдик. Если close_after сработал не показываем на конкретном экране в текущей сессии пользователя (если шильдик предусматривает несколько экранов появления - поле "screens").

### Условия показа на бекенде
- Можно контролировать проверками на беке условия показа шильдика: флаги подписки, кешбэчности пользователя, положительного баланса, эксперименты.

## Что не хватает?
- Есть проект перс. целей - https://wiki.yandex-team.ru/users/vladazh/personalnye-celi-pljusa-v-go/

<img src="https://jing.yandex-team.ru/files/arteeemik/Screenshot%202022-03-03%20at%2011.05.35.png" width="400">

Пройдемся по каждому из пунктов по шильдику и зафиксируем, что есть, а что нужно добавить:
### "Прогресс по цели до поездки":
- `[2.1] экран, на котором показывается шильдик — summary`: реализовать такое можно через условия показа по экрану screens
- `[2.2] НЕ раскрывается на summary, если пользователь видел карточку цели (см. п.1) - нужно не показывать все шильдики Плюса, пока карточка в раскрытом состоянии`: такое в api не предусмотрено. Предлагаю добавить в api следующее поле `available_tariffs`:
- `[2.3] по дефолту раскрывается каждую сессию, скрывается по смахиванию вверх` - шильдики сейчас так и работают
- `[2.4] по дефолту скрывается через X секунд после раскрытия (X настраивается в конфиге для всех целей)` - такое сейчас поддержано в обычном шильдике, и нужно поддержать в гибком шильдике тоже
- `[2.5] в шильдике указывается количество поездок до выполнения цели в нужном склонении` - на бекенде это решается через tanker
- `[2.6] в шильдике указывается награда за цель: либо фикс либо % повышенного кешбэка` - на бекенде решается
- `[2.7] тап на любое место в теле шильдика открывает карточку цели из п.1` - сделаем диплинк в настройках действия у виджетов
- `[2.8] кнопка может быть, а может не быть — её поведение зависит от типа цели, см ниже` - решается через настройку шильдика
- `[2.9] если безналичная оплата обязательна для выполнения цели, шильдик НЕ показывается, если способ оплаты — наличные` - такого сейчас нет. Нужно расширить API. Предлагаю добавить следующую настройку `payment_methods`:
```C++
SimpleCondition:
            type: object
            description: >
                Простое условие показа.

                Если какое-либо условие не заполнено, то считается, что оно
                выполняется всегда.
                Если условий совсем нет, то этот шильдик необходимо игнорировать
                (потому что это непредсказуемо).

                Если есть требование, но при этом в клиентском контексте
                отсутствует соответствющий параметр, то это **неудовлетворение
                условия**.
            additionalProperties: false
            properties:
                screens:
                    type: array
                    description: |
                        Список экранов хостового приложения, которые
                        удовлетворяют условию показа.
                    items:
                        type: string
                    example:
                      - "main"
                      - "summary"
                ...
                payment_methods:
                    type: array
                    description: >
                        Список способов оплаты, при которых покажется шильдик. То есть, если выбран способ оплаты из этого поля, то шильдик покажется.
```
- `[2.10] цель на Активность (см раздел "Виды персональных целей") --> кнопки "В [название тарифа]" нет, шильдик скрывается после X секунд` - здесь все умеем поддерживать
- `[2.11] цель на Апсейл, не выбран нужный тариф --> появляется кнопка "в [название тарифа]", где название тарифа — по-умолчанию самый младший из доступных в рамках цели и не выбранных пользователем тарифов` - Диплинк на кнопке `yandextaxi://route?vertical=ultima`, по идее можно в любой тариф пользователя закинуть таким диплинком. Тут хочется узнать на IOS и на Android этот диплинк уже реализован?
- `[2.11.1] пользователь не выбирает нужный тариф --> шильдик скрывается после X секунд` - может это реализовать тоже
- `[2.11.2] пользователь выбирает нужный тариф --> надпись кнопке меняется на "[название тарифа]" выбран` - здесь тоже умеем
- `[2.11.3] цель на Апсейл, выбран нужный тариф --> кнопки "В [название тарифа]" нет, шильдик скрывается после X секунд` - умеем.
- `[2.12] тап на любую область шильдика, кроме кнопки, ведёт на карточку цели` - диплинк на карточку нужен
- `[2.13] шильдик не показывается, если пользователь ВНЕ зоны тарифов из цели` - для этого вводим как раз новое поле `available_tariffs`
Так мы сможем не показывать пользователю шильдик про перс. цели "В комфорт", если не будет тарифа комфорт. Так как еще нужно добавить поддержку вертикалей, то добавляется новое поле selected_tariffs. После `tariffs` клиенты поддерживать не должны и смотреть на него не нужно после поддержки поля `selected_tariffs`. 
```C++
Tariff:
    type: object
    additionalProperties: false
    required:
      - tariff
      - vertical
    properties:
        tariff:
          type: string
          example: econom, ultima
        vertical:
          type: string
          example: taxi, ultima, ...
                  
SimpleCondition:
    type: object
    description: >
        Простое условие показа.

        Если какое-либо условие не заполнено, то считается, что оно
        выполняется всегда.
        Если условий совсем нет, то этот шильдик необходимо игнорировать
        (потому что это непредсказуемо).

        Если есть требование, но при этом в клиентском контексте
        отсутствует соответствющий параметр, то это **неудовлетворение
        условия**.
    additionalProperties: false
    properties:
        screens:
            type: array
            description: |
                Список экранов хостового приложения, которые
                удовлетворяют условию показа.
            items:
                type: string
            example:
              - "main"
              - "summary"
        ...
        tariffs:
            type: array
            description: Cписок необходимых тарифов. После поддержки поля selected_tariffs, поле tariffs не должно использоваться.
            items:
                type: string
        selected_tariffs:
            type: array
            description: Cписок необходимых тарифов.
            items:
                $ref: 'plus_sweet_home/definitions.yaml#/Tariff'
        available_tariffs:
            type: array
            description: >
                Список доступных тарифов для пользователя. Если какой-то тариф недоступен пользователю,
                то не показываем шильдик.
            items:
                $ref: 'plus_sweet_home/definitions.yaml#/Tariff'
```
- `[2.14] для каждого id существует гибкая настройка параметров шильдика (текстов, кнопок и диплинков по ним)` - как я понимаю, здесь имеется в виду, что для каждого id цели. В предположении, что это все будет делаться на бекенде, опустим это сейчас.
- `[2.15] мы умеем управлять "бесячестью" шильдика, т.е показываем его не каждый раз; для каждого id цели есть свой "конфиг" который позволяет раскрывать шильдик по умолчанию в зависимости от параметров:` - аналогично с предыдущим пунктом, на бекенде будет сделано, может не в рамках MVP.


- `[3.1] После завершения поездки каждый раз показываем шильдик с прогрессом без кнопки` - такой шильдик будет реализован через шаблоны totw, как делали догоняющий кешбэк. Только в данном случае из plus будет ходить в сервис cashback-levels за шаблонами для юзера для шильдика (будет отдельная ручка, в которую будет ходить сервис шильдиков за шаблонами).
- `[3.2] Тап на любую область шильдика, кроме кнопки, ведёт на карточку цели` - в настройках шильдика будет диплинк на карточку цели
- `[3.3] После того, как цель завершена, шильдик не разворачивается — показывается нативный экран завершения цели` - решаться будет на бекенде. В этом кейсе просто не вернем шаблоны из totw и шильдики не покажутся.
