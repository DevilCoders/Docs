# Домик Плюса

В [предыдущей проработке](https://github.yandex-team.ru/taxi/rfc/pull/504) были следующие договорённости:

> ...
> - для домика Плюса и любой информации о подписки необходимо будет создать новую архитектуру (кэш над балансом, ручка для домика Плюса), так как сейчас информация получается из разных мест для формирования одной сущности
> - при создании так называемой архитектуры для домика Плюса, мы выпилим логику из клиентов и полностью перенесём её на бек
> 
> О переезде на новую архитектуру читайте в следующих проработках...

Данная проработка является тем самым долгожданным продолжением.

- [О фильме](#о-фильме)
- [Требования](#требования)
- [Интеграция других сервисов](#интеграция-других-сервисов)
- [Прелюдия](#прелюдия)
- [Авторизационная прокси (`passport-authproxy`)](#авторизационная-прокси-passport-authproxy)
- [Ручки](#ручки)
- [Архитектура](#архитектура)
  - [Доменная модель](#доменная-модель)
  - [Потоки данных](#потоки-данных)
- [Настройка под сервисы](#настройка-под-сервисы)
- [Клиентские метрики](#клиентские-метрики)
- [Это может быть интересно](#это-может-быть-интересно)
- [Behind The Scenes](#behind-the-scenes)

## О фильме

Необходимо продумать взаимодействие между беком и Плюсовым SDK (**домика Плюса** на клиентах, etc).
Также нужно перенести логику отображения элементов домика Плюса с клиентов на бек.

| <img src="https://jing.yandex-team.ru/files/erakli00/sdk-newbee.png" width="300"> | <img src="https://jing.yandex-team.ru/files/erakli00/sdk-overview.png" width="300"> | <img src="https://jing.yandex-team.ru/files/erakli00/sdk-discount.png" width="300"> |
| --------------------------------------------------------------------------------- | :---------------------------------------------------------------------------------: | ----------------------------------------------------------------------------------- |
|                                                                                   |                                  Домик Плюса в SDK                                  |                                                                                     |

Предлагается ряд изменений в существующей архитектуре Плюса.
Основным потребителем вносимых изменений будет являться разрабатываемое SDK для мобильных клиентов (iOS - [ITAXI-7991](https://st.yandex-team.ru/ITAXI-7991), Android), а также веб (если у них будет SDK или виджет, но это в будущем).

## Требования

- возможность встраивания SDK в приложения других сервисов, где недоступны креденшиалы Такси (user_id, phone_id, etc)
- управление структурой меню плюса (отображаемые элементы, их стиль)

## Интеграция других сервисов

Необходимый минимум, который требуется от сервисов, которые хотят интегрировать Плюсовое SDK себе:

- интеграция с Паспортом
- интеграция с Трастом

Таким образом, мы не будем сами предоставлять никакой платёжной информации (методы оплаты, общение с Трастом, etc) в инфраструктуре Плюса, а только использовать трастовый `payment_method_id` при покупке подписки (через Медиабиллинг).
Также мы закладываемся на использование Паспортных авторизационных данных (OAuth токен, `Session_id` кука - всё, что позволит нам получить паспортный `yandex_uid`).

Чтобы гарантировать наличие способа оплаты, на клиентах будет реализована логика, по которой сам потребитель будет форсить клиента привязать карту при её отсутствии.

## Прелюдия

Сформулируем конечный продукт (с точки зрения бекенда, UI элементы выходят за рамки данной проработки), который бы мы хотели бы получить в разрезе этапов.

Первый этап (MVP):

- баланс кошелька
- сторизы
- информация о подписках
- продление подписки за баллы
- покупка подписки
- апгрейд скидочной подписки
- композитная оплата

Второй этап:

- админка для сервисов
- кастомные действия в сервисах

Третий этап:

- показываем нотификации
- умеем работать с QR-оплатой

## Авторизационная прокси (`passport-authproxy`)

Для того, чтобы клиентские приложения других сервисов могли осуществлять запросы к нашим бекендам, была написана новая авторизационная прокся - `passport-authproxy` ([TAXIBACKEND-30321](https://st.yandex-team.ru/TAXIBACKEND-30321)).
Для неё не нужны таксичные креденшиалы, авторизацию будем осуществлять по **паспортным OAuth токенам** (для приложений) и по **паспортной сессионной куке** (`Session_id`, для веба).
Таким образом, мы будем закрывать все ручки для SDK новой прокси.

Помимо этого, для работы SDK из приложений других сервисов **необходимо, чтобы все задействованные ручки работали без таксишных креденшиалов** (`user_id`, `phone_id`, etc).

## Ручки

Как было сказано ранее, все ручки, которые будут участвовать во взаимодействии с SDK, не должны зависеть от таксишных креденшиалов (user_id, phone_id, etc).

Все существующие ручки предлагается оставить в сервисе `plus` и дёргать их оттуда.
Для новых ручек предлагается создать **новый сервис**, который будет хранить в себе бизнес логику, а также настройки для сервисов.

Все ручки будут спрятаны за `passport-authproxy`.

> Данные, которые прокидывает данная прокси через хедеры можно посмотреть на [вики][link-pap-headers].

[link-pap-headers]: https://wiki.yandex-team.ru/taxi/backend/taxi-product-discovery/services/passport-authproxy/#m-routingzaprosovdobekendov

| Ручка                        | Существующая ручка                     | Меняющая? |
| ---------------------------- | -------------------------------------- | :-------: |
| Покупка Плюса                | `POST /plus/v1/subscriptions/purchase` |    да     |
| Отмена подписки на Плюс      | `/plus/v1/subscriptions/stop`          |    да     |
| Апгрейд скидочного Плюса     | `/plus/v1/subscriptions/upgrade`       |    да     |
| Обновление настроек Плюса    | `/plus/v1/subscriptions/settings`      |    да     |
| Инициализация SDK            | `-` (новая ручка)                      |    нет    |
| Информация о текущей покупке | `GET /plus/v1/subscriptions/purchase`  |    нет    |

> Описание новой ручки расположено [в соседнем файле](./new-handles.md).

Какие входные данные нужны для этих ручек:

- "Покупка Плюса"
  - `yandex_uid`
  - remote IP
  - `subscription_id`
  - `payment_method_id`
- "Отмена подписки на Плюс"
  - `yandex_uid`
  - `subscription_id`
- "Апгрейд скидочного Плюса"
  - `yandex_uid`
  - remote IP
  - Pass Flags (ya-plus, cashback-plus)
  - `phone_id` (кажется совсем не обязательно)
  - `application`
- "Обновление настроек Плюса"
  - `yandex_uid`
  - сами настройки
- "Информация о текущей покупке"
  - `yandex_uid`
  - remote IP
  - `purchase_id`

Данные, которые должен присылать клиент:

- `payment_method_id` - трастовый способ оплаты. В случае, если у клиента нет возможности получать трастовые способы оплаты и использовать их, то мы не сможем осуществлять покупку подписки.
- `subscription_id` - может быть получено из ручки "Получение текущего состояния пользователя".
- `purchase_id` - может быть получено из ручек "Получение текущего состояния пользователя" и "Покупка Плюса" (при успешной покупке).
- `application`
- `language`

Данные которые мы получим от бекендов (`passport-authproxy`, `nginx`, etc):

- `yandex_uid`
- remote IP (`nginx`)
- Pass Flags (ya-plus, cashback-plus)

## Архитектура

### Доменная модель

Предлагается следующая доменная модель.

| <img src="https://jing.yandex-team.ru/files/erakli00/domain-models.png" width="800"> |
| :----------------------------------------------------------------------------------: |
|                                   Доменная модель                                    |

> На данной схеме модели объединены в логические группы для удобства.
> Сущности физически будут разнесены между разными сервисами и приложениями.
> 
> Например, **пользовательские настройки** для конкретных сервисов (`UserPreferences`) могут храниться на каждом конкретном устройстве независимо для каждого приложения (Такси, Драйв, Афиша, etc), а **настройки подписок** (`SubscriptionSettings`) - в сервисе `plus`.

Представленная модель нужна только для общего описания компонент.
Реальный формат данных может отличаться.

Из модели очевидно, что мы имеем следующие виды данных:

- специфичные для сервиса (ссылки, рестораны, deeplink'и)
- специфичные для пользователя в сервисе (композитная оплата)
- специфичные для подписки пользователя (наличие подписки, настройки подписки)

Специфичные для сервиса настройки будут определять вид домика Плюса.

Каждый сервис будет независимо определять доступные пользовательские настройки (дефолтное значение, отображаемое название, доступность).
Например, предположим, что Афиша первое время не будет позволять использовать композитную оплату.
В таком случае мы будем иметь следующую настройку (псевдопротокол):

```json5
{
    "id": "composite_payment",
    "display_name": "Платить за билеты баллами",
    "enabled": false,
    "available": true,
    "value": {
        "type": "boolean",
        "default": false
    }
}
```

Данный пункт будет отображён задизейбленным для всех пользователей, независимо от наличия подписки.
Выглядеть это будет как на следующей картинке:

<img src="https://jing.yandex-team.ru/files/erakli00/plus-menu.png" width="300">

Далее SDK будет передавать значение этой настройки в соответствующие запросы (подробнее ниже).

Настройки для сервиса также будут определять, какие пункты меню будут отображаться в домике Плюса.
Например, настройки сервиса отвечают за наполнение кнопки QR-оплаты и списка ресторанов, а также за порядок и вид элементов меню.

<img src="https://jing.yandex-team.ru/files/erakli00/menu-sections.jpg" width="400">

### Потоки данных

На текущий момент можно выделить следующие потоки данных в рамках взаимодействия `SDK - backend`:

1. Инициализация SDK
2. Покупка Плюса
3. Апгрейд скидочного Плюса
4. Обновление пользовательских настроек
5. Получение текущего состояния пользователя

Подробнее см. [data-flows](./data-flows.md).

## Настройка под сервисы

Отображаемая информация будет зависеть от:
- экспериментов
- сервиса (Такси (Go), Драйв, Афиша, Беру...)
- наличия и вида пописки
- балансов (есть ли баллы на счету)
- etc

Чтобы менять настройки в зависимости от сервиса, необходимо иметь конфигурацию с по-сервисными настройками.
На первом этапе (MVP) настройки можно будет хранить **в конфиге**, но далее скорее всего понадобиться какая-нибудь админка с доступом для менеджеров других сервисов.

К числу данных, которые могут зависеть от сервиса, относятся пункты меню.
Сторизы управляются через собственную админку.

В дальнейшем предлагается регистрировать новые сервисы через данную админку. 
При регистрации будет формироваться какой-нибудь идентификатор сервиса (приложения), для которого будут задаваться конкретные настройки (отображения, доступности настроек, etc).

На этапе MVP идентификатор будет задаваться хардкодом как в конфигах, так и на клиентах.

## Клиентские метрики

Работа с метриками должна полностью происходить в SDK.
Необходимые метрики нужно придумать вместе с клиентами. 

// TBD

## Это может быть интересно

- кнопки QR-оплаты ([TAXIMOBILEDEV-157](https://st.yandex-team.ru/TAXIMOBILEDEV-157))

## Behind The Scenes

Приблизительный скоуп следующий.

> Более актуальный стоит смотреть в тикете - [TAXIBACKEND-30375](https://st.yandex-team.ru/TAXIBACKEND-30375).

Первый этап (MVP)

- завести новый сервис
- завести конфигурацию под сервисы на конфигах
  - хардкод клиентских приложений
- реализовать получение состояния
  - получение балансов
  - получение настроек пользователя
  - получение подписок
  - обогащение настроек в зависимости от сервиса
- реализовать получение структуры меню
  - элементы меню
  - секции
  - кнопки покупки/апгрейда
  - фоллбек структура
- добавить ручку инициализации
- спрятать ручки покупки, апгрейда и настроек за `passport-authproxy`

Второй этап

- фолбеки при недоступности источников в ручке состояния
- админка для сервисов
  - регистрация новых приложений
  - настройка по сервисам
- поддержка capabilities в ручках
  - qr-оплата

Третий этап

- нотификации
