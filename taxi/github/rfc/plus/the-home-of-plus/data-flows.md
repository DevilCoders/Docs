# Потоки данных

В данном документе рассматриваются основные потоки данных.

- [Необходимые параметры](#необходимые-параметры)
- [Инициализация SDK](#инициализация-sdk)
  - [Фолбеки при проблемах инициализации](#фолбеки-при-проблемах-инициализации)
- [Покупка Плюса](#покупка-плюса)
- [Апгрейд скидочного Плюса](#апгрейд-скидочного-плюса)
- [Обновление пользовательских настроек](#обновление-пользовательских-настроек)
- [Получение текущего состояния пользователя](#получение-текущего-состояния-пользователя)
  - [Фолбеки на источники данных](#фолбеки-на-источники-данных)

## Необходимые параметры

Для любого флоу необходимыми параментрами со стороны SDK являются:

- паспортный OAuth токен с соответствующими скоупами
- идентификатор сервисного приложения

Идентификатор необходим для определения сервиса (Такси, Афиша, etc).

## Инициализация SDK

Базовый флоу инициализации SDK выглядит следующим образом:

<img src="https://jing.yandex-team.ru/files/erakli00/base-flow.png" width="900">

В изначальном виде предполагается, что будет происходить 2 запроса:

- получение UI информации (структура меню домика Плюса, кнопки) и текущего состояния пользователя
- сторизы

Инициализация может происходить с низким приоритетом в фоне после запуска приложения.

В случае Такси добавлять новые запросы будет расточительно.
По этой причине в одном из будущих обновлений SDK нужно подержать два режима инициализации: самостоятельная инициализация (описанная выше) и инициализация внешними данными.

Второй вариант будет необходим как минимум для приложения Такси.
В этом варианте предлагается возвращать информацию для инициализации SDK в ручке `launch` и хостовое приложение должно будет передать эти данные в SDK.

Предлагается на этапе MVP не делать внешнюю инициализацию.

> Также ре-инициализация SDK должна происходить при глобальной смене состояния пользователя (покупка подписки, апгрейд подписки), а также при открытии домика Плюса.

Подробнее про процесс инициализации см. [описание новой ручки](./new-handles.md).

### Фолбеки при проблемах инициализации

Для инициализации SDK есть критиные и не-критичные данные и запросы.
Предлагается следующая схема.

- Если ответ всех стартовых ручек 200, то показываем точки входа SDK в нативе.
- Если ручка инициализации SDK ответила не 200, показываем дом Плюса в информационном режиме (покупка подписки, баланс и информация о подписках недоступны).
- Если ручка сторизов ответила не 200, не показываем сторизы.
- Во всех остальных случаях не показываем точки входа SDK.

Предполагается, что клиенты будут пытаться ретраить неуспешные запросы и в случае тотального неуспеха предлагать загрузить данные позднее.

## Покупка Плюса

Здесь всё остаётся как и раньше.

Если мы получили кнопку при инициализации при инициализации SDK, то она отображается в интерфейсе.
В этом случае можно будет купить Плюс.

<img src="https://jing.yandex-team.ru/files/erakli00/buy-plus.png" width="900">

После покупки SDK должно поллить статус покупки.

## Апгрейд скидочного Плюса

Остаётся как и раньше, аналогично покупке.

## Обновление пользовательских настроек

Для обновления настроек предлагаются следующие условия:

- на клиенте зашиваются ручки обновления настроек (подписки, сервисные настройки)
- в ручке с UI-наполнением присылаются пункты меню с ID изменяемой настройки и её типом, параметры её отображения (в зависимости от настроек сервиса)
- в ручке пользовательского состояния присылаются значения настроек пользователя с ID и доступностью для изменения
- при изменении настройки на клиенте, SDK дёргает ручку настроек в зависимости от её типа
- при совершении каких либо действий, где нужны эти настройки, хостовое приложение должно узнать значение настройки у SDK

<img src="https://jing.yandex-team.ru/files/erakli00/settings-update.png" width="900">

> Если SDK не может найти в обеих ручках необходимые данные для отображения, оно должно скрыть настройку.

> Вместо двух ручек у нас будет одна.

Подробный протокол описан в файле [new-handles](./new-handles.md).

## Получение текущего состояния пользователя

> Теперь это легковесный ответ ручки инициализации SDK.

SDK должно использовать ручку текущего состояния при любом отображении информации, связанной с подпиской (балансы, статус подписки, настройки, etc).

<img src="https://jing.yandex-team.ru/files/erakli00/state.png" width="900">

### Фолбеки на источники данных

В случае, если не работает какой-то из источников данных, необходимых для отображения, мы можем не фейлить весь запрос, а просто отключать некоторые данные.
Например, если не работает `plus-wallet`, то отвечаем информацией о подписках, а в секции `wallet` передаем заглушку c технической информацией для SDK.
SDK по этой информации через некоторый таймаут (который в ней написан) ретраит ручку, а в интерфейсе баланса рисует какой-то спиннер. 
Если что-то совсем сломалось и ретраи не помогают - говорим пользователю что балансы сейчас недоступны, попробуйте позже.

Аналогично для Медиабиллинга мы не сможем предложить покупку или узнать, какая у пользователя сейчас подписка.
Зато в качестве фоллбека будет информация от `passport-authproxy`, благодаря которой мы точно узнаем, что у пользователя есть подписка.

Подробный протокол описан в файле [new-handles](./new-handles.md).
