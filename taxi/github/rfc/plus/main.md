## Бизнесовая задача

### Описание

[Продуктовое описание](https://st.yandex-team.ru/TAXIPROJECTS-866)

Глобальная цель -- растить активность пользователей. 
Один из самых эффективных инструментов - это Плюс (рост поездок на 2,5%). Поэтому нам необходим растить долю пользователей с плюсом, а значит нужно:
+ продавать больше Плюса
+ снижать долю отписавшихся от Плюса

### Гипотеза

Продажа плюса нативно позволит увеличить общее количество подписок.
Общее количество подписок позволит вырастить число поездок.

### Дизайн

Ссылка на [дизайн](https://www.figma.com/file/eY5J1JznYJKgX4plN0fmG4q1/Плюс%3A-валюта-и-подписка?node-id=2578%3A173)
![Дизайн](https://jing.yandex-team.ru/files/rgnlax/design.png "Design")

### Продуктовые задачи

#### Информация о возможных подписках

Необходимо давать информацию пользователю о том, какие подписки в данный момент доступны для него.
Предполагается, что за доступными подписками надо ходить в медиабиллинг.
Возвращать их планируется в launch.


#### Информация о бонусах за подписку

Информация о том, какие бонусы предлагаются за конкретную подписку.
Первое время будет только информация за подписку "Плюс"

![Дизайн](https://jing.yandex-team.ru/files/rgnlax/subscription.png)

Бонусы будут хранится на нашем бекенде, предлагается воспользоваться контентом из конфига [YAPLUS_SUMMARY_PROMO_BANNER_SETTINGS_BY_COUNTRY](https://tariff-editor.taxi.yandex-team.ru/dev/configs/edit/YAPLUS_SUMMARY_PROMO_BANNER_SETTINGS_BY_COUNTRY)
Цену за подписку будет брать из ответа медиабиллинга.


#### Продвижение подписки на саммари

На саммари можно продвигать продажу подписки, если стоимость за месяц будет меньше или равна скидке по подписке.
Например цена за комфорт сейчас 1700 рублей, скидка за подписку 10% (170 рублей), стоимость подписки 169 рублей.
В этом случае можно показать пользователю предложение купить подписку и тут же поехать, пользователь ничего не потеряет.
Для неавторизованных пользователей ничего не показываем

![Дизайн](https://jing.yandex-team.ru/files/rgnlax/promo.png)

Предлагается простое решение:
1. Сделать плагин для продвижения плюса
2. В тело соответствующего эксперимента 3.0 положить текст и цену


#### Оформление подписки

Если у юзера все еще нет подписки Плюс, он может захотеть оформить ее прямо через приложение.
Мы должны дать возможность ему это сделать нативно при нажатии на кнопку подписаться
![Дизайн](https://jing.yandex-team.ru/files/rgnlax/subscription.png)

Далее возможны варианты:
1. Если у юзера одна привязанная карта, то сразу попытаться оформить подписку.
2. Если у юзера более одной карты, то предоставить ему выбор.
3. Если у юзера нет ни одной карты, то показать экран со списком оплаты.

После этого приложение идет в ручку оформления подписки с идентификатором подписки и выбранным способом оплаты.
В ответ в ручке оформления получает идентификатор платежа.

Данный идентификатор далее приложение поллит до перехода в терминальный статус.

![Дизайн](https://jing.yandex-team.ru/files/rgnlax/payment.png)


#### Управление подпиской

Пользователь может захотеть посмотреть состояние своей подписки и управлять ей.
Первоначально предоставим управление через вебвью

![Дизайн](https://jing.yandex-team.ru/files/rgnlax/manage.jpg)

#### Уведомления 

При привязке фониша к порталу подписку необходимо переносить на портал.
Возможны варианты:
1. На фонише и на портале нет подписки -- ничего не делать
2. На фонише есть подписка, на портале нет -- перенести подписку на портал и показать уведомление
3. На фонише нет подписки, на портале есть -- показать уведомление "Ура есть подписка"
4. На фонише есть подписка, на портале есть подписка -- выбрать подписку которую нужно отменить и показать уведомление

**Сервис promitions не поддерживает realtime нотификации.
Нотификации придется делать своими силами**

## Архитектура

### Высокоуровневая архитектура
![Архитектура](https://jing.yandex-team.ru/files/rgnlax/arch.png)

### Влияние на цикл заказа

На цикл заказа не влияет

### Компоненты

#### Сервис `api-proxy`

- Правка в `/3.0/launch`

Предполагается, что ручка launch должна возвращать список доступных подписок для пользователя.
Для этого launch будет ходить во внутреннюю ручку списка подписок.

#### Сервис `plus`

**Клиентские ручки**


- Ручка `/4.0/plus/v1/subscriptions/info?subscripiton_id=<>`

Информация о бонусах за подписку. Когда юзер хочет увидеть, какие бонусы
предлагаются за конкретную подписку, приложение ходит в данную ручку с идентификатором подписки.

Ручка возвращает список бонусов.

Алгоритм работы:
1. Достать информацию о бонусах из конфига по идентификатору подписки.
2. Смаппить subscription_id в медибиллинговый subscription_id.
3. Сходить в ручку transitions и получить цену за подписку.


- Ручка `/4.0/plus/v1/subscriptions/submit`

Когда юзер покупает подписку, клиентское приложение ходит в эту ручку и передает
информацию о том, какую подписку юзер покупает и каким способом оплаты будет оплачивать.

Ручка возвращает purchase_id, которое приложение должно поллить, чтобы узнать статус платежа.
Ручка идемпотентна по subscription_id

Алгоритм работы:
1. Смаппить subscription_id в медибиллинговый subscription_id.
2. Сходить в ручку submit-native-product медиабиллинга и получить purchase_id
3. Вернуть purchase_id клиенту для поллинга


- Ручка `/4.0/plus/v1/subscriptions/purchase_info`

Чтобы узнать статус покупки, клиенсткое приложение ходит в эту ручку с purchase_id.
Ручка возвращает статуса покупки - в процессе, успех или не успех.

Алгоритм работы:
1. Сходить в ручку order_info медиабиллинрга c purchase_id
3. Вернуть status клиенту


**Внутренние ручки**


- Ручка `/internal/v1/subscriptions/list`

Сервис api-proxy ходит в эту ручку для информации о подписках пользователя. 
Предполагается что эта ручка будет ходить в медиабиллинговую ручку transtitions за возможными подписками, 
а затем маппить полученные подписки во внутренние идентификаторы и возвращать клиенту.

Чтобы сходить в ручку transitions нужно знать ip адреса пользователя и uid, эти параметры можно получить из Passenger Authorizer.

Алгоритм работы:
1. Понять ip и uid пользователя.
2. Сходить в ручку transitions медиабиллинга с таргетом taxi и получить доступные подписки.
3. Смаппить медибиллинговые product_id в таксишные, отсеять недоступные.
4. Вернуть ответ клиенту.


- Ручка `/internal/v1/zalogin/handle`

Когда произошла привязка фонишного аккаунта к портальному, подписку необходимо перенести на портал, для 
этого сервис zalogin ходит в эту ручку, чтобы сообщить о том, что произошло.

Алгоритм работы:
1. Понять uid фониша и uid портала
2. Сходить в ручку transfer-native-subscription медиабиллинга 
3. Добавить уведомление для пользователя


#### Сервис `protocol`

- Ручка `/3.0/routestats`

Когда скидка по подписке за тариф дешевле, чем стоимость подписки за 1 месяц, в routestats добавляется брендинг предложения покупки плюса.
Необходимо также учитывать, что у клиента еще нет подписки Плюс.

### API

#### Медиабиллинг
Протокол медиабиллинга: https://wiki.yandex-team.ru/mb/music-billing-ruchkas/

#### Сервис `protocol`

- Ручка `/3.0/routestats`

Добавляется branding:
```json
{
    "brandings": [
        {
            "action": "",
            "title": "Поездка может стоит на 480 дешевле -- с подпиской на Плюс",
            "type": "plus_promo"
        }
    ]
}
```


#### Сервис `Plus`

Протоколы примерные, конечная спецификация будет реализована в формате OpenAPI.

- Ручка GET `/4.0/plus/v1/subscriptions/info?subscripiton_id=yandex_plus_ru`

Request:
- subscription_id

Response:
```json
{
    "subscription_id": "yandex_plus_ru",

    "title": "Подписка это",
    "subtitle": "<>Первый месяц бесплатно,<> потом за 169Р.",

    "brandings": [
        {
            "type": "cashback",
            "icon": "",
            "title": "Больше кэшбэка"
        }
    ],

    "currency_rules": {},
    
    "features": [
        {
            "title": "Скидка 10%",
            "subtitle": "Такси",
            "type": "taxi",
            "icon": ""
        }
    ]
}
```

- Ручка POST `/4.0/plus/v1/subscriptions/submit?subscripiton_id=yandex_plus_ru`

Request
```json
{
    "payment": {
        "type": "card",
        "method_id": ""
    }
}
```

Response
```json
{
    "purchase_id": ""
}
```


- Ручка GET `/4.0/plus/v1/subscriptions/payment_info?purchase_id=4ff4f1f5ddac415bbb`

Response:
```json
{
    "purchase_id": "4ff4f1f5ddac415bbb",
    "status": "pending"
}
```

- Ручка `/internal/v1/subscriptions/list`

Response:
```json
{
    "manage_url": "<url для управления подписками>",
    "allowed_subscriptions": [
        {
            "subscription_id": "yandex_plus_ru"
        }
    ],
    "pending_subscriptions": [
        {
            "purchase_id": ""
        }
    ]
}
```

- Ручка `/internal/v1/zalogin/handle`

Request:
```json
{
  "portal_uid": "",
  "phonish_uid": ""
}
```


### Нагрузка

#### Нагрузка на `plus`

- Ручка `/4.0/plus/v1/subscriptions/info?subscripiton_id=<>`
< 200 rps

- Ручка `/4.0/plus/v1/subscriptions/submit`
< 50 rps

- Ручка `/4.0/plus/v1/subscriptions/payment_info`
< 50 rps

- Ручка `/internal/v1/subscriptions/list`
600 rps

- Ручка `/internal/v1/zalogin/handle`
< 100 rps


#### СУБД

Использование СУБД не планируется

#### Используемые сервисы

1. Используется внешний сервис Медиабиллинга.
2. Про идемпотентность конкретной ручки в описании ручки.
3. При отказе сервиса медиабиллинга сервис plus перестает возвращать доступные подписки и стоимость подписки.
Больше всего пострадают ручки списка подписок и информации о подписках.
Также нельзя будет купить подписку.
4. Ретраи внешних сервисов будет организованы через QOS конфиг

### Клиентская логика

1. Web-vew будет использоваться для управления подпиской.
2. На старте клиенсткое приложение дергает launch для получения информации о доступных подписках. Далее при открытии соответсвующего экрана и при желании оформить подписку.
3. Ретраи стандартные
4. Все неоходимые тексты будут приходить с сервера.

### Отказоустойчивость

Будет реализован:
- Клиентский эксперимент нативной покупки
- Конфиг отключения клиентских ручек PLUS_SERVICE_ENABLED
- Эксперимент для плавной раскатки списка подписок в launch

### Мониторинги, алерты, бизнесовые графики, логи

1. Дашборд nanny_taxi_plus_stable.
2. Мониторинг стандартный.
3. Алертинг стандарный
4. Метрики: количество проданных подписок.
5. Репликация логов в YT

### Технические ограничения

- MVP на моках и конфигах означает, что мы храним идентификаторы подписок в конфигами и не ходим в медиабиллинг.
Таким образом, за актуальностью надо следить. Также мы не сможет следить какая подписка уже есть, а какой еще нет.

- Наши ручки списка подписок и информации о подписке напрямую ходят в медиабиллинг, следовательно медиабиллинг для нас это точка отказа.
Если это будет большой проблемой - потребуется доработка для написания кеша.

### Этапы

#### Этап 1. MVP на моках и конфигах

_Продвижение продажи плюса_ - **2d**
1. Правки в routestats - 2d

_Миграция подписки при залогине_ - **3d**
1. Подключение к залогину - 1d
2. Внутренняя ручка миграции - 2d

_Информация о возможных подписках_ - **3d**
1. Интеграция с api-proxy - 1d
2. Внутренняя ручка списка подписок - 2d
 
_Информация о бонусах за подписки_ - **2d**
3. Конфиг с информацией о бонусах - 2d

_Оформление подписки_ - **3d**
1. Клиент медиабиллинга - 1d
2. Клиентская ручка оформления подписки - 1d
3. Клиентская ручка поллинга статуса подписки - 1d

_Продуктовые метрики_ - **2d**
1. Подключение к solomon - 2d 

_Раскатка_ - **1d**
1. Раскатка - 1d


#### Этап 2. Раскостыливание моков

_Информация о возможных подписках_
1. Интеграция с медиабиллингом - 3d
 
_Информация о бонусах за подписки_
1. Интеграция с медиабиллингом - 3d

_Уведомления_ - **?**


#### Этап 3. Отказоусточивость

_Информация о возможных подписках_
1. Кеширование ответа медиабиллинга
 
_Информация о бонусах за подписки_
1. Кеширование ответа медиабиллинга


### Как раскатываем

#### Раскатка этапа 1

1. Эксперимент native_plus на клиенте.
2. Конфиг PLUS_SERVICE_ENABLED на бекенде.
3. Эксперимент native_plus_enabled на бекенде


### Безопасность

1. Подключение к takeout не планируется.
2. Персональные данные не используются
