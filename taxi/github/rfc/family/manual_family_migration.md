# Ручная миграция семьи в Я.Паспорт

## Цель

Наша цель перевести все таксишные семьи в Я.Паспорт. При этом хочется как можно более бесшовный переход, который будет понятен и владельцам семей, и участникам.

## Проблема

[Автоматически перевести таксишные семьи в Я.Паспорт](from_taxi_to_passport.md#переезд-акка-в-паспорт-backend) получится далеко не все. Существует большое количество сценариев, когда бесшовный перевод не произойдет и нам нужно чтобы пользователь узнал о нём и принял решение.

После автоматической миграции сталкнемся со следующей картиной:
![image](static/family_migration_matrix.png)

Видно, что проблема есть только у владельцев таксишных семей, которые не удалось по каким-то причином перевести в Я.Паспорт. 

## Решение

Что хочется соблюсти:
1. Хотим давать пользоваться таксишным семейным способом оплаты участникам, до миграции. Т.е. чтобы не получилось ситуации, когда старого семейного счета уже нет, а новый еще не появился.
2. В меню оставить один пункт семейного аккаунта, который будет вести в новую семейность. В проблемных случаях описываем ситуацию и даем пользоваться семейностью только после принятия решения.

Все проблемные сценарии могут быть связана только с владельцами таксишных семей, их разбиваем на 3 группы: "у пользователя нет паспортной семьи", "пользователь является участником паспортной семьи", "пользователь является владельцем паспортной семьи". Если владелец семьи попадает на экран новой семейности и он попал в одну их этих групп, мы информируем о проблеме и предлагаем решение. Каждая группа обрабатывается по-своему:

### У пользователя нет паспортной семьи

![image](static/create_family_account.png)

Мы по какой-то причине не смогли автоматически создать семью в Паспорте, поэтому будем просить об этом пользователя. Сразу предлагаем решить каких участников Таксишной семьи владелец хочет перенести в Паспорт. 
Автоматически выбираем всех участников (поскольку в Таксишной семье тоже число участников, что и в Паспортной), пользователь может снять какие-то галки вплоть до всех и нажать продолжить. 

После согласия происходят следующие действия:
1. Создается паспортная семья
2. Добавляются сразу выбранные участники (если возможно) либо им отправляется инвайт
3. Таксишная семья считается смигрированной


### Пользователь является участником паспортной семьи

![image](static/select_family_account.png)

Тут фактически предлагаем два варианта: либо остататься участником паспортной семьи и удалить таксишную, либо выйти из паспортной семьи и создать новую паспортную с тем же состатов, что и таксишная. Автоматически предлагаем остаться с текущей паспортной семьей. Выбор семьи работает как radio button, выбираем другую - ставится галка, с предыдущей галка слетает.

Если пользователь соглашается остаться участником:
1.  Таксишная семья считается смигрированной (наверно, нужно удалить / заблокировать)

Если пользователь соглашается остаться с Таксишной семьей:
1. Пользователь выходит из паспортной семьи
2. Ему создается паспортная семья
3. Добаляются сразу все участники таксишной такси (если возможно) либо им отправляется инвайт
4. Таксишная семья считается смигрированной

### Пользователь является владельцем паспортной семьи

![image](static/update_family_account.png)

Фактически хотим обновить состав паспортной семьи, предлагая удалить кого-то из Паспортной и добавить кого-то из Таксишной семьи. Для этого отображаем всех участников объединения паспортной и таксишной семьи без повторов. Выделяем участников паспортной семьи, отображаем число уже выбранных и сколько всего можно выбрать. 
Если у пользователя есть отправленные инвайты, то выбрать можно меньше. Поясняем этот сценарий. 

Когда выбрано N из N участников, выбирать больше не даем блокируя выбор, но снять галку можно и выбрать другого участника.

Отдельно рассматриваем сценарий, когда у пользователя в Я.Паспорт нет участников и все инвайты разосланы, поэтому пригласить кого-то он не может. В этом случае пишем другой поясняющий текст и текст на кнопке. Отображаем участников таксишной семьи, без контролов выбора (просто чтобы пользователя проинформировать кто был в таксишной семье)

После согласия происходят следующие действия:
1. Удаляются участники из паспортной семьи, если пользователь снял выделение с них
2. Добаляются сразу все новые участники таксишной такси (если возможно) либо им отправляется инвайт 
3. Таксишная семья считается смигрированной

## API

Информация о том, что ситуация требует миграции приходит в ручке `/4.0/family/v1/launch`

```json
{

    ...
    "family_migration": {
        "title": "Проверьте участников, которые будут в Семье", // обязательное
        "subtitle": "Выбрано $$SELECTED_MEMBERS_COUNT$$ из $$MAX_SELECTED_MEMBERS_COUNT$$ возможных.", // обязательное
        "button_text": "Выбрать", // обязательное
        "collision": {
            "type": "...",  // тип коллизии с полями, характерными для нее
            ...
        }
    }
    ...
}
```

`family_migration` приходит владельцу не смигрировавшей таксишной семьи при включенном для пользователя эксперименте family_group_v2. Бекенд присылает `family_migration` до тех пока пока не случится ручная миграция (либо в будущем мы принудительно удалим таксишные семьи и конфликт будет разрешен, но пока не знаем когда это случится)

Получая этот признак фронт знает, что нужно отобразить новый блокирующий экран миграции (и это имеет наивысший приоритет перед другими состояниями).

### Type: select_members

Коллизия "У пользователя нет паспортной семьи" или "Пользователь является владельцем паспортной семьи". Пользователю нужно выбрать участников и согласиться с выбором. В ручке `/4.0/family/v1/launch` придет ответ

```json
{
    ...
    "family_migration": {
        "title": "Проверьте участников, которые будут в Семье", // обязательное
        "subtitle": "Выбрано $$SELECTED_MEMBERS_COUNT$$ из $$MAX_SELECTED_MEMBERS_COUNT$$ возможных.", // обязательное
        "button_text": "Выбрать",

        "collision": {
            "type": "select_members", // Случай "У пользователя нет паспортной семьи" и "Пользователь является владельцем паспортной семьи"
            "members": [ // список участников
                { 
                    "id": "214143", // id, обязательное поле
                    "title": "Данила", // обязательно, тайтл участника, например имя
                    "details": "+79018343204", // обязательно, детали, например, телефон
                    "is_selected": false // выбран ли данный участник, обязательное
                }
            ],
            "max_selection_count": 3 // обязательное, число доступных инвайтов, может быть 0
        }
    }
    ...
}
```

`max_selection_count` - означает сколько аккаунтов может быть выбрано, если приходит значение 0, то не отображаем контролы выбора у участников.

![image](static/upgrade_family_account_max_selection_0.png)

В противном случае позволяем выбрать не более чем max_selection_count участников.
Когда пользователь соглашается с выбором дергаем ручку `/4.0/family/v1/apply_migration`

```json
{
    "collision": {
        "selected_members_ids": [ // обязательное, id выбранных участников (в момент нажатия на кнопку)
            "member 1 id", 
            "member 2 id"
        ]
    }
}
```
### Type: select_family

Если имеем коллизицию типа "Пользователь является участником паспортной семьи", то ответ будет такой

```json
{
    ...
    "family_migration": {
        "title": "Произошла коллизия", // обязатльеное
        "subtitle": "Можно оставить только одну Семью. Надо выбрать, где останетесь", // обязательное
        "button_text": "Выбрать", // обязательное

        "collision": {
            "type": "select_family", // Случай "У пользователя нет паспортной семьи" и "Пользователь является владельцем паспортной семьи"
            "families": [ // список семей 
                {
                    "type": "taxi", // обязательное поле
                    "title": "Семья Такси", // обязательное поле
                    "details": "Вы создатель", // опциональное
                    "icon_tag": "icon_tag", // опционально, если хотим иконку у семьи
                    "is_selected": false, // обязательное
                    "members": [
                        {
                            "title": "Данила", // тайтл участника, обязательно
                            "details": "+79018343204", // детали, обязательное, либо телефон, либо информация о том, что является владельцем
                        }
                    ]
                },
                {
                    "type": "passport", // обязательное поле
                    "title": "Семья ID", // обязательное поле
                    "details": "Вы участник", // опциональное
                    "icon_tag": "icon_tag", // опционально, если хотим иконку у семьи
                    "is_selected": true, // обязательное
                    "members": [
                        {
                            "title": "Данила", // тайт лучастника, обязательно
                            "details": "Владелец", // детали, обязательное, либо телефон, либо информация о том, что является владельцем
                        }
                    ]
                }
            ]
        }
    }
}
```

Когда пользователь соглашается с выбором дергаем ручку `/4.0/family/v1/apply_migration`

```json
{

    "collision": {
        "selected_family_type": "family_type" // обязательно, type выбранной семьи
    }
}
```