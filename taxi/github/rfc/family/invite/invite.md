# Приглашения в семью 2.0

## Новогодние открытки

### Главная

![image](static/summary.png)

~~Информация для показа шортката с поздравлением на саммари будет возвращаться из ручки `4.0/mlutp/products` в формате,
аналогичном остальным шорткатам. В диплинке должна быть ссылка на открытие семейного ЛК 2.0 с указанием дополнительного
параметра, чтобы была возможность определить, какая именно страница должна быть показана.~~

В итоговом решении отказались от шорткатов - коммуникации с пользователем будут выполняться через объекты на
карте/фулскрины и пр., в которых будет зашит диплинк на семейный ЛК. Параметры диплинка описаны в
задаче [TAXIMOBILEDEV-933](https://st.yandex-team.ru/TAXIMOBILEDEV-933), и имеют
вид `yandextaxi://coopaccount?type=family&action=invite&invite_type=postcard`.

В сценарии, если мы все же будем показывать два семейных кабинета, пользователя можно всегда вести во второй.

В случае, если пользователь является участником существующего паспортного семейного аккаунта, при переходе по ссылке ему
должна быть показана заглушка (**_НУЖЕН ДИЗАЙН СТРАНИЦЫ, МИША ПРОКОФЬЕВ_**). Такие ситуации можно сократить за счет
раскатывания шортката на всех юзеров, кроме участников новых семейных семей.

Условие показа заглушки для фронта - в ручке `4.0/family/v1/launch` пользователю приходит информация о семейном
аккаунте, при этом `family.owner_uid != user_uid`

Если пользователю не приходит эксперимент `family_group_v2` из ручки launch - по переходу на диплинк кидаем его в старый
ЛК.

### Новогодний экран создания семьи

![image](static/fullscreen.png)

В дизайне не хватает пользовательского соглашения (**_МИША ПРОКОФЬЕВ_**)

После перехода по диплинку шортката должна быть открыта веб-версия ЛК. Информация для отображения фулскрина будет
возвращена в одном из экспериментов ручки `4.0/family/v1/launch` (объект `typed_experiment`) в следующем формате:

```json
{
  "name": "family_new_year_2021_invite_fullscreen",
  "value": {
    "l10n": {
      "title": "Новый год - семейный праздник",
      "subtitle": "Здесь будет добрый тёплый текст",
      "button_text": "Позвать близких в Семью!",
      "privacy_policy_agreement": "Текст про пользовательское соглашение"
    },
    "background": "image_tag"
  }
}
```

Эксп нужен на случай, если захотим для разных групп пользователей показывать различные изображения.

В кнопке должен быть хардкодный экшен, который открывает нативный генератор открыток.

До тех пор, пока чекбокс не будет нажат необходимо дизейблить кнопку нажатия.

### Создание открытки

![image](static/create_invite.png)

Информация о фонах поступит на фронтенд в эксперименте, ручке `/4.0/family/v1/launch`, после чего будет проброшена на
нативный экран создания открытки. Формат экспа:

```json
{
  "name": "family_new_year_2021_invite_fullscreen",
  "postcard": {
    "backgrounds": [
      {
        "image": "image_tag",
        "color": "hex"
      }
    ],
    "text_limit": 140
    ?,
    // 140 by default, Optional
    "text_placeholder": "string",
    "choose_contact_button_title": "string",
    "empty_text_button_title": "string"
  }
]
}
```

* `image` - тэг картинки, которая должна быть показана
* `color` - HEX-код цвета, который необходимо показывать на время загрузки тэга
* `text_limit` - Лимит символов на поздравление

Подробнее в задаче https://st.yandex-team.ru/TAXIMOBILEDEV-931.

При нажатии на кнопку в правом верхнем углу должен открыться список с изображениями, полученными в эксперименте. Пока
изображения загружаются, необходимо будет показывать бэкграундный цвет.

Получателя для открытки можно выбрать только одного, чтобы использовать текущую страницу контактов в приложении.

Кнопка "Отправить поздравление" должна вести на страницу с контактами до тех пор, пока хотя бы один из них не будет
выбран.

В центральной части открытки клиент может ввести произвольный текст, длиной до `max_symbol_length` символов.

После того как текст введен и участники выбраны, клиент дает пользователю возможность нажать на кнопку создания
открытки. После нажатия открывается страница веб-кабинета с информацией об открытке.

Со стороны натива должны быть прокинуты следующие данные на фронт:

```json
{
  "image": "image_tag",
  "text": "some_text",
  "phone": "+79111111111"
}
```

* `image` - выбранный пользователем тэг бэкграунда
* `text` - введенный текс
* `phone` - номер телефона пользователя, которому необходимо отправлять инвайт

### Показ открытки отправителю

![image](static/created_invite.png)

На основании данных, полученных с предыдущего экрана веб отрисовывает открытку. На время загрузки изображения можно
показывать лоадер.

Все текстовки предлагается зашить в виде танкерных ключей на вебе.

После нажатия кнопки "Давайте" должен быть отправлен POST запрос на бэкенд в ручку `4.0/family/v1/invite/`, со следующим
телом:

```json
{
  "type": "postcard_new_year_21",
  "phone": "+79111111111",
  "image": "image_tag",
  "text": "some_text"
}
```

* `type` - тип инвайта, который будет одинаковый для всех новогодних открыток - `postcard_new_year_21`.

В случае, если пользователь превысил лимит на создание приглашений, или его семейный аккаунт уже содержит 4 аккаунта с
бэкенда будет возвращен ответ c ошибкой и текстом о том, который надо будет отобразить на клиенте в следующем формате:

```json

{
  "code": "invite_create_error",
  "message": "Превышен лимит на создание приглашений, отмените созданные на странице паспорта",
  "details": {}  // Необязательное поле, в которое по необходимости будем докидывать данные
}
```

До попытки создания приглашения нет возможности точно узнать, может ли пользователь создавать инвайты, т.к. между
моментом начала создания открытки и отправкой он может пригласить участников в свой аккаунт через паспорт.

После создания приглашения пользователю должен быть отправлен пуш с информацией о том, что его ждет инвайт и пометкой,
что их видно только в последней версии приложения. Открытие пуша должно триггерить запрос ручки `3.0/launch`.

Информация о том, что необходимо обновить страницу будет приходить в payload'e диплинка, параметры:
```json
{
  // ...
  "update_session": true
}
```

### Показ открытки получателю

![image](static/show_invite.png)

Показ инвайтов предлагается реализовать на нативе. Логика показа - если в ответе ручки `3.0/launch` приходит
объект `family_invite` - показываем. Для новогодних инвайтов планируется следующая структура:

```json
{
  // ...
  "family_invites": [
    {
      "id": "uuid4",
      "deeplink": "yandextaxi://coopaccount?type=family&action=invite&invite_id=uuid4",
      "image": "image_tag",
      "text": "some_text",
      "button_text": "Принять и узнать о семье",
      "family_info": {
        "title": "Данила пригласил Вас в семью",
        "subtitle": "Возможен короткий текст про фичи",
        "avatar": "image_url"
      }
    }
  ]
}
```

* `id` - uuid4 идентификатор приглашения. Обязательное.
* `deeplink` - диплинк на открытие старницы семейного кабинета. Обязательное.
* `image` - тэг картинки, которую показываем на подложке. Опциональное.
* `text` - текст на центральной части открытки. Опциональное.
* `button_text` - текст на кнопке принятия приглашения. Обязательное.
* `family_info` - информация по владельцу аккаунта, который пригласил пользователя. Опциональное

Бэкенд возвращает инвайты списком, натив показывает их по очереди начиная с первого. То есть если пользователь скипнул
первую открытку, сразу же показываем вторую, и т.д. Счетчик показа открыток храним на клиенте. Каждую открытку
показываем только один раз.

В случае, если пользователь фонишный, при тапе на кнопку принятия приглашения необходимо его дорегестрировать до
портала.

С бэкенда созданный инвайт будет возвращаться до тех пор, пока не выполнится хотя бы одно условие:

* Пользователь принял приглашение в семью
* Приглашение отозвано
* Приглашение заэкспайрилось

Все приглосы будут храниться во внутренней базе бэкенда, и в момент выдачи приглашения бэк в паспорте будет проверять
его актуальность. В случае, если инвайт уже не действует, в БД инвайт пометится неактуальным, и больше не будет
возвращаться.

### Вопросы

* Куда должен попасть пользователь при тапе на открыку в случае, если он является участником или владельцем
  несмигрировавшего аккаунта?

_Коммент от Максима Быстрова_

> Приглашение показывается только, если пользователю пришел эксперимент family_group_v2 (эксперимент Семейности 2.0). Т е этому пользователю в любом случае доступна точка входа в Семейность 2.0 (иначе не покажем приглашение). При обработке диплинков при наличии этого эксперимент всегда ведем в Семейность 2.0. Есть идея добавить параметр в диплинк с версияй семьи как раз для случая двух точек входа, но пока договорились, что идем в новую семью.

> И еще замечание - для участника несмигрировавшей семьи точки входа в Семейность 1.0 не будет.`