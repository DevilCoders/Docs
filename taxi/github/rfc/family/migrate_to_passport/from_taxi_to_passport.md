# Миграция семейных аккаунтов такси в Я.Паспорт

## Бизнес-задача

Для дальнейшего развития продукта "семейности" в такси первым этапом необходимо перенести все взаимодействие по семейным
аккаунтам на инфраструктуру Я.Паспорта.

[Ссылка на проект](https://st.yandex-team.ru/TAXIPROJECTS-2479)

## К чему хотим придти

1) Информацию о семейном аккаунте (участники) пользователь получает из паспорта
2) После миграции пользователь получает коммуникацию о том, что его аккаунт переехал в паспорт
3) При обновлении информации об участниках семьи в такси информация должна обновляться в паспорте
4) После миграции у семьи пользователя должна быть доступна общая карта для оплаты
5) После миграции у пользователя должны появиться лимиты на оплату поездки

## Переезд акка в паспорт (backend)

По договоренности с юристами миграцию возможно осуществлять в фоновом режиме - т.е. без предварительных уведомлений
пользователя. Логика работы планируется следущая:

* При открытии приложения клиент вызывает ручку `/3.0/payment-methods` (уже)
* В сервисе `taxi-shared-payments`, методе `internal-stats` проверяем, попал ли клиент в эксперимент миграции, не
  произошла ли миграция до сих пор (не пустое поле в `coop_accounts.accounts.passport_family_id`), есть ли у него
  портальный аккаунт и является ли он владельцем семейного аккаунта
* Если условие выполнено - добавляем таску на миграцию в stq с указанием id семьи из `coop_accounts.accounts`

Логика внутри таски:

* Проверяем, выполнена ли уже миграция (наличие `passport_family_id` в таблице `accounts`)
* Если условие выполнено
    * скипаем задачу
* Если нет
    * Запрос в blackbox на получение информации о семье
      пользователя ([api](https://wiki.yandex-team.ru/passport/blackbox/#14.02.2020getfamilyinfoyes)). В случае
      возникновения ошибки снимаем блокировку и скипаем задачу.
    * Если нет семьи
        * [создаем новую](https://wiki.yandex-team.ru/passport/python/api/bundle/family/#sozdaniesemi)
        * загружаем всех участников семейного аккаунта такси из нашей базы
        * [пытаемся добавить их в созданную семью](https://wiki.yandex-team.ru/passport/python/api/bundle/family/#dobavleniechlenasemi)
        * для каждого добавляем в таблицу `coop_accounts.account` id созданного семейного аккаунта
        * `!!!TBD` - ждем инфу со стороны бизнеса для случая, когда некоторых участников не получилось добавить по
          причине отсутствия паспортного аккаунта
    * Если есть:
        * добавляем в таблицу `coop_accounts.account.passport_family_id` id созданного семейного аккаунта
        * выгружаем ее участников, и стараемся сматчить их айди с нашими телефонами
        * `!!!TBD` - ждем инфу со стороны бизнеса для случая, если у некоторых пользователей семейного аккаунта в
          паспорте нет приложения такси

План Б на случай, если надо будет ускорить процесс миграции - перенести все семьи скриптом. Это не отменяет варианта
ленивой загрузки, т.к. в рамках него будут разрабатываться компоненты, использующиеся в API (клиенты/репозитории и пр.)

Так же после загрузки участников необходимо будет отправить в сервис family pay айди семейной карты, и в дальнейшем
получать ее из кардстораджа. В случае отсутствия семейной карты в такси информация отправлена не будет. Эта часть пока
WIP, т.к. нет информации по API + не до конца понятно про верификацию.

## Коммуникации про переезд аккаунта (backend + iOS + Android)

После осуществления миграции пользователю будет отправлен пуш с диплинком на фулскрин, где будет показана основная
информация о паспортном аккаунте.

**!!!TBD** Так же возможен кейс показа inapp-коммуникации на старте приложения. В этом случае необходимо будет завести
экспериментальную группу для показа по условию наличия у пользователя определенного тэга, который будет проставляться в
момент миграции. Потенциально это может сказаться на конверсии. Ждем инфу от бизнеса.

## Изменение паспортной семьи после переезда (backend)

Чтобы не раздувать функционал клиентской части на момент переезда, планируется оставить API взаимодействия с участниками
семейного аккаунта тем же самым. Для этого необходимо будет пропатчить все ручки взаимодействия с семьей
для `taxi-shared-payments`, проверяя перед каждым шагом наличие семьи в паспорте (
поле `coop_accounts.accounts.passport_family_id`):

* `/4.0/coop_account`
    * достаем информацию об участниках,
      из [blackbox](https://wiki.yandex-team.ru/passport/blackbox/#14.02.2020getfamilyinfoyes), и подменяем ими
      участников аккаунта такси
    * в случае ошибок на стороне блэкбокса, а так же при отсутствии там данных о семье ничего не возвращаем клиенту
* `/4.0/coop_account/create`
    * проверяем наличие портального аккаунта, и создаем
      семью [там](https://wiki.yandex-team.ru/passport/python/api/bundle/family/#sozdaniesemi)
    * если портального аккаунта нет - можно либо показывать окно дологина, либо показывать ошибку на подобие той,
      которая отображается при попытке добавить пользователя в семью без приложения Go. `!!!TBD`
* `/4.0/coop_account/payment`
    * **!!!TBD** API для добавления карт к семейным аккаунтам
* `/4.0/coop_account/delete`
    * выполняем запрос в паспорт
      на [удаление](https://wiki.yandex-team.ru/passport/python/api/bundle/family/#udaleniesemi)
* `/4.0/coop_account/ridehistory_item`
    * **!!!TBD**
* `/4.0/coop_account/member/create`
    * синхронный запрос в паспорт
      на [добавление участника](https://wiki.yandex-team.ru/passport/python/api/bundle/family/#dobavleniechlenasemi)
* `/4.0/coop_account/member/delete`
    * синхронный запрос в паспорт
      на [удаление участника](https://wiki.yandex-team.ru/passport/python/api/bundle/family/#vyxodizsemi)
* `/4.0/coop_account/member/leave_group`
    * синхронный запрос в паспорт
      на [выход из семьи](https://wiki.yandex-team.ru/passport/python/api/bundle/family/#vyxodizsemi)

По ходу разработки и тестирования может потребоваться патчить в т.ч. и другие ручки семейного аккаунта.

## Использование новой семейной карты (backend + iOS + Android)

В данный момент семейные способы оплаты хранятся во внутренней БД сервиса
сервиса `taxi-shared-payments` `coop_accounts.shared_payments`, и обрабатываются клиентским приложением по данным
объекта `coop_account.payment_methods`. После того, как семья мигрировала в паспорт, карты будут доступны всем
участникам семейного аккаунта в ответе ручки LPM с дополнительной информацией

- [тык](https://paste.yandex-team.ru/5058082):

```json
{
  "bindings": [
    {
      "id": "card-x3e663db3ffd39b71bcc0844e",
      // ...
      "payer_info": {
        "uid": "4051330158",
        "family_info": {
          "family_id": "f1000",
          "usage": 100,
          "limit": 1000,
          "frame": "month"
        }
      }
    }
  ]
}
```

Чтобы реализовать функционал поддержки семейного способа оплаты без участия с клиентской стороны, на бэкенде планируется
фильтровать все карты из ответа ручки 3.0/payment-methods, которые не принадлежат участнику
аккаунта (`uid != card.payer_info.uid`). При запросе семейного способа оплаты будет осуществлен еще один поход в траст,
чтобы вытащить семейную карту. На стороне клиента не потребуется дополнительных доработок.

## Лимиты на поездки

Для определения возможности оплаты по семейной карте с учетом лимитов планируется заехать в текущую
ручку `/internal/coop_account/check_available`. Логика работы следущая:

* Если аккаунт уже переехал в паспорт, выполняем еще один запрос в траст, чтобы узнать оставшийся лимит по карте
* Если лимит меньше стоимости поездки, в ответе возвращаем

```json
{
  "available": false
}
```

Внутренняя логика остается прежней, за исключением того, что данные по лимитам получаются из траста, а не внутренней БД.

## Клиентское приложение

### Главная

![image](static/main.png)
Для отображения информации об обновлении семейного аккаунта предлагается использовать новый флаг в ответе
ручки `3.0/paymentmethods`, `accounts[].details.passport_account` == `true`. Флаг будет приходить с бэкенда только для
аккаунтов с типом family. В случае отсутствия флага стоит предполагать, что акк еще не мигрировал в пасспорт.

Фулскрины предлагается отображать через открытие диплинка на заведенную коммуникацию, причем коммуникации должны быть
разными как для участников, так и для владельцев. Ссылки на диплинк предлагается брать из эксперимента (!TODO описание).

```json
{
  // ... 
  "coop_account": {
    "accounts": [
      {
        "id": "family-6e5e80a3561d40c8bdb9b0640218cdda",
        "details": {
          "name": "Семейный аккаунт",
          "color": "000000",
          "passport_account": true // новое поле
        },
        "type": "family",
        "is_active": true,
        "member_role": "owner",
        "description": "",
        "has_rides": false
      }
    ]
  }
}
```

### Семейный ЛК

![image](static/family_lk.png)

Экшены "Настроить лимиты" и "Расширенные настройки в Паспорте" предлагается показывать по
условию `accounts[].details.passport_account == true && coop_account.accounts[].member_role == 'owner'`
для `accounts[].type == 'family'`. Последнее предполагается из расчета, что семейный ЛК сейчас видят как владельцы, так
и участники.

Для отображения банера "Подключите Плюс Мульти" предлагается использовать новый флаг в ответе ручки `4.0/coop_account`
`have_plus_multi == false`. Поле не является обязательным на стороне бэкенда, и возвращается только в тех случаях, когда
у владельца аккаунта есть обычная подписка.

Пример ответа ручки:
```json
{
  "has_plus_multi": false,  // новое поле
  "id": "family-6e5e80a3561d40c8bdb9b0640218cdda",
  "revision": "790349c4526d4aae8a35557ea419eb22",
  "members_description": "2 участника",
  "type": "family",
  "has_specific_limit": false,
  "is_active": true,
  "details": {
    "name": "Семейный аккаунт",
    "color": "000000"
  },
  "members": [
    // ...
  ],
  "accepted_at": "2021-09-09T16:25:03+03:00",
  "payment": {
    "payment_methods": [
      {
        "type": "card",
        "payment_method_id": "card-x8b7ef467f9f92b73d3b2de08"
      }
    ],
    "main_payment_method_id": "card-x8b7ef467f9f92b73d3b2de08"
  }
}
```
