# –õ—É—Ç–±–æ–∫—Å—ã ü¶Ñ


## –ë–∞–∑–æ–≤—ã–µ –ø–æ–Ω—è—Ç–∏—è

–ü–æ–¥–∞—Ä–æ–∫ - –ø—Ä–æ–º–æ–∫–æ–¥, –ø—Ä–æ–º–æ–∫–æ–¥ –Ω–∞ –º–µ—Å—è—Ü –ø–ª—é—Å–∞, —Å–∫–∏–¥–∫–∞ –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ –∏ —Ç–¥. –ò–º–µ–µ—Ç `id` –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏—è: —Ç–∏–ø, id –∫–∞—Ä—Ç–∏–Ω–∫–∏, ...

–õ—É—Ç–æ–±–æ–∫—Å - –º–Ω–æ–∂–µ—Å—Ç–≤–æ –ø–æ–¥–∞—Ä–∫–æ–≤. –ò–º–µ–µ—Ç `id` –∏ `gift_ids`.

–°–µ—Ä–∏—è - —Å—É—â–Ω–æ—Å—Ç—å, –∑–∞–¥–∞—é—â–∞—è –Ω–∞–±–æ—Ä –ª—É—Ç–±–æ–∫—Å–æ–≤, —Å–ø–æ—Å–æ–± –≤—ã–±–æ—Ä–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –ª—É—Ç–±–æ–∫—Å–∞, —É—Å–ª–æ–≤–∏–µ –≤—ã–ø–∞–¥–∞–Ω–∏—è –ª—É—Ç–±–æ–∫—Å–∞. –ò–º–µ–µ—Ç `id`, `lootbox_ids`, `next_lootbox_condition`.

## MVP

–î–ª—è MVP –æ—Å—Ç–∞–≤–∏–º —Ç–æ–ª—å–∫–æ –±–µ–∑—É—Å–ª–æ–≤–Ω—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã.
–î—Ä—É–≥–∏–µ —Ç–∏–ø—ã –ø–æ–¥–∞—Ä–∫–æ–≤ –Ω–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –∞ MVP —Ö–æ—á–µ—Ç—Å—è —Å–¥–µ–ª–∞—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–µ—à–µ–≤–æ.
–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç –±—É–¥–µ—Ç –∑–∞–∫–ª—é—á–∞—Ç—å—Å—è –≤ —Å—Ä–∞–≤–Ω–µ–Ω–∏–∏ –ø—Ä—è–º–æ–≥–æ –æ—Ñ—Ñ–µ—Ä–∞ –≤ –ø—Ä–æ–º–æ–ø–ª–∞—à–∫–µ –ø–æ—Å–ª–µ –ø–æ–µ–∑–¥–∫–∏ –∏/–∏–ª–∏ –≤ –ø–æ–µ–∑–¥–∫–µ: "–°–∫–∏–¥–∫–∞ 490 —Ä—É–±–ª–µ–π –Ω–∞ –∑–∞–∫–∞–∑ –≤ –µ–¥–µ" —Å –ª—É—Ç–±–æ–∫—Å–æ–º —Å –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–º –ø–æ–¥–∞—Ä–∫–æ–º.
–¢–∞–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Ö–æ—Ç–∏–º –¥–µ–ª–∞—Ç—å –∫–∞–∂–¥—É—é –ø–æ–µ–∑–¥–∫—É, –Ω–æ –Ω–µ —á–∞—â–µ —Ä–∞–∑–∞ –≤ —Å—É—Ç–∫–∏.

–í —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–µ –±—É–¥–µ—Ç —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å 21 –º–∏–ª–ª–∏–æ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
–¢—Ä–∏ –≥—Ä—É–ø–ø—ã:
* 7 –º–ª–Ω —Å –ª—É—Ç–±–æ–∫—Å–æ–º
* 7 –º–ª–Ω —Å –ø—Ä—è–º—ã–º –æ—Ñ—Ñ–µ—Ä–æ–º
* 7 –º–ª–Ω –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è –≥—Ä—É–ø–ø–∞

–û–∂–∏–¥–∞–µ–º–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è –≤ –Ω–∞–∂–∞—Ç–∏–µ, —Ç–æ –µ—Å—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞, 10%, –∞ –≤ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ 30%.
–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ –æ–∂–∏–¥–∞–µ–º –≤—ã–¥–∞—Ç—å `(7 + 7) –º–ª–Ω * 0.1  =  1 400 000` –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö –±—É–¥–µ—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–æ `1 400 000 * 0.3 = 420 000`.

–ï—Å–ª–∏ –∫–æ–Ω–≤–µ—Ä—Å–∏—è –≤ –∑–∞–∫–∞–∑—ã —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–º–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏ –±—É–¥–µ—Ç –≤—ã—à–µ –≤ —Å–ª—É—á–∞–µ —Å –ª—É—Ç–±–æ–∫—Å–æ–º, —Ç–æ —Å—á–∏—Ç–∞–µ–º –ø—Ä–æ–µ–∫—Ç —É—Å–ø–µ—à–Ω—ã–º.
–¢–æ –µ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä—è–µ–º –≥–∏–ø–æ—Ç–µ–∑—É: –∫—Ä–∞—Å–∏–≤–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –≤ –∑–∞–∫–∞–∑ –ª—É—á—à–µ, —á–µ–º –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–º–æ–∫–æ–¥.
–í –¥–∞–ª—å–Ω–µ–π—à–µ–º –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –≤–≤–µ–¥–µ–Ω–∏–µ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è –ø–æ–¥–∞—Ä–∫–æ–≤, –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø–∞ –∏—Ö –≤—ã–¥–∞—á–∏.
–ù–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ –∫–∞–∂–¥—É—é –ø–æ–µ–∑–¥–∫—É, –Ω–æ –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —à—Ç—É–∫; –Ω–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, –∞ —Å–ª—É—á–∞–π–Ω–æ.

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

* –°–æ–∑–¥–∞–µ–º –Ω–∞–±–æ—Ä –ø–æ–¥–∞—Ä–∫–æ–≤, –≤–∫–ª—é—á–∞—é—â–∏–π —Ä–∞–∑–ª–∏—á–Ω—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã. –ò—Ö –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –≤ –∫–æ–Ω—Ñ–∏–≥–µ.

* –°–æ–∑–¥–∞—ë–º –ª—É—Ç–±–æ–∫—Å—ã. –ü–æ –æ–¥–Ω–æ–º—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–¥–∞—Ä–∫–∞. 
–ù—É–∂–Ω—ã, —á—Ç–æ–±—ã –æ—Ç–¥–∞–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—É –æ–¥–∏–Ω –ø–æ–Ω—è—Ç–Ω—ã–π `id` –∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ª—É—Ç–±–æ–∫—Å–æ–≤. 
–ò—Ö —Ç–∞–∫–∂–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –≤ –∫–æ–Ω—Ñ–∏–≥–µ.
–õ—É—Ç–±–æ–∫—Å—ã –≤ MVP –º–æ–∂–Ω–æ –±—ã–ª–æ –±—ã –æ–ø—É—Å—Ç–∏—Ç—å, —Ç–∞–∫ –∫–∞–∫ –≤ –Ω–∏—Ö —Ö—Ä–∞–Ω–∏—Ç—Å—è –ª–∏—à—å –æ–¥–∏–Ω –ø–æ–¥–∞—Ä–æ–∫, –Ω–æ
    * —ç—Ç–æ –≤–∞–∂–Ω—ã–π —Å–ª–æ–π –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏,
    * –≤ –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ, –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–¥–∞—Ä–∫–æ–≤ –≤ –ª—É—Ç–±–æ–∫—Å –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –¥–æ—Ä–∞–±–æ—Ç–∫–∞.
 
* –°–æ–∑–¥–∞—ë–º —Å–µ—Ä–∏—é, –≤ –∫–æ—Ç–æ—Ä—É—é –≤–∫–ª—é—á–∞–µ–º –ª—É—Ç–±–æ–∫—Å—ã. –ó–∞–¥–∞–µ–º –∏—Ö –ø–æ—Ä—è–¥–æ–∫. 
–û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Å–ª–æ–≤–∏–µ –≤—ã–ø–∞–¥–∞–Ω–∏—è —Å–ª–µ–¥—É—é—â–µ–π –∫–æ—Ä–æ–±–∫–∏: –∫–∞–∂–¥—ã–µ X –ø–æ–µ–∑–¥–æ–∫. –°–µ—Ä–∏—è –º–∞—Ç—á–∏—Ç—Å—è –≤ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–µ –ø–æ `yandex_uid`.


–î–ª—è –ø–æ–¥–∞—Ä–∫–æ–≤ –∏ –ª—É—Ç–±–æ–∫—Å–æ–≤ –≤—ã–±—Ä–∞–ª–∏ –∫–æ–Ω—Ñ–∏–≥–∏, –ø–æ—Ç–æ–º—É —á—Ç–æ –¥–µ–ª–∞—Ç—å —É–¥–æ–±–Ω—É—é –∞–¥–º–∏–Ω–∫—É –≤ MVP –¥–æ—Ä–æ–≥–æ, –∞ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç –ø–æ–∫–∞ –Ω–µ –Ω—É–∂–µ–Ω, —Ç–∞–∫ –∫–∞–∫ –¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ –≥—Ä—É–ø–ø—ã –º–æ–∂–Ω–æ –≤ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–µ —Å–µ—Ä–∏–π –ª—É—Ç–±–æ–∫—Å–æ–≤.

### –°—Ö–µ–º—ã —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤ –∏ –∫–æ–Ω—Ñ–∏–≥–æ–≤

1. –ö–æ–Ω—Ñ–∏–≥ —Å –ø–æ–¥–∞—Ä–∫–∞–º–∏ RANDOM_DISTCOUNTS_LOOTBOX_GIFTS_CONFIG

```
default: []
description: –ü–æ–¥–∞—Ä–∫–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –¥–ª—è –ª—É—Ç–±–æ–∫—Å–æ–≤: –ø—Ä–æ–º–æ–∫–æ–¥—ã, –¥—Ä.
tags: [notfallback]
maintainers: [m1eszok]
schema:
    type: object
    properties:
        gifts:
            type: array
                items:
                    $ref: '#/definitions/LootBoxGift'
                x-taxi-cpp-type: std::unordered_set
    required:
        - gifts
    additionalProperties: false

    definitions:
        Promocode:
            type: object
            properties:
                series_id:
                    type: string
            required:
            - series_id
            additionalProperties: false


        LootBoxGift:
            type: object
            properties:
                id:
                    type: string
                type:
                    type: string
                    enum:
                      - promocode
                payload:
                    oneOf:
                    - $ref: '#/definitions/Promocode'
            required:
            - id
            - type
            - payload
            additionalProperties: false
```

2. –ö–æ–Ω—Ñ–∏–≥ —Å –ª—É—Ç–±–æ–∫—Å–∞–º–∏ RANDOM_DISCOUNTS_LOOTBOXES_CONFIG

```
default: []
description: –õ—É—Ç–±–æ–∫—Å—ã --- –Ω–∞–±–æ—Ä –ø–æ–¥–∞—Ä–∫–æ–≤.
tags: [notfallback]
maintainers: [m1eszok]
schema:
    type: object
    properties:
        lootboxes:
            type: array
                items:
                    $ref: '#/definitions/LootBox'
                x-taxi-cpp-type: std::unordered_set
    required:
    - lootboxes
    additionalProperties: false

    definitions:
        LootBox:
            type: object
            properties:
                id:
                    type: string
                gift_ids:
                    type: array
                        items:
                            type: string
                type:
                    type: string
                    enum:
                      - box
                      - direct_offer
            required:
            - id
            - gift_ids
            additionalProperties: false
```

3. –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç 3.0 —Å —Å–µ—Ä–∏—è–º–∏ –ª—É—Ç–±–æ–∫—Å–æ–≤

```
name: lootbox_series
type: config
description: |
    –°–µ—Ä–∏–∏ –ª—É—Ç–±–æ–∫—Å–æ–≤. –°–æ–¥–µ—Ä–∂–∞—Ç –Ω–∞–±–æ—Ä –ª—É—Ç–±–æ–∫—Å–æ–≤, —É—Å–ª–æ–≤–∏–µ –≤—ã–¥–∞—á–∏ –ª—É—Ç–±–æ–∫—Å–∞.
    –í MVP –ø–æ—Ä—è–¥–æ–∫ –≤—ã–ø–∞–¥–µ–Ω–∏—è –ª—É—Ç–±–æ–∫—Å–æ–≤ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ—Ä—è–¥–∫–æ–º –∏—Ö –∑–∞–ø–∏—Å–∏ –≤ —Å–µ—Ä–∏–∏.

value:
    schema:
        type: object
        properties:
            series:
                type: array
                    items:
                        $ref: '#/definitions/LootBoxSeries'
                    x-taxi-cpp-type: std::unordered_set
        required:
          - series
        additionalProperties: false

definitions:
    NRidesCondition:
        type: object
        properties:
            rides_number:
                type: integer
                minimum: 10
        required:
          - rides_number
        additionalProperties: false



    LootBoxSeries:
        type: object
        properties:
            id:
                type: string
            lootbox_ids:
                type: array
                    items:
                        type: string
            next_lootbox_condition:
                oneOf:
                  - $ref: '#/definitions/NRidesCondition'
        required:
          - id
          - lootbox_ids
          - next_lootbox_condition
        additionalProperties: false
```

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

–î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–≤—è–∑–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Å–µ—Ä–∏–µ–π –ª—É—Ç–±–æ–∫—Å–æ–≤ –Ω—É–∂–Ω–æ –∏–º–µ—Ç—å —Ç–∞–±–ª–∏—á–∫—É —Å–æ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π:
```
{
    'yandex_uid': 'yandex_uid',
    'lootbox_series_id': 'lootbox_series_id', 
    'last_lootbox_update_at': utcnow(),                     # timestamp –≤—ã–¥–∞—á–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ª—É—Ç–±–æ–∫—Å–∞ –∏–ª–∏ —Å–æ–≤–µ—Ä—à–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ª—É—Ç–±–æ–∫—Å–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–æ–≤–µ—Ä—à–µ–Ω–∏–µ –ø–æ–µ–∑–¥–∫–∏
    'current_user_status': {'rides': 0} –∏–ª–∏ None,           # –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Å–µ—Ä–∏–∏. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å–ª–æ–≤–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –ª—É—Ç–±–æ–∫—Å–∞ –≤ —Å–µ—Ä–∏–∏.
    'lootbox_state': {'last_lootbox_idx': 0} –∏–ª–∏ None,      # –°–æ—Å—Ç–æ—è–Ω–∏–µ, –ø–æ–∑–≤–æ–ª—è—é—â–µ–µ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –∫–∞–∫–æ–π –ª—É—Ç–±–æ–∫—Å –≤—ã–¥–∞–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–º. –í —Å–ª—É—á–∞–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è --- –∏–Ω–¥–µ–∫—Å –≤ –º–∞—Å—Å–∏–≤–µ.
    'idempotency_key': 'idempotency_key'        
}
```

–°—Ö–µ–º–∞ –¥–ª—è PostgreSQL:
```
CREATE TABLE IF NOT EXISTS random_discounts.user_lootbox_series
(
  yandex_uid                TEXT,
  lootbox_series_id         TEXT,
  last_lootbox_update_at    TIMESTAMPTZ NOT NULL,
  current_user_status       jsonb,
  lootbox_state             jsonb,
  idempotency_key           TEXT,
  PRIMARY KEY(yandex_uid, lootbox_series_id)
);
```

–ë—É–¥—É—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –≤—Å—Ç–∞–≤–∫—É, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –ø–æ–∏—Å–∫ –ø–æ PRIMARY KEY. 
–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –Ω–µ –Ω—É–∂–Ω—ã.

–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ `user_lootbox_series` –µ—Å—Ç—å –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∞—É–¥–∏—Ç–æ—Ä–∏–∏ –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ—Ä–∏–π.
–í MVP –ø–ª–∞–Ω–∏—Ä—É–µ–º 2 —Å–µ—Ä–∏–∏ –∏ 14 –º–∏–ª–ª–∏–æ–Ω–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
–ü–æ–ª—É—á–∞–µ—Ç—Å—è, —Ö—Ä–∞–Ω–∏—Ç—å –±—É–¥–µ–º –ø–æ—Ä—è–¥–∫–∞ 14 –º–∏–ª–ª–∏–æ–Ω–æ–≤ –∑–∞–ø–∏—Å–µ–π.

–ù–∞ –∑–∞–ø–∏—Å—å —Å –∑–∞–ø–∞—Å–æ–º –∑–∞–ª–æ–∂–∏–º 100 –±–∞–π—Ç. 
–ò—Ç–æ–≥–æ `0.1 * 14 000 000 = 1 400 000 –ö–ë = 1 400 –ú–± = 1.4 –ì–ë`.
–ï—Å–ª–∏ —Ä–∞—Å–∫–∞—Ç–∏—Ç—å –Ω–∞ –≤—Å—é –∞—É–¥–∏—Ç–æ—Ä–∏—é GO (35 –º–ª–Ω MAU): 
`0.1 * 35 000 000 = 3 500 –ú–ë = 3.5 –ì–ë`.

–¢–∞–∫–∂–µ –ø–æ–ª–µ–∑–Ω—ã–º –±—É–¥–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –ª—É—Ç–±–æ–∫—Å–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 
```
{
    'yandex_uid': 'yandex_uid',
    'lootbox_series_id': 'lootbox_series_id',
    'lootbox_ids': ['lootbox_id'],
    'idempotency_key': 'idempotency_key'        
}
```

–°—Ö–µ–º–∞ –¥–ª—è PostgreSQL:
```
CREATE TABLE IF NOT EXISTS random_discounts.user_lootbox_history
(
  yandex_uid                TEXT,
  lootbox_series_id         TEXT,
  lootbox_ids               ARRAY[]::TEXT[] NOT NULL,
  PRIMARY KEY(yandex_uid, lootbox_series_id)
);
```
–ë—É–¥—É—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –≤—Å—Ç–∞–≤–∫—É, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –ø–æ–∏—Å–∫ –ø–æ PRIMARY KEY. 
–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –Ω–µ –Ω—É–∂–Ω—ã.

–¢—É—Ç —Ç–∞–∫–∂–µ –±—É–¥–µ—Ç –¥–æ 14 –º–∏–ª–ª–∏–æ–Ω–æ–≤ –∑–∞–ø–∏—Å–µ–π, –∏ —Ç–∞–∫–∂–µ –ø–æ–ª–æ–∂–∏–º –ø–æ 100 –±–∞–π—Ç –Ω–∞ —à—Ç—É–∫—É.
–¢–æ–≥–¥–∞ –æ–±–µ –±–∞–∑—ã –¥–ª—è MVP –∑–∞–π–º—É—Ç –ø–æ—Ä—è–¥–∫–∞ `2.8 –ì–ë`, –∞ –ø—Ä–∏ –ø–æ–ª–Ω–æ–π —Ä–∞—Å–∫–∞—Ç–∫–µ - `7 –ì–ë`.

–¢–∞–∫ –∫–∞–∫ –ø–æ–ª—è `current_user_status` –∏ `lootbox_state` –∏–º–µ—é—Ç –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É, —Ö–æ—á–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–µ—Ä–µ–ª—è—Ü–∏–æ–Ω–Ω—É—é mongodb.
–•–æ—Ç—è –≤ –Ω–æ–≤—ã—Ö –≤–µ—Ä—Å–∏—è—Ö postgresql —Ç–æ–∂–µ –º–æ–∂–Ω–æ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å json –ø–æ–ª—è: [—Å—Å—ã–ª–∫–∞](https://stackoverflow.com/a/45150668).
–ö—Ä–æ–º–µ —Ç–æ–≥–æ, –≤ —Å–µ—Ä–≤–∏—Å–µ `random-discounts`, –≤ –∫–æ—Ç–æ—Ä—ã–π –¥–æ–±–∞–≤–ª—è–µ–º –≤—Å—é –ª–æ–≥–∏–∫—É, —É–∂–µ –µ—Å—Ç—å PostgreSQL –±–∞–∑–∞, –≤ –∫–æ—Ç–æ—Ä—É—é –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–∞–±–ª–∏—á–µ–∫.
–ü–æ—ç—Ç–æ–º—É –≤ –∏—Ç–æ–≥–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å –Ω–∞ –≤–∞—Ä–∏–∞–Ω—Ç–µ —Å PostgreSQL.

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ñ–ª–æ—É

–í —Ä–∞—Å—á—ë—Ç–∞—Ö rps –ø–æ–ª–∞–≥–∞–µ–º—Å—è –Ω–∞ —Ç–æ, —á—Ç–æ MAU GO –ø–æ—Ä—è–¥–∫–∞ 35 –º–ª–Ω, –∞ –∞—É–¥–∏—Ç–æ—Ä–∏—è MVP –ø–æ—Ä—è–¥–∫–∞ 21 –º–ª–Ω, –∏–∑ –Ω–∏—Ö 14 –º–∏–ª–ª–∏–æ–Ω–æ–≤ --- –∞—É–¥–∏—Ç–æ—Ä–∏—è —Å –ª—É—Ç–±–æ–∫—Å–∞–º–∏.
–í—Å—è –∞—É–¥–∏—Ç–æ—Ä–∏—è GO —Å–æ–≤–µ—Ä—à–∞–µ—Ç 7.7 –º–ª–Ω –ø–æ–µ–∑–¥–æ–∫ –≤ –¥–µ–Ω—å.
14 –º–ª–Ω –∏–∑ –≤—ã–±–æ—Ä–∫–∏ –ø—Ä–∏–º–µ—Ä–Ω–æ 2.26 –º–ª–Ω.

* –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–∞–∫—Å–∏

* –ü—Ä–∏ –≤—ã–∑–æ–≤–∞—Ö totw –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `/4.0/lootbox/v1/fetch_state`, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –±—É–¥–µ—Ç –ª–∏ –≤ —ç—Ç–æ–π –ø–æ–µ–∑–¥–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤—ã–¥–∞–Ω –ª—É—Ç–±–æ–∫—Å. 
–ü—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —É—Å–ª–æ–≤–∏—è, —Ç–æ –µ—Å—Ç—å `{'rides': X}` –∏ `now() - last_lootbox_update_at  > Y`, –æ—Ç–¥–∞–µ–º `LootboxAction` —Å id —Å–ª–µ–¥—É—é—â–µ–≥–æ –ª—É—Ç–±–æ–∫—Å–∞: [RFC –∫–ª–∏–µ–Ω—Ç–æ–≤](https://a.yandex-team.ru/arcadia/taxi/github/rfc/lootbox/promo_block_lootbox_action.md?from_pr=2647546&rev=users%2Fa-tumanov%2FTAXIMOBILEDEV-1270%2Flootboxes).
–ü–∏–∫–æ–≤–∞—è –¥–Ω–µ–≤–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ totw - 6k rps, –∑–Ω–∞—á–∏—Ç, –æ–∂–∏–¥–∞–µ–º–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Ä—É—á–∫—É –ª—É—Ç–±–æ–∫—Å–æ–≤ - –¥–æ `6 000 * 2.26 / 7.7 = 1761` rps.

* –ü–æ –Ω–∞–∂–∞—Ç–∏—é –Ω–∞ –ø—Ä–æ–º–æ–ø–ª–∞—à–∫—É –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —ç–∫—Ä–∞–Ω —Å –∑–∞–∫—Ä—ã—Ç—ã–º –ª—É—Ç–±–æ–∫—Å–æ–º –∏ –∫–Ω–æ–ø–∫–æ–π "–ó–∞–±—Ä–∞—Ç—å –≤—Å—ë".
–ü–æ –Ω–∞–∂–∞—Ç–∏—é –Ω–∞ –Ω–µ–µ, –≤—ã–∑—ã–≤–∞–µ–º —Ä—É—á–∫—É `/4.0/lootbox/v1/activate`, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ª—É—Ç–±–æ–∫—Å–∞, –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –±–∞–∑–µ –∏ –æ—Ç–¥–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ª—É—Ç–±–æ–∫—Å–∞. 
–í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —Ä—É—á–∫–∞ –æ—Ç–≤–µ—á–∞–µ—Ç 404: [RFC –∫–ª–∏–µ–Ω—Ç–æ–≤](https://a.yandex-team.ru/arcadia/taxi/github/rfc/lootbox/lootbox_activate.md?from_pr=2647546&rev=users%2Fa-tumanov%2FTAXIMOBILEDEV-1270%2Flootboxes).
–ü–∏–∫–æ–≤–∞—è –¥–Ω–µ–≤–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ `ordercommit` 170 rps.
–ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è –≤ –Ω–∞–∂–∞—Ç–∏–µ - 10%, –ø–æ—ç—Ç–æ–º—É –æ–∂–∏–¥–∞–µ–º–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Ä—É—á–∫—É –ª—É—Ç–±–æ–∫—Å–æ–≤ - –¥–æ `170 * 2.26 / 7.7 * 0.2 = 10` rps.

* –í –∫–æ–Ω—Ü–µ –ø–æ–µ–∑–¥–∫–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –ø–æ–ø–∞–¥–∞—é—â–∏—Ö –ø–æ–¥ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç, —Å—Ç–∞–≤–∏–º stq, –∫–æ—Ç–æ—Ä–∞—è –æ–±–Ω–æ–≤–ª—è–µ—Ç –µ–≥–æ —Å—Ç–∞—Ç—É—Å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Å–µ—Ä–∏–∏ –ª—É—Ç–±–æ–∫—Å–æ–≤: –æ–±–Ω–æ–≤–ª—è–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–µ–∑–¥–æ–∫ –ø–æ—Å–ª–µ —Ç–∞–π–º—Å—Ç–µ–º–ø–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –ª—É—Ç–±–æ–∫—Å–∞.
–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–µ–∑–¥–æ–∫ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–º –ø–æ–ª—É–∏–Ω—Ç–µ—Ä–≤–∞–ª–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä—É—á–∫—É [`/v1/recent-orders
`](https://pages.github.yandex-team.ru/taxi/schemas/Taxi_Documentation/Uservices/user-statistics/api/api/#v1recent-orders).

–ü–∏–∫–æ–≤–∞—è –¥–Ω–µ–≤–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ `ordercommit` 170 rps.
–ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ stq –ª—É—Ç–±–æ–∫—Å–æ–≤ `170 * 2.26 / 7.7 = 50` rps.

### –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å

–°–µ—Ä–≤–∏—Å `random-discounts` –≤—ã–±—Ä–∞–ª–∏ –∫–∞–∫ —Å–∞–º—ã–π —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π.
–°–µ–π—á–∞—Å –æ–Ω –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ `x2nano` (—Å—É–º–º–∞—Ä–Ω–æ 2 —è–¥—Ä–∞, 8 –ì–± –û–ó–£) —Å –º–µ–¥–∏–∞–Ω–Ω–æ–π –ø–∏–∫–æ–≤–æ–π –¥–Ω–µ–≤–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π 30 rps.
–°–µ–π—á–∞—Å –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ CPU –ø–æ—Ä—è–¥–∫–∞ 9%, RAM 33%.
–ù–∞–≥—Ä—É–∑–∫–∞ —É–≤–µ–ª–∏—á–∏—Ç—Å—è –Ω–∞ 1820 rps, —á—Ç–æ –ø–æ—Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–µ—Ä–≤–∏—Å–∞.
–£—á–∏—Ç—ã–≤–∞—è —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ 60 —Ä–∞–∑, —Ä–∞–∑—É–º–Ω—ã–º –∫–∞–∂–µ—Ç—Å—è —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ `x3micro` —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –ø–æ–¥–æ–≤ –∏ RAM –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏: 
3 –¥—Ü x 3 –ø–æ–¥–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ 2x8 -> 18x72.  



### C—Ö–µ–º—ã —Ä—É—á–µ–∫

* `/4.0/lootbox/v1/fetch_state`

```
openapi: 3.0.0
info:
    description: Yandex Taxi random-discounts Service
    title: Yandex Taxi random-discounts Service
    version: '1.0'

# Not used in codegen
servers:
  - url: random-discounts.taxi.yandex.net
    description: production

x-taxi-middlewares:
    tvm: true


x-taxi-client-qos:
    taxi-config: RANDOM_DISCOUNTS_CLIENT_QOS

paths:
    /4.0/lootbox/v1/fetch_state:
        get:
            x-taxi-middlewares:
                api-4.0: true
            parameters:
              - in: header
                name: X-Idempotency-Token
                description: —Ç–æ–∫–µ–Ω, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã–π –∫–ª–∏–µ–Ω—Ç–æ–º, –¥–ª—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–∞
                type: string
                required: true
            description: |
                –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Å–µ—Ä–∏–∏ –ª—É—Ç–±–æ–∫—Å–æ–≤.
            responses:
                '200':
                    description: OK
                    schema:
                        $ref: '#/definitions/LootBoxUpdateStateResponse'
                '400':
                    description: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–º–∞—Ç—á–∏–ª—Å—è –≤ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–µ
                    schema:
                        $ref: '#/definitions/definitions/UserError'

definitions:
    LootBoxUpdateStateResponse:
        type: object
        additionalProperties: false
        properties:
            lootbox_id:
                type: string
                description: –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ª—É—Ç–±–æ–∫—Å–∞, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –≤—ã–¥–∞–Ω –≤ –¥–∞–Ω–Ω–æ–π –ø–æ–µ–∑–¥–∫–µ.
        required:
          - lootbox_id

    UserError:
        type: object
        additionalProperties: false
        properties:
            message:
                type: string
                description: —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                example: "invalid or missing parameters"
            code:
                description: –∫–æ–¥ –æ—à–∏–±–∫–∏
                type: string
        required:
          - message
```

* `/4.0/lootbox/v1/activate`

```
paths:
    /4.0/lootbox/v1/activate:
        post:
            x-taxi-middlewares:
                api-4.0: true
            parameters:
              - in: header
                name: X-Idempotency-Token
                description: —Ç–æ–∫–µ–Ω, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã–π –∫–ª–∏–µ–Ω—Ç–æ–º, –¥–ª—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–∞
                type: string
                required: true
            description: |
                –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —É—Å–ª–æ–≤–∏–π –≤—ã–¥–∞—á–∏ –ª—É—Ç–±–æ–∫—Å–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –¥–ª—è –µ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è. 
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            type: object
                            additionalProperties: false
                            properties:
                                lootbox_id:
                                    type: string
                                    description: –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ª—É—Ç–±–æ–∫—Å–∞, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –≤—ã–¥–∞–Ω –≤ –¥–∞–Ω–Ω–æ–π –ø–æ–µ–∑–¥–∫–µ.
                            required:
                            - lootbox_id

            responses:
                '200':
                    description: OK
                    schema:
                        $ref: '#/definitions/LootBoxActivateResponse'
                '404':
                    description: |
                        –£—Å–ª–æ–≤–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ª—É—Ç–±–æ–∫—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã
                        –∏–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω –Ω–µ–ø—Ä–∞–∏–≤–ª—å–Ω—ã–π id –ª—É—Ç–±–æ–∫—Å–∞
                    schema:
                        $ref: '#/definitions/UserError'

definitions:
    Title:
        type: object
        additionalProperties: false
        properties:
            items:
                $ref: '#/definitions/Items'
        required:
          - items
            

    Separator:
        type: object
        additionalProperties: false
        properties:
            items:
                $ref: '#/definitions/Items'
        required:
          - items

    Gifts:
        type: object
        additionalProperties: false
        properties:
            title:
                $ref: '#/definitions/Title'
            subtitle:
                $ref: '#/definitions/Title'
            lead_icon_tag:
                type: string
            lootbox_icon_tag:
                type: string
            action:
                $ref: '#/definitions/Title'
        required:
          - title
          - subtitle
          - lead_icon_tag
          - lootbox_icon_tag
          - action

    LootBoxActivateResponse:
        type: object
        additionalProperties: false
        properties:
            title:
                $ref: '#/definitions/Title'
            separator:
                $ref: '#/definitions/Separator'
            gifts:
                $ref: '#/definitions/Gifts'
            take_all_button:
                $ref: '#/definitions/Button'
        required:
          - service
          - separator
          - gifts
          - take_all_button

        required:
          - lootbox_id

    UserError:
        type: object
        additionalProperties: false
        properties:
            message:
                type: string
                description: —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                example: "invalid or missing parameters"
            code:
                description: –∫–æ–¥ –æ—à–∏–±–∫–∏
                type: string
        required:
          - message
```

