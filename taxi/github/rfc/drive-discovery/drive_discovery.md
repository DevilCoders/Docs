

## Дизайн

![drive-discovery](https://jing.yandex-team.ru/files/pavelnekrasov/drive_discovery_v3-1.png "Дискавери Драйва")


## Flow 

Денис Тимошин нарисовал классную схему (TODO: поправить)
![drive-discovery-v2](https://jing.yandex-team.ru/files/pavelnekrasov/drive_discovery_v2_flow.jpg "Флоу дискавери с уточнением точки B")

### Главный экран

Добавляем клиентский эксперимент drive_discovery, который включает режим 
дискавери вместо саджеста точки B после нажатия на кнопку Драйва.
Если drive_discovery.enabled==true, то открываем экран discovery. 

Клиенский эксперимент `drive_discovery` будет проходить в ручке `products`.
(кварг `client-superapp-misc/availability`).

*Примечание1: не хочется добавлять флажок в add_drive_cars, т.к. кажется, что 
дискавери режим - независимая от этого экспа фича*

*Примечание2: проверка запортальности и зарегистрированности в Драйве остается 
такой же как и в режиме саджеста.*


### Экран discovery

#### Заголовок экрана (иконка + текст)

Иконка Драйва на экране discovery берется из эксперимента drive_discovery. 
`drive_discovery.header_icon_tag`.

Текст заголовка берется из эксперимента `drive_discovery.l10n`.
Ключ: `superapp.drive.discovery_header`

#### Подгрузка нулевого саджеста
При открытии режима "discovery" асинхронно подгружается нулевой саджест точки 
B с `current_mode=drive` - он нужен, чтобы не запрашивать каждый раз нулевой 
саджест при попытке указать адрес точки B для машины. А также для того, чтобы 
сообщать первые "N" адресов нулевого саджеста в Драйв для генерации фикспоинт
офферов (а-ля Домой, На работу).

#### Работа с layers
Экран discovery для Драйва очень похож на экран discovery для Транспорта.

Клиент должен ходить в layers с `"screen": "discovery", "mode": "drive"`.

На экране disсovery должен быть поддержан `optimal_view` и отображение ошибки 
`no_objects_message`. Также при отстутствии объектов присылается `no_object_subtitle`.
 ![drive-discovery](https://jing.yandex-team.ru/files/pavelnekrasov/layers_error.jpg "Нет машин рядом")

Пример выдачи ответа без объектов:
```json5
{
  "bbox": [...],
  "clean_sec": 86400,
  "features": [],
  "optimal_view": {
    "no_objects_message": "Нет машин поблизости",
    "no_objects_subtitle": "Можно подвигать карту, вдруг повезет"
  },
  "throttle_ms": 100,
  "type": "FeatureCollection",
  "validity_sec": 86400,
  "zooms": [
    15.0,
    21.0
  ]
}


```
 

Если layers не отвечает, либо 500-тит, то нужно отобразить ошибку с текстом 
из drive_discovery.l10n.superapp_drive_layers_unavailability_message
с кнопкой `Повторить`.

В ответе layers будут машинки драйва без офферов. 
На текущем этапе мы хотим только машины с фикспоинт офферам. Драйв пока не 
умеет возвращать машины, у которых только фикспоинт офферы. 
Поэтому будем фильтровать такие машины на нашей стороне по классу машины и 
могут быть кейсы, когда пользователю придет машина без фикса. Нужно предусмотреть 
сообщение об ошибке в SDK на этой случай.

По нажатию на машинку открывается карточка SDK, на которой отображаются офферы. Также строится 
пеший маршрут до машинки (аналогично пешему маршруту на экране выбора офферов).
Для открытия карточки SDK добавляется новый action в layers - `DriveSdkAction`:
```json
{
  "type": "drive_sdk",
  "car_number": "x111xx799"
}
```

#### Simplified-стиль в layers
В драйве, начиная с определенного зума, картинки машинок превращаются в кружочки.
Чтобы повторить эту логику в layers предлагается добавить поле simplified_style
 в ответе layers. Если зум становится меньше `display_settings.simplified_zoom`, то используется 
 `simplified_style` для картинки.

```json5
    "display_settings": {
      "z_index": 210,
      "zooms": [
        14,
        16
      ],
      "simplified_zoom": 15.5 // Если зум <= 15.5, то используется simplified_style
    },
    "style": {
      "azimuth": 5,
      "image": {
        "type": "url",
        "doublex": "https://carsharing.s3.yandex.net/drive/car-models/mercedes_e200_white/map-2x.png",
        "triplex": "https://carsharing.s3.yandex.net/drive/car-models/mercedes_e200_white/map-3x.png"
      },
      "scale": 0.8
    },
    "simplified_style": {
      "image": {
        "type": "url",
        "doublex": "https://carsharing.s3.yandex.net/drive/car-models/mercedes_e200_white/pin-2x.png",
        "triplex": "https://carsharing.s3.yandex.net/drive/car-models/mercedes_e200_white/pin-3x.png"
      },
      "scale": 0.5
    }
```

#### Открытие карточки SDK

Для открытия карточки SDK, клиент передает номер машины `car_number` в SDK и  
первые "N" адресов нулевого саджеста (нужны поля title и 
position). Параметр "N" указывается в экперименте drive_discovery:
`drive_discovery.max_sdk_zerosuggest_addresses`. 

#### Кнопка "Куда едем"

На экране дискавери отображается кнопка "Куда едем". По нажатию на эту 
кнопку открывается саджест и повторяется текущий флоу Драйва 
(https://github.yandex-team.ru/taxi/rfc/blob/master/persuggest/drive_suggest.md).

### Карточка машины SDK
В карточке SDK отображается кнопка "Указать адрес" и офферы для адресов, 
переданных в SDK вместе с номером машины. Офферы "варятся" на 
стороне SDK (не через таксишный бэкенд).

#### Кнопка "Указать адрес"
При тапе на кнопку "Указать адрес" выполняется переход на экран саджеста с выбранной машиной 
(см. подробное описание далее).

#### Кнопка оффера
При тапе на оффер (Домой/На работу) SDK сообщает в приложение гео-точку адреса и 
тайтл. Приложение открывает экран выбора точки B 
на карте, а SDK прогружает выбранный оффер. Важный момент, что при переходе на 
экран выбора точки B не нужно дергать finalsuggest (pin_drop) - 
нужно просто отобразить тайтл, полученный от SDK и поместить пин в 
точку, полученную от SDK. Подробное описание экрана выбора точки B ниже.

### Экран саджеста с выбранной машиной
#### Нулевой саджест
При входе на экран саджеста подгружается нулевой саджест, полученный при 
входе на экран discovery.

#### Формат запросов в persuggest 
Все походы в саджест должны выполняться с current_mode=drive и с указанием выбранной 
машины:
```json5
{
  "state" : {
     "drive": {
        "selected_car_number": "x111xx799" //номер выбранной машины
     },
     "current_mode": "drive",
     ...
  }
}
```
Если уже выбрана машина, то в finalsuggest не "варятся" офферы - в ответе всегда будет 
service.drive.available=true и не будет layers_context (саджест понимает, что 
не нужно генерить офферы по наличию selected_car_number). 

#### Финализация адреса текстового саджеста 
После финализации адреса открывается экран выбора точки B и в SDK передаются 
номер машины, координаты адреса и title.

#### Кнопка "Карта"
При нажатии "Карта" выполняется переход на экран выбора точки B 
с отзумом на drive_discovery.choose_b_zoom - пин указывает на текущую точку A.  

### Экран выбора точки B на карте

#### Работа с layers
На экране выбора точки B должны дергаться слои с `mode=drive,screen=choose_b`, 
а также добавляется номер выбранной машины (чтобы отрисовывать машинку на карте):
```json5
{
  "state": {
     "mode": "drive",
     "screen": "choose_b",
     "drive": {
        "selected_car_number": "x111xx799" //номер выбранной машины
     },
     ...
  }
}
```
Если слои вернули пустой список объектов, либо не ответили (500, таймаут), 
то сообщение об ошибке не нужно выводить - просто на карте не будет выбранной тачки.


#### Инициализация экрана
Экран выбора точки B может быть инициализирован из трех мест:
1. По нажатию оффера в карточке SDK. В таком случае номер машины, title и положение пина 
должны приходить из SDK и SDK должно прогрузить оффер.
2. По нажатию кнопки "Карта" в саджесте. В таком случае открывается карта с 
отзумом на drive_discovery.choose_b_zoom, пин указывает на текущую точку A. 
Оффер в SDK не подгружается (подгрузка оффера выполняется только после перемещения 
пина).
3. После финализации адреса из текстового саджеста. В таком случае открывается 
карта, пин находится в финализированной точке. Номер машины,
 title и position адреса должны быть переданы в SDK для прогрузки оффера.
 
#### Обработка движения пина 

При каждом сдвиге пина дергается finalsuggest/pin_drop (current_mode=drive)
 
#### Загрузка офферов через SDK
После каждого finalsuggest  - как при инициализации с finalsuggest (пункт 3), так и при 
сдвиге пина (после pin_drop) в SDK сообщаются:
 1. `car_number=номер выбранной машины`
 2. `dst=results[].position` (положение точки B)
 3. `destination_name=results[0].title.text` (название адреса)

После каждой прогрузки оффера SDK должно сообщить в приложение зеленую зону, в которой 
можно оставить машину.

#### Кнопка "геолокация"
Кнопку "геолокация" не отображаем.

#### Кнопка адреса
По нажатию на адрес пина (сверху экрана) - открываем саджест (как на главном экране).

#### Обработка ошибок finalsuggest
Если после сдвига пина finalsuggest/pin_drop не отвечает (таймаут, нет интернета, 500), 
то нужно послать сигнал в SDK для отображения ошибки.

### Экран забронированной машны
После бронирования машины через SDK начинаем ходить в layers с screen=totw,mode=drive (как сейчас).

## [deprecated] Flow MVP - без уточнения точки B на карте [deprecated]
 
Чтобы подойти итеративно к добавлению полноценного режима дискавери предлагается 
сначала сделать MVP версию без уточнения точки B на карте - она требует сильно 
меньше доработок.

#### Главный экран

Добавляем клиентский эксперимент drive_discovery, который включает режим 
дискавери вместо саджеста точки B после нажатия на кнопку Драйва.
Если drive_discovery.enabled==true, то открываем экран discovery. 


*Примечание1: не хочется добавлять флажок в add_drive_cars, т.к. кажется, что 
дискавери режим - независимая от этого экспа фича*

*Примечание2: проверка запортальности и зарегистрированности в Драйве остается 
такой же как и в режиме саджеста.*


#### Экран discovery
Экран discovery для Драйва очень похож на экран discovery для Транспорта.
Клиент должен ходить в layers с `"screen": "discovery", "mode": "drive"`.

На экране disсovery должен быть поддержан `optimal_view` и отображение ошибки 
`no_objects_message`. Если layers не отвечает, либо 500-тит, то поведение такое 
же как в режиме транспорта.

При открытии режима "discovery" асинхронно подгружается нулевой саджест точки 
`B` с `current_mode=drive` - он нужен, чтобы не запрашивать каждый раз нулевой 
саджест при попытке указать адрес точки B для машины. А также для того, чтобы 
сообщать первые "N" адресов нулевого саджеста в Драйв для генерации фикспоинт
офферов (а-ля Домой, На работу).

В ответе layers будут машинки драйва без офферов. По нажатию на машинку 
открывается карточка SDK, на которой отображаются офферы. Также строится 
пеший маршрут до машинки (аналогично пешему маршруту на экране выбора офферов).
Для открытия карточки SDK добавляется новый action в layers - `DriveSdkAction`:
```json
{
  "type": "drive_sdk",
  "car_number": "x111xx799"
}
```

Для открытия карточки SDK, клиент передает номер машины `car_number` в SDK. 
Также в SDK передаются первые "N" адресов нулевого саджеста (нужны поля title и 
position). Параметр "N" указывается в экперименте drive_discovery:
`drive_discovery.max_sdk_zerosuggest_addresses`. 

---TODO: можно не передавать адреса и полагаться на Дом/Работа, которые будут в SDK.
 Обсудить с Гошей и Кириллом.---

На текущем этапе мы хотим только машины с фикспоинт офферам. Драйв пока не 
умеет возвращать машины, у которых только фикспоинт офферы. 
Поэтому будем фильтровать такие машины на нашей стороне по классу машины и 
могут быть кейсы, когда пользователю придет машина без фикса. Нужно предусмотреть 
сообщение об ошибке в SDK на этой случай.

#### Карточка машины SDK
В карточке SDK отображается кнопка "Указать адрес" и офферы для адресов, 
переданных в SDK вместе с номером машины. Офферы "варятся" на 
стороне SDK (не через таксишный бэкенд).

При тапе на кнопку "Указать адрес" выполняется переход на экран саджеста (см. 
подробное описание далее).

При тапе на оффер SDK бронирует машину.

**TODO: обсудить с Гошей, насколько это ОК продуктово. Кажется, что цена уже 
видна пользователю и нет смысла в промежуточном экране с кнопкой "Забронировать"**

#### Экран саджеста
Экран саджеста полностью повторяет экран саджеста для текущего flow 
(https://github.yandex-team.ru/taxi/rfc/blob/master/persuggest/drive_suggest.md) за 
исключением двух моментов:
1. Нулевой саджест берется из нулевого саджеста, который был запрошен при 
переходе на экран дискавери (см. выше)
2. state расширяется объектом `drive`:
```json5
{
  "state" : {
     "drive": {
        "selected_car_number": "x111xx799" //номер выбранной машины
     },
     ...
  }
}
```

Поведение после финализации адреса аналогично текущему флоу драйва. 

При выборе адреса на карте дергаются layers с `mode=drive,screen=choose_b`, 
а также добавляется номер выбранной машины (чтобы отрисовывать машинку на карте):
```json5
{
  "state": {
     "mode": "drive",
     "screen": "choose_b",
     "drive": {
        "selected_car_number": "x111xx799" //номер выбранной машины
     },
     ...
  }
}
```

Коды ошибок те же.
**TODO: при получении ошибки no_cars можно переходить на карту с выбором машинок, 
а не на главный**

#### Экран с оффером на карте
После финализации также открывается экран с оффером. 
Обработка ошибок та же, что и на экране выбора офферов в текущем флоу. 
В запросе layers также указывается `state.drive.selected_car_number.`


#### Доработки на бэке Драйва
В ручке офферов поддержать указание номера машины, для которой нужен оффер. 

#### Доработки в SDK Драйва
Карточка со списком офферов, которая умеет принимать номер машины и список 
адресов, для которых нужно сгенерить офферы. По нажатию на сгенеренный оффер 
сразу бронируется машина. По нажатию на "Указать адрес" посылается сигнал 
об открытии экрана саджеста.


