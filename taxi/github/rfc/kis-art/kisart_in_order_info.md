# Контекст

По просьбе ДепТранса мы должны отображать в приложении такси для водителя признак: зарегестрирован ли водитель в КИС АРТ или нет. Сильнее погрузиться можно тут https://st.yandex-team.ru/TAXIPROJECTS-2661 или в связанных.

![Макет](https://s715sas.storage.yandex.net/get-tools_st/4585726/prod_attach_41658894_1635343820061?ts=0005cf68e09813f3&content_type=image%2fpng&filename=Frame%201.png&disposition=inline&sign=d43baaf26dc85d3bd2fa6cd0e39c92debe21c64d1d7cc14d1e200ddf4405a52e)
На макете видно плашку КИС АРТа в разделе Водитель

КИС АРТ - Комплексная информационная система «Аналитика Работы Такси». На данный момент к ней у нас подключены только почти все водители такси Москвы и МО (дальше её не раскатывали ещё). И в итоге на данный момент существует где-то 157т профилей. Если система хорошо себя покажет, то возможна её раскатка за пределы МО. Для справки, в такси сейчас около 810к водителей, их число за последний год вырасло на 36% (основано на https://tableau.taxi.yandex-team.ru/#/views/Regionprofile2_0_15847161968910/Regionprofile?:iid=1).

Данные о регистрации в этой системе у нас есть в сервисе deptrans-driver-status

# Задача

Прокидывать с бэка в детали заказа заголовок для плашки про КИС АРТ + тег картинки для водителей, которые зарегистрированы в системе.

# Как решаем

## Где есть данные

Данные о водителях есть в сервисе deptrans-driver-status. Их уже сейчас можно запросить из ручек /internal/v1/profiles/bulk-retrieve (балковая ручка по профилям водителей) и /internal/v2/profiles/updates (ручка для обновления инкрементального кэша с профилями водителей).

Тайминги у существующих ручек deptrans-driver-status для 95pc в пределах 200мс, для 98pc в пределах 300мс. Насколько понял, в основном связано с крос дц запросами в базу и большим количеством запрашиваемых профилей.

В связи с багом, который, насколько понял, возникает из-за невозможности сейчас выгружать во время запросы две таблицы (профилей и заявок) целиком, в результате мёрж получается неточный. И сейчас неточности мёржа чинятся запуском скрипта. За последние 2 месяце было выявлено 800 расхождений в статусах профилей.
Но важно отметить, что баг есть только в ручке обновления кэша, из-за особенностей выдачи данных кусками по курсору, в просто балковой ручке его нет.

Также стоит отметить, что мёрж для нашей задачи на самом деле не актуален. Он позволяет для водителей, у которых нет профиля, определить подали ли они уже заявление или нет. В нашей же задаче это знание лишнее.

<details>
<summary>Вариант потерявший актуальность, когда разобрались что происходит при мёрже</summary>

## Как получаем данные (вариант с кэшом и ручкой в deptrans-driver-status)

### Кэш

Для того чтоб по заказу быстро получать готовый блок данных о регистрации в КИС АРТе для водителя, можно сделать в сервисе deptrans-driver-status кэш, в котором хранить уже итоговые профили водителей в дептрансе, после мёржа таблиц с профилями и заявками. Хранить в кэше следующие данные для каждого водителя:
- license_pd_id
- status (статус профиля в КИС АРТ)
- deptrans_pd_id
- updated_ts

Был ещё вариант с хранением по driver_id/park_id, но тогда для каждого водителя может приходиться несколько разных строк, так как водители могут иметь профили в разных парках. В итоге кэш потребуется бОльшего размера.

Также докину сюда плюсы/минусы использования в кэше license_pd_id вместо driver_id/park_id, которые отметил Дмитрий Коргун
Плюсы:
    - Новые профили будут "автоматически" попадать в кеш без задержек. С park_id/driver_id это произойдёт только при full апдейте;
    - Скорее всего логика "слияния" табличек profiles и requests будет проще;
    - В некоторых местах сервиса будет удобнее пользоваться кешом;

Минусы:
    - В некоторых местах сервиса пользоваться будет менее удобно, но т.к. у нас есть кеш профилей поменять driver_licesne_pd_id на список park_id/driver_id (и наоборот) будет довольно дешево;

Оценю место под кэш. Оценки будет две: для сейчас (157т профилей в Москве с запасом на всякий сразу х2, типа для 300т профилей), для суперсветлого будущего, где в систему попали все водители вообще в России/СНГ (возьму для оценки сверху тупо всех водителей на момент через 3 года, предпологая, что рост не увеличиться. Т.е. 810 * 1.36^3 = 2012т).

Предполагаю, что на каждую строку надо (8 + 32) * 4 = 160 байт (предполагаю, что updated_ts вряд ли займёт больше места, чем его строковое представление). Предполагаю, что кэш обновлять будем не чаще раза в минуту (то есть сильно дольше, чем любой запрос => в памяти будет максимум 2 кэша).

Итого:
- на сейчас надо 300т * 160 * 2 ~ 92 Мб;
- на будущее надо 2012т * 160 * 2 ~ 614 Мб.

Данные для наполнения будем получать аналогично существующим ручкам путём мёржа данных из таблиц существующих профилей и заявок. Но соответственно подправив багу в логике мёржа.

### Ручка

Для получения же блока данных по конкретному водителю сделаем ручку там же в deptrans-driver-status, в которой по связке driver_id + park_id будем отдавать данные для totw уже готовым блоком для водителей, зарегистрированых в кис арт (статусы профилей temporary и approved):
{
    "title": Есть профиль в системе КИС 'АРТ' Депортамента транспорта Москвы",
    "image_tag": <тег картинки-символа кис арта>
}
Либо пустым ответом {} в случае, если водитель не имеет профиля в КИС АРТ (все остальные статусы профилей).

Ответ кешируем в тотв через api-cache по driver_id + park_id (кажется, что норм, если в течении заказа не будут прорастать изменения по состоянию профиля). Это сэкономит нагрузку, вместо 5к от тотв будем иметь всего 150-200 от ordercommit.

### Оценка

Этапы (ревью с предыдущего этапа идёт фоном в следующем):
1. Кэш в deptrans-driver-status; 4д
2. Ручка в deptrans-driver-status; 1д
3. Подключение в totw; 1д
4. (доревьюиться + выкатиться) 1д

Суммарно - 6 дней


Плюсы этого решения:
- тайминги ручки будут очень хорошими, так как будут требоваться только обращения к кэшу (кэшам, если точнее) для ответа;
- оно не костыльное;
- оно поможет партнёрке побороть баги в данных (что будет критично, когда начнут блокировать водителей за отсутствие профиля КИС АРТ);
- опять же и мы не страдаем от ошибках в данных.

Минусы:
- будет довольно долгим в реализации;

</details>

## Как получаем данные (вариант: ручка в deptrans-driver-status с одним запросом в базу)

Для получения же блока данных по конкретному водителю сделаем ручку в deptrans-driver-status, в которой по связке driver_id + park_id будем отдавать данные для totw уже готовым блоком для водителей, зарегистрированых в кис арт (статусы профилей temporary и approved):
{
    "title": Есть профиль в системе КИС 'АРТ' Депортамента транспорта Москвы",
    "image_tag": <тег картинки-символа кис арта>
}
Либо пустым ответом {} в случае, если водитель не имеет профиля в КИС АРТ (все остальные статусы профилей).

Внутри ручки будем менять driver_id + park_id на license_pd_id и уже по нему делать запрос в таблицу за профилем. На основе полученных данных формируем ответ

Ответ кешируем в тотв через api-cache по driver_id + park_id . Нам ок, то что состояние подписки постоянно в течении заказа. Это сэкономит нагрузку, вместо 5к от тотв будем иметь всего 150-200 от ordercommit.

Этапы:
1. Ручка в deptrans-driver-status; 1 д
2. Подключение в totw; 1 д
3. Доревьюиться и выкатить; 1 д

Плюсы:
- тайминги будут лучше, чем у ручки /internal/v1/profiles/bulk-retrieve, вероятно, запрос в базу только 1 и только по одному профилю;
- ошибок в данных для нас не будет, данные в таблице профилей фактически верные;
- Довольно быстро реализовывать;
- Переводы сделаны по нормальному в сервисе.

## Как получаем данные (вариант супербыстрый и костыльный)

Ходим в балковую ручку за статусом профиля водителя /internal/v1/profiles/bulk-retrieve . Собираем данные для ответа прям в апи-прокси в тотв. Для перевода используем эксперимент (добавляем специальную секцию l10n и прогоняем эксп через протокол), тег либо выносим в конфиг, либо хардкодим.

Суммарно делать: 2 дня

Минусы такого решения:
- костыльно (особенно эксперимент, который в будущем надо будет на что-то постоянное заменять);
- получаем ошибки из-за проблем с мёржем заявок и существующих профилей;
- тормозим тотв медленными запросами (на самом деле, только один раз, когда ещё нет в кэше).

Плюсы:
- быстрое (как будто бы можно нафигачить за пару дней).

## Как получаем данные (походы в deptrans-driver-status через order-parts)

В сервисе order-parts добавляем блок данных в ручку /v1/frequency/mid, в ней ходим в балковую ручку /internal/v1/profiles/bulk-retrieve, формируем блок (с текстом и тегом картинки) либо пустой ответ для водителей без КИС АРТа, отдаём в тотв. В тотве кэшируем (сейчас ответ и так кэшируется).
(тут можно сделать микрооптимизацию, ходить из тотв параллельно в order-parts и deptrans-driver-status, формировать данные на основе обоих ответов. Тогда тайминги запросов до сервисов не будут суммироваться, как в случае, когда один запрос делается из другого)

Этапы:
1. Добавить логику в order-parts; 1 д
2. Подключить получение блока данных в тотв; 1 д
3. Выкатить; 0.5 д

Итого: 2.5 д

Минусы такого решения:
- тайминги будут не лучше, чем у ручки /internal/v1/profiles/bulk-retrieve (но только 1 раз на заказ до кэширования);
- будем страдать от баги с мёржем в источнике данных;

Плюсы:
- Довольно быстро реализовывать;
- Переводы сделаны по нормальному в сервисе;

## Как получаем данные (походы в deptrans-driver-status через order-parts + кэш)

В сервисе order-parts делаем кэш профилей КИС АРТа с обновлением через ручку /internal/v2/profiles/updates. Также в order-parts в ручке /v1/frequency/mid готовим блок данных про КИС АРТ, в ней ходим созданный кэш, формируем блок (с текстом и тегом картинки) либо пустой ответ для водителей без КИС АРТа, отдаём в тотв. В тотве кэшируем (сейчас ответ и так кэшируется).

Этапы:
1. Пишем кэш в сервисе order-parts; 2 д
2. Добавить логику в ручку в order-parts; 1 д
3. Подключить получение блока данных в тотв; 1 д
4. Выкатить; 0.5 д

Итого: 4.5 д

Минусы такого решения:
- будем страдать от баги с мёржем в источнике данных;
- относительно долго реализовывать (в районе недели);
- имеем не очень уместный кэш в order-parts;

Плюсы:
- Переводы сделаны по нормальному в сервисе;
- тайминги не ухудшаем.

## Как получаем данные (писать куда-то признак для заказа в начале)

Писать в начале заказа в какую-то базу признак для водителя в КИС АРТ он или нет. В процессе заказа ориентироваться на базу.

Это не критичная для заказа информация, поэтому в order_proc/orders её положить не получится. Других вариантов пока не придумал.

TO_DO: Додумать варианты, оценить, если актуально будет

## Как отдаём клиентам

В любом случае для клиентов будем отдавать блок данных в объекте driver ответа totw в случае, если водитель зарегистрирован в КИС АРТ:
"driver": {
    ...
    "kis_art": {
        "title": Есть профиль в системе КИС 'АРТ' Депортамента транспорта Москвы",
        "image_tag": <тег картинки-символа кис арта>
    }
    ...
}

В случае, если водитель не зарегистрирован, то вообще ничего не будем добавлять.

# Итого

<details>
<summary>Выводы до того, как разобрались что происходит при мёрже</summary>
Я бы точно отказался бы от самого костыльного варианта. Так как функционал в целом не временный да и спешки особо большой нет.

Я ещё раз посмотрел тайминги, у тотва они 200мс+ сейчас по 95pc и 250мс+ по 98pc, то есть мы их заметно не ухудшим, просто изредка один из первых запросов по заказу в тотв будет подтормаживать до 300-400мс, на фоне существующих скачков - не заметно. Итого на уменьшении времени запроса я б не концентрировался.
Поэтому я б откинул вариант с кэшом в order-parts, так как по масштабам он приближается к самому качественному решению с фиксом баги в deptrans-driver-status + кэш профилей КИС АРТа в order-parts немного не к месту, кмк. Вариант с базой, хоть и не проработан, скорее всего тоже будет по стоимости разработки приближаться к варианту с кэшом в deptrans-driver-status, так как придётся писать отдельно где-то запись в базу, потом где-то получение из базы + формирование ответа для тотв.

Итого остаётся два решения:
- относительно быстро реалезуемое через order-parts без кэша, но с ошибками в данных;
- кэш в deptrans-driver-status + фикс бага, которое реализуется раза в 2 дольше, но зато решает проблему с ошбиками в данных.

По выбору синкнулся в телеге с менеджером Настей Романовой. Она ок делать более долгое решение, но с фиксом данных.
</details>

Исходя из всего выше написанного в итоге вариант с ручкой в deptrans-driver-status, которая делает один запрос в таблицу профилей и не смотрит на заявки, наиболее подходящий для решения нашей задачи сейчас. Его и возьму в разработку.
