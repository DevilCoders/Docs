**Название сервиса**
fleet-storage-manager

**Какую продуктовую проблему решает сервис?**
Уметь делать долгие асинхронные задачи и работать с файлами. 
Уметь делать ограничения на коли-во таких операций по park_id, clid, user_id, тип_операции
Уметь контролировать и мониторить нагрузку, а также нагрузку на чужие сервисы
Файлы в MDS с ttl
Уметь кешировать данные запросов от юзера с ttl

**Почему нельзя решить эту задачу без разработки нового сервиса существующими решениями?**
Текущее решение (считать в реалтайм) подходит только для небольших объемов данных.
Вариант через библиотеку ограничен одним языком + пришлось бы цеплять БД к каждому сервису потребителю.
Если делать в рамках одного сервиса, то будет сервис-монолит.

**Как именно сервис будет решать поставленные перед ним задачи?**
Cервис будет связующим звеном для остальных сервисов с выгрузкой в диспетчерской.

На старте планируется:
Rate limiter. Будем по конфигу ограничивать количество операций на формирование файлов.
Кэш запросов. Если какой-то файлов уже посчитали, то отдаем готовую ссылку на файл, а не пересчитываем с нуля.
Отдать ссылку на скачивание. Сервис предоставит внешний URL для скачивания файла по ID, проверит права, сгенерирует ссылку на скачивание в MDS и сделает на нее редирект.
Уведомление юзера о готовности файла. Email, notifications. По апишке через поллинг со стороны клиента. 

Другие сервисы будут самостоятельно формировать файлы и отправлять в S3-MDS, синхронизируя действия с связующим сервисом.
Первым таким сервисом планируется fleet-reports.

Примерный флоу:
1) Юзер нажал "скачать".
2) Запрос ушел в fleet-reports
3) Синкаемся по апи с fleet-storage-manager (rate limiter, cache...)
4) Если все хорошо, то запускаем STQ таску на создание файла.
5) Когда файл будет готов юзер получает уведомление с ссылкой на файл

Чтобы внешний юзер мог скачивать с MDS планируем подключить приватный балансер https://wiki.yandex-team.ru/mds/s3-api/FAQ/#nazapisichtenie-s3-private.mds.yandex.net
Также используем presigned url https://cloud.yandex.ru/docs/storage/concepts/pre-signed-urls

**Разрабатывается один сервис или система?**
Система

**С кем взаимодействует сервис?**
Сервис будет ходить в:
- sticker
- fleet-notifications
В сервис будут ходить:
- fleet-reports
- fleet-web через fleet-authproxy

**Какие базы использует?**
Название - fleet-storage-manager.
Новая.
На postgresql.

**Какие периодические процессы?**
Удаление устаревших файлов из MDS и БД
Обработка зависших операций. Например какая-то операция висит 3 дня в работе, мы ее закрываем и делаем рассылку пользователям "не удалось сформировать файл, попробуйте еще раз или обратитесь в техподдержку".

**Планируется обработка персональных данных**
Нет

**Какие данные и по какой схеме сервис будет хранить в базе?**
operations
- id
- park_id
- clid
- passport_uid
- type - например отчет по заказам, по транзакциям
- filters - json с фильтрами от юзера
- status - на каком этапе сейчас формирование файла
- file_id - id файла в mds
- created_at

**Какой объем данных будет храниться и какой объем будет изменяться в единицу времени?**
Незначительный

**Какие операции над данными заложены?**
select, update, delete

**Есть ли какой-то стейт в памяти, как он обновляется и валидируется?**
При необходимости положим часть базы в кэш. Например для rate limiter или кеширования запросов от юзера.

**Какая нагрузка ожидается?**
До 5 rps

**Какие фолбеки предусмотрены на сам этот сервис?**
Нет

**Какие фолбеки предусмотрены внутри этого сервиса на взаимодействие с другими сервисами?**
Нет

**Какие возможности масштабируемости закладываются?**
Горизонтальное масштабирование

**Какие точки отказа есть в сервисе?**
База

**Укажите ключевые продуктовые метрики сервиса, за которыми планируете следить**
Что и как часто скачивают пользователи

**Укажите технические метрики**
rps, квота в MDS

**Какая функциональность ожидается в сервисе в будущем?**
Развитие ACL, апишка для раздела "мои файлы"

**Какое изменение нагрузки планируется?**
Пропорционально росту такси

**Активно ли будет изменяться сервис?**
Только на этапе разработки.