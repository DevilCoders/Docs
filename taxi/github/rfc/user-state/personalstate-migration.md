# Для справки: как сейчас работает сверка запросов в personalstate
1. Запрос /personalstate приходит в api-proxy (AP). В протокольную ручку запрос идет всегда, а в новую - только если юзер попадает в эксперимент `userstate-personalstate-enabled`. Порядок запросов: сначала новая ручка, потом старая, потом - в ручку сверки (см. ниже). Почему не ходим параллельно в старую и новую - если ходить параллельно, то запросы на запись не получится сверять: новая ручка будет видеть или неизмененное или уже измененное состояние, и во втором случае будет выдавать 409.
2. Ходим в отдельную ручку в `user-state`, которая просто сверяет 2 json (ответы от старого и нового personalstate) с точностью до порядка в массиве tariffs (он может не совпадать и это ок).
2. Она отдает 200 если совпадают, и 409 если нет. Поэтому удобно смотреть все расхождения на графиках и в [https://tariff-editor.taxi.tst.yandex-team.ru/logs2?phone_type=yandex&type=%2Finternal%2Fcompare_jsons](логах).
3. Ходим, только если получили оба ответа
4. Если запрос на запись (с `revision_id`) то добавляем в запрос к `user-state` хедер `X-Ya-Mock-Write-Request`.
По нему ручка не пишет в базу (но старается сделать по-максимум остального).
Предпочли этот вариант варианту с отдельной базой, потому что так быстрее и проще, и кажется проверим 90% функционала на запись.

# План по раскатке personalstate
1. Проверяем сами на тестинге, в том числе запросами с прода
2. Включаем на тестинге сверку на всех (экспериментом) (2д)
  2.5 Просим тестировщиков тоже проверить на тестинге, они готовы помочь (1д)
3. Настраиваем api-proxy (AP) на проде, с выключенным экспериментом
4. Выктаываем client_proxy, который ходит в AP. В этот момент ничего не должно поменяться
5. Постепенно (команда - 1% - 5% - итп - 100%) включаем в АР поход в новую ручку (с фоллбеком на старую) и сверку ответов.
5.5 Раскатку на запросы на запись делаем отдельным экспериментом, и раскатываем его позже и более внимательно, чем запросы на чтение.
6. Когда убедились что ответы совпадают, два варианта: 
  а) либо сразу переключаем на новую ручку, 
  б) либо убираем сверку но эксперимент включаем на 1% и тоже постепенно повышаем. Кажется это более безопасно
  Склоняюсь к первому варианту но может будут аргументы за более осторожное переключение.
7. Выпиливаем код по сверке ответов из сервиса и из `user-state/personalstate`
8. Выпиливаем старую `personalstate` из протокола
9. Думаем о переходе на PG
