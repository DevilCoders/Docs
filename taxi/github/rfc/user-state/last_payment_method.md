## Бизнесовая задача

### Описание

Хотим иметь возможность в супераппе такси, показывать последний использованый тип оплаты отдельно для каждого сервиса.
С учётом разделения по флоу (заказ оплачен по бейджу, чаевые по карте)
https://st.yandex-team.ru/TAXIBACKEND-27908

### Текущее решение в Такси

В колллекции [user_phones](https://github.yandex-team.ru/taxi/schemas/blob/6d5ce9caab37f949c4b33b83af0aa87dbfb02b53/schemas/mongo/user_phones.yaml#L72) хранится последний тип оплаты.

В ручке `3.0/paymentmethods` мы достаём данное поле из http://user-api.taxi.yandex.net/user_phones/get

Сохранение нового последнего типа оплаты происходит в ручке `3.0/orderdraft`

## Архитектура

### Высокоуровневая архитектура

Новый сервис будет заниматься хранением специфичных пользовательских данных.
Например: последний метод оплаты

### Компоненты

#### Сервис `user-state`

Разработка сервиса будет осуществлена в несколько этапов. 
На этапе MVP будут реализованы лишь internal ручки для поддержки супераппа.

Сервис будет написан на uservices

Логика работы:
- В ручке PUT получаем список flow и сохраняем/обновляем зачения в базе для текущего пользователя
  При этом, нужно инвалидировать flows которые не пришли в запросе (UPDATE payment_type на NULL / Или DELETE всей строки).
- В ручке GET делаем SELECT запрос в базу с yanex_uid/bound_uids и service.

### API

[api.yaml](api.yaml)

### Нагрузка

#### Нагрузка на `user-state`

На этапе MVP, ожидается нагрузка в пределах 2рпс `internal/v1/last-payment-methods`, это рассчитано следующим образом:
  * Запросы из ручки `4.0/list-payment-methods` `api-proxy` (0.7рпс)
  * Запросы из ручки `preorder` сервиса `payments-eda` (0.5рпс)

Нагрузочное тестирование не делается.

### Внешние сервисы

#### СУБД

Postgresql - как дефолтная база. 

Пример таблицы:

 yandex_uid | service | flow  |          created_at           |          updated_at           |             payment_info             
------------|---------|-------|-------------------------------|-------------------------------|--------------------------------------
 4018711532 | taxi    | order | 2020-04-19 20:18:04.670456+03 | 2020-04-19 20:18:04.670456+03 | {"payment_method": {"type": "cash"}}

```
CREATE TABLE payment_methods (
    yandex_uid TEXT PRIMARY KEY,
    service TEXT NOT NULL,
    flow TEXT NOT NULL,
    created_at TIMESTAMPTZ NOT NULL,
    updated_at TIMESTAMPTZ NOT NULL,
    payment_type jsonb,

    PRIMARY_KEY(yandex_uid, service, flow)
);

```

#### Используемые сервисы

На этапе MVP внешние сервисы использоваться не будут.

### Клиентская логика

Клиентская логика - не меняется.

### Отказоустойчивость

Фолбеки MVP:
При неудачной попытке сохранить последний тип оплаты - не сохраняем.
При неудачно попытке прочитать последний тип оплаты - считаем что последний тип оплаты отсутсвует, на клиентах включается уже имеющийся фолбек. (наверное выбирают первый из доступных)

Фолбеки:
На основе статистики собранной после этапа MVP, примем решение о использования stq для повышения гарантии сохранения.

### Мониторинги, алерты, бизнесовые графики, логи

1. Ссылки на дашборды (пусть и без всех графиков пока).
2. Описание основных мониторингов.
3. Как будет организован алертинг.
4. Какие бизнесовые метрики будут собираться в соломон.
5. Что с репликацией логов.

### Технические ограничения

Чем мы осознанно жертвуем: алертами, отсутствием запаса под xN рост, редкие гонки, отсутутвие необходимого рефакторинга и тп. ВСЕ должно быть четко описано и скоммуницировано менеджеру и ревьюеру архитектуры.

### Этапы

1. MVP: internal ручки для изменения/получения последнего типа оплаты - 7 - 9д
  * Арх + сек ревью + завести базу - 1 - 3д
  * Реализовать PUT ручку - 2д
  * Реализовать GET ручку - 1.5д
  * интегрироваться с `4.0/list-payment-methods` - 1д
  * интегрироваться с `v1/preorder` - 1.5д
2. Интеграция с флоу заказа такси - ?д
  * Проработка переезда - 3д
3. Перенос ручки `3.0/personalstate` - ?д
  * Проработка переезда - 3д
  
### Флоу MVP:

- В payments-eda, в ручке preorder, будем дёргать ручку сохранения текущей конфигируации метода оплаты (непонятно как будут выглядеть чаевые, выше лишь вольная интерпритация).
- Из `4.0/list-payment-methods` будет дёргаться ручка `internal/v1/last-payment-methods`

### Безопасность

Сервис не хранит личных данных пользователя.
В качестве основного идентификатора, используется `yandex_uid`
