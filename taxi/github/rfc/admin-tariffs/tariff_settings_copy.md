# Решаемая задача

Добавить в админку функционал, который позволял бы копировать в разделе Настройки тарифов:
 - Настройки зоны из указанной зоны в указанные зоны (зону);
 - Все тарифы из указанной зоны в указанные зоны (зону);
 - Конкретный тариф из указанной зоны в указанные зоны (зону).

Также выяснил, что следует учитывать следующие тонкости:
 - При копированни настроек тарифа/тарифов из зоны в зону нужно, чтобы копировались только те тарифы, которые заведены в tariffs (другими словами, для которых прописаны интервалы в зоне);
 - Если в целевой зоне такой тариф уже есть, то его нужно затереть и на его место вставить копируемый;
 - При копировании настроек зоны копировать надо не все поля: tz, city_id, classifier_name, country - нужно оставить, а всё что ниже (на странице админки) заменить на скопированные значения;
 - работать должно также через апрувы драфта, как и при просто изменении настроек тарифов в админке;
 - поддтверждать должны те же люди, что и просто изменения;
 - можно всё копирование объединить в одно, то есть настройки зоны и категории из настроек зоны (но оставить возможность выбрать, копировать что-то одно, либо всё сразу);
 - наиболее частые кейсы копирования тарифов - по одному, либо все сразу. Кейс, когда надо несколько, но не все - очень редкий.

# Основные этапы реализации

Этапы сформированы на основе [wiki по Админке без кода](https://wiki.yandex-team.ru/taxi/backend/adminka-bez-koda/). Уточнял в чате поддержки, вроде как, алгоритм верный.

1. Написать ручки для копирования настроек тарифов и копирования настроек зон (+ по дополнительной ручке на каждую для проверки драфта, но об этом ниже);
2. Прописать в backend-py3/services/taxi-approvals/taxi_approvals/services_schemes/ [yaml с настройками новых ручек для approvals](https://wiki.yandex-team.ru/taxi/backend/architecture/approvals/#detaliporabotesservisom);
3. Прописать в backend-py3/services/taxi-api-admin/taxi_api_admin/services_schemes/ yaml [с настройками для АБК](https://wiki.yandex-team.ru/taxi/backend/adminka-bez-koda/#strukturasxemynastroekservisa);
4. Пробить дырки с сервисов апрувов и импортов до taxi-tariffs + прописать TVM правила. [Об этом тут](https://wiki.yandex-team.ru/taxi/backend/architecture/approvals/#integracijavsvojjservis);
5. После выкатки всего этого создать задачу в очередь TAXIFRONTINFRA на доработку интерфейса админки.

# О новых ручках

## Куда добавить новые ручки

Подробно процесс выбора был описан в другом [ПРе](https://github.yandex-team.ru/taxi/rfc/pull/371/files#diff-7940ed9db02ac88dc1b9198b22acc004R28), копировать не вижу смысла. Рассматривались два варианта: создание нового сервиса admin-tariffs и добавление функционала в сервис taxi-tariffs.
Перенесу только основной вывод:
Рациональным кажется добавление нового функционала админки в сервис taxi-tariffs, так как это сильно уменьшит время разработки за счёт переиспользования кода и отсутствия необходимости заводить новый сервис.

## Какие ручки добавить

Исходя из поставленной задачи, кажется разумным создать одну ручку, которая будет в зависимости от переданных параметров копировать настройки зоны и тарифы либо выборочно что-то одно из них. Тарифы копировать опять же только те, что пришли в запросе, также учитывая, что копировать можно только те, у которых в целевой зоне настроены интервалы.
Отдельно отмечу, заказчик сказал, что им не нужно копировать настройки антифрода, они их настраивают один раз при создании тарифа, поэтому функциональность добавлять не буду. Доделать, если необходимость возникнет, больших проблем не составит.

Но учитывая [особенности работы сервиса Approvals](https://wiki.yandex-team.ru/taxi/backend/adminka-bez-koda/) кроме ручки, которая осуществляет копирование, нужно будет ещё создать ручку для проверки драфта.

Также Approvals вводит некоторые требования для ручек применения драфта, которые я учёл при проектировании API.

API разрабатываемых ручек привожу в отдельном файле tariff_settings_copy_api.yaml

## Основные сложности

### Заблокировать создание двух драфтов для одного tariff_settings

Для того чтобы не возникало путаницы при редактировании Настроек тарифа нужно запретить создание драфта, если драфт для изменения настроек в этой зоне уже создан.
В сервисе Approvals для этого предусмотрен механизм блокировки. Для его использования нужно из ручки для проверки драфта возвращать массив lock_ids, который содержит набор id-шников, соответствующих изменяемым сущностям. В нашем случае сущности это документы tariff_settings, которые соответствуют разным зонам. В результате, при попытке создать драфт с множеством lock_ids, которое пересекается с lock_ids созданных и не закрытых драфтов, создание драфта упадёт.
Но есть одна проблема. Кроме нашей новой ручки для копирования, эти же tariff_settings могут быть изменены ручкой [set_tariff_settings/apply](https://github.yandex-team.ru/taxi/backend/blob/develop/taxi-admin/taxiadmin/api/views/tariff_settings.py#L817) из py2 (плюс ручка для проверки [set_tariff_settings/check](https://github.yandex-team.ru/taxi/backend/blob/develop/taxi-admin/taxiadmin/api/views/tariff_settings.py#L741)). То есть надо, чтобы блокировка также не давала создать драфт через ручку в py2 для зон, которые уже меняются в драфте с копированием. Но в ручке set_tariff_settings не возвращаются набор lock_ids. Поэтому ручки не заблокируют друг друга.
Поправить положение можно двумя путями:
1. (простой) дописать в возвращаемые параметры ручки set_tariff_settings/check lock_ids.
Плюсы:
    Не увеличит время разработки, изменение делается в две строчки буквально;
Минусы:
 - Доработка в py2, правки в котором уже не желательны;
 - lock_ids должны и в py2, и в py3 сформированы по одной схеме (иначе блокировка не получится), и если кто-то поменяет схему в одном месте и забудет поменять в другом, то мы получим внезапно возможность создания драфтов одновременно обоими способами;

2. (трудоёмкий) перенести set_tariff_settings/check и set_tariff_settings/apply из py2 в py3:
Плюсы:
 - Вынос кода из py2 в py3;
 - lock_ids для tariff_settings будут формироваться в одном месте (более того, вероятно, все способы изменить из админки tariff_settings окажутся в одном месте);
Минусы:
 - Увеличится время на разработку: нужно перенести около 800 строк кода из старого бэкенда.

Вывод:
    В результате пришли к договорённости, что буду вносить правку в py2, а в техдолг заведена [задача на вынос кода](https://st.yandex-team.ru/TAXIBACKEND-28908). (так как вынос увеличивает задачу слишком сильно)

### Связь с коллекцией tariffs

В связи с тем, что при копированни настроек тарифа/тарифов из зоны в зону нужно, чтобы копировались только те категории, которые заведены в tariffs (другими словами, для которых прописаны интервалы в зоне), возможно, было бы логично блокировать создание драфтов и для tariffs. С другой стороны, сейчас возможность создать драфт для tariffs одновременно с tariff_settings не блокируется. Просто, если интервала не оказывается в tariffs, изменение tariff_settings падает с ошибкой.
Опять же возможны несколько вариантов:
1. Не блокировать:
Плюсы:
 - Никакой дополнительной разработки;
Минусы:
 - Если между созданием и применением драфта для tariff_settings кто-то изменит tariffs, то скопируем меньше тарифов, чем пообещали;

2. Добавить в ручку изменения тарифов в py2 lock_ids, а в новой ручке также проставлять lock_ids для документов из tariffs, соответствующих заданным зонам (вероятно, аналогичную блокировку для единообразия надо будет добавить и в ручки set_tariff_settings):
Плюсы:
 - Сравнительно маленькая доработка;
 - Никто не сможет поменять tariffs пока происходит копирование tariff_settings для зоны;
Минусы:
 - Правки в py2;
 - lock_ids должны и в py2, и в py3 сформированы по одной схеме (иначе блокировка не получится), и если кто-то поменяет схему в одном месте и забудет поменять в другом, то блокировка исчезнет; 

3. Перенести из py2 [set_tariff_apply](https://github.yandex-team.ru/taxi/backend/blob/develop/taxi-admin/taxiadmin/api/views/tariffs.py#L1972), [set_tariff_check](https://github.yandex-team.ru/taxi/backend/blob/develop/taxi-admin/taxiadmin/api/views/tariffs.py#L1869) ([задача на вынос кода](https://st.yandex-team.ru/TAXIBACKEND-28911)):
Плюсы:
 - Вынос кода из py2 в py3;
 - lock_ids для tariffs будут формироваться в одном месте (более того, вероятно, все способы изменить из админки tariffs окажутся в одном месте);
Минусы:
 - Увеличится время на разработку: нужно перенести около 600 строк кода из старого бэкенда.

Вывод:
    В результате выяснилось, что текущее положение вещей с возможностью содать параллельно драфты на tariffs и tariff_settings всех устраивает, поэтому здесь ничего делать в итоге не буду
