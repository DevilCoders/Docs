## Опросник для ревью комитетом

> Этот опросник нужен для [архитектурного ревью комитетом](https://forms.yandex-team.ru/surveys/25357/). Его можно будет скопировать.

**Название сервиса**

card-antifraud

**Какую продуктовую проблему решает сервис?**

Угон аккаунта позволяет выводить деньги с привязанных карт. Нужно научиться защищать карты от такой атаки.

**Почему нельзя решить эту задачу без разработки нового сервиса существующими решениями?**

Можно этот функционал положить в cardstorage

**Как именно сервис будет решать поставленные перед ним задачи?**

Клиентские ручки (paymentmethods, changepayment, order, ordercommit) будут проверять через этот сервис
возможность использовать карту

В клиентском приложение будет реализован флоу верификации карты для устройства

**Разрабатывается один сервис или система?**

Один новый сервис + изменения в существующие

**Сколько и какие сервисы входят в систему?**

Изменения в protocol (order, ordercommit, changepayment) и настройки api-proxy(paymentmethods)

**С кем взаимодействует сервис?**

Сервис взаимодействует с
user-api
protocol
api-proxy
passenger-authorizer
trust-payments (либо transactions)
сервис конфигов
сервис экспериментов

2. Как гарантируется идемпотентность внешний операций.
Внешняя операция одна - верификация карты.
Запуск верификации - двустадийный процесс:
1) создать верификацию - /verify/draft - создает верификацию в хранилище
2) запустить верификацию - /verify/commit - инициирует платеж и его процессинг

3. Как поддерживается консистентность данных при частичных отказах.
Транзакции имеют ограниченное время жизни. Если пользователь/процессинг не пришел в транзакцию за таймаут (1день, конфигурируемо) - транзакция считается устаревшей и запускается процесс ее отмены и удаления.

4. Как организованы ретраи внешних сервисов.
статус транзакции в трасте проверяет новая stq таска.
остальные запросы - стандартные ретраи и таймауты, фолбэки продумаем в процессе разработки

**Какие базы использует?**

Используется новая база postgres - хранение верифицированных устройств и карт

**Какие периодические процессы?**
Процессы очистки базы от устаревших данных. Конкретную логику продумаем в процессе разработки.


**Прикрепите схему того, где этот сервис находится в текущей инфраструктуре**

Клиентские ручки (paymentmethods, changepayment, order, ordercommit) будут проверять через этот сервис
возможность использовать карту

**Какие данные и по какой схеме сервис будет хранить в базе?**
TBD:
Какие таблицы, индексы, уровни изоляции транзакций, особенности запросов и тп.
Объем хранимых данных, как их подразумевается чистить. Ресурсы под СУБД (cpu, ram, disk).

**Какой объем данных будет храниться и какой объем будет изменяться в единицу времени?**

...

**Какие операции над данными заложены?**

...

**Есть ли какой-то стейт в памяти, как он обновляется и валидируется?**

...

**Какая нагрузка ожидается?**

Ожидается нагрузка 1000 RPS на ручку `/orders`, это рассчитано следующим образом: ...
Нагрузочное тестирование делается/(не делается).

**Какие фолбеки предусмотрены на сам этот сервис?**

...

**Какие фолбеки предусмотрены внутри этого сервиса на взаимодействие с другими сервисами?**

Фолбэк на каждый компонент должен быть описан. Какие особенности будут при отключении ДЦ. Как будет тестироваться отказоустойчивость.

**Какие возможности масштабируемости закладываются?**

...

**Какие точки отказа есть в сервисе?**

...

**Укажите ключевые продуктовые метрики сервиса, за которыми планируете следить**

...

**Укажите технические метрики**

...

**Какая функциональность ожидается в сервисе в будущем?**

Этапы разработки:

1. MVP: заглушки на сервере для быстрого тестирования клиентов -  3д
  * либо обоснование почему заглушки не нужны.
2. Показ заказов в заново открытом приложении - 10д
  * Подзадача 1, без нее нельзя запускаться так как X - 3д
  * Подзадача 2, без нее нельзя запускаться так как Y - 2д
  * Интеграция с клиентами - 5д
3. Показ заказов всегда - пушим их юзеру - 6д
  * Подзадача 1 - 3д
  * Подзадача 2 - 3д
4. Подчистка техдолга - 7д
  * Подзадача 1 - 3д
  * Подзадача 2 - 4д

**Какое изменение нагрузки планируется?**

...

**Активно ли будет изменяться сервис?**

...

<hr>

> Ниже - не жесткий шаблон, а скорее чеклист того, о чем надо подумать, с примерами заполнения.
> Если ты точно уверен, что какой-то раздел не относится к твоей проработке - не включай его.

## Бизнесовая задача

### Продуктовые ограничения

#### Этап 1

1. Если приложение уже открыто, новые заказы не появятся: для этого нужно делать пуши.

#### Этап 2

1. В кейсе X с вероятностью Y заказы могут не показаться.
2. 15% пушей не доходят, поэтому новые заказы не появятся у части юзеров с открытым приложением.

#### Все этапы

1. Если юзер не залогинен в приложении, заказы через Алису не покажутся.

## Архитектура

### API

#### `Alice`

Ручка `/orders`:

```json
{
    "orders": [
        {
            "ID": 123,
        },
    ],
}
```

Здесь описание ошибочных ответов и различных нюансов использования. Можно в формате `openapi` прикладывать `yaml`-ы.
Идемпотентность ручки гарантируется за счет X.

### Клиентская логика

1. Используется ли web-view. Если нет, то почему.
2. Когда и как (паралелльно/последовательно) дергать ручки.
3. Как ретраить. Что делать при ошибках.
4. Откуда брать тексты (лучше с сервера).

### Технические ограничения

Чем мы осознанно жертвуем: алертами, отсутствием запаса под xN рост, редкие гонки, отсутутвие необходимого рефакторинга и тп. ВСЕ должно быть четко описано и скоммуницировано менеджеру и ревьюеру архитектуры.

### Как раскатываем

#### Раскатка этапа 1

1. По эксперименту X на стафф.
2. На город Y.
3. По остальным городам.

#### Техническая раскатка

За раскатку отвечает эксперимент 3.0, который работает в ручке `/launch` и может раскатываться по следующим аргументам: `personal_phone_id`, `phone_id`, `country`, `yandex_uid`.

### Безопасность

1. Как подключаемся к `GDPR takeout`.
2. Как работаем с ПД.
