## Продуктовая задача

### Описание

Продолжаем интегрировать Драйв в Такси. 

Добавляем шорткат Драйва "Домой на Драйве" (или "На работу").
По нажатию на этот шорткат мы переходим на экран фикса Драйва. На этом экране 
отображаются XXX машинок Драйва на карте с ценой бронирования 
фикса до Дома, среди которых выбрана машинка, для которой отображается оффер
на карточке в SDK. Пользователь может выбрать другую машинку на карте и 
соответственно должен погрузиться другой оффер в карточке SDK.

Шорткат появляется **только** если есть оффер с фиксом до нужного места 
(Дома/работы).

Когда добавится Драйв на саммари, нажатие на шорткат будет переводить нас в 
саммари, где выбран Драйв.

### Гипотеза

Добавление шортката увеличит количество поездок на Драйве из приложения Такси,
так как шорткат сразу бросается в глаза, в отличие от машинок на карте.
Также такой шорткат приблизит нас к интеграции фикса Драйва в саммари.


### Дизайн

![shortcut-drive-v1](https://jing.yandex-team.ru/files/pavelnekrasov/shortcut_drive.jpg "Шорткат Драйва (v1)")

### Положение шортката в сетке

@AKruglyak:
````
Моё мнение такое: 
1. Шорткат драйва для текущих пользователей драйва - строгое добро, но может 
просадить метрики Такси, нужно наблюдение
2. ML умеет подмешивать, там чуть чуть умнее ифов - веса. Я ок ставить рядом с 
Такси, если это дом/работа и не просаживает метрики. Если всё ок, расширять на 
все первые подсказки адресов
````

TODO: обсудить с ребятами из ML

## API

Делаем ручку `/4.0/persuggest/v1/drive-shortcuts`. Ручка дергается не напрямую с 
клиентов, а через api-proxy.

В `/4.0/persuggest/v1/drive-shortcuts` проверяем, что есть хотя бы один оффер до 
первого адреса в нулевом саджесте и если есть, то возвращаем шоркарт с 
контекстом для для хождения в `/4.0/layers/v2/objects`. По 
нажатию на шорткат мы идем в `layers` за объектами  с нужным контекстом 
(в контексте будет храниться информация о точках А и Б).

### На бэке:
#### Расширение эксперимента add_drive_cars

Эксперимент add_drive_cars расширяется секцией `shortcut`:

```json
{
  "enabled": true,
  "shortcut": {
    "enabled": true,
    "subtitle_key": "drive_shortcut.subtitle",
    "car_image_tag": "shortcuts_drive_car",
    "background_color": "#DAE0F8",
    "offer_count_limit": 5,
    "only_registered_users": false,
    "max_distance_to_offer_meters": 400
  }
}
```


#### Ручка `/4.0/persuggest/v1/drive-shortcuts` 
1) Проверяем, что пользователь есть в эксперименте `add_drive_cars`. Если
нет, то возвращаем пустой список шорткатов.
1) Проверяем, что `add_drive_cars.shorcut.enabled`. Если
нет, то возвращаем пустой список шорткатов.
1) Идем в `/umlaas-geo/v1/zerosuggest` за нулевым саджестом. 
1) Если первый адрес zerosuggest не Дом/Работа, то возвращаем пустой список 
  шорткатов.
1) Если в Драйве нет оффера до первого адреса в zerosuggest, то не добавляем 
шорткат.
1) Если расстояние до оффера Драйва превышает 
1) Формируем шорткат "на Драйве". Добавляем в шорткат контекст 
для хождения в layers: точки src, dst, имя destination_name и максимальное число 
офферов.

```
api-4.0 headers
POST /4.0/persuggest/v1/drive-shortcuts
```
```json
{
  "user_context": {
    "bbox": [
      35.8962177956883,
      56.81290553670576,
      35.90024110921064,
      56.808980333875304
    ],
    "pin_position": [
      35.897940886390266,
      56.81144027116202
    ],
    "show_at": "2020-01-01T00:00:00+00:00"
  }
}
```
```json
{
  "scenario_tops": [
    {
      "scenario": "drive_fixpoint_offers",
      "shortcuts": [
        {
          "content": {
            "color": "#F5F2E4",
            "title": "Домой",
            "subtitle": "на Драйве"
          },
          "id": "fe062acb30bb4fb3bba44f71c909838a",
          "scenario": "drive_fixpoint_offers",
          "scenario_params": {
            "drive_fixpoint_offers_params": {
              "action_type": "drive_fixpoint_offers",
              "overlays": [
                {
                  "shape": "car",
                  "image_tag": "drive_shortcut_car_tag"
                }
              ],
              "layers_context": {
                "type": "drive_fixpoint_offers",
                "src": [
                  33.33,
                  55.55
                ],
                "dst": [
                  33.307668,
                  53.246202
                ],
                "destination_name": "Дом",
                "offer_count_limit": 3,
                "preferred_car_number": "м668от799"
              }
            }
          }
        }
      ]
    }
  ]
}

```

Шорткат из ответа `/4.0/mlutp/v1/products`
```json
{
  "type": "drive:fixpoint-offers",
  "height": 2,
  "width": 2,
  "shortcut_id": "drive-fe062acb30bb4fb3bba44f71c909838a",
  "title": "Домой",
  "subtitle": "на Драйве",
  "background": {
    "color": "#DCE9F5"
  },
  "action": {
    "layers_context": {
      "type": "drive_fixpoint_offers",
      "src": [
        33.33,
        55.55
      ],
      "dst": [
        33.307668,
        53.246202
      ],
      "destination_name": "Дом",
      "offer_count_limit": 3,
      "preferred_car_number": "м668от799"
    }
  },
  "overlays": [
    {
      "shape": "car",
      "image_tag": "drive_shortcut_car_tag"
    }
  ]
}

```

#### Расширение ручки `/4.0/layers/v2/objects`
1) В запрос добавляется поле `context`, пока только один тип контекста 
`drive_fixpoint_offers`. Контекст копируется из ответа ручки шорткатов.
1) В ответ добавляется `selected_object_id` - айди выбранного объекта (как будто 
пользователь на него нажал)
1) В DriveCardAction добавляется offer_id для открытия карточки SDK

### На клиенте

1) Шорткат возвращается в ручке `/4.0/mlutp/v1/products`

1) При нажатии на шорткат идем в `/4.0/layers/v2/objects` с контекстом из
 шортката и `"mode": "drive"`. Контекст должен быть передан в корне запроса в поле `"context"`.
 Пример запроса:
 ```json
 {
  "context": {
    "type": "drive_fixpoint_offers",
    "src": [
      37.880318157794707,
      55.754543995739407
    ],
    "dst": [
      37.6425634912552,
      55.73475967775757
    ],
    "destination_name": "Work",
    "offer_count_limit": 5,
    "preferred_car_number": "м668от799"
  },
  "state": {
    "bbox": [
      37.868574701220695,
      55.73813247694166,
      37.892082162849164,
      55.762261637963604
    ],
    "location": [
      37.88048333333333,
      55.755160000000004
    ],
    "mode": "drive",
    "pin": [
      37.880318157794704,
      55.75454471862964
    ],
    "screen": "main",
    "zoom": 14.60303
  }
}
 ```
 
 
 
  layers вернет все машинки на карте с прогруженными офферами. 
Клиент делает объект `selected_object_id` выбранным (как будто на него нажал 
пользователь). При выборе объекта открывается карточка драйва из SDK с 
прогруженным оффером. При нахождении на экране с машинками фикса должны 
все хождения в layers должны быть с контекстом