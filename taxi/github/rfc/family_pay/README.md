# Оплата в семейности 2.0

## `3.0/paymentmethods`

Вид карты и UI для владельца семейной карты не должен отличаться от обычной

В клиентах поддерживающих новый семейный счет появятся supported флаги:

```
supported: ["family"]
```

При наличии флага для участников и владельца семейного аккаунта 2.0 появится новое поле `family`

```json
{
  "coop_account": {
    // ...
  },
  "card": {
    "unverified_cards": [],
    "available_cards": [
      {
        "family": {
          "is_owner": false
          // true для владельца семьи
          // для него доступна ссылка на верификацию
          // POST /4.0/payment/verifications
          // возможны другие поля: expenses, limit, frame, currency
        },
        "description": "Семейный счет: 1000 из 2500р.",
        // только для участников
        // старые поля 3.0/paymentmethods
        "expiration_year": 2022,
        "currency": "RUB",
        "expiration_month": 5,
        "expiration_time": "2022-05-31T00:00:00+0000",
        "system": "VISA",
        "busy": false,
        "number": "****6595",
        "usable": true,
        "id": "card-xb2b4566880d2557f7b152d18"
      }
    ],
    "payment_available": true
  },
  "last_payment_method": {
    "type": "card",
    "id": "card-xb2b4566880d2557f7b152d18"
  },
  "corp": {},
  "apple_country_merchants": {},
  "personal_wallet": {}
}
```

**Если карта недоступна:**

* (для владельца) карта придет в unverified_cards и по тапу запустится верификация
* (для участника) карта не придет

### Логика на клиенте

Если `/description` то показать его где-то в описании метода оплаты. Для владельца description не приходит, фактически
привязанная к семье карта не будет отличаться от остальных.

### Логика в cardstorage

Если карта unverified, то для владельца она приходит в unverified_cards, и по ней возможно запустить верификацию Для
участника unverified карты не приходят.

### Логика в api-proxy/3-0-paymentmethods

Если семейная карта приходит из cardstorage и supported есть флаг `family` то старый семейный счет не показывается по
условию `coop_account.type == 'family' and coop_account.type.details.passport_account == true`.

Это делается для того, чтобы скрывать только смигрировавшие аккаунты, но не скрывать старые. Например, мы не можем
мигрировать конфликтные аккаунты, у которых есть какая-то семья в паспорте, поэтому 

## Проведение платежа

В случае платежа по семейной карте 2.0 клиентом должна быть отправлена следующая информация в `orderdraft`
и `routestats` для ключа "payment":

```json
{
  //...
  "payment": {
    "type": "card",
    "payment_method_id": "card-8719a984f0214afca9e96e92918e1d94"
  }
}
```

С точки зрения логики проведения платежа на бэкенде общий флоу будет в целом идентичен обычному платежу по банковской
карте. Но на уровне процессинга в заказ будет добавлен флаг `/order/request/payment/is_family` (для участника): это надо
для отдельной логики в долгах и чаевых (TODO: отдельный RFC про это)
