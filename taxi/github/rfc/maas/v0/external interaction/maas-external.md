# Контекст

В рамках проекта  Mobility as a Service (MaaS) мы собираемся продавать абонемент на Метро с фиксированным количеством поездок на Такси. Для этого нам нужно будет взаимодействовать с ВТБ и Мосметро. 

В данном rfc рассматривается только взаимодействие Яндекса с внешними сервисами наших партнеров. Подробное описание реализации проекта на нашей стороне будет описано в другом rfc 



# Реализация

В проекте принимают участие 3 стороны со следующими ролями:
- **ВТБ** - основное связующее звено между сервисами Метро и Яндекса. Связывает пользователей Яндекса и Мосметро в единого maas-пользователя. Процессит оплату абонемента. Уведомляет обе стороны о всех изменениях.
- **МосМетро** - продает абонемент (предоставляет нам свое WebView для оплаты). В приложении Мосметро отображает маршрут такси до ближайшего метро и по диплинку открывает приложение YandexGo. Позволяет пользователю совершить поездку на метро по абонементу, используя заранее выбранную для этого банковскую карту. Передает/получает информацию о совершенных поездках на метро/такси.
- **Яндекс** - позволяет пользователю совершать поездки до ближайшего метро по абонементу (для этого используем промокоды). Предоставляет точку входя для покупки абонемента. Передает/получает информацию о совершенных поездках на такси/метро. При этом установка приложения мосметро для покупки и использования абонемента не требуется.


## Реализация API на нашей стороне

Cоздаем 2 новых сервиса: 
- `maas` - внутренний сервис, который будет отвечать за хранение данных о maas-пользователях. А также за логику выбора точек B при поездке до ближайшего метро (подробное описание будет отражено в другом RFC)
- `maas-external` - открытый наружу сервис для всех внешних ручек, в которые будет ходить ВТБ. Задача сервиса - авторизовать внешний запрос и проксировать его во внутренний сервис `maas`. 

Таким образом все ручки сервиса maas-external будут реализованы следующим образом:
1. получили запрос в ручку `/maas-external/v1/<handler>`  
2. авторизовали запрос по API key (проверка хэш(секрет+ключ) == хэш_из_конфига )
3. перенаправили запрос во внутренний сервис `maas` (в соответствующую ручку `/maas/v1/<handler>` )
4. при необходимости запросы/ответы могут адаптироваться пот внутренний/внешний API, но скорее всего мы будем просто проксировать запросы как есть. 

Все кейсы взаимодействия приведены на этой диаграмме:
![sequence diagram](https://jing.yandex-team.ru/files/andreykostin/maas_external.png)

По-хорошему мы ни на одном этапе не нуждаемся в посредничестве ВТБ, однако на сколько нам известно на данный момент все взаимодействие будет происходить через ВТБ. При этом реализация API с нашей стороны кажется совсем не зависит от того, с какой стороной в итоге мы будем взаимодействовать. 


## Выбор тарифа для абонемента

Перед покупкой пользователь должен выбрать 1 из доступных тарифов.
Тариф идентифицируется по `tariff_id` и имеет фиксированное количество поездок на Такси и безлимит на Метро, при этом в каждом тарифе абонемент имеет ограниченный срок действия.

Согласно договоренностям основным держателем информации о тарифах является ВТБ. Однако мы со своей стороны можем также проверять, что количество поездок на такси и срок действия соответствуют некоторым заранее оговоренным вариантам

### Выбор тарифа через YandexGo

На нашем бэке будет своя клиентская ручка, которая будет отдавать информацию о продаваемых абонементах. В этой ручке мы будем ходить (пока не знаем как именно) в ВТБ/Метро за доступными тарифами.

### Выбор тарифа через клиент Мосметро

Мосметро/ВТБ должны будут придти к нам в ручку чтобы получить список доступных для данного пользователя тарифов.На текущий момент мы договорились о 2х возможных вариантах (из которых возможно в конечном счете выберем только 1):
 - `/maas-external/v1/available-tariffs` - отдает информацию о доступном количестве абонементов для продажи по каждому тарифу (пока предполагается, что Метро/ВТБ будут дергать эту ручку раз в день)
 - `/maas-external/v1/available-tariffs/user` - отдает информацию о доступных тарифах для конкретного maas-пользователя  (если пользователь к этому моменту еще не существует, то его придется предварительно создать). Здесь мы сможем предварительно провести все те же проверки по этому пользователю, которые мы проводим в `/maas-external/v1/pass/reserve`
  
В обеих ручках ВТБ/Метро передает нам условия тарифов, которые мы будем проверять на соответствие нашим внутренним условиям тарифов для абонемента.


## Покупка абонемента

Абонемент реализуется на нашей стороне как надстройка над промокодами. 
Абонемент имеем фиксированное количество поездок и срок действия.
С точки зрения Яндекс.Такси абонемент может находиться в одном из следующих состояний:
- reserved - зарезервирован, но не активирован, не виден пользователю
- activated - активирован, доступен для использования
- expired - срок действия абонемента истек - терминальный статус
- canceled - аннулирован и не может быть использован (например в следствии неудавшейся оплаты) - терминальный статус

Не зависимо от того с чьей стороны будет инициирована покупка абонемента, будут выполнены следующие этапы:

1. Если покупка происходит в первый раз, то Метро/ВТБ создает maas-пользователя и присваивает ему maas_user_id. Регистрация пользователя происходит по телефону. После создания пользователя Метро/ВТБ передает данные на нашу сторону в ручку `/maas-external/v1/user/create`. Если пользователь уже существует, то никаких действий не требуется.
2. Перед оплатой абонемента, Метро/ВТБ должно зарезервировать его на нашей стороне - для этого они отправляют запрос в ручку `/maas-external/v1/pass/reserve`. Возможные причины отказа в резерве:
   - закончился бюджет для выдачи промокодов
   - только для пилота: у пользователя есть активный абонемент (в пилоте не будем уметь работать с несколькими абонементами одновременно)   
   - антифрод
   - условия тарифа не соответствуют ни одному из вариантов заданных на нашей стороне
   - разные маловероятные технические ошибки (например абонемент с этим id уже выдан другому пользователю) - но от них придется тщательно защититься, т.к. это будут запросы с внешней стороны
3. Если продажа абонемента разрешена, то Метро/ВТБ запускают оплату.
4. Если оплата завершена успешна, то Метро/ВТБ дергает `/maas-external/v1/pass/activate`. В результате чего абонемент активируется и становится доступен для использования пользователем.
5. Если оплата завершена неуспешно, то Метро/ВТБ дергает  
`/maas-external/v1/pass/cancel`, в результате чего абонемент будет аннулирован и больше никогда не сможет быть использован 

### Особенности покупки через YandexGo

При покупке через YandexGo мы будем использовать WebView оплаты Мосметро.
В это WebView мы будем передавать либо телефон пользователя (при первой покупке) либо maas_user_id (при последующих покупках). Кроме того, во всех случаях мы будем передавать токен авторизации пользователя. Токен будем создавать на нашем бэке и записывать хэш(токен+соль) в бд. На этапе резервирования абонемента Метро/ВТБ передаст этот токен в ручку `/maas-external/v1/pass/reserve` - там мы проверим, что переданный maas_user_id соответствует пользователю, которому был выдан этот токен.


## Просмотр информации о купленном абонементе
Будем показывать пользователю купленный абонемент, его срок действия и количество оставшихся поездок на метро.

### Просмотр информации о купленном абонементе в YandexGo

На нашем бэке будет своя клиентская ручка, которая будет отдавать информацию о купленных абонементах. В этой ручке мы будем ходить (пока не знаем как именно) в ВТБ/Метро за информацией о текущем статусе абонемента и добавлять к этой информации количество оставшихся поездок на Такси.

### Просмотр информации о купленном абонементе в клиенте Мосметро

Для того чтобы отобразить всю информацию об абонементе Метро/ВТБ должны будут сходить к нам в ручку `/maas-external/v1/pass/info`, которая отдаст статус абонемента на нашей стороне и количество оставшихся поездок.


## Переход в приложение YandexGo из приложения Мосметро 

Переход будет осуществляться через диплинк следующего формата:

`yandextaxi://nearest-metro?pass_id=1234&lat_a=55.1&lon_a=37.1&lat_b=55.2&lon_b=37.2`

где  все параметры являются необязательными и имеют следующее применение:  
- `pass_id` — идентификатор абонемента. Если не передан, то будет выбран последний использованный/приобретенный абонемент
- `lat_a`, `lon_a` — координаты точки А. Если не переданы, то по умолчанию будут использованы координаты текущего местоположения пользователя.
- `lat_b`, `lon_b` — координаты точки B. Итоговая точка B будет выбрана из списка доступных точек высадки для поездки от выбранной точки A, с учетом максимальной близости к указанной в качестве аргумента. Если координаты не переданы, то по умолчанию будет использовано место высадки у ближайшего к точке A метро.


Для того, чтобы маршрут такси до ближайшего метро в приложении  YandexGo имел минимальное расхождение с маршрутом, отображаемом в приложении Мосметро, предлагается организовать передачу списка возможных точек B для выбранной точки А. Для этого приложение Мосметро будет ходит в нашу ручку `/nearest-metro`.
Данная ручка будет принимать в качестве параметра точку A и отдавать список доступных точек B.
