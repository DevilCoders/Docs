### Название сервиса:
maas, maas-external

### Какую продуктовую проблему решает сервис?
* выдача пользователю абонемента на поездки на Такси до ближайшего метро (в рамках продажи абонемента Метро+Такси, которую осуществляет Мосметро+ВТБ);
* проверка/санкционирование применения абонемента в части Такси;
* отображение информации по купленным абонементам.


### Почему нельзя решить эту задачу без разработки нового сервиса существующими решениями?
Требуется отдельное место для реализации специфичной логики под проект.
Попытки распихать логику по существующим сервисам приведут к запутанности системы и костылям.

### Как именно сервис будет решать поставленные перед ним задачи?
Сервис будет:
* Хранить связь таксишного пользователя с пользователем ВТБ/Метро, а также информацию по абонементу в такси;
* Выдавать абонементы пользователю по запросу от ВТБ/Метро и создавать под это купон в сервисе coupons;
* Определять может ли совершить пользователь поездку по абонементу между заданными точками;
* Предоставлять (или проксировать, если нужно, от ВТБ/Метро) информацию для пользователя в клиенты.

### Разрабатывается один сервис или система?
Система

### Сколько и какие сервисы содержит система?
Система будет содержать 2 сервиса:
* maas - собственно со всей логикой (внутренний);
* maas-external - прокси-сервис для взаимодействия с бэкендом ВТБ/Метро (внешний).

### Сервис внутренний или внешний?
Внешний (выбрать даёт один вариант, остальное понятно из описания системы выше)

### С кем взаимодействует сервис?
* Бэк ВТБ/Метро (через прокси maas-external);
* Клиенты такси ios/android через PA;
* coupons - через него реализуется оплата поездок по абонементу;
* personal - для обмена номера телефона на personal_phone_id;
* user-api - для получения phone_id;
* zalogin - получаем связанные yandex-uid.

### Использование Passenger Authorizer?
да

### Использование Driver-authorizer?
нет

### Залогиненность?
(Залогиненность означает возможность запуска сервиса в доменах yandex.ru|yandex-team.ru, возможность залогинить пользователя, возможность проверить или выставить cookie)
нет
	
### Использование Blackbox?
нет

### Использование MDS?
нет

### Какие базы использует?
db_maas - postgres бд сервиса maas (будет заведена вместе с сервисом)

### Какие периодические процессы?
-

### Прикрепите схему того, где этот сервис находится в текущей инфраструктуре
![картинка](https://jing.yandex-team.ru/files/maxim-ivanov/maas-interactions.png)

### Планируется ли обработка перс данных?
В одном из кейсов будем получать номер телефона от ВТБ/Метро, преобразовывать в personal_phone_id и дальше работать только с id.
Также в одном из кейсов будем отдавать номер телефона в ВТБ/Метро.

### Какие данные и по какой схеме сервис будет хранить в базе?
Таблица users:
- maas_user_id string PK;
- personal_phone_id string;
- yandes_uid string;

Таблица passes:
- pass_id string PK; - идентификатор абонемента
- tariff_id string; - внешний id тарифа
- maas_user_id string;
- promocode_series_id string; - серия промокодов, подходящая под заданные условия
- expiration_datetime timestamptz; - срок действия
- status string (reserved, activated, expired, canceled);
- tariff_info объект; -условия тарифа (стоимость, кол. поездок, длительность в днях - как минимум в пилоте пригодиться, потом можно будет избавиться).

### Какой объем данных будет храниться и какой объем будет изменяться в единицу времени?
1. Если ориентироваться на пилот, то это 5к абонементов. Каждый абонемент это строка в users и строка в passes.
Каждый id это 33 байта, дата 8 байт, статус 10 байт, tariff_info примерно 16 байт => две строки = 7*33 + 8 + 10 + 16 = 265 байт
Округлим с запасом на всякие доработки до 1 Кб
50к строк ~ 50 Мб
Учитывая, что минимальный размер БД, вроде, 10Гб - мы помещаемся без проблем.
2. Учитывая небольшое количество абонементов и поездок в пилоте, меняться будет порядка несколько байт в секунду (точнее несколько сотен байт в минуту).

### Какие операции над данными заложены?
Вставка, обновление, чтение, удаление

### Есть ли какой-то стейт в памяти, как он обновляется и валидируется?
-

### Какая нагрузка ожидается?
В перспективе наибольшая нагрузка нам может прилететь от routestats и shortcuts
1. routestats: судя по графику, в пике на НГ выдавал около 2.3 RPS. Можно для надёжности округлить до 3к RPS. Если посмотреть на taxi_main долю поездок по Москве от всех поездок, то она составит где-то 20% (мы можем экспом обрезать трафик в routestats по зоне). Следовательно, от routestats надо быть готовыми к нагрузке 0.2 * 3к = 600 RPS;
2. shortcuts: в шорткатах есть данные о позиции, по которым мы опять же можем срезать нагрузку, ограничившись Москвой. Нагрузку на шорткаты можно округлённо взять 2.5к RPS, тогда учитывая всё ту же долю 20%, получается 0.2 * 2.5к = 500 RPS
По сравнению с этой нагрузкой, остальное сейчас не существенно. То есть ориентировочно нагрузка будет до 1100 RPS.

### Какие фолбеки предусмотрены на сам этот сервис?
-

### Какие фолбеки предусмотрены внутри этого сервиса на взаимодействие с другими сервисами?
При наличии уже оформленного абонемента, если сервис ВТБ поляжет, мы всё равно можем дать пользователю осуществить поездку на такси по абонементу.
Остальное критично для работы системы. Но учитывая, что это не основной функционал такси, дублировать его не суперкритично

### Какие возможности масштабируемости закладываются?
-

### Какие точки отказа есть в сервисе?
бэк ВТБ/Метро, база, сервисы от которых зависим

### Укажите ключевые продуктовые метрики сервиса, за которыми планируете следить
* активность пользователя c абонементом (поездок в месяц) в сравнении с обычной активностью
* утилизация / горение (сколько забираем себе неоткатанных поездок в абонементе)
* реальная средняя стоимость поездки / субсидии водителям


### Укажите технические метрики
Стандартные метрики (тайминги, bad_rps, cpu и тд)

### Какая функциональность ожидается в сервисе в будущем?
Возможно какое-то расширение функционала абонементов, пока не ясно

### Какое изменение нагрузки планируется?
Пропорционально % поездок по абонементу х2 и умножить на нагрузку на ordercommit. Если предположить, что все кто ездит до ближайшего метро на такси, подсядут на абонемент, и их количество не изменится, то нагрузка будет около 6 RPS. Что меркнет по сравнению с нагрузкой на routestats, при наличии которого нагрузка просто будет пропорциональна его нагрузке.

### Активно ли будет изменяться сервис?
Зависит от успешности пилота

### Менеджер
Максим Педошенко

### Релиз (дата)
Конец июня

### Язык, на котором пишется сервис
C++

### Ссылка на тикет, в рамках которого идет разработка
https://st.yandex-team.ru/TAXIPROJECTS-1932

### Дополнительные согласования
Все доп согласования прводятся в рабочем порядке на соовтетствующих встречах по проекту. Тикеты по согласованиям:
https://st.yandex-team.ru/LEGALTAXI-10449
https://st.yandex-team.ru/SECAUDIT-4321
https://st.yandex-team.ru/FRAUDREVIEW-125

### Комментарий
rfc: https://github.yandex-team.ru/taxi/rfc/tree/master/maas/v0
