### Вступление

На дизайн можно посмотреть [тут в фигме](https://www.figma.com/file/UVBegm3guW0nxtVamvQ3t6/Go-%D0%90%D0%B1%D0%BE%D0%BD%D0%B5%D0%BC%D0%B5%D0%BD%D1%82?node-id=346%3A0).

Здесь проработка API только по личному кабинету пользователя и флоу покупки подписки, поездка прорабатывается отдельно.

Для работы вебвью потребуется 6 ссылок:
* на флоу покупки (пришлём вместе с кнопкой меню);
* на флоу показа купленного/просроченного абонемента (пришлём опять же с кнопкой);
* на проверку статуса оплаты и завершение;
* на случай отмены оплаты пользователем в ВТБшной вьюхе;
* на проверку статуса смены ключа доступа и завершение этого процесса;
* на случаей отмены смены ключа пользователем.

Может быть ссыли на случай отмены лишние, но они позволят не дёргать лишний раз ручку статуса, что кажется полезным.

### Отображение кнопоки в меню

Отображении кнопки абонемента в меню определяется по эксперименту из zoneinfo + ответу ручки /4.0/maas/v1/subscription/info/short.

В zoneinfo присылаем свитч-эксперимент: maas_subscription_enabled. Если пришёл, то дёргаем ручку и смотрим пришла ли в ответе menu_button, если пришла, то отрисовываем кнопку по параметрам из api + для перехода в вебвью при нажатии используем пришедшую ссылку. Также оттуда берём купон абонемента, если он пришёл (если пришёл купон - значит есть абонемент).

Ручку /4.0/maas/v1/subscription/info/short надо запрашивать чаще, чем zoneinfo, так как zoneinfo кэшируется, а состояние пользователя может обновляться чаще. К примеру, запрашивать при каждом обновлении сессии.

### Покупка абонемента

Тут изображено моё видение схемы работы
![флоу покупки](https://jing.yandex-team.ru/files/maxim-ivanov/MaaS_buy_subscription.jpg)

Процесс оплаты описан на вот этой картинке:
![флоу оплаты подписки](https://jing.yandex-team.ru/files/maxim-ivanov/MaaS_pay_subscription_2.jpg)

Соответственно в случае, если выбирается токен какого-то pay-я, то оплата запускается без всяких ВТБ-шных окон, и можем смело сразу начинать поллинг ручки /4.0/maas/v1/subscription/pay/status в ожидании статуса. Иначе сначала поллитася ручка /4.0/maas/v1/subscription/pay/status в ожидании ссылки на webview.

На андройде важно проверить наличие NFC на устройстве и предупредить (или может не дать пользователю выбрать) про googlepay, что при оплате этот метод привяжется в качестве ключа доступа, а из-за отсутствия NFC в метро всё равно пройти не удастся.

Также тут надо будет реализовать реакцию на три диплинка, по которым пользователь возвращается из ВТБ:
* успешная оплата - в этом случае мы немного защищаемся от фрода и поллим ручку статуса оплаты, чтоб убедиться, что абонемент действительно куплен, прежде чем покажем что-то ещё;
* проблемы с оплатой/отмена оплаты пользователем - тут можно ничего не проверять, просто идём по соответствующей ветке.

Все необходимые данные для отображения в окнах я постарался разместить в API.

### Отображение купленного/просроченного абонемента

Если есть купленный абонемент, то его можно посмотреть из главного меню.

Собственно, картинка поясняющая, как происходит отображение абонемента:
![схема показа купленного абонемента](https://jing.yandex-team.ru/files/maxim-ivanov/MaaS_show_subscription_2.jpg)

Все нужные данные придут из ручки /4.0/maas/v1/subscription/info/full. Если получили 404, значит какой-то рассинхрон и абонемента на самом деле нет, перекидываем на флоу покупки не выходя из вебвью.

Флаг hide_extend_button сигнализирует, что надо скрывать кнопку Продлить. Нужно как минимум в пилоте, так как если есть действующий абонемент в пилоте, то мы не даём завести новый. Со временем можно будет от флага просто отказаться, если решим показывать кнопку всегда. По кнопке Продлить кидаем в начало флоу покупки абонемента.

Флоу привязки нового метода оплаты (похоже на оплату, но не совсем и ручки другие):
![схема показа купленного абонемента](https://jing.yandex-team.ru/files/maxim-ivanov/MaaS_change_user_access_key_2.jpg)

### Недобитые вопросы

- Что нужно фронтам для перехода в поддержку ВТБ из окна ошибки? url-а достаточно? И что вообще нам дадут ВТБ?
- Что делаем в случае, если есть googlepay, но нет NFC?
