# Флоу поездки 

Точкой входа будет являться шорткат с переходом по диплинку на `ловушку вертикали` для абонемента. Переход будет возможен для двух сценариев: поездка от метро / к метро.

Вертикаль абонемента должна быть скрыта в обычном режиме саммари, т.к. на текущий момент саммари+роутстатс умеют работать только с 1 промокодом, а значит этот режим мы должны оставить для использования обычных промокодов.

Промокод абонемента клиенты будут получать через ручку `/4.0/maas/v1/subscription/info/short` и в диплинке из шортката. При этом среди обычных промокодов, полученных от сервиса `coupons` через существующую ручку, не будет промокода на абонемент. 

Если у пользователя есть абонемент, то в ручке  `/products` будет отдавать один из вариантов шортката с диплинком ведущего в ловушку (для поездок от/к метро). Если абонемента нет и пользователь попал в эксперимент, то будем отдавать шорткат для покупки абонемента.

Для абонемента будет доступен только карточный способ оплаты. Если будет выбрана наличка, то routestats вернет ошибку. Чтобы автоматически переключать выбор пользователя на выбранную ранее карту предлагается сохранять его в `/personalstate` 

## /zoneinfo

### Параметры ответа
В ответе `/zoneinfo` будем отдавать вертикаль для абонемента. В ней добавим поле `trap_only=true`:

```json
{
    "verticals":[
        {
            "type": "group",  
            "trap_only": true,  // по умолчанию вертикаль должна быть скрыта в UI 
                                // т.е. до тех пор пока не перейдем на нее в режиме ловушки          
        
            ...
        }
    ]
}
```

## /personalstate

В запросе и ответе в `selected_options_in_verticals` добавляем новое поле `payment_method`:
```json
{
    "selected_options_in_verticals" : {
        "maas_vertical" : {
            "payment_method": "googlpay"
        },
        ...
    }
}    
```

## GET /4.0/maas/v1/nearest-metro

### Параметры запроса

В запросе передаем координаты пина как параметры lat, lon  в query

### Параметры ответа


```json
{
    "stations": [ // ближайшие станции метро, отсортированные в порядке близости
        {            
            "exits": [ // выходы из метро
                { 
                    "point" : { "lat": 1.1, "lon": 2.2 }, // координаты входа
                    "dropoff_point_id" : "p_1", // id оптимальной точки высадки              
                    "title" : "Выход 1", //  название выхода                    
                },
                ...
            ],
            "time": "~5 мин", // время до ближайшего выхода
            "title": "Площадь революции", // название станции
            "line_id": "line_1",  // id ветки            
        },
        ...
    ],
    "dropoff_points": [ // точки высадки
        {
            "id": "p_1",
            "point" : {
                "lat": "1.1",
                "lon": "2.2",
            },
            "time": "~7 мин",
        },
        ...
    ],
    "lines": [ // линии метро
        {
            "id": "line_1",
            "image_tag": "metro_M", // цветная буква М   
            "name": "МЦК",
            "number": "4А" 
        },
        ...
    ],
    "title": "До какой станции едем?", // это можно передавать в эксперименте в zoneinfo, но можно и здесь.
    "button_text": "Подтвердить" // это можно передавать в эксперименте в zoneinfo, но можно и здесь
}
```


## /products

Вернет шорткат с диплинком на поездку от метро или к метро или для покупки абонемента

Пимерный формат диплинка: `yandextaxi://maas-ride?mode=ride_to_metro&vertical_id=maas&coupon=maas_coupon`

параметры:
- mode = ride_to_metro|ride_from_metro|account - сценарий поездки (к метро/от метро/покупка)
- vertical_id - id вертикали для ловушки
- coupon - промокод абонемента


## /routestats


### Параметры запроса
В запросе в state добавляем признак режима ловушки для абонемента:
```json
{
    "state": {
        "fields":[
            {
                "type": "maas" // признак того, что в запросе используется промокод абонемента 
            }
        ]
    }
}
```
И стандартным способом передаем купон на абонемент. 

> К сожалению получить промокод на бэке для нас будет очень невыгодным - нам придется это делать до похода в прайсинг, а значит мы рискуем увеличить тайминги routestats, чего мы не можем себе позволить. Поэтому намного дешевле будет получать промокод от клиентов.

### Параметры ответа
В случае, если поездка по купону невозможна, прокидываем:

```json
{
    "service_levels":[
        {
            "tariff_unavailable": {
                "code": "maas_route_unavailable",
                "message": "Поездка по абонементу невозможна",
                "reason_description": "Выбранные точки маршрута находятся слишком далеко от метро" // Новое опциональное поле
            }
        },
        ...
    ],
    ...
}
```

Поле code может быть 3х типов:
- maas_subscription_unavailable - редкие кейс когда абонемент недействителен/просрочен/закончились поездки и т.п. **TBD:** если пришел этот флаг, то  нужно кинуть пользователя на страницу покупки абонемента 
- maas_route_unavailable - маршрут не подходит для использования абонемента. Предлагаем пользователю переставить точки A/B
- maas_payment_method_unavailable - выбран не карточный способ оплаты

## /ordercommit
    
В идеальном мире:
В случае некорректного маршрута или невалидного купона вернет ошибку 406

В неидеальном мире: будет создан заказ без купона. Поэтому здесь было бы хорошо, если клиенты всегда ждали бы ответа routestats (но это тоже дорого).

## /totw

**TBD:** в идеальном мире мы должны сообщить пользователю о том, что купон не будет применен и в следствии каких причин. Пока не прорабатывался этот вопрос. Имеет минимальный приоритет


