### Заметки для этапа in_progress

!!! API немного поменялось, а картинки я пока не успел подправить. Более актуальный вид стоит смотреть пока по [дизайну в фигме](https://www.figma.com/file/UVBegm3guW0nxtVamvQ3t6/Go-%D0%90%D0%B1%D0%BE%D0%BD%D0%B5%D0%BC%D0%B5%D0%BD%D1%82?node-id=346%3A0).
Схемы подправлю позже.

Важная деталь, наличие на телефоне googlepay (да и с applepay подозреваю также) не означает наличие NFC. Надо как-то разруливать эту ситуацию, а то пользователь оплатит токеном подписку, а в метро пройти не сможет.

### Вступление

Отображение на клиентах можно разбить на три этапа:
* Покупка абонемента;
* Отображение уже купленного абонемента;
* Поездка на такси по абонементу. (возможно, это не успею до первой встречи)

Каждый этап опишу отдельно (схемы API лежат в соседнем файле).

### Отображение кнопоки в меню

Отображении кнопки абонемента в меню предлагаю определять по launch + zoneinfo.
В launch кладём, в корень, поле с объектом:

```
"maas": {
    // Обязательные поля
    "has_subscription": true,
    "buy_button_title": "Купить абонемент",
    "info_button_title": "Абонемент на такси",
    // Необязательные поля
    "remaining_trips_count": "13",
    "expiring_info": "до 3 сентября"
}
```

А в zoneinfo присылаем свитч-эксперимент: maas_subscription_enabled.
Кнопку показываем, если:
- пришло maas.has_subscription=true;
- пришёл эксперимент maas_subscription_enabled в zoneinfo.

Соответственно текст для кнопки будет из buy_button_title, если нет абонемента и has_subscription=false, иначе из info_button_title, а при нажатии в любом случае произойдёт проверка есть/нет абонемента, и даже если какой-то рассинхрон возникнет, мы его поправим вовремя.

Также на кнопке "Абонемент", когда у пользователя есть действующий абонемент, будут отбражаться время действия и оставшееся количество поездок. Для этого, когда has_subscription=true, будут приходить с бэка remaining_trips_count и expiring_info. По дефолту, если данные не пришли - они просто не отображаются.

### Покупка абонемента

Тут изображено моё видение схемы работы
![флоу покупки](https://jing.yandex-team.ru/files/maxim-ivanov/clients-interact-payment-2.png)

При попытках из любого места начать покупку, клиенты должны сделать запрос на бэк в ручку /4.0/maas/v1/subscription/info. В случае каких-то рассинхронов это позволит понять, не идёт ли уже оплата или нет ли уже купленного абонемента. Если ничего из этого нет, то просто уходим во флоу покупки.

Процесс оплаты описан на вот этой картинке:
![флоу оплаты подписки](https://jing.yandex-team.ru/files/maxim-ivanov/subscription-pay-process-2.png)

Соответственно в случае, если выбирается токен какого-то pay-я, то оплата запускается, без всяких ВТБ-шных окон и можем смело сразу начинать поллинг ручки /4.0/maas/v1/subscription/pay/status. В остальных случаях вызывается вьюха ВТБ по ссылке с бэка, вохможность выбора сохранённых карт будет также внутри этого webview на стороне ВТБ.

Также тут надо будет реализовать реакцию на три диплинка, по которым пользователь возвращается из ВТБ:
* успешная оплата - в этом случае мы немного защищаемся от фрода и поллим ручку статуса оплаты, чтоб убедиться, что абонемент действительно куплен, прежде чем покажем что-то ещё;
* проблемы с оплатой/отмена оплаты пользователем - тут можно ничего не проверять, просто идём по соответствующей ветке.

Все необходимые данные для отображения в окнах я постарался разместить в API.

### Отображение уже купленного абонемента

Если есть купленный абонемент, то его можно посмотреть из главного меню.

Собственно, картинка поясняющая, как происходит отображение абонемента:
![схема показа купленного абонемента](https://jing.yandex-team.ru/files/maxim-ivanov/show-subscription-to-user.png)

Все нужные данные (или ошибка, если вдруг с абонементом что-то не так), придут из ручки /4.0/maas/v1/subscription/info.

Флаг hide_extend_button, который сигнализирует, что надо скрывать кнопку Продлить. Нужно как минимум в пилоте, так как если есть действующий абонемент в пилоте, то мы не даём завести новый. Со временем можно будет от флага просто отказаться, если решим показывать кнопку всегда.

Флоу привязки нового метода оплаты, как ключа доступа, пока не до конца понятно, поэтому там присутствуют пунктирные линии. Но, вероятно, оно будет чем-то похоже на флоу оплаты.

### Поездка на такси по абонементу

TO_DO: Пока плохо понимаю, как должно работать. Проработаю и допишу/дорисую

### Вопросы, которые могут повлиять на api и флоу в целом

Вопросы к ВТБ/Метро:
* Нельзя ли поменять логику ручек /subscription/pay/start + /subscription/pay/status, чтоб ссылка приходила в первой ручке, а резервирование абонемента шло после старта оплаты через webview? (это несколько упростит часть кейсов)
* Уточнить, если привязываем, как ключ доступа, какой-то pay, то попыток списать тестовый рубль не будет и он сразу привяжется?
* Уточнить, как мы будем отслеживать привязку новой карты? (пока тут белое пятно)
* Что делаем при неполной активации? ( в каком-то сервисе что-то сломалось и надо как-то предупредить об этом)

Вопросы к дизайну/менеджеру/на подумать:
* Что будет в тех местах, где ещё нет дизайна или он не доделан?
* Подробное описание будет своё для каждого тарифа?
