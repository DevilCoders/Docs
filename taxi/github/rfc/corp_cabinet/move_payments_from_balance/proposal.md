# Что
Переносим взаимодействие с оплатой из интерфейса баланса в корп-кабинет

# Зачем
Чтобы не редиректить пользователей в сторонние сервисы, где их повторно просят авторизоваться

# Текущий флоу

При формировании нового счёта бэкенд создаёт "черновик" счёта, после чего перенаправляет пользователя в Паспорт, который после прохождения авторизации перенаправляет пользователя в Баланс. Подтверждение черновика и оплата происходят через интерфейс Баланса.

Для создания "черновика" счёта используется [xmlrpc-API Баланса](https://wiki.yandex-team.ru/balance/xmlrpc):
1. Получаем созданные договоры из Баланса через метод [`Balance2.GetOrdersInfo`](https://wiki.yandex-team.ru/balance/xmlrpc/#balance.getordersinfo), достаём из них `ServiceID` и `ServiceOrderID`
2. Создаём "черновик" счёта в балансе, вызывая метод [`Balance2.CreateRequest`](https://wiki.yandex-team.ru/balance/xmlrpc/#balance.createrequest), в ответ получаем url на который редиректим пользователя

![image](https://jing.yandex-team.ru/files/toporkovm/current%20flow.png)

# Новый флоу
Переносим в корп-кабинет большую часть логики, связанной формированием и оплатой счёта. Для реализации используем API Баланса.

Флоу пользователя:
1. При нажатии на кнопку "сформировать счёт", проверяем принята ли оферта. Если оферта не принята, то доступна только оплата банковым переводом, а минимальная сумма пополнения - 1000р. Отображаем окно ввода суммы и промокода.
2. После того как пользователь ввёл промокод, редиректим пользователя на страницу в корп-кабинете для оплаты черновика
3. Отображаем доступные способы оплаты, предлагаем пользователю выбрать один их них (банковым переводом или произвольной картой)

Если пользователь выбрал оплату банковым переводом, то "досоздаём" счёт из "черновика", а пользователю возвращаем pdf-ку с квитанцией на оплату

Если пользователь выбрал оплату картой, то редиректим пользователя на страничку Траста, где он вводит данные карты и оплачивает заказ, после чего возвращаем его в корп-кабинет

![image](https://jing.yandex-team.ru/files/toporkovm/new_flow.png)


Используемые методы xmlrpc-API:
* [`Balance2.GetOrdersInfo`](https://wiki.yandex-team.ru/balance/xmlrpc/#balance.getordersinfo) - получение информации о договорах(?), используем чтобы получить нужную инфу для создания "черновика". В доках помечен как `deprecated`, но нам для наших целей разрешили продолжить использовать. Использовать начали когда [делали промокоды](https://st.yandex-team.ru/TAXIBACKEND-19650)
* [`Balance2.CreateRequest2`](https://wiki.yandex-team.ru/balance/xmlrpc/#balance.createrequest2) - используем для создания "черновика" счёта. Используем вторую версию, так как она возвращает request_id отдельным полем
* [`Balance2.GetRequestChoices`](https://wiki.yandex-team.ru/balance/xmlrpc/#balance.getrequestchoices) - получение "балансовых" способов оплаты. Используем чтобы получить способ оплаты "банковым переводом"
* [`Balance2.CreateInvoice`](https://wiki.yandex-team.ru/balance/xmlrpc/#balance.createinvoice) - создание счёта. Используем для создания счёта при оплате банковым переводом
* [`Balance2.GetRequestPaymentMethods`](https://wiki.yandex-team.ru/balance/xmlrpc/#balance.createinvoice) - ручка прокси-апи Баланса к Трасту. Возвращает "трастовые" способы оплаты. Используем чтобы получить способ оплаты "произвольной картой".
* [`Balance2.PayRequest`](https://wiki.yandex-team.ru/balance/xmlrpc/#balance.payrequest) - ручка прокси-апи Баланса к Трасту для инициализации процесса оплаты реквеста. Используем для оплаты произвольной картой


Почему `Balance2`:
>  Ручка Balance2. использует готовую библиотеку для серелизации в XMLRPC и работает строго по станадрату. Рекомендуется использовать именно ручку Balance2

Для использования методов `GetRequestPaymentMethods` и `PayRequest` нужно [настроить сервис в Трасте и в Балансе](https://wiki.yandex-team.ru/balance/xmlrpc/#prerekvizity).

Также используем ручку [`/documents/invoices/{invoice_id}`](https://wiki.yandex-team.ru/billing/mdsproxy/dev/back/testing/description/#url1) для получение pdf-квитанции при оплате банковым переводом. Для использования ручки нужны отдельные TVM-правила, которые уже заказаны [тут](https://st.yandex-team.ru/BALANCEDUTY-516).

# Необходимые доработки
На бэкенде:
* Добавить в клиент баланса работу с новыми методами xmlrpc-api
* Сделать ручки для нового пользовательского флоу (примерная схема имплементации - в [api.yaml](api.yaml))

На клиенте (корп-кабинет):
* Доработать интерфейс, поддержав новый пользовательский флоу работы со счетами

В Трасте:
* Настроить сервис, подключить терминалы

В Балансе:
* Настроить оплату через Траст

# Возможное развитие в дальнейшем
Для "оплаты банковым переводом" можно перенести из Баланса дополнительные возможности к выгрузке счёта:
* Загрузить в формате Word
* Отправить по электронной почте

Кажется наиболее правильным будет доработка/создание метода в Балансе для переиспользования их функционала


Для "оплаты картой" можно полностью реализовать флоу оплаты внутри корп-кабинета - с добавлением новой карты и оплатой, без редиректа на Траст для этого. Делается при помощи [остальных методов прокси-апи баланса к Трасту](https://wiki.yandex-team.ru/balance/xmlrpc/#bystrajaoplatacherezproksi-apibalanceaktrastu), более трудоёмко