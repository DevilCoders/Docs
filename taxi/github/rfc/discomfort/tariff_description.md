## Прелюдия

Уже есть [wiki](https://wiki.yandex-team.ru/taximobiledev/tariffdiscomfort/), а также схема в [miro](https://miro.com/app/board/uXjVO5q8xy8=/).

Путь `overrides` кажется самым безобидным:
* Он хоть сам по себе и выглядит неуклюже, но по сравнению с альтофферами несёт меньше боли клиентской разработке (см. miro)
* Он не несёт рисков рассинхрона между 2мя тарифами: рассчёт данного тарифа будет происходить также, как для эконома. Поддежка одного тарифа, а не 2х в перспективе - колоссальная экономия времени всевозможных команд.

## Клиентские ручки, которых коснутся изменения

Для его реализации нужно:
* В `/zoneinfo` в `max_tariffs` для эконома добавить поле `order_flow: discomfort`. Это маркер доступности тарифа "Дискомфорт".
* Доработать `routestats`. Об этом подробнее в соответствующем разделе.
* Доработать `zonaltariffdescription`.

## Изменения в АПИ routestats

Ответ `routestats` для эконома расширяется следующей структурой (подобный механизм уже реализован для драйва, доставки и шаттла):
```json
  ...
  "econom_extra": { // optional
    "discomfort": { // optional
      "service_level_override": { // required
        "class": "discomfort",
        "name": "Эконом",
        "description_parts": {
          "prefix": "",
          "suffix": "",
          "value": "1932 $SIGN$$CURRENCY$"
        },
        "estimated_waiting": {
          "seconds": 480,
          "message": "~8 мин пешком"
        }
      }
    }
  },
  ...
```
Если структура `econom_extra`/`discomfort` не пришла, то работаем как с обычным экономом. Опциональность добавил с прицелом на будущее - возможно, захотим добавить ещё какой-нибудь псевдотариф. Добавлять массив псевдотарифов на данном этапе кажется оверинжинирингом.

Если пришла секция `discomfort`, её нужно интерпретировать так: создаём ещё один тариф, который копирует все настройки эконома, но некоторые (определённые в `service_level_override`) перезатирает. Этот тариф в селекторе тарифов располагается слева от эконома.

## Доработки на беке

Поскольку хотим катить не на всю аудиторию такси, а только там, где часто наблюдается сурж, то тариф должен быть доступен не всегда. Пока что можно сделать костыль в виде отдельного эксперимента, но вообще конфиг [TARIFF_CATEGORIES_ORDER_FLOW](https://tariff-editor.taxi.yandex-team.ru/dev/configs/edit/TARIFF_CATEGORIES_ORDER_FLOW?name=TARIFF_CATEGORIES_ORDER_FLOW) стоит перевести на конфиг 3.0 со `extension_method=extend` - 1.5d (перевести требуется и протокол для консистентности).

Доработка сервиса `routestats` - 4d (перевод на конфиг3.0 - 0.5-1d, создание нового плагина - 2.5-3d).

Доработка `zonaltariffdescription` - 1d

Доработка ??? - 3+d - пока ещё непонятно, какие сервисы заденет, как менять АПИ. Но, скорее всего, тут будут костыли:(
* `/3.0/orderdraft` - автоматически прорастёт новый тариф в `order_proc`

## Перспектива

В перспективе хочется структурировать эти `_extra`s в админке, и, как следствие унифицировать работу с ними.
