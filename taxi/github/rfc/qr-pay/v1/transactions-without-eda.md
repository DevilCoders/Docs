# Новый воркфлоу оплаты ресторанных заказов

## Контекст

Актуальное описание сервиса: [тык](https://wiki.yandex-team.ru/users/a-lyamin/servis-yandex.pay/)

### Проблемы связанные с Едой
В первой версии MVP мы планировали создавать заказ в Еде, что облегчало нам задачу, 
т.к. мы могли не думать о реализации всех стандартных воркфлоу по заказу, 
но также и создавало некоторые проблемы (для того чтобы создать заказ в Еде нужен пользователь, 
которого мы не можем менять после создания, из-за чего нам пришлось продумать костыльное решение 
для оплаты заказ несколькими пользователями).

На текущем этапе развития Еды мы больше не имеем возможность создавать наши заказ в сервисах Еды. 
Что приводит нас к необходимости реализовать без участия еды следующие воркфлоу:
- оплата заказа
- саппорт заказа (раздел админки для отображения информации по заказу)
- рефанд заказа
- история заказа и выдача пользователю чека

Данный rfc затрагивает только доработки в части **оплаты заказа**.

### Проблемы связанные с подтверждением заказа рестораном
Текущий флоу предполагает ожидание подтверждения от ресторана того, 
что мы можем списать деньги с пользователя (после успешного холда). 
Клир инициируется сразу после этого подтверждения.
При этом пользователя мы также держим до тех пор, 
пока не получим это подтверждение со стороны ресторана.

Такой подход позволяет нам избежать неоднозначностей в ситуациях 
при одновременной оплате через ресторан и суперапп. 
Однако может надолго подвесить UI из-за необходимости ждать ответа со стороны ресторана.

Кроме того, на данный момент у нас нет отмены холда в том случае, 
когда ресторан закрывает заказ на своей стороне.
(деньги конечно в любом случае вернутся пользователю, 
но будут оставаться замороженными весьма длительное время)



## Оплата заказа без Еды

Ниже приведены отличия от предыдущей реализации.

### Доработки сервиса `payments-eda`
1. Ручка `/4.0/payments/v1/orders`:
   1. Получив заказ от `iiko-integration` не идем в Еду и не создаем там заказ 
    (и не генерим никаких `eda_order_id` для этого заказа)
   2. Не ходим в Еду чтобы получить позиции для создания `invoice` в сервисе `transaction`
   3. Обновляя статус заказа в `iiko-integration` передаем `invoice_id` вместо `eda_order_id` 
   (но по сути ничего не меняется).
   Для этого используем ручку `/v1/order/authorized-update`. Это точка как и раньше 
   является точкой синхронизации для двух пользователей, которые одновременно инициируют оплату
   (в сервисе `iiko-integration`, перевод заказа в `HOLDING` осущетсвляется одной транзакцией,
   а при переводе закза из `HOLDING` в `HOLDING` мы проверяем, 
   что yandex_uuid пользователя совпадает с uuid записанном в заказе). 
   Т.е. два пользователя не смогут инициировать параллельную оплату одного и того же заказа
   4. Генерим уникальный `invoice_id` для пары {пользователь, заказ} и создаем 
   по нему `invoice` в `transactions`. Состав `invoice` формируем непосредственно
   из позиций заказа полученного от `iiko-integration`
   5. В случае, если мы неуспешно сходили в `transactions`, переводим заказ в `iiko-integration` 
   в `HOLD_FAILED` и возвращаем ошибку. (это позволит разблокировать следующую попытку оплаты 
   для другого пользователя)
   

2. Stq-таска в очереде `payments_eda_callback`. Получив колбэк на `invoice` для `service=restaurants`:
   1. Для статусов `HOLDING`, `HELD`, `HOLD_FAILED`, `CLEARING`, `HOLD_FAILED`, `CLEAR_FAILED`, `REFUNDING` 
   не отправляем нотификацию о статусе в Еду. Отправляем только в `iiko-integration`.
   2. Для статуса `CLEARED`:
      1. Идем в `iiko-integration` за информацией по заказу, достаем из нее `restauran_id` 
      2. Идем в новую ручку Еды, чтобы сообщить о сумме долга ресторану
      3. Также обновляем статус заказа в `iiko-integration`


### Доработки сервиса `iiko-integration`
1. Заменяем везде поле `eda_order_id` на `invoice_id` (логика не меняется)
2. В ручке `/v1/order/authorized-update` в тело запроса добавляем `invoice_id`
(почему-то при последних правках что-то пошло не так, и `eda_order_id` оказался в ручке 
`/v1/order/update`, где он не нужен, но мы не заметили этого т.к. не успели использовать)



### Доработки сервиса `superapp-misc`
Доработка никак не связана с Едой. Просто необходимо поддержать ресторанные заказы 
в ручке `/v1/available-payment-types` (расширяем API для `service=restaurants`)



## Оплата заказа без ожидания подтверждения со стороны ресторана

Мы можем не заставлять пользователя ждать подтверждения со стороны ресторана,
а сообщать об успешности оплаты сразу после успешного холда. 
В случае же, при котором ресторан не подтверждает оплату на нашей стороне, 
а напротив сообщает об успешном закрытии заказа с его стороны - 
мы можем слать пользователю пуш об отмене оплаты заказа
и сразу же разблокировать его деньги на счете.


### Доработка сервиса `iiko-integration`
1. В том случае, когда осуществляется переход заказа в статуса `HELD_AND_WAITING_FOR_CONFIRMATION` 
необходимо слать нотификацию об успешной оплате. А в статусе `HELD_AND_CONFIRMED` теперь ничего не шлем.
2. В том случае, когда осуществляется переход заказа из статуса
`HELD_AND_WAITING_FOR_CONFIRMATION` в статусы `CANCELED_BY_RESTAURANT|CLOSED_BY_RESTAURANT`:
   1. Необходимо отменять холд - для этого можно воспользоваться уже существующей 
   в `payments-eda` ручкой `/v1/orders/cancel`
   2. После успешной отмены холда необходимо слать нотификацию пользователю 
   (аля "заказ был отменен/оплачен в ресторане, не переживай, ща все вернем")
3. **Не обязательное улучшение на будущее**: в случае перехода в статус `HELD_AND_CONFIRMED` 
инициировать не мгновенный клир, а отложенный на N часов. (это позволит нам быстрее и более гибко 
делать рефанд заказа до клира). Для этого ставим таску с соответствующим ETA в очереди `payments_eda_close_order` 


### Доработки сервиса `payments-eda`
1. В ручке  `/4.0/payments/v1/orders/retrieve` сообщаем клиентам об успехе 
не по статусу `HELD_AND_CONFIRMED` а по `HELD_AND_WAITING_FOR_CONFIRMATION`.
2. **Не обязательное улучшение на будущее**: в stq-таске `payments_eda_close_order` необходимо 
до начала клира пытаться перевести заказ в iiko-integration в статус `CLEARING` - это будет точка синхронизации 
с операцией "рефанда до клира" в будущем. Если обновить статус не удалось - ничего не делаем.


### Риски
Доставка пушей пользователю может сильно запаздывать
(как вариант у пользователя может просто пропасть связь в неподходящий момент) - 
в этом случае он может оказаться в ситуации когда и приложение и ресторан говорят 
ему о том, что взяли с него деньги. Текущий воркфлоу исключает такой ситуации.
Возможно мы можем сгладить этот негативный эффект, если объясним ресторанам,
что в этом случае посетителю нужно говорить что-то типа "не переживай, Яндекс вернет деньги"
