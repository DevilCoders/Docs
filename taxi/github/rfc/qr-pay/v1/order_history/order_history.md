# Решаемая задача

Надо сделать так, чтоб оплаченные QR заказы были видны в истории заказов в приложении (заказы туда подгружаются через orderhistory в py3).

При этом:
* хорошо бы показывать в истории ещё и чек;
* понять на будущее, как можно отображать заказы с рефандом;
* иметь возможность отключить по конфигу.

# Вводная

Информацию по заказам приложение получает через сервис orderhistory в py3. orderhistory собирает информацию по заказам пользователя с разных сервисов, смёрживает их в один список и отдаёт приложению. Это фактически прокси-сервис, он прокидывает информацию по заказам как есть, просто сливая их из разных источников в один.

Также стоит отметить, что orderhistory сейчас имеет две версии АПИ: старую, которая сейчас работает, и новую. Мы сразу начнём впиливаться в новую, потому что к нашему запуску она уже должна быть запущена и заменит старую.

Раньше наша оплата была завязана на Еду, поэтому заказы для истории также просто брались из Еды. В связи с последними изменениями оплату мы реализуем теперь самостоятельно через transactions. Поэтому и заказы для истории теперь из Еды брать не получится.

# Что делаем?

Следовательно, кажется логичным сделать следующее:
1. Ручки в iiko для отдачи информации по заказам;
2. Допилить немного ручки в orderhistory, которые агрегируют заказы.

## Ручки в iiko-integration

Вид ручек зависит от того какую информацию ждёт клиент и от АПИ orderhistory.

Информация, ожидаемая на клиенте, описана немного ниже.

Новое АПИ из двух: /4.0/orderhistory/v2/list отдаёт список заказов с базовой информацией, а /4.0/orderhistory/v2/item отдаёт детальную информацию по конкретному заказу.

Делаем две ручки в сервисе iiko:
1. Для отдачи списка заказов. Которая отдаёт базовую информацию по заказам;
2. Для отдачи детальной информации по одному заказу. Будет отдавать детальную информацию по заказу для истории.

Заказы пользователя будем на данном этапе получать прямо из базы iiko, так как база на старте не будет очищаться. При этом, когда будет делаться очистка базы, надо будет дописать получение заказов ещё и из того места, куда будут сливаться старые заказы.

В истории будем отображать заказы в статусах: HELD_AND_CONFIRMED, CLEARING, CLEARED. Так как с точки зрения пользователя заказ в этих статусах является оплаченым.

**Ручки лежат рядом с RFC в api.yaml**

### Информация, которую покажем в истории на клиенте

На превью
- Пиктограммка QR-оплаты (предполагается стандартная картинка, определяется по типу сервиса);
- Название ресторана;
- Полную стоимость заказа после всех рефандов;
- Сколько получено кэшбека (может и нет, но на всякий заложим в ответ);
- Дата/Время оплаты;

В карточке заказа:
- Название ресторана;
- Фактический адрес ресторана;
- Телефон ресторана;
- Полная стоимость заказа;
- Сколько начислено кэшбека за заказ;
- Позиции заказа с количеством и стоимостью за единицу (позиции тоже будут из итогового заказа, после всех - рефандов);
- Дата/Время оплаты;
- Чеки по типам (оплаты/рефанды).

### Касательно чеков

Выяснилось, что единственное место из которого можно брать ссылку на чек это transactions. Но они пока не умеют отдавать чеки и будут делать доработку по этому поводу https://st.yandex-team.ru/TAXIBILLING-3422 .
Также стоит отметить, что чеков может быть несколько. Траст чеки отдельно выставляет за оплату корзин, рефанды.

После доработки в transactions будем в процессе оплаты получать чеки из ответа v2/invoice/retrieve и складывать их в базу к заказу. По ответу, по идее, можно будет определить за что чек: за оплату или за рефанд. Первый чек должен появляться после холда. В базу буду складывать массив объектов receipt, у каждого из которых будет url и тип (оплата, рефанд).

Возможно, когда договоримся с фронтом, а ручку transactions допилят, этот пункт изменится.

### Заказы с рефандом

В заказе с рефандом буду размещать чек на рефанд (в секции с чеками), а также у него будет итоговая стоимость изменена на стоимость после рефанда.

## Доработка orderhistory

В orderhistory дописываем отдельный модуль для взаимодействия с ручками iiko (мне кажется, существующие модули там и так здоровенные, строк по 400), запрашиваем заказы у iiko по user_id. С помощью модуля уже получаем заказы в основном коде orderhistory.

Также сюда же впиливаем конфиг, отключающий получение истории по QR. Так как аналогичные конфиги там же имеются для Еды и Такси.

# Про время

Затраты на разработку:

?. Синк с фронтом по формату (1d) (оценка с потолка и скорее чистого времени, без учёта на подождать ответ)
0. Доделать базу iiko и поставки в неё чеков (2d);
1. Разработать ручку для отдачи списка заказов для истории (2d)
2. Разработать ручку для отдельного заказа (1d);
3. Сделать правку в orderhistory (2d);
4. Выкатить (1d);

Итого, потребуется приблизительно: 9d

Срок может растянуться за счёт необходимости договориться про форматы, за счёт необходимости дождаться подключения оплаты через transactions (тут можно замокать временно поставку чеков из transactions и доделать позже)
