# Композитная оплата 

## Контекст

Добавляем возможность совместной оплаты (рубли + баллы). 
Баллы, Плюс, кошелек - это все одно и тоже.
В процессинге заказа нужно уметь списывать баллы с Плюса, распределять баллы по позициям в заказе, 
формировать правильный инвойс, корректно делать возврат.

## Распределение баллов по айтемам

Для того что бы формировался чек и позиции отображались в чеке, стоимость одной позиции должна быть > 0.
 
Баллами можно оплачивать только целую стоимость (без копеек). Поэтому предлагаю следующую схему, 
если одна позиции стоит ровное количество рублей, то с карты оплачиваем 1 рубль, остальное баллами. 
А если в цене позиции есть копейки, то с карты оплачиваем все копейки до 1 рубля, остальное баллами.  

    Если чай стоит 10 рублей 50 копеек, то с карты оплатим 50 копеек, а 10 рублей баллами

Нужно сделать функцию распределения балов по айтемам заказа.

Предлагается такое решение.
Если количество балов больше чем стоимость всего заказа, тогда:
- пользователь оплачивает с карты сумму равную `(1 рубль Х количество позиций)` 
(если есть позиции с копейками, то немного иначе будет)
- все остальное списываем баллами с Плюса

Если стоимость заказ больше чем количество баллов, тогда:
- проходим по всем позициям, если хватает баллов, то оплачиваем полную стоимость позиции баллами (кроме 1 рубля или N копеек). 
Если не хватает баллов, то оплачиваем только часть позиции баллами.

**Рассмотрим на примерах:**

Меню: Чай - 100р, Кофе - 150р, Хлеб - 20.5р, Суп - 100р

    _Пример 1._
    
    500 баллов на Плюсе
    
    1. Чай - 99р (баллы) - 1р (карта)
    1. Кофе - 149р (баллы) - 1р (карта)
    1. Хлеб - 20р (баллы) - 0.5р (карта)
    1. Суп - 99р (баллы) - 1р (карта)
    
    Итого:
    * 367р с Плюса (остаток на плюсе 133)
    * 3.5р с карты

___

    _Пример 2._
    
    200 баллов на Плюсе
    
    1. Чай - 99р (баллы) - 1р (карта)
    1. Кофе - 101р (баллы) - 49р (карта)
    1. Хлеб - 20.5р (карта)
    1. Суп - 100р (карта)
    
    Итого:
    * 200р с Плюса (остаток на плюсе 0)
    * 170.5р с карты

## Доработка ручки /preorder

Нужно применить функцию распределения баллов по айтемам,
что бы точно посчитать сколько денег будет списано с карты пользователя при оплате и отдать эту инфу на клиенты. 
На клиентах отображается зачеркнутая изначальная цена и отдельно новая цена.
Цену айтемов отображаем изначальную (без учета Плюса)

## Доработка ручки /orders и /v1/order/authorized-update

В ручке создания заказов нужно учитывать включена ли оплата Плюсом или нет.
Если включена оплата Плюсом, то нужно передать ID кошелька в сервис iiko и сохранять его в базе заказов. 
Доработка в ручке /v1/order/authorized-update в iiko.

При создании инвойса (ручка /v2/invoice/create) нужно передать дополнительный способ оплаты - Плюс (если он выбран) 

```json
{
  "account": {
    "id": "w/e5af70eb-6ccf-595e-a4a4-1d32f706a369"
  },
  "method": "w/e5af70eb-6ccf-595e-a4a4-1d32f706a369",
  "service": "13",
  "type": "personal_wallet"
}
```

## Доработка таски restaurant_order_update_transactions

В данной таске происходит обновление инвойса через ручку /v2/invoice/update.
Туда передается список всех позиций с ценами и способом оплаты, с помощью которого эти позиции будут оплачены.
Все что оплачивается баллами можно объединить в одну позицию для упрощения. 
Информация о распределении баллов по итемам будет храниться в базе (ниже будет описано)

Список айтемов передаваемых в ручке /v2/invoice/update для Примера 2 будет выглядеть так:

```json
{
"items_by_payment_type": [
    {
      "items": [
        {
          "amount": "1",
          "fiscal_receipt_info": {
            "title": "Чай x1",
            "vat": "nds_20"
          },
          "item_id": "1",
          "product_id": "eda_107819207_ride"
        },
        {
          "amount": "49",
          "fiscal_receipt_info": {
            "title": "Кофе x1",
            "vat": "nds_20"
          },
          "item_id": "2",
          "product_id": "eda_107819207_ride"
        },
        {
          "amount": "0",
          "fiscal_receipt_info": {
            "title": "Молоко x1",
            "vat": "nds_10"
          },
          "item_id": "3",
          "product_id": "eda_107819207_ride"
        },
        {
          "amount": "20.50",
          "fiscal_receipt_info": {
            "title": "Хлеб x1",
            "vat": "nds_20"
          },
          "item_id": "4",
          "product_id": "eda_107819207_ride"
        },
        {
          "amount": "100",
          "fiscal_receipt_info": {
            "title": "Суп x1",
            "vat": "nds_20"
          },
          "item_id": "5",
          "product_id": "eda_107819207_ride"
        }
      ],
      "payment_type": "card"
    },
    {
      "items": [
        {
          "amount": "200",
          "fiscal_receipt_info": {
            "title": "Оплата баллами",
            "vat": "nds_20"
          },
          "item_id": "1",
          "product_id": "eda_107819207_ride"
        }
      ],
      "payment_type": "personal_wallet"
    }
  ]
}
```

## Как разделять айтемы

Нужно разделить все айтемы на 2 способа оплаты (карта и баллы) используя функцию описанную выше.
Для того что бы разделить айтемы, нужно знать текущий баланс кошелька. 

Тут я вижу несколько вариантов:

1. Доработка в ручке /v1/order/authorized-update
    
    Передаем в ручку баланс кошелька. Применяем функцию описанную выше ко всем позициям.
    
    Добавляем в БД orders новые поля:
    - total_price_by_complement - сумма баллов потраченных на заказ
    - для каждой позиции из items добавляем поле price_by_complement (по дефолту = 0) - сумма баллов потраченных на позицию
    
    При обновлении заказа в БД, также заполняем новые поля. При формировании инвойса используем эти данные и при рефандах, что бы вернуть корректную сумму.
    
1. Доработка в таске restaurant_order_update_transactions
    
    Для получения баланса кошелька в этом случае есть несколько вариантов:
    1. Передать параметром при постановке таски (простой)
    1. Написать новую внутреннюю ручку за TVM в сервисе personal_wallet,
    которая будет возвращать баланс по id кошелька и ходить в эту ручку (чуть сложнее, требуется доп разработка)

    После того, как узнали баланс, применяем функцию распределения баллов. В данном варианте нам
    так же требуется сохранить в базу всю инфу о потраченных баллах и распределении баллов по айтемам.

После обсуждения, принято решение выполнять разделение заказов и обновлять их в базе в ручке order/authorized-update.
Потому что stq-таска restaurant_order_update_transactions сейчас не занимается обновлением данных по заказу, 
она их только распространяет на transactions.
 
## Доработка ручки /v1/cashback

Если заказ оплачивается с использованием баллов, то не нужно начислять кэшбэк за такой заказ.
Нужно добавить проверку, что в заказе есть дополнительный способы оплаты - Плюс, 
в таком случае начислять баллы не нужно.

## Доработка таски restaurant_order_process_cleared

Передать в еду информацию о том, сколько было списано с карты, 
а сколько с Плюса (сейчас передается только полная стоимость заказа).
Нужно для подсчета правильной комиссии. Нужно согласовать API с едой.

## Доработка рефандов

Для того что бы рефанды корректно работали, нужно обновить айтемы в инвойсе
через ручку /v2/invoice/update. Сервис transactions сам посчитает сколько нужно вернуть 
и сходит куда нужно. 

Нужно только сформировать новый список айтемов с учетом возврата. Больше ничего не нужно делать на стороне iiko.

Может быть, несколько кейсов:
1. Вернуть стоимость всего заказа

    При возврате всего заказа, мы возвращаем все что списали с карты и все баллы пользователю.
    В данном кейсе нет каких либо особенностей. Выставляем стоимость всех позиций 0 руб.

1. Вернуть полную стоимость конкретной позиции

    В заказе может быть 2 типа позиций: полностью оплачены картой, 
    часть оплачена картой и часть баллами (как миниму 1 рубль оплачен картой).
    
    Если производится возврат позиции, которая полностью оплачена картой, 
    то мы вернем пользователю деньги на карту.
    
    Если производится возврат позиции, оплаченной баллами и картой, 
    мы возвращаем всё что списали с карты и все баллы.
    
    Тут, как и в первом кейсе все выглядит понятно. 
    Вся информация о распределении баллов по позициям лежит в базе orders.
    
1. Вернуть часть стоимости конкретной позиции

    Такая ситуация возможна, когда пользователь заказывал несколько одинаковых блюд.
    Например 10 супов по 100руб., это будет отображаться в чеке как одна позиция с заголовком
    "Суп х10" и стоимостью 1000руб. Если мы захотим сделать возврат 2ух супов, 
    то нам нужно вернуть 200р по этой позиции.
    
    Если позиция целиком оплачена картой, то возвращаем деньги на карту.
    
    Если оплачена оплаченной баллами и картой, то сначала возвращаем всё в баллах,
    если этого не хватило что бы покрыть возврат, то делаем возврат и по карте.
    
    
    Пример. 
    
    У нас есть 500 баллов на Плюсе и мы покупаем 10 чаев по 100руб. 
    Тогда позиция в чеке бдет оплачена таким образом.
    
    - Чай x10 - 500р (баллы) - 500р (карта)
    
    Делаем возврат 2ух чаев. Возвращаем пользователю 200 баллов.
    
    - Чай x8 - 300р (баллы) - 500р (карта)
    
    Если делаем возврат ещё 5 чаев, тогда вернем все баллы и часть денег на карту.
    
    - Чай x3 - 300р (карта)

## Доработки в ручках получения заказа

Есть несколько ручек для получения информации по заказу:
- /iiko-integration/v1/orderhistory/(list и order) - ручки для получения заказа в истории поездок
- /admin/qr-pay/v1/order - получение инфы о заказе для админки
- /v1/order - внутренняя ручка для получения инфы о заказе (дергается из payments-eda)

Нужно внести доработки в данные ручки. Добавить информацию, что заказ был оплачен частично баллами  и
убрать блок с информацией о начислении кэшбэка где он есть.

В ручке истории поездок нужно отображать сколько списали баллов с пользователя.

В админке нужно отображать сколько было потрачено баллов и распределение баллов по позициям.

## Доработки в БД (orders)

Инфа о дополнительном способе оплаты:

    complement_payment_method_type: text
    complement_payment_method_id: text
   
Инфа о распределение баллов:

    total_price_by_complement: numeric - сумма баллов потраченных на заказ
    в items новое поле price_by_complement - сумма баллов потраченных на позицию