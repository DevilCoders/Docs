## Про сбор метрик ##

# Предыстория

Изначально я планировал использовать для отправки метрик крон-таски и слать метрики пачкой с какой-то периодичностью.
Затем в процессе обсуждений пришли к тому, что лучше слать метрики прям в момент появления события из ручки.
Но в итоге решили использовать и крон, и прямую поставку из ручек.
Подробнее предыдущий вариант можно почитать открыв [предыдущий коммит](https://github.yandex-team.ru/taxi/rfc/pull/312/commits/86f2019219abe1ad82fd253b5487cdb5a03f0908), о новом ниже.

# Какие

**Технические**

Технические метрики будем собирать крон-таской.

В кроне будем проходить по базе и считать количество заказов в статусах для каждого ресторана отдельно:
* PENDING
* HOLDING
* HELD_AND_WAITING_FOR_CONFIRMATION
* HELD_AND_CONFIRMED
* HOLD_FAILED
* CLEARING

Затем отправлять посчитанные количества отправлять в Соломон.
На метрики из кроны буду вешать дополнительную метку (что-то типа cron), чтоб отличить от того, что приходит с ручек.

**Технические и продуктовые**

Также и технические, и продуктовые метрики будем слать прямо из кода ручек.
Технические для того, чтобы сравнить качество мониторинга этим способом с мониторингом при помощи кроны.
А для продуктовых это более удобный способ, к тому же из ручек эти метрики отправить проще.

Отправляться будут следующие события.
Из метода orders_db.create_order():
* PENDING ресторан распечатал предчек - ждем оплаты (фактически это и есть создание заказа)
Из из метода orders_db.change_order_status()
* HOLDING # идет процесс заморозки денежных средств пользователя
* HELD_AND_WAITING_FOR_CONFIRMATION # деньги заморожены - ждем подтверждения от ресторана
* HELD_AND_CONFIRMED # ресторан подтвердил, что заказ должен быть оплачен с нашей стороны
* HOLD_FAILED # не смогли заморозить необходимую сумму на счете пользователя
* CLEARING # клирим
* CLOSED_BY_RESTAURANT # заказ оплачен через ресторан
* CANCELED_BY_RESTAURANT # заказ отменён рестораном
* CLEARED # заказ закрыт нами
Из ручки /v1/order:
* Заказ просмотрен

Тут тоже будет отдельная своя метка, чтоб отличать от cron-метрик.

**Общее по всем поставкам**

Поставлять метрики будем при помощи плагина [Stats](https://github.yandex-team.ru/taxi/backend-py3/blob/0d96d660b81da2e4a502503e7f9c19f50eac0855/taxi/stats.py#L111). Он хорошо подходит для наших целей, потому что агрегирует метрики и шлёт их в отдельной корутине клиенту соломона раз в 60 секунд. Т.е. не будет блочить выполнение кода.

Ко всем событиям будем дописать restaurant_id и restaurant_group_id, которые пока планируют быть человекочитаемыми, если изменится в будущем, то поправим. Но надо помнить про ограничение на длину метки в 199 символов.

Опасения по поводу нагрузки на соломон не оправдались. Наши 1-2 RPS ему нипочём, уточнял в чатике соломона.

**Алерты**

После настройки поставок метрик можно настроить алерты. Алерты настроить можно, например, на слишком большое число заказов зависших в каком-нибудь из статусов.
