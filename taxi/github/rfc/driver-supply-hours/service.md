**Название сервиса**

driver-supply-hours

**Какую продуктовую проблему решает сервис?**

Отдает информацию о количестве сапплай часов водителя/всех водителей в парке в таксометр и Оптеум

**Почему нельзя решить эту задачу без разработки нового сервиса существующими решениями?**

Существующие решения не подходят:

Для таксометра: в монге нет данных старше, чем за два месяца
Для диспы: долго считать общее количество сапплай часов по парку

Мы будем использовать монгу + биллинг для получения данных о водителе
И биллинг для получения данных о парке

Объединяем эту логику в новом сервисе (старая ручка, отдающая данные из монги, живет в deprecated-сервисе parks)

**Как именно сервис будет решать поставленные перед ним задачи?**

Для парков: брать балансы сабсчетов seconds/supply парков из биллинга

Для водителей: "горячие данные" (в пределах последних часов/дней) считать в реальном времени по статусам водителей из монги; более старые данные - с балансов биллинга

**Разрабатывается один сервис или система?**

Один сервис

**С кем взаимодействует сервис?**

Биллинг - получение балансов сабсчетов, на которые пишутся сапплай-часы водителей и парков

**Какие базы использует?**

Mongo dbstatus_history.status_history

Для подсчета времени водителя на линии

**Какие периодические процессы?**

Пока не предусмотрено.

В будущем может появиться джоба пересчета сапплай-часов водителей.

**Планируется обработка персональных данных**

нет

**Какие данные и по какой схеме сервис будет хранить в базе?**

{
    'driver_id': 'clid_uuid',  # айди водителя
    'updated': datetime.datetime.utcnow(),  # время обновления документа
    'created': datetime.datetime.utcnow(),  # округленное до 4 часов время создания документа
    'statuses': [{
        'timestamp': datetime.datetime.utcnow(),  # время, которое прислал клиент
        'status': 'free'                          # статус водителя, free|almost|busy|verybusy  в основном free и verybusy
        'taxi_status': 'free'                     # таксишный статус unknown|free|busy|order_free|order_busy
        'no_moving': true                         # (опционально) true - если водитель не двигался продолжительное время (подробности TAXIBACKEND-13765)
        'is_blocked': true                        # (опционально) true - если водитель заблокирован за усталость в данный момент времени
        'reposition_active': true                 # (опционально) true - если включён и активен режим репозиции, если false - значит включён и не активен. Если этого поля нету - значит выключен. (подробности TAXIBACKEND-14871).
    }]
}

**Какой объем данных будет храниться и какой объем будет изменяться в единицу времени?**

15.6 гб. Данные не модифицируются сервисом

**Какие операции над данными заложены?**

Только чтение

**Есть ли какой-то стейт в памяти, как он обновляется и валидируется?**

Нет

**Какая нагрузка ожидается?**

До 1000 рпс

**Какие фолбеки предусмотрены на сам этот сервис?**

Не будем показывать sh и mph водителя/парка

**Какие фолбеки предусмотрены внутри этого сервиса на взаимодействие с другими сервисами?**

В случае отказа биллинга:

- для водителей: отдаем данные в пределах последних двух дней, считаем по монге в реальном времени
- для парков: не обрабатываем отказ биллинга

**Какие возможности масштабируемости закладываются?**

В будущем возможен перенос джобы, рассчитывающей сапплай-часы из labor в этот сервис

**Какие точки отказа есть в сервисе?**

- Биллинг (фоллбеки описаны выше)
- Монга - фоллбечимся на биллинг

В случае отказа одновременно монги и биллинга, отвечаем 500

**Укажите ключевые продуктовые метрики сервиса, за которыми планируете следить**

sh и mph водителей и парков

**Укажите технические метрики**

- Среднее время ответа на запрос
- Нагрузка на БД
- Количество запросов в биллинг

**Какая функциональность ожидается в сервисе в будущем?**

Такая же, как сейчас - получение сапплай-часов водителей и парков

**Какое изменение нагрузки планируется?**

Прямо пропорционально количеству активных водителей

**Активно ли будет изменяться сервис?**

Добавление новых ручек не планируется.

В сервис может переехать джоба пересчета сапплай-часов.
