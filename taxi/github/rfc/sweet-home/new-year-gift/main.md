# Подарки в домике (хак-а-тон)

Десигн: https://www.figma.com/file/hlqZPVLEtjYhTLnf4lufNI/%D0%A5%D0%B0%D0%BA%D0%B0%D1%82%D0%BE%D0%BD?node-id=0%3A1

Условия:
- показываем только подписчикам
- только v2 ручка
- коммуникации только на основе баланса

Предлагается такой план:

- в communications
  - настраиваем сторизы для каждого баланса - 111, 222...
  - для каждого баланса задаём отдельный экран - `screen111`, `screen222`...
- добавляем эксперимент, где на каждый баланс заводим значение экспа с идентификатором коммуникации
- в домике 
  - проверяем значение экспа, если значения нет, то просто пропускаем данный алгоритм
  - если в экспе есть значение, то добавляем к ответу нотификацию
  - сториз для меню клиенты получат сами из inapp-communications
- клиенты
  - при нажатии на подарок открывается фулскрин

Рассмотрим план подробнее.

- [Коммуникации](#коммуникации)
- [Нотификация про подарок на беджике](#нотификация-про-подарок-на-беджике)
- [Сториз про баланс в меню](#сториз-про-баланс-в-меню)
- [Клиенты](#клиенты)
- [Скоуп](#скоуп)

## Коммуникации

Предлагается использовать **сторизы** (тип `story`), чтобы мы могли одну и ту же коммуникацию использовать и в меню, и при нажатии на подарочек.

Сторизы заводим для экрана `house_of_plus:promotions` ([пример](https://tariff-editor.taxi.tst.yandex-team.ru/promotions/edit/story/16ce2a4092894159bdd5fd4adf498e80)):

- заводим на каждый баланс отдельную историю с названием `{тут может быть префикс}:house_of_plus:promotions:balance:{значение баланса}`
- в качестве аргумента связанного эксперимента используем баланс (ручка communications присылает кварг `wallet_balance`) и признак плюсовости
- для всех сторизов указываем высокий приоритет (например 50) - по этому приоритету ручка `/4.0/inapp-communications/communications` будет при сортировке возвращать сториз с балансом в первую очередь

## Нотификация про подарок на беджике

Нотификация будет превращаться в трансформацию беджика на главном

<img src="https://jing.yandex-team.ru/files/erakli00/badge.png" width="400">

Добавляем в корень ответа `/v2/sdk-state` новое поле:

```json5
{
    // список коммуникаций в рамках домика Плюса. делаем в виде списка, чтобы можно было потом это API
    // переиспользовать, например для нотификаций
    "communications": [
        {
            // будем использовать для кэширования на клиенте, что нотификация была показана.
            // нет смысла спамить об одних и тех же балансах каждый раз (возможно)
            "id": "gift:balance-info:5555",
            
            "options": {
                // флаг управления повторными показами. для того, чтобы мы могли с бека управлять
                // тем, показывать ли подарочек каждый раз как он придёт, если пользователь уже 
                // нажал на подарок
                "show_after_tap": true
            },

            // пока что тип у нас один
            "type": "SPECIAL",

            // описание трансформаций, применяемых к беджику, сейчас только иконка
            "badge_transformations": {
                // переиспользуем существующее описание картинок в текущем протоколе
                "icon": {
                    "url": "https://tc.tst.mobile.yandex.net/static/test-images/598/ccefe4b0-..."
                }

                // animation, etc
            },

            // действие, совершаемое при нажатии на коммуникацию
            "action": {
                // сейчас это будет только открытие коммуникации
                "type": "OPEN_FULLSCREEN",

                // id коммуникации из inapp-communications.
                // клиенты должны получить его из local cache или из ручки /retrieve
                "banner_id": "f30b0df389104c2192a9a7f6417d04cc"
            }
        }
    ]
}
```

> Так как `badge_transformations` и `action` достаточно унифицированные поля, не будем их прятать во внутреннее поле.

Предполагается, что клиенты умеют открывать коммуникацию по идентификатору. Если нет, то должны научиться.

Предлагается всё наполнение коммуникации получать из эксперимента:
- id
- show_after_tap
- icon url
- banner_id

## Сториз про баланс в меню

На месте сториза "Вы в Плюсе" будет сториз с подарком, первый в карусели.

<img src="https://jing.yandex-team.ru/files/erakli00/overview.png" width="400">

## Клиенты

Клиенты должны отображать трансформацию, если она придёт и пока пользователь на неё не нажмёт.

Потом мы можем добавить сокрытие по времени. Важно, чтобы клиенты проверяли, приходила ли раньше данная коммуникация, чтобы не было дёрганной анимации.

## Скоуп

- добавить эксперимент с нотификацией
- поддержать картинки в sweet-home (конфиг или кэш картинок из zoneinfo)
- добавить новый use-case "communications"
- загрузить необходимые коммуникации для балансов
