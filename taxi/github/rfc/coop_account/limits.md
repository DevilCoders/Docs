### Лимиты.

Лимиты будут задаваться в меню редактирования мембера

При включении лимитов в аккаунте, нужно будет указать валюту в которой будем хранить и показывать остаток 
После этого выставляем лимиты пользователю, лимит будем записывать в таблицу stats

#### Новые таблицы:
1. coop_accounts.stats
	* account_id
	* member_id
	* spent - потрачено за месяц
	* date - месяц в котором действует лимит 2019-05
    
    pk (member_id, date)

    индексы:
	* account_id + date

2. coop_accounts.transactions
	* id 
	* order_id 
	* member_id
	* amount
    
    pk (id, order_id)
    	
	данная таблица нужна для идемпотентности подсчета лимитов
	
#### Доработки
1. Ручка /internal/coop_account/check_available

    В ручку check_available добавляем проверку что у пользователя amount-spent > 0 в текущем месяце, 
    если меньше то возвращаем available: False 

2. Доработки в py2
    
    Из py2 после холда средств ходим в сервис для пересчета лимита (может быть нужно запоминать все транзакции) 
    пересчитываем лимит в coop_accounts.stats -> spent.

    Если будет рефанд, ходим в сервис для пересчета лимита (возвращаем в лимит списанную сумму)

3. В ручке stats 

    Для меберов в поле description подставлять строку с доступным остатком: `Осталось 1700 из 2000 руб.` 
    Если у мембера остаток < 0, то возвращаем аккаунт с флагом is_active:False и сообщением об ошибки
    "Лимит исчерпан", что бы пользователь не мог выбрать аккаунт для оплаты.

4. Можно менять лимиты когда угодно
    (на статистику наезженного это не влияет, она не обнуляется), 
    а в будущем видимо будем слать пуши тем, у кого лимит изменился в минус.

    Возможно несколько гонок, если пользователь готовится сделать заказ, а владелец в этот момент меняет лимит:
    * при смени лимита в большую сторону все будет ок
    * пользователь получил аккаунт (/paymentmethods) -> меняется лимит -> 
    пользователь создает заказ -> в /ordercommit придет ошибка, что лимит исчерпан
    * пользователь уже создал заказ -> меняем лимит -> все будет ок, дадим пользователю завершить заказ,
    но новые не получится создать
    
5. При первом холде в месяце добавлять статистику в coop_accounts.stats на новый месяц
    Месяц всегда начинается с 1 числа, таймзона берется из аккаунта (задается при создании аккаунта)

6. Для общего лимита
    
    Ручка для задания общего лимита.
    
    Расширить таблицу accounts, добавить столбцы как у мембера:     
    > limit_amount INTEGER
    has_specific_limit BOOL

#### Продуктовые требования

* Общий лимит на весь аккаунт. 
Пока что нет точного понимания какие лимиты должны учитываться если задан и общий и отдельно для участника,
какое поведение при изменении общего, если задат лимит на участника и наоборот

* Запрещаем поездки только когда лимит ушёл в минус, если на счету осталось 10 рублей, а поездка стоит 100 руб., 
то после этой поездки лимит станет -90руб. и пользователь не сможет больше поехать по этому аккаунту до конца месяца

* Если у пользователя остался хотя бы 1 рубль из доступного лимита, то он сможет сделать заказ
и так как пересчет лимитов будет при холде(или в конце поездки), то пользователь сможет сделать еще несколько заказов
по мультизаказу или с другого телефона, до того момента пока не пересчитается лимит. Дима с этим Ок.


#### API

Ручка для выставления общего лимита (возможно это будет в ручке details)

    PUT /4.0/coop_account/limits

Внутренняя ручка для холда/рефанда средств, дергается из py2 для заказов по семейному аккаунту

    POST /internal/coop_account/transaction

Ручки для валют (согласовано)

    GET /4.0/coop_account/currencies
    PUT /4.0/coop_account/currency