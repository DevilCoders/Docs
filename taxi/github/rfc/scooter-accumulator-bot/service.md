**Название сервиса**

scooter-accumulator-bot

**Какую продуктовую проблему решает сервис?**

Используется для получения (сдачи) аккумуляторов из шкафов (в шкафы) в оффлайн режиме, когда шкаф недоступен удаленно.
Является fallback-ом для случая, когда сервис scooter-accumulator не может получить ответ от шкафа.

**Почему нельзя решить эту задачу без разработки нового сервиса существующими решениями?**

Нет сервиса решающего эту проблему. Сервис взаимодействует с другим сервисом - scooter-accumulator, но писать бота в рамках этого сервиса кажется неправильным, т.к. scooter-accumulator - это внутренний сервис на основе userver. А бота писать лучше на питоне, и скорее всего пригодится кодовая база backend-py3.

**Как именно сервис будет решать поставленные перед ним задачи?**

Для цикла замены аккумуляторов в самокатах используется сервис scooter-accumulator, который хранит информацию об аккумуляторах, отправляет команды шкафу, получает ответы от шкафа.

Если шкаф не отвечает (в первом приближении шкафы не смогут отвечать ничего, а в дальнейшем просто может пойти что-то не так), то ручки scooter-accumulator будут возвращать ошибки, т.к. от шкафа нет информации, и мы не можем знать, забрал контрактор аккумуляторы или нет.

В этом случае ответственный за аккумуляторы сможет отправить в бота id-шники (QR-коды) аккумуляторов, которые забрал у курьера или отдал ему. А бот сообщит эту информацию в scooter-accumulator, после чего ручки scooter-accumulator ругаться уже не будут, т.к. информация о выдаче/сдаче аккумуляторов получена.

Примерный флоу:
1. Контрактор приезжает забрать аккумуляторы, нажимает кнопку в приложении "открыть ячейку".
2. Бекенд самокатов дергает ручку выдачи аккумуляторов у scooter-accumulator.
3. scooter-accumulator посылает команду разблокировки ячеек шкафу.
4. Если дожидается, то scooter-accumulator-bot во флоу не участвует. Если не дожидается ответа, то во флоу подключается scooter-accumulator-bot.
6. scooter-accumulator возвращает в бекенд самокатов ответ о том, что шкаф недоступен.
7. Бекенд сообщает контрактору об этом и просит дойти до ответственного за аккумуляторы и попросить его выдать аккумы вручную.
8. Контрактор сообщает ему свой ID-шник.
9. Ответственный за аккумуляторы отправляет ID-шкафа и ID-контрактора боту, бот дергает ручку cabinet/booking_info в scooter-accumulators и находит список аккумов, которые нужно отдать, и отправляет эту информацию ответственному за аккумуляторы. Бот также выставляет состояние state = GIVE_ACCUMULATORS в бд и записывает contractor_id, cabinet_id. state = GIVE_ACCUMULATORS означает, что сейчас ответственный выдает аккумы для контрактора contractor_id из шкафа cabinet_id.
10. Ответственный сканирует QR-коды (ID-шники) аккумов и отправляет их в бот, который дергает ручку accumulator/taken в scooter-accumulators (contractor_id, cabinet_id берутся из бд).
11. Ответственный отдал все аккумы и написал боту "закончил", бот в этот момент обновит бд и выставит state = NONE.
12. Контрактор жмет в приложении кнопку "забрал аккумуляторы", которая по итогу дернет ручку валидации accumulator/validate_booked_taken сервиса scooter-accumulator, которая проверит корректность взятия аккумуляторов.
13. Так как бот отослал информацию в scooter-accumulator, то взаимодействие со шкафом на этапе валидации не нужно, достаточно просто посмотреть в состояние базы данных, которое обновлялось на каждый вызов accumulator/taken.

Возврат аккумуляторов проходит аналогично, используя в scooter-accumulator ручку accumulator/returned.

Сервис scooter-accumulator-bot будет:
- выдавать информацию по бронированиям ответственному (пользователю бота) по ID-шниками контрактора + шкафа. Эту информацию он будет получать от scooter-accumulator по ручке cabinet/booking_info
- передавать ID-шники (отправленные боту) взятых/сданных аккумуляторов в сервис scooter-accumulator, использую ручки accumulator/taken, accumulator/returned

**Разрабатывается один сервис или система?**

Один сервис.

**С кем взаимодействует сервис?**

Клиент telegram <-> scooter-accumulator-bot <-> scooter-accumulator.

**Какие базы использует?**

Postgres в PGaaS.

**Какие периодические процессы?**

Нет

**Планируется обработка персональных данных**

Не планируется обработка персональных данных.

**Прикрепите схему того, где этот сервис находится в текущей инфраструктуре**

- Клиент telegram <-> scooter-accumulator-bot
- scooter-accumulator-bot <-> api.telegram.org
- scooter-accumulator-bot <-> scooter-accumulator

**Какие данные и по какой схеме сервис будет хранить в базе?**

```javascript
1) allowed_clients
{
  "login": "login ответственного за шкаф"
}

2) client_states
{
  "login" NOT NULL: "login ответственного за шкаф",
  "state" NOT NULL: "одно из состояний NONE/GIVE_ACCUMULATORS/GET_ACCUMULATORS",
  "contractor_id": "id контрактора в случае state = GIVE_ACCUMULATORS/GET_ACCUMULATORS",
  "cabinet_id": "id шкафа в случае state = GIVE_ACCUMULATORS/GET_ACCUMULATORS"
}
```

**Какой объем данных будет храниться и какой объем будет изменяться в единицу времени?**

Меньше 10Mb

Изменений до 0.1Mb/s

**Какие операции над данными заложены?**

CRUD

**Есть ли какой-то стейт в памяти, как он обновляется и валидируется?**

Нет

**Какая нагрузка ожидается?**

- На первом этапе (т.к. запускаемся в оффлайн режиме) - 1 rps.
- В случае использования как фолбек - 1 rps.
- В остально время - <1 rps.

**Какие фолбеки предусмотрены на сам этот сервис?**

Фолбека нет.
Если сервис недоступен, выдать/сдать аккумуляторы в оффлайн режиме не можем.

**Какие фолбеки предусмотрены внутри этого сервиса на взаимодействие с другими сервисами?**

Фолбеков нет.
Если scooter-accumulator недоступен, выдать/сдать аккумуляторы не можем.
Если Telegram API недоступен, выдать/сдать аккумуляторы в оффлайн режиме не можем.
Если Postgres недоступен, выдать/сдать аккумуляторы в оффлайн режиме не можем.

**Какие возможности масштабируемости закладываются?**

Увеличение базы.

**Какие точки отказа есть в сервисе?**

- Отказ Telegram API.
- Отказ Postgres.

**Укажите ключевые продуктовые метрики сервиса, за которыми планируете следить**

Нет

**Укажите технические метрики**

- Количество запросов.
- Максимальное и среднее время ответа на запрос.

**Какая функциональность ожидается в сервисе в будущем?**

Расширение/упрощение функционала бота для клиента, связанного со сдачей, получением аккумов.

**Какое изменение нагрузки планируется?**

Прямо пропорционально количеству шкафов.
Нагрузка будет на первом этапе (т.к. запускаемся в оффлайн режиме) и в случае работы как фолбека.
В остальное время ожидается мало нагрузки.

**Активно ли будет изменяться сервис?**

Активных изменений в сервисе не предполагается.
