# ПОКА - ЧЕРНОВИК, ПРОРАБОТКА БУДЕТ ПРОДОЛЖЕНА ПРИ НЕОБХОДИМОСТИ. ПОКА НЕ ПОНЯТНО, НУЖНО ЛИ НАСТОЛЬКО ОПЕРАТИВНОЕ ОБНОВЛЕНИЕ ИНФОРМАЦИИ, КАЖЕТСЯ ЧТО ПОЛЛИНГА РАЗ В СЕКУНДУ ВПОЛНЕ ДОСТАТОЧНО.

### 2. Оперативное обновление статусов операторов в списке

Бек:
- Подписываемся на события лог-брокера
- По событиям меняем статус и очереди оператора:
    - ADDMEMBER - (обновить очереди оператора) + статус Ожидает
    - REMOVEMEMBER - (обновить очереди оператора) + статус Отключен
    - ENTERQUEUE - 
    - CONNECT - Разговаривает
    - ABANDON - 
    - COMPLETEAGENT - Ожидает
    - COMPLETECALLER - Ожидает
    - RINGNOANSWER - пропустил звонок, ожидает
    - ATTENDEDTRANSFER - ?
    - BLINDTRANSFER - 
- Начинает обновлять данные в таблице, и начинает ходить в телефонию по обычным ручкам гораздо реже

!! НЕ НАШЕЛ В СПИСКЕ СОБЫТИЙ ПАУЗУ/ВОЗОБНОВЛЕНИЕ

Фронт:
- получает токен для XIVA
- устанавливает WS соединение по токену и ждет ивентов
- По ивентам (один ивент - данные по одному оператору) обновляет UI по данному оператору

#### Доработки
##### Ручка получения токена для подписки
`POST /v1/admin/get_xiva_token`
Ответ: `{"sign": "00a1560f46a1953645c9dd9fbcba4836", "ts": "1510268445"}`

TODO: будем как-то решать проблему, что между первым запросом страницы и получением ксивовского токена прошло какое-то время, и эти события могут быть потеряны


##### Формат WS сообщения
- Тип: `operator_update`
- соответствует одному оператору из ручки `GET /v1/admin/operators/`

### 3. Риалтайм панель - поллинг
Бек:
- получает события через лог-брокер, обновляет PG таблицу очередей
    - таблица `queues`
        - `operators_online`
        - `calls_in_line`
- заполнение таблицы на фронте осуществляется через ручку `GET /v1/admin/queues`

### 4. Риалтайм панель - WS
Бек:
- При поступлении события но не чаще чем в Х миллисекунд по каждой очереди - отправляем во фронт событие через WS
- тип события: `queue_update`
- состав события - аналогичен одному элементу из ручки `GET /queues`

Фронт:
- первоначально заполняет таблицу через механизм поллинга
- подписывается на события
- начинает обрабатывать новые события и обновлять дашборд