# Риалтайм панель менеджера

## Цель
Обеспечить обновление статусов по очередям и операторам для руководителей КЦ для принятия решений.

## Ограничения и допущения
- на стороне коллцентра нет агрегированной информации по очередям, есть только поток событий
- допустим что события могут теряться (push-client, баги в коде, edge-кейсы) но порядок событий будет верный
- допустим что задержка в доставке сообщений через логброкер в кросс-дц будут примерно равна текущей по другим топикам (99ый перцентиль ~10 секунд)

## Архитектура концептуально
- поток событий об операторах передается из телефонии в сервис `callcenter_telephony` и в YT (в YT -  стандартным механизмом через `logfeller`)
- сервис обрабатывает события и обновляет статусы операторов и звонков
- статистика по очередям для фронта (кол-во операторов на линии, звонков в ожидании) расчитывается на лету на основании статусов операторов/звонков. Стараемся чтобы считалась по индексам целиком.
- долгорочную статистику строим из YT

## Разбиение на микросервисы
Сервис taxi-integration-api-auth сильно разросся, и кажется пришло время его дробить. Предложение следующее:
- `taxi-integration-api-auth` - оставляем только аутентифиацию и авторизацию запросов к integration-api. Операторов получает из callcenter_operators, возможно стоит добавить кеширование чтобы гарантировать бесперебойную работу. Своей БД не имеет.
- `callcenter_operators` - работа с операторами (добавление, удаление, возможно в будущем права). Пока также оставляем тут работу с очередями и статусами в телефонии.
- `callcenter_stats` - работа с телефонией - пока сбор статистики из лог-брокера для риалтайм панели, возможно потом сюда можно будет перенести часть из телефонии из `callcenter_operators`

### Задачи
 - `1d` завести два новых сервиса и базы под них, перенести базу в новый сервис (секдист)
 - `2d` вынести в новые сервисы логику из прокси без изменений

## Возможные улучшения
- сервис сам мониторит задержку по событиям и при неактуальных данных отдает признак этого на фронт

### Если увидим что бывают потери событий
- периодически (раз в минуту?) проверяем самые долго не обновлявшиеся статусы всех операторов, и если статус не обновлялся больше достаточно большого промежутка времени (~10 минут?) - то сбрасываем статус на "оффлайн". Аналогично со звонками (сбрасываем на "звонок завершен"). Покрываем это мониторингами.

## Недостатки
- в случае задержек событий (вероятность оценить пока сложно) от лог-брокера будет задержано обновление статусов. Этот риск принимаем, так как по информации от рук-ля КЦ риалтайм вмешательства не требуются.
- в случае потери событий (вероятной точкой потери видится push-client, так как там клиент не получает ack на отправку) - некоторое время будут неактуальные данные на панели
- если потребуется более глубокая статистика (старше чем за последние несколько часов), то она доступна только через YT

*Ниже - черновик*

## Архитектура (чуть более) детально
- вводим таблицы:
    - статус операторов
      - id оператора
      - статус (оффлайн/на линии/на паузе/в разговоре)
      - очереди оператора
      - текущий звонок
    - статус звонковв
      - id
      - статус (abandoned, )
      - длительность
      - оператор
      - очередь
      - тип звонка (входящий/исходящий)
      - waittime
      - position
      - origposition
- телефония пишет события в logbroker. Настройки лог-брокера:
   - геораспределенный кластер (`lbkx`), обеспечивает строго exactly once и упорядоченность
   - время хранения сообщений - минимально 1 сутки, в идеале несколько дней
   - один общий топик всех событий (https://lb.yandex-team.ru/crossdc/topic/taxi%2Fcallcenter%2Fproduction%2Fqapp-events)
   - один читатель
   - ожидается средний rps в районе 300
   - средний размер сообщения 500 байт, соотв поток 150кб/сек
- сервис подписывается на события, обрабатывает как описано ниже
- фронт поллит ручку `GET /queues/status` и полуачает агрегированные данные по очередям. В дальнейшем можно перевести на Websocket если будет необходимо, пока кажется что запросы будут INDEX ONLY SCAN и будут выполняться быстро, ничто не мешает поллить раз в секунду. К тому же лог-брокер тоже добавляет некую задержку.

### Задачи
 - `2d` механизм чтения потока событий из лог-брокера
 - `3d-5d` обработка поступающих событий по правилам (включая согласование этих правил)
 - `2d` ручка отдачи статистики на фронт включая согласование АПИ
 - `0.5d` доработка ручки отдачи операторов - дополнять статусами из таблицы
 - `2d` тестирование в тестинге
 - `1d` нагрузочное тестирование
 - `2d` запуск


## Обработка событий
    - ABANDON (вызов не отвечен): обновляем статус звонка + position|origposition|waittime
    - ADDMEMBER (подключение к очереди агента): обновляем статус агента в очереди
    - REMOVEMEMBER (отключение от очереди агента): обновляем статус агента в очереди
    - ENTERQUEUE (вход вызова в очередь - новый вызов): добавляем новый вызов в очередь
    - CONNECT (вызов отвечен оператором) - статус оператора, статус звонка
    - COMPLETEAGENT (вызов завершен оператором) - статус оператора, статус звонка
    TBD

## Формирование панели
TBD

