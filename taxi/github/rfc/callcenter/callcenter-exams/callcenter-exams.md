# Сервис для тестирования операторов коллцентра

## Бизнес-описание

Нам нужно одновременно нанять на работу несколько тысяч операторов. Для этого
их нужно как-то тестировать. Механика работы следующая:

1. Оператор открывает в браузере страницу с экзаменом, авторизуется и нажимает
кнопку начать экзамен
2. Оператор начинает отвечать на вопросы. Каждый вопрос имитирует реальный
кейс звонка в КЦ. В рамках вопроса оператору проигрывается аудио звонка
пользователя и проверяются действия оператора и соответствие результата
обработки звонка ожидаемому
3. После прохождения экзамена руководителю оператора отправляется отчет о
прохождение экзамена

Также будет режим тренажера. Режим нужен, чтобы оператор познакомился с
интерфейсом программы. От экзамена отличается тем, что результаты нигде не
сохраняются, а вопросов всего несколько вариантов.

## Техническая реализация проекта

### Проверка ответа на вопрос
Ожидаемый результат обработки звонка описываем json с набором ручек. Ручки
должны были вызваться в процессе и их параметры(возможно не все, а только те,
которые нужно проверять) +, если нужно, финальное действие, которое должен был
сделать оператор. Например, если должены были быть вызваны order_estimate
с параметрами и orders_cancel, а в итоге оператор должен был переключить
на саппорт
```json
{
  {
    "handler" : "order_estimate",
    "action" : {
      "requirements": { "nosmoking": true },
      "route": [ [37.588144, 55.733842], [37.565210, 55.734434] ],
      "selected_class": "econom",
      "discount_card": "77",
      "payment": {
            "type": "cash"
          }
      }
  },
  {
    "handler" : "orders_cancel"
  },
  {
    "handler" : "final_action",
    "action" : "switch_to_support"
  }
}
```

### Ручки

Сервис callcenter-exams содержит 2 группы ручек
1. Ручки для предоставления вопросов, сохранения информации об экзмене, etc.
2. Моки ручек необходимых фронту для имитации работы в режиме экзамена и в
режиме тренажера.

#### Мок ручки

Получают на вход id экзамена и номер белета, если применимо, данные, которые
нужно проверить. Например, запрос к order_estimate_mock должен выглядеть так
```json
{
  "exam_id": "id",
  "ticket": 14,
  # Далее информация для валидации
  "requirements": { "nosmoking": true },
  "route": [ [37.588144, 55.733842], [37.565210, 55.734434] ],
  "selected_class": "econom",
  "discount_card": "77",
  "payment": {
        "type": "cash"
  }
}
```
Если применимо, валидируют входные данные. Сохраняют информацию о правильности
похода в них в коллекцию *questions_pass*. Возвращают ответ, сохраненный для
соответствующего вопроса и ручки json.

Ручки у которых ничего проверять не нужно или нужно проверять только сам факт их
вызова:
- ``expecteddestinations``
- ``expectedpositions``
- ``orders_cancel``
- ``orders_commit``
- ``orders_search``
- ``zoneinfo``
- ``nearestzone``
- ``zonaltariffdescription``
- ``nearestposition``
- ``paymentmethods``
- ``profile``

``orders_draft`` -  проверяет route, requirements, payment, class,
``orders_estimate`` - тут сложнее, пока делаем проверку, что последний поход
в эту ручку был с правильными параметрами. При этом теряем возможность сделать
кейс, где пользователь позвонил, указал точки a и b, оператор их вбил, потом
пользователь попросил поменять маршрут.

#### Ручки для работы экзамена

``start_exam`` - принимает на вход данные оператора, генерит новый exam_id
для экзамена, создает записи в базе данных коллекции *exams_pass*, возвращает
первый вопрос

``pass_question`` - принимает на вход exam_id, номер билета и final_action,
проверяет правильно ли было выполнено предыдущее задание по данным в
*questions_pass* и *exam_questions*, сохраняет информацию в *exams_pass*.
Возвращает id нового вопроса и его номер.

``finish_exam`` - завершает экзамен, формирует отчет и отправляет его
руководителю сотрудника.

### Новые коллекции

#### Коллекция ``exam_questions``

```python
exam_questions = {
  'question_id': string,      # id вопроса
  'audio_link': string,       # ссылка на аудио для вопроса
  'answer': json,             # ответ на вопрос, формат см. выше
}
```

Индексы:

```yaml
indexes:
- key: question_id
  unique: true
```

#### Коллекция ``exams_pass``

```python
exams_pass = {
  'exam_id': string,            # id экзамена
  'user_id': string,            # id пользователя
  'start_time': timestamp,      # время начала экзамена
  'end_time': timestamp,        # время конца экзамена
  'score': int,                 # Количество правильных ответов
}
```

```yaml
indexes:
- key: exam_id
  unique: true
- key: user_id
```

#### Коллекция ``questions_pass``

```python
questions_pass = {
  'exam_id': string,            # id сессии
  'question_id': string         # id вопроса
  'question_stat': json,        # статистика по вопросу
}
```

```yaml
indexes:
- key: exam_id
- key: question_id
```

#### Коллекция ``exam_variants``

```python
exam_variants = {
  'variant_id': string,         # id варианта
  'questions': string[]         # список вопросов
}
```

```yaml
indexes:
- key: variant_id
  unique: true
```

### Оценка сроков

Список задач:

1. ``[1d]`` Создание коллекций в монге
2. ``[5d]`` Мок ручки
3. ``[2d]`` Ручка ``start_exam``
4. ``[3d]`` Ручка ``pass_question``
5. ``[2d]`` Ручка ``finish_exam``
6. ``[2d]`` Добавить аутентификацию во все ручки
7. ``[1d]`` Создать скрипт для генерации json-ов правильных ответов
7. ``[2d]`` Запуск экзаменов. Такой запас на то, что придется самому создавать
            варианты либо объяснять как все работает ребятам из КЦ + могут быть
            какие-нибудь проблемы с интеграцией с фронтом.
Итого: 18d, это умеренно оптимистичные оценки.
