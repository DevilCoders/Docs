# Меню ресторанов Еды

## Как работает сейчас

За выдачу меню ресторанов отвечает ручка `/api/v2/catalog/{slug}/menu`
Эта ручка рерайтится в ручку `/api/v2/menu/retrieve/{slug}` в [конфиге nginx](https://bb.yandex-team.ru/projects/EDA/repos/infrastructure_ansible/browse/roles/nginx/templates/vhosts/frontend-v2.j2#619).
Далее запрос попадает в EAP и оттуда перенаправляется в кору.

## Что нужно делать

Нужно добавлять в ручку меню ресторанов новую бизнес логику. В частности, [задачу с экспериментом сортировки блюд внутри категории](https://st.yandex-team.ru/EDADEV-38051).

## Способ решения

Нужно написать сервис, который будет применять модификации к ответу Коры и возвращать клиенту модифицированный ответ.

Примерная схема: nginx -> EAP -> Api-Proxy -> Eda Core -> Api-Proxy -> New Service.

Ответ сервиса будет в точности повторять текущий ответ ручки  `/api/v2/menu/retrieve/{slug}`. Запрос будет повторять ответ этой же ручки + поле `slug` с именем точки в корне.

Переключение на новый сервис предлагается делать по эксперименту через api-proxy.

## Параметры нового сервиса

### Ожидаемая нагрузка

В пике 100 rps

### Какие фолбеки предусмотрены на сам этот сервис

Фолбек на использование немодифицированного ответа коры

### Какие фолбеки предусмотрены внутри этого сервиса на взаимодействие с другими сервисами

При недоступности любых дополнительных сервисов отвечаем as-is.

### Какие возможности масштабируемости закладываются

При росте нагрузки можно будет докинуть инстансов.

### Какие точки отказа есть в сервисе

Поход в сервис eats-ordershistory

### Продуктовые метрики

Будем смотреть конверсию в заказ, позицию выбранного блюда, средний чек.

### Технические метрики

Тайминги ответа, процент не 200 ответов.

## Первый модификатор

Первый модификатор ответа меню ресторана требуется для [эксперимента сортировки блюд](https://st.yandex-team.ru/EDADEV-38051).

Нужны следующие сортировки:

1. сортировка по популярности
1. по наличию акции - сначала, потом - по популярности
1. сначала - если пользователь заказывал это блюдо, потом - по популярности
1. как сейчас
1. рандомный порядок

### Популярные блюда

Приоритеты считаются исходя из количества заказов блюда в данной точке. Для их вычисления будет написана крон-таска, которая запустит вычисления по данным заказов и ресторанов в YT и запишет их в отдельную таблицу.

### Рандом

Нужен рандом, воспроизводимый в течение дня, разный для разных категорий. Для этого нужно инициализировать генератор псевдослучайных чисел хешем от user_id + date + category_id. Где date — текущая дата по Москве.

### Наличие акции

Это поле уже отдаётся в ответе api коры, можно использовать для сортировки.

### Заказывал блюдо раньше

[Описание здесь](./ordered_dishes.md)
