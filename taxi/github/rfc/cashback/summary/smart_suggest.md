Делаем новую логику показа.
Показываем пользователям, кроме кейсов:
1. Если пользователь потратил баллы больше чем 2 раза, то не показываем
2. Если пользователь уже видел саджест на этой неделе 1 раз, то не показываем (как узнать, что мы точно показали плашку пользователю?)
3. Если баланс не менялся, то не показывать (на клиенте?)

## Часть 1
Нужна статистика по юзерам, тратил ли тот баллы.

Варианты:  
**Как для рейтинга пользователя:**
1. orders_monthly в YT
2. процесс в DWH
3. табличка в YT для нас
4. крон в нашем сервисе, plus-sweet-home или plus-wallet
5. postgres в нашем сервисе  

**На тегах:**
1. orders_monthly в YT
2. админка тегов с YQL запросом
3. тег на юзера вроде composite_rider/plus_spender/smth else

Выбираем вариант с тегами. Аналитики от тегов ок, но просят в будущем при необходимости большего количества статистики по плюсовым юзерам делать ее отдельно, не на тегах.

## Часть 2
Как кешировать баланс

**На клиенте**  
Там нет приличного готового способа это кешировать и нужно писать самому. Ресурса клиента у нас мало.

**На беке**
Тут мы не можем дать гарантий. Мы можем только фиксировать, что отправили, а что юзер видел - не можем.

Нужна какая-то база.
У нас есть база с фолбеком балансов кошельков, можно добавить в нее. Тогда понадобится ручка получения баланса прошлого брендинга, ручка сохранения и собственно использование этих ручек.

Или же можно использовать кеш общего назначения из либы api-cache. Для него есть обертка, но внешних юзеров кроме собственно сервиса api-cache кажется пока нет. В этом варианте не придется писать ручки, только складывать в кеш и доставать из него.

## Часть 3
Как доставлять новый брендинг на клиент.

Варианты:

**Переселяем наш брендинг ##complement_payment## в новый routestats.**   
  Работа на беке:
  1. Переселить брендинг
  * Получить балансы - уже есть
  * Проверить наши конфиги и эксперименты - тоже не должно быть проблем
  * Проверить tariff_settings - есть
  * Проверить цену по тарифу - цена есть GetFinalPrice
  2. Добавить в новый routestats теги. Кажется, есть либа, не должно быть проблем.
 
В целом все данные есть, нужно только принести теги, повторить код и тесты. Суммарно неделя-полторы наверное.

  Работа на клиенте:
  1. Клиенты делают ограничение про раз в неделю.

**Правим наш брендинг в монолите**   
  Работа на беке:
  1. Добавляем проверку, есть ли в списке тегов наш. Список тегов уже есть.
5 строчек и тесты. 1 день.

  Работа на клиенте:
  1. Клиенты делают ограничение про раз в неделю.

Не подходит, если нам прямо сейчас нужно кеширование баланса с прошлого показа.

**На основе 4.0/inapp-communications/promos-on-summary. Тут мы надеемся, что нам хватит поля ##show_policy## для наших ограничений по показу.**  
  Работа на беке:
  1. Расширяем 4.0/inapp-communications/promos-on-summary новым параметром ##place##, где будем передавать, что плашку нужно показывать сверху
  2. Учим 4.0/inapp-communications/promos-on-summary ходить в наш сервис за новой промкой
  3. В нашем сервисе ходим за статистикой и балансом
  4. И собственно готовим промку

  Работа на клиенте:
  1. Поддерживаем расширение 4.0/inapp-communications/promos-on-summary новым полем
  2. Делаем логику про переход в методы оплаты из этой новой промки

##Итого варианты
**Супер быстрый и с перспективой***Выбрали его*
Сейчас 2 дня и на беке и на клиенте. Потом наверное 2 недели на inapp на беке и клиенте. И отдельно неделя на кеш на беке.
*Если пользователь потратил баллы больше чем 2 раза, то не показываем* - делаем на тегах в монолите
*Если пользователь уже видел саджест на этой неделе 1 раз, то не показываем (как узнать, что мы точно показали плашку пользователю?)* - делаем на клиенте

Потом переносим все в inapp-communications.
*Если баланс не менялся, то не показывать (на клиенте?)* - и доделываем это

**Более правильный и без перспективы**
Сейчас 2 дня на клиенте и неделя-полторы на беке. И отдельно неделя на кеш на беке.
*Если пользователь потратил баллы больше чем 2 раза, то не показываем* - делаем на тегах в юсервисах
*Если пользователь уже видел саджест на этой неделе 1 раз, то не показываем (как узнать, что мы точно показали плашку пользователю?)* - делаем на клиенте
*Если баланс не менялся, то не показывать (на клиенте?)* - тоже делаем в юсервисах сразу

Вкладываться сейчас и потом все равно переделывать на inapp будет странно, поэтому скорее всего останется так.

