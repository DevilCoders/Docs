## Задача
Получилось, что pricing_data.user.total не хранит в себе итоговую цену для пользователя: нужно прибавить еще стоимость кешбека. Это неправильно - нужно исправить и сделать так, чтобы pricing_data.user.total включала в себя кешбек.  

## Решение
Мы с Иоанном немного пообсуждали этот вопрос. Выводы лучше всего смотрятся на флоу заказа и процессе обновления `current_prices`

0. routestats - цельный тотал позволит забирать сразу его для показа на саммари. Кешбек продолжаем забирать из меты.
1. ordercommit - тут ничего не меняется, `pricing_data` остается и мы заполняем `current_prices` на его основе.
2. apply_multiclass - обновится `pricing_data` в проке и вместе с ней обновим `current_prices`
3. assigned - в `pricing_data` есть отдельный набор всех данных для кейса платной подачи. Если случилась платная подача, просто забираем из него, иначе - из основного набора.
4. current cost - в процессе поездки мы пока планируем получать от таксометра только итоговую цену для пользователя, не планируем считать все меты. То есть`current_prices` нам придется считать самим. Это не кажется проблемой, потому что до завершения заказа нам сейчас нужны:
* `user_total_price` для антифрода и ее нам даст таксометр
* `user_total_display_price` для показа пользователю. Для композитки в ней нужно будет вычесть сумму, оплачиваемую кошельком. Это останется в сервисе `current-prices-calculations`
5. move_to_cash - Сразу контекст, кейс с кешбеком: юзер едет с кешбеком, платит 900 за поездку, 100 за кешбек, итого 1000. Водитель получит 900. Происходит сброс на кеш. Мы не можем взять с юзера 100 рублей за кешбек кешом и вынуждены его "потерять". То есть стоимость пассажира становится 900, то есть тотал должен стать 900.  
Сейчас есть проблема: тип оплаты считается в прайсинге неизменным значением и лежит в `backend_variables`. Нужно будет переместить его в изменяемые `trip_details`. Тогда после сброса на кеш прайсинг внутри таксометра сможет отреагировать на это изменение, пересчитать преобразования, кешбек из стоимости пропадет и нам придет от таксометра 900. Тут есть три детали:
* От типа оплаты зависит наличие кешбека, то есть зависит, выпускаем мы меты про кешбек или нет. Сейчас нельзя ставить выпуск меты под динамическое условие из `trip_details`.
* Вместе со сбросом на кеш теряется еще и композитная оплата. Да, они не могут встретиться с кешбеком в заказе, но это тоже часть метода оплаты.
* Нам нужно быстрое обновление стоимости для юзера, мы не можем ждать, когда таксометр решит в следующий раз вызвать `polling/cost` и прислать нам обновленную сумму. Нужно придумать, как это делать форсированно.
6. back_to_card - аналогичная история наоборот
7. cancel - тут ничего не меняется, прайсинг отмену пока не трогает.
8. requestconfirm на `complete`- у нас вот-вот будет прайсинг в конце поездки, который получается так: клиент таксометра отдает `trip_details` при завершении заказа - прайсинг считает цены и меты - и отдает их в протокольный `requiestonfirm`.  
Здесь мы и будем на основании данных прайсинга делить тотал на `order.cost` и `order.cashback_cost`. То есть `order.cost` останется ценой поездки для пассажира.


## План
1. Выпилить купонные костыли и `price_before_coupon`
2. Перенести метод оплаты в `trip_details`. И разобраться с метами.
3. Переделать `requestconfirm`: разделить тотал на `cost` и `cashback_cost`