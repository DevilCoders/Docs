# Лесенка кешбека
## Задача
Управлять кешбеком на эконом. 
1. Управляемые конфигурации по процентам. Вопрос: должны ли они сосуществовать. Должны. В экспе хотят закрыть другие страны. Хотя я пока не думал про эксп совсем. Страну можно прям в преобразовании проверить
* 3% с 3й поездки за месяц (3% с 4й поездки и тд) Вопрос: по любому тарифу? По любому.
* 5% с 5й поездки за месяц (5% с 7й поездки и тд)
2. Управляемые конфигурации по юзерам
* Давать плюсовикам и неплюсовикам
3. Ограничение на начисленный кешбек - 3000. Вопрос: 3000 кешбека за эконом или 3000 кешбека вообще? На всё.
4. Окно для расчета количества поездок и суммы лимита - календарный месяц. Начался новый месяц - счетчик поездок и счетчик лимита сбрасываются.

## Этапы
### Подсчет статистики
**Варианты**
1. YT. Аналитики готовят табличку, какие юзеры удовлетворяют всем ограничениям, мы эту табличку забираем. А лучше даже сразу теги расставляют на юзеров, вроде `cashback_econom_step_1` - это значит, что юзер на первой ступеньке лесенки.  
Проблема - Геша хочет быстрое обновление, в течение 10 минут после поездки. YT нам такое дать не может.
2. Собственный сервис+`user-statistics`. Предлагаю использовать уже имеющийся `cashback-levels`.  
И тут разделение: статистику по количеству поездок и начисленному кешбеку считать отдельно.
* Уже есть очередь коллбек в очередь `process_balance_change`, который ставится на любое изменение баланса и даже поле `cashback_amount` в базе уже есть. Оно тоже на календарный месяц и это то, что нам нужно.
* Количество заказов. Думали получать из сервиса `user-statistics`, но он не может нам этого дать: так как хранит только счетчики и не может пересчитать за произвольное окно. То есть допилить его, точнее даже переделать - начать хранить счетчики с гранулярностью по дням или вообще заказы с полями, по которым мы считаем статистику. Тогда получится получать статистику за любое окно.  
Но есть шанс, что мы прокачаем `user-statistics`, а новые возможности никому не понадобятся.  
Возможно, Леша Быков сможет нам помочь, но это нужно с Ваней Ивашковским говорить.
3. Только собственный сервис. Тот же вариант 2, но количество заказов тоже считать самим.  
* Добавить еще поле в базу `cashback-levels` и поставить колбек на завершение заказа. Негибко, зато явно быстрее, чем доделывать `user-statistics`.  

### Доставка информации о проценте для заказа в прайсинг
**Варианты**
1. Самое простое - теги. Прайсинг может проверять в преобразовании теги. Можно даже скидки не заводить. Ребята из тегов просили посчитать, сколько
2. Также ставим теги, но на них заводим скидки и в прайсинге проверяем скидки. В скидках есть механизм ограничение бюджета, но не факт, что он работает на кешбечные скидки. И менеджеры сказали, что им не нужен этот механизм.

## Итого процесс с учетом выбранных решений
1. Заводим АБ эксперимент `cashback_stairway_to_econom`. Делим всех юзеров в РФ на 3 группы: в одной 3%+, в другой 5%+, третья контрольная. В значении для тестовых групп будем держать описание лесенки. Например, вида [{'rides': 3, 'next_rides_percent: 3'}, {'rides': 5, 'next_rides_percent: 5'}].
2. Делаем правки в сервисе `user-statistics`, чтобы он мог дать нам число поездок по уиду за календарный месяц.  
Детали реализации в тикете https://st.yandex-team.ru/TAXIBACKEND-32866  
Кажется, пока планируется начать хранить статистику по дням. В течение дней 60, например.
3. Ставим таску `process_cashback_stairway` на завершение заказа. Ставим под экспериментом `cashback_stairway_to_econom`.  
Будем спрашивать у сервиса, учли ли они заказ, который мы обрабатываем и если нет, то переставляем таску на более позднее время.
4. В таске `process_cashback_stairway` смотрим, забираем лесенку из эксперимента. Если она пустая, то уходим, если нет - продолжаем.  
Дальше смотрим на `cashback_amount` из своей базы, ходим в `user-statistics` за количеством поездок, принимаем решение про тег и если нужно, то ставим. При постановке в том же запросе отбираем предыдущий.
5. Правим преобразование маркетингового кешбека и проверяем в нем теперь наши теги для получения процента. Учитывая немутабельность тамошних переменных, это будет копипаста вот этих строк на каждый тег
```js
if (tag == "5perc")
	let cashback_rate = 0.05;
	let cashback_price = *ride.price * cashback_rate;
	let floor_cashback_price = fix.rounding_factor * floor(cashback_price / fix.rounding_factor);
	emit("cashback_discount_fixed_value", floor_cashback_price);
	emit("cashback_rate", cashback_rate);
```
6. После запуска в декабре делаем балковость установок тега. Так договорились с ребятами из тегов. Как, пока не знаю, возможно придется таки заводить базу с текущим уровнем лесенки еще.

## Некоторые детали
1. В 00:00 каждого 1го число делать ничего не надо: теги ставятся с временем жизни до конца месяца, а `cashback_amount` обновится при следующей операции по кешбеку в новом месяце.
2. Считаем, что переход из тестовой группы в контрольную в течение месяца невозможен, поэтому процесс отбирания тега не предусматриваем вообще.
3. В крайнем случае мы в любой момент может отключить выдачу кешбека через правки преобразований.
4. Текущий уровень лесенки мы хранить пока не планируем. Пока необходимости в этом не видно.
5. У нас будет примерно 13кк юзеров(то есть тегов) и примерно 100кк заказов(то есть установок тегов).
6. Ребята из тегов окнули план: постепенно в течение месяца выдать 10кк тегов через сервис с рпс в 60.
