## Варианты решения
**Решили делать правильный вариант 4, мы поможем прайсингу с разработкой. Трюк с купоном за наш счет не делаем**
1. Перевыпустить price_before_coupon. Решает практически все проблемы, делается легко. Есть одно но - мы не можем нормально пересчитать мету для кейса, когда купон покрывает всю стоимость. Например, поездка стоила 700 рублей, а купон на 1000. Тогда преобразование кешбека обновит мету до 1000 и никак не может узнать, что было 700. Была попытка не обновлять мету, если в преобразование кешбека приходит 0 - но нельзя ставить выпуск меты под динамически изменяющимся условием.  
Тут только если прайсинг специально для нас сделает костыль: или даст возможность прочитать мету `price_before_coupon` в преобразовании, или сделает управляемое переопределение мет между преобразование.  
Можно забить на этот кейс: тогда для заказов с полным купоном мы исскуственно повысим стоимость фиксы до размера купона.  Судя по моим исследованиям в YT - примерно треть купонов тратится с полным покрытием стоимости заказа.  
И еще понадобится:
* Сделать макс(0+купон, старая цена) в тотве.
* Сделать (цена-купон) x cashback_rate в requestconfirm
2. Можно влезть везде в коде, где используется `price_before_coupon` и сделать там `price_before_coupon` - `cashback_fixed_price`. Нетрудно в целом, но костылёметр взорвался на таком варианте.
И все равно понадобится:
* Сделать макс(0+купон, старая цена) в тотве.
* Сделать (цена-купон) x cashback_rate в requestconfirm
3. В принципе, даже если не трогать `price_before_coupon`, то можно ограничиться пунктами:
* Сделать макс(0+купон, старая цена) в тотве.
* Сделать (цена-купон) x cashback_rate в requestconfirm  
* Дополнительно в requestconfirm вычесть стоимость кешбека из стоимости заказа
На саммари будет нормальная цена, правка в requestconfirm позволит нам нормально посчитать итоговую стоимость и кэшбек. Но водители получат меньше, чем им обещалось на экране заказа: покажем там поездка+кешбек, а дадим только за поездку.
4. Сделать правильно и это придется рано или поздно сделать. Дождаться апдейта таксометра до минимальной версии с прайсингом - уйдет необходимость в `price_before_coupon` - выпилить ее. Купон станет как скидка и штатно заработает. Только с округлением нужно будет разобраться, но это отдельная история.  
И в этом же варианте нужно обсудить, что мы будем с `pricing_data.user.total`.
5. Трюк. Выдавать юзерам с кешбечной подпиской на заказы с купоном кешбек за наш счет.
Я посчитал сумму денег, заплаченных юзерами: с карты, в поездках в России, с купоном, по тарифам, где мы даем кешбек, за октябрь. Получилось 3.5млн рублей. Я не отфильтровывал юзеров с плюсом, так как этого признака нет в заказе. Если супероптимистично считать что половина юзеров плюсовики и взять рейт в 10%, то мы потратим 175к в месяц. Кажется, немного.  
Можно использовать как временный вариант до реализации варианта 4.

**Мое мнение**  
Так как вариант 1 не сработал из-за ограничения при выпуске мет, то нужно делать сейчас 5 и начинать делать 4. Варианты 1-3 это все барахло под разными ракурсами.

Если эта задача не стоит того, чтобы для варианта 5 выделить на нее пусть 500к бюджета, то вряд ли она так важна.

## Этапы заказа(теоретически и на основе проверок в тестинге)
Это для кейса, когда мы можем перевыпустить price_before_coupon.
### Прайсинг
Можно посчитать нормально: 1000 - 500 -> 450+50. price_before_coupon нужно пересчитать в 950.  
Цена водителя будет 900. Но так как купон коменсируется значением, то водитель получит 450 из транзакции юзера + 500 купон, то есть 950. Чуть больше обычного, нужен ок Геши.

### routestats, offer
Должно заработать нормально на данных прайсинга

### ordercommit и current_prices
Должно заработать нормально на данных прайсинга

### current_prices на основе current_cost от таксометра
Умеют считать кешбек, судя по тестингу - работает.

### антифрод
Он уже на current_prices, а они нормальные.

### taxiontheway в поездке
На эту цену особо никто не смотрит, но она нормальная: общая сумма для юзера и текст про купон.
Пример есть в [заказе 5](#order_5)

### requestconfirm
Перекладывать фиксу кешбека как обычно. При поездке по таксометру нужно в расчете вычесть купон. 

### taxiontheway в конце
Все нормально, кроме кейса, когда купон покрывает всю стоимость поездки. Иначе получается как в [заказе 7](#order_7)
Тут нам нужна правка в totw.  
И в целом про последний тотв - в нем показывается стоимость до вычета купона.  
<img src="https://jing.yandex-team.ru/files/aliev-r/totw_coupon_part.jpg" alt="drawing" width="180"/>  
Неважно, кешбечный заказ или нет. То есть, даже если прайсинг выпилит `price_before_coupon`, нужен будет какой-то ее аналог для показа юзеру.  
Кажется, мету с ценой до купона придется оставить, возможно, переименовав. Причем ее получать нужно будет и от таксометра, по-хорошему. Это нужно обсудить с Иоанном.  
И нам в current_prices понадобится поле с ценой до купона. Это нужно обсудить с Даней.  
current_prices нужно сделать сейчас и эта правка пригодится потом, когда прайсинг будет выпиливать купонные костыли. Но кешбек на купоны можно включить и раньше, если решим, что кейс купоном на полную стоимость не страшен. Это нужно обсудить с Гешей.  

### update_transactions
Отношения order.cost-купон-payment_tech.sum_to_pay.ride мы не трогаем.

### debts-processing
Сумму долга сервис debts получает из invoice/retrieve. Там уже купона нет.

### DWH
Надо разобраться, что там при купоне. Но в целом кажется, что раз мы не лезем в отношения order.cost-купон-payment_tech.sum_to_pay, то все должно быть ок.

## Поездки в тестинге с flat купоном
### Заказ 1 - обычная фикса - 686d42625ba412ea94738a8a3cd5a9c0

Расчет:
* цена, price_before_coupon - 577  
* после купона - 377  
* кешбек - 38  
* после кешбека - 340 + 38=378(плюс рубль)  

Заказ:
* routestats показывает 378, зачеркнутую 577  
* ordercommit пишет c_p 378
* в таксометр едет 577 и купон 200
* в order_info.cc от таксометра приходит 577
* current_prices считает (577-200)x0,1111 = 42 и сумма 419
* В requestconfirm таксометр присылает 577
* requestconfirm считает cost 577 и берет фиксу кешбека 38
* current_prices внутри requestconfirm считает 577-200+38=415
* order.cost 577 и order.cashback_cost 38. 
* sum_to_pay 377 и 38

**Итог**
Все криво.

### Заказ 2 после патча price_before_coupon - обычная фикса - 944d3e23ee3c3782bd02d98fc2198c39 {#mht}

Расчет:
* цена, price_before_coupon - 722 
* после купона - 622
* кешбек - 63
* после кешбека - 560 + 63=623(плюс рубль), обновили price_before_coupon - 560+100=660

Заказ:
* routestats показывает 623, зачеркнутую 722
* ordercommit пишет c_p 623
* в таксометр едет 660 и купон 100
* в order_info.cc от таксометра приходит 660
* current_prices считает (660-100)x0,1111 = 63 и сумма 623
* totw показывает 623
* В requestconfirm таксометр присылает 660
* requestconfirm считает cost 660 и берет фиксу кешбека 63
* current_prices внутри requestconfirm считает 660-100+63=623
* order.cost 660 и order.cashback_cost 63. 
* последний тотв 623. Поездка 723, промокод 100, кешбек 63.
* sum_to_pay 560 и 63

**Итог**
560 поездка, 63 кешбек, всего 623. Все ок.

### Заказ 3 после патча price_before_coupon - сброс на кеш, купон только на карту - d96c93fdf232160585bc34f92b646011
Расчет:
* цена, price_before_coupon - 1334 
* после купона 1234
* кешбек - 124
* после кешбека - 1111+124=1235(плюс рубль), обновили price_before_coupon - 1111+100=1211

Заказ:
* routestats показывает 1235(1111+124), зачеркнутую 1334
* после сброса на кеш тотв показывал 1235, потом 1111
* CVV в конце заказа просит на 1211
* последний тотв 1211
* в c_p 1211, в cost.breakdown 1111. Кешбека в этот раз нет.
* order.cost 1211, order.cashback_cost нет

**Итог**
* Юзер получил скидку в сумму кешбека 1334-124=1211 с проблемами округления. Вроде норм.
* У нас кривой order.current_prices.cost.breakdown, но кажется, что он ни на что не влияет.
* Купон сбросился


### Заказ 4 после патча price_before_coupon - сброс на кеш, купон и на кеш и на карту(половина купонов такие, другая - только карта) - bdede9a9548d154aa06811e79f4a19cb
Расчет:
* цена, price_before_coupon - 1271 
* после купона - 1171
* кешбек - 118
* после кешбека - 1054+118=1172(плюс рубль), обновили price_before_coupon - 1054+100=1154

Заказ:
* routestats показывает 1172(1054+118), зачеркнутую 1271
* current_prices после сброса, kind taximeter - 1054
* последний тотв 1054 (1154-100), кешбека нет
* current_prices 1054, kind final_cost

**Итог**
Юзер получил скидку в сумму кешбека 118 и использовал купон на 100: 1271 - 118 - 100 = 1054 с проблемами округления. Вроде норм.

### Заказ 5 после патча price_before_coupon и rounding_artefact - без точки Б - 1bdb69d3dbfb1125bbfd8e097adc2d59


Расчет:
* цена, price_before_coupon - 398 
* после купона 298 - 298
* кешбек - 29
* после кешбека - 269+29=298, обновили price_before_coupon - 369

Заказ:
* routestats показывает 298, зачеркнутую 398, кешбек 29
* current_prices в процессе поездки
```js
{
  "cashback_price": 29,
  "kind": "prediction",
  "user_ride_display_price": 298,
  "user_total_display_price": 298,
  "user_total_price": 298,
  "cost_breakdown": [
    {
      "amount": 298,
      "type": "card"
    }
  ]
}  
```
<a name="order_5"></a>
* ![И тотв в процессе поездки](https://jing.yandex-team.ru/files/aliev-r/totw_screen.jpg)
* Последний requestconfirm прислал "extra": "2241.937520",
* Последний тотв 2392 (2492-100), кешбек 250.
* current_prices в конце
```js
{
  "cashback_price": 250,
  "kind": "final_cost",
  "user_ride_display_price": 2391.94,
  "user_total_display_price": 2391.94,
  "user_total_price": 2391.94,
  "cost_breakdown": [
    {
      "amount": 298,
      "type": "card"
    }
  ]
} 
```
* В payment_tech 2141.94 за поездку и 250 за кешбек. 
**Итог**
Неправильно посчитали кешбек: посчитали на сумму до вычета купона. Нужно патчить наш код в requestonfirm. 
Откуда-то взялось неровное число, причем от таксометра. Не выглядит нашей проблемой.

### Заказ 6 после патча price_before_coupon и rounding_artefact - вырожденный случай с купоном на всю стоимость) - 68d91b3ac19021dba3e0fd121cb8dd6c
Коротко - переписали price_before_coupon в 1000 и огребли проблем.

### Заказ 7 после патча price_before_coupon и rounding_artefact и нуля - вырожденный случай с купоном на всю стоимость) - 11d963333ad0594bb794410ae651075e
Расчет:
* цена, price_before_coupon - 654 
* после купона 0
* кешбек - 0
* после кешбека - 0, не трогали price_before_coupon - 654

Заказ:
* routestats показывает 0, зачеркнутую 654
* price_before_coupon 654, rounding_artefact 0
* последний тотв 0(1000-1000), кешбека нет
<a name="order_7"></a>
<img src="https://jing.yandex-team.ru/files/aliev-r/totw_full_coupon.jpg" alt="drawing" width="180"/>
* current_prices в конце
{
  "cashback_price": 0,
  "kind": "final_cost",
  "user_ride_display_price": 0,
  "user_total_display_price": 0,
  "user_total_price": 0,
  "cost_breakdown": [
    {
      "amount": 0,
      "type": "card"
    }
  ]
} 
* order.cost 654
* payment_tech нули

**Итог**  
Некрасиво получается в конце.  Нужно сделать макс(0+купон, старая цена) в тотве.

