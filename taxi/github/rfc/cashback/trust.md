# Перевод начисления кэшбэка на transactions

## Задача
https://st.yandex-team.ru/TAXIPROJECTS-1629
Баланс хочет уметь работать только с выгрузкой из Траста, поэтому все операции пополнения и списания нужно перевести на Траст.  
В нашей инфраструктуре с Трастом работает сервис transactions, поэтому операции пополнения кэшбэка переезжают в него.

### API Transactions для пополнения кошелька
В отличие от billing-wallet, пополнение кошелька через transactions будет асинхронным:
1. Создать операцию пополнения
2. Поллить статус

Второе отличие в том, что вместо дельты кэшбэка, которую нужно начислить или списать, в transactions нужно будет передавать целевую сумму кэшбэка.
Transactions работает с корзинами траста и понимает, какую корзину нужно создать или рефанднуть, чтобы прийти к нужной величине кэшбэка.

Точной спецификации API ещё нет.

### Изменения во флоу кэшбэка
Упрощённо, флоу кэшбэка выглядит так:

- `universal_cashback_processing` получает инвойс из `transactions` и коэффициенты кэшбэка из `order_rates`
- `universal_cashback_processing` рассчитывает размер кэшбэка на основе инвойса и коэффициентов и отправляет его в ручку `register/cashback`  
- `register/cashback` проверяет в таблице `order_clears`, какой клир и какой кэшбэк мы уже регистрировали.  
- Из старого и нового значений кэшбэка получается дельта кэшбэка, которую нужно снять с кошелька или начислить на кошелёк.
- Эта дельта сохраняется в таблице `events`.  
- Если у заказа появились новые ивенты, то запускается STQ `cashback_charge_processing`.  
- `cashback_charge_processing` для каждого ивента делает запрос в ручку `v2/charge` с размером списания/начисления.

С переходом на `transactions` нам больше не нужно будет считать дельты самим. Достаточно отправить в `transactions` требуемый размер кэшбэка по заказу.
Флоу кэшбэка становится таким:

- `universal_cashback_processing` получает инвойс из `transactions` и коэффициенты кэшбэка из `order_rates`.
В инвойсе теперь лежит ещё и уже начисленный кэшбэк.
- `universal_cashback_processing` рассчитывает размер кэшбэка на основе инвойса и коэффициентов и отправляет его в ручку `register/cashback`
- `register/cashback` обновляет значение клира в базе и ставит таску `cashback_charge_processing`
- `cashback_charge_processing` получает инвойс по id заказа и сравнивает значение рассчитанного кэшбэка из order_clears с кэшбэком в инвойсе
  - если новый размер кэшбэка не совпадает с размером в инвойсе или инвойс зафейлился, то инвойс обновляется через API transactions
  - если инвойс ещё не обработался, таска перепланируется
  - если инвойс в терминальном статусе, таска завершает работу

### Изменения в сервисах
#### personal-wallet
- Ручка v2/charge перестаёт использоваться  
- Пуш об обновлении баланса и обновление кэша балансов должны уехать в отдельную очередь, когда будет сделана задача https://st.yandex-team.ru/TAXIBILLING-3192

#### cashback
- Очередь `cashback_charge_processing` начинает работать с order_clears и transactions вместо events и billing-wallet
- Таблица `events` перестаёт использоваться
- Изменения в /register/cashback:
  не записываем ивенты, только обновляем значение кэшбэка
  всегда возвращаем need_processing: True

### Скоуп задач
Для запуска нужно:
1. Не записывать events в /cashback/register
1. Обновлять invoice в `cashback_charge_processing`
2. Добиться от биллинга коллбэка об изменении баланса https://st.yandex-team.ru/TAXIBILLING-3192
3. Перенести обновление кэша балансов на коллбэк от биллинга
3. Перенести клиентский сайлент-пуш на коллбэк от биллинга
