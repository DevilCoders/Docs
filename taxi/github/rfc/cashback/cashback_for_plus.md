# Выплата кэшбэка за подписку на Плюс
## Продуктовые требования
### Кэшбэк вместо скидки
За поездки с Плюсом должны начисляться 10% кэшбэка вместо 10% скидки.
Стоимость поездки для водителя уменьшается на размер кэшбэка.
Стоимость поездки для пассажира остаётся прежней, но в ней появляется детализация — 90% средств уходит в парк, а 10% — владельцу подписки, в нашем случае Медиасервисам.
Оба списания должны находиться в одном чеке.


|                | Стоимость поездки | Платит пассажир        | Получает водитель |
|----------------|-------------------|------------------------|-------------------|
| Скидка за Плюс | 1000              | 900                    | 900               |
| Кэшбэк за Плюс | 1000              | 900+100 (в одном чеке) | 900               |

### Кэшбэк за кэш
В поездке за кэш у нас нет возможности забрать у пользователя 10% средств в пользу Медиасервисов, поэтому сейчас мы не рассматриваем начисление кэшбэка за такие поездки.

## Реализация
### Списания в пользу Медиасервисов
Чтобы списания за поездку и за кэшбэк были в одном чеке, нужно в корзину Траста добавить два заказа с разными агентами.
Это будет реализовано в `update_transactions` после переезда `update_transactions` на `transactions`
`update_transactions` будет формировать инвойс в сервисе транзакций через `invoice/create` и `invoice/update`:
```json
{
  "id": "<order_id>",
  "operation_id": "<operation id>",
  "version": 0,
  "originator": "processing",
  "payments": [
    {
      "type": "card",
      "method": "string",
      "billing_id": "string"
    }
  ],
  "items_by_payment_type": [
    {
      "payment_type": "card",
      "items": [
        {
          "item_id": "ride",
          "product_id": "<id продукта поездки>",
          "amount": "900"
        },
        {
          "item_id": "cashback",
          "product_id": "<id продукта кэшбэка>",
          "amount": "100"
        }
      ]
    }
  ],
  "need_cvn": true,
  "user_ip": "string",
  "yandex_uid": "string"
}
```
`update_transactions` нужно знать величину кэшбэка для отправки его в инвойсе.
Величина кэшбэка будет вычисляться в `update_transactions` на основе price_modifier, о котором дальше.
id продукта кэшбэка будет лежать в конфиге.

### Разная стоимость поездки для водителя и пассажира
Стоимость поездки для пассажира должна остаться неизменной, а для водителя она уменьшится. Это означает, что нужно поддержать уменьшение стоимости поездки для водителя.  
При уменьшении стоимости поездки для водителя возникают вопросы:
1. Что делать при сбросе на кэш?  
Уменьшаем стоимость поездки для пользователя — пользователь платит водителю 900 р.
У пользователя в интерфейсе остаётся старая цена, потому что непонятно, как изменить фиксу в процессе поездки.

2. Что делать в поездках по таксометру?
Таксометр считает стоимость поездки в зависимости от тарифа, который был отправлен в setcar. Нужно уметь отправлять в setcar тариф с пониженным коэффициентом для водителя.


### Новый price_modifier
```yaml
{
    "is_enabled": true,  
    "type": "cashback",
    "reason": "ya_plus_cashback",  # Тип скидки
    "value": "0.1",   # Значение кэшбэка
    "classes": ["comfort"],  # Тариф
    "pay_subventions": true  # Выплачивать субсидии за скидки
}
```
При обработке заказа с таким модификатором стоимость поездки для водителя должна уменьшиться, а для пользователя остаться прежней. В момент оплаты заказа в чек должен попасть продукт "кэшбэк".

Почему новый тип модификатора, а не multiplier с дополнительным полем?  
По логике работы этот модификатор отличается от обычного мультипликатора:
1. Он влияет только на стоимость заказа для водителя.
2. Он добавляет новую позицию в чек.

Также, multiplier с дополнительным полем пришлось бы поддержать в 
- [_compose_price_modifiers](https://github.yandex-team.ru/taxi/backend/blob/0d2f3cb5829721bff1b519bf566172d0c989eb3d/taxi/taxi_protocol/protocol_1x/producers.py#L1428). — не учитывать в пользовательском тарифе
- [get_discount_multiplier](https://github.yandex-team.ru/taxi/backend/blob/de4d396e90c0874a8257de733c93c793313bb32a/taxi/internal/order_kit/multipliers.py#L84) — не учитывать как скидочный мультипликатор


Новый тип price_modifier придётся поддерживать только в [get_discount_multiplier](https://github.yandex-team.ru/taxi/backend/blob/de4d396e90c0874a8257de733c93c793313bb32a/taxi/internal/order_kit/multipliers.py#L84), на скидочный мультипликатор он не будет влиять (и не должен)

### Отображение кэшбэка за Плюс на саммари
В routestats нужно будет по эксперименту cashback_for_plus по-новому считать цену для пользователя с учётом нового модификатора и добавлять кэшбэк в брендинг.
Кэшбэк по скидке и по модификатору должен складываться.
### Запись разной фиксы для водителя и пассажира в оффер
В оффер должна попасть разная фикса для водителя и пассажира.
```yaml
{
  "_id": "<offer id>",
  ...
  "prices": [
    {
      "cls": "econom",  # категория без модификатора
      "driver_price": 500,
      "price": 500,
      ...
    },
    {
      "cls": "comfort",   # категория с модификатором
      "driver_price": 900,
      "price": 1000,
      ...
    }
  ],
  "price_modifiers": {
    "items": [
      {
        "reason": "ya_plus_cashback",
        "value": 0.1,
        "type": "cashback",
        ...
      }
    ]
  }
}
```

Кроме этого в order_proc должна попасть галочка `is_cashback`, как для всех кэшбэчных заказов.

В дальнейшем нужно поддержать это в integration api, чтобы за заказы через Алису и Поисковое Приложение Яндекса тоже начислялся кэшбэк за плюс.

### Запись is_cashback в order_proc для заказов с модификатором
В ordercommit нужно записывать is_cashback для заказов с кэшбэчным модификатором аналогично тому, как это делается сейчас для кэшбэчной скидки

### Отправка разной фиксы в setcar
В setcar нужно отправить разную стоимость поездки для водителя и пассажира, при этом не показывать водителю стоимость пассажира.
При условии, что в оффер запишется разная цена, это будет работать автоматически.
### Отправка разных тарифов в setcar
В setcar нужно отправить тариф с учётом понижающего коэффициента для кэшбэка
Для этого в setcar_sender нужно сделать поддержку нового price_modifier.
Мультипликаторы тарифа считаются в функции [_compose_price_modifiers](https://github.yandex-team.ru/taxi/backend/blob/0d2f3cb5829721bff1b519bf566172d0c989eb3d/taxi/taxi_protocol/protocol_1x/producers.py#L1428).

### Учёт при корректировке цены диспетчером
При корректировке стоимости поездки диспетчером стоимость заказа для пользователя должна быть увеличена на размер кэшбэка.
Нужно поддержать это [здесь](https://github.yandex-team.ru/taxi/backend/blob/b740db3d48e5a65864b5f8dc6baa43e4003798b6/taxi/internal/order_kit/invoice_handler.py#L447)


### Поддержка в сервисе кэшбэка
Изменяется схема хранения коэффициентов кэшбэка в поле rates таблицы order_rates
Было:
```json
{
  "by_classes": [
    {
      "class": "econom",
      "value": 0.2,
    },
    {
      "class": "business",
      "value": 0.2,
    },
    {
      "class": "comfortplus",
      "value": 0.2,
    }
  ]
}
```
Станет
```json
{
  "by_classes": [
    {
      "class": "econom",
      "value": 0.2,
    },
    {
      "class": "business",
      "value": 0.2,
      "additional_service_value": 0.1,
    },
    {
      "class": "comfortplus",
      "value": 0.2,
      "additional_service_value": 0.1,
    }
  ]
}
```

В `rates_processing` нужно учитывать модификаторы с типом `cashback` и класть сумму их коэффициентов в каждый тариф.

В ручке `cashback/v1/calc` нужно учитывать поле `additional_service_value` при расчёте кэшбэка

### Раскатка
price_modifier раскатывается по странам.
Поддержка price_modifier раскатывается экспериментом 3.0 `cashback_for_plus` в routestats и ordercommit 

## Этапы:
0. Запуск кэшбэка за Плюс без продажи второй услуги (за счёт Такси)
- Давать кэшбэчную скидку подписчикам Плюса
- Игнорировать модификатор Плюса в routestats по эксперименту cashback_for_plus
- Игнорировать модификатор Плюса в ordercommit по эксперименту cashback_for_plus
1. Продажа второй услуги
Продуктовые задачи:
Правки в протоколе:
- Поддержать новый модификатор в калькуляторе
- Поддержать новый модификатор в брендинге роутстатс
- Записывать is_cashback в order_proc с модификатором в ordercommit
Правки в py2:
- Поддержать модификатор в processing в формировании setcar
- Поддержать новый модификатор в ручной установке цены диспетчером
- Рассчитывать в update_transactions величину кэшбэка и отправлять её в transactions
Правки в сервисе кэшбэка:
- Поддержать запись величины модификатора в rates_processing
- Поддержать коэффициент доп.услуги в расчёте кэшбэка в `cashback/v1/calc` 

Правки в админках:
- Поддержать новый модификатор в админке заказов
- Поддержать новый модификатор в админке скидок
Задачи биллинга:
Правки в transactions:
- Поддержать списания в пользу разных агентов в transactions
Правки в py2:
- Перевести update_transactions на сервис transactions


2. Доработки
- Поддержка кэшбэка за Плюс в Алисе и Поисковом приложении Яндекса
- Переход на новый прайсинг
- Антифрод намеренного сброса на кэш ради скидки 
