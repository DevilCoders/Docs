# Кэшбэк

## Описание
В Яндекс.Такси сейчас реализован механизм скидок. 

[Ссылка в админку.](https://tariff-editor.taxi.yandex-team.ru/discounts/user)
Скидки можно настраивать по зонам, по размеру и т.п.

Проблема в том, что давать скидку в виде уменьшения стоимости за поездку для Я.Такси очень дорого, так как пользователей миллионы.
Удобнее давать скидку в виде кешбека, когда юзер сначала заплатит полную стоимость поездки, а потом на внутренний счет упадут деньги.

## Реализация
[Дизайн](https://www.figma.com/file/eY5J1JznYJKgX4plN0fmG4q1/Плюс%3A-валюта-и-подписка?node-id=2531%3A0)
![Архитектура](/cashback/img/arch.png)

Введение кешбека в цикл заказа подразумевает правки в следующих местах:
- Попадание юзера в кешбек
- Процессинг заказа за кешбек
- Начисление денег на внутренний счет
- Информация о текущем состоянии кошелька

---

### Попадание юзера в кешбек
Планируется реализовать кешбек на движке сервиса скидок.
Это подразумевает правки в:
1. Сервисе скидок
2. Routestats
3. Ordercommit


Подробнее по каждый пункт:

#### Сервис скидок
- Необходимо добавить в модель скидки поле `is_cashback: bool` и настраивать его через админку.
- Необходимо добавить в ответ ручки скидок для пользователя `is_cashback: bool`.

#### Routestats
_Примечание: Подразумевается добавление плагина в routestats_

**Схема работы routestats:**
- Проверить доступен ли для юзера кешбек (есть ли у него кошелек).
- Отправить в сервис скидок `support: ["cashback"]`
- распарсить `is_cashback: bool` и обработать его.
- Если `is_cashback: false` -- работаем как раньше
- Если `is_cashback: true`:
    - Не учитывать в цене эту скидку.
    - Вернуть интерфейсное поле для карточки тарифа
    - Сохранить в оффер информацию о кешбеке

    Примерное дополнение ответа routestats:
    ```json
    {
     "cashback": {
       "value": "100",
       "description": "Dicsount 100 $SIGN$$CURRENCY$ in wallet"
     }
    }
    ```

#### Ordercommit
_Примечание: Подразумевается добавление плагина в ordercommit_

Скидки компенсируются биллингом. Но кешбек это не обычная скидка -- кешбек не влияет на цену, а значит и компенсировать
ничего не надо. Чтобы не ломать старый флоу для нового типа скидок, такую скидку в order_proc сохранять не будем.
Однако при этом необходимо где-то запомнить информацию о кешбеке из оффера. Для этого есть два варианта:
- Сохранить в order_proc поле cashback
- Сходить в ручку нового сервиса cashback и зарегистрировать коэффициенты за заказом. (Предпочтительный).

Разберем второй способ.

**Схема работы ordercommit:**
1. Достать скидку из оффера
2. Если `is_cashback: false` -- работает по-старому
3. Если `is_cashback: true` 
    - не записываем поле `discount` в order_proc
    - записываем флаг `is_cashback: true` в order_proc
    - ставим таск `cashback_coeffs_processing`, `task_id=order_id, args=(order_id, coeffs/offer_id)`

---
### Процессинг заказа за кешбек
За успешно завершенный заказ пользователю должны быть начислены деньги на внутренний счет
Вопрос -- что считать успешно завершенным заказом. Ведь сам факт завершения поездки еще не означает
списание денег с пользовательской карты. Также стоит помнить, что цена за поездку может измениться во время поездки.
Все это значит, что нас интересует именно успешная транзакция пользовательского платежа -- то есть `clear`.

- За каждую заклиренную транзакцию необходимо начислить кешбек.
- За каждый заклиренный рефанд кешбек необходимо снять.

В рамках существующего процессинга предлагается следующий план работ:
- Обработка клира в update_transactions
- Нотификация во время поездки

#### Обработка клира в update_transactions
В `update_transactions` необходимо обрабатывать каждую заклиренную транзакцию/рефанд и
процессить кешбек.

**Схема работы**:
- Проверить что `is_cashback: true` в order_proc
- Поставить таск `cashback_processing`, `task_id=order_id, args=(order_id,)`

#### Нотификация во время поездки
На статусе transporting необходимо уведомить пользователя о том, что текущий заказ будет за кешбек.

В MVP предлагается запихнуть нотификацию в ответ `taxiontheway.notifications`
**Однако, конечно, taxiontheway лучше не править, поэтому это место следует продумать еще тщательней!**

---
### Начисление денег на внутренний счет
Из update_transactions будет ставиться таск на каждый успешный клир. Необходимо обратывать эту сумму и начислять деньги
когда нужно.

План работ:
- stq таск `cashback_coeffs_processing`
- stq таск `cashback_processing`
- stq таск `cashback_charge_processing`
- Сервис кешбеков

#### stq таск `cashback_coeffs_processing`
Таск `cashback_coeffs_processing` должен записать коэффициенты в базу.

**Схема работы**:
- Понять коэффициенты для заказа
- Сходить в ручку `internal/order/coeffs/register`

#### stq таск `cashback_processing`
Таск `cashback_processing` должен начислить кешбек пользователю.

**Схема работы**:
- Проверить, что для данного заказа есть коэффициенты, иначе перепланировать себя
- Проверить, что данный заказ за кешбек через ручку `/internal/order/coeffs/info`.
- Сходить в `invoice/retrieve` сервиса транзакций за суммой текущего клира
- Сходить в ручку `internal/cashback/register_clear` чтобы зарегистрировать текущую известную сумму клира
- Если клир не был зарегистрирован (сумма не изменилась, нечего процессить) -- ничего не делать
- Если клир зарегистрирован и нужно запроцессить -- ставится таск`cashback_charge_processing`, `task_id=order_id, args=(order_id,)`

#### stq таск `cashback_charge_processing`
Таск `cashback_charge_processing` занимается непосредственно начислением кешбека на внутренний кошелек или в 
любое другое место.

**Схема работы**:
1. Сходить в ручку `internal/cashback/events` для получения необработанных событий начисления
2. Для каждого события:
 - сходить в personal_wallet в ручку charge и либо добавить сумму либо снять.
 - поменить событие исполненным

#### Сервис кешбеков
Новый сервис который будет хранить инфомацию о кешбеках по заказам.

Для работы процессинга кешбека подразумевается 3 ручки.
- /internal/order/coeffs/register
- /internal/order/coeffs/info
- /internal/order/register
- /internal/order/events/
- /internal/order/events/processed

Более подробно про каджую ручку:

##### /internal/order/coeffs/register
Примерный протокол `/internal/order/coeffs/register?order_id=<order_id>`
  
Запрос
```json
{
 "cashback": {
   "coeff": 0.1
 }
}

```

**Идемпотентность**:
По order_id

**Схема работы**:
- Зарегистрировать в БД коэффициент кешбека за данным заказом

##### /internal/order/coeffs/info
Примерный протокол `/internal/order/coeffs/info?order_id=<order_id>`
  
Ответ
```json
{
 "cashback": {
   "coeff": 0.1
 }
}

```

**Схема работы**:
- Получить информацию о коэффициентах для заказа из локальной базы

##### /internal/order/register
Примерный протокол `/internal/order/register?order_id=<order_id>`
  
Запрос
```json
{
 "cleared": {
   "value": 231.43,
   "currency": "RUB"
 }
}

```

Ответ:
```json
{
  "status": "need_processing|not_registered"
}

```
   
**Идемпотентность**:
По order_id
 
**Схема работы**:
- Достать из базы последнюю известную сумму клира
- Проверить отличается ли она от текущей суммы
- В рамках одной транзакции:
    - Обновляем текущую сумму клира
    - Добавляем событие начисления кешбека:
  
  _Например_:
  
  Текущая сумма клира: 100
  В ручку пришла сумма: 150
  
  Дифф = 150 - 100 = +50
  Надо начислить кешбек от этой суммы.
  Достаем коэффициент, считаем сумму и добавляем событие начисление кешбека в БД типа
  
  ```json
  {
    "type": "charge|withdraw",
    "status": "new",
    "order_id": "<order_id>",
    "value": 5,
    "currency": "RUB"
  }
  ```
- Посмотреть есть ли в базе необработанные события и вернуть статус

##### /internal/order/events
Примерный протокол `internal/order/events?order_id=<order_id>`
  
Ответ:
```json
{
  "events": [
    {   
        "id": "event_id",
        "type": "charge|withdraw",
        "order_id": "<order_id>",
        "value": 5,
        "currency": "RUB"
    }
  ] 
}

```
**Схема работы**:
- Достать из БД события со статусом new

##### /internal/order/events/processed
Примерный протокол `internal/order/events/processed?order_id=<order_id>`
  
Запрос:
```json
{
  "event_id": "event_id"
}

```
**Идемпотентность**:
По event_id

**Схема работы**:
- Пометить event выполненным

---
### Информация о текущем состоянии кошелька
Пользователь должен видеть текущее состояние своего кошелька, а также историю его пополнения и списаний.
Продуктовое рабочее название пункта меню - Плюс. Предполагается раскостыливание ручки payment_methods на api-proxy.

Итого: 
- Необходимо поддержать в api-proxy информацию о личном счете (раскостылить payment_methods).

### Предполагаемая нагрузка

Сервис cashbacks - 100rps

---
### Схема БД сервиса кешбеков

_Подразумевается, что хранилище postgres. Для удобства чтения все примеры в json_

#### Таблица cashback.order_cashbacks
```json
{
 "order_id": "<order_id>",
 "coeffs": "json-b",
 "created": "date-time"
}
```

#### Таблица cashback.order_clears
```json
{
 "order_id": "<order_id>",
 "value": "455",
 "currency": "RUB",
 "created": "date-time",
 "updated": "date-time"
}
```

#### Таблица cashback.order_events
```json
{
 "id": "uuid",
 "order_id": "<order_id>",
 
 "type": "charge|withdraw",
 "status": "new|processed",
 
 "value": "5",
 "currency": "RUB",
 
 "created": "date-time",
 "updated": "date-time"
}
```

---
### Предварительная оценка по времени
+ [4d] Раскостылить paymentmethods
+ [2d] Правки в routestats
+ [2d] Правки в ordercommit
+ [1d] Правки в сервисе скидок


+ [2d] Правки в update_transactions
+ [2d] Очередь cashback_coeffs_processing
+ [2d] Очередь cashback_processing
+ [2d] Очередь cashback_finish_processing


+ [2d] Регистрация события
+ [1d] Список событий
+ [1d] Завершение события
+ [2d] Коэффициенты


+ [2d] Правки в personal_wallet

+ [2d] Продуктовые метрики solomon
+ [4d] Запуск в проде
Итого: 31d
