### Архитектурное описание сервиса - fleet-payment-systems

### Название сервиса
fleet-payment-systems

### Какую продуктовую проблему решает сервис?
Интеграция парка с платежными системами

### Почему нельзя решить эту задачу без разработки нового сервиса существующими решениями?
Существующее решение находится в шарпах, которые мы не поддерживаем.
У бизнеса в планах добавлять новые интеграции и развивать инструмент в других странах.

### Как именно сервис будет решать поставленные перед ним задачи?
Внутренний сервис fleet-payment-systems (для диспетчерской и Про):
- Хранение и шифрование авторизационных данных платежных систем парков (для qiwi аккаунтов)
- CRUD кошельков платежных систем в диспетчерской
- Просмотр и выгрузка списка транзакций

Безопасность хранения авторизационных данных аккаунтов будет обеспечиваться шифрованием.
Аналогичное используется в contractor-instant-payouts.

Внешний сервис fleet-payment-systems-api (API для платежных систем):
- Предоставление внешнего API для коллбэков платёжных систем (интеграция)

Авторизация платежных систем - сгенерированная ссылка
Для генерации ссылки будет переиспользован сервис api ключей.

Сгенерированная ссылка:
- генерим ссылку по аналогии с api ключом - показываем один раз при создании
- парк указывает эту ссылку в ЛК ПС

Парк может в любой момент отозвать и перегенерировать ссылку - функциональность аналогичная api-ключам.

Во внешнем сервисе fleet-payment-systems-api будут ручки для платежных систем, доступные снаружи.
У каждой платежной системы свой контракт, поэтому для каждой платежной системы будет своя ссылка.

Часть платежных систем (киви, пейстек) умеет работать через веб-интерфейс.
Для них есть возможность пополнять баланс водителя через ПРО.

Форматы данных ПС:
- UzPaynet - xml (SOAP)
- Elecsnet - запрос с параметрами
- TellCell - запрос с параметрами, на выходе xml
- City24 - xml
- TBC - запрос с параметрами, на выходе xml
- Easypay - запрос с параметрами, на выходе xml
- Mobilnik - запрос с параметрами, на выходе xml
- Paystack - json
- Qiwi qvp - запрос с параметрами, на выходе xml
- qiwi_md - запрос с параметрами, на выходе xml
- idram - запрос с параметрами, на выходе xml
- qiwi - xml

### Разрабатывается один сервис или система?
Система сервисов

### Сколько и какие сервисы содержит система?
- fleet-payment-systems - внутренний сервис, ручки для ПРО и диспетчерской
- fleet-payment-systems-api - внешний сервис, ручки для платежных систем для проверки наличия водителя в парке и изменения его баланса (callback)

### Сервис внутренний или внешний?
fleet-payment-systems - внутренний
fleet-payment-systems-api - внешний 

### С кем взаимодействует сервис?
- Диспетчерская - для CRUD аккаунтов и выгрузки отчетности
- ПРО - для инициализации платежа со стороны водителя
- Биллинг - для изменения баланса водителя
- fleet-transactions-api - для создания транзакций
- Внешние сервисы платежных систем - для создания платежа и получения статуса
- STQ - для операций с платежными системами
- uapi-keys - для генерации ссылок

### Какие базы использует?
- redis: текущие данные кошельков
- taximeter_db_misc: таблица с транзакциями
- своя база для кошельков (перенесем из редиса)

### Какие периодические процессы?
QIWI аккаунты требуют авторизационный токен, который выписывается на год.
Каждый год токен нужно перевыпускать.
Периодик таска будет находить аккаунты, у которых скоро просрочатся токены, и оповещать парки по email.
В идеале перевыпускать токен в автоматическом режиме.
Также QIWI не использует callback-ручки - нужно периодически запрашивать статусы платежей и обрабатывать их.
Но это можно будет сделать через stq - при нажатии водителем кнопки "Выставить счет" запускается таска с определенным ttl, котороая поллит статус выплаты.

### Планируется обработка персональных данных
Нет

### Какие данные и по какой схеме сервис будет хранить в базе?
Данные о кошельках лежат в redis по ключу PaySystem:Items:{park_id}

План переезда кошельков из редиса в pg:
1 Ручка чтения берет данные из redis, ручка записи пишет в redis и pg
2 Пишем в шарпах клиент, чтобы они ходили не в бд, а в ручку
3 Переносим данные из шарпов в пг
4 Переводим новый сервис с шарпов на пг

Таблица transactions лежит в taximeter_db_misc_shard0 и разделена на 128 частей
Требуется для просмотра списка транзакций, а также для периодики опроса платежей qiwi
У транзакции есть 3 состояния
- принята
- обработана
- отклонена
Периодика киви обрабатывает принятые транзакции и отклоняет обработанные
Прорабатывается перенос транзакций в биллинг - создавать там, брать оттуда же

### Какой объем данных будет храниться и какой объем будет изменяться в единицу времени?
В рамках MVP изменений не предвидится

### Какие операции над данными заложены?
чтение и запись

### Есть ли какой-то стейт в памяти, как он обновляется и валидируется?
нет

### Какая нагрузка ожидается?
Не более 10 rps

### Какие фолбеки предусмотрены на сам этот сервис?
нет

### Какие фолбеки предусмотрены внутри этого сервиса на взаимодействие с другими сервисами?
В случае падения биллинга stq будет ретраить, пока операция не выполнится

### Какие возможности масштабируемости закладываются?
Горизонтальное масштабирование

### Какие точки отказа есть в сервисе?
- БД
- Внешние сервисы
- Биллинг
- fleet-transactions-api
- STQ

### Укажите ключевые продуктовые метрики сервиса, за которыми планируете следить
- Количество транзакций
- Распределение платежных систем по количеству аккаунтов
- Количество водителей, которые пользуются сервисом
- Количество парков, которые пользуются сервисом
- Оборот

### Укажите технические метрики
Для мониторинга выплат через внешнее API платежных систем будут использованы стандартные метрики STQ в которых будут выполняться соответствующие задачи. По ним будем смотреть и понимать на каких этапах и со сколькими транзакциями у нас есть проблемы, количество ошибок, справляемся ли мы с нагрузкой.

### Какая функциональность ожидается в сервисе в будущем?
Добавление новых платежных систем в новых странах
Усиление безопасности

### Какое изменение нагрузки планируется?
Пропорционально количеству водителей

### Активно ли будет изменяться сервис?
Да
