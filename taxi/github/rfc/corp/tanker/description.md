# Описание
Описание интеграции Заправок (для начала в виде расписанных блоков по тикету 
https://st.yandex-team.ru/CORPDEV-2625)

v1.7

Схема на Miro https://miro.com/app/board/o9J_lyWQzBI=/

Эпик про добавление корпоративного метода в Еду https://st.yandex-team.ru/TAXIBACKEND-24412
(ориентируемся на интеграцию Еды).

## 1. Синхронизация сотрудников
Сейчас Заправки синхронизируют корпоративных сотрудников через API, которое
предоставляют сами корпоративные клиенты. Обновление сотрудников происходит раз в 30 минут.
Вариант, в котором мы просто подстраиваемся под это, делая для каждого
клиента API, выглядит не очень. 

Возможен ли такой вариант?
1) Заправки узнают номер телефона пользователя
2) Заправки меняют этот телефон на personal_phone_id в сервисе 
   https://wiki.yandex-team.ru/taxi/backend/architecture/personaldataservice/ 
   (видимо вопрос в том, как в него ходить из-вне MLU сервисов) и где-то у себя у 
   данного пользователя сохраняют этот personal_phone_id
3) В момент ввода телефона и при последующих открытиях вкладки 
   с методами оплаты (если они видят наличие personal_phone_id 
   у своего пользователя), Заправки идут к нам в corp-int-api/payment-methods, 
   чтобы
   подтягивать доступные корп способы оплаты
   
В таком варианте на первом этапе (до миграции) Заправкам надо будет
проверить пользователя и среди своих корп клиентов, и сходить к нам
в payment-methods.


## 2. Лимиты
По лимитам на первый взгляд все хорошо ложится на существующую 
архитектуру лимитов: проверки потраченного за заданный период уже
есть — нужно завести заправочные accounts в биллинге, чтобы 
получать потраченную сумму через billing-reports/v1/balances/select.
https://wiki.yandex-team.ru/taxi/backend/billing/Kakie-external-entity-id-ispolzovat/

Насчет марки бензина: можно например завести в монге 
corp_limits для этого новое поле, в payment-methods 
новый простенький чекер, наверно больше всего похоже на 
проверки класса такси. Разве что этих различных марок топлива сильно больше,
чем классов такси, они всегда отличаются от заправки к заправке, и надо 
подумать как мы их будем кодировать. У Заправок видел что-то такое:

1) https://bb.yandex-team.ru/projects/TANKER/repos/tanker-backend/browse/core/Models/Fuel.cs#7
2) https://bb.yandex-team.ru/projects/TANKER/repos/tanker-backend/browse/core/Models/Order.cs#368


## 3. Взаимодействие при заказе
Заправки буду ходить к нам в corp-int-api в ручку v1/payment-methods/tanker, 
там будут все проверки возможности оплаты корпоративным счетом.
В начале заправки будет дергаться ручка v1/pay-order/tanker в corp-billing,
в конце заправки — ручка v1/close-order/tanker. Для этих ручек нам нужен 
order_external_ref от Заправок.

Нужно помнить про такие вещи:
1) Цитата из рекламы Заправок: "Если в бак поместилось меньше топлива, 
   то разница вернется на счет".
2) Есть два вида заправок:
    1) Предоплатные: Выбираешь объём, оплачиваешь, заправляешься
    2) Постоплатные: Выбираешь объём, заправляешься, после заправки на
    экране появляется объём и стоимость залитого топлива, оплачиваешь.
3) Цены у нас везде показываются с НДС или без?
4) Что там про постоянную скидку 1.5% для корп клиентов?
5) Есть предложение сделать "декаплинг", ну или вернее нашу собственную
тарификацию

Вообще, в плане этих двух ручек вижу пока такие сценарии:
1) Выбрана сумма, заправился на эту сумму — дергаем pay-order, close-order
2) Выбрана сумма, заправился на меньшую сумму и надо вернуть остаток — pay-order,
pay-order с новой ценой, close-order. Хотя если итоговая цена отличается 
   от начальной очень часто, то возможно стоит обновленную цену сразу 
   через close-order присылать, вместо дополнительного вызова pay-order
3) Выбрана сумма, заправился на эту сумму, через какое-то время рефанд — 
pay-order, close-order, pay-order.
4) И как-то обработать случай с постоплатными заправками

Эти ручки формируют события order_created, order_closed, price_changed и
отправляют в corp-billing-events. Далее corp-billing будет выгребать новые
ивенты и формировать документы для billing-orders. 
Важно, что документы, отправляемые в таксишный биллинг как обычно содержат 
поле entries для учета на виртуальных счетах, но
поле payments в документе будет пустым.
Нужно завести новые agreement_id tanker/orders и tanker/{year-month}/orders.
Пример документа тут https://st.yandex-team.ru/TAXIBILLING-5201#60e46cd0f5c1e278be0793d4

Обработка заказов аналогично еде в сервисе corp-orders:  
Скажем у нас будет крон аналогичный create_eda_order. Подтягиваем новые ивенты
из corp-billing-events с их external_ref. Создаем stq-таску, в которой 
вытягиваем инфу о заказе из Заправок (нужно попросить у них ручку, 
аналогичную ручке Еды /internal-api/v1/orders/retrieve) и сохраняем их 
в постгресе corp_orders.tanker_orders. Плюс надо помнить про репликацию.

## 4-5. Подключение клиента и схема хождения денег
https://st.yandex-team.ru/MLUPO-990#61289a4a252a4c0bac88e3a6  
https://st.yandex-team.ru/MLUPO-1081  
https://st.yandex-team.ru/OEBS-48031  

Еще не финализировано, предварительно:
* создаём оферту Заправок в Балансе
* отдаём открутки по 650-му сервису: 1 транзакция на 1 рубль в месяц, 
  если клиент пользовался Заправками

Весь флоу биллинга остается на стороне Заправок, на своей стороне делаем минимум
для учета лимитов.

## 6. История заправок и акты
По отчетам: аналогично другим сервисам, там +- копипаста везде,
думаю с заправками сделаем так же. Нужна ручка в corp-orders 
v1/orders/tanker/find, 
которая будет отдавать из постгреса заправочные заказы данного клиента за
выбранный период. Нужны будут всякие танкерные ключи для табличек.
Для раздела Поездки и отчёты в кабинете нужна будет ручка 
1.0/client/{client_id}/tanker/orders.

## 7. Отправка актов на почту
Если тут речь про то, что я делал с YaDoc`ом, то тут надо 
понять собственно как туда попадают акты. Если заправочные 
окажутся там же, то уже выгрузку на почту оттуда менять не 
надо будет.

Формирование актов на стороне заправок/oebs, им нужно обеспечить попадание актов
в YaDoc, чтобы их оттуда можно было достать по contract_id (номер договора клиента
с заправками?)


## Личный кабинет
* Для раздела в Поездки и отчёты в кабинете нужна будет ручка 
1.0/client/{client_id}/tanker/orders.
* 1.0/client/{client_id} в поле services в ответе учитывать сервис заправок
* GET и POST 1.0/client/{client_id}/user. 
  Сейчас в интерфейсе можно задать
только месячный лимит, но вроде бы у нас есть поддержка дневных лимитов
* 1.0/client/{client_id}/user/{user_id}/order — сейчас возвращает заказы Такси
конкретного сотрудника. Просят сделать то же самое для Заправок.
* 1.0/client/{client_id}/reports/orders/generate — скачать реестр

## Админка
проверить, и если нужно добавить
* v1/clients/list — поле services в ответе
* v1/contracts — поле services
* v1/services
* v1/clients/{client_id}/reports/acts/generate — добавить sheet в ДА
* v1/clients/{client_id}/reports/orders/generate — добавить поддержку tanker
* v1/users


## Вкратце: что нужно от Заправок
* Уметь получать personal_phone_id
* Дергать ручку v1/payment-methods/tanker для получения корп способа оплаты
* Уметь дергать ручки v1/pay-order/tanker и v1/close-order/tanker при заказе
* Ручка, которая по id заказа возвращает информацию о нем
