# Почтовые уведомления корпоративных клиентов

## Задача
Создать единый механизм отправки писем корпоративным клиентам.

## Как сейчас
[Функциональное описание](https://wiki.yandex-team.ru/taxi/backend/corp/avtomaticheskie-pisma-klientam/)

[Описание для разработчика](https://wiki.yandex-team.ru/taxi/backend/corp/avtomaticheskie-pisma-klientam-dlja-razrabotchika/)

Кратко текущий функционал умеет:

- отправлять письма при наступлении события(триггерные письма)
- планировать отправку писем в будущее 
- планировать отправку группы писем (например так реализован онбординг)
- удалять запланированные к будущей отправке письма
(например надо прекратить спамить клиенту если он сдался и пополнил счет)

## Что нам не нравится в текущей реализации
1. Функционал отправлятора живет глубоко в [коде КК](https://github.yandex-team.ru/taxi/backend-py3/tree/develop/services/taxi-corp/taxi_corp/notifier)
2. События-триггеры и события отмены отправки раскиданы по коду КК и Админки

## Предложения

Хотелось бы в итоге получить такую схему:
1. Происходит некое триггерное событие (создание клиента по оферте, изменение баланса и т.д.)
2. Сервис, в котором произошло событие (КК/corp-admin/corp-clients) отправляет это событие в сервис corp-notifier (отправка события через постановку stq-таски)
3. corp-notifier готовит данные (идет в БД или АПИ других сервисов, проверяет условия и т.д.)
4. corp-notifier в соответсвии со своимо конфигами ставит событие в очередь (если отложенное) / шлет в рассылятор (если надо отправить сразу)
5. фоновый процесс в corp-notifier (крон) периодически разгребает очередь и отправляет письма в рассылятор

### Сервис corp-notifier
Для чего: для отправки писем корпоративным клиентам по событиям от других сервисов.

Что он умеет:
MVP:
- принимать события от других сервисов (сервисы ставят stq-таску в специальную очередь нотифаера)
- по получению события проверяет условия и собирает данные для отправки (из других сервисов) 
- хранит очередь писем (отправленные и на отправку)
- взаимодействие с рассылятором

Второй этап:
- ручки исторических данных для Админки(отправлено/запланировано/еще что-то...)
- ручки для конфигурирования из Админки (часть конфигов удобнее реализовать во фронте)
- возможность "переотправки" письма
- возможность ручной отправки письма некоторому клиенту (только те письма которые "сконфигурированы", заведены в рассыляторе и т.д.)

#### АПИ сервиса

##### Очередь входящего события

corp-notifier предоставляет специальную stq-очередь в которую сервисы-клиенты могут ставить таску.
Что это значит: любому письму предварительно предшествует некоторое событие, например, баланс изменился.
В stq попадает именно событие "баланс изменился" и связанные с событие данные.
(для каждого события будет собственный предопределенный набор данных, клиенты обязаны передать эти данные в stq-таску)

в таске происходит:
- определение какие письма может триггернуть это событие
- сбор данных (по АПИ других сервисов)
- вычисление необходимость отправки письма (например баланс не только изменился, но и стал меньше порога уведомления)
- немедленная отправка (если триггерное письмо), или постановка в очередь / удаление из очереди

##### Крон разгребания очереди
Раз в минуту. Вычитывает очередь и отправляет письма, срок которых наступил.
Аналог https://tariff-editor.taxi.yandex-team.ru/dev/cron/taxi_corp-stuff-process_notices_queue

##### Что еще может потребоваться (последующие этапы)
- ручка переотправки письма
- ручка удаления письма из очереди

#### БД сервиса (драфт)

queue - очередь писем на отправку (отправленные письма либо тут же либо в отдельной табличке)
create table queue(
  id BIGSERIAL PRIMARY KEY,
  event_id FOREIGN KEY,
  client_id TEXT NOT NULL,
  send_at TIMESTAMPTZ ALLOW NULL,  -- время запланированой отправки
  sended TIMESTAMPTZ ALLOW NULL,   -- время фактической отправки 
)

Индексы: client_id, sended, send_at

### Этапы реализации
##### MVP
1. (3d) Заводим новый сервис corp-notifier, арх-ревью, шаблон нового сервиса
2. (9d) Реализация stq-шек (stq входящего события и stq отправки) и крона разгребания очереди (MVP сервиса)
3. (1w) Первые переезды писем (делать под конфигами): В первую очередь переносим письма, вызываемые из старых кронов синка контрактов и балансов:
   из синка контрактов:
   - FirstRemindPrepaidNotice
   - SecondRemindPrepaidNotice
   - ThirdRemindPrepaidNotice
   - ThirdRemindOfferNotice

   - PrepaidFirstTakeARideNotice
   - PrepaidSecondTakeARideNotice
   - PostpaidFirstTakeARideNotice
   - PostpaidSecondTakeARideNotice

   - ActivateClientNotice
   - CargoActivateClientNotice

   из синка балансов:
   - LimitIsOverNotice
   - FinancialUnblockNotice
   - LowBalanceNotice

   - наблюдаем, исправляем баги, удаляем временные конфиги, старый код в КК, старые кроны и т.д.

##### Второй этап:
- Перенос всех остальных писем
- Удаление кода нотифаера из КК
- Документация на вики

##### Третий этап: (опционально)
- Ручки для Админки (история, ручная отправка, переотправка)
- Возможно перенос некоторых конфигов в Админку
- Фронт Админки

## Дополнительно
https://st.yandex-team.ru/TAXICORP-4829

