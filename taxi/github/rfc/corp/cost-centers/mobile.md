## Ссылки

* [проект на вики](https://wiki.yandex-team.ru/users/aantsife/kastomizirovannyjj-centr-zatrat/)
* [тикет в TAXIPROJECTS](https://st.yandex-team.ru/TAXIPROJECTS-2113)
* [проработка зависимостей в Miro](https://miro.com/app/board/o9J_lTOaIvc=/)
* [эпик разработки бэкенда](https://st.yandex-team.ru/CORPDEV-1871)
* [бэкенд-тикет на изменения в /3.0/paymentmethods](https://st.yandex-team.ru/CORPDEV-1893)
* [бэкенд-тикет на изменения в /orderdraft](https://st.yandex-team.ru/CORPDEV-1895)
* [бэкенд-тикет на изменения в /changecorpcostcenter](https://st.yandex-team.ru/CORPDEV-1896)

## Получение новых ЦЗ из /3.0/paymentmethods

### Как сейчас

В ответе ручки есть поле `corp.available_accounts`, содержащее список объектов,
у каждого из которых может быть поле `cost_centers` с объектом, который
содержит поля:
- `required` (обязательно ли вводить ЦЗ)
- `format` (выбирать значения из списка `items`, вводить вручную или оба варианта)
- `items` (список объектов с ключом `name`, содержащим строку с вариантом для выбора ЦЗ)

### Как будет

Приложения старых версий используют старый флоу работы с ЦЗ (поля `cost_centers` и `cost_center`).

Для новой версии в ответ ручки рядом с полем `cost_centers` добавится новое поле
`cost_center_fields`, которое будет содержать
список объектов, аналогичных объекту из поля `cost_centers`.
Если этот список пустой или поле отсутствует, то для данного пользователя
не нужно показывать экран выбора ЦЗ.

На каждый объект в этом списке нужно отрисовать поле,
аналогичное полю "центр затрат", только заголовок поля нужно брать из нового поля `title`:

В этих объектах будут следующие поля:
- `title`, в котом будет заголовок поля ("центр затрат", "цель поездки" etc)
- `id`, в котором будет идентификатор поля (если клиент заполнил это поле,
  то идентификатор нужно будет передавать с другими данными в ручку `orderdraft`)
- `order_flows`, в котором будет список строк: `["taxi", "eats", "drive"]`
  (содержит список order_flows, для которых нужно отображать это поле)
- `services`, в котором будет список строк: `["taxi", "eats", "drive"]`
  (список сервисов, для которых корп. клиент включил это поле в настройках ЦЗ)
- `required` (булево значение; обязательно ли вводить это поле)
- `format` (строка; выбирать значения из списка `items`, вводить вручную или оба варианта)
- `items` (список объектов с ключом `name`, содержащим строку с вариантом для выбора ЦЗ)

```yaml
    cost_center_fields:
        type: array
        items:
            type: object
            properties:
                title:
                    description: заголовок поля для отображения на клиенте
                    type: string
                id:
                    description: |
                      id поля для будущей локализации
                      (уникально в рамках одного корп. аккаунта)
                      (NOTE! Может быть пустой строкой, это означает, что у клиента
                      есть только старый ЦЗ) 
                    type: string
                required:
                    description: |
                      если true, то значение для этого поля обязательно нужно
                      передавать в ручки `orderdraft` и `changecorpcostcenter`
                      (и это значение должно быть не пустым)
                    type: boolean
                format:
                    description: |
                      строка, обозначающая допустимые варианты значения поля
                      - если `text`, то допускается любое значение
                        (пустое или непустое, в зависимости от `required`)
                      - если `select`, то допускаются только значения из списка `items`
                      - если `mixed`, то допускаются любые значения, при этом
                        нужно также предложить пользователю выбрать из `items`
                    type: string
                order_flows:
                    description: список order_flows, для которых это поле активно
                    type: array
                    items:
                        type: string
                services:
                    description: список сервисов, для которых это поле активно
                    type: array
                    items:
                        type: string
                items:
                    type: array
                    items:
                        type: object
                        properties:
                            name:
                                type: string
```

### Возможные ошибки

**TODO**

## Получение новых ЦЗ из /3.0/taxiontheway

Для возможности изменения ЦЗ в процессе поездки.

### Как сейчас

Приходит строка `cost_center` со значением ЦЗ, выбранным пользователем на этапе заказа.

### Как будет

Добавится поле `cost_centers` со списком объектов, в формате, аналогичном
отправленному ручкой orderdraft (см. ниже).

```yaml
cost_centers:
    type: object
    properties:
        can_change:
            description: можно ли менять ЦЗ в текущем статусе поездки
            type: boolean
        values:
            description: |
              текущие значения ЦЗ, присланные пользователем в заказе
              или измененные ранее через ручку changecorpcostcenters
            type: array
            items:
                type: object
                properties:
                    title:
                        description: название поля (заданное в корп. кабинете)
                        type: string
                    id:
                        description: |
                          id поля (генерируется беком)
                          (может быть пустым, см. детали в /3.0/paymentmethods)
                        type: string
                    value:
                        description: значение для поля, ранее выбранное пользователем
                        type: string
```


## Отправка новых ЦЗ в /orderdraft

### Как сейчас

Приложение отправляет поле `cost_center`, которое содержит строку со значением
центра затрат (если оно было выбрано/введено на этапе создания заказа).

### Как будет

Приложение старой версии игнорирует поле `cost_center_fields`, используя
старый флоу работы с ЦЗ (поля `cost_centers` и `cost_center`).

В новой версии поле `cost_center_fields` всегда приходит в ручке
`/3.0/paymentmethods`, приложение работает только по новому флоу:

1) Проверить, что пользователь ввёл значения для обязательных полей (у них `required: true`).

2) Поддержать проверку введённых значений в каждом поле (при наличии этого значения):
- если у поля указан `format: selected`, то значения могут быть выбраны только из списка `items`
- если у поля указан `format: text`, в поле могут быть любые значения
- если у поля указан `format: mixed`, в поле могут быть любые значения, в том числе из `items`

3) Если все введённые значения корректны, то в ручку `/orderdraft` нужно
    отправить новое поле `cost_centers`:

```yaml
    cost_centers:
        description: список значений полей центра затрат
        type: array
        items:
            type: object
            properties:
                title:
                    description: заголовок поля, берётся из `/3.0/paymentmethods`
                    type: string
                id:
                    description: |
                      id поля, берётся из `/3.0/paymentmethods`
                      (в том числе может быть пустым, это признак старого ЦЗ для бэка)
                    type: string
                value:
                    description: значение поля, указанное пользователем
                    type: string
```

## Проверка ЦЗ в ordercommit

Для приложения в запросе ничего не меняется.

В ответе бекенд может прислать ошибку 406 про то, что ЦЗ не прошли валидацию.

## Отправка новых ЦЗ в /changecorpcostcenter

Формат отправки измененных ЦЗ такой же, как в ручке `/orderdraft`.
Значения настроек полей новых ЦЗ приложение получает из `/3.0/paymentmethods`
(либо из кэша, как обсуждали).
Значения полей, выбранные ранее, приложение регулярно получает из `/3.0/taxiontheway`.

В случае, если присланные значения не соответствуют настройкам ЦЗ клиента или
пользователя, ручка ответит кодом 406:
```json
{
  "error": {
    "code": "CANNOT_CHANGE_COST_CENTER_WRONG_SETTINGS",
    "comment": "",
    "text": "Неверные центры затрат"
  }
}
```

В случае, если заказ уже завершён, ручка ответит кодом 406:
```json
{
  "error": {
    "code": "CANNOT_CHANGE_COST_CENTER_ORDER_STATUS",
    "comment": "",
    "text": "Невозможно поменять центры затрат на этой стадии заказа"
  }
}
```

(в поле `comment` будет некий технический комментарий для логов и дежурных)
