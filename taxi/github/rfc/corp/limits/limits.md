### Описание

Описание примерной структуры монги и ручек в рамках задачи https://st.yandex-team.ru/CORPDEV-1885 
для наглядного представления и обсуждений, постепенно пополняется и исправляется.

Понятия "лимиты" и "теги" используются здесь как синонимы.

### Пример объекта новой коллекции corp_limits
```json5
{
	// В целом схема очень похожа на corp_roles, но есть отличия
	"_id" : "dd89e0539b654d8bbd6026f27272e9d5",
	"name" : "Регулярные поездки такси",

	"client_id" : "3ca124c251554a359fdf40a967e76c59",

	// Пишем сюда департамент пользователя, создавшего лимит
	// необходимо для упрвления доступами чтения/редактирования
	// (https://wiki.yandex-team.ru/users/f-damir/ybs/ybs-sotrudniki-i-limity/#limityprivjazanykklientuilidepartamentu)
	"department_id": "eb2d06799a214e39962029fc7f016aeb",

	// Каждый лимит строго привязан к одному сервису
	"service": "taxi",
         
        // удобно будет хранить id соответсвующей роли, если лимит был получен
        // в результате миграции из групп, это поможет удобно менять лимиты при
        // изменении групп в старой логике
        "role_id": "ffc258e6e0f141e29f0b00297554e24b",

	"categories" : [
		"business",
		"comfortplus",
		"econom",
	],

	"limits": {
		// Отдельные объекты для каждого типа лимита, 
		// потому что решили, что period может быть различным
		"orders_cost": {
			"value" : 999999,
			"period" : "month",
		},
		"orders_amount": {
			"value" : 20,
			"period" : "day",
		},

                // По новому дизайну непонятно акуально ли это
                "limits_mode": "or",
	},

	"time_restrictions" : [
		{
			"days" : [
				"we",
				"tu",
				"th",
				"sa",
				"fr"
			],
			"start_time" : "00:00:00",
			"end_time" : "03:00:00",
			"type" : "weekly_date"
		}
	],

	"geo_restrictions": [
		{
			"source" : "ff50ba8a205f44d89107a088b083aa99",
			"destination" : "2c56d7f583714fc1b08502519942afae"
		},
	],

	"counters" : {
		"users" : 3,
	},

	"creates" : ISODate("2020-05-06T16:03:11.079Z"),
	"updated" : ISODate("2020-05-06T16:03:11.079Z"),
}
```

В теории, лимиты по сервисам могут отличаться и содержимое corp_limits может стать сильно разным для сервисов
(пока что представленный выше пример полность подходят для такси, а сервисы еды и драйва пока не используют все 
перечисленные выше возможности и не имеют своих особенных лимитов, но кто знает, что будет дальше).


Но так как у нас монга, то вроде это ок, каждый лимит строго привязан к сервису полем service, на основе которого 
можно будет задокументировать различия содержимого лимитов в будущем.

### Соответствующие изменения в corp_users
```json5
{
	"...": "...",

	// Думаю, помимо поля 'service' в corp_limits информацию о сервисе
	// необходимо дополнительно хранить в привязке пользователя к лимиту как минимум для того, 
	// чтобы на странице сотрудников без лишних запросов отрисовывались иконки сервисов
	// (https://wiki.yandex-team.ru/users/f-damir/ybs/ybs-sotrudniki-i-limity/#razdelljudiigruppy)
	"limits": {
		"taxi": ["014bb29961e04bd688ea2db64c827330", "79a5f4f62d9a490ba8c9229468812b1b"],
		"eats2": ["5ee81483499c42a7a53a5fa32d329a8a"],
		"drive": ["2a95fd5619c34ec1937d6c4e81291546"]
	},

	// Либо так, пока не определился как лучше
	"limits": [
		{
			"service": "taxi",
			"limit_id": "014bb29961e04bd688ea2db64c827330",
		},
		{
			"service": "taxi",
			"limit_id": "79a5f4f62d9a490ba8c9229468812b1b",
		},
		{
			"service": "eats2",
			"limit_id": "5ee81483499c42a7a53a5fa32d329a8a",
		},
		{
			"service": "drive",
			"limit_id": "2a95fd5619c34ec1937d6c4e81291546",
		}
	]
}
```

### Новые ручки

По поводу новой функциональности Дамир писал следующее:

Действия с самим лимитом: 
- создать лимит
- редактировать лимит 
- удалить лимит
- фильтровали лимиты по подразделениям

Действия с сотрудниками, связанные с лимитом
- назначить текущем сотруднику
- назначить новому сотруднику при создании
- заменить один лимит на другой
- снять у пользователя данный лимит
- массово по списку пользователей назначить лимит
- массово по списку пользователей заменить лимит
- массово по списку пользователей снять лимит

#### Новые ручки лимитов
**GET** /2.0/client/{client_id}/limits/{limit_id} - получение конкретного лимита

**GET** /2.0/client/{client_id}/limits - поиск лимитов, все параметры в query params

**POST** /2.0/client/{client_id}/limits - добавление нового лимита

**PATCH** /2.0/client/{client_id}/limits/{limit_id} - обновление лимита по id

**DELETE** /2.0/client/{client_id}/limits/{limit_id} - удаление лимита по id 
(понять что делать с сотрудниками с таким лимитом)


#### Новые ручки сотрудников
**GET** /2.0/client/{client_id}/users/{user_id} - получение сотрудника

**GET** /2.0/client/{client_id}/users - поиск сотрудников, все параметры в query params

**POST** /2.0/client/{client_id}/users - добавление сотрудника

**PATCH** /2.0/client/{client_id}/users/{user_id} - обновление сотрудника

**POST** /2.0/client/{client_id}/users/{user_id}/restore - восстановление сотрудника


#### Ручка для массовых назначений/снятий лимитов пользователям
**POST** /2.0/client/{client_id}/users-limits/reassign
тело запроса может быть примерно таким
```json5
{
	"users_limits": [
		{
			"user_id": "123",
			"limits_to_assign": ["123123123", "1231231244"],
			"limits_to_remove": ["2423423423"],
		},
		{
			"user_id": "456",
			"limits_to_remove": ["77823882898", "54545453543"],
		}
	]
}
```
Ручка массового переназначения тегов сотрудникам выглядит тяжелой, возможно нужно выполнять 
обновления лимитов сотрудников в stq, тогда необходима такая ручка:

**GET** /2.0/client/{client_id}/users-limits/status - статус выполнения операции массового изменения
лимитов сотрудникам

Есть мысли о удалении ненужного куска /client/{client_id} из url-ов в v2, но тогда в случае
вызова по новым ручкам старых функций возникнет проблема, что в старых функциях часто
client_id берется напрямую из path. Кажется проще всего будет переделать старые функции, 
чтобы брать в них client_id как-то так:
```python
(await request.cache.access_data).client_id
```

#### Изменения флоу страницы сотрудников

Как сейчас происходит открытие вкладки "сотрудники" на примере клиента corp-test:
1) идет запрос в /1.0/search/departments - с новыми лимитами остается все так же
2) /1.0/group/8fffcb9488a54c9b9ad1a70bdd91972c - запрашивается группа "Без права самостоятельного заказа", 
с новыми лимитами потребность в этом запросе отпадает
3) /1.0/group?department_id=null&limit=10000 - запрашиваются корневые группы (с отсутствующим депаратментом), 
вместо этого в новых лимитах можно будет запрашивать не корневые группы, а корневых пользователей с 
отсутствующим департаментом 
4) еще в это время идет запрос сотрудников /1.0/client/beed2277ae71428db1029c07394e542c/user?skip=0&limit=50 - 
оставляем так же
5) далее там начинаются постепенные запросы некорневых групп, которые становятся неактуальными


Вроде в целом пока все складывается и остальные ручки не должны быть затронуты. Ко всем актуальным старым ручкам 
предлагается в рамках перехода на новые лимиты сделать доступ и по /v2, чтобы фронт/клиенты по апи однозначно 
могли использовать либо полностью только ручки /v1, либо только ручки /v2.


### Миграция и совместимость старой логики с новой

#### Миграция из старой логики в новую:

- Каждую группу можно однозначно превратить в новый лимит (или в несколько лимитов, если у сотрудника есть 
лимиты на еду. Для драйва пока насколько я понял эти лимиты неактульны), поэтому 
каждая группа (кроме группы  "Без права самостоятельного заказа") будет смигрирована в лимиты.

Для сервиса такси лимиты будут взяты из коллекции corp_roles, а для еды из groups в сorp-billing.

- Кастомные группы сотрудников ("Остальные") будут точно так же смигрированы в лимиты. Тут надо
постараться максимально объединить одинаковые по факту кастомные группы в один тег.

- Пользователи групп "Без права самостоятельного заказа" не будут иметь тегов (лимитов).

Какое-то колиество клиентов, которые работают с нами через API, надолго останутся с на
старой логике и ручках v1, про это надо не забывать. Так как группы легко матчатся на лимиты,
то для таких клиентов в старых ручках нужно будет поддержать одновременное ведение
ролей, групп и лимитов, что позволит во всем остальном коде (например в corp-int-api) 
использовать только corp_limits.

#### Возможность миграции из новой логики в старую:

Идеальная миграция в обратную сторону невозможна, потому что новые лимиты гибче старых групп (лимиты - 
отдельные сущности для каждого сервиса, к тому же, лимитов на сервис в теории может быть несколько).

Поэтому предлагаю не придумывать никакую поддержку совместимости в эту сторону и запретить возврат 
клиентов со старой логики на новую.


### Шаги реализации

Описание примерных шагов дейставий на пути к новым лимитам, на основе которых можно будет создавать
конкретные таски 

#### Общие шаги:

1) создать новую коллекцию corp_limits
2) добавить доступ к старым ручкам через /v2/

#### Такси

- т1) добавить в код старых ручек для групп и сотрудников дублирование данных ролей в corp_limits
- т2) мигрировать corp_roles в corp_limits
- т3) реализовать новые ручки, взаимодействуя при этом с фронтом
- т4) доработать КК, чтобы во всех местах вместо ролей использовались лимиты
- т5) доработать corp-int-api для использования новых лимитов вместо ролей

1 -> т1 -> т2 -> т3 -> т4 -> т5

#### Еда

- е1) добавить в код старых ручек для групп и сотрудников дублирование данных по лимитам еды
в corp_limits
- е2) мигрировать groups из corp-billing в corp_limits
- е3) доработать КК, чтобы во всех местах вместо groups использовались лимиты
- е4) перенести логику проверки возможности заказа еды из corp-billing в corp-int-api и соответственно
переключиться на использование corp_limits

1 -> е1 -> е2 -> е3 -> е4

#### Драйв

В процессе..

#### Результат

Кажется, что ветки шагов можно выполнять в таком порядке: Такси, Еда и затем Драйв.
После выполнения всех шагов можно сказать, что задача будет решена.

### Заметки

#### Оставшиеся вопросы 
- актуален ли в новых лимитах параметр "limits_mode" ("or"/"and") и если нет, то как его 
интерпретировать при миграции в новые лимиты?
- что в итоге делаем в случае, когда удалается лимит, который еще назначен сотрудникам?
- надо подумать по поводу того, что у сотрудника может быть несколько лимитов на один сервис. 
Что это из себя представляет? Лимит интерпретируется как отдельный кошелек (отдельный payment method?)
и нужно считать траты по каждому из них?
- в кастомных группах (которые объединяются термином "остальные"), название группы в монге
является не человекочитаемым id сотрудника. Это ок, если соответствующие им лимиты будут 
называться так же?
- и как выполнять требование для индивидульных лимитов "максимально объединяем одинаковые",
если потом через старую логику сотруднику могут обновить индивидульную группу, и будет непонятно
что делать с этим объединенным лимитом

#### Несколько лимитов на один сервис

Если будет несколько лимитов на один сервис и лимит будет восприниматься как отдельный
"кошелек", то, если очень вернеуровнево, то нужно сделать следующее:

- в corp-int-api нужно будет воспринимать лимит как отдельный метод оплаты,
по каждому из которых нужно считай свои траты
- после завершения заказа в дополнение к данным в текущем запросе в таксишный 
биллинг необходимо отправлять и ифнормацию о конкретном лимите.

#### Переезд логики проверки способов оплаты еды в corp-int-api

После того, как заработают навые лимиты, вся необходимая информация по лимитам еды
будет храниться в corp_limits, поэтому можно будет перенести логику ручки 
/v1/payment-methods/availability/eats из corp-billing в corp-int-api.

Если полность повторить схему ручки /v1/payment-methods/availability/eats в corp-int-api,
то для перехода на нее достаточно будет поменять путь к ручке в api-proxy.

Также можно будет перенести всю логику групп из corp-billing в КК, так как в corp-billing
она перестанет использоваться.
