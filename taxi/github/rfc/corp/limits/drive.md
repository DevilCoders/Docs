## Лимиты драйва

### Выбор подхода

Сейчас есть два основных подхода, как можно сделать лимиты драйва:

#### Использовать драйвоский description как сущность лимита ("С дескрипшнами")

Если создать description в драйве с настройками лимитов и создавать кошельки в этом дескрипшне, 
то на кошельки будут действовать лимиты этого дескрипшна.

##### Плюсы

- Легкость операции обновления лимита - нужно сделать всего один запрос на обновление 
дескрипшна и лимиты у всех кошельков изменятся автоматически.

##### Минусы

Переносить кошельки  из одного дескрипшна в другой в драйве нельзя, это влечет следующее

- При переназначении лимита сотруднику нужно будет удалить старый кошелек сотрудника и завести
ему новый (и не совсем понятно как это делать балково)
- Также при переназначении лимита таким образом потеряются все траты кошелька
- Сложность миграции старых клиентов на эту логику. Получается для каждого старого сотрудника
нужно будет создать свой дескрипшн + удалить старый кошелек + создать новый кошелек в этом 
дескришне. В таком кейсе, когда для каждого кошелька существует еще и отдельный дескрипшн - 
то дескрипшн выглядит лишним. Можно конечно попытаться сжать похожие лимиты, но выглядит сложно.
- Хотелось хранить лимиты драйва так же, как лимиты такси и еды в corp_limits для удобства 
API корп кабинета и быстродействия ручки. Для такого придется делать какую-то репликацию
драйвовских дескрипшнов в corp_limits или наоборот из corp_limits в драйв.

#### "Без дескрипшнов"

Подход предполагает оставить примерно все, как есть сейчас. То есть настройки лимитов будут
храниться только у нас в corp_limits, а лимиты кошельков в драйве будут изменяться напрямую
как и сейчас.

##### Плюсы

- Требуется заметно меньше изменений в текущей логике
- Легко мигрировать старых клиентов (для них для каждого кошелька нужно будет создать 
объект в corp_limits)

##### Минусы

- Изменение настроек лимита. Изменить настройку лимита так просто не получится, потому что
для этого нужно изменить настройки каждого кошелька, принадлежащего лимиту. (но для этого в
драйве есть балковая ручка 
https://wiki.yandex-team.ru/Yandex.Drive/carsharing/Razrabotka/DriveCorp/#8.obnovleniejekzempljarakoshelka)

#### Решение

Второй вариант кажется более привлекательным - меньше трудозатрат и легкость миграции кажутся основными факторами.
Также минус второго подхода кажется не таким плохим при наличии балковой ручки обновления настроек кошельков. У
первого подхода же минусов кажется больше, к тому же удалять + создавать новый кошелек каждый раз при переназначении
лимита сотруднику кажется узким местом, способным создать много duty.

Что касается балковых операций переназначения лимитов сотрудникам, то во втором подходе делать нужно будет то же
самое, что и при изменении настроек одного лимита - балково обновить настройки кошельков в драйве. В первом
же подходе для массового переназначения лимитов нужно будет удалить кучу кошельков и создать столько же в других 
дескрипшнах (при таком массовом муве узкое место становится еще уже, к тому же создать балково кошельки в драйве
кажется нельзя).

Учитывая все это, я для себя пока выбрал второй подход ("Без дескрипшнов"), но готов обсудить это и поменять решение, 
если я в чем то не прав.


### Подробнее о реализации

Все следующие мысли будут описаны для варианта "Без дескрипшнов", так как пока этот вариант кажется наиболее
предпочтительным

##### Привязка в драйве

Примерный флоу:
- изначально у сотрудника нет лимитов на драйв и он не привязан к нему
- привязываем автоматически при назначении первого лимита на драйв. Как и сейчас, по промокодам сразу с созданием
кошелька (только теперь создаем с нулевыми настройками, например soft_limit=0, hard_limit=0), 
который назначается сотруднику.
- также тут сразу пишем в corp_users в список лимитов сотрудника что то такое:
```json5
{
    "limit_id": "12313",
    "service": "drive",
    "account_id": 12345, // ручка POST api/b2b/accounts/promocode возвращает account_id
    "are_changes_applied": false // лимит не применен до тех пор, пока сотрудник не привязался к драйву
}
```
- после этого на фронте появляется что-то по типу "Промокод выслан, лимит назначится сотруднику после привязки к
драйву". Можно либо не отдавать на фронт непримененный лимит драйва вообще, либо отдавать и помечать его как-нибудь серым,
чтобы было понятно, что он еще не применен.
- далее крон corp_drive_sync_promocodes проставляет drive_user_id активированным сотрудникам в драйве. Тут можно
вызывать stq, которая будет менять настройки кошелька account_id в драйве в соответствии с настройками лимита, 
который указан в limit_id (stq, а не прямо в коде, чтобы можно было заюзать ее при изменении настроек лимита и 
переназначении лимитам сотрудникам). После успешного запроса в драйв stq выставляет лимиту "are_changes_applied": true.

Как бонус предлагаю не давать возможности "перепривязать" сотрудника, если он уже успешно привязан. Кажется, 
очень много duty возникает, когда клиент начинает кликать на эту кнопку. Сейчас "перепривязка" кажется нужна только
для таких кейсов https://wiki.yandex-team.ru/taxi/backend/corp/corp-drive/#pereprivjazka, но эти кажутся довольно
редкими. Думаю, лучше их отдельно разбирать на duty, чем давать всем возможность кликать на эту кнопку.

Если же промокод протух, а сотрудник не успел привязаться, то тогда будем давать возможность привязать заново.


#### Переназначение лимита сотруднику

- в списке лимитов сотрудника для лимита драйва меняется "limit_id", are_changes_applied лимита становится false
- вызывается stq обновления кошелька в драйве, меняется are_changes_applied на true

#### Балковое переназначение лимитов сотрудникам

То же самое, что и с одним сотрудником

#### Изменение настроек лимита

- всем сотрудникам, которым назначен этот лимит драйве проставляем are_changes_applied: false в этом лимите
- вызываем все ту же stq, которая обновит настройки кошельков у всех кошельков в драйве, после чего вернет 
are_changes_applied в true
