# миграция корповой монги на MDB

## Какие вводные
- хотим иметь возможность откатиться
- нельзя потерять данные
- без полного даунтайма:
    - во всех случаях хотим оставить доступ на чтение
    - хотим не блокировать возможность заказа
    - и нужно обсудить, можно ли на время запретить создание новых сотрудников - т.е. временно запись users будет недоступна. Заказ для новых номеров телефонов тоже
      (нужно оценить, как часто вообще мы добавляем так новых сотрудников. Для call2visit наверное это частый кейс)


## Что может пойти не так

- Данные разъедутся между базами;
- Данные разъедутся в кешах сервисов;
- База в MDB будет не справляться с нагрузкой;

## Куда что мигрируем

У нас есть ~40 коллекций, которые используются в разных сервисах, планируем перенести на несколько баз.
Теги:
- [updated] - есть поле updated
- [has_delete] - записи удаляются из коллекции

Новые базы (размер указан на 2022-01-12 с учетом сжатия. Без сжатия - где-то в 1.5-2 раза больше):
1. corp-requests:
    - [updated] "client_request_drafts"
    - [updated] "client_requests"
    - [updated] "manager_requests"
    - "locks" (забыли)

    Нагрузка (s2.nano):
        - rps: ~ 1 rps
        - размер: ~260Mb
        - totalIndexSize: 41Mb
2. corp-tariffs:
    - [updated] "client_roaming_zones"
    - [updated][has_delete] "client_tariff_plans"
    - [updated][has_delete] "tariff_plans"
    - [updated][has_delete] "tariffs"

    Нагрузка (s2.medium):
        - rps: в пике до 700 rps на corp-tariffs.taxi.yandex.net/v1/client_tariff/current_GET , которые проваливаются в поиск по индексу в client_tariff_plans;
               + загрузка кешей (corp-tariffs, corp-int-api . Первоначальная загрузка >40к тарифов в corp-tariffs может наверное нагрузить);
        - размер: ~187Mb
        - totalIndexSize: 85Mb
3. corp-clients:
    - [updated] "cards_main"
    - "client_attendance"
    - "client_categories"
    - [updated] "clients"
    - [updated] "contracts"
    - [updated] contract_debts
    - [updated] contract_fixed_debts
    - [updated] "corp_front_storage"

    Нагрузка (s2.medium):
        - rps: 50 (corp-clients) + 150 (taxi-corp) + (300 на paymentmethods + 50 на GET client) (corp-int-api) = 550rps (Запросы по индексам. Редкие тяжелые запросы из админки)
        - размер: ~640Mb
        - totalIndexSize: 120 Mb
4. corp-orders:
    - [updated][has_delete] "orders"

    Нагрузка (s2.micro):
        - rps: ~20 rps по primary key и редкие тяжелые запросы по cost_center, client_id.
        - размер: ~80 Gb
        - totalIndexSize: 13 Gb
5. corp-users:
    - "async_operations"
    - "long_tasks"
    - "long_tasks_locks"
    - [updated][has_delete] "cost_center_options"
    - [updated] "departments"
    - [updated] "geo_restrictions" (?)
    - "drive_accounts"
    - [updated] "drive_promocode_cursor"
    - [updated] "drive_promocodes"
    - [updated] "history"
    - [updated][has_delete] "limits"
    - [updated][has_delete] "roles"
    - [updated] "users"

    Нагрузка (s2.large):
        - rps: >2k rps на users от corp-int-api;
        - размер: ~13 Gb
        - totalIndexSize: 3.2 Gb
6. corp-reports (s2.nano):
    - [updated][has_delete] "reports"
    - [updated] detailed_acts

    Нагрузка:
        - меньше 1rps;
        - размер: ~2mb;
        - totalIndexSize: 0.5mb
7. corp-managers:
    - [has_delete] "acl_common"
    - [updated][has_delete] "department_managers"
    - [updated][has_delete] "managers"

    Нагрузка (s2.micro):
        - rps: 150(taxi-corp) + 50 (corp_client_id в corp-int-api) = 200rps
        - размер: ~30mb;
        - totalIndexSize: 10Mb;


Эти коллекции вообще удалим:
    - "ratelimits"
    - [updated] "codes"
    - [updated] "drive_groups"
    -  "drive_users_queue"
    - [has_delete] "eats_users_queue"
    - [updated] "groups"
    - "link_requests"
    - "users_codes"
    - [updated] "client_frontend_version"
    - [has_delete] "notices_queue" (будет не нужна после полного переезда в corp-notices)

## Процесс миграции

Мигрировать будем отдельные коллекции, а не целиком базы.
В процессе будет запрет на запись в коллекцию.
(Про то, как реплицировать данные - см. след. раздел)

### Миграция одной коллекции

1) создаём индексы в новой базе;
2) запускаем репликацию из старой коллекции в новую;
3) переключаемся (с запретом на изменения на непродолжительное время):
    1) вырубаем на время кроны, которые работают с этими коллекциями. И все другие долгие процессы;
    2) запрещаем изменять данные в старой базе (на фронт будем возвращать http 503. stq-шки пускай падают (?) );
        (в идеале конечно на уровне монги запретить, но это будет сложно с учетом наших всех сервисов, которые ходят под разными пользователями)
    3) ждем, пока всё дореплицируется;
    4) запускаем обратный синк изменений (из новой в старую);
    5) переключаем чтение на новую базу;
    6) смотрим, нормально ли база справляется с нагрузкой и тп;
    7) включаем запись (уже в новую базу);
4) выпиливаем старые коллекции. Оставляем только corp_..._mdb;


### Общий план

Репликация через Data Transfer сейчас заблочена [задачей](https://st.yandex-team.ru/TM-2885) и [доступом](https://st.yandex-team.ru/TAXIADMIN-29478).
Поэтому делаем так:
1. так как переключать будем через конфиг и соотв. декораторы в py3, то для всех коллекций нужно заранее перенести весь код, который работает с коллекциями в py3 (из backend-py2 соотв.);
2. заказываем базы в MDB, исходя из оценок нагрузки;
3. Поддержать на фронте какое-то понятное отображение 503 (наверное с каким-то фискированным кодом?)
4. Переносим малонагруженные (на чтение и на запись) коллекции через синк по updated полю;
5. Переносим нагруженные (на чтение) коллекции через синк по updated полю;
6. Как будет готов Data Transfer - с помощью него спокойно мигрируем всё остальное;


### Задачи
- Поддержать на фронте какое-то понятное отображение 503 (наверное с каким-то фискированным кодом?)
- Перенести в py3 всю работу с корповой базой
- Написать скрипт по копированию по updated полю
- Миграция коллекций corp-requests
- Миграция corp-reports
- ....


## Как копировать данные

Есть 4 основных варианта - вряд ли для всех коллекций можно будет использовать один и тот же.
data-transfer, если они поддержат разные названия баз при миграции, выглядит самым удобным.

### mongodump/mongorestore

Плюсы:
- кажется, самый быстрый способ
- точно все данные переедут, выглядит как самый надёжный

Минусы:
- на время mongodump + restore нужно запретить запись, т.е. время простоя самое большое. restore еще будет ребилдить индексы
- должны быть одинаковые major версии монги, но говорят, что с 4.0 на 4.2 можно переносить. Надо проверять
- вроде бы требует админов - у нас самих нет таких прав (но это не точно, наверняка можно временно попросить)

###  data-transfer
Яндексовая система https://wiki.yandex-team.ru/data-transfer/ (доступна снаружи, как сервис облака).
С помощью data-transfer трекер перевозил монгу (1.5Tb) в MDB, им всё понравилось [STARTREK-22702](https://st.yandex-team.ru/STARTREK-22702).


Плюсы:
- минимальный даунтайм (останавливаем запись. Ждем досинка)
- возможность отката (см. как у трекера - они после переключения настроили трансфер обратно)
- мониторинг из коробки
- поддерживает миграцию между разными версиями монги

Минусы:
- (БЛОКЕР) пока нельзя переименовать базу [тикет](https://st.yandex-team.ru/TM-2885). Нам нужно будет при переезде corp переименовать в соотв. базы (corp_requests, corp_reports и тп)
- тоже кажется, нужны действия админов для заведения источника

###  скриптами/кронами по updated

Одноразовый скрипт - "скопировать всё" вроде ничем не лучше dump/restore.
Крон, который постоянно подтягиваем

Плюсы:
- самый понятный, можно делать хоть сейчас

Минусы:
- не похватит deleted
- не везде есть updated поле
- можно потерять часть данных, так как updated особых гарантий не даёт (пишется пользовательским кодом)
- нужно писать сколько то кода (сам крон, добавление updated, сохранение курсора, мониторинг) и тестировать


###  читать и писать в обе базы

Скопировать данные (скриптом например) и потом писать сразу в обе базы. (пример - см. [personal_state_mdb](https://github.yandex-team.ru/taxi/rfc/blob/master/user-state/personal_state_mdb.md#вариант-второй-чтение-из-новой-с-фолбеком-на-старую))

Плюсы:
- единственный вариант сделать вообще без даунтайма (в каких-то местах достаточно читать из двух баз)

Минусы:
- у нас 42 коллекции, которые часто изменяются в нескольких местах в коде. Очень много кода придется для этого перелопатить;
- сложно корректно обработать find & update, могут быть проблемы с delete
- вообще сложно для этого подхода поддержать консистентность данных

## Как переключаем чтение/запись в новые базы

Есть классический вариант - поменять connection string в секдисте и передеплой сервиса.

1. Но так как переносим не всю базу разом, а разносим коллекции по разным базам,
то целиком поменять коннект для "corp" в секдисте не получится.
2. Сделать отдельные коннекшены (corp_requests, corp_reports и тп), прописать их в конкретный коллециях, и их менять в секдисте тоже не получается, так как названия базы тоже отличается на железе и в MDB (т.е. dbcorp vs. corp_requests например).

Поэтому в schemas будут коллекции вида:
    - corp_<smth>: смотрит на старую базу
    - corp_<smth>_mdb: на новую базу


И надо либо явно в коде писать corp_users_mdb.find... либо можно попробовать таким способом (тут PoC для py3): https://a.yandex-team.ru/review/2137102/details
(но могут возникнуть проблемы с кешами в corp-int-api и corp-tariffs)


## Нюансы миграции каждой коллекции


#### Миграция базы corp_users
- Коллекция читается в py2
- используется в каждом запросе в corp-int-api, т.е. по факту ~1.5 - 2к rps запросов;
- При создании заказа для неизвестного номера, мы перед созданием заказа создаём сотруника
- Во время коммита для этого сотрудника есть запрос в corp-int-api, поэтому там есть чтение из мастера.
  Собственно поэтому мы не можем там читать с задержкой



#### Миграция базы тарифов

Так как в тарифах и ТП есть версионирование, то кажется, что миграция тут будет несложной.

Коллекции:
- "client_roaming_zones"
- "client_tariff_plans"
- "tariff_plans"
- "tariffs"

Читаются в сервисах:
- taxi-corp
- corp-int-api
- corp-tariffs
- corp-admin
- corp-clients

Пишут в сервисах:
- corp-admin
- corp-clients

#### Миграция базы corp_requests
Коллекции "client_request_drafts" & "client_requests" специально читаются из мастера, потому что фронт сразу после PUT делает GET.
