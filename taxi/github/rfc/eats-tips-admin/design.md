## Предоставляет данные для нового веб интерфейса пользователя системы

Основная задача: сбор и агрегация данных из смежных сервисов и предоставление их на фронт в виде единого согласованного апи.

В первой итерации (2021 q4) переносим функционал только страницы транзакций.  
<font color=red>Часть с асинхронной выгрузкой отчетов еще в проработке.</font>

Тикеты:
- глобальный продуктовый [EDAPRODUCT-2036](https://st.yandex-team.ru/EDAPRODUCT-2036)
- кусочек продуктового [EDAPRODUCT-2161](https://st.yandex-team.ru/EDAPRODUCT-2161)
- эпик бекенда [EASYT-176](https://st.yandex-team.ru/EASYT-176)

Смежные сервисы:
- [tips-payments](https://wiki.yandex-team.ru/taxi/backend/architecture/eats-tips-payments/) - предоставляет платежи и отзывы
- [tips-partners](https://wiki.yandex-team.ru/taxi/backend/architecture/eats-tips-partners/) - предоставляет пользователей и организации
- потенциальные сервисы из [EASYT-443](https://st.yandex-team.ru/EASYT-443)

### Авторизация

На время интеграции нового интерфейса в старую систему - обмен куки пользователя на jwt, после переезда в партнерку - tvm.

Пример с полным циклом получения списка транзакций  
![авторизация](https://jing.yandex-team.ru/files/jlemyp/auth.png)

Схема единая для всех ручек админки, но далее в диаграмках шаги обмена куки на токен будут пропущены для простоты.

### Асинхронная выгрузка отчетов

диаграмка  
![асинхронная выгрузка](https://jing.yandex-team.ru/files/jlemyp/export.png)


### API

**Получение списка заведений пользователя**  
По умолчанию, если не указан конкретный пользователь - используется текущий авторизованный.
При указании не своего пользователя в ответе будут общие заведения.  
выходные:
- название
- логотип (ссылка на s3)
- роль/права текущего пользователя в заведении

**Получение списка сотрудников заведения**  
входные:
- список идентификаторов заведений

выходные:
- идентификатор заведения
- фио - 3 раздельных поля. под вопросом
- фото - ссылка на s3

**Получение списка транзакций**  
входные:
- список заведений
- список пользователей
- отрезок времени - даты от и до
- верхняя и нижняя границы оценок
- пагинация (<font color=red>еще обсуждается. запасной вариант в лоб - limit/offset</font>)

выходные:
- фио
- фото
- сумма чаевых (за транзакцию)
- текст отзыва
- оценка отзыва
- дата-время - сначала транзакция, потом отзыв
- бейджи быстрых ответов
- процент от чека (пока что не имеем)
- заведение (пока что труднореализуемо)

### Доп ресурсы

- mds - хранение файлов выгрузки отчетов  
  бакет будет торчать наружу, но закрыт на чтение. ссылки на файлы будут выдаваться временные и с подписью
- postgres - хранение истории и статусов выгрузок  
  схема бд:
  таблица export_tasks:
  - id (`uuid`) - pk, он же ключ файла в s3
  - created_at (`datetime`) - когда создана
  - live_to (`datetime`) - примерное время автоудаления файла (кончился lifetime в mds)
  - user_id (`str`) - пользователь, инициировавший выгрузку
  - type (`str`) - enum: transactions, ...
  - status (`str`) - enum: <font color=yellow>in-progress</font> | <font color=green>>success</font> | <font color=red>fail</font>
  - parameters (`jsonb`) - опции фильтра
