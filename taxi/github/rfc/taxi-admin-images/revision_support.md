# Поддержка ревизий в image_tag

## Проблема
Сейчас в картинках нет никакого механизма, позволяющего отслеживать
изменения в загруженных файлах. Поскольку клиенты кешируют изображения
на своей стороне, то обновление картинки может внести неконсистентность
в элементы UI. 

## Описание
Управление картинками происходит в админке в микросервисе
`taxi-admin-images`. Изображения загружаются в mds, полученный урл
сохраняется в монге вместе с image_tag'ом и выбранным размером.

Сейчас структура одной загрузки выглядит примерно так:
```(json)
{
    "image_id" : "38221/c7b37ca42c474514ad9b8a668024c4cf",
    "tags" : [
        "class_express_car_7"
    ],
    "size_hint" : {
        "iphone" : 300
    }
}
```

Предлагаю новую структуру с учетом ревизий:
```(json)
{
    "tags" : [
        "class_express_car_7"
    ],
    "size_hint" : {
        "iphone" : 300
    },
    "image_id": <image_id>,
    "revision_history": [
        {"revision_id": <revision_id>, "image_id": <image_id>},
        {"revision_id": <revision_id>, "image_id": <image_id>},
        {"revision_id": <revision_id>, "image_id": <image_id>}
    ]
}
```

Новые теги будут иметь вид `<tag>:<revision_id>`. После полного перехода
на ревизии, поле `image_id` из корня структуры можно будет удалить.
При редактировании image_tag'а, у которого ревизий еще не было, в дополнение
к сгененированной новой, будет записана "старая ревизия" с `revision` = `initial`.

#### Пример
Процесс будет полностью прозрачным для клиентов.

##### Было
Пришел тег `{"image_tag": "app_icon_music"}`, клиент делает запрос
по урлу `https://tc.tst.mobile.yandex.net/3.0/getimage?tag=app_icon_music&size_hint=432`

##### Станет
Пришел тег `{"image_tag": "app_icon_music:34f88b"}`, клиент делает запрос
по урлу `https://tc.tst.mobile.yandex.net/3.0/getimage?tag=app_icon_music:34f88b&size_hint=432`


### Как клиенты кешируют изображения
iOS клиенты удаляют из кеша изображения, которые не использовались
более двух месяцев. Библиотека, которая на Android загружает изображения,
имеет lru-кеш, старые изображения будут вытесняться.

В приложении iOS есть провайдер изображений,
у которого есть 3 метода:
1. Дай мне изображение (если есть в кеше, то берет оттуда, иначе скачивает и сохраняет в кеш)
2. Скачай изображение (всегда ходит по сети)
3. Отдай изображение из кеша и сходи в ручку, вдруг нужен апдейт (https://st.yandex-team.ru/ITAXI-7288) (будет удален)
Разработчики сами выбирают, каким методом им воспользоваться.

### Изменения в коде

#### backend-py3
Генерить ревизии при создании тегов и обновлять при их изменении
в микросервисе `taxi-admin-images`. Еще понадобится новая ручка, через 
которую будет наполняться кеш.

#### backend-cpp
Нужно сохранять ревизии в кеше коллекции `db.images`, а также
парсить ревизии в запросах к `/3.0/getimage`.

#### uservices
Ручку `/3.0/getimage` нужно вынести в uservices и доработать, чтобы
парсить запросы с ревизиями.
Нужен новый кеширующий компонент соответствия `image_tag -> актуальная ревизия`
и функция, которая будет преобразовывать `image_tag` к виду `image_tag:<актуальная ревизия>`.
Также потребуется внедрить ревизии в сервисе shortcuts.

#### Изменения на клиентах
Поскольку клиенты могут кешировать полученные изображения навсегда, то
нужно продумать вариант очистки кеша. Нужно подобрать какой-нибудь
адекватный таймаут (например, 2 недели), при наступлении которого 
неиспользованные изображения будут удаляться.

### Задачи и оценка
- [TAXIBACKEND-29124](https://st.yandex-team.ru/TAXIBACKEND-29124) — поддержка ревизий в админке (2d)
- [TAXIBACKEND-29210](https://st.yandex-team.ru/TAXIBACKEND-29210) — внутренняя ручка для наполнения кеша (2d)
- [TAXIBACKEND-29125](https://st.yandex-team.ru/TAXIBACKEND-29125) — перенос ручки `/3.0/getimage` в uservices (3d)
- [TAXIBACKEND-29126](https://st.yandex-team.ru/TAXIBACKEND-29126) — кеш-компонент в uservices (3d)
- [TAXIBACKEND-29127](https://st.yandex-team.ru/TAXIBACKEND-29127) — внедрить в сервисе shortcuts (2d)
- [TAXIBACKEND-29155](https://st.yandex-team.ru/TAXIBACKEND-29155) — мониторинги (2d)
- [TAXIBACKEND-29156](https://st.yandex-team.ru/TAXIBACKEND-29156) — фикс проблем (лишние куки, тяжелые изображения) (3d)
