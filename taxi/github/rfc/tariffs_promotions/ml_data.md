## Задача

Передавать в блендер некоторые данные из оффера, чтобы учитывать их в ML-моделях.

### Продуктовое описание
См. [TAXIBACKEND-34565](https://st.yandex-team.ru/TAXIBACKEND-34565)

#### Какие данные требуются:
- названия точек А и Б
- длина поездки в км (и минутах)
- цены в тарифах
- коэффициент суржа (для всех тарифов)
- дефолтный/предвыбранный тариф

#### Кто потребители:
- tariffs-promotions
- inapp
- persuggest
- ... (другие сервисы, кому нужны данные из оффера)



### Существующий механизм получения данных из оффера

uroutestats (асинхронная передача некоторых данных оффера в tariffs-promotions через [/v1/offer-data](https://github.yandex-team.ru/taxi/uservices/blob/develop/services/tariffs-promotions/docs/yaml/api/offer-data.yaml#L20-L35))

↓↓↓

tariffs-promotions (сохраняет данные в redis)

↓↓↓

tariffs-promotions (для генерации промоплашек достаем данные из редиса)


Сейчас уже сохраняем:
- валюта
- цены в тарифах
- данные из альт.офферов, в частности промо плюса

___

## Варианты реализации получения данных из редиса

- Вариант 1: с помощью библиотеки
- Вариант 2: через сервис tariffs-promotions

Рассмотрим подробнее эти варианты.

 
### Вариант 1: с помощью библиотеки

Клиенты подключает библиотеку, в которой будет метод получения данных из редиса.

Плюсы:
- уменьшаем время получения данных за счет прямого похода в хранилище
- избавляемся от лишней нагрузки в tariffs-promotions

Минусы:
- непонятно как контроллировать нагрузку от нескольких потребителей на общий редис
- не будет обобщенного графика в графане, только графики базы yasm, из-за этого возможно сложности с настройкой алертов


### Вариант 2: через сервис tariffs-promotions

Клиенты за данными из оффера ходят в tariffs-promotions. В нашем случае это будет inapp.
То есть добавляются шаги к существующей схеме:

inapp (идет в tariffs-promotions за данными из офферов)

↓↓↓

blender (получает данные из inapp)

Плюсы:
- будет единый привычный график нагрузки от всех потребителей + настройка нужных алертов
- можем использовать rate-limiter

Минусы:
- увеличиваем время получения данных за счет похода в сервис tariffs-promotions

___

### Выводы:

Выбираю вариант 2 (через сервис tariffs-promotions),
т.к. 
- он из коробки дает наглядные мониторинги и прочие механизмы работы с нагрузкой
- в реализации намного проще (добавит get для существующего post)

#### На будущее:
Чтобы срезать нагрузку на tariffs-promotions,
можно сделать так, чтобы inapp получал данные оффера,
а потом передавал во все остальные источники (tariffs-promotions, persuggest).
Таким образом не каждый источник вычитывает оффер, а inapp один раз.

Тут появляются сложности:
- т.к. поход за данными оффера будет синхронный, важно не увеличить тайминги
- перевести всех источников промоплашек на новую логику

Сейчас данная схема требует больше ресурсов на разработку, поэтому пока не делаем.

___

#### План доработок:
- uroutestats: добавить в запрос дополнительный данных из оффера
- tariffs-promotions:
    - для POST /v1/offer-data добработать сохранение новых данных из uroutestats
    - добавить GET /v1/offer-data аналогично схеме POST
- inapp:
    - забирать данные по офферам из tariffs-promotions /v1/offer-data (асинхронно с получением плашек, чтобы не увеличивать тайминги)
    - передавать данные оффера в blender
