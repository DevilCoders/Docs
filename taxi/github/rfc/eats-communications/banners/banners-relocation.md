# Переезд banners в eats-communications

# Table of Contents

1.  [Сервис banners](#org7ecaf7c)
    1.  [Клиенты](#orgdbef56a)
        1.  [Эксперименты](#orgd090206)
        2.  [Inapp](#orge571225)
        3.  [Коллекции](#org86f1193)
        4.  [Каталог](#org29bfeb5)
    2.  [Ручки](#org9d29095)
    3.  [Логика работы](#org4c37805)
2.  [План переезда](#org4c27d23)
    1.  [Этап 1](#orgb3d1090)
    2.  [Этап 2. Отказ от похода в inapp](#org9ee3f02)


<a id="org7ecaf7c"></a>

# Сервис banners


<a id="orgdbef56a"></a>

## Клиенты

Список внешних зависимостей сервиса


<a id="orgd090206"></a>

### Эксперименты

Использвется для получения настроек и экспериментов, при переезде
в eats-communications часть задач решаемых с помощью экспериментов,
такая как конфигурация таймаутов, ретраев и хостов внешних API,
будет решена средствами уже существующими в uservices, такими как
Taxi Configs.


<a id="orge571225"></a>

### Inapp

[Спека](https://github.yandex-team.ru/taxi/uservices/blob/7f33016d14344ccbf95a4be7072f11694e2ca82a/services/inapp-communications/docs/yaml/api/api.yaml#L285)

Ипользуется для того чтобы получить список баннеров, созданных
в tariff-editor.

Баннеры привязываются к заведения по brand<sub>id</sub> или по place<sub>id</sub>.

Каждый баннер имеет тип:

-   **info** - баннеры просто ведут на опредленный url без привязки
    к какому-то ресту
-   **place** - привязан к ресту по place<sub>id</sub>, показывается только в том
    случае если каталог отдал рест с таким идентификатором на точку
-   **brand** - то же что и **place**, только привязка происходит по brand<sub>id</sub>
-   **collection** - баннер коллекции, должен показываться только в том
    случае, когда есть коллекция с указанным слагом, в данной точке,
    и если в ней есть хотябы один ресторан.


<a id="org86f1193"></a>

### Коллекции

[Спека](https://github.yandex-team.ru/taxi/uservices/blob/develop/services/eats-collections/docs/yaml/api/api.yaml#L215)

Используются для отображения баннеров коллекций - баннер коллекции
является входной точкой в коллекции. Сервис баннеров запрашивает
у сервиса коллекций все возможные, не пустые, коллекции - если
для данной коллекции есть баннер, то он будет возвращаен в ответе
серввиса.


<a id="org29bfeb5"></a>

### Каталог

Используется для получения списка доступных заедений на запрос
пользователя. К сожалению под ручку нет спецфиикацию - на вход
она получает координаты и время доставки

    {
        "deliveryTime": "2020-11-03T12:07:53+03:00",
        "location": {
                    "latitude": 55.74009273155045,
                    "longitude": 37.64017012269922
        }
    }

и возвращает список доступных ресторанов

    "payload": [
      {
        "id": 173213,
        "slug": "yandekslavka_bolshaya_tatarskaya_35s4",
        "type": "store",
        "brand": {
          "id": 20369,
          "slug": "yandekslavka_vasti",
          "placeSlug": "yandekslavka_bolshaya_tatarskaya_35s4"
        }
      },
      {
        "id": 73448,
        "slug": "Subway_Sadovnicheskaya",
        "type": "restaurant",
        "brand": {
          "id": 1661,
          "slug": "subway",
          "placeSlug": "Subway_Sadovnicheskaya"
        }
      }
    ]

При переездее в eats-communications хотелось бы использовать
ручку каталога /api/v1/catalog/shotlist, который уже используется
в eats-communications для фильтрации сторизов.

[Спека shortlist](https://bb.yandex-team.ru/projects/EDA/repos/spec-api/browse/specs/server_catalog-service_v1/paths/shortlist.yml)


<a id="org9d29095"></a>

## Ручки

[Спека серверных ручек](https://bb.yandex-team.ru/projects/EDA/repos/spec-api/browse/specs/server_banners_v1/spec.yml)
[Спека клиентских ручек](https://bb.yandex-team.ru/projects/EDA/repos/spec-api/browse/specs/client_banners_v1/spec.yml)

Сервверная ручка баннеров использыется только для layout-constructor,
она должна целиком быть перенесена под аналогичную ручку 
eats-communications.

Клиентская ручка используется для отображения баннеров на старых
клиентах, кажется, что в первой итерации ее либо нужно переносить,
либо оставлять ее в текущей go имплементации чтобы потом удалить
весь сервис.


<a id="org4c37805"></a>

## Логика работы

Делается два параллельных запроса: в каталог за достпуными для
пользователя заведениями и в коллекции для получения доступных
коллекций. На основании полученных данных формируется запрос в
inapp, который возввращает список доступных баннеров.
При это каталог и коллекции могут не ввернуть результат, в
резульате чего inapp не вернет баннеры заведений или баннеры
коллекций.

![img](banners-layout.png)


<a id="org4c27d23"></a>

# План переезда

Для того чтобы постепенно переключить трафик с сервиса banners
в eats-communications мы можем реализовать один из двух вариантов:

-   Добавить в сервис banners поход в eats-communications и под
    экспериментом пускать трафик либо в старый флоу, либо проксировать
    в eats-communications.
-   Использовать api-proxy реализовав на нем аналогичную механику
    с экспериментом, который будет определять в какой сервис нужно
    пускать запрос. (насколько я помню api-proxy умеет использовать
    эксперимент)


<a id="orgb3d1090"></a>

## Этап 1

На первом этапе кажется самым надежным и быстрым будет перенесение
логики баннеров без изменений - это позволит нам накопить
какой-то объем тестовых кейсов и не тратить большое количество
времени на решение новых проблем.

Оценка: ~2 дня


<a id="org9ee3f02"></a>

## Этап 2. Отказ от похода в inapp

По сути дела, сейчас мы используем inapp в качестве кеша баннеров,
который inapp, в свою очередь, получает из сервиса promotions.
Данное решние не очень удобно для нас так как изменения в баннерах
Еды првязаны к разработке и релизам inapp, поэтому хочется
вторым шагом отказать от inapp в пользу аналогичной логики на
стороне eats-communications.

Вторым этапом мы создаем кеш баннеров Еды из ручики сервиса
promotions [/internal/promotions/list](https://github.yandex-team.ru/taxi/backend-py3/blob/develop/services/promotions/docs/yaml/api/api.yaml#L12), которым мы подменим поход
в inapp.

Оценка: ~2 дня

![img](banners-layout-v2.png)

