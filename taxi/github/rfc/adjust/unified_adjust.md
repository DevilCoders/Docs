# Единый Adjust для Такси, Еды и Лавки

## Проблема

Сейчас есть много совершенно разных способов отправлять события в Adjust о заказах в том или ином БЮ:
- события со стороны пассажиров Такси обрабатываются в сервисе `taxi-adjust`, причём он на данный момент достаточно сильно заточен именно под это
- событий со стороны водителей Такси в Adjust вроде бы нет совсем или они отправляются каким-то неизвестным мне образом
- события Еды отправляются через монолит на PHP, где дальнейшая разработка нежелательна
- события Лавки отправляются тоже через монолит Еды, что накладывает ограничения на дальнейшую разработку новых событий для Лавки


## Задача

Проработать максимально универсальную схему, при которой данные из Такси, Еды, Лавки и в будущем, возможно, других БЮ смогут попадать в Adjust с минимальным количеством доработок.

## Решение

1. Потребители Adjust (Такси, Еда, Лавка), публикуют свои события в `order-events-producer`. 
1. `order-events-producer` имеет возможность описывать в [конфиге](https://tariff-editor.taxi.yandex-team.ru/dev/configs/edit/ORDER_EVENTS_PRODUCER_PIPELINES) на некотором метаязыке пайплайн обработки данных: какие поля откуда забрать, какие новые поля добавить и куда отправить результат.
1. В конце обработки данных в пайплайне `order-events-producer` публикует stq-таску, которую обрабатывает сервис `taxi-adjust`.


## Подробнее о том, какую задачу решает сервис `taxi-adjust`

Сервис [Adjust](https://adjust.com) предоставляет возможности по оптимизации маркетинговых кампаний. Например, маркетолог настраивает рекламную кампанию в Google Analytics:
- При клике на рекламу и перед тем, как пользователь будет перенаправлен в магазин приложений, на сервера Adjust уйдёт запрос с деталями о том, на какую рекламу кликнул пользователь.
- Cервера Adjust запомнят эту информацию.
- Далее, при запуске приложения, с SDK Adjust отправляют запрос на их сервера, которые могут сопоставить ранее сохранённую информацию и отправить в сервис `taxi-adjust` запрос, содержащий id установки и id кампании.
- Сервис `taxi-adjust` запоминает id установки и id кампании.
- В момент какого-то события в дальнейшем инфраструкктура БЮ может отправить запрос в `taxi-adjust` c тем, чтобы `taxi-adjust` сопоставил идентификатор пользователя и id кампании и отправил как данные события, так и эти идентификаторы в Adjust.
- На основании событий из предыдущего пункта Adjust может каким-либо образом оптимизировать рекламные кампании так, чтобы поток таких событий увеличивался.
- События должны быть "важными" с точки зрения целевой функции маркетинга БЮ. Например, для Такси хороший пример это первая поездка на Такси пассажира/первый выполненный заказ водителя, для Лавки - первый заказ в Лавке.


## Как обеспечить возможность хранить данные разных потребителей в `taxi-adjust`
**Вариант 1**: Добавить новое поле и при запросе фильтровать по нему
**Вариант2**: Выделять отдельную коллекцию на отдельный тип пользователей

Второй вариант кажется более предпочтительным, но новых потребителей будет чуть сложнее добавлять.

## Как получать события от потребителей

### Пассажиры Такси

1. Добавить новую очередь `taxi_passenger_adjust_events`.
1. Под экспериментом слать события из процессинга в `order-events-processing`, передавай в параметрах статус заказа, тариф и возможно что-то ещё.
1. Из `order-events-processing` ставить таску в `taxi_passenger_adjust_events`.
1. В этой очереди определять нужный тип события по параметрам таски (первый заказ, первый успешный заказ, первый (успешный) заказ в тарифе) и слать его в Adjust.
1. Постепенно отказаться от всех других существующих очередей и удалить их.

Для определения того, первый ли это заказ пользователя, используется `phone_id`. Количество поездок пользователя (в тарифе) для данного `phone_id` можно найти в сервисе `userstats`.

### Водители Такси

1. Добавить новую очередь `taxi_driver_adjust_events`.
1. Под экспериментом слать события из процессинга в `order-events-processing`.
1. Из `order-events-processing` ставить таску в `taxi_driver_adjust_events`.
1. В этой очереди определять нужный тип события по параметрам таски (первый заказ, первый успешный заказ, первый (успешный) заказ в тарифе) и слать его в Adjust.

Для определения того, первый ли это заказ водителя, используется следующая схема:
- берём ВУ, по которому совершалась данная поездка
- для этого ВУ собираем все `driver_id` - все профили водителя, связанные с данным ВУ
- ищем заказы для всех `driver_id`  из предыдущего пункта, соверщённые не позже, чем за 45 дней до данного заказа
- если такие заказы есть, ничего не делаем. В противном случае считаем этот заказ первым и отправляем соответствующее событие в Adjust.

Q: Как можно по ВУ найти `driver_id`?

A: Совершить запрос в сервис `unique-drivers` в ручку `/v1/driver/profiles/retrieve_by_license_pd_ids`, которая по `driver_license_pd_id` вернёт список `unique_driver_id` связанных с этим ВУ. Далее с каждым из таких `unique_driver_id` можно сходить в `/v1/driver/profiles/retrieve_by_uniques` ([спека](https://github.yandex-team.ru/taxi/uservices/blob/develop/services/unique-drivers/docs/yaml/api/api.yaml#L365)), получив таким образом список `driver_id` водителя.


Q: Как по `driver_id` можно определить, первый ли это заказ водителя?

A: Можно с помощью `park_id` и `driver_id` сходить в ручку `/v1/parks/orders/list` сервиса `driver-orders` ([спека](https://github.yandex-team.ru/taxi/uservices/blob/develop/services/driver-orders/docs/yaml/api/api.yaml#L16)), чтобы получить список заказов, совершённых после определённой даты. Её вычислить как дата совершения текущего заказа - 45d.
