## Админка для промо со скидками

Промо со скидками: это изменения отображения способа оплаты
(summary, плашка вверху, payment options, legal)
в зависимости от геозоны, выбранного тарифа
и наличия скидки у пользователя, заведенной через админку скидок.

[Описание с картинками](https://wiki.yandex-team.ru/users/sharapova-e/Zavedenie-skidok-v-produkt/)

Вкратце, технически сам процесс запуска промо состоит из:
0. Определения сегмента скидки через теги или геозону.
1. Заведения скидки через админку скидок
2. Создания креативов: картинок и текстов через админку картинок и Танкер
3. Заведения структуры в конфиге DISCOUNT_SUMMARY_PROMO


### Какие решаем проблемы

Шаги 0-2 выше неплохо решаются отдельными сервисами, но для шага 3
конфиг уже не очень подходит:
1. Запись в конфиге имеет сложную структуру, которую легко
   понять и заполнить неправильно
2. Заводят скидку одни люди а редактируют другие, что создает ненужный
   ручной труд.
3. Правка конфига осуществляется одним человеком
   и не проходит обязательного согласования.

Также в силу неудачной структуры конфига сейчас он имеет огромный размер.
Эта проблема частично решается в
[TAXIBACKEND-28740](https://st.yandex-team.ru/TAXIBACKEND-28740).
(Частично потому что фикс и новый конфиг есть только в протоколе,
а код в user-state про это ещё не знает. А также потому что
новый конфиг это все равно >1000 строк).

## Roadmap

По результатам обсуждений с Володей Беликовым решили делать через
feeds-admin/feeds.
Ключевые параметры для работы с [API feeds-admin](https://pages.github.yandex-team.ru/taxi/schemas/Taxi_Documentation/Backend-py3/Index/#feeds-admin):
```
service = "discount-summary-promo"
channel = "discount:<тег скидки>"
```

#### Создание промо в админке
проработка админки выполнена в тикете: https://st.yandex-team.ru/TAXIINFRA-1953


#### Доработка бекенда
1. Переносим скриптом содержимое конфига DISCOUNTS_SUMMARY_PROMO в feeds-admin
   В этот момент можно тестировать изменения user-state
2. Делаем бекенд в user-state, протокол не трогаем.
   Вместо похода в конфиг DISCOUNTS_SUMMARY_PROMO ходим в feeds
    ```
    POST <feeds>/v1/fetch
    {
        "service": "summary-discount-promo",
        "channels": ["discount:test_master_yt_ru_econom_16_06_2020"]
    }
    ```
    Параметры для personalstate будут в `feed.0.payload`
    Фоллбек в случае недоступности feeds: пустой список промо. То есть скидка будет работать,
    но промо не нарисуется.

    _важно_: для снижения ожидаемой latency потребуется кеширование <feeds> на стороне user-state
    (нагрузка на сервис feeds составила бы сейчас < 5rps)
    _важно_: старое поведение через конфиг в user-state не поддерживаем, тк сейчас сервис
    в разработке и в случае несоответствия ответа отдается версия из протокола.
    Поэтому принципиально важно, чтобы существующий механизм сверки работал
    в момент запуска.

3. Когда админка будет готова, никаких действий на бекенде не потребуется.

#### Влияние на производительность и время отклика
У personalstate есть 2 режима выполнения: get и update. В обоих может произойти
показ промо, процедура поиска промо инкапсулирована в BuildNotification
1. Запрос в cardstorage (поиск карт по phone_id): 98% ~200ms, но часто кеширован
2. Запрос в discounts (поиск скидок по картам): 98% <60ms, нагрузка 1000rps,
   в 99.5% случаев скидок нет, выход из BuildNotification
3. Запрос в feeds (поиск промо по скидке): <5rps, долгое время отклика 98% до 400ms
   Как собираемся решать:
   * максимум 100мс таймаут на 1 поход и максимум 2 ретрая
     в случае таймаута промо не показываем, скидку даем
   * Кеш на стороне user-state. Здесь очень большой процент попадания в кеш
     * скидок мало и данные почти не меняются. Время кеша: 10 минут
     * ключ кеша - скидка, результат - payload промо

В результате:
 * увеличатся тайминги 0.005 / 600 = 1e-5 доли запросов (+100мс)
 * В случае таймаута feeds с вероятностью (100% - 98%) / 600 = 1e-3
   промо не будет показано там где должно.
