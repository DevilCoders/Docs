# Интеграция с манго

## Введение

Пользователь покупает подписку на страховку через сайт манго (натив или дом плюса). Манго через месяц  приходит в Яндекс с просьбой начислить баллы.

Для пополнения кошелька пользователя планируется создать новый сервис cashback_int_api. 

В качестве авторизации запросов от манго планируется написать новую авторизационную проксю cashback_authproxy.

## Основные моменты
- Авторизация яндексового пользователя в манго
- Пополнение кошелька пользователя из манго

## Авторизация яндексового пользователя в манго

### Манго через Домик Плюса
В домике плюса появляется шорткат Манго. Юзер открывается его и попадает на форму покупки полиса.

Алгоритм:
- Приложение запрашивает авторизацию у паспорта и передает редирект урл на манго.
- Юзеру показывается окно с просьбой подтверждения передачи данных в манго.
- Манго поддерживает паспортную авторизацию Яндекса и получается авторизационный токен (Authorization) юзера.
- По этому токену (Authorization) манго запрашивает необходимое инфо о пользователе (дом, квартира, email, ДР, кошелек, наличие подписки).

Условия показа манго в домике плюса: 
- Так как манго будет доступен только для порталов, то в домике нужно будет показывать секцию/айтем с манго только для портальных пользователей. Поэтому для манго нужно поддержать новое условие в visibility_requirements "has_portal" в конфиге PLUS_SWEET_HOME_CLIENTS_UI_V2 для айтемов в сервисе plus-sweet-home.

<img src="https://jing.yandex-team.ru/files/arteeemik/authorization_v2.png" width="900" alt="">

### Авторизационная прокся
Все ручки сервисы cashback_int_api будут спрятаны за авторизационной проксей **cashback_authproxy**.

В одну из ручек (а именно __/binding/create__) манго будет ходить с авторизационным токеном (Authorization) пользователя и api-key, который мы выдадим манго для авторизации на нашей стороне. 
В другие ручки манго будет ходить без токена (Authorization), только с api-key. То есть хедер ___"X-External-API-Key"___ будет обязательным для всех ручек.

```
Headers:
  // api-key, который мы выдадим партнеру, для их авторизации на нашей стороне
  - "X-External-API-Key": "some_api_key",
  
  // Логин партнера - нужно в авторизационной проксе, чтобы достать по этому логину из секдиста api-key
  // и сверить с присланным api-key из манго
  - "X-External-Service": "mango",
  
  // авторизационный токен (Authorization) пользователя, полученный через паспортную авторизацию
  - "X-External-Authorization": "some_token"
```

Авторизация запросов будет происходить с помощью двух хедеров ___"X-External-API-Key"___ и ___"X-External-Service"___.
В случае успешной авторизации:
- Если пришел хедер "X-External-Authorization" авторизационная прокся пойдет в паспорт за информацией о пользователе
- Перенаправит запрос в нужную ручку

Потребуется создать новый сервис cashback_authproxy.

Ожидаемый rps по ручкам:
- /binding/create - около 500 в день (у Геши узнал)
- /cashback/update - не больше 100 запросов в день на начисление баллов
- /v2/invoice/retrieve - не больше 100 rps (исходя из того, что в ручку /cashback/update в день прилетит не больше 100 запросов), на деле должно быть сильно меньше 100.

### Создание уникального id пользователя для манго

После того, как манго получили информацию о пользователе через паспорт (в том числе получили токен от паспорта - Authorization), манго ходит в ручку __/binding/create__ через авторизационную проксю cashback_authproxy.

Алгоритм:
- Манго идет в ручку __/cashback_authproxy/binding/create__
- Авторизационная прокся cashback_authproxy проверяет Api-key, который передал манго, и авторизовывает пользователя по токену (Authorization) через паспорт
- После авторизации через паспорт, запрос перенаправляется в ручку __/cashback_int_api/binding/create__ с полученным yandex_uid
- Ручка __/cashback_int_api/binding/create__ получает (через новую базу postgres) или создает уникальный binding_id (uuid4) для полученного yandex_uid, и записывает в базу пару (yandex_uid, binding_id) в случае, если для пользователя с данным yandex_uid нет записи в базе
- Ручка __/cashback_int_api/binding/create__ возвращает полученный binding_id

В качестве базы данных планируется использовать postgres.

<img src="https://jing.yandex-team.ru/files/arteeemik/Get_or_creat_binding_id_v2.png" width="900" alt="">

Request ручки __/cashback_int_api/binding/create__:
```json5
{
    "yandex_uid": "<some_yandex_uid>"
}
```

Response ручки __/cashback_int_api/binding/create__:
```json5
// 200 OK
{
    "service": "mango",
    "binding_id": "<uuid4>"
}

// 5xx - ретрай
```

После вызова ручки, манго сохраняет уникальный binding_id пользователя, и в будущем ходят в ручки изменения баланса кошелька пользователя с этим binding_id.

#### Схема базы данных:

```sql
CREATE TABLE cashback_int_api.user_bindings
(
  yandex_uid                   TEXT  NOT NULL,
  binding_id                   TEXT  NOT NULL,
  PRIMARY KEY (yandex_uid, binding_id)
);
```

#### Ожидаемый рост базы данных:
Так как 500 запросов в день в ручку ___/binding/creat___, получаем, что размер базы данных **через год** будет ориентировочно: 500 * 365 = **182 500 записей**.

## Пополнение кошелька пользователя из манго

Алгоритм:
- Юзер покупает подписку на манго либо через домик плюса, либо через веб Манго
- Манго сохраняет информацию о том, что пользователь с таким-то binding_id купил подписку
- Через месяц манго захочет прийти и начислить N баллов пользователю с каким-то binding_id

### Алгоритм начисления на нашей стороне

Вводится две ручки ___/cashback/retrieve___ и ___/cashback/update___.

Ручка ___/cashback/retrieve___:
- Нужна для получения статуса по кэшбэку для определенного заказа манго (mango_order_id)
- Возвращает сколько уже начислено баллов, есть ли операции в прогрессе, список операций, версию
- Версия нужна для разрешения гонок, манго передает версию в ручку ___/cashback/update___

Флоу работы ручки ___/cashback/retrieve___:
- Ручка ходит в сервис transactions в ручку ___/v2/invoice/retrieve___ для получения инвойса, используя <mango_order_id> в качества invoice_id
- Если ручка ___/v2/invoice/retrieve___ ответила кодом 404, значит инвойса не создавали по данному <mango_order_id>, и в ручке ___/cashback/retrieve___ вернем:
```json5
// 200 OK
{
    "id": "<mango order id>",
    "binding_id": "<uuid4>",
  
    "status": "done", 
    "amount": "0", // начисленный кэшбэк
    
    // статус в разбивке по операциям
    "operations": [], 
    
    // версия для разрешения гонок
    "version": 1 
}
```
- Если ручка ___/v2/invoice/retrieve___ вернула инвойс. Через инвойс сможем получить информацию о том, сколько баллов уже зачислено, в каком статусе находится инвойс, список операций и версию инвойса для разрешения гонок
- Возвращает эту информацию в ручке

Схема работы ручки ___/cashback/retrieve___:

<img src="https://jing.yandex-team.ru/files/arteeemik/%3Acashback%3Aretrieve_v2.png" width="900" alt="">

Request ручки __/cashback_int_api/cashback/retrieve__:
```json5
// body
{
    "binding_id": "<uuid4>",
    "order_id": "<mango_order_id>"
}
```

Response ручки __/cashback_int_api/cashback/retrieve__:
```json5
{
    "order_id": "<mango order id>",
    "binding_id": "<uuid4>",
  
    "status": "processing", // статус последней операции
    "amount": "100", // начисленный кэшбэк
    
    // статус в разбивке по операциям
    "operations": [
      {
        "operation_id": "<topup_id>",
        "status": "done",
      },
      {
        "operation_id": "<refand_id>",
        "status": "failed",
      },
      {
        "operation_id": "<refand_id>",
        "status": "processing",
      }], 
    
    // версия для разрешения гонок
    "version": 3
}
```

Ручка ___/cashback/update___:
- Нужна для пополнения баллами кошелька пользователя 
- Нужна для рефандов баллов с кошелька пользователя

Количество запросов в день < 100.
Запрос "начислить больше 1500 баллов" на заказ неправильный, можно это будет контролировать с помощью конфига, в котором будет лежать наибольшее число баллов, которое можем начислить.

Флоу работы ручки будет следующим:
- Поход в базу postgres за yandex_uid по binding_id, который пришел в запросе
- Поход в сервис plus-wallet с yandex_uid и currency за кошельком пользователя
- Вызов ручки ___/v2/invoice/retrieve___ по <mango_order_id>:
  - Вызов завершился с кодом 404. Значит инвойс еще не создан. Проверяем, что пришедшая версия в ручку равна 0 (если не равна возвращаем код 400. Версию 0 возращаем в ручке ___/cashback/retrieve___, когда еще не создали инвойса). Дальше нужно создать invoice c помощью вызова ручки ___/v2/invoice/create___. В случае, если ручка ___/v2/invoice/create___ вернула 409 (Invoice exists), в ручке ___/cashback/update___ возвращаем тоже код 409 (code = "RACE_CONDITION", так как произошла гонка (409 - значит, что инвойс уже создали в transactions). Манго должен у себя обработать эту ситуацию.
  - Вызов завершился с кодом 200. Значит invoice уже есть:
    - Проверяем версию из инвойса и из запроса (если не равны, возвращаем код 400, code = "WRONG_VERSON"). 
    - Если операция с operation_id таким, которое пришло в запросе от манго, уже есть в операциях в инвойсе, то возращаем код 400 (code = "ALREADY_HAVE_OPERATION_ID")
    - Также проверяем, что сейчас никакая другая операция по переданному от манго order_id не выполняется. Если выполняется, нужно дождаться пока она закончит выполняться. Поэтому в этом случае, ручка /cashback/update должна вернуть код 409 (Conflict, code == "NEED_WAIT_ALREADY_RUNNING_PROCESS"). Манго должен будет дождаться с помощью retrieve статуса завершения операций, и повторить попытку обновить баланс, если требуется изменить баланс (доначислить баллы или сделать рефанд)
- Если сумма баллов меньше, чем в инвойсе, значит это рефанд
- Дальше нужно запустить операцию начисления или рефанда через ручку ___/v2/cashback/update___
- В ручку будем передать payload, который сформировал манго для аналитики и отчетности. 
- Также будем в ручку передавать версию операции (версия в transactions увеличится на 1). 

Общая схема ручки ___/cashback/update___:
<img src="https://jing.yandex-team.ru/files/arteeemik/%3Acashback%3Aupdate_v2.png" width="900" alt="">

Request ручки ___/cashback/update___:

```json5
// body
{
    "binding_id": "<uuid4>",
    "order_id": "<mango_order_id>",
  
    "operation_id": "<topup_id/refand_id>",
    "amount": "124.34", // дробного количества кэшбэка для рубля приходить не должно
    "currency": "RUB",
    "payload": {}, // может быть большим
  
    "version": 0
}
```

Response ручки ___/cashback/update___:
```json5
// 200 OK
{}

// 400
{ 
  "code": "WRONG_VERSON", // "ALREADY_HAVE_OPERATION_ID" | "WRONG_VERSON"
  "description": "" // optional
}

// 409
{ 
  "code": "", // "NEED_WAIT_ALREADY_RUNNING_PROCESS" | "RACE_CONDITION"
  "description": "" // optional
}

```

#### Ограничение на количество запросов в ручку:
Можно будет добавить ratelimit на поход в ручку ___/cashback/update___, чтобы предохраниться от неожиданно большого кол-ва запросов от манго (чтобы не положить transactions).
https://wiki.yandex-team.ru/taxi/backend/architecture/rate-limiter/#dokumentacija

## Итог (основные моменты):
- Гонки будут разруливать в сервисе transactions по версиям инвойса, с которым пришел в ручку mango
- Рефанды будут происходить на стороне transactions
- Начисление баллов будет работать только для пользователей с портальными аккаунтами:
  - В домике будем показывать айтем "манго" только портальным пользователям
  - Манго будет авторизовывать клиентов через портальные аккаунты
- **operation_id** - ключ идемпотентности, который будет генировать манго, для начисления баллов и похода в ручку /cashback/update
- **X-External-API-Key** будем генировать руками. Подойдет любой генератор случайной строки, например, uuid4

## Предварительная оценка по времени

### MVP:

[9d] Создать авторизационную проксю cashback_authproxy:
  - [3d] Завести сервис
  - [2d] Создать каркас
  - [2d] Реализовать api-key авторизацию
  - [2d] Реализовать роутер для токена

[3d] Заведение нового сервиса cashback_int_api (арх-ревью + заведение болванки и окружения, + сек-ревью тикет завести). Планируется заводить сервис в uservices

[3d] Заведение базы postgres для создания получения binding_id по yandex_uid

[3d] Реализация ручки ___/cashback_int_api/binding/create___

[3d] Реализация ручки ___/cashback_int_api/cashback/retrieve___

[4d] Реализация ручки ___/cashback/update___

[1d] Поддержать новое требование "has_portal" в конфиге PLUS_SWEET_HOME_CLIENTS_UI_V2 (plus-sweet-home)

Также нужно будет сделать отдельную инсталляцию transactions для манго: https://wiki.yandex-team.ru/taxi/backend/architecture/transactions/architecture/#oservise

Итого, ориентировочно: 26 дней

### Дополнительные доработки:

[3d] Сделать ratelimit на ручку ___/cashback/update___
