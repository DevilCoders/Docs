## Бизнесовая задача


### Описание
Делаем к новому году небольшой интерактив для пользователей - тест про прошедший год и шарилку результатов в соц-сети.
Для водителей предполагается только шарилка с их фактами за год.

Подробнее:
https://wiki.yandex-team.ru/users/boldov/newyear2020/

### Дизайн
[ссылка на дизайн](https://www.figma.com/file/W8CdMxWOZHaXHyPv9WC03l/NY2020?node-id=2%3A1398)


### Глоссарий
* *тест* - Новогодний тест для пользователей такси, составленый на основании их * активности за прошедший год
* *воспоминание* - Один из заранее подготовленных фактов об активности пользователя за * прошедший год
* *YT* - Всеми любимый
* *DB* - Внутренняя база данного сервиса


### Высокоуровневая архитектура
Точка входа: при открытии приложения в случае если у пользователя включён эксперимент появляется popup, предлагающий пройти тест, который открывается как webview.

Создаём новый микросервис с несколькими ручками.
У сервиса есть своя *DB* в которой хранятся вопросы и ответы для пользователей.
Данные в *DB* (вопросы пользователей, факты водителей) загружаются единожды из *YT* скриптом за несколько дней до запуска сервиса.

Единственным потребителем сервиса является фронтенд. Фронтенд ходит в сервис при для того чтобы:
* [I Этап] Получить вопросы пользователя
* [I Этап] Получить рашсарку пользователя
* [I Этап] Создать публичную расшарку пользователя
* [I Этап] Посмотреть публичную расшарку пользователя
* [II Этап] Посмотреть публичную расшарку водителя


### Задачи
#### Получение вопросов
__Описание__

Пользователь хочет пройти тест. Вместе с вопросами приходят также ответы и *воспоминания*.


#### Создание расшарки по результатам теста
__Описание__

Пользователь прошёл свой тест и хочет расшарить результаты

#### Просмотр своей расшарки
__Описание__

Пользователь хочет открыть свои результаты.


#### Просмотр публичной расшарки пользователя
__Описание__

Пользователь переходит по публичной ссылке расшарки и просматривает чьи-либо результаты.

#### Просмотр публичной расшарки водителя
__Описание__

Пользователь переходит по публичной ссылке расшарки и просматривает реузльтаты какого-либо водителя.

Для всех водителей за несколько дней до запуске делается последняя выгрузка из YT. Для каждого водителя генерируется уникальный ID его результатов (например, hash(driver_id+salt)). Во время эвента через таксометр водителям отправляется уведомление содержащие ссылку на их страницу с итогами года (шарилку). Они могут поделиться своими результатами отправив ссылку.

### Предлагаемый API
__Полное описание API находится в файле [`api.yaml`](api.yaml)__

Авторизация пользователя при каждом запросе к эндпоинтам `/4.0/ny2020/...` происходит средствами `passenger-authorizer`.

#### `GET /4.0/ny2020/v1/launch`
Ручка, запрашиваемая при открытии пользователем webview с тестом. Всегда возвращает вопросы и *воспоминания* пользователя. В случае если пользователь уже проходил тест также возвращает результат прохождения теста. В случае если пользователь расшаривал свой результат также возвращает информацию расшарки - процент правильных ответов, выбранные воспоминания, id расшарки.

Если для пользователя не подготовлены вопросы, то ручка возвращает 404.

Пример тела ответа:
```json
{
    "questions": [

        {
            "id": "q23",
            "question": "Какой был самый активный месяц?",
            "answers": [
                {"id": "b36f9a03-8769-40d1-a3da-22d62e13920f", "value": "Январь"},
                {"id": "f8cfd95c-d409-4e3e-affe-746d213e150b", "value": "Май"},
                {"id": "0118e4df-07ec-47f0-809d-bd8ad981f293", "value": "Июнь"},
                {"id": "ba355e3c-c9df-4906-9369-9c8c71aaab9c", "value": "Июль"}
            ],
            "correct_answer_id": "b36f9a03-8769-40d1-a3da-22d62e13920f",
            "input": {
                "type": "checkbox",
                "hint": "Выберите правильный ответ"
            }
        },
        ...
    ],
    "memories": [
        {
            "id": "6afec28a-813e-45f5-8252-46ca7966ac36",
            "text": "Поездок в такси",
            "value": "25"
        },
        {
            "id": "94df80ef-74a3-4710-bb6b-8033df8bf23c",
            "text": "Поездок ночью",
            "value": "10"
        },
        {
            "id": "aacb24ae-bedc-4028-a4f1-e1a97d8725c3",
            "text": "КМ в пути",
            "value": "89"
        },
        {
            "id": "7bc4b240-8507-4e99-a4b4-a57937d14bc5",
            "text": "Поездки на беспилотнике",
            "value": "4"
        },
        {
            "id": "94cc9cae-4de7-4527-af40-ed7a3292213b",
            "text": "Самый активный месяц",
            "value": "Январь"
        }
    ],
    "result": {
        "correct_answers_percent": 60
    },
    "share": {
        "id": "b36f9a03-8769-40d1-a3da-22d62e13920f",
        "correct_answers_percent": 60,
        "chosen_memory_ids": [
            "6afec28a-813e-45f5-8252-46ca7966ac36",
            "94df80ef-74a3-4710-bb6b-8033df8bf23c",
            "7bc4b240-8507-4e99-a4b4-a57937d14bc5"
        ]
    }
}
```

#### `PUT /4.0/ny2020/v1/results`
Ручка для сохранения результатов прохождения теста. Принимает на вход список вопросов и ответов пользователя и возвращает процент правильных ответов.

Пример тела запроса:
```json
{
    "answers": [
        {
            "question_id": "6afec28a-813e-45f5-8252-46ca7966ac36",
            "chosen_answer_id": "dd76f8f9-a8d4-4e33-b07d-179db185380e"
        },
        {
            "question_id": "94df80ef-74a3-4710-bb6b-8033df8bf23c",
            "chosen_answer_id": "1bc60801-865d-4d6b-87f9-ed01b931cfb7"
        },
        {
            "question_id": "aacb24ae-bedc-4028-a4f1-e1a97d8725c3",
            "chosen_answer_id": "ac89b8b4-90a5-4a06-87e1-a84d0299910f"
        },
        {
            "question_id": "7bc4b240-8507-4e99-a4b4-a57937d14bc5",
            "chosen_answer_id": "9d15b6a7-1cc3-4da2-83b8-effb01c3f564"
        },
        {
            "question_id": "94cc9cae-4de7-4527-af40-ed7a3292213b",
            "chosen_answer_id": "9a97a899-b68a-4dff-98e9-0d9b4991e34e"
        }
    ]
}
```

Пример тела ответа:
```json
{
    "correct_answers_percent": 0
}
```

#### `PUT /4.0/ny2020/v1/share`
Ручка для создания расшарки.
Пользователь передаёт ровно три ID *воспоминаний*. Выбранные воспоминания будут использованы для генерации картинки расшарки.

Пример тела запроса:
```json
{
    "memory_ids": [
        "6afec28a-813e-45f5-8252-46ca7966ac36",
        "94df80ef-74a3-4710-bb6b-8033df8bf23c",
        "94cc9cae-4de7-4527-af40-ed7a3292213b"
    ]
}
```

Пример тела ответа:
```json
{
    "share_id": "94cc9cae-4de7-4527-af40-ed7a3292213b"
}
```

#### `GET /ny2020/v1/share?share_id={share_id}`
Ручка для получения инфы публичной расшарки какого-то пользователя.

Пример тела ответа:
```json
{
    "title": "Ладно, проехали",
    "subtitle": "Я помню свой год на",
    "result_percent": 20,
    "memories": [
        {
            "id": "6afec28a-813e-45f5-8252-46ca7966ac36",
            "text": "Поездок в такси",
            "value": "25"
        },
        {
            "id": "94df80ef-74a3-4710-bb6b-8033df8bf23c",
            "text": "Поездок ночью",
            "value": "10"
        },
        {
            "id": "aacb24ae-bedc-4028-a4f1-e1a97d8725c3",
            "text": "КМ в пути",
            "value": "89"
        },
        {
            "id": "7bc4b240-8507-4e99-a4b4-a57937d14bc5",
            "text": "Поездки на беспилотнике",
            "value": "4"
        },
        {
            "id": "94cc9cae-4de7-4527-af40-ed7a3292213b",
            "text": "Самый активный месяц",
            "value": "Январь"
        }
    ]
}
```

#### `GET /ny2020/v1/driver_share?driver_share_id={driver_share_id}`
Ручка для получения публичной расшарки какого-то водителя.

Пример тела ответа:
```json
{
    "memories": [
        {
            "id": "6afec28a-813e-45f5-8252-46ca7966ac36",
            "text": "Получил пять звёзд",
            "value": "25"
        },
        {
            "id": "94df80ef-74a3-4710-bb6b-8033df8bf23c",
            "text": "Поездок ночью",
            "value": "10"
        },
        {
            "id": "aacb24ae-bedc-4028-a4f1-e1a97d8725c3",
            "text": "КМ в пути",
            "value": "9001"
        },
        {
            "id": "7bc4b240-8507-4e99-a4b4-a57937d14bc5",
            "text": "Подвёз старушек",
            "value": "4"
        },
        {
            "id": "94cc9cae-4de7-4527-af40-ed7a3292213b",
            "text": "Самый активный месяц",
            "value": "Январь"
        }
    ]
}
```

### Клиентский Flow
Типовые сценарии использования сервиса выглядят следующим образом

#### Первое прохождение теста из приложения пользователем
Пользователь видит в приложении кнопку "Вспомнить всё хорошее" и нажимает на неё. В приложении открывается webview фронтенда. Фронтенд запрашивает необходимую информацию с бэкенда (`../launch`). Бэкенд возвращает список вопросов и ответов, список *воспоминаний*. 

После получения вопросов и прохождения теста фронтенд отсылает выбранные ответы на бэкенд и получает процент правильных ответов пользователя.

Пользователю предлагается поделиться результатом - выбрать три *воспоминания* которые ему больше нравятся. После выбора пользователя, фронтенд отправляет выбранные *воспоминания* на бэкенд.

Бэкенд генерирует картинку и сохраняет её по заранее определённому урлу (необходимо для встраивания в meta-часть страницы расшарки), делает запись об успешном создании в базе и возвращает ID расшарки фронту. Фронт редиректит пользователя на публичную страницу расшарки.

![image](static/flow/first_app_interaction.png)

#### Для пользователя не подготовлены вопросы
В случае если для пользователя не подготовлены вопросы, фронтенду в ответ на `GET /4.0/ny2020/launch` будет возвращён ответ 404. В этом случае пользователю будет выведена страница-заглушка с текстом в духе "в этом году у нас мало общих воспоминаний".

![image](static/flow/no_questions.png)


#### Повторный переход из приложения пользователем
В случае если пользователь уже прошёл тест, фронтенду в ответ на `GET /4.0/ny2020/launch` также будет возвращен результат прохождения пользователя. Если пользователь расшаривал результат, то также будет возвращена информация о расшарке пользователя (ID и выбранные *воспоминания*). 

![image](static/flow/second_app_interaction.png)


#### Расшарка пользователя
Публичная страница расшарки пользователя содержит в meta-части страницы ссылку на картинку. Ссылка на картинку известна заранее (по ID в адресе расшарки).

При переходе на страницу фронтенд запрашивает из бэкенда *воспоминания* и процент прохождения теста, на основании которых рисует страницу.

![image](static/flow/shared.png)


#### Расшарка водителя
Публичная страница расшарки водителя содержит в meta-части страницы ссылку на созданную заранее картинку.Ссылка на картинку известна заранее (по ID в адресе расшарки).

* __(?) У каждого водителя своя картинка или делаем одну общую?__

При переходе на страницу фронтенд запрашивает из бэкенда *воспоминания*, на основании которых затем рисует страницу.

![image](static/flow/driver_shared.png)


### Мониторинги
Общие для сервиса и для отдельной ручки:
* Ok RPS
    * Количество начавших тест пользователей
    * Количество расшарок
    * Количество просмотров расшарок
* Bad RPS
* Перцентили скорости ответов (95, 99)

### Нагрузка
Нагрузка на все ручки API находится на одном порядке, так как предполагается линейный flow пользователя от действия к действию.

Поскольку единственная точка входа - нажатие на popup в приложении такси, потенциальная пиковая нагрузка соответствует нагрузке на ручку `/launch`, вызываемую при старте приложения.

Предположительная пиковая нагрузка на ручку `/launch` в период новогодних праздников может быть примерно предсказана как пиковая нагрузка в новый год 2018 года, помноженная на коэффициент прироста rps за 2019 год:

```
Средний RPS сейчас (2019-11 w1):            330
Средний RPS год назад (2018-11 w1)          240
Пиковый RPS за NY 2018 (2019-01-01 01:50)  1238

(peak_ny_rps_2018) * (avg_rps_2019/avg_rps_2018)
1238 * (330/240) = 1702.25
```

Следовательно, наибольший потенциально возможный RPS на сервис ожидается чуть меньше чем 2000.

Имхо данный RPS указан с сильным запасом по следующим причинам:
1. **RPS будет стабильно падать** по мере того как люди проходят тест
2. **Пик будет сглажен**. Запуск будет произведён не в момент пика (за неделю или более до нового года), и будет проходиться пользователем только один раз. Люди, прошедшие тест до точки с пиковой нагрузкой не будут создавать нагрузку в момент пика.
3. **Не все будут участвовать**. Заранее неизвестно какому проценту людей будет интересно поучаствовать в нашем новогоднем интерактивчике, но это очевидно будет значение меньше 100%.

### Ожидаемый объём данных для хранения
Для каждого активного пользователя яндкес такси необходимо хранить до 5 вопросов с несколькими ответами и факт расшаривания результатов теста.

При оценке свехру в 1 kb на пользователя и количестве пользователей уникальных пользователей в месяц ~20 миллионов  выходит ~19 Gb. 

На деле объём хранимой информации будет меньше, так как для хранения данной информации нужно меньше 1kb/user

Для хранения этой информации планируется использовать Postgres

### Архитектура
Исходя из предполагаемой пиковой нагрузки сервиса и требований к CPU (создание картинки для расшаривания) сервис следует делать на C++.

#### Используемые компоненты
__HTTP-Service__

Сервис в uservices с нужными ручками. Не ходит в другие внутренние сервисы.


__YT__

Перед запуском сервиса выгружаем данные в базу. Во время работы сервиса в YT не ходим.


__Postgres__

В базе храним информацию о вопросах пользователя, результате прохождения теста и расшаривании результата.


### Критичность
Разрабатываемый сервис никак не влияет на сценарии использования других сервисов яндекс такси.

Критичность: низкая

### Фолбеки
В случае недоступности одного или нескольких зависимых сервисов пользователю будет возвращён ответ HTTP 500, сигнализирующий о временной недоступности сервиса.

### Локализация
Вопросы, *воспоминания*, и некоторые ответы на вопросы нуждаются в локализации. Информация о том для каких вопросов в ответах хранятся значения, а для каких танкерные ключи, будет вынесена в конфиг-файл.

### Танкерные ключи
Текст вопроса:
`ny2020.questions.{QUESTION_ID}.question`

Текст *воспоминания*:
`ny2020.questions.{QUESTION_ID}.memory`

Текст ответа на вопрос:
`ny2020.questions.{QUESTION_ID}.answers.{ANSWER_ID}`

Текст подсказки для типа ввода:
`ny2020.input_types.{INPUT_TYPE}.hint`

Остальные ключи используемые в приложени (фразы и тексты) делает фронт

### Эксперимент
Раскатывать функционал для пользователей будем через эксперимент. Если эксперимент не пришёл в `/launch`, приложение не будет выводить кнопку с переходом на тест.

### Конфиг
Для определения значения поля `input_type` и танкерного ключа для вопросов создаём конфиг `NY2020_EVENT` со следующей структурой
```json
{
    "questions": {
        "q23": {
            "input_type": "checkbox",
            "asnwers_are_tanker_keys": false,
            "tanker_keys": {
                "question": "ny2020.questions.q23.question",
                "memory": "ny2020.questions.q23.memory"
            }
        }
    },
    "input_types": {
        "checkbox": {
            "tanker_keys": {
                "hint": "ny2020.input_types.checkbox.hint"
            }
        }
    }
}
```
### Расшаривание результатов
Пользователь может расшарить свои результаты, пройдя тест и выбрав три *воспоминания*:
* Пользователь выбирает три *воспоминаня* и отправляет их на сервер
* Из базы подтягивается результат пользователя и информация о последней шарке пользователя
    * Если последняя шарка пользователя совпадает с новой (процент ответов и выбранные воспоминания), то просто возвращаем её ID
    * Если последняя шарка не совпадает, то генерируем новый ID и записывает новую инфу в базу, и отправляем STQ-таску на создание новой картинки и загрузке её в MDS по этому ID

#### Генерация картинок
Генерацию картинок следует делать в STQ-тасках чтобы не блокировать флоу пользователя при расшарке: Пользователь сразу получит ссылку на страницу с расшаркой, а картинка для встраивания появится в MDS по заранее заданному адресу в течение наскольких секунд.

Планируется использовать наработки по генерации картинок с прошлого года.
Тикет про генерацию картинки в прошлом году: [TAXIBACKEND-18498](https://st.yandex-team.ru/TAXIBACKEND-18498)

1. Как генерировать картинку?
    * Картинка генерируется путем наложения текста на заранее подготовленные шаблоны;
2. Что получится реюзать с прошлых лет?
    * С прошлых лет получится переиспользовать ничего кроме общего алгоритма решения не получится так как прошлое решение было скостылено в backend-cpp и затем выпилено, а мы будем костылить делать в uservices;
3. Будет ли генериться png или же лучше svg отрендерить?
    * Будет генериться png; svg не подойдет поскольку нужно встраивать в соц.сети и не факт что они из meta подтянут svg-шку, плюс прошлогодний вариант на png и может частично удастся переиспользовать;
4. Как генерировать из плюсов с их нехваткой либ?
    * Подключим либу которая использовалась в прошлом году (cimg_library) или аналогичную, её функционал покрывает необходимые нам кейсы;
5. Какие размеры картинок генерить?
    * Размеры ещё не согласовали;
6. Как генерить, чтобы не убить event loop?
    * В прошлом году картинки вроде генерировались в отдельных worker-тредах, в этом году можно сделать так же;
7. Будут ли реюзаться сгенеренные картинки при повторном шаринге?
    * Если пользователь решит расшарить другие данные, то картинка пересоздатся. В противном случае будет использоваться та же.
8. Где хранить картинки? 
    * Картинки будем хранить в отдельном неймспейсе в mds
9. Как будут картинки отдаваться после того как сервис потушим?
    * После того как сервис потушим можно оставить картинки в mds (но вообще имхо можно и выпилить - сама страница шарки доступна уже не будет всё-равно)


### Декомпозиция задач и оценка

#### I Этап: Тест и шарилка для пользователей
Функционал: 
* Пользовательский флоу: тест, результаты, расшарка в соц.сети

Задачи:
1. [1d] Согласование и утверждение API
1. [1d] Архитектурное ревью
1. [2d] Заведение нового микросервиса
    * Заведение машинки
    * Пробитие "дырок" в панчере
    * Создание "пустого" сервиса в uservices
1. [4h] Моки ручек для получения вопросов пользователя и расшаривания
1. [1d4h] Генерация картинки из результатов теста пользователя
1. [4h] Выгрузка вопросов пользоватлей из YT в DB
1. [1d] Реализация ручек
1. [2h] Добавление ручек и продуктовых метрик в графану
1. [1d] Нагрузочное тестирование ручек
1. [1d] Выкатка в stable и интеграционное тестирование

Итого: 8d 6h


#### II Этап: Публичная шарилка для водителей
Функционал:
* Расшарка для водителей

Задачи:
1. [2h] Мок ручки статистики для водителей
1. [4h] Выгрузка фактов о водителях из YT в DB
1. [4h] Реализация ручки
1. [1d] Добавление ручки и продуктовых метрик в графану
1. [4h] Нагрузочное тестирование ручки
1. [1d] Выкатка в stable и интеграционное тестирование

Итого: 3d 6h

#### III Этап: Депрекация сервиса
Задачи:
* [0h] Выключение эксперимента
* [2h] Выключение сервиса
* [2h] Очистка DB и MDS
* [1d] Удаление проекта из кодовой базы приложения такси
* [1h] Удаление кода сервиса из uservices

Итого: 1d 5h