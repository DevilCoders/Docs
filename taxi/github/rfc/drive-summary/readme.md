# Драйв на саммари

## Продуктовая задача

https://st.yandex-team.ru/TAXIMOBILEDEV-379

Проработка в [Miro](https://miro.com/welcomeonboard/82yLbRaHjEyJegRgYlQpWP5yzocPlUCgTGtb3gJXwHREFKVteFnQdgpmDu2AgkFa)

#### Дизайн

[Фигма](https://www.figma.com/file/W8oInUTbSrUNsH1g8grbDD/Интеграция-Драйва?node-id=3301%3A32812)

![dos](https://jing.yandex-team.ru/files/pavelnekrasov/drive_on_summary.png "Драйв на саммари")

#### Дополнения по дизайну
1. Для незареганных пользователей показываем тариф Драйва с кнопкой 
"Зарегистрироваться" и примерной ценой.
2. Для непортальных пользователей показываем тариф Драйва с кнопкой 
"Войти в аккаунт" и примерной ценой.
3. Для невыбранных машин на карте в баблике рисуется модель машины + цена. 
Для выбранной - просто модель машины.
4. В селекторе тарифов и в селекторе машин Драйва может отображаться иконка 
кэшбэка (аналогично обычным тарифам).
5. При свайпе развернутой карточки тарифа Драйва выполняется переход к следующему тарифу.
В режиме вертикалей выполняется переход в следующую вертикаль.
6. При выборе машины в селекторе машин Драйва или на карте меняются: 
   - цена в общем селекторе тарифов и цена на развернутой карточке 
   - картинка в развернутой карточке Драйва
   - иконка машинки в общем селекторе тарифов (для режима без вертикалей)
   - кэшбэк в общем селекторе тарифов (для режима без вертикалей)
7. В режиме без вертикалей цена Драйва на селекторе пишется без `от`. 

8. Для режима без вертикалей - если Драйв нерелевантен (например, дороже эконома или машина далеко), то 
нужно спрятать тариф Драйв слева от эконома (будет управляться с бэкенда). 
9. В режиме с вертикалями в вертикали Драйва тариф драйва сразу разворачивается 
в селектор машин - т.е. не отображается отдельный тариф `Драйв`. Исключение - 
состояние ошибки: отсутствие машин рядом, плохая точка Б - в таких случаях нужно 
отобразить тариф `Драйв` без цены и сообщением из ответа routestats 
(также как для кейса `Нет доступных машин` в такси).
10. Промо-плашка Драйва теперь сразу переводит в тариф Драйва (TODO нужно проработать на бэкенде)


## Flow

### Общее описание
Данный RFC дополняет и в чем-то дублирует:
https://github.yandex-team.ru/taxi/rfc/pull/568

Добавляем полноценный тариф (категорию) `class: drive`.  
Получаем информацию о тарифе Драйва в zoneinfo. 
Получаем в routestats service_level для Драйва. В service_level добавляется
контекст `layers_context` для хождения в сервис layers при выборе тарифа Драйва в 
селекторе. Из ответа layers получаем список объектов на карте и id-выбранной 
машинки. Также для каждого объекта в layers будет указан элемент селектора 
машин (чтобы выбирать между машинками на карте) и добавляется новый 
экшн `drive_summary_offer`, в котором указаны оверрайды для Драйва в селекторе 
тарифов и для развернутой карточки Драйва. 
По нажатию кнопки Дальше выполняется переход к экрану уточнения точки B для 
машины с открытием SDK. По нажатию `Забронировать` в SDK машина бронируется.

### Изменения в /3.0/zoneinfo
В ответе zoneinfo для элемента max_tariffs появляется новое поле `order_flow`, 
которое указывает на нестандартный способ заказа по тарифу. Наример, для Драйва 
( `order_flow=drive`) -- это:
   - запрос layers для отображения машин на карте 
   - отсутствие точки A в адресах точек 
   - отсутствие маршрута на карте
   - отсутствие пина на карте
   - открытие SDK при бронировании машины. 
   - отсутствие "Комментария водителю" в развернутой карточке 
     (по идее должно регулироваться флагом comments_disabled, 
     но на ios почему-то не так).

Видимость тарифа Драйва настраивается конфигами видимости тарифов.


Также добавляется новый `zone_mode=drive`, чтобы можно было переопределять стили 
для карты в режиме Драйва (приходит в списке zone_modes).

В остальном тариф Драйва ведет себя как полноценный тариф такси. 
У Жени в https://github.yandex-team.ru/taxi/rfc/pull/568/files#diff-9f84b67fc6de24c2ca1030cb6792ebe9R30 
хорошо описана мотивация отдельного тарифа Драйва. 

### Изменения в /3.0/routestats

В routestats расширяется запрос и элемент `service_levels` из ответа.

#### Расширение запроса
Для того, чтобы ходить за офферами Драйва нам нужна дополнительная информация 
в запросе routestats:
1. Координаты пользователя (если они есть). Нужны для того, чтобы посчитать 
время бесплатного ожидания машины на стороне Драйва.
2. Короткий адрес точки B (например: `Садовническая улица, 82с2`) - нужен для 
того, чтобы этот адрес пророс в карточку оффера Драйва.

Для этого добавляем в запрос routestats поле `state` (аналогичное ручкам саджеста).
Нужны минимум два поля `location` и `fields` из `state`:
```json5
{
  ...,
  "state": {
    "location": [37.5, 55.5], //опциональное поле 
    "fields": [
      {
        "type": "a",
        "title": "Ленинский проспект, 10", //новое поле state.fields[]
        "position": [37.1, 55,1],
        "log": "xxxx"
      },
      {
        "type": "b",
        "title": "Садовническая улица, 82с2", //новое поле state.fields[]
        "position": [37.3, 55,3],
        "log": "xxxx"
      }
    ]
  },
  ....
}
```
Остальные поля из саджестового state необязательно добавлять. 
Поле `title` в элементе state.fields - 
новое поле, которое соответствует `title` из ответа finalsuggest для адреса.

Стоит отметить, что `state.fields[]` в чем-то дублирует список `route` из запроса routestats.
Но, к сожалению, список `route` нерасширяемый, поэтому лучше указать филды 
отдельно в state.


**Опционально**. Также предлагается добавить в `tariff_requirements` выбранную 
на текущий момент машину Драйва - если пользователь явно перешел на тариф Драйва  - то есть  клиент
 сходил в слои и пользователь увидел машинку Драйва на карте. Это нужно для того, чтобы при повторном 
запросе `routestats` пользователю вернулась выбранная машина. Если 
выбранная машинка стала забронирована, то бэкенд просто не будет учитывать пожелание.

```json5
{
  "tariff_requirements" : [
    {
      "class": "drive",
      "requirements": {
        ... 
      },
      "drive": {
        "selected_car_number": "а123бв",
      }
    }
  ]
}
```
После выхода из саммари `selected_car_number` сбрасывается.

Возможно не очень хорошая идея делать выбранную машину в tariff_requirements.

#### Расширение элемента service_levels[] из ответа
Элемент списка `service_levels` расширяется полями:
 1. `layers_context` - контекст для хождения в layers (аналогично промо-плашке  
 и шорткату Драйва). Подробное описание доработок в layers приведено дальше.
 2. Список `offer_ids` - список офферов для данного класса. Для драйва варятся 
 отдельные офферы (по одному на каждую тачку), поэтому для каждого класса 
 Драйва может быть свой список офферов. Этот список нужен для того, 
 чтобы прокидывать его в ручку промо-плашки на саммари в поле `summary_state` 
 (описание будет дальше).
 3. Полем `selector`, в котором может быть переопределена иконка `icon` для селектора 
 и указан флаг `is_hidden=true`, который прячет категорию в селекторе тарифов. 
 Селектор выравнивается таким образом, чтобы все категории с флагом `selector.is_hidden: true` 
 были спрятаны слева от первого видимого тарифа (см. как в дизайне).
 Если получилось так, что между двумя категориями, у которых `is_hidden=false` и 
 `selector.is_hidden=false` оказалась категория с  `selector.is_hidden=true`,
  то флаг `selector.is_hidden=true` игнорируется.
  
```json5
{
  ...,
  "service_levels": [
    {
      "class": "drive",
      ...,
      "selector": {
        "is_hidden": true,
        "icon": {
          "tag": "class_drive_car", // <- нужно поддержать (новая функциональность) 
          "url": "https://tc.tst.mobile.yandex.net/static/test-images/598/e91511b5-6f70-456b-b21d-57e29ebb6b1f",
          "size_hint": 390,
          "url_parts": {...} //надо ли?
        },
        "image": { // <- переопределяет большую картинку тарифа
          "url": "https://tc.tst.mobile.yandex.net/static/test-images/598/e91511b5-6f70-456b-b21d-57e29ebb6b1f"
        }
      },
      "drive_extra": {
          "layers_context": {
            "dst": [
              10.1,
              20.2
            ],
            "offer_count_limit": 0,
            "preferred_car_number": "т577нх799",
            "src": [
              37.1,
              55.2
            ],
            "type": "drive_fixpoint_offers",
            "previous_offer_ids": ["offer_1", "offer_2"],
            "summary_tariff_class": "drive"
          },
          "offer_ids": ["offer_1", "offer_2"],
          "offer_id": "offer_1", //<- указывается для фолбэка в случае неответа layers
          "car_number": "т577нх799" //<- указывается для фолбэка в случае неответа layers
      },
      ...
    },
    ...
  ]
}
```    
  
Если рядом нет машин Драйва или в точке `B` нельзя оставить машины, 
то приходит service_class с сообщением:
```json5
    {
      "is_hidden": false,
      "class": "drive",
      "selector": {
        "is_hidden": true
      },
      "name": "Драйв",
      "service_level": 40,
      "tariff_unavailable": {
        "message": "Нет доступных машин рядом",
        "code": "drive_no_cars"
      }
    }
```

Если пользователь не зареган в Драйве, то приходит service_class с сообщением:
```json5
    {
      "is_hidden": false,
      "class": "drive",
      "selector": {
        "is_hidden": true
      },
      "name": "Драйв",
      "service_level": 40,
      "tariff_unavailable": {
        "message": "Зарегистрироваться",
        "code": "drive_not_registered"
      },
      "description_parts": { 
        "prefix": "",
        "suffix": "",
        "value": "~194 $SIGN$$CURRENCY$"
      },
    }
```

Если пользователь непортальный, то приходит service_class с сообщением:
```json5
    {
      "is_hidden": false,
      "class": "drive",
      "selector": {
        "is_hidden": true
      },
      "name": "Драйв",
      "service_level": 40,
      "tariff_unavailable": {
        "message": "Войдите в аккаунт",
        "code": "drive_not_portal"
      },
      "description_parts": { 
        "prefix": "",
        "suffix": "",
        "value": "~194 $SIGN$$CURRENCY$"
      },
    }
```
  
В зависимости от кода ошибки клиент должен выполнить соответствующее действие.
  
Коды ошибок:
`drive_bad_dst` - точка B вне зоны, где можно оставить машину.
`drive_no_service` - сервис Драйва недоступен
`drive_not_portal` - непортальный аккаунт
`drive_not_registered` - нет регистрации в Драйве
`drive_active_order` - есть активный заказ в Драйве
`drive_bad_payment_method` - некорректный способ оплаты (пока только карта поддерживается)

  
### Расширение запроса /4.0/inapp-communications/promos-on-summary
В запрос promos-on-summary добавляются идентификаторы офферов, которые лежат в списках 
`service_levels[].offer_ids` (если они есть)
```json5
{
  "summary_state": {
    "offer_id": "taxi_offer_id",
    "service_levels_offers": [
      {
        "class": "drive",
        "offer_ids":  ["offer_1", "offer_2"]
      },
      ...
    ],
  }
}
```

Список `service_levels_offers` нужен для того, чтобы в промо-плашке Драйва использовать 
те же офферы, которые сгенерились в ручке `routestats`, иначе цены могут отличаться.

*Примечание. Почему не использовать плоский список drive_offers?. Потому что 
может появиться другой тариф Драйва, например, `drive_cargo` и плоский список 
офферов будет некорректен.*


### Изменения в /4.0/layers/v2/objects

#### Запрос в layers
В запросе layers указываются `mode: drive`, `screen: summary` и 
`context=routestats_response.service_levels[].layers_context`.

Если выбран тариф Драйва в селекторе и выполняется перезапрос routestats, то
 нужно зашиммерить селектор машин Драйва и перезапросить layers с контекстом 
 из ответа routestats. Если в ответе `routestats` не оказалось `layers_context`,
 то в кнопке отображается ошибка из ответа `routestats`. 

**Опционально**. Получив ответ `routestats`, можно сразу сделать prefetch ответа 
layers, чтобы при открытии тарифа Драйва не ждать ответа `layers`.


#### Новое поле selector_item

В объекте на карте добавляется новое поле `selector_item`, которое отвечает 
за отображение элемента в селекторе объектов на карте (в данном случае селектор машин на саммари):
```json5
{
  "type": "Feature",
  "id": "drive_123",
  "geometry": {...},
  "properties": {
    "display_options": {...},
    "style": {...},
    "selector_item": {
      "type": "summary",
      "base_service_level_class": "drive", //<- базовый класс, от которого нужно множить тарифы
      "service_level_overrides": {
        "class": "drive_х1234", // <- для выбранной машинки указывается просто drive, чтобы работал редирект
        "brandings": [
          {
            "title": "Кэшбээк",
            "tooltip": {
              "text": "кэшбээк"
            },
            "type": "cashback",
            "value": "9"
          }
        ],
        "description": "Поездка 74 $SIGN$$CURRENCY$, ~8 мин",
        "description_parts": {
          "prefix": "",
          "suffix": "",
          "value": "74 $SIGN$$CURRENCY$"
        },
        "estimated_waiting": { // <- время пешком
          "message": "~9 мин пешком",
          "seconds": 540
        },
        "name": "Kaptur",
        "selector": {
          "icon": {
            "tag": "class_drive_icon_7"
          },
          "image": {
            "url": "https://carsharing.s3.yandex.net/drive/car-models/renault_kaptur/renault-kaptur-side-2-kaz_large.png"
          }
        },
        "subtitle": "16 мин бесплатного ожидания", //<- subtitle в кнопке
        "title": "Дальше",
        "drive_extra": {
          "offer_id": "offer_1",
          "car_number": "x123yz",
          "layers_object_id": "drive_123" // <- id-объекта, к которому привязан этот selector_item
        }
      }
    },
    ...
  }
}
```
Механика селектора следующая. Из ответа layers достаются элементы селектора объектов - 
берутся `selector_item` из объектов по-порядку объектов. Полученный селектор отображается на экране.
Выбранный объект на карте должен быть синхронизован с селектором, т.е. при 
изменении положения селектора, изменяется выбранный объект на карте и наоборот.

Тип селектора `type: summary` определяет отображение селектора. Для `type: summary` 
стиль - такой же как селектор тарифов на саммари. Селектор для саммари содержит:
  - оверрайды для service_level-а из routestats


#### Эшкн drive_summary_offer
Экшн `drive_summary_offer` отвечает за отображение карточки оффера Драйва.
Экшн содержит:
  - информацию об оффере Драйва: номер машины и айди оффера.

```json5
{
  "type": "drive_summary_offer",
  "service_level_class": "drive_x1234"
}
```

#### Экшн walk_route
Экшн `walk_route` отвечает за построение пешего маршрута до объекта (от точки Я)
Экшн содержит:
  - информацию об оффере Драйва: номер машины и айди оффера.

```json5
{
  "type": "walk_route",
  "dst": {
    "position": [37.5, 55.5] //<- точка, до которой построить пеший маршрут (совпадает с положением объекта, нужно для совместимости)
  }
}
```

#### selected_components для бабла
Хочется иметь разный текст для обычного и выбранного бабла.
Для этого добавляется список `selected_components` для бабла, который 
задает список компонент для выбранного бабла. Если `selected_components` не 
задан, то для выбранного состояния используется `components`.
```json5
"bubble": {
  "id": "drive_car_bubble",
  "components": [
    {
      "type": "text",
      "value": "Mercedes"
    },
    {
      "type": "text",
      "font_style": "bold",
      "value": "100 ₽"
    }
  ],
  "selected_components": [ // <- новое поле
    {
      "type": "text",
      "value": "Mercedes"
    }
  ],
  ...
},
```



#### Поведение в случае неответа ручки layers
Если layers не ответил после нескольких запросов, то нужно отобразить 
задизэйбленную кнопку "Ошибка хххх" (TODO) и убрать цену в селекторе тарифов
  для Драйва.

#### Поведение в случае пустого ответа ручки layers
Если layers ответил пустым списком машин, то нужно отобразить в кнопке ошибку 
из ответа layers (optimal_view.no_objects_message, optimal_view.no_object_subtitle) 
и убрать цену из селектора тарифов для Драйва.


#### Фокусировка

1. Без гео-локации - на выбранной машинке
2. С гео-локацией - на пешем маршруте о точки (Я) до машинки

### Экран выбора точки B на саммари
Экран такой же, как для обычных тарифов. Текст под адресом берется из 
`description` service_level-а (`"description": "Поездка 194 $SIGN$$CURRENCY$, ~20 мин"`).


### Экран уточнения точки B для оффера Драйва
После нажатия `Дальше` для оффера Драйва нужно открыть экран уточнения точки B.
Если юзер сам сдвигает пин, то нужно перезапросить оффера драйва через SDK 
(поведение аналогично дискавери режиму).

## Раскатка
Заводим бэкендовский эксперимент `drive_summary`, который проверяется в 
сервисе `routestats`. Если `drive_summary` выключен, то тариф Драйва присылается 
как `is_hidden: true`. 

Не хочется настраивать видимость тарифа в конфигах-3.0 для видимости (tariff-visibility-helper),
 т.к. хотим раскатывать тариф Драйва в A/B.  



