# Что
Выносим очередь `send_report` из backend (py2) в отдельный сервис. Текущая нагрузка - примерно 100 tasks/sec

# Зачем
Потому-что ~старый код это помойка~ сейчас в коде сложно делать доработки и его сложно поддерживать

# Как

## TODO
Надо изучить код stq-шки в старом бекенде и составить список всего функционала который сейчас поддерживается. Весь функционал надо будет перенести в новый сервис, предварительно отрефакторив его таким образом чтобы не было такого спагетти как в старом бэкенде.

Также надо разобраться как это лучше (понятнее) абстрагировать. Текущая идея: есть шаблоны отчётов, нужный шаблон однозначно выбирается по каким-то параметрам, после чего для него получаем все необходимые параметры и создаём из него отчёт.

## Цели
* Есть админка - загрузка новых шаблонов, валидация шаблонов, список доступных для шаблонов параметров
* Доступные для шаблонизации параметры задокументированы
* Локализация и получение данных - раздельные шаги
* Запрашиваются только те данные, которые нужны для выбранного шаблона
* Можно легко определить, какой отчёт (шаблон) должен придти для конкретного заказа (через ручку для админки?)
* Можно легко определить по каким условиям выбирается конкретный шаблон
* В случае если отсутствуют какие-либо из необходимых параметров - сигнализировать (алерты?)
* Независимое указание языка для отчетов и вложений (привет, Латвия)


## Где заводим сервис
В backend-py3. Нагрузка небольшая, а переносить легче с питона на питон

## Скоуп сервиса
Формирование и отправка отчетов о поездках после их завершения

## Источники данных
Сервис использует данные из кучи разных баз, хождение в них переносим напрямую если они не закрыты за каким-либо сервисом

## Флоу

Темплейт - шаблон для формирования отчёта о поездке
Мутаторы - переменные и данные, на основании которых выбирается нужный темплейт для отчёта

1. __Получение мутаторов__: Конечный вид отчёта на почту (внешний вид, приложения, etc) зависит от некоторых переменных. Например, версия приложения, страна, настройки пользователя. Все переменные, изменяющие структуру итогового отчёта, должны быть получены в начале работы

2. __Выбор темплейта__: Используя мутаторы, выбираем нужный шаблон

3. __Получение нужных параметров__: Определишвись с темплейтом, получаем список нужных параметров. Запрашиваем нужные параметры из их источников

4. __Локализация параметров, получение ключей__: Локализуем все полученные параметры и ключи для указанного языка

5. __Формирования отчёта__: Используем темплейт и локализованные параметры для формирования отчёта и вложений

6. __Отправка отчёта__: Отправляем сформированный отчёт на почту
