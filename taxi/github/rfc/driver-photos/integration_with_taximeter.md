# Интеграция с таксометром

## Общая информация

В таксометре есть функционал для загрузки/отображения фото водителя. 
На бэке таксометра хранятся фото водителей (в редисе) по park_id и driver_profile_id. 
Данные фото отображаются в диспетчерской и у самого водителя.
Если один водитель подключен к разным паркам, у него будут разные фото.

### Задача

Полностью отказываемся от хранения фото водителей на бэке таксометра. 
Вся обработка фоток будет происходить в сервисе driver-photos 
(единая точка хранения фотографий водителей).

**Как хотим сделать**

При обсуждении с таксометром пришли к варианту, 
 что будем проксировать запросы по обработке фото из бэкэнда таксометра в сервис driver-photos.
 Данное решение требует доработку бэка таксометра и сервиса driver-photos.
 
### Текущая реализация

**Таксометр:**

На бэке таксометра есть ручка для работы с фото водителя (GET и POST),
 также через эту ручку могут загружаться фото авто.
[API ручки](https://github.yandex-team.ru/taxi/backend-cpp/blob/27d20dcf39509a67ab55aa6c6fb1bcf4b0cb708a/parks/docs/yaml/driver_profiles_photo_remove.yaml#L16-L15)   
Фото загружаются в MDS(namespace=taximeter) и после этого сохраняются в рэдис по
park_id и driver_profile_id. Из-за чего у одного водителя в разных парках, может быть несколько фото.

**Driver-photos:**

Фото водителей хранятся по unique_driver_id. 
На данный момент загрузка фото происходит через админку. 
Имеются фотографии только для водителей премиум классов, 
данные фотографии отображаются пользователям при поездке и никак не пробрасываются в таксометр.

Также у фото есть статусы:

* approved
* rejected
* new
* error

Фото водителя показывается пользователю, только если находится в статусе `approved`

**Отображение фото в диспетчерской:**
    
> todo

---

## Этапы:

1. Только загрузка фото в сервис driver-photos (ручка из таксометра, скрипт загрузки всех существующих фото, приоритеты).
2. Отображение фото в таксометре и в диспетчерской из сервиса driver-photos.
3. Отображение статусов в клиенте таксометра, отправка уведомлений водителю после изменения статусов.


## Доработки:

### Таскометр

1. Ручка загрузки фото  [(реализация)](https://github.yandex-team.ru/taxi/backend-cpp/blob/fd247da96b1239bacb7ea0d4f0e83c08cc3f6732/parks/src/handlers/driver_profiles/photo.cpp#L183).

    Первый этап: добавляем загрузку фото в сервис driver-photos. Если загрузка зафейлилась игнорируем это.
    Загрузку в рэдис остается. Оставляем загрузку в MDS на стороне таксометра, в ручку driver-photos передаем ссылку на фото.
    
    Второй этап: после переноса всех фото в сервис driver-photos, отключаем загрузку в рэдис и начинаем обрабатывать ошибки загрузки
    от сервиса driver-photos.  
    
    Для того что бы избежать лишней нагрузки на CPU и DOS атаки, нужно продумать возможность ограничивать водителя загружать более X фото за промежуток времени Y.
    Проверяем сколько фото в таблице за последнее время (например 1 день) и если больше (например 5), не даем больше загрузить фото.
    Либо вообще не давать загружать фото пока старое находится на модерации.
    
2. Ручка получения фото [(реализация)](https://github.yandex-team.ru/taxi/backend-cpp/blob/fd247da96b1239bacb7ea0d4f0e83c08cc3f6732/parks/src/handlers/driver_profiles/photo.cpp#L264).
    
    Вместо похода в редис, ходим в сервис driver-photos. Если сервис не доступен, фото не будет отображаться в клиенте таксометра.
    
### Driver-photos

1. Ручка для загрузки фото из таксометра.

    Данная ручка получает на вход ссылку на фото (MDS namespace=taximeter), park_id и driver_profile_id,
    после чего ставится stq таска, которая обрабатывает(обрезает) фото, загружает фото в MDS и сохраняет запись в базу со статусом `needs_moderation`.
    Далее фото с данным статусом проходят модерацию в Толоке.
    
     ```
    POST /driver-photos/v1/photos/upload_mds?idempotency_key=
    
    {
        park_id: 
        driver_profile_id: 
        mds_photo_path: 
    }
    ```
   
    По переданным параметрам park_id и driver_profile_id вычисляется unique_driver_id(через сервис unique-drivers) и записывается в базу.
    Расширяем таблицу driver_photos, добавляем новые колонки: park_id и driver_profile_id
    
    Возможные технические ошибки в ручке:
    * не смогли поставить stq таску - показываем ошибку, просим повторить загрузку позже (редкий кейс)
    
    Возможные технические ошибки в stq:
    * не удалось получить unique_driver_id для park_id и driver_profile_id - записываем статус error, некорректные данные.
    Разбираемся из-за чего вообще такое произошло, рестартим скриптом процесс обработки для таких фоток (скрипт нужно написать)
    * сервис unique-drivers недоступен - фейлим таску, что бы повторно перезапустить, года сервис заработает - таска выполнится
    
2. Ручка для получения фото водителя в таксометре.

    Таксометр ходит в данную ручку для получения фото и отображения его в таксометре. 
    В сервисе(driver-photos) уже есть ручка с подобным функционалом([GET /driver-photos/v2/photos](https://github.yandex-team.ru/taxi/backend-py3/blob/64659d63f06cb8eb8d1115ea7077f6875359d361/taxi-driver-photos/taxi_driver_photos/docs/api/driver_photos.yaml#L63)),
    но получение фото происходит по unique_driver_id (используется для отображения фото в клиентском приложении и в админке).
    
    Варианты реализации:
    
    i. Оставляем одну ручку, которая отдает фото либо по unique_driver_id, либо по связке park_id, driver_profile_id.
    В таком случае не понятно как правильно передавать параметры.
    
    ii. Делаем новую ручку, которая возвращает фото по park_id и driver_profile_id. 
    Данный вариант кажется наиболее правильным.
    Лучше явно разделять ручки, с разной логикой получения фото и разными параметрами.
    
3. Приоритет фото

    В сервисе есть возможность загружать фото через админку. 
    Данные фото получаем для водителей премиум классов, когда их специально фотографируют в центрах. 
    Такие фото должны считаться приоритетными и не должны затираться при загрузке новой фотки водителем.
    
    Для того что бы отличать фото из админки и из таксометра, добавляем новое поле `priority` 
    (admin, taximeter)

    Варианты:

    i. Запретить загрузку фото из таксометра если есть фото из админки, и всегда отдавать это фото.
    Можно обойтись без доработки клиента, и отправлять ошибку на запрос загрузки фото. 
    
    ii. Разрешить загрузку, но для пользователей всегда отдавать фото из админки, а водителю последнюю загруженную
    
    - думаю что вариант i наиболее правильный. 
   
**Открытые вопросы с возможными вариантами решения:**
    
_Как таксометр будет отображать ошибки при загрузке фото?_
* Показываем окно с текстом (сервис временно не доступен, попробуйте позже)

_Если фото не прошло модерацию в толоке, как уведомляем водителя?_
_Если фото было некорректное и загрузка зафелилась в сервисе driver-photos, как уведомляем водителя?_
* Отправляем пуш с причиной что не так
* Выставляем статус error и причину, добавляем возможность отображать статусы в таксометре.
Нужна доработка API для прокидывания причины ошибки.
* Андрей предложил: Отображать статус обработки в таксометре можно через экран диагностики (требуется доп. доработка)

_Если фото не прошло модерацию в толоке, но водитель утверждает что фото нормальное?_
* Нужен ручной ацепт из админки
* Повторная модерация в толоке

_Фото с каким статусом отдаем в таксометр?_
* С любым, но лучше еще как то отображать статус в интерфейсе, что бы водитель знал что фото подтверждено или находится на модерации
    
_Если водитель загружает новое фото, а у него есть старое (продумать для каждого статуса)?_ 
* Старое approved - новое фото уходит на модерацию, после модерации отображаем новое, до этого старое.
* Старое НЕ approved  - для старого фото выставляем статус (rejected), новое фото отправляем на модерацию.
(учесть возможность гонок, если фото ушло на модерацию, мы поменяли ему статус, после чего пришел новый статус из Нирваны)

### Ручка получения фото для диспетчерской

Как я понял нужна балкавая ручка которая на вход получает park_id и возвращает фото всех водителей в данном парке.

> todo

### Перенос текущих фото

Написать скрипт, который выгрузит все фото из бэка таксометра и загрузит их в сервис driver-photos.
Это нужно делать после включения загрузки фото из таксометра. Учесть что в таксометре, много фоток (загружаем чанками с таймаутами)

---

## Задачи
 
 1. Проксируем загрузку фото водителей из таксометра в сервис driver-photos. `3d`
 2. Доработки в driver-photos для приоритизации фото. `2d`
 3. Ручка для отдачи фото водителя в таксометр. `1d` 
 4. Дорабатываем бэк таксометра для получения фотографий из сервиса driver-photos, а не из редиса. `2d` 
    4.1. Включаем постепенно, смотрим на нагрузку, возможно что-то не учтем и придется допиливать. `2d` (на доработки)
 5. Перед тем как перейти на показ фото из driver-photos, нужно выгрузить все текущие фото из таксометра в driver-photos. `3d`
 6. Ручка получения фото для диспетчерской + поход в данную ручку (пока что не знаю где она используется). `3d`
 7. Документация. `1d`

 8. Добавить метрики и настроить алерты, без этого нельзя включать `2d`
    8.1 Метрики на загрузку фото из таксометра
    8.2 Информация по фоткам, которые модерируются в Нирване
    8.3 Ошибки на ручке получения фото из сервиса driver-photos
