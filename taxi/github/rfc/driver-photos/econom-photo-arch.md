## Процесс TO BE
- Водитель фотографирует себя в Таксометре
- Фото попадают в driver-photos в статусе "На модерации". При этом они сразу обрабатываются (поиск лица и кадрирование). Не прошедшие кадрирование (в том числе те фото где нет лица или где пропорции совсем не подходят) сразу получают статус "отклонено".
- Периодически (не реже чем раз в сутки), фото на модерации попадают в Толоку, где их модерируют толокеры. Периодичность надо будет выбрать такую, чтобы с одной стороны задания в Толоке не оказывались слишком маленькими, а с другой - фото модерарировались оперативно.
- Если Толока не доступна по каким-то причинам то модерация задерживается на время недоступности.
- Если фото прошло модерацию - оно получает статус approved и начинает показываться в клиентском приложении
- Если фото не прошло модерацию - отправляем водителю сообщение об этом в Таксометр с просьбой еще раз сфотографироваться и причиной неудачной модерации. В дальнейшем можно будет применять другие методы мотивации вплоть до блокировки.
- Время жизни фото пока считаем неограниченным. 
- Если у водителя есть фото с повышенного тарифа (подразумеваем что оно выше качеством), то оно имеет приоритет.

## API
### POST /driver-photos/v1/moderation/get_bulk
Ручка получения всех фото для процесса в Нирване. Берет фотографии в статусе NEED_MODERATION, проставляет им статутус ON_MODERATION и возвращает их в ответе. Если фотографии зависнут в статусе ON_MODERATION, то будет джоб, который их вернет в статус NEED_MODERATION, и они заново попадут в Нирвану.
 
 Получает на вход:
 - max_photos (максимальное число запрашиваемых фотографий)
 
 На выходе - список элементов состоящих из:
 - ссылка на mds фотографии водителя
 - photo_name (по этому идентификатору дальше возвращаются статусы)
 - unique_driver_id (сверка в ДКВУ)
 - park_id 
 - driver_profile_id (это и park_id нужно для логирования в Нирване и более точного определения водителя)

### POST /driver-photos/v1/photos/upload_mds
Старая ручка для сохранения фотографий из Таксометра. Фотографии сохраняются в статусе NEED_MODERATION. По идентификаторам из Таксометра определяется unique_driver_id. Учитывать priority (admin/taximeter).
  
В ручке нужно добавить входные параметры:
- park_id
- driver_profile_id

### POST /driver-photos/v1/photos/set_status
Ручка проставления статусов фотографий после модерации. Вызывается процессом в Нирване.
Ручка возвращает массив статусов фотографий:
- photo_name
- status (APPROVED/REJECTED)
- reason (если REJECTED) 
  - bad_foreshortening
  - bad_quality
  - face_not_visible
  - foreign_objects
  - need_biometry
  - no_person
  - not_in_driver_seat
  - rotation
  - several_persons
  - wrong_person

### POST /photos/set (существующая ручка Таксометра)
Ручка Таксометра отправляет фотографию водителя в ручку /driver-photos/v1/photos/upload_mds

### Диаграмма статусов
NEED_MODERATION -> ON_MODERATION -> APPROVED/REJECTED (с причиной)

## Доработки
### Этап 1
- 2d cpp Доработка ручки /photos/set чтобы она кроме записи фото в Редис Таксометра отправляла его в driver-photos. Важно сделать так чтобы надежность и тайминги ручки почти не изменились.
- 0.5d py3 Проверка, если есть уже фото и водитель ездит по повыш. тарифам — не загружать новую фото
- 1d py3 Ручка получения всех фото для процесса Нирваны
- 0.5d py3 Ручка проставления статуса фото из процесса Нирваны
- 3d Процесс в Нирване
- 1d py3 Мониторинги + графики
- 2d Тестирование + отладка процесса целиком
- 3d скрипт перкачки фотографий из Таксометра в driver-photos
- 2d джоб возвращения фотографий, зависших в статусе ON_MODERATION, в статус NEED_MODERATION

Итого: 15d

### Этап 2
- ?d Интерфейс ручной модерации фото в админке
- ?d Отправлять пуши о прохождении модерации/отклонении

## Интегарция с Толокой
Предлагается сделать модерацию через Нирвану, потому что этот механизм уже работает в ДКК => ниже риски. Минусы - задача в Нирване будет периодческая, поэтому модерация всегда будет проходить с задержкой. В проекте Нирваны:
- Получаем в driver-photos через отдельную ручку те фото, которые должны быть отправлены на модерацию
- Создаем новый проект в Толоке по шаблону со всеми фото для модерации
- После получения результатов - загружаем статус обработки фото (отклонено/одобрено) обратно в driver-photos

## Открытые вопросы
- Можно ли модерировать фото водителей (перс данные?) через Толоку?
- Кто будет модерировать вручную?
- Как мотивировать водителей фотографироваться?
- Что делать если много фото подряд не проходят модерацию?
