**Название сервиса**

signalq-billing

**Какую продуктовую проблему решает сервис?**

Формирование выплат за услуги предоставления камер паркам


**Почему нельзя решить эту задачу без разработки нового сервиса существующими решениями?**

Необходимо реализовать специализированную бизнес-логику по формированию выплат, которая использует данные по камерам (такие как активность работы камер для конкретного парка). Данный процесс достаточно важен, поэтому необходимо изолировать его от других сервисов Signalq.


**Как именно сервис будет решать поставленные перед ним задачи?**

1. Создаются продуктовые конфиги, описывающий необходимые параметры для алгоритма формирования выплат конкретного парка
2. В сервисе крутится периодичная таска, которая достает из YT данные о активности камер в парках -> создает выплаты паркам 1 раз в определенный период (описывается конфигом) путем запуски stq таски. В случае успешного проставления в бд signalq_billing пишется статус 'created'

**Разрабатывается один сервис или система?**

Один сервис.

**С кем взаимодействует сервис?**

1. С billing-orders - для создания выплат
2. С YT - для взаимодействия с репликой status_history, для формирования данных об активности камер

**Какие базы использует?**

Новую базу postgres - signalq_billing

**Какие периодические процессы?**

DistLock таска, которая достает из YT данные о активности камер в парках и создает stq раз в определенный период, которая создает выплаты паркам

**Планируется обработка персональных данных**

Нет

**Какие данные и по какой схеме сервис будет хранить в базе?**

park_id,
device_id,
payment_progress: ENUM['not_created', 'in_progress', 'created'],
created_at,
updated_at

В данной табличке будут храниться статусы о статусе создании выплат в биллинге. Эта табличка нужна для синхронизации запусков периодической таски (потому что в течение дня она будет запускаться несколько раз, для того чтобы проверять, смогли ли завестись платежки или нет, в случае чего заново ставить stq таски)

**Какой объем данных будет храниться и какой объем будет изменяться в единицу времени?**

Меньше 1 GB, размер изменяется линейно пропорционально кол-во партнеров, использующих signalq, и числу дней между выплатами.

**Какие операции над данными заложены?**

CRUD

**Есть ли какой-то стейт в памяти, как он обновляется и валидируется?**

Нет.

**Какая нагрузка ожидается?**

Нагрузка будет идти только от периодеческого(-их) процессов.
В среднем 1 запуск ожидается, что будет выполняться за час (большую часть времени уходит на процессинг YT таблички), если времени будет уходить больше, то делегируем подсчеты на другую периодическую таску. 

**Какие фолбеки предусмотрены на сам этот сервис?**

В случае, когда сервис не доступен в день создания выплат:
1. Если сервис недоступен менее 1 дня - выплаты формируются по факту восстановления работы сервиса.
2. Если сервис длительно недоступен - формируем выплаты вручную.

**Какие фолбеки предусмотрены внутри этого сервиса на взаимодействие с другими сервисами?**

Если недоступно 1 из (billing-orders, YT, Postgres) - не создаем выплаты.

**Какие возможности масштабируемости закладываются?**

Увеличение ram/cpu на инстансе, увеличение количества инстансов сервиса.

**Какие точки отказа есть в сервисе?**

Отказ billing-orders, YT, pg

**Укажите ключевые продуктовые метрики сервиса, за которыми планируете следить**

- Количество сформированных выплат, в будущем количество сформированных транзакций по отдельным камерам 

**Укажите технические метрики**

- Количество сформированных выплат
- Среднее время получения данных о камерах из YT
- Время работы периодической таски

**Какая функциональность ожидается в сервисе в будущем?**

1. Формирование транзакций по сущностям - камера
2. Усложнение логики формирования выплат

**Какое изменение нагрузки планируется?**

Прямо пропорционально количеству партнеров и количеству камер.

**Активно ли будет изменяться сервис?**

Будет усложняться логика выплат
