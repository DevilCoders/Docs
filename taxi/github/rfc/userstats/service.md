## Опросник для ревью комитетом

**Название сервиса**

user-statistics

**Какую продуктовую проблему решает сервис?**

Сервис позволит гибко настраивать условия в сериях промокодов. Например, выдавать промокоды на первые поездки по тарифу "Доставка" со способом оплаты "Корпоративный аккаунт". Это позволит продвигать новые тарифы/способы оплаты.

**Почему нельзя решить эту задачу без разработки нового сервиса существующими решениями?**

В настоящий момент есть статистика числа заказов только по тарифам в сервисе userstats.

Причины, по которым лучше завести новый сервис, чем дорабатывать существующий:
- он написан на базе более неподдерживаемого backend-cpp
- новый сервис будет раскатываться в облако, тем самым закроется вопрос "переезда" в облако (текущий сервис катится на железо)
- структура хранения документов в mongo сложна для расширения (добавления новых разрезов в данные)
- в любом случае нужно проводить миграцию историчных данных по заказам

**Как именно сервис будет решать поставленные перед ним задачи?**

Подробное описание есть в [проработке](proposal.md).

**Разрабатывается один сервис или система?**

Один сервис.

**Сколько и какие сервисы входят в систему?**

Сервис user-statistics.

**С кем взаимодействует сервис?**

Основной потребитель - сервис coupons. Получает информацию о количестве поездок пользователя для того, чтобы не допускать фрод при использовании промокодов.

Еще один потребитель - сервис `taxi-adjust`, который отсылает события в adjust, если была совершена первая поездка по тарифу.

Запись данных происходит в STQ-таске. STQ гарантирует, что задача рано или поздно будет выполнена.

**Какие базы использует?**

Для хранения данных требуется БД postgres, в которой будет храниться статистика числа поездок пользователей.

**Какие периодические процессы?**

Очистка устаревших данных.

**Прикрепите схему того, где этот сервис находится в текущей инфраструктуре**

Цикл заказа аффектит только по части использования промокодов. Потребитель - сервис coupons.

**Какие данные и по какой схеме сервис будет хранить в базе?**

Схема хранения данных описана в [проработке](proposal.md).

**Какой объем данных будет храниться и какой объем будет изменяться в единицу времени?**

Оценка объема данных на текущий момент - 127 гигабайт.
- [Расчет числа комбинаций на пользователя на один бренд](https://yql.yandex-team.ru/Operations/XsvEFSAsJSKmfscp5HpUaI7xoLHvraXA89gnBs6rE44=)
- [Расчет общего числа идентификаторов](https://paste.yandex-team.ru/1035799) - `yandex_uid` сейчас не используется, взята оценка по `phone_id`
- [Расчет размера строки в байтах](https://paste.yandex-team.ru/1035092)
- [Общий расчет](https://paste.yandex-team.ru/1035807)

Оценка завышена по следующим причинам:
- `phone_id` для Яндекса и Убера не пересекаются, поэтому для каждого идентификатора будет только один бренд.
- для `card_id` будет только способ оплаты `card`, что уменьшает количество различных комбинаций для этого идентификатора

Прирост данных соответствует появлению новых пользователей.
По оценке от менеджеров прирост новых пользователей 40-50% в год.

**Какие операции над данными заложены?**

Обновление счетчиков заказов (INSERT + UPDATE).
Чтение данных (SELECT).

Все операции предполагают выполенение с использованием основного индекса по одному из идентификаторов пользователя.

**Есть ли какой-то стейт в памяти, как он обновляется и валидируется?**

Стейта в памяти нет.

**Какая нагрузка ожидается?**

Ожидается нагрузка 300 RPS на ручку /v1/orders.
Рассчитано как текущий дневной пик на ручку сервиса userstats: [график](https://nda.ya.ru/t/SuUn22hz3Vyz2W).

Запас прочности будет найден во время стрельб.

**Какие фолбеки предусмотрены на сам этот сервис?**

При отказе сервиса и невозможности проверить количество поездок не будут работать некоторые промокоды, в которых есть соответствующие ограничения (например, действует на первые N поездок по тарифу).

**Какие фолбеки предусмотрены внутри этого сервиса на взаимодействие с другими сервисами?**

Сервис не ходит в другие сервисы, только работа с БД.

**Какие возможности масштабируемости закладываются?**

Шардирование таблиц хранилища счетчиков позволит горизонтально масштабироваться.

**Какие точки отказа есть в сервисе?**

База данных postgres.

**Укажите ключевые продуктовые метрики сервиса, за которыми планируете следить**

Напрямую на продуктовые метрики не влияет. Дает необходимые функционал для гибкой настройки промокодов.

**Укажите технические метрики**

Тайминги ответа ручки, размер хранилища.

**Какая функциональность ожидается в сервисе в будущем?**

Можно добавлять измерения, по которым собирается статистика.
Можно добавить новые счетчики.

**Какое изменение нагрузки планируется?**

Основной потребитель на данный момент - ручка couponlist сервиса coupons.
Прирост RPS в ней за последний год (если не смотреть на падение из-за самоизоляции) ~30%: [график](https://nda.ya.ru/t/jhPSoj9X3Vyz57).

**Активно ли будет изменяться сервис?**

В данный момент новых доработок не предвидится, но в Продукте они могут возникнуть в любой момент.

<hr>

## Этапы разработки

1. Создание заготовки сервиса со схемой БД - [3d].

- Заведение сервиса - ПР в uservices
- Накатка миграции на БД базы
- Настройка выкатки (тестинг)
- Сетевые доступы

2. STQ-таска записи данных - [3d].

- Реализация таски
- Поставновка таски из процессинга 2.0

3. Ручка получения данных - [2d].

- Написать ручку по проработке

4. Скрипт миграции - [5d].

- Выгрузка необходимых данных из YT
- Заливка в БД скриптом с учетом новых данных из STQ-таски

5. Ходить в новый сервис из coupons - [2d].

- Начать делать запросы
- Сравнивать с существующим userstats

## Дальнейшие этапы

1. Перевести adjust-py3 на новый сервис
2. Отключить старый сервис.
- Освободить сервисные ресурсы, хранилище.
