**Название сервиса**

signal-device-message-api

+ Yandex IoT Core (mqtt брокер)

**Какую продуктовую проблему решает сервис?**

Обмен сообщениями в реальном времени между камерами и клиентскими браузерами.

**Почему нельзя решить эту задачу без разработки нового сервиса существующими решениями?**

Нет подходящего pub/sub механизма в такси (одно сообщение рассылаем только на один девайс, поллить с девайса не хотим, потом хотим доставить ответ обратно клиенту). С разработчиками сервисов коммуникаций поговорили – сейчас готового решения под нас нет.
Есть logbroker, но Yandex IoT Core построен как раз поверх него и поддерживает протокол MQTT.

**Как именно сервис будет решать поставленные перед ним задачи?**

Камера через signal-device-message-api регистрируется в брокере сообщений и далее держит mqtt-соединение напрямую с ним, получая запросы/отсылая обратно ответы.

Браузерные клиенты отсылают команды через signal-device-message-api (мы проверяем форматы запросов и разрешения на их выполнение). signal-device-message-api кладет сообщение в брокер через grpc (авторизуется по сертификату).

В signal-device-message-api заводим распределённый кэш (предлагаю redis).

Клиент получает ответы на свои запросы от железок через поллинг по такому флоу:
1. Клиент шлёт нам запрос с проверкой ответов нужного девайса на его команды
2. Мы проверяем, есть ли ответ для нужного запроса от клиента в кэше. Если есть – отдаём и удаляем из кэша.
3. Если ответ в кэше не нашёлся, по grpc выгребаем из mqtt сообщения в выходном канале от девайса и складываем их в кэш. Если среди сообщений нашлись ответы для нашего клиента, отдаём их ему.
4. Если ответа по-прежнему не нашлось, говорим клиенту, что девайс не ответил.

Кэш нужен по той причине, что к одному девайсу запросы могут послать несколько клиентов, и выгребая очередь мы можем забрать «чужой» ответ. Терять его не хотим (в очереди, при повторном запросе, его не будет).

TTL записи в кэше – около 1 часа.

**Разрабатывается один сервис или система?**

Разрабатывается один сервис у нас + будет использоваться готовый сервис из Яндекс.Облака.

**С кем взаимодействует сервис?**

- с железками при их регистрации в IoT Core
- с админкой при отправке собщений на железку и при получении ответов
- с IoT Core при отправке/получении сообщений со стороны админки + при регистрации девайсов по сертификатам

**Какие базы использует?**

Новый redis signal_device_messages.

**Какие периодические процессы?**

Нет

**Планируется обработка персональных данных**

Нет

**Какие данные и по какой схеме сервис будет хранить в базе?**

```javascript
{
	"client_id (или session_id)" : {Ответы на команды клиента, у которых не истёк ttl}
}
```

**Какой объем данных будет храниться и какой объем будет изменяться в единицу времени?**

Меньше 100Мб

Изменений до 0.3мб/с

**Какие операции над данными заложены?**

read, write, delete

**Есть ли какой-то стейт в памяти, как он обновляется и валидируется?**

Только распределенный кэш, указанный выше

**Какая нагрузка ожидается?**

1 rps

**Какие фолбеки предусмотрены на сам этот сервис?**

Если сервис недоступен, нельзя зарегистрировать в брокере новую камеру + нельзя отправить запрос/получить ответ из админки.

**Какие фолбеки предусмотрены внутри этого сервиса на взаимодействие с другими сервисами?**

Если недоступен IoT Core, отвечаем на запросы админки только из кэша, не регистрируем новые камеры.

Если недоступен кэш, всегда ходим в IoT Core.

Если недоступен и кэш и IoT Core, не отвечаем ни на какие запросы.

**Какие возможности масштабируемости закладываются?**

Увеличение базы, увеличение ram/cpu на инстансе, увеличение количество инстансов сервиса.

**Какие точки отказа есть в сервисе?**

Отказ Yandex Iot Core.
Отказ Redis.

**Укажите ключевые продуктовые метрики сервиса, за которыми планируете следить**

- Частота и типы отправляемых запросов.

**Укажите технические метрики**

- Среднее время ответа на запрос.
- Количество записей в кэше.

**Какая функциональность ожидается в сервисе в будущем?**

Все, связанное с обвязкой над текстовым протоколом обмена сообщениями с камерой через mqtt.

**Какое изменение нагрузки планируется?**

Прямо пропорционально количеству активных камер усталости.

**Активно ли будет изменяться сервис?**

В основном меняться будет набор поддерживаемых сервисом команд для отправки в очередь.
