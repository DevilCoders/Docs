# Реклама в Еде

## Введение
В рамках данной задачи будут добавлена возможность создавать рекламную компанию
для ресторанов / брендов и продвигать их на главной странице.

Уже была проверенна концепция с рекламой в каталоге (через хардкод ресторанов
в специальную карусель). Данный подход показал себя жизнеспособным. Принято
решение развивать направление рекламы.

Текущая итерация подразумевает собой интеграцию с Банерокрутилкой (далее просто
БК). Она включает в себя:
  * Интеграцию ресторанной выдачи с ранжированием через БК.
  * Трекинг просмотра и открытия рекламных ресторанов через клиентские
    приложения.
  * Добавление возможности рестарану поставить сбея в "аукцион" и интеграцию с
    рекламным кабинетом со стороны Core.


## Задачи

* [https://st.yandex-team.ru/EDAPRODUCT-744](https://st.yandex-team.ru/EDAPRODUCT-744) - продуктовая задача.
* [https://st.yandex-team.ru/EDADEV-35326](https://st.yandex-team.ru/EDADEV-35326) - задача на интеграцию со стороны ресторанной выдачи.

## Ответственные

* [udalovmax@](https://staff.yandex-team.ru/udalovmax) со стороны Каталога и Layout Constructor.
* [janual@](https://staff.yandex-team.ru/janual) менеджер проекта.
* [lisnyak@](https://staff.yandex-team.ru/lisnyak) технический менеджер со стороны БК.
* **(!)** со стороны Rest App и админки - кто-то из @a_team (ryurasov@ ?).

## Предлагаемая реализация

В ресторанном приложении будет заведена возможность создать рекламную компанию
для рестика. Запрос отправляется в API **Я.Директа**, в ответ рестапп получает
`ID рекламного баннера`, который вешается на ресторан (либо на все рестораны
бренда). Этот `ID рекламного баннера` прорастает в каталог через дамп эластики
(и в будущем через `eats-catalog-storage`).

При запросе **layout-constructor** -> **catalog**, после ранжирования ресторанов и
дедубликации, формирует список ресторанов, у которых проставлен `ID рекламного баннера`
и делает запрос в **API Баннерной Крутилки** (спека [https://bb.yandex-team.ru/projects/EDA/repos/spec-api/pull-requests/713/overview](https://bb.yandex-team.ru/projects/EDA/repos/spec-api/pull-requests/713/overview))
для полуения **списка ресторанов с весами** (приоритетами ранжирования) и **ссылок** на счетчики показа и
кликов. После чего формируем отдельный список для рекламных ресторанов (фактически, новый
`place_list_type: ads`), и отдаёем его в ответ **LC**.

> Продуктово важно делать обращение к БК после дедупликации, т.к. важно
> сохранить логику выбора лучшего ресторана и не ухудшать выборку в пользу
> рекламных.

**Layout Constructor** вставляем рекламные рестораны в отдельную карусель.

Фронты на своей стороне при попадании рекламируемого ресторана во **viewport**
делают GET-запрос по ссылке, считающей просмотры. При переходе на ресторан -
делают запрос на кликовую ссылку, соответственно.

В первую итерацию ретраев / отложенных отправок в **API БК** со стороны фронта не планируется.

> В будущем, в случае недоступности API, фронты могут ретраить запросы, но это не очень рекомендуюется, т.к. возрастет нагрузка на движок БК.
> При недоступном интернете, можно держать очередь сообщений на отправку: сначала показ, потом клик, т.к. это важно для движка.

[lisnyak@](https://staff.yandex-team.ru/lisnyak), говорит, что:
> В целом опять же можно посмотреть в эксперименте, есть ли разница с ретраями
> или без них. Вполне может оказаться что эти два сценария не отличимы.

## Схема взаимодействия Ресторанной выдачи с БК

![Схема](./scheme.png)

Если схема не прогружается, можно найти её [на Wiki](https://wiki.yandex-team.ru/users/udalovmax/eatscatalogads/#m-sxemapoluchenijareklamy).

## Деградация

Рекламная выдача не является необходимой с точки зрения данных для работы
сервиса.
Динамическая конфигурация (без необходимости рестара инстанса) каталог включает
в себя:

* флаг вкл/выкл сетевого похода
* таймаут на сетевой поход

В случае, если API БК будет негативно влиять на сервис, поход в него можно
будет отключить:

* везде;
* по ДЦ;
* по группам RTC (pre/stable);
* руками через локальный конфиг на интересующих инстансах (аварийный способ,
доступен только @platform_team и @devops).

## Мониторинг

Собираться будет следующий набор метрик:

* общее количество запросов к API БК;
* количество успешных ответов API БК (2ХХ);
* количество "плохих" ответов API БК (4ХХ и 5ХХ);
* перцентили времен ответов;
* перцентили времен успешных ответов;
* перцентили времен плохих ответов.

В мониторинг должны поступать следующие сигналы:

* процент плохих ответов больше N за последние M минут (N нам пока что предстоит
узнать, M - 5 минут);
* среднее время ответа либо время ответа в 99-м перцентиле больше трешхолда (150мс).

Бизнесовыми метриками будут являться (например):

* среднее количество рекламных ресторанов в ответе с разбивкой по региону.

## Эксперименты

Реклама должна выкатываться по-процентно, чтобы следить как за нагрузкой на
каталог, так и нагрузкой на API БК (БК не должен нас особо почувствовать).

## Альтернативные варианты реализации

### На стороне Layout Constructor

Была рассмотрена реализация со стороны **Layout Constructor**.

Отказались от этого варианта, из-за того, что на стороне **LC** списки
ресторанов уже отфильтрованы и он не обладает полным списком ресторанов,
которые могли бы участвовать в "рекламе".

Так-же это нарушает зону ответственности **LC** и переносит в него доменные
знания каталога.

### Отдельный сервис

Рассмотрен сервис "над каталогом", который бы переносил в себя ручки каталога
и реализовывал бы новый функционал уже на своей стороне.

Сейчас прорабатывается проект разработки этого сервиса. Делаем параллельно.
В текущей итерации, которая нужна для быстрой проверки гипотезы, блокировка
об него была бы излишня. Сейчас важео проверить концепцию с рекламой на клик.

Технически разработать подобный сервис для формирования списки ресторанов для
eats-layout-constructor, примерно оценена в 3-4 недели на разработку
и ввод в эксплуатацию:

1. Ручка на стороне eats-catalog, отдающая все рестораны на точку (пока не
готов поиск в eats-catalog-storage).
2. Повторение логики ручки cfl (`/catalog/layout`) из Go, со всеми клиентами и
прочими зависимостями.

> Разработку сревиса исключительно под рекламу тоже рассмотрели, но отказались
> по причине того, что при изменении формата реклама (не отдельная карусель,
> а пересортировка в рамках существующих выдач), сервис полностью исчерпал бы
> себя (просто дублировал поход в БК напрямую).
