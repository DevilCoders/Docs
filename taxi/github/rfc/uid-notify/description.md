## Бизнесовая задача

### Описание

Нужно получать события от паспорта о событиях связки и развязки аккаунтов.

### Гипотеза

Мы должны научиться мигрировать подписку плюса с фониша на портал в момент связки. Без событий от паспорта это можно сделать только в ручке launch/новой клиентской ручке. Подобный функционал нужен в семейном счете.

### Дизайн

https://jing.yandex-team.ru/files/jolfzverb/uid.png

### Продуктовые ограничения

Событие доставляется на сервис-потребитель асинхронно, возможен лаг между событием связки/развязки и доставкой.

## Архитектура

### Высокоуровневая архитектура

Паспорт ходит в новую ручку uid-notify.
Ставится stq задача uid-notify, которая доставляет событие (ходит в ручки) сервисам-подписчикам из конфига.

В будущем возможна интеграция LogBroker.

### Влияние на цикл заказа

На цикл заказа не влияет

### Компоненты

#### Сервис `zalogin`

В сервисе zalogin пишем ручку-коллбек для паспорта.

#### Stq `uid-notify`

Забирает из конфига подписчиков и доставляет до них по http события.

### API

В отдельном файле.
Идемпотентность функционала важна только в случае когда один подписчик подписан на оба события - bind и unbind.
В таком случае для обработки события необходимо знать что было раньше - последний обработанный bind или новый unbind (и наоборот).
Паспорт не может предоставить информацию для гарантии идемпотентности. Сервисам, которые хотят обрабатывать оба события необходимо самостоятельно ходить в social апи и проверять текущее состояние аккаунтов.

Все интегрирующиеся сервисы должны гарантировать идемпотентность по ключу portal_uid-phonish_uid-event_type

### Нагрузка

События связки очень редки - не больше 1 rps, события развязки еще реже - единицы запросов в сутки.

### Внешние сервисы

#### СУБД

Отдельное хранилище не заводим.

#### Используемые сервисы

Используется `stq-agent` для очереди stq и сервисы-подписчики

### Отказоустойчивость

Паспорт обязуется ретраить ручку uid-notify.
stq задача перезапускается если какой-либо сервис не ответил 200 на запрос в uid-notify

### Мониторинги, алерты, бизнесовые графики, логи

Стандартных мониторингов 500, stq и графиков достаточно.
При необходимости в дальнейшем можно сделать графики с разбивкой по потребителям.

### Технические ограничения

Осознанно жертвуем синхронностью событий.

### Этапы

1. Ручка в zalogin, stq очередь, катящаяся на кластер zalogin
2. Интеграция LogBroker.

### Как раскатываем

#### Раскатка этапа 1

Раскатываем со стороны паспорта. С нашей стороны будет рубильник в ручке uid-notify

### Безопасность

1. С персональными данными не работаем
2. Данные пользователя не храним - интеграция с `takeout` не нужна
