### Дизайн фичи получения истории для командного аккаунта

В данном документе представлены различные решения для получения истории командного аккаунта и произведено их сравнение.

Требования к решению следующие:
* история включает всех участников аккаунта, для заказов где способом оплаты был этот аккаунт
* параметр запроса: payment_method_id (в случае командного аккаунта payment_method_id равен account_id)
* фильтрация hidden-поездок не нужна
* поддержка пагинации по курсору
* список возвращаемых полей. Обязательные выделены:
  * **Время заказа**
  * **Точки А, Б** и промежуточные точки
  * **Статус заказа (в качестве статуса подойдут поля status и taxi_status)**
  * **ID заказа**
  * phone_id, user_uid 
  * Стоимость поездки и валюта
  * Тариф 
  * Водитель (фио, телефон)
  * Автомобиль (марка, номер)

Общее у всех решений то, что заказы должны быть получены как из оперативного хранилища (mongo), так и из архива (YT).

#### Решение 1. Расширение сервиса ridehistory

Сервис ridehistory имеет готовый pipeline для накапливания истории и выдачи её через ручку [/list](https://github.yandex-team.ru/taxi/uservices/blob/develop/services/ridehistory/docs/yaml/api/api.yaml#L16).
В данный момент история отдаётся по пользователю, авторизованному через PA.
Для поддержки получения истории по payment_method_id необходимо следующее:
1. в таблицу user_index сервиса ridehistory добавить optional поле payment_method_id
1. в YT добавить индекс payment_method_id_created для быстрого доступа в YT-балицу order_history по запросу (payment_method_id, дата, limit)
1. при заказе тригерить существующую stq, добавляющую запись в user_index
1. авторизация будет выполняться на стороне taxi-shared-payments, где будет проверяться что пользователь имеет доступ к истории запрашиваемого payment_method_id

Если не удастся собрать все поля по заказам, то оставшиеся можно показывать пользователю при клике на поездке, взяв данные из ручки [/list](https://github.yandex-team.ru/taxi/backend-py3/blob/develop/services/orderhistory/docs/yaml/api/api.yaml#L96) сервиса orderhistory.

Плюсы:
- Переиспользование готового pipeline
- Можно использовать и для других фич, которым требуется история заказов по payment_method_id

Минусы:
- Привнесение специфических знаний об payment_method_id в сервис ridehistory


#### Решение 2. Реализация в сервисе taxi-shared-payments

1. Начинаем сохранять все order_id заказов аккаунта в новой postgres-таблице account_orders (account_id, order_id, order_created)
Чтобы таблица не разрасталась, данные из неё будут переезжать в YT (будет новая таблица).
2. При запросе истории по payment_method_id, получаем список order_ids (из postgres + YT в п.1), который передаём в ручку [/archive/orders](https://github.yandex-team.ru/taxi/backend-cpp/blob/develop/archive-api/docs/orders.yaml#L11) archive-api, откуда получаем order_proc'и из mongo и YT. В order_proc находятся минимально требуемый набор полей: order.request.source, order.request.destinations, order.status

Плюсы:
- Держим специфику payment_method_id внути taxi-shared-payments

Минусы:
- дублирование кода - фактически повторная реализация ridehistory


#### Решение 3. Получения заказов по телефонам участников

1. У аккаунта есть список текущих (и бывших) участников с номерами телефонов.
1. По номерам телефонов делаем эффективные запросы заказов (с фильтрацией по payment_method_id) в mongo и в YT

Плюсы:
- простота реализации

Минусы:
- получение заказов по списку номеров телефонов, а не по payment_method_id, представляет собой скорее хак, чем архитектурно-корректное решение, т.к. требует знания phone_id всех текущих и бывших участников, и например переход с phone_id на yandex_uid (как идентификатора участника) ломает эту схему. 


### Сравнение решений

Решение 1 представляется наилучшим компромиссом по простоте и архитектуре.
