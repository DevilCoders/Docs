# Парковые заказы в int-api

## Бизнесовое описание

В рамках проекта [Superweb SaaS](https://st.yandex-team.ru/TAXIPROJECTS-2221)
хотим научиться продавать Такси-как-Сервис отдельным Таксопаркам. Так будет
легче расширять международное направление. Само Такси в таком случае называется
"whitelabel-Такси".

Из особенностей - нужно уметь назначать заказ на водителей из парка, в котором
создан заказ, с опциональным фоллбэком на всех доступных водителей. Будем
называть такие заказы "парковыми".

Парки будут заводить собственные тарифы, по которым будет рассчитываться
стоимость поездок.

## Доработки в клиентской части (int-api)

### whitelabel_id

Создаем отдельную сущность - whitelabel, которая будет соответствовать целиком
продукту, продаваемому таксопарку.  Пока будет мапиться 1:1 к таксопаркам и
приложениям Турбоаппа. Но в будущем это даст больше гибкости, если нужно будет,
например, расширить один whitelabel на несколько таксопарков.

### Новые приложения

Для каждого нового whitelabel-приложения будут добавлены два приложения в
терминологии заказов Такси: одно для заказов через ТурбоАпп (пассажиры будут
заказывать сами через нативное мобильное приложение, в котором будет вебвью
ТурбоАппа), другое - для заказов через диспетчерскую таксопарков (далее -
"диспа"). Сущность `source` - устаревшая, для новых источников заказов ее не
используем.

Отдельные приложения нужны, так как в сценариях ТурбоАппа и Диспы - разные
механизмы авторизации пользователей. Проращивание заказов Диспы в ТурбоАпп
пользователя будет работать только после реализации этого механизма для Такси и
колл-центра в рамках
[TAXIBACKEND-35084](https://st.yandex-team.ru/TAXIBACKEND-35084).

Приложения будут парситься из заголовка запросов `User-Agent` на основе правил
из конфига
[APPLICATION_DETECTION_RULES_NEW](https://nda.ya.ru/t/lRQDVY0s3sJGLa). К
стандартному содержимому `User-Agent` нужно будет дописать дополнительную
информацию о whitelabel:
- `whitelabel/turboapp/{whitelabel_id}` для запросов из ТурбоАппа
- `whitelabel/superweb/{whitelabel_id}` для запросов из Диспы

В качестве `whitelabel_id` будет использоваться суррогатный идентификатор вроде
GUID. Однако при определении приложения будем мапить его в человекочитаемое
название, получаемое, например, на основе названия Таксопарка. Это существенно
упростит дальнейшую аналитику, настройку конфигов для этого приложения и т.д.

После заведения нового приложения нужно добавить его в нужные конфиги, которые
указаны
[здесь](https://wiki.yandex-team.ru/taxi/backend/new-application-procedure/).

Также предлагается для каждого whitelabel-приложения заводить отдельный бренд.
Это позволит решить ряд задач:
- разделение данных пользователей по брендам (статистика поездок
  (новичковость), история поездок, промокоды и т.д.)
- гибкая настройка видимости тарифных категорий (например, можно будет
  отключить категорию "эконом" для таксопарков с премиальными автомобилями)
- гибкая настройка реферальной программы

### Создание документа пользователя

#### Диспа

Создание и обновление информации о пользователе происходит в ручке
[/profile](https://nda.ya.ru/t/DnwuyrgE3sJFY5).  Этот флоу актуален при
использовании номера телефона пользователя для создания `user_doc`, когда нет
Паспортной авторизации.

Нужно передать `personal_phone_id`, который можно получить в обмен на номер
телефона пользователя в сервисе ПД. Пользователь сразу создается
авторизованным.

Доработок в этой ручке не требуется.

#### ТурбоАпп

Авторизация пользователя в ТурбоАппе происходит в ручке `/4.0/startup`. Для
whitelabel-приложение будет легкая Паспортная авторизация по номеру телефона и
имени/фамилии пользователя. Для того, чтобы это заработало, нужно новые
приложения добавить в [эксперимент
launch_auth_web_as_portal](https://nda.ya.ru/t/0FKQNmbG3sJFJo).

### Создание оффера/запрос ETA

Предварительный расчет стоимости поездки и создание оффера происходит в ручке
[/orders/estimate](https://nda.ya.ru/t/sibw82ig3sJFZU).  На этапе запуска MVP
офферов не будет, так как стоимость поездки будет рассчитываться по Таксометру.

Запуск MVP будет происходить в странах, в которых Яндекс.Карты могут быть
неточными, из-за чего принято продуктовое решение не показывать даже
приблизительные цены на экране саммари. Будет отображаться только минимальная
цена, заданная в тарифе. Для этого при обработке запросов от вайтлеблов на
этапе MVP будем отбрасывать все точки маршрута, кроме точки А. При подключении
точного роутинга (например, через GoogleMaps) можно будет включить обычное
поведение с помощью конфига.

В ручке `/orders/estimate` также происходит вычисление ожидаемого времени
подачи машины по каждой доступной тарифной категории. Кроме того, на основе
данных о ETA, делается вывод о доступности тарифной категории. Например, если
нет подходящих кандидатов, то мы считаем, что тариф недоступен и не даем
сделать заказ.

Для `whitelabel_id`, который берется из хедера `X-Taxi`, как описано
[здесь](#новые-приложения), ходим в ручку Диспы для получения:
- `source_park_id` - id парка, внутри которого создан заказ
- `dispatch_requirement` - типа диспатча `only_source_park|source_park_and_all`

Эту информацию нужно будет прокидывать для расчета примерной стоимости и ETA в
виде объекта:
```json
"white_label_requirements": {
  "source_park_id": "park_id",
  "dispatch_requirement": "only_source_park|source_park_and_all"
}
```

Для прайсинга важно знать, из какого парка заказ, так как у каждого парка в
перспективе будут свои тарифы. На этапе MVP, скорее всего, в каждой тарифной
зоне будет одинаковый тариф для всех парков, как это сделано в текущих тарифах
Такси.

Для инфраструктуры назначения важно знать, из какого парка заказ и какой режим
диспатча предполагается, так как эта информация среди прочего влияет на
доступных кандидатов, что, в свою очередь, влияет на ожидаемое время подачи.

Этот объект нужно пробрасывать:
- в PricingDataPreparer [здесь](https://github.yandex-team.ru/taxi/backend-cpp/blob/develop/protocol/lib/src/external/estimate/estimate.cpp#L741)
- в сервис `driver-eta` [здесь](https://github.yandex-team.ru/taxi/backend-cpp/blob/develop/protocol/lib/src/external/estimate/estimate.cpp#L295)

#### Доработки driver-eta

Для корректного отображения ETA на саммари - времени подачи машины в каждой
тарифной категории, и определения доступности тарифа нужно передавать в сервис
`driver-eta` объект `white_label_requirements`. Далее этот объект будет
пробрасываться в сервисы `candidates` и `driver-scoring` (через либу
`lookup-ordering`) для корректного поиска кандидатов.

Для поиска потенциальных исполнителей заказа сервис `driver-eta` ходит в сервис
`candidates` в ручку [/order-multisearch](https://nda.ya.ru/t/Y1-Vqtl93t7ySR) и
в сервис `driver-scoring` в ручку
[/driver-scoring](https://nda.ya.ru/t/yPL4-V9P3tMb6o).  Объект
`white_label_requirements` предполагается пробрасывать туда без изменений.

#### Доработки суржа?

TODO: нужно ли как-то по-особому создавать пины для суржера?

### Создание заказа

Заказ создается парой ручек [/orders_draft](https://nda.ya.ru/t/smKZ3jf73sJFmG)
и [/orders_commit](https://nda.ya.ru/t/5srTQRMR3sJFoL).

Аналогично тому, как это происходит в ручке
[estimate](#создание-офферазапрос-eta), будем формировать и сохранять в
`order_proc` следующий объект:
```json
"white_label_requirements": {
  "source_park_id": "park_id",
  "dispatch_requirement": "only_source_park|source_park_and_all"
}
```

Диспа может присылать объект `white_label_requirements` явно, если, например,
для конкретного заказа нужно задать режим диспатча, отличающийся от дефолтного
для парка.

Эта информация будет использоваться во время диспатча, чтобы выбирать
кандидатов из нужного парка.

Нужно поддержать новые поля при создании черновика:
- [здесь](https://github.yandex-team.ru/taxi/backend-cpp/blob/develop/protocol/lib/src/handlers/order_base.cpp#L513)
- [тут](https://github.yandex-team.ru/taxi/backend-cpp/blob/develop/protocol/lib/src/views/order_maker.cpp#L620)
- ...

### Работа с активными заказами

Получить список заказов пользователя можно через ручку
[/orders_search](https://nda.ya.ru/t/zkvwMsOs3tFwPz). Несмотря на то, что для
ТурбоАппа и Диспы создаются разные `user_docs`, здесь можно получить полный
список заказов пользователя с этим номером телефона внутри бренда (бренд у
приложений ТурбоАппа и Диспы одинаковый):
- [логика в коде](https://nda.ya.ru/t/0hMby6a_3tFxJe)
- [запрос в базу](https://kibana.taxi.yandex-team.ru/goto/53f3a0fe70ed89dda34c4ea8c4ce116f)

Отмена заказа происходит через ручку
[/orders_cancel](https://nda.ya.ru/t/pzwzqBfR3tG3Zh).

## Дополнительная нагрузка

Оценка по создаваемым через int-api заказам ежедневно: ~850К заказов, получена
[отсюда](https://kibana.taxi.yandex-team.ru/goto/a65827ae12d6aaee56adf8dba2f44779).

По оценке от менеджеров ожидается 10K ежедневно на старте проекта, к концу года
100К оптимистично, 30К реалистично. То есть на старте будет чуть больше 1%
дополнительной нагрузки, что пока не требует увеличения ресурсов int-api.
