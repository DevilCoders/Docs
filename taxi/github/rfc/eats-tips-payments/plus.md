# Внедрение плюса в чаевые

Процедура начисления баллов начинается при завершении платежа (колбек, страница успешной оплаты, ...)

продуктовые тикеты:
- [EDAPRODUCT-1397](https://st.yandex-team.ru/EDAPRODUCT-1397)
- [NEWSERVICE-1461](https://st.yandex-team.ru/NEWSERVICE-1461)
- [FRAUDREVIEW-174](https://st.yandex-team.ru/FRAUDREVIEW-174)
- [EASYT-384](https://st.yandex-team.ru/EASYT-384)

разрабские тикеты:
- [EASYT-178](https://st.yandex-team.ru/EASYT-178) - беклог

Задействованные сервисы:
- [eats-tips-authproxy](https://wiki.yandex-team.ru/taxi/backend/architecture/eats-tips-authproxy/)
- [tips-payments](https://wiki.yandex-team.ru/users/tavery/easyt/)
- [plus-wallet](https://wiki.yandex-team.ru/taxi/backend/architecture/plus-wallet/)
- [billing-wallet](https://wiki.yandex-team.ru/taxi/backend/architecture/billing-wallet/)
- [transactions-ng](https://wiki.yandex-team.ru/taxi/backend/architecture/transactions/architecture/)
- taxi-antifraud

Задействованные конфиги:
- EATS_TIPS_PAYMENTS_PLUS_SETTINGS
  - enabled (`bool`) - рубильник всей плюсовой логики
  - payment_ttl (`int`) - время жизни платежа в минутах. после истечения кешбек за анонимный платеж забрать будет нельзя
  - service_name (`str`) - название сервиса, выдающего кешбек
  - service_id (`int`) - id сервиса в биллинге, выдающего кешбек
  - ticket (`str`) - тикет, в котором согласовывался выпуск баллов
  - issuer (`str`) - выпускатель баллов кешбека
  - antifraud_enabled (bool) - рубильник всей фродовой логики
  - max_amount_per_transaction (int) - максимальное кол-во плюса, которое можно начислить за 1 транзакцию
- EATS_TIPS_PAYMENTS_POLL_RETRY_SETTINGS, EATS_TIPS_PAYMENTS_PLUS_CHARGE_RETRY_SETTINGS - настройки ретраев начисления и полинга
  - delay (float) - базовая задержка повтора
  - factor (float) - множитель задержки повтора
  - max_tries (int) - максимальное количество повторов

Задействованные эксперименты:
- eda_tips_payments_plus_calculation (проработка в [EASYT-414](https://st.yandex-team.ru/EASYT-414))
  - вход:
    - amount (`int`) - сумма чаевых в рублях
    - user_id (`str`) - yandex uid пользователя
    - place_id (`int`) - id заведения
  - выход:
    - plus_amount_percent (`float`) - множитель баллов
    - plus_minimal_threshold (`int`) - порог начисления баллов (мин сумма, с которой начинается)

eats-tips-authproxy - входная точка. пробрасывает в цепочку взаимодействий yandex_uid, мета-информацию и статус плюсовой подписки пользователя через заголовки.

---

## Общий путь платежа
1. регистрация платежа:
    - авторизован? - пишем в бд связку юзера + платеж + сумму + заведение + IP
    - не авторизован? - пишем в jwt номер платежа и время создания
1. ждем успешного завершения платежа:  
    - a) колбек от б2п:
      - платеж прошел и есть связка с юзером? - выписываем кешбек
    - b) завершение оплаты (страница успеха):
      - есть связка платеж + юзер? - выписываем кешбек
      - связки нет, но авторизован, и есть платеж в jwt? - пишем в бд связку и выписываем кешбек

jwt с платежами нужен для кейса:
  - анонимный юзер платит, но после банка не переходит в завершение оплаты
  - авторизованный юзер подставляет в url завершения чужой незавершенный заказ и забирает себе плюс

От дублирования инвойсов на один заказ защищают:
- наличие связки заказ + инвойс проверяется первым шагом
- уникальность orders.order_id не дает создать две записи на один заказ из мускуля
- `update orders set invoice_id = <...> where invoice_id is null` гарантирует единоразовую связку инвойса и заказа
- `update` возвращает кол-во обновленных строк, если их не было - транзакция создания инвойса откатывается

---

## Алгоритм начисления плюса
1. проверяем, включена ли логика плюса
1. проверяем, начисляли ли уже плюс на этот платеж
    - если да - отдаем на фронт id инвойса и кол-во баллов
1. ищем платеж в бд
    - если не нашли - создаем
1. из эксперимента берем кол-во / множитель начисляемого плюса
    - если 0 - выходим
1. ищем у пользователя рублевый кошелек плюса
    - если нет - создаем
1. выписываем инвойс в транзакциях (`/v2/invoice/create`)
1. накидываем на инвойс кешбек (`/v2/cashback/update`)
1. сохраняем инвойс в бд и связываем с платежом. отдаем на фронт инвойс и начисленные баллы
1. поллим инвойс в ожидании успеха

![жирненькая схемка](https://jing.yandex-team.ru/files/jlemyp/sequence.png)

---

## Алгоритм отбирания начисленных баллов
1. админ отменяет транзакцию в b2p
2. админ отменяет транзакцию в кабинете, ставится пометка о необходимости отбирания баллов
3. крон раз в короткий промежуток выгребает из базы платежи с пометкой
4. проверяется наличие кешбека по транзации
    - если есть - в инвойс в pg ставится пометка возврата
5. пометка снимается с транзакции
6. меняем сумму кешбека платежа на 0
7. поллим инвойс в ожидании успеха

![возврат](https://jing.yandex-team.ru/files/jlemyp/refund.png)

---

## Анти-фрод схема
1. показываем и начисляем плюс только авторизованным пользователям
1. при заходе авторизованного пользователя на страницу, передаем его uid и метаинформацию в сервис антифрода
1. в зависимости от вердикта антифрода, показываем или скрываем офер плюса

![антифрод](https://jing.yandex-team.ru/files/jlemyp/fraud.png)


[тоже самое на вики](https://wiki.yandex-team.ru/users/jlemyp/tips-plus)
