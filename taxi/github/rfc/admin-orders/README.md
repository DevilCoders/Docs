# Админка заказов

## О проекте
Сервис admin-orders предоставляет API для вкладки "Заказы" в Админке 2.0.
Адрес вкладки:
- продакшн: https://tariff-editor.taxi.yandex-team.ru/orders/
- тестинг: https://tariff-editor.taxi.tst.yandex-team.ru/orders
- анстейбл: https://tariff-editor-unstable.taxi.tst.yandex-team.ru/orders

### Текущее состояние
Сейчас ручки для этого раздела живут в монолите py2, некоторые ручки вынесены в отдельные сервисы (персональные данные, ???)

### Этапы развития сервиса
    задача минимум - перенести ручки в py3
    задача максимум - переделать всю архитектуру, продумать удобное добавление фич и удобное управление заказом

### Архитектура

- сервис admin-orders, написанный на py3 (admin-orders.taxi.yandex.net - ?)
- аутентификация пользователей через АБК, т.к. сервис внутренний
- база данных: используются существующие коллекции в mongodb (если нет специфичных сервисов)
- взаимодействует с другими сервисами для получения/сохранения данных без походов в mongodb
 
### MVP
Создать новый сервис с одной-двумя простыми ручками.
Далее - перенос остальных ручек вместе со вспомогательным кодом (аудит, походы в сервисы etc)

## Техническая реализация
Реализация подразумевает добавление нового сервиса admin-orders в backend-py3.

### TODO
- [x] список ручек
- [ ] анализ ручек и зависимостей
- [x] список внешних сервисов (to be updated)
- [ ] структура кода сервиса (ручки, тесты, internal, external, utils, etc)
- [ ] дашборды (свои новые, т.к. отдельный сервис;
    на вики-странице оставить ссылки на старые дашборды)
- [ ] дырки
- [ ] *ПРОЧЕЕ* по шаблону rfc (конкретизировать)

### О чём подумать

- задача фронтам на конфиг для переключения на новые ручки без выкатки фронтенда
    (обсуждали голосом, оценка примерно пара дней)

### Ручки 

В целом план работы над ручками такой:
- проанализировать ручки, их зависимости (декораторы, компоненты, внешние сервисы)
- составить список зависимого кода, который уже реализован в py3 (хотя бы частично)
- составить список зависимого кода, который нужно будет переносить в py3
- выбрать ручку-другую для MVP;
    **критерии**:
    1) минимум кода для переноса,
    2) отсутствие зависимого кода из `invoice_handler` and like,
    3) ...?
- составить план переноса ручек MVP по чек-листу запуска нового сервиса

Начальный анализ ручек ведётся в `handles/initial_analysis.md`
    (**NOTE**: периодически актуализировать при наличии свежих коммитов).

После этого можно будет оценить объём работ по переносу остальных ручек и заводить на них задачи.


### Внешние сервисы (TODO)

- archive-api
- order-core
- api-admin
- startrack
- vgw-api
- experiments3
- territories

(список дополняется и уточняется)

## RFC

### GRFCG (good RFC guide)

Хорошее РФЦ нового сервиса содержит в себе:
- [ ] Ссылка на тикет в TAXIPROJECTS (отсутствует; не обязательно)
- [x] Ответ на вопрос "Какую проблему решает этот сервис" (ака "Продуктовое описание")
- [x] Описание архитектуры: из чего состоит (web/stq/postgres/YT), что использует, от чего зависит, как организовано взаимодействие.
 Например [так](https://github.yandex-team.ru/taxi/rfc/pull/121#discussion_r2473134).
- [x] Описан API
- [x] приглашен фронтенд (заведена задача на переключение URL)
- [x] Клиентский флоу не меняется (на первом этапе)
- [x] Оценен ожидаемый RPS (суммарный/ручек в отдельности)
- [x] Оценен ожидаемый объем данных для хранения (базы данных, MDS, ...) и QPS
- [x] Описана критичность, продуманы фолбеки
- [x] Определен MVP
- [x] Проект разбит на этапы, этапы состоят из оцененных задач
- [x] Подключение к takeout не нужно
- [x] Моки для фронтенда не требуются, т.к. меняются только URL ручек

### Тикеты

Эпик разработки: https://st.yandex-team.ru/TAXIBACKEND-26520
Ревью безопасности: https://st.yandex-team.ru/SECREVIEW-280
Ревью архитектуры: https://st.yandex-team.ru/TAXIARCHREVIEW-82
Проектный тикет: TAXIPROJECTS (? TODO or not TODO)

### Смежные зависимые задачи

Конфиг на фронтенде для бесшовной смены урлов ручек:
    [TAXIFRONTINFRA-132](https://st.yandex-team.ru/TAXIFRONTINFRA-132)

## Список задач и оценка по срокам

### Этап I
- [TAXIBACKEND-26751](https://st.yandex-team.ru/TAXIBACKEND-26751
) [2d] - генерация нового микросервиса, стаб ручки `restore`
- [TAXIBACKEND-26753](https://st.yandex-team.ru/TAXIBACKEND-26753
) [2d] - перенос ручки `restore`
- [TAXIBACKEND-26752](https://st.yandex-team.ru/TAXIBACKEND-26752
) [1d] - дашборды для нового сервиса
- [TAXIBACKEND-26804](https://st.yandex-team.ru/TAXIBACKEND-26804
) [1d] - настройка АБК
- [TAXIBACKEND-26758](https://st.yandex-team.ru/TAXIBACKEND-26758
) [?d] - анализ ручки `orders`, постановка задач смежным сервисам
- [TAXIBACKEND-26759](https://st.yandex-team.ru/TAXIBACKEND-26759
) [?d] - перенос ручки `orders` после реализации нужных ручек в смежных сервисах

### Этап II
- [TAXIBACKEND-26760](https://st.yandex-team.ru/TAXIBACKEND-26760
) [?d] - анализ ручки `order`, постановка задач смежным сервисам
- [TAXIBACKEND-26761](https://st.yandex-team.ru/TAXIBACKEND-26761
) [?d] - перенос ручки `order` после реализации нужных ручек в смежных сервисах
- [TAXIBACKEND-26755](https://st.yandex-team.ru/TAXIBACKEND-26755
) [?d] - перенос ручки `autoreorder` (при готовности order-core)
- [TAXIBACKEND-26756](https://st.yandex-team.ru/TAXIBACKEND-26756
) [?d] - перенос ручки `cancel/user` (при готовности order-core)
- [TAXIBACKEND-26757](https://st.yandex-team.ru/TAXIBACKEND-26757
) [?d] - перенос ручки `cancel/park` (при готовности order-core)
- [TAXIBACKEND-26754](https://st.yandex-team.ru/TAXIBACKEND-26754
) [3d] - перенос ручки `report/retry`
