**Название сервиса**

scooter-accumulator

**Какую продуктовую проблему решает сервис?**

Отправляет команды разблокировки/блокировки ячеек в шкаф с аккумуляторами. Собирает и хранит информацию по аккумуляторам/шкафам.

**Почему нельзя решить эту задачу без разработки нового сервиса существующими решениями?**

Нет сервиса для работы со шкафом с аккумуляторами.

**Как именно сервис будет решать поставленные перед ним задачи?**

Сервис будет:
- опрашивать шкафы о наличии и зарядах аккумуляторов;
- хранить информацию о каждом аккумуляторе: где находится (в скутере, у техника и пр.), заряд аккума и пр.;
- хранить информацию о шкафах;
- осуществлять бронирование/открытие ячеек в шкафах для выдачи/возврата аккумуляторов;

Примерный флоу:
1. Мы храним кол-во аккумуляторов в шкафах и их заряды в бд. В фоне опрашиваем шкафы для актуализации данных.
2. Бекенд самокатов спрашивает у нас, в каком шкафу и сколько есть аккумуляторов.
3. Получает ответ и бронирует у нас N аккумуляторов в шкафу. Если бронирование не удалось, бекенд может попробовать забронировать в другом шкафу.
4. Мы отмечаем бронирование в бд.
5. Техник приезжает забрать аккумы, нажимает кнопку в приложении.
6. Бекенд самокатов дергает ручку выдачи аккумуляторов.
7. Наш сервис посылает команду разблокировки ячеек шкафа в очередь по протоколу mqtt.
8. Дожидается ответа, сохраняет в бд информацию о технике и аккумуляторах (в частности, аккумуляторы теперь закреплены за техником), отдает результат с номерами ячеек.
9. Если ответа не дождался - говорит клиенту, что шкаф не ответил.
10. Техник забирает аккумуляторы, едет до самокатов и заменяет их.
11. Сразу после замены аккума бекенд самокатов дергает нашу ручку и мы списываем заряженный аккумулятор с техника и вешаем на него разряженный.

Возврат аккумуляторов проходит аналогично пунктам 2-10.

**Разрабатывается один сервис или система?**

Один сервис.

**С кем взаимодействует сервис?**

Бекенд самокатов <-> scooter-accumulator <-> облачный mqtt брокер Yandex IoT Core.

**Какие базы использует?**

Postgres в PGaaS.
Т.к. в дальнейшем будет запись в несколько таблиц за одно обращение к серверу.

**Какие периодические процессы?**

Опрос шкафов о количестве и уровнях зарада аккумуляторов.

**Планируется обработка персональных данных**

Не планируется обработка персональных данных.

**Прикрепите схему того, где этот сервис находится в текущей инфраструктуре**

Яндекс.GO <-> бекенд самокатов <-> scooter-accumulator <-> облачный mqtt брокер Yandex IoT Core <-> сервер шкафа

**Какие данные и по какой схеме сервис будет хранить в базе?**

```javascript
1) cabinets
{
  "cabinet_id": "айдишник шкафа",
  "coords": "геопозиция шкафа"
}

2) accumulators
{
  "accmulator_id": "id аккума",
  "contractor_id": "id курьера, если он его везет"
  "cabinet_id": "id шкафа, если аккум на зарядке",
  "scooter_id": "id самоката, если аккум в самокате",
  "battery_charge": 90%
}
```

**Какой объем данных будет храниться и какой объем будет изменяться в единицу времени?**

Меньше 100Mb

Изменений до 0.3Mb/s

**Какие операции над данными заложены?**

CRUD

**Есть ли какой-то стейт в памяти, как он обновляется и валидируется?**

Нет.

**Какая нагрузка ожидается?**

1 rps

**Какие фолбеки предусмотрены на сам этот сервис?**

Если сервис недоступен: открыть ячейку шкафа не получится, следовательно не получится забрать аккумулятор для замены и не получится вернуть замененный аккумулятор; нельзя получить информацию по аккумуляторам и шкафам.

**Какие фолбеки предусмотрены внутри этого сервиса на взаимодействие с другими сервисами?**

Если недоступна очередь сообщений: не отвечаем на запросы по выдаче/возврату аккумуляторов в шкаф.
Если недоступна база данных: не отвечаем на запросы по выдаче/возврату аккумуляторов в шкаф; не отвечаем на запросы получения статистики/информации по аккумуляторам.

**Какие возможности масштабируемости закладываются?**

Увеличение базы, увеличение ram/cpu на инстансе, увеличение количество инстансов сервиса.

**Какие точки отказа есть в сервисе?**

- Отказ Yandex Iot Core.
- Отказ Postgres.

**Укажите ключевые продуктовые метрики сервиса, за которыми планируете следить**

- Количество аккумуляторов и их заряды в шкафах.
- Количество аккумуляторов у техников.

**Укажите технические метрики**

- Количество запросов.
- Максимальное и среднее время ответа на запрос.
- Количество записей в бд.

**Какая функциональность ожидается в сервисе в будущем?**

Функционал, связанный с контролем/выдачей/получением аккумуляторов: обвязки над обменом сообщений по mqtt-протоколу с очередью сообщений.

**Какое изменение нагрузки планируется?**

Прямо пропорционально количеству шкафов + техников.

**Активно ли будет изменяться сервис?**

В основном меняться будет набор поддерживаемых сервисом команд для отправки в очередь.
