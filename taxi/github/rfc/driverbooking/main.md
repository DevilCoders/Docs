# Букинг водителей

[Проработка MVP](https://wiki.yandex-team.ru/users/e-ovcharenko/driverbooking/)

## О проекте

Заказать машину, оплатить сразу несколько часов и кататься. 
Пользователю — личный водитель с машиной, чтобы сделать все дела.
Сервису — 100% эффективность водителя в это время.

[Продуктовое описание](https://wiki.yandex-team.ru/users/boldov/driver-booking/)

## Flow

### Заказ такси

- Можно будет забукать водителя на любом тарифе.
- Количество часов для букинга - будет задаваться в виде требований к тарифу.
- Возможно, придётся делать специальный диспатч водителя, с учётом усталости.

### Отмена заказа
После 300секунд после начала поездки, поездку отменить сможет только водитель (оставляем текущее поведение).

1. Используем текущее поведение и отменяем по минималке.
2. Не списываем активность при отказе водителя от заказа

## Задачи


1. Расчёт цены
    1. [В калькулятор добавляем расчёт цены с учётом новых параметров требований](#Калькулятор) - 3d - 5d
    2. [Подменяем тариф для таксометра, с учётом новых параметров требований](#/get_tariffs) - 4d

2. Отображение
    1. Добавляем в требования, коэффициенты тарифа [/tariff /set_tariff](#/tariff/set_tariff) - 3d
    2. На клиент в [/totw](#/taxiontheway) отправляем информацию о текущем состоянии поездки (пуши об окончании поездки, оставшиеся время поездки) - 3 - 4d
    3. [Запрещаем делать заказ одновременно с двумя требованиями-тарифами [/ordercommit](#/ordercommit) [/routestats](#/routestats) (этап 2) - 5d
    4. Отдаём правильные названия требований в [/zoneinfo](#/zoneinfo) - 1-3d
    5. Не уменьшать активность водителей за отмену заказа [setcar](#setcar) - 2d
    6. Давать делать заказ только по free_route [/routestats, /ordercommit](#force_free_route) - 5d

    Обсуждение:

    7. Показывать водителю что данный заказ по букингу (на стадии обсуждения) - ?d

3. Метрики - 4d

## Протокол

### Калькулятор
- Добавляем новый сценарий(или используем текущий free_route) при котором используются коэффициенты тарифа из требования. Учитываем сурж и скидки.

### /routestats
- Запрещаем делать заказ с несколькими требованиями с индивидуальной тарификацией. Через CheckTariffAvailable.

### /ordercommit
- Запрещаем делать заказ с несколькими требованиями с индивидуальной тарификацией.

### /zoneinfo
MVP: https://st.yandex-team.ru/TAXIA-6878

API для показа информации о требовании.
Добавляем новый опциональный объект в элементы массива **supported_requirements**

```
{
  ...
  "information_popup": {
    "info_screen_link_title": "some title",
    "icon_tag": "other_requirement_booking_icon",
    "top_title": "top_title",
    "top_description": "top_description",
    "info_screen_texts": [
        {
            "title": "some title",
            "text": "some text"
        },
        {
            "title": "some title",
            "text": "some text"
        },
        {
            "title": "some title",
            "text": "some text"
        }
        ...
    ]
  }
}
```

Логика на клиентах:
- Попытаться прочитать **information_popup**
- В случае провала, попытаться прочитать данные из эксперемента

Варианты:
1. Для того чтобы показать цену за требования, шаблонизируем label.
2. Используем новое поле для цены + переделка клиента

+ Проверить другие места в которых используются требования.

- Миша категорически против того чтобы не показывать цену.

### /taxiontheway
MVP: https://st.yandex-team.ru/TAXIBACKEND-21650
Текущий согласованный API из https://st.yandex-team.ru/TAXIBACKEND-21650#5cd08516902b8f00229c4e28
```
...
{
  "status_info": {  # уже используется для времени платного ожидания
    ...
    "prepaid_time_ends_at": ..., # абсолютное время окончания заказа в формате iso - понадобится для параметров шаблонов
    "translations": {
      "card": {  # шаблоны для карточки (внизу экрана)
          "title_template": "$BEFORE_PREPAID_TIME_MINUTES_SECONDS$",
          "subtitle_template": "Итоговая стоимость - в конце поездки"
      },
      "status": {  # шаблоны для статуса (вверху экрана)
          "title_template": "$BEFORE_PREPAID_TIME_MINUTES_SECONDS$",
          "subtitle_template": "Итоговая стоимость - в конце поездки"
      }
    }
  },
  "notifications": { # оставляем только пуши
    "prepaid_time_push": {
      "type": "prepaid_time_push",
      "show_time": ..., # абсолютное время показа пуша в формате iso
      "translations": {
        "title_template": "...",
        "subtitle_template": "..."
      }
    }
  }
}
...
```
Утверждены шаблоны вида:
```
$CAR_NUMBER$ - красиво отформатированный номер авто
$BEFORE_PREPAID_TIME_MINUTES_SECONDS$ - время до окончания заказ в формате минуты:секунды
$BEFORE_PREPAID_TIME_HOURS_MINUTES$ - время до окончания заказ в формате часы:минуты
$AFTER_PREPAID_TIME_MINUTES_SECONDS$ - время после окончания заказ в формате минуты:секунды
$AFTER_PREPAID_TIME_HOURS_MINUTES$ - время после окончания заказ в формате часы:минуты
```

+ Изменить описание тарифа в деталях поездки

Пуши - 2d
Время - 1-2d

### /order_cost и /track_order_cost
Возможно, потребуется минимальная доработка.
Оценка доработки возможна после доработки калькулятора

### setcar

Сделать конфиг REQUIREMENT_SKIP_FIELDS по аналогии TARIFF_SKIP_FIELDS
Отдать на ревью @taxibi

- Добавить новое требование в build_setcar

### /tariff/set_tariff

Новые поля у требований тарифа

Приемущества данного варианта в том, что можно будет полностью заменить интервалы в калькуляторе, без дополнительных вычислений.

```
{
    "type": "booking.2_hours",
    "max_price": 100500,
    "price": {
      "included_distance": 123,
      "included_time": 120,
      "distance_multiplier": 0.8,
      "time_multiplier": 0.1
    }
}
```
**included_distance** - предоплаченное расстояние, при превышении данной величины, включется расчёт по счётчику

**included_time** - предоплаченное время поездки, при превышении данной величины, включется расчёт по счётчику

**distance_multiplier** - коэффициент к цене тарифа по расстоянию

**time_multiplier** - коэффициент к цене тарифа по времени

При создании/изменении тарифа из указанных выше коэффициентов формируются новые интервалы на основе тарифа текущей домашней зоны.
Интервалы имеют тип **special_taximeters** и сохраняются в объект **price**.
Предварительное вычисление необходимо для того чтобы логику с расчётом интервалов не размазывать по 3-4 репозиториям.
Пример:

```
{
  "p": 2000.0,
  "t": "booking.1hours",
  "price": {
    "included_distance": 100,
    "included_time": 60,
    "distance_multiplier": 1,
    "time_multiplier": 1,
    "st": [
      {
        "p": {
          "dmi": 6,
          "dpi": [
            {
              "b": 100,
              "p": 32
            }
          ],
          "tmi": 5,
          "tpi": [
            {
              "b": 60,
              "p": 8
            }
          ]
        },
        "z": "moscow"
      },
      {
        "p": {
          "dmi": 6,
          "dpi": [
            {
              "b": 100,
              "p": 32
            }
          ],
          "tmi": 5,
          "tpi": [
            {
              "b": 60,
              "p": 8
            }
          ]
        },
        "z": "suburb"
      }
    ]
  }
}
```

### /get_tariffs

1. Изменить тариф для таксометра с учётом требования
2. waiting_in_transit - занулять при требовании букинга(возможно это нужно делать в другом месте)
3. Дублировать логику /get_tariffs py3

Проверить:
- У таксометра ограниченное количество новых тарифов

Возникшие проблемы:
- По причине того что таксометр кэширует полученные от бэка тарифы, нельзя не изменив id тарифа подменить в нём интервалы
- Ручка ничего не знает про выбранные пользователем требования

Решение:
- Добавляем поле ```requirement``` в id тарифа отсылаемого в setcar, после содержит в себе название требования модифицирующее расчёт тарифа.
- В ручке /get_tariffs, при наличии данного поля, подменяем интервалы тарифа, на интервалы из требования


### force_free_route

В routestats и ordercommit

Убирать точку Б при требовании букинга

Использовать плагинную систему
