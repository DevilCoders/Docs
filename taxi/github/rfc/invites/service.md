## Закрытый клуб Яндекс Go: онбординг и шорткаты  по инвайтам
#### Верхнеуровневое описание

### Терминология

- __Онбординг__ - набор баннеров/экранов, появляющихся при запуске приложения, которые показывают новые возможности Яндекс Go
- __Шорткаты__ - отображение новых возможностей Яндекс Go в виде небольших плашек-категорий
- __Инвайт__ - ссылка, которая дает возможность видеть онбординг и шорткаты

### Требования
__ЭТАП 1:__

C определенного момента X известному набору пользователей (закрытый клуб) Я.Такси:
- при открытии приложения показать _онбординг_ и _шорткаты_,
- в шорткатах показать N инвайтов, которыми можно поделиться с другими клиентами через системную поделяшку.

Для остальных пользователей: при переходе по инвайту добавить пользователя в закрытый клуб,
 чтобы у него отобразились _онбординг_ и _шорткаты_ c N инвайтами.

__ЭТАП 2:__

C определенного момента Y выключить логику инвайтов 
и включить _онбординг_ и _шорткаты_ на всех пользователей.


### Реализация

1. __Реализация закрытого клуба__

Все пользователи закрытого клуба будут храниться в pg-таблице _invites.members_.

В приложении признаком причастности человека к закрытому клубу является наличие в ответе `/4.0/persuggest/v1/finalsuggest` 
_typed_experiments_:
- `go_onboarding` - данные для онбординга
- `superapp_shortcuts` - отоброжать шорткаты.

_Как в `finalsuggest` определяется, нужно ли пользователю показывать онбоардинг?_

В `finalsuggest` сначала делаем запрос в сервис _invites_, который определяет, принадлежит ли пользователь к закрытому клубу.
Если пользователь из закрытого клуба, то в кварги экспериментов пробрасываем параметр `{"secret_club": "yandex_go"}`,
в экспериментах проверяется наличие этого параметра и после этого отдаются два вышеуказанных эксперимента.

После того, как в `finalsuggest` будет получена информацию об onboarding, пользователю показывается onboarding и далее - шорткаты. Приложение локально запоминает, что пользователь просмотрел onboarding и после этого его больше не показывает.

_Как добавляем людей в закрытый клуб?_

В эксперименте `invites_secret_group`:
- указываем phone_id пользователей или
- заводим правило для группы людей

При проверке вхождения пользователя в закрытый клуб, сначала смотрим наличие пользователя в _invites.members_, если его там нет, про проверям в эксперименте `invites_secret_group`, и если пользователь там есть, то добавляем в _invites.members_.

**Важно**: вхождение пользователя в эксперимент `invites_secret_group` дает возможность пользователю попасть в закрытый клуб, но удаление пользователя из эксперимента не удаляет его из закрытого клуба, т.к. члены закрытого клуба хранятся не в эксперименте, а в таблице _invites.members_.


2. __Реализация инвайтов__

На каждого пользователя из закрытого клуба создается N уникальных ссылок,
которые в будущем могут активировать N клиентов не из закрытого клуба.
Ссылки будут созданы в pg-таблице _invites.codes_ при первом запросе списка инвайтов.

Инвайты приходят в шорткатах, по каждому инвайту отдается информация, была ли активация инвайта или нет.

_Активация инвайта_

Пользователь переходит по инвайт-ссылке -> В приложении дергается ручка `/4.0/invites/v1/activate`,
которая возвращает результат обработки в виде кода и тексты для нотификации.

Коды ответов:

|    Код ответа    |   Описание   |
| ---------------- |--------------|
| `code_activated`  | инвайт активирован или был активирован раннее |
| `code_invalid`    | инвайт не активирован, т.к. не существует |
| `code_used`       | инвайт не активирован, т.к. активирован другим пользователем |
| `code_redundant`  | инвайт не активирован, т.к. пользователь уже в закрытом клубе без участие переданного инвайта |
| `outdated_app`    | инвайт активирован, в info говорится, что пользователю нужно обновить версию приложения |
| `outdated_os`     | инвайт активирован, в info говорится, что пользователю нужно обновить версию ОС |

Для каждого кода также отдается структура info, которая содержит тексты для нотификации.

Из эксперименента3.0  забираем тексты ответов (переведенные танкерные ключи - ключи разбиты по кодам ответов),
и кладем в ответ тексты для текущего кода ответа.

_Пример ответа ручки:_

```
{
  "code": "code_activated",
  "info": {
    "title_text" : "Ты сейчас в поездке",
    "body_text" : "Магия произойдет сразу после завершения поездки",
    "confirm_button_title": "ОК",
    "cancel_button_title": "Что же вы так",
    "is_close_button_visible" : true
  }
}

```

При активации приглашенный пользователь запоминается в _invites.members_, инвайт считается активированным 
и пользователь записывается в таблицу _invites.members_, после этого в `finalsuggest` будет приходить онбоардинг и  шорткаты.

Ручка идемпотентна, т.к. при повторой успешной активации будет возвращен код `code_activated`.

4. __Отображение инвайтов в шорткатах__

Будет добавлен новый blender source - invites, который будет отдавать информацию по инвайтам пользователя.

Структура source определяется в PR https://github.yandex-team.ru/taxi/uservices/pull/6944/files

Основная логика source:
- определить, является ли пользователь участником закрытого клуба (в таблице `invites.members` или в эксперименте `invites_secret_group`)
- если пользователь попадает в закрытый клуб, то вернуть данные для отображения инвайтов

Далее клиенты запоминают [данные по инвайтам](https://github.yandex-team.ru/taxi/uservices/pull/6944) и при переходе по шорткату отображают их. Если пользователь переходит напрямую по диплинку, то клиенты сами синхронно забируют даннные по инвайтам.

5. Отключаем сервис инвайтов после даты Y

1. Убеждаемся, что правильно настроены эксперименты `go_onboarding`и `superapp_shortcuts`, то есть чтобы пользователи из закрытой группы попадали под другие правила эксперимента.
2. Отключаем blender source - invites
3. В `finalsuggest` отключаем походы в invites
