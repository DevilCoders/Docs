## Оффер без requirements

#### Текущий клиентский протокол требований
* routestats:
  requirements: выбранные требования в текущей категории (selected_class)
  tariff_requirements: выбранные требования по категориям, используются для расчета ETA/цен на саммари
* orderdraft:
  class: класс(ы) по которым возможен заказ, например [econom, comfortplus] в мультиклассе
  requirements:
    требования, доступные в категории заказа
    мультикласс: отсутствует
  
*Недоступные пожелания (НП)* в категории -- те пожелания из routestats.requirements, которых в ней быть не может:
1. Нет в настройках тарифной зоны
2. Недоступны для данного метода оплаты
3. hourly_rental

Если в категории есть НП:
* "requirements_v2" in not supported (старый флоу): в категории возвращается tariff_unavailable с code: "unsupported_requirement"
* "requirements_v2" in supported: в категории считается ETA/цена без учета этих НП
          
### Проверка требований в ordercommit
Суть проверки в том, чтобы в заказе были те же требования, которые пользователь увидел в оффере.
К примеру, п-ль накликал требований и быстро нажал Заказать.
Проверка не пройдет и пользователь увидит сообщение "цена изменилась".
Сейчас проверяется requirements текущей категории оффера, и из-за этого есть проблемы:

#### Проблема 1: tariff_specific пожелания
Заказ может быть не по той же категории что была текущей в оффере (при переключении rs не дергается).
tariff_specific пожелание может быть недоступно в категории заказа.

Поэтому когда-то давно сделали костыль:

Недоступные tariff_specific отбрасываются из requirements оффера, так как они
не учитываются при расчете ETA/цены в категориях где этих пожеланий нет.
* В новом флоу (requirements_v2 in supported) отбрасываются вообще любые НП.

Недостаток костыля (незначительный):

Пользователь может сбросить пожелания, не дождаться ответа rs с новой ценой и сделать заказ.
Заказ будет сделан без пожеланий, цена будет отличаться в меньшую сторону от той, которая была в оффере
ещё см. https://st.yandex-team.ru/TAXIBACKEND-33948

#### Проблема 2: объединение Детских кресел
В новом флоу единое пожелание childchair_v2 по всем категориям, которое может принимать разные значения: 
1. (routestats) `{selected_class: child_tariff, requirements: {"childchair_v2": [1, 1]}}`
2. Клиент переключился на comfortplus и нажал заказать, пришел orderdraft с
   `class: ["comfortplus"], "requirements": {"childchair_v2": [1]}`
   так как в K+ можно только 1 кресло

*Сравнение требований не будет работать*

#### Проблема 3: требования в мультиклассе
Текущий orderdraft API позволяет передать только единый для всех выбранных категорий список требований.

##### Что сейчас не так
Клиенты при переключении на мультикласс блокируют заказ если в какой-то из выбранных категорий выбрано
не-tariff_specific пожелание которого нет в других. Кнопка "Сбросить НП" сбрасывает его, но оставляет tariff_specific пожелания и те, которые есть во всех категориях (здесь могут быть нюансы, но в целом так).

Это приводит к проблеме ordercommit 406 (https://st.yandex-team.ru/TAXIDUTY-17833):

Выбираем tariff_specific пожелание dont_open_door в Бизнесе, переходим на Самый быстрый,
там выбираем Эконом, Комфорт и Бизнес.
Текущая логика отбрасывает пожелания только если их нет в выбранных категориях,
поэтому пожелание остается в оффере, и не проходит проверку
(в orderdraft для мультикласса приходит пустой requirements)

##### Продуктовое решение для MVP нового флоу (с бабблами)
Если в выбранных категориях есть любые требования 
а) блокируем заказ
б) рисуем баббл который сбрасывает ВСЕ пожелания в выбранных категориях и дергает rs. 

То есть не поддерживаем пока требования, и это решает проблему 3


### Предлагаемое решение
1. (протокол routestats) В оффере вместо requirements сохранять tariff_requirements
2. (протокол ordercommit) В ordercommit проверять не `order.requirements == offer.requirements` а
   `order.requirements == offer.tariff_requirements[class]` для одного класса.

#### Для мультикласса на старом флоу
Клиенты для старого флоу и MVP *не передают* в orderdraft requirements (список order.requirements выше пустой)
Не вдаваясь в подробности, [текущая проверка](https://github.yandex-team.ru/taxi/backend-cpp/blob/6eed13dae1465842f283f8446d42036ca8dca223/protocol/lib/src/orderkit/calcinfo_processing.cpp#L180)
для мультикласса по сути рандом и бессмысленна.

Мы можем проверить, что по выбранным категориям в оффере только tariff_specific требования (на новом флоу с бабблами проверка не имеет смысла).
```
for _class in classes:
  for offer_req in offer.tariff_requirements[_class]:
    if not offer_req.is_tariff_specific():
      throw "Цена изменилась!"
```

Потом когда будет продуктовое решение по требованиям в мультиклассе можно будет упростить валидацию
(когда клиенты смогут передавать в orderdraft tariff_requirements),
но в MVP и на старых клиентах придется жить так.

#### Резюме
Предлагается 
* отказаться от requirements в оффере
* упростить код валидации в ordercommit
* улучшить валидацию в ordercommit, решив проблему на старом флоу
* Разблокировать фичу объединения Детских кресел
* Разблокировать фичу Детской вертикали

PROFIT!
