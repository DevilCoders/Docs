# Проект "Спасибо водителям"
https://st.yandex-team.ru/TAXIPROJECTS-1397

## tl;dr
В данном RFC описывается взаимодействие между пользователем, приложением, бекендом и фронтендом для проекта "спасибо водителям". Более подробное описание проекта см. в тикете.

## Алгоритм работы
1. Пользователь завершает поездку в такси или заказ в еде/лавке, выставляя оценку в 5 звёзд;
2. Открывается фуллскрин с благодарностью водителя/курьера и кнопкой "поделиться";
3. При нажатии на кнопку пользователю предлагается запостить ссылку в соцсеть.

### Логика отображения фулскрина
Приложение запоминает был ли уже показан фулскрин пользователю. Фулскрины с благодарностью водителя и курьера запоминаются независимо друг от друга.

Фулскрин отображается только если пришёл эксперимент.

Если в эксперименте пришёл параметр `show_fullscreen_probability`, то фулскрин показывается с вероятностью от 0 до 1 вне зависимости от того был ли он показан до этого.

Если параметр отсутствует, то фулскрин показывается только один раз.


### Схема создания шарилки (при использовании DB)
![image](static/sharing.png)

### Схема просмотра шарилки
![image](static/share_view.png)


## Бэкенд

### Используемый сервис
Для экономии времени новый функционал встраиваем в сервис ny2020 - в данном сервисе имеется большая часть необходимого кода:
* генерация картинок
* заливка картинок в MDS

При этом мы закоммитились вывести сервис из эксплуатации и депрекейтнуть его до 30 июня.

### Используемый бакет MDS
Для экономии времени мы переиспользуем бакет MDS, созданный для проекта нового года. Факт того что ссылка на картинку шарилки будет содержать `ny2020` согласован, и продуктово - ОК.

#### Адрес картинки в MDS
Используется бакет нового года:
https://s3.mds.yandex.net/ny2020/shares/{share_id}

Для доступности бакетов снаружи используется прокся. Про проксю уточнил у @twin - выключать пока не планируют

На странице фронтенда встраиваем в META ссылку одного из следующих форматов:
* https://taxi-ny2020.s3.yandex.net/shares/{share_id}
* https://taxi.yandex.ru/nyimage/(share_id)




### Новая ручка
Для поддержки нового функционала создаём одну новую ручку в сервисе ny2020:

`PUT /4.0/driver_heroes/share`

#### Авторизация
Ручка доступна через Passenger-Authorizer

#### Получение имени водителя/курьера
Имя водителя можно получить по order_id, приходящем в ручку.

Имя курьера на данный момент __нельзя__ получить по order_id заказа еды/лавки - в API Еды нет соответствующих методов. Возможные решения:
* Попросить у еды сделать ручку (По этому вопросу идти к @thelena)
* Пересылать из приложения имя курьера вместе с ID заказа (https://st.yandex-team.ru/TAXISECURITY-1005)

#### Генерация картинки шарилки
1. Используя параметры из PA (phone_id) идём в сервис экспериментов;
2. Из эксперимента узнаём параметры для картинки:
    * цвет
    * улыбку
    * границу использования fallback-картинки для длинных имен (long_name_threshold)
3. Получаем имя водителя/курьера;
4. Генерируем из шаблона картинку или берём fallback-картинку для длинных имен;
5. Генерируем share_id и загружаем по нему картинку в бакет MDS;
6. Возвращаем share_id/share_url.

#### Сохранение в базу
Можно реализовать сохранение информации о созданных шарилках в базу. Для этого в алгоритме генерации картинки нужно внести следующие изменения:
1. Проверять order_id в базе на предмет созданной шарилки
2. Сохранять пару service+order_id и share_id в базу данных перед возвращением

Плюсы:
* Можно избежать повторной генерации при проблемах с сетью
* Известна информация о всех созданных шарилках - статистика, можно выборочно удалить

Минусы:
* Требует дополнительной разработки: новая коллекция, логика взаимодействия с базой

#### Fallback для длинных имён водителей
Не все имена нормально умещаются на шаблонах. Для водителей/курьеров, чьи имена длинее поддерживаемых, созданы fallback-картинки без имени.

Максимальная длина имён указана в эксперименте - параметр `long_name_threshold`. Если полученное имя водителя/курьера длиннее заданого параметра или если имя неизвестно, должен использоваться соответствующий шаблон.

Информацию о том какой шаблон следует использовать берём из эксперимента:
* цвет
* вариант улыбки
* вариант текста

Для определения того какой вариант текста нужен следует смотреть на параметр `long_name_choice_id` в эксперименте.

## Эксперимент

### Потребители
Клиенты:
* client_protocol/suggest_pin_drop
Бэкенд:
* _Новый потребитель для создаваемой ручки_

#### Почему не totw?
Потому-что в в totw можно получить только при поездке, а у нас ещё курьеры еды/лавки


### Значение эксперимента
Рандомные параметры:
1. Цвет фона:
    * Желтый `#ffde40`
    * Сиреневый `#a7a8e8`
    * Голубой `#95c6fd`
    * Красный `#fc5545`
2. Тег картинки улыбки (4 варианта)
3. fallback-текст для длинных картинок (4 варианта)

Рандомные параметры не связаны между собой, в эксперименте задаются используя три выборки с параметром [mod_sha1_with_salt](https://wiki.yandex-team.ru/taxi/backend/architecture/experiments3/manual/) и разными `salt` для создания "матрицы 4x4x4".

Общие параметры:
1. Заголовок фулскрина
2. Текст фулскрина
3. long_name_threshold

Версии приложений:
* android > 3.146.0
* iphone > 5.4.4


Схема эксперимента:
```yaml
type: object
properties:
    color:
        type: string
        description: Цвет фона фулскрина
    show_fullscreen_probability:
        type: number
        description: С какой вероятностью отображать фулскрин (от 0 до 1)
    long_name_threshold:
        type: integer
    long_name_choice_id:
        type: string
    drivers:
        type: object
        properties:
            smile_tag:
                type: string
            title_template:
                type: string
            text_template:
                type: string
            long_name_title:
                type: string
            long_name_text:
                type: string
        required:
          - smile_tag
          - title_template
          - text_template
          - long_name_title
          - long_name_text
        additionalProperties: false
    couriers:
        type: object
        properties:
            smile_tag:
                type: string
            title_template:
                type: string
            text_template:
                type: string
            long_name_title:
                type: string
            long_name_text:
                type: string
        required:
          - smile_tag
          - title_template
          - text_template
          - long_name_title
          - long_name_text
        additionalProperties: false
required:
  - color
  - long_name_threshold
  - long_name_choice_id
  - drivers
  - couriers
additionalProperties: false
```

### Обновление параметров эксперимента
Так как эксперимент огромный - 64 возможные комбинации параметров - для его обновления написан скрипт [`experiment_generator.py`](https://github.yandex-team.ru/taxi/tools-py3/pull/1882).

Для изменения параметров эксперимента необходимо изменить их в скрипте, запустить его, скопировать сгенерированный скрипт и импортировать его в админке экспериментов.
