# Диагностика долгов

## Ручка получения списка долгов (/internal/admin/orders/list)

Предполагается, что саппорт вводит номер телефона, фронт идет в ручку [user_phones/by_number/retrieve](https://pages.github.yandex-team.ru/taxi/schemas/Taxi_Documentation/Uservices/user-api/api/user_phones/#user_phonesby_numberretrieve) и на вход ручки сервиса долгов прилетает уже phone_id

В ответе ручка возвращает список долговых заказов пользователей, которые есть хотябы в одной из сущностей: в заказе, сервисе долгов или в локах, в каких сущностях есть эти долги информируют соответсвующие флаги: 
* видит ли долг - означает, что пользователь в ручке paymentstatuses получает информацию о долге (долг есть в заказе)
* влияет ли на заказ - долг есть в сервисе долгов

Так же возвращается базовая информация по заказу: id заказа, время создания, id телефона, бренд, сумма долга (если есть долг в сервисе долгов), валюта долга, источник информации о долге (базы данных, в которых есть этот долг)


Алгоритм работы следующий:
* Получить список долгов из postgres базы сервиса долгов
* сходить в phonelocks за долгами
* Сходить в db_orders за заказами. Проверить payment_tech.debt
* Если долг есть в db.orders.payment_tech.debt, то соответсвенно этот долг видит пользователь
* Если долг есть в debts, то это влияет на заказ


## Подробная ручка долга (/internal/admin/orders)

На вход принимает order_id

Ручка аналогична orders/list, только она дополнительно возвращает долговые заказы по заданной карте и номеру телефона пользователя, а так же техническую информацию: наличие флага долга в dborders, наличие в orderlocks, наличие в сервисе долгов

Алгоритм работы:
* Сходить за заказом в архив (либо в монгу db.orders)
* Сходить в cardlocks если заказ по карте и найти связанные заказазы (т.е. записи долгов где в поле x лежит order_id)
* Сходить в phonelocks и вытащить оттуда связанные долговые заказы
* Вытащить долг из базы debts


## Ручка лайт снятия долга (/internal/admin/orders/release/light)

Предполагается, что ее может нажимать любой саппорт, надо только выдать право release_debts_light

Алгоритм работы:
* Ручка должна сходить в db.orders и проверить, что если заказ не долговой (т. е. payment_tech.debt = false), то необходимо снять долг (аналогично скрипту https://github.yandex-team.ru/taxi/tools/blob/7b4b279a8f477159283fb64729dec6026a4de544/one-time/unset_debt.py)


## Ручка снятия долга (/internal/admin/orders/release/hard)

Ручка призвана снимать долг во всех сущностях, которые хранят эту информацию. Для возможности дерганья ручки нужно будет право release_debts, действие будет логироваться в журнале аудита


На вход принимает order_id

Алгоритм работы:
* Сделать {'$pull': {'x': order_id}}  для всех orderlocks
* В db.orders установить payment_tech.debt = False (надо уточнить что еще надо убирать)
* Удалить заказ из базы debts


## Ручка начисления долга (/internal/admin/orders/make_debt)

Эта ручка обратная ручкам снятия долга, она будет вешать на заданный заказ долг

Алгоритм работы:
* Найти заказ в db.orders (если нет, то необходимо восстановить из архива)
* Установить payment_tech.debt = True
* Поставить таску debts_processing c параметрами аналогичными в py2 (https://github.yandex-team.ru/taxi/backend/blob/2272ac7a0709777f117c3f02dae7ff373836e767/taxi/internal/order_kit/debts_handler.py#L20)
