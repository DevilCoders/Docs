# Проект платные дороги

Нужно предложить пассажиру альтернативу: ехать по платной дороге или по бесплатной. Соответственно, этот выбор нужно будет запомнить, показать водителю и использовать в расчёте стоимости.

Также нужно после проезда по платной дороге уметь списывать деньги с карты пассажира.

## Части проекта

### Часть первая: информирование

#### Заказ такси

Добавляем в routestats новый опциональный параметр запроса `use_toll_roads`.

Клиенты при указании точки Б делают параллельно запросы в мапкит и routestats как и раньше.

Если из мапкита пришёл самым быстрым платный маршрут и среди альтернатив есть бесплатный, то клиенты рисуют два маршрута: выделен бесплатный и серым платный, и есть кнопка с переключателем.

Условие что самым быстрым является платный маршрут критично, так как в routestats не будет возможности выбрать медленный платный маршрут.

При переключении на платную дорогу, клиент делает дополнительный запрос в routestats с параметром `use_toll_roads = true`.

Таким образом у клиента будет два оффера и с одним из них он создаст поездку.

Ручка routestats должна строить маршрут исходя из значения переданного параметра, а не значения из [эксперимента](https://st.yandex-team.ru/EFFICIENCYDEV-1893).

Также для случаев выбора платной дороги нужно добавить поход в новый сервис, который будет сохранять связку `offer_id-use_toll_roads`.

Поддержку платной дороги нужно добавить в свойства тарифа в ответе zoneinfo, чтобы клиенты не давали выбрать платную дорогу для курьера и грузового.

#### TOTW

Нужно через api_proxy сделать доп. запрос в новый сервис для получения информации, нужно ли строить в поездке маршрут по платной дороге.

#### Таксометр

Таксометр из той же ручки сервиса, что и TOTW будет узнавать, выбрал ли пассажир платную дорогу (по умолчанию считаем, что выбран бесплатный маршрут).

### Дальнейшие доработки первой части

Backend принимает поля `toll_roads.user_had_choice` и `toll_roads.user_chose_toll_road`, смысл которых резюмирован в таблице:

| toll_roads.user_had_choice | toll_roads.user_chose_toll_road | описание |
|:--------------------------:|:-------------------------------:|----------|
| true                       | true                            | выбор был, выбран платный вариант |
| true                       | false                           | выбор был, выбран бесплатный вариант |
| false                      | true                            | единственным выбором был платный вариант |
| false                      | false                           | единственным выбором был бесплатный вариант |
| -                          | -                               | клиент старой версии. логика эквивалентна случаю toll_roads.user_had_choice=false, toll_roads.user_chose_toll_road=false |

В OrderDraft добавляем эти 2 поля в `order_proc.order.request.toll_roads`, и в новом процессинге на uservices ставим stq-таску [toll_roads_order_save](service.md#toll_roads_order_save).

Мы сможем показать водителю уведомление об обоих вариантах его выбора.

Ещё возможно мошенничество: человек будет выбирать платную дорогу, но водителя убеждать ехать по бесплатной, и таким образом экономить деньги/проводить их мимо сервиса. Для этого нужно в условия сброса расчёта стоимости на таксометр добавить проезд по бесплатной дороге при оффере по платной.

В поездке должна быть возможность изменить выбор, ехать по платной или бесплатной. При сбросе с платной на бесплатную мы переводим тарификацию на счётчик.

### Часть вторая: автоматическая оплата

При формировании оффера нужно явно сказать пассажиру, что оплата будет автоматической и соблюсти это обещание, то есть сохранить информацию, что на момент формирования оффера эксперимент с автоматической оплатой был включен.

При завершении поездки нужно скачать трек водителя и произвести его привязку к графу. В ответе привязки мы будем иметь данные о въезде и выезде с платной дороги. По этим координатам мы сможем найти ближайшие известные нам шлагбаумы и посчитать стоимость проезда.

Все эти операции будем проводить в stq-таске и только при оплате картой. Сейчас идёт работа по оплате чаевых и других платежей через apple_pay, а так же теоретически есть возможность снимать плату за доп. услуги не тем же способом, как пассажир платит за поездку. Но это будем прорабатывать и внедрять позже, если гипотезы оправдаются по поездкам с оплатой картой.

После определения стоимости, нужно провести оплату. Для этого нужно поднять инстанс сервиса transactions.

### Дальнейшие доработки второй части

Нужно уметь подписываться на событие заезда и выезда с платной дороги и производить списание сразу.

## Реализация

### Этап I

#### Сервис Платных Дорог (TR)

Новый сервис должен уметь:

* сохранять признак выбора платной дороги по offer_id;
* отдавать значение признака платных дорог по order_id.

#### Изменения в routestats

В ручке routestats будут следующие изменения:

* добавляется параметр `use_toll_roads`, который будет сохраняться в сервис платных дорог после формирования оффера, если пришёл;
* на основании параметра `use_toll_roads` формировать запрос в роутинг таким образом, чтобы мы избегали платных дорог, если false;
* в кейсе наличия более быстрой платной альтернативы и выбора её клиентом, будет происходить доп. запрос;
* в ответе в массиве `notify` придёт объект с `type`=`toll_road`, с полями `title`, `text` для отображения нотификации.
В объект нотификации добавим дополнительное поле `text_id` с идентификатором версии текста, чтобы клиентам не сравнивать тексты, а сравнивать идентификаторы. Это нужно в кейсе, когда мы показываем один текст, а в ответе на второй запрос пришёл другой (переключили эксперимент, супер-редкий кейс).

#### Изменения в TOTW

TOTW сейчас за api-proxy, поэтому нужно просто добавить поход в новый сервис с order_id и добавление данных из него в ответ. Возможно, посмотрим код TOTW и вынесем из него ещё какой-то кусочек, рядом с тем, куда мы бы добавили свой вызов, если бы не было api_proxy.

#### Изменения в zoneinfo

Нужно добавить тарифам (классам) характеристику "поддерживает платные дороги" и задавать её в админке и отдавать клиентам.

### Этап II

#### Сервис transactions

Нужно поднять сервис transactions для платных дорог. Этот сервис будет смотреть на новую БД и хранить там данные по order_id. Оплачивать там будем только платные дороги.

#### Добавится в routestats

Нужно будет на этом этапе проверять, попал ли пользователь в эксперимент с автооплатой, отдавать ему правильные тексты и сохранять факт автооплаты в сервисе TR.

#### Сервис TR

Нужно в ручке сохранения выбора сохранять ещё и флажок автооплаты при наличии.

#### STQ-таск для оплаты

Если поездка по карте, то мы:

1. запрашиваем трек водителя (ручка [geotracks/gps-storage/get](https://wiki.yandex-team.ru/taxi/backend/architecture/geotracks/#api>)),
1. делаем привязку трека к графу (ручка [adjust/track](https://wiki.yandex-team.ru/taxi/backend/graph/services/yaga-adjust/#ruchkaadjust/track) сервиса `yaga-adjust`),
1. из ответа `yaga-adjust` мы получаем координаты въезда и выезда с платной дороги (делается по задаче [TAXIGRAPH-914](https://st.yandex-team.ru/TAXIGRAPH-914)),
1. по новому конфигу по координатам въезда/выезда находим ближайшие шлагбаумы и по конфигу считаем стоимость проезда между ними,
1. отправляем в новый инстанс transactions запросы на оплату нужной суммы с карты.

### Особенности включения, тексты и прочее

Нужно уметь включать первый этап экспериментом по зонам.
При этом второй этап планируем включать экспериментом по зонам и тарифам.

Для клиентов второй этап отличается от первого только текстами: при попадании в эксперимент по второму этапу, пользователю нужно сказать, что платить самому не нужно, всё будет оплачено автоматически.

Эта информация жестко связана с оффером и не должна меняться после его отображения, таким образом единственное место, где мы можем корректно проверить и зафиксировать значение эксперимента -- это routestats. Так что нужно там проверять эксперимент и отдавать правильный текст на клиент.

Второй этап можно включать только тем, у кого включен первый. Поэтому при его запуске до включения первого на 100%, нужно включать его с той же солью.

Основные гипотезы:

* упадёт Defect rate — жалобы в саппорт
* вырастет DSAT — платные дороги входят в топ-10 жалоб водителей и в топ-5 целей программы Большая перемена
* вырастет конверсия в поездку — время по платке меньше, конверсия должна вырасти
* вырастет количество поездок по платным дорогам в А/Б (части юзеров покажем, части нет)
* вырастет MPH
* вырастет SH

На данный момент гипотезы не имеют числового эквивалента, так как сложно посчитать прогноз. Но на уровне ощущений должно быть именно так.

### Доработки этапа I

#### Доработки сервиса TR

Нужно добавить:

* проверять и записывать признак платных дорог по order_id;
* хранить данные ограниченное время (по офферу — время жизни оффера, по заказу — реплицировать в YT). Это дальнейшая доработка, так как записей ожидается не много.

#### OrderDraft

Нужно добавить:

* опциональную структуру `toll_roads` с двумя полями `user_had_choice` и `user_chose_toll_road` в запрос,
* если параметр пришёл, делаем запрос к сервису TR в ручку проверки и записи по order_id,
* если случился конфликт — оффер не соответствует ордеру, отдаём ошибку,
* если записи нет — добавляем.

### Сброс платной дороги

Нужно научиться сбрасывать флаг платной дороги.

#### Ручка смены платности дороги

В сервисе TR нужна ручка, которая изменит существующую запись. При этом нужно сбрасывать цену на таксометр при сбросе с платной на бесплатную. И присылать нотификацию водителю при переключении в обе стороны. У пассажира нужно спросить подтверждение действия.

### Доработки этапа II

#### Сервис нотификаций о перемещениях водителя

Нужен новый сервис, который будет в режиме реального времени отслеживать перемещения водителей и при наступлении определённых событий (въезд на платную дорогу, выезд с неё, проезд через шлагбаум) будет создавать соответствующее событие для всех заинтересованных сервисов.

#### Доработки TR

Нужно научить сервис Платных дорог подписываться на события из сервиса нотификаций о перемещениях и сразу при выезде с платной дороги производить списание, не дожидаясь завершения поездки.
