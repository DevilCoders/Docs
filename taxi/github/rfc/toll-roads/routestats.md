# Изменения в routestats для фичи "Платные Дороги" (Toll Roads)

Верхнеуровневая проработка доступна по [ссылке](toll_roads.md).
Проработка сервиса платных дорог [здесь](https://github.yandex-team.ru/taxi/rfc/pull/186).
Дизайн [тут](https://www.figma.com/file/HqiJ8t81poeL4dYL2pDM3xqL/Платные-дороги).

## Изменения в запросе к routestats

Новые версии клиентского приложения будут передавать в запросах к routestats новый параметр `use_toll_roads`. Значение этого флага будет использоваться бэкендом при построении маршрута через router'ы. При первом запросе в routestats передается значение `use_toll_roads = false`, что соответствует попытке построить маршрут, избегая платных дорог (дефолтное поведение).

Если на основании ответа mapkit'а клиентское приложение понимает, что есть возможность проехать по маршруту с платным участком, то у пользователя будет возможность выбрать платный вариант. _Важно:_ платный вариант необязательно должен быть быстрее, так как нужно давать возможность пользователю заказать платный вариант, который на момент совершения заказа медленнее, если пользователь считает, что риск возникновения пробки на бесплатной дороге выше. Если пользователь выбрал платный маршрут (детально пользовательский сценарий описан в общей проработке), то клиентское приложение делает запрос в routestats с `use_toll_roads = true`.

Если в запросе не пришел флаг `use_toll_roads`, то это значит, что запрос пришел с приложения старой версии, где не поддерживается новая фича. Бэкенд в таком случае реализует текущее поведение, а именно передает в роутеры флаг `avoid=tolls` в зависимости от эксперимента. Детали в [тикете](https://st.yandex-team.ru/EFFICIENCYDEV-1893). Про поддержку роутерами флага избегания платных дорог см. [ниже](#как-флаг-use_toll_roads-будет-передаваться-в-роутеры).

## Изменения в ответе routestats

В ответ routestats предлагается добавить объект `toll_roads`, который будет содержать информацию о платных участках на маршруте. Если пассажир делает заказ, не дождавшись ответа routestats, то создается заказ без оффера; в таком случае срабатывает фоллбэк (routestats не ответил), см. детали [ниже](#сценарии-работы-при-различных-комбинациях-флагов-use_toll_roadshas_tolls). То же самое происходит, если клиент сделал изменения, которые ведут к перезапросу routestats (например, поменял способ оплаты), и не, дождавшись ответа, делает заказ.

### Содержит ли построенный на бэкенде маршрут платные участки

В данный момент при построении маршрута в роутеры можно передать флаг использования платных дорог скорее как пожелание, а не требование. То есть на запрос с `use_toll_roads = true` может прийти бесплатная дорога, и наоборот. Таких случаев должно быть немного, но каждый из них заслуживает детальной проработки, см. [ниже](#сценарии-работы-при-различных-комбинациях-флагов-use_toll_roadshas_tolls). Для того, чтобы клиентское приложение понимало, какой в итоге маршрут построен - платный или бесплатный - в ответ предлагается добавить флаг `has_tolls` в объект `toll_roads`.

### Выигрыш по времени при проезде по платной дороге

На экране "Как поедете?" (aka "алерт пользователю", см. дизайн) клиентское приложение показывает, сколько времени выиграет пользователь, если выберет наиболее быстрый маршрут (может быть как платный, так и бесплатный). Для этого нужно сравнить время следования по маршруту из двух ответов routestats (с параметром `use_toll_roads = false/true`). Сейчас время по маршруту передается в ответе в поле `time` в виде локализованной строки (например, "19 мин").

Чтобы клиентскому приложению не делать сложных преобразований по парсингу строки c человекочитаемым временем, в ответ routestats предлагается добавить целочисленное поле `time_seconds`. Значение `time_seconds` должно соответствовать времени, пришедшему в поле `time`. Например, если поездка длится 587 секунд, то в `time` пишем `10 мин`, а в `time_seconds` - 600. Это нужно, чтобы не накапливалась ошибка округлений при расчете выигрыша по времени в клиентском приложении.

### Информация о том, как будет происходить оплата

На первом этапе клиент платит сам (картой, наличными, ...) при въезде на платную дорогу. Об этом пользователь получает информацию на экране "Как поедете?". На втором этапе проекта, когда будет происходить автоматическое списание средств с пользователя, текст должен быть другим, что-то вроде: дополнительно платить ничего не надо, сами спишем деньги с карты, бесшовный проезд, и т.д. Кроме того, текст может меняться и в других местах, например, в текущем варианте дизайна информация о том, что проезд по платной дороге не включен в стоимость, есть на кнопке "Заказать" - "1000 рублей и оплата проезда".

Для того, чтобы клиентское приложение отличало автоматическое списание средств от ручной оплаты клиентом, в ответ routestats в объект `toll_roads` предлагается добавить флаг `auto_payment`. Флаг приходит, если на бэкенде включена автоматическая оплата. При этом на бэкенде надо запоминать, какое значение `auto_payment` мы отправили в клиентское приложение, чтобы защититься от гонок при включении/выключении автоматической оплаты рубильником. То есть, если мы при заказе сказали пользователю, что он платит сам за платную дорогу, а в процессе поездки мы включили фичу автоматического списания, нельзя еще и списать стоимость платной дороги с карточки пользователя.

### Примерная стоимость проезда

Пользователю полезно знать хотя бы примерную стоимость проезда по платной дороге, см. результаты UX-исследования по [ссылке](https://wiki.yandex-team.ru/taxi/UX/Vypolnennye-proekty/2019-12-%D0%9F%D0%BB%D0%B0%D1%82%D0%BD%D1%8B%D0%B5-%D0%B4%D0%BE%D1%80%D0%BE%D0%B3%D0%B8/#obshhievyvody). Например, пользователь прилетел в Москву впервые и собирается взять такси от аэропорта Шереметьево в центр города. Человек, скорее всего, не знает в принципе о существовании платной дороги, не говоря уже о стоимости проезда по ней. Информацию можно узнать, например, у водителя, но это произойдет уже во время поездки, а информация нужна до нажатия кнопки "Заказать".

Не всегда возможно посчитать даже примерную стоимость, как, например, в Питере при проезде по ЗСД, когда есть много въездов и выездов. В таком случае сумма проезда зависит от участка платной дороги, по которому ехала машина. При этом для поездок в/из Шереметьево цену практически наверняка можно указать. В силу описанного, информация о стоимости будет опциональной.

Стоимость будет приходить в объекте `toll_roads` в опциональном поле `price` в виде текста, к которому будут применяться `currency_rules`. Последние уже приходят в ответе routestats.

### Тексты через клиентские эксперименты

Тексты отдаются на клиент с помощью клиентских экспериментов в ручке suggest/pin_drop, которая точно будет дернута до запроса в routestats. Эксперимент `toll_roads` для платных дорог в тестинге - по [ссылке](https://tariff-editor.taxi.tst.yandex-team.ru/experiments3/edit/toll_roads?type=experiments&name=toll_roads). Если ручка suggest/pin_drop не отвечает - всё Такси не работает, так как в этой ручке приходит зона, а без зоны мы не знаем, работает ли здесь сервис вообще.

### Изменения схемы ручки

```yaml
definitions:
  RoutestatsRequest:
    properties:
      ...
      use_toll_roads:
        type: boolean
        description: не избегать платных дорог при построении маршрута
  RoutestatsResponse:
    properties:
      ...
      time_seconds:
        type: integer
        min: 0
        description: время по маршруту в секундах
      toll_roads:
        type: object
        description: информация о платных участках на построенном маршруте
        properties:
          has_tolls:
            type: boolean
            description: содержит ли построенный маршрут платные участки
          auto_payment:
            type: boolean
            description: плата за проезд по платной дороге списывается с клиента автоматически
          price:
            type: string
            description: |-
              приблизительная стоимость проезда по платной дороге, если можно
              посчитать (детали смотреть в проработке сервиса платных дорог)
            example: "~390 $SIGN$$CURRENCY$"
        required:
        - auto_payment
```

## Сценарии работы при различных комбинациях флагов `use_toll_roads/has_tolls`

Ниже описаны различные сценарии наличия платного/бесплатного маршрута `A->B`, варианты ответов mapkit и routestats. В большинстве случаев ответы mapkit и routestats должны совпадать с точки зрения доступности маршрутов, а также с точки зрения, какой из них является наиболее быстрым. Однако могут возникать несоответствия в ответах; эти случаи заслуживают детального описания. Алгоритм посылки запросов в mapkit и routestats описан [выше](#изменения-в-запросе-к-routestats).

Обработчик ручки routestats из протокола делает запрос в сервис toll roads, если либо в запросе в routestats пришел флаг `use_toll_roads = true`, либо роутер прислал в ответе `has_tolls = true`. В сервисе сохраняем информацию о том, что оффер для маршрута с платной дорогой, а также фиксируем способ оплаты за проезд по платному участку (ручной/автосписание), см. [выше](#информация-о-том-как-будет-происходить-оплата).

Если сервис недоступен, то ставим stq-таску, которая будет гарантировать, что мы сохранили способ списания средств для поездки. Если сразу ставить stq-таску без попытки сходить в ручку внутри обработки routestats, то повышаются риски допускать фрод, так как при создании заказа уже нужна информация о платности маршрута в оффере. Если же мы ставим таску, то порядок обработки offer/order внутри сервиса toll roads становится менее предсказуемым. Кроме того, нужно правильно чистить таблицу offers и перемещать старые данные из orders в YT - не перемещать заказы, в которых есть ссылка на оффер, который еще не появился в таблице offers. Данная проработка будет детально описана и сделана на одном из следующих этапов, когда будем делать автосписание.

- C1. Есть только бесплатный маршрут:
  - Предпосылки:
    - mapkit вернул только бесплатный маршрут
    - routestats вернул бесплатный маршрут (на запрос `use_toll_roads = false`)
  - Действия:
    - стандартный сценарий при отсутствии платных дорог, ничего дополнительно делать не нужно

- C2. Есть оба маршрута (платный и бесплатный), платный быстрее:
  - Предпосылки:
    - mapkit вернул два варианта
    - routestats вернул бесплатный маршрут на запрос `use_toll_roads = false`
    - routestats вернул платный маршрут на запрос `use_toll_roads = true`
  - Действия:
    - делаем запрос в сервис toll roads из протокола, чтобы сохранить информацию для второго оффера

- C3. Есть оба маршрута (платный и бесплатный), бесплатный быстрее:
  - Предпосылки:
    - mapkit вернул два варианта
    - routestats вернул бесплатный маршрут на запрос `use_toll_roads = false`
    - routestats вернул бесплатный маршрут на запрос `use_toll_roads = true`, так как он быстрее
  - Действия:
    - на саммари показываем время и стоимость из ответа routestats
    - в алерте (экран "Как поедете?") время платной дороги показываем из ответа mapkit
    - делаем запрос в сервис toll roads из протокола, чтобы сохранить информацию для второго оффера

- C4. Есть только платный маршрут:
  - Предпосылки:
    - mapkit вернул только платный маршрут
    - routestats вернул платный маршрут на запрос `use_toll_roads = false`
    - клиентское приложение не делает второй запрос в routestats, так как уже пришел платный маршрут
  - Действия:
    - делаем запрос в сервис toll roads из протокола, чтобы сохранить информацию для оффера

- C5. Есть оба маршрута (платный и бесплатный), бесплатный **сильно** дольше, так как нужно ждать паром и т.п.:
  - Предпосылки:
    - mapkit вернул два варианта
    - routestats вернул платный маршрут на запрос `use_toll_roads = false`, так как бесплатный **сильно** дольше
    - клиентское приложение не делает второй запрос в routestats, так как уже пришел платный маршрут
  - Действия:
    - на саммари скрываем бесплатный маршрут и оставляем только платный, поведение такое же как в "есть только платный маршрут"
    - делаем запрос в сервис toll roads из протокола, чтобы сохранить информацию для оффера

Далее идет описание фоллбэков в неконсистентных ситуациях.

- Ф1
  - Предпосылки:
    - mapkit вернул только бесплатный маршрут
    - routestats вернул платный маршрут на запрос `use_toll_roads = false`
  - Действия:
    - оставляем на саммари бесплатный маршрут
    - на алерте показываем, что есть только платный маршрут
    - делаем запрос в сервис toll roads из протокола, чтобы сохранить информацию для оффера

- Ф2
  - Предпосылки:
    - mapkit вернул только платный маршрут
    - routestats вернул бесплатный маршрут на запрос `use_toll_roads = false`
    - routestats вернул бесплатный маршрут на запрос `use_toll_roads = true`
  - Действия:
    - алерт пассажиру не показываем

- Ф3
  - Предпосылки:
    - mapkit вернул два варианта
    - routestats не отвечает вообще
  - Действия:
    - рисуем оба маршрута, даем сделать выбор
    - дефолтный алерт с общим текстом (где говорим, что пассажир должен оплатить проезд по платной дороге самостоятельно)
    - пассажир платит сам на кассе
    - поездка по таксометру
    - на бэкенде видим, что заказ без оффера, и не делаем автосписание

- Ф4
  - Предпосылки:
    - mapkit вернул два варианта
    - routestats не вернул флаг `has_tolls` (например, при включении фоллбэка на роутер, который не поддерживает этот флаг)
  - Действия:
    - на саммари показываем время и стоимость из ответа routestats
    - в алерте время платной дороги показываем из ответа mapkit
    - делаем запрос в сервис toll roads из протокола, чтобы сохранить информацию для второго оффера

## Логика работы на бэкенде

### Как флаг `use_toll_roads` будет передаваться в роутеры

В Такси используются различные роутеры для построения маршрута, подробнее про доступные роутеры и алгоритм выбора можно почитать на [вики](https://wiki.yandex-team.ru/taxi/backend/routing/#algoritmvyboramarshrutizatora).

#### Роутер yamaps

Роутер поддерживает параметр `avoid=tolls`, который сейчас отправляется по [эксперименту](https://tariff-editor.taxi.yandex-team.ru/experiments3/edit/yamaps_routing_params?type=experiments), описание - в [тикете](https://st.yandex-team.ru/EFFICIENCYDEV-1893). Судя по [документации](https://wiki.yandex-team.ru/maps/dev/core/mobile/services/mapkit2/driving-2.x/), в ответе есть флаг `has_tolls`, однако он пока не парсится и не передается в ответе routestats.

#### Роутер tigraph

Роутер поддерживает параметр `use_tolls`, который сейчас **не** используется в routestats, нужно будет добавить его отправку в зависимости от значения флага `use_toll_roads`. В ответе роутера есть флаг `is_toll` у всего маршрута, который говорит, что маршрут содержит платный участок.

#### Роутер fallback

Роутер, используемый в качестве фоллбэка в случае недоступности основных роутеров, считает протяженность маршрута как геометрическое расстояние между точками, поэтому, естественно, ничего про платные дороги ничего не скажет.
