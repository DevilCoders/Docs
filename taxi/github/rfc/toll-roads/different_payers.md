# Платные дороги 2.0

Проект описан [здесь](https://st.yandex-team.ru/PARTNERSPROJECT-575)

Задача: научиться определять, была ли предложена пассажиру платная дорога, была ли выбрана платная дорога в качестве маршрута,
кто будет оплачивать проезд по платной дороге: водитель или пассажир.

## Части проекта

### Часть первая: Платные дороги в РФ

#### Заказ такси

Повторяем в estimate в protocol механизм, реализованный в routestats: добавляем новый опциональный параметр запроса `use_toll_roads`.
Партнеры при указании точки Б делают параллельно запросы в mapkit и int-api.
При переключении на платную дорогу, клиент делает дополнительный запрос в estimate с параметром `use_toll_roads = true`.

Таким образом у клиента будет два оффера и с одним из них он создаст поездку.
Ручка estimate должна строить маршрут исходя из значения переданного параметра.

Также для случаев выбора платной дороги нужно добавить поход в сервис toll-roads, который будет сохранять связку `offer_id-use_toll_roads`.

#### Таксометр

Таксометр получит данные из setcar. Сервис driver-orders-builder, отвечающий за формирование setcar, получит новые флаги из tolls из ручки /tolls/v1/order/retrieve, будет узнавать, выбрал ли пассажир платную дорогу (по умолчанию считаем, что выбран бесплатный маршрут).

### Доработки

Estimate принимает поле `use_toll_roads`.
Допустимые комбинации выборов пассажира платки [здесь](toll_roads.md#дальнейшие-доработки-первой-части)

В новом процессинге на uservices сохраняем источник заказа с помощью таски [toll_roads_order_save](service.md#toll_roads_order_save).

В случае, когда в качестве плательщика выбран водитель, в ручке `/tolls/v1/order/retrieve` в поле auto-payment будем возвращать `true`.

Кроме того, в сервисе toll-roads появится ручка, которая будет уметь принимать цену за платную дорогу и сохранять для конкретного order_id.
Данная цена будет возвращаться в хендлере `/tolls/v1/order/retrieve`.

### Часть вторая: Платные дороги в Норвегии

В поездках по Норвегии мы добавляем к каждой(!) поездке фиксированную стоимость.
Вариант А) Через изменение тарифов для Норвегии
Вбариант Б) Через прайсинг и докидывание при расчете цены значения из конфига (конфиг будет новый)

## Реализация

#### Сервис Платных Дорог (TR)

Сервис должен уметь:

* сохранять признак возможности выбора платной дороги по offer_id;
* сохранять признак выбора платной дороги по offer_id;
* сохранять признак выбора плательщика по offer_id;
* отдавать значение признака возможности выбора платных дорог по order_id;
* отдавать значение признака выбора платных дорог по order_id;
* отдавать значение признака плательщика по order_id.
* уметь сохранять цену платной дороги.

#### Изменения в protocol

В ручке estimate будут следующие изменения:

* добавляется параметр `use_toll_roads`, который будет сохраняться в сервис платных дорог после формирования оффера, если пришёл;
* на основании параметра `use_toll_roads` формировать запрос в роутинг таким образом, чтобы мы избегали платных дорог, если false;
* в кейсе наличия более быстрой платной альтернативы и выбора её клиентом, будет происходить доп. запрос;
* в ответе в объекте `toll_roads` придут поля `has_tolls`, `auto_payment`, которые говорят о наличии платной дороги и о плательщике.


### Особенности включения

Нужно уметь включать поддержку доработок на страну по эксперименту.
При этом второй этап планируем включать экспериментом по зонам и тарифам.

Значение эксперимента будем проверять на этапе получения флажков о платной дороге, то есть в estimate.






# Альтернатива Платных дорог 2.0 

## Идея 

Рассчитывать стоимость маршрута самим для поездок с маршрутом через платную дорогу.

Предлагается хранить координаты пунктов оплаты и цены для отрезков между ними на платных дорогах Москвы и Санкт-Петербурга.
При построении маршрута принимаем от пользователя (или партнера) флажок, что пользователь готов ехать по платным дорогам и передаем его в pricing. 

В случае, когда платная дорога на маршруте есть и пользователь согласен по ней ехать, прайсинг обращается в сервис toll-roads, который посчитает ему цену участка платной дороги, которая принадлежит маршруту.

Далее списываем с пользователя сумму платной дороги автоматически, в чеке показываем отдельным пунктом.

## Аргументы

1. Более универсальное решение, которое даже в описанном виде помогает Go;
2. Можем развивать в будущем;
3. Существенно сокращаем возможности для фрода.

### Что нам для этого нужно

1. На стороне Про: 
а) Получать от водителя согласие на проезд по платным дорогам (мы должны информировать его о том, что платить будет он, что у него есть достаточно средств наличными или на карте, чтобы оплатить платную дорогу самому).
б) Получать информацию о том, что пользователь мог выбирать маршрут и выбрал платную дорогу.
2. На стороне сервиса платных дорог:
а) Научиться обращаться в конфиг и считать стоимость заданного участка платной дороги. Считаем стоимость проезда по транспондеру (она значительно ниже, чем при оплате наличными или картой) и добавляем фиксированную сумму сверху.
3. На стороне прайсинга:
_Почему_ _прайсинг?_
Есть вероятность пересчета стоимости из-за изменений в маршруте. Например, пользователь выбрал платную дорогу, но время по бесплатной сократилось и они договорились ехать по бесплатной. В таком случае мы не должны списывать с пассажира стоимость платной дороги. 
Или, например, произошло критичное отклонение от запланированного маршрута и поездка пересчиталась по таксометру. В таком случае мы тоже не должны терять стоимость платной дороги, если она была.
**Важно:** 
1) Мы не хотим снимать комиссию с цены платной дороги.
2) Необходимо понять, нужно ли для корпоративного способа оплаты прибавлять к цене НДС. (Обсуждала предварительно с @pvpolyakov, он считает, что не надо)

а) Принимать флаг о том, имеется ли на маршруте платная дорога, и если да - обращаться в toll-roads с указанным участком пути для вычисления его стоимости.
4. На стороне integration-api:
а) Научиться принимать флаг желания пользователя поехать по платной дороге и прокидывать его в роутеры, по аналогии с routestats.
5. На стороне candidates:
а) Поддержать фильтрацию водителей по признаку готовности к самостоятельной оплате платных дорог.

### Норвегия

Из-за юридических тонкостей было принято решение для поездок в Норвегии прибавлять к цене **каждой** поездки фиксированную сумму.
С нее также не берется комиссия, мы можем показывать сумму в чеке отдельным полем, но не можем говорить, что это за платную дорогу.

### Доработки

1. Про: 

Добавляется флаг `agree_to_pay_tolls` (название обсуждамое), отвечает за готовность водителя принимать заказы с платными дорогами на маршруте и платить самому.

2. В сервисе `toll-roads` добавится ручка `GET` `/tolls/v1/order/price`, которая принимает на вход отрезок пути `[long, lat]` и возвращает цену за платную дорогу на отрезке.

3. Прайсинг:

Добавить обращение в ручку `/tolls/v1/order/price` в сервисе toll-roads для получения цены для участка маршрута.

4. integration-api:

Ссылочки на код

[Ручка estimate](https://github.yandex-team.ru/taxi/backend-cpp/blob/f500ffef52bf383b0dbec90d731a78ddf1fca11e/protocol/lib/src/handlers/integration/orders_estimate.cpp#L419)
[Формирование ответа](https://github.yandex-team.ru/taxi/backend-cpp/blob/develop/protocol/lib/src/integration/orders_estimate.cpp#L599)
[Вызов прайсинга](https://github.yandex-team.ru/taxi/backend-cpp/blob/develop/protocol/lib/src/external/estimate/estimate.cpp#L741)

Описано [тут](estimate.md#изменения_в_запросе_к_estimate)

5. candidates:

Добавляется проверка, если у водителя присутствует флаг `agree_to_pay_tolls` и выставлен в `True`, водитель может быть назначен на заказ.

### Вопросы на будущее

1. Как решать ситуацию, когда пользователь выбрал проезд по бесплатной дороге, а водитель поехал по платной? 

2. Что делаем с изменением точки Б? 
