# Промокоды Лавки в SuperApp'е Такси

## Бизнесовая задача

Так как пока зоны действия рефералки Такси и Лавки не пересекаются, будем отдавать в ручке **getreferral** Таксишного API специальные реферальные промокоды для Лавки.
**Важно:** в ручку рефералки приходит зона последней поездки пользователя, поэтому если пользователь открыл приложение в Москве, но последняя поездка была в другой зоне, с точки зрения рефералки это пользователь не из Москвы.

## Бэкенд

На первом этапе сам промокод и зона его действия будут настраиваться через Эксперименты 3.0 (далее `exp3`).
Запускаем эксперимент на бренд `yataxi`, зону `moscow`.

Если пользователь попал в эксперимент (запускаем сначала на команду, все Такси, процент пользователей), то вместо обычной логики ручки **getreferral** с генерацией нового промокода или получением старого из базы, отдаем промокод, который пришел в эксперименте. Для таких промокодов добавляем в ответ ручки специальное поле `external_referral_service` со значением `grocery` (Лавка). Можно будет расширить костыль для других сервисов SuperApp'а (Еда, и т.д.) :)

В ответе экспериментов должны быть следующие поля:
- `promocode` - сам промокод
- `external_referral_service` - для какого сервиса промокод (Лавка)
- `value` - скидка промокода в единицах валюты
- `currency` - валюта промокода
- `orders_count` - на какой количество первых заказов будет действовать скидка
- `descr_tanker_key` - танкерный ключ, из которого будет генериться `descr` - описание промика в приложении
- `message_tanker_key` - танкерный ключ, из которого будет генериться `message` - текст шэринга, который отправляется другу
- `share_url_template` - шаблон ссылки для шэринга
- `rides_count/rides_left` - сколько всего и "осталось" активаций реферального промокода

Как эти поля перекладываются в ответ **getreferral**:
- поля `promocode`, `external_referral_service`, `value`, `currency`, `rides_left/rides_count` перекладываются в ответ as-is
- поля ответа `descr` и `message` формируются следующим образом:
  - берем шаблон текста из танкера, имя танкерного ключа в поле `..._tanker_key`
  - готовим аргументы `value_str`, `orders_count`, `link`, `promocode` для заполнения шаблона
  - заполняем шаблон и кладем в ответ
- аргуметы для шаблонов сообщений:
  - `value_str` - формируется на основе `value`, `currency`, `locale` и `format_currency` (последние два приходят в запросе в ручку)
  - `orders_count` - приходит из эксперимента
  - `link` - формируется из шаблона `share_url_template`, в который подставляем `promocode`

Поля из ответа `value`, `currency`, `rides_left/rides_count` используются старыми клиентами (разной степени свежести), отправляем их для совместимости. Хотя, как видно по логике заполнения сообщений, они нужны на входе. Новые клиенты будут смотреть в дополнительные опциональные поля для формирования текстов кнопок.

### Кастомная ошибка при вводе лавочного промокода в приложении Такси

Если клиент вводит в Такси лавочный промокод, то с бэкенда приходит специальная ошибка, в тексте которой объясняется, что вводить промокод нужно в другом месте.
Список промокодов, для которых следует показывать такую ошибку будет задаваться конфигом `COUPONS_LAVKA_PROMOCODES`. **Важно:** новый лавочный промокод, который хотим отдавать через ручку **getreferral** нужно сначала добавить в указанный конфиг, а только потом добавлять в эксперимент. Если вдруг нужно поменять текст промокода, надо сначала добавить в конфиг новый вариант текста (старый не убирать), потом заменить в эксперименте текст, и только потом можно убрать старый вариант текста из конфига.

## На клиентах

И старые, и новые клиенты будут воспринимать промокод как обычный реферальный промокод Такси и показывать его всем, кто получил его из **getreferral**, независимо от наличия эксперимента `superapp_screens` (отвечающего за показ Лавки).

## Новые поля в ответе getreferral для разхардкоживания текстов/картинок рефералки на клиентах

В ответ getreferral добавляется объект `overrides` со следующими полями:

- `referral_screen` - объект:
  - `rides_left_text` - текст "Осталось 5 промокодов" на экране рефералки
  - `send_referral_code_text` - текст кнопки "Отправить промокод" на экране рефералки
  - `image` - бублики на экране рефералки

- promocode_screen - объект:
  - `list_item_text` - текст кнопки "Получить скидку" в списке на экране промокодов
  - `bottom_image` - бублик над кнопкой "Пригласить друзей" на экране промокодов
  - `bottom_button_text` - текст нижней кнопки "Пригласить друзей" на экране промокодов
  - `list_item_image` - картинка кнопки "Получить скидку" в списке на экране промокодов

- `order_card` - объект:
  - `list_item_image` - подарочек в поездке (отображается если нет баннера)
  - `list_item_text` - текст кнопки "Подарить друзьям скидку" в карточке поездки (отображается если нет баннера)

- `map` - объект:
  - `button_image` - подарочек на карте

В объект ответа `banner` добавляется следующее поле:
- `image` - бублик в баннере

Для картинок передаются тэги сервиса картинок.
