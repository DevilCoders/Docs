## Give&Get рефералка для Лавки в Я.Такси

### Описание
[TAXIBACKEND-25951 Реализация Give&Get рефералки для Лавки в супераппе](https://st.yandex-team.ru/TAXIBACKEND-25951)

Необходимо реализовать рефералку, чтобы:
- пользователю в супераппе было заметно предложение о реферальной программе в Лавке
- пользователь мог делиться своим уникальным реферальным промокодом для Лавки
- новые пользователи могли использовать реферальный промокод на первые заказы в Лавке (только в супераппе)
- пользователь мог получать вознаграждения за новых пользователей Лавки, использовавших его реферальный промокод.

Ограничения:
- не сломать основное флоу таксишной рефералки


### Флоу пользователя:

__У кого будет возможность участвовать в реферальной программе?__

Пользователи Я.Такси, у которых на момент запроса промокода последняя поездка была в Москве (стандартная логика рефералки)


__Где пользователь увидит информацию про реферальный промокод?__

На странице рефералки. Там будет текст условия реферального промокода (get/give скидки, каким способом доставляется вознаграждение, в каких районах работает лавка) и сам уникальный реферальный промокод.


__Как пользователь попадет на страницу рефералки__?
- В меню перейти в раздел "Скидки" -> "Получить скидку"
- При клике на главном экране на значок "Подарочек" (в будущем значок Лавки) - эксперимент referral_gift
- На карточке поездки через пункт меню, а при включенном эксперименте referral_banner_tanker_keys, через баннер


__Как пользователь может поделиться промокодом?__
- будут кнопки "скопировать" реферальный промокод и "поделиться" им. В "поделиться" планируется добавить deeplink, который будет вести в шторку "Лавки"


__Как пользователь получит вознаграждение?__
- Придет смс с промокодом


### Техническая реализация
#### __Вариант A: хранение промокодов в такси__

A1. Уникальные реферальные промокоды лавки загружаются в db.promocode_referrals с помощью скрипта

Структура промокода:
```
{
  "_id" : ObjectId(),
  "promocode" : "unique_promocode",
}
```

A2. Пользователь приходит в get_referral

A2.1 Смотрим, попадает ли зона последней поездки пользователя в эксперимент рефералки Лавки (external_referral_inside_taxi) и получаем текст для рефералки. (Если пользователь не попал в эксперимент, переходим на стандартное флоу таксишной рефералки)

A2.2 Пытаемся из db.promocode_referrals получить промокод по yandex_uid
- если удалось найти, то отдаем код вместе с текстом из эксперимента
- если не удалось найти, пытаемся выполнить findAndModify, чтобы захватить свободный промокод, захваченный промокод отдаем клиенту вместе с текстом

Структура документа после захвата промокода:

```
{
  "_id" : ObjectId(),
  "promocode" : "unique_promocode",
  "yandex_uid": "***",
  "created": Date(),
}
```
- если не удалось захватить промокод (закончились промокоды или затупила база) -> логируем и отдаем либо ответ 406, что рефералка недоступна + нужно настроить мониторинг

А3. Пользователь делится промокодом

А4. Другой пользователь вводит реферальный промокод:
   - в Лавке супераппа -> обрабатывает Лавка
   - в Такси -> показываем, что промокод из Лавки, ссылка на лавку
      (для этого в coupon/activate проверяем, что рефреальный промокод есть в db.promocode_referrals и у него проставлен yandex_uid)
   - в Лавке Еды -> будет ошибка, что промокод для супераппа
   
Выдавать вознаграждения будут CRM, для этого нужен скрипт, похожий на скрипт, когда выдавали промокоды для таксишной рефералки. Также Лавка ещё должна будет выгружать свободные промики.
https://raw.github.yandex-team.ru/taxi-crm/crm/someone/nirvana/graphs/give_and_get/taxicrm-604/daily_user_updating

#### __Вариант Б: запрос промокода из Лавки__

Б1. Смотрим, попадает ли зона последней поездки пользователя в эксперимент рефералки Лавки и получаем текст для рефералки.

Б2. Делаем запрос в лавку с параметром: uid (yandex_uid) + TVM до сервиса _eda_core_
   
   Если в ответ пришел промокод, то подставляем значения в ответ.
   Если была ошибка запроса, то - ответ 406, что рефералка недоступна

Б3. Пользователь делится промокодом

Б4. Другой пользователь вводит реферальный промокод:
   - в Лавке супераппа -> обрабатывает Лавка
   - в Такси -> показываем, что промокод из Лавки, ссылка на лавку (все лавочные промокоды будут начинаться с единого префикса)
   - в Лавке Еды -> будет ошибка, что промокод для супераппа

Для вознаграждения на стороне Лавки подразумевается механика, которая за новых пользователей будет выдавать возграждение путем отправки смс с промокодом для Лавки в супераппе.

### Задачи

#### __Вариант A: [9] хранение промокодов в такси__
1. [3] Выпилить логику таксишного промокода в монге -> оставить только работу c pg
   - [1] из uservices
   - [1] из протокола
   - [1] скрипт на очистку индексов + обновление schemas
   - удалить скрипт CRM для работы с db.promocode_referrals
1. [2] Написать скрипт загрузки уникальных реферальный промокодов в mongo db.promocode_referrals + обновление schemas + скрипт на индексы
2. [2] Правки в get_referral

    [2] Найти в db.promocode_referrals промокод по yandex_uid или захватить свободный промокод + при неуспешном запросе отдаем 406, что рефералка недоступна [тесты]
  
3. [2] В coupon/activate обрабатывать реферальные промокоды из Лавки. Ищем промокод в db.promocode_referrals, если нашли и он захвачен для пользователя -> отдаем ошибку "ERROR_LAVKA_PROMOCODE", иначе стандартный ответ coupon/activate

#### __Вариант Б: [4] запрос промокода из Лавки__

2. [2] Правки в get_referral

    [2] Запрос в Лавку для получения: кода промокода, лимита использований, кол-во использований.
        На случай, если запрос неуспешен, вернуть 406, что рефералка недоступна
        [тесты]
  
3. [1] В coupon/activate проверяем, если промокод начинается со специального лавочного префикса  -> отдаем ошибку "ERROR_LAVKA_PROMOCODE", иначе стандартный ответ coupon/activate [тесты]


[2] Настроить мониторинги:
   - количество свободных db.promocode_referrals (для варианта А)
   - количество неверных вводов лавочных промокодов в такси
