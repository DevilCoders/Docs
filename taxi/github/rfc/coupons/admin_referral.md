# Админка рефералки

## Введение

Настройки для рефералки пользователей разбиты на две группы:
- для создателя (creator) - тот, кто делится реферальным промокодом
- для получателя (consumer) - тот, кто применяет реферальный промокод. 

Сейчас данные размещены в конфигах: 
- [REFERRAL_CREATOR_CONFIG](https://tariff-editor.taxi.yandex-team.ru/dev/configs/edit/REFERRAL_CREATOR_CONFIG) (какую серию при каком количестве привлеченных получает тот, кто поделится; в каком регионе; в рамках какой кампании + технические характеристики самой кампании; сколько максимально человек может быть привлечено промокодом одного пользователя)
- [REFERRAL_CONSUMER_CONFIG](https://tariff-editor.taxi.yandex-team.ru/dev/configs/edit/REFERRAL_CONSUMER_CONFIG) (сколько дней действует добавленный реферальный промокод; какой серии он соответствует; в каком регионе; в рамках какой кампании). 

Реферальная кампания - группа конфигов (записей в конфигах для создателя и получателя) с уникальным наименованием и другими характеристиками: дополнительные проверки пользователя для участия (если есть), отдельные танкерные ключи, бренд приложения. Такое объединение потребовалось, чтобы иметь возможность выдавать пользователям несколько рефералок разного типа, но контролировать, чтобы в рамках кампании рефералка должна быть одна.

Существующие и планируемые в ближайшее время кампании:
- `common_taxi` - рефералка для новых пользователей в приложении Яндекс.Такси
- `common_yango` - рефералка для новых пользователей в приложении Yango
- `common_uber` - рефералка для новых пользователей в приложении Uber Russia (скоро)
- `light_business` - рефералка для пользователей бизнес-аккаунта в приложении Яндекс.Такси (отключена по эксперименту)

В настоящее все необходимые характеристики кампании указываются в CREATOR конфиге в каждой записи, соответствующей этой кампании. Кампания `common_taxi` является наиболее распространенной; исторически сложилось, что её наименование и характеристики можно не указывать.

### Текущий функционал
Чтобы расширить географию (добавить в новую зону/страну) существующей реферальной кампании сейчас требуется:

1. завести серию, которую будет получать новый пользователь (уникальная, на первую поездку, для Такси, обычно на 1 поездку, обычно при оплате картой, с требуемым ограничением на географию - страна/город и временем действия - начало и окончание)
2. завести одну или несколько серий - наград (уникальная, для Такси, обычно на 1 поездку, со снятым ограничением "один промокод из серии в одни руки", обычно при оплате картой, обычно на все тарифы, с требуемым ограничением на географию - страна/город и временем действия - начало и окончание)
3. добавить данные о сериях-наградах в CREATOR конфиг (новый незанятый айди, география, массив наград с указанием диапазонов действия по количеству активаций, максимальное число активаций, для кампаний, отличных от common_taxi - имя кампании, её танкерный ключ, наименование её дополнительной проверки, если она есть)
4. добавить данные о сериях для новых пользователей в CONSUMER (география, серия, длительность, для кампаний, отличных от `common_taxi` - имя кампании)
5. [недавние доработки] выполнить синхронизацию CREATOR конфига и таблицы в базе данных (запустить [скрипт sync_with_creator_config](https://github.yandex-team.ru/taxi/tools-py3/blob/master/taxi_coupons/sync_with_creator_config.py))
6. Для кампаний, отличных от common_taxi, проверить/добавить включенность разрешающего кампанию эксперимента для нужной группы/процента пользователей (например, [для бизнес-аккаунта](https://tariff-editor.taxi.yandex-team.ru/experiments3/show/referral_campaign_light_business))
7. Если требуется отображать шорткаты с этими реферальными кодами, добавить географию в [эксперимент referrals_shortcuts_params](https://tariff-editor.taxi.yandex-team.ru/experiments3/show/referrals_shortcuts_params) и возможно, для Такси, в [эксперимент referral_overrides_by_service](https://tariff-editor.taxi.yandex-team.ru/experiments3/show/referral_overrides_by_service)
8. Если страна новая, убедиться, что в Танкере, есть переводы на нужный язык, а также, что страна указана для соответствующих приложений в конфиге [REFERRALS_URL_TEMPLATE_MAP](https://tariff-editor.taxi.yandex-team.ru/dev/configs/edit/REFERRALS_URL_TEMPLATE_MAP).
9. Если характеристики серии-награды отличаются от других серий этой кампании (особое внимание, если серия на несколько поездок - на текущий момент, в большинстве случаев количество поездок захардкожено), убедиться, что ключи в Танкере заведены с учетом таких настроек: ключи должны содержать соответствующие поля value, percent, ride_count.

Если создается новая реферальная компания, то дополнительно к этим действиям требуется: 
- реализовать в коде дополнительную проверку с некоторым наименованием (если такая для кампании требуется)
- завести разрешающий кампанию эксперимент (см. п.6)
- завести ключи с соответствующим префиксом (префикс [приложения из LOCALES_APPLICATION_PREFIXES](https://tariff-editor.taxi.yandex-team.ru/dev/configs/edit/LOCALES_APPLICATION_PREFIXES) и кампании - если таковой указан в CREATOR конфиге) в Танкере, которые учитывают типичные характеристики серии-награды (процентная/непроцентрая, на 1/несколько поездок)
- проверить ссылки для нужных приложений в конфиге [REFERRALS_URL_TEMPLATE_MAP](https://tariff-editor.taxi.yandex-team.ru/dev/configs/edit/REFERRALS_URL_TEMPLATE_MAP).

При этом мы говорим о следующих ограничениях:
- Не удалять записи из CREATOR конфига (если требуется "выключить" генерацию новых кодов, то достаточно удалить данные о географии в соответствующей записи)
- Не генерировать промокоды по этим сериям вручную через Админку (на вкладке "Промокоды")

## Новый раздел "Рефералка пользователей"
### Метазадача
- Упростить ведение (просмотр, заведение, редактирование) реферальных кампаний
- Минимизировать число возможных ошибок ведения за счет функционала

### Идея решения
Для реферальных кампаний, конфигов и (большинства) реферальных серий реализовать возможность через Админку Такси в рамках одного раздела выполнять:
- просмотр
- добавление
- редактирование
- удаление (отключение)

Все действия, кроме просмотра, выполняются через сервис драфтов (approvals).

### Связь с реферальными сериями
Если проанализировать все существующие реферальные серии, то видно что большинство из них международные и отличаются только номиналом (в валюте соответствующей страны). 

Исключения: 
- Гана - нет ограничения на оплату картой
- [только планируется] кампания `common_uber`: количество поездок > 1, процент, лимит на каждую поездку
- [отключена] кампания `light_business`: количество поездок > 1, процент, лимит на каждую поездку, ограничение по тарифам, способ оплаты `business_account`, ограничения на первую поездку по тарифу/способу оплаты. 

При этом consumer-серии `light_business` не имеют обычного ограничения "на первую поездку" (поскольку кампания предназначена для продвижения фичи, а не бренда как такового, и доступна в том числе "старым" пользователям Такси), а значит (в отличие от consumer-серий других кампаний) должны согласовываться полным составом групп (маркетинг + финансовый отдел).

По этому критерию можно разделить все кампании на два типа: для продвижения бренда (consumer-серии для новичков) и для продвижения фичи (consumer-серии с другими ограничениями). Поскольку кампания `light_business` - единственный представитель второго типа - ещё только ищет свою форму, сложно сказать, какие параметры серии ей в будущем понадобятся. В связи с этим для неё, как и для других возможных особых случаев, мы допускаем старый механизм заведения: серии отдельно заводятся на вкладке "Промокоды", а затем прописываются в конфигах на вкладке "Рефералка".

Итого, в перспективе у нас могут быть три полноценных типа кампаний (они же шаблоны заведения/редактирования серий: `new_brand_promocodes`, `new_feature_promocodes` - здесь дополнительно требуется указание в каком смысле старый пользователь считается новым, `custom_promocodes` - нерекомендуемый тип для особых/срочных случаев), но в текущей реализации мы будем рассматривать только 1й и 3й (к которой пока отнесем `light_business`). Следует учитывать, что для разных типов кампаний, в зависимости от требований аудита, может потребовать сделать отдельные ручки создания и редактирования конфигов (пока стараемся сделать общие).

Для первой группы от серии нам достаточно:
- номинал
- процент (если нужен)
- количество поездок (если > 1, то лимит на каждую поездку)
- снять ограничение "Только при оплате картой"

Эти данные предполагается отображать (заводить/редактировать) через вкладку "Рефералка". При этом серии также могут быть отредактированы через вкладку "Промокоды".

### География конфигов и реферальных серий
Практика показывает, что использование одной реферальной серии сразу в нескольких зонах страны является удобным. Это встречается в международных рефералках Латвии, Израиля, Белоруссии и скоро будет в России (в Убере) в нескольких городах с перспективой расширения географии. Также следует учитывать, что при выборе даже одного города на вкладке "Промокоды" в параметрах серии, промокод зачастую становится доступен для нескольких зон, связанных с этим городом.

Соответствено, понятие конфига следует пересмотреть: понимать под конфигом не настройку для отдельной зоны, а для набора зон одной страны (на бэке будем в таблицах конфигов будем хранить поле типа text ARRAY, а в кешах "распаковывать" в отдельные зоны).

При создании/редактировании реферальных конфигов в Админке предполагается указывать города, также как на вкладке "Промокоды".

### Техническое
По результату выполнения этой задачи (а также задачи по переносу stq из backend-py3) значения из конфига [CREATOR](https://tariff-editor.taxi.yandex-team.ru/dev/configs/edit/REFERRAL_CREATOR_CONFIG) (сейчас в базу перенесены не все его данные) и [CONSUMER](https://tariff-editor.taxi.yandex-team.ru/dev/configs/edit/REFERRAL_CONSUMER_CONFIG) будут перенесены в таблицы в постгресе, а сами конфиги удалены. Перед удалением потребуются правки в коде uservices (перенос таски наград из backend-py3 и место, где выбирается необходимый CONSUMER конфиг). Конкретно к этой задаче относим именно правку выбора CONSUMER конфига (сделать кеш!).

## Новые ручки админки
### 1. Для кампаний
Список брендов для реферальных кампаний берется из конфига [REFERRALS_ENABLED_BY_BRAND](https://tariff-editor.taxi.tst.yandex-team.ru/dev/configs/edit/REFERRALS_ENABLED_BY_BRAND).

#### admin/referral/campaigns/options/list
Вспомогательная `GET` ручка, которая отдает список наименований дополнительных проверок `extra_check` для участия пользователя в реферальной кампании.
```
GET admin/referral/campaigns/options/list
```

Response:
```
{
  "extra_check": ["business_account"]
}
```

#### admin/referral/campaigns/list 
Cписок существующих реферальных кампаний c указанием бренда, описания, флага внутренней фичи, разрешающего эксперимента, флага включенности, префикса для танкерных ключей. Возможный фильтр: бренд.
```
GET admin/referral/campaigns/list?brand_name=yataxi
```

Response:
```
{
  "items": [
    {
      "campaign_name": "common_taxi",
      "campaign_type": "new_brand_promocodes",
      "brand_name": "yataxi",
      "description": "Обычная рефералка Яндекс.Такси",
      "status": "enabled",
      "tanker_prefix": "",
    {
      "campaign_name": "light_business",
      "campaign_type": "custom_promocodes",
      "brand_name": "yataxi",
      "description": "Рефералка бизнес-аккаунта",
      "status": "disabled",
      "show_experiment": "referral_campaign_light_business",
      "extra_check": "business_account",
      "tanker_prefix": "light_business"
    }
  ]
}
```

#### admin/referral/campaigns/edit (check, apply) 
Изменить существующую реферальную кампанию: текстовое описание, префикс для танкерных ключей, дополнительную проверку пользователей, изменить статус кампании - "Включена"/"Выключена"/"По эксперименту" (`referral_campaign_{campaign_name}`).

Две ручки: `check` и `apply`.

```
POST admin/referral/campaigns/edit/apply
    {
      "campaign_name": "common_taxi",
      "campaign_type": "new_brand_promocodes",
      "description": "Новое описание обычной рефералки",
      "status": "by_experiment",
      "tanker_prefix": "common",
      "extra_check": "common_taxi_check"
    }
```

Response выдает в составе ответа объект как в массиве выше (см. `admin/referral/campaigns/list`).

#### admin/referral/campaigns/add (check, apply)
Cоздать реферальную кампанию. Требуется ввести уникальное название и остальные характеристики. Кампания создается для конкретного бренда (далее бренд не может быть сменен).
```
POST admin/referral/campaigns/edit/apply
    {
      "campaign_name": "common_uber",
      "campaign_type": "new_brand_promocodes",
      "brand_name": "uber",
      "description": "Рефералка в Uber Russia",
      "status": "by_experiment",
      "tanker_prefix": ""
      # "extra_check": null
    }
```

#### admin/referral/campaigns/delete (check, apply)
"Удалить" реферальную кампанию: выключить все активные creator/consumer-конфиги, в указанной географии (обычно это страна). Если указаны города/зоны, но это лишь пересечения с действующими конфигами - ошибка с указанием "неоднозначных" конфигов. Выключить всю кампанию можно через редактирование кампаний.
```
POST admin/referral/campaigns/delete/apply
    {
      "campaign_name": "common_yango",
      "descr": "Полностью отключена Румыния",
      "country": "rou",
      # "zones": ["bucharest"]
    }
```

### 2. Для consumer конфигов
#### admin/referral/consumer_configs/list
Список существующих consumer конфигов (обязательный фильтр: кампания; возможные фильтры: гео, включен).
```
GET admin/referral/consumer_configs/list?campaign_name=common_yango
```

Response:
```
{
  "items": [
    {
      # "config_id": 1,
      "campaign_name": "common_yango",
      # "campaign_type": "new_brand_promocodes",
      "cities": ["Аккра"],
      "zones": ["accra"],
      "country": "gha",
      "status": "enabled",
      "duration": 30,
      "series_info": {
        # "series_id": "rfgv2accra0",
        "value": 5,
        "currency": "GHS",
        "user_limit": 1,
        "creditcard_only": false,
        "descr": "5 GHS for 1 ride in Accra",
        "used_count": 223
      }
    },
    {
      # "config_id": 2,
      "campaign_name": "common_yango",
      # "campaign_type": "new_brand_promocodes",
      "cities": ["Бухарест"],
      "zones": ["bucharest"],
      "country": "rou",
      "status": "disabled",
      "duration": 30,
      "series_info": {
        # "series_id": "rfgv2bucha0",
        "value": 20,
        "currency": "RON",
        "user_limit": 1,
        "creditcard_only": true,
        "descr": "20 RON for 1 card ride in Bucharest",
        "used_count": 511
      }
    },
    ...
  ]
}
```
#### admin/referral/consumer_configs/add (check, apply)
Создать consumer конфиг для существующей кампании.

Для `"campaign_type": "new_brand_promocodes"` будет автоматически создана серия для новых пользователей с необходимыми параметрами. Ограничения конфига на географию прорастают в серию: серия будет ограничена ровно тем же самым набором городов/зон (не храним города в рефералке - попробуем восстанавливать по зонам).
```
POST admin/referral/consumer_configs/add/apply
    {
      "campaign_name": "common_yango",
      # "campaign_type": "new_brand_promocodes",
      # "country": "gha", 
      "cities": ["Аккра", "Тема"],
      # "status": "enabled",
      "duration": 25,
      "series_info": {
        "value": 6,
        "user_limit": 1,
        "creditcard_only": false
      }
```

Для `"campaign_type": "custom_promocodes"` требуется указать существующую серию. При этом важно (проверяем), чтобы серия была той же страны и либо не была ограничена по зонам или же все зоны, указанные в реферальном конфиге, были в наборе зон серии.
```
POST admin/referral/consumer_configs/add/apply
    {
      "campaign_name": "common_yango",
      # "country": "gha", 
      "cities": ["Аккра", "Тема"],
      # "status": "enabled",
      "duration": 25,
      "series_id": "rfgiveaccra"
```

Наличие для данной кампании в данной географии другого активного конфига (в одной из зон) считаем ошибкой (потенциально можно реализовать отключение, но сейчас остановились на самом простом варианте). В сообщении об ошибке желательно сделать ссылки на "конфликтующие" конфиги.

#### admin/referral/consumer_configs/edit (check, apply)
Изменить существующий consumer конфиг (в том числе просто выключить). Поведение по умолчанию (`force_change = false`) - выключить редактируемый старый конфиг и завести новый с новой серией. Это поможет видеть, какие раньше были настройки, и верно учитывать статистику использования серии с прежними параметрами. В случае `force_change = true` происходят изменения в самой редактируемой сущности.
```
POST admin/referral/consumer_configs/edit/apply
    {
      # "config_id": 1,
      "campaign_name": "common_yango",
      # "campaign_type": "new_brand_promocodes",
      # "country": "gha", 
      "cities": ["Аккра"],
      "status": "enabled",
      "duration": 25,
      "series_info": {
        "value": 6,
        "user_limit": 1,
        "creditcard_only": false
      },
      "force_change": false
```
Нужно учитывать, что при включении выключенного конфига или при расширении географии, здесь, также как и в случае add, может произойти пересечение географий. Попытка использовать в активном конфиге географию, которая уже "покрыта", - ошибка. Для `new_brand_promocodes` успешное изменение географии изменяет ограничения серии, для `custom_promocodes` - аналогично add - проверка вложенности зон.

### 3. Для creator конфигов
Creator-конфиги существенно отличаются от consumer-конфигов:
1. у них есть два состояния включенности:
    - **включен на новых** - новый пользователь, который начал удовлетворять условиям рефералки, в том числе оказался в нужном регионе, получит именно эти условия по наградам за привлечение
    - **включен на старых** - у пользователя более ранние условия по наградам, которые он получил, будучи в некотором регионе рефералки и удовлетворяя её условиям на момент получения. Они продолжают работать: пользователь может делиться промокодом (параметры промокода для нового пользователя зависят исключительно текущих consumer-конфигов) и при этом получит награду по старым, ранее обещанным ему условиям.
2. **выключение** означает что у пользователей, которым уже был выдан этот конфиг, будет выключена эта реферальная кампания без возможности как-либо в ней участвовать дальше. (Мы перестаем отображать пользователю промокод, которым он может делиться, а его ранее розданные промокоды перестают работать). Обычно применяется только если выключается целая страна. Для этого -- отдельная ручка delete на уровне кампаний.
3. потенциально серий-наград может быть несколько. На данном этапе делаем только одну, но стараемся учесть это в структуре json.
4. поскольку речь идет о создании серий без ограничения на первую поездку, требуется согласование от двух групп: маркетинг + финансовый отдел. В случае указания в конфиге уже готовой серии это, по идее, излишне, но для единообразия оставляем пока так.

#### admin/referral/creator_configs/list
Cписок существующих creator конфигов (обязательный фильтр: кампания; возможные фильтры: гео, включен, включен на новых).
```
GET admin/referral/creator_configs/list?campaign_name=common_yango
```

Response:
```
{
  "items": [
    {
      # "config_id": 1,
      "campaign_name": "common_yango",
      # "campaign_type": "new_brand_promocodes",
      "cities": ["Аккра"],
      "zones": ["accra"],
      "country": "gha",
      "rewards": [
        {
          # "series_id": "rfge2accra0",
          "series_info": {
            "value": 5,
            "currency": "GHS",
            "user_limit": 1,
            "creditcard_only": false,
            "descr": "Reward: 5 GHS for 1 ride in Accra",
            "used_count": 299
          },
          "max_completion_number": 10000
        }
      ],
      "success_activations_limit": 10000,
      "status": "for_new_users",
      "checks_for_users": {
        "min_orders_card": 0,
        "min_orders_total": 1
      }
    },
    {
      # "config_id": 2,
      "campaign_name": "common_yango",
      # "campaign_type": "new_brand_promocodes",
      "cities": ["Бухарест"],
      "zones": ["bucharest"],
      "country": "rou",
      "rewards": [
        {
          "series": {
            # "series_id": "rfge2bucha0",
            "value": 20,
            "currency": "RON",
            "user_limit": 1,
            "creditcard_only": true,
            "descr": "Reward: 20 RON for 1 card ride in Bucharest",
            "used_count": 499
          },
          "max_completion_number": 10000
        }
      ],
      "success_activations_limit": 10000,
      "status": "for_old_users",
      # "checks_for_users": {
        "min_orders_card": 0,
        "min_orders_total": 1
      }
    }
  ], ...
}
```

#### admin/referral/creator_configs/add (check, apply)
Создать creator конфиг для существующей кампании.

Для `"campaign_type": "new_brand_promocodes"` будет автоматически создана серия с необходимыми параметрами: ограничения по зонам рефералки = ограничения по зонам серии, `max_completion_number = success_activations_limit`. Потенциально можно подумать над копированием значений из consumer-конфига (и наоборот).
```
POST admin/referral/creator_configs/add/apply
    {
      "campaign_name": "common_yango",
      # "campaign_type": "new_brand_promocodes",
      "cities": ["Аккра", "Тема"],
      # "country": "gha",
      "rewards": [
        {
          "series_info": {
            "value": 6,
            "user_limit": 1,
            "creditcard_only": false
          },
          "max_completion_number": 10000
        }
      ],
      "success_activations_limit": 10000,
      "status": "for_new_users",
      "checks_for_new_user": {
        "min_orders_card": 0,
        "min_orders_total": 2
      }
    }
```

Для `"campaign_type": "custom_promocodes"` требуется указать существующую серию (которая ограничена как минимум теми же зонами)
```
POST admin/referral/creator_configs/add/apply
    {
      "campaign_name": "common_yango",
      # "campaign_type": "new_brand_promocodes",
      "cities": ["Аккра", "Тема"],
      # "country": "gha",
      "rewards": [
        {
          "series_id": "rfgetaccra",
          "max_completion_number": 10000
        }
      ],
      "success_activations_limit": 10000,
      "status": "for_new_users",
      "checks_for_new_user": {
        "min_orders_card": 0,
        "min_orders_total": 2
      }
    }
```

Наличие для данной кампании в данной географии другого активного конфига (в одной из зон) считаем ошибкой.

#### admin/referral/creator_configs/edit (check, apply)
Изменить существующий creator конфиг, в том числе выключить по нему новые генерации или отключить совсем. Аналогично созданию + флаг `force_change` (по умолчанию `false`): по умолчанию для существующего конфига выставляем `status = for_old_users` и заводим новый конфиг (+ новую серию). Иначе - редактируем как есть (замена значений параметров).

Наличие для данной кампании в данной географии другого активного конфига (в одной из зон) считаем ошибкой. Для `new_brand_promocodes` успешное изменение географии изменяет ограничения серии, для `custom_promocodes` - аналогично add - проверка вложенности зон.

### Пермишены	
По согласованию с ИБ, можем использовать существующие пермишены, которые остались от прошлой реализации рефералки и в настоящий момент не используются: `referral_view` - просмотр, `referral_edit`  - редактирование. При необходимости (для ОКов реферальных драфтов) могут быть заведены дополнительные.

### Итоговый общий список
- admin/referral/campaigns/options/list
- admin/referral/campaigns/list 
- admin/referral/campaigns/edit (check, apply) 
- admin/referral/campaigns/add (check, apply)
- admin/referral/campaigns/delete (check, apply)
- admin/referral/consumer_configs/list
- admin/referral/consumer_configs/edit (check, apply)
- admin/referral/consumer_configs/add (check, apply)
- admin/referral/creator_configs/list
- admin/referral/creator_configs/edit (check, apply)
- admin/referral/creator_configs/add (check, apply)

## Изменения в БД
### Краткое описание
- перенос данных из REFERRAL_CONSUMER_CONFIG
- добавление возможности полностью выключить один creator конфиг, возможности хранить массив зон
- добавление возможности полностью выключить кампанию, включить учет эксперимента, указание типа кампании
- добавление реферальным сериям флага "type": "referral" (для запрета генерации в разделе "Промокоды", исключения из list без соответствующего фильтра, плюс потенциально можно перестать проверять applications этих серий на соответcвие default-enabled) -- опционально в рамках общего перехода на "type":"multi"/"single"/"referral" всех серий
- [техническое] указание стран во всех конфигах

### [новая таблица] consumer_configs - конфиги потребителя рефералки
- `id` --  айди записи (конфига)
- `campaign_id REFERENCES campaigns (id)` -- айди кампании, для которой этот конфиг
- `enabled BOOLEAN NOT NULL` – флаг включенности конфига (для случая редактирования/удаления)
- `series_id TEXT NOT NULL` -- серия-бонус новому пользователю
- `duration_days INTEGER NOT NULL DEFAULT 30` -- время действия промокода с момента активации
- `zones TEXT[] NULL` -- список зон
- `country TEXT NOT NULL` -- страна
- `updated_at` -- техническое для репликации

Предполагаем (следить в коде), что в одной зоне в рамках одной кампании активен в один момент времени активно (`enabled = true`) не более одного consumer конфига. Допустима ситуация одновременного наличия активного consumer конфига в зоне и в стране этой зоны (второй - не имеет указания зоны). При этом первый будет использоваться в зоне, второй - в стране, но вне зоны.

Первичное заполнение - вручную составленный sql-скрипт или доработанный скрипт синхронизации.

### creator_configs -- конфиги создателя рефералки
Пересматриваем логику `enabled`: значение `false` означает полностью, что конфиг полностью выключен (нужно иметь ввиду, что пользователи, которым был выдан выключенными конфигами не получат ). Добавляем поле `active_for_new BOOLEAN NOT NULL DEFAULT FALSE`, которое идейно заменяет `enabled`, а также поле `zones TEXT[] NULL` (список зон, в первое время можно заполнить по полю `zone_name`) и поле `updated_at`.

### campaigns -- реферальные кампании
Нужны `BOOLEAN` поля `enabled` и `by_experiment`, а также `ENUM`/`TEXT` поле `campaign_type`.

## Не вошло в данную задачу
### 1. [новая таблица] creator_rewards - награды за привлечение
Полноценный функционал CREATOR конфига (в том виде, в каком он задумывался) предполагает, что для каждого (creator) конфига потенциально может быть несколько разных серий-наград (в зависимости от числа привлеченных пользователей), причем допустимы диапазоны, когда награды вообще нет (например, "в хвосте" - начиная с некоторого количества). 

Пример такой настройки: за привлеченное количество пользователей от 1 до 10 - серия-награда-1, за количество от 11 до 49 - награды нет, за количество от 50 до 99 - серия-награда-2, далее - награды нет (но есть общее ограничение в 200 привлеченных человек).

Cтруктура:
- `id` --  айди записи (награды)
- `config_id REFERENCES creator_configs (id)` -- айди CREATOR конфига, для которого награда
- `series_id NOT NULL` -- серия-награда из `dbtaxi.promocode_series`
- `activations_from` -- нижняя граница интервала награды (Варианты: 1. рассчитать в коде, 2. просить ввести пользователя)
- ~~`max_completion_number`~~ `activations_to` -- верхняя граница интервала награды 
- Дополнительно: `CHECK (activations_from < activations_to)`
- Также: следить, чтобы интервалы не пересекались (TODO)

Поскольку есть обе границы, то нужную награду можно найти по условию `WHERE current_activations BETWEEN activations_from AND activations_to`, а пустые награды  можно не записывать. 

Первичное заполнение таблицы можно выполнить sql-скриптом на основе полей `reward_series` и `success_activations_limit` таблицы `creator_rewards`, поскольку в настоящее время в production для каждого CREATOR конфига награда только одна. Альтернатива: доработать скрипт синхронизации.

Далее эту таблицу следует использовать в коде в uservices в рамках переноса stq из py3. После этого можно следует вместо `reward_series` (из `creator_configs`) можно начать использовать первую награду из `creator_rewards` (или полноценно: награду, соответствующую текущему количеству активаций), а поле `reward_series` удалить.

### 2. Списки/проверки танкерных ключей кампаний
Из-за наличия произольных префиксов становится сложно контролировать наличие/актуальность танкерных ключей для рефералки. Неплохо бы как-то учесть это в Админке в будущем.

Текущий список:
- referral_promocode.message
- referral_promocode.descr
- referral_promocode.message.percent.per_trip
- referral_promocode.descr.percent.per_trip
- referral_promocode.descr_empty
- referral_promocode.message.percent -- в случае описанного здесь заведения серий могут использоваться только в `custom_promocodes`
- referral_promocode.descr.percent -- аналогично

Текущие префиксы:
 - префикс yango (основные: [descr](https://tanker.yandex-team.ru/?project=taxi&branch=master&keyset=backend.client_messages&key=yango.referral_promocode.descr), [message](https://tanker.yandex-team.ru/?project=taxi&branch=master&keyset=backend.client_messages&key=yango.referral_promocode.message))
 - префикс light_business 
 - префикс отсутствует
 
Также следует учесть, что разные приложения могут использовать разные кейсеты (например, backend.override.uber вместо backend.client_messages).
