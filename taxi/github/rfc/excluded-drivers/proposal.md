### Описание

В рамках глобального перехода на микросервисную архитектуру оборачиваем коллекцию excluded_drivers в соответствующий микросервис.
Микросервис должен позволять добавлять водителя в список исключенных водителей для конкретного пользователя, а также позволять получить этот список для пользователя (используется в момент поиска исполнителя заказа). 

Водители исключаются на какое-то время либо по результатам фидбэка пользователя (исключаются навсегда) либо во время реордера/отмены заказ/... и других событий в рамках процессинга заказа.

Тикет на создание сервиса: https://st.yandex-team.ru/TAXIBACKEND-26696
Архитектурное ревью: https://st.yandex-team.ru/TAXIARCHREVIEW-84
Секьюрити ревью: https://st.yandex-team.ru/SECREVIEW-282 

### Метрики

Основной метрикой является количество не назначенных исключенных водителей при поиске исполнителя на заказа, а также количество назначенных исключенных водителей (в случае каких-либо отказов). Также имеет смысл следить за общим количеством водителей в списках исключений (скорее как за технической метрикой).


### Архитектура

Реализуем api-over-data c небольшими нюансами. 


#### Добавление исключенного водителя

ручка: `POST excluded-drivers/v1/drivers`

Параметры:
- `phone_id` - идентификатор телефона пользователя
- `reason` - причина занесения в список
- `order_id` - идентификатор заказа (опционально)
- `driver_license_pd_id` - personal id ВУ водителя 
- `driver_license` (deprecated) - ВУ водителя (оставлено на время переходного периода для совместимости)

Ручка сохраняет исключенного для пользователя водителя в бд. В зависимости от `reason` устанавливает (или не устанавливает) TTL исключения. Необходимость запись `driver_license` в открытом виде в БД обусловлена поддержкой устаревшего кода - в будущем поле будет удалено.


#### Получение исключенных водителей для пользователя

ручка: `GET excluded-drivers/v1/drivers/list`

Параметры:
- `phone_id` - идентификатор телефона пользователя

Возвращает:
- `excluded_drivers_pd_ids` - список personal id ВУ водителя исключенных для пользователя


#### Удаление водителей из списков исключения

На данный момент водители удаляются по TTL, которое устанавливается в зависимости от причины блокировки по конфигу `DRIVER_EXCLUSION_TIME` (устанавливается в момент добавления водителя).
Но для подсчета метрик по назначенным исключенным водителям (в случае отказов) нам придется продливать TTL на время, в течении которого гарантировано отработает обработчик события "перехода заказа в исполнение" для подсчета этой метрики. Эту дельту времени запаса необходимо будет учесть при запросе в бд в ручке получения исключенных водителей.


#### Подсчет метрик 

Количество  НЕназначенных исключенных водителей определяется по метрикам соответствующего фильтра в `candidates` (фильтр `infra/license`). 
Для подсчета назначенных исключенных водителей подписываемся в LogBroker'е на событие перехода заказа в исполнение (статус `assign`) и в обработчике проверяем был ли назначен исключенный для этого пользователя водитель.


#### Данные 
Схема БД: https://pages.github.yandex-team.ru/taxi/schemas/Taxi_Documentation/Mongo%20collections/taxi/excluded_drivers/#excluded_drivers

На данный момент в коллекции 62 млн записей общим объемом 6,7 Гб

Сейчас в коллекции нет индекса по полю `t`  - он понадобится для запросов в ручке /drivers/list и при подсчете метрик вследствие продления TTL


##### Персональные данные
Сейчас в коллекции из параметрах запроса присутствуют ПД в виде ВУ водителя - в ближайшем будущем планируется избавиться от этого поля. Для осуществления этого необходимо, чтобы все запросы на запись и чтение в сервис  приходили с personal id ВУ.


#### Взаимодействие и нагрузка

##### Добавление исключенного водителя:
- от `feedback` - 200 RPS в пике
- от `processing` - по очень грубой прикидке это примерно 30% от 1000 RPS = 300 RPS в пике (чтобы точнее расчитать нарузку, нужно просуммировать статистику по: cancel_or_fail_by_park, cancel_by_user, exclude_for_user, offer_reject, autoreordering)
Итого: примерно 500 RPS в пике

##### Получение исключенных водителей:
- от `lookup` или `сandidates` - 1000 RPS в пике 

##### Подсчет метрик
- от события перехода заказа в исполнение - 250 RPS в пике 


#### Точки отказа и фолбэки

Основная точка отказа сервиса - mongodb

При прогнозируемом SLA 99.9% мы можем позволить отключить данную фичу при поиске исполнителя на заказ. 

В случае отказа при добавление водителя отвечаем 500, вынуждаем клиента ретраить.


#### Альтернативный вариант реализации
На данный момент исключение водителей производится по ВУ (что вынуждает нас дополнительно взаимодействовать с сервисом ПД) - похоже, что так сложилось по историческим причинам. 
В качестве альтернативы мы могли бы использовать unique_driver_id


### Этапность

#### Этап 1 - создаем сервис
- [2d] ручка добавления 
- [2d] ручка чтения
- [2d] подсчет статистики
- [1d] добавить алерты
ИТОГО: 7d

#### Этап 2 - удаляем ПД водителя
После того, как все писатели и читатели будут переведены на данный сервис и будут использовать personal id ВУ водителя - нужно будет удалить это поле `driver_license` из ручки добавления данных и удалить из БД:
- [0.5d] удаление ПД из API
- [0.5d] скрипт на удаление ПД из бд

