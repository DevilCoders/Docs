# Добавления адреса фактической точки Б в избранное

## Задача
В Африке сейчас очень много поездок со сбросом фиксы, хотелось бы уменьшить их процент. При далеко не всегда получается указать конкретный дом или улицу из-за невысокого качества карт в Африке. Среди поездок много (https://st.yandex-team.ru/TAXIWORLDANLT-145) повторяющихся (= с примерно совпадающими фактическими точками Б), поэтому было бы неплохо создать механизм, который будет форсить пользователей сохранять повторяющиеся точки Б в избранное и заказывать такси именно до них.

## Дизайн
https://www.figma.com/file/Do5KAt7q6ilRsKaySLPBV5/Закладки?node-id=0%3A1

Хотим иметь возможность кидать на экран добавления точки Б в избранное:
- из zerosuggest
- через пуш после поездки

Хочется иметь возможность возвращать не только основную частую точку Б, но и информацию о числе и времени поездок.

## Реализация

Хочется сделать в сервисе userplaces одну ручку, которая будет работать через PA и будет отдавать список точек, которые можно было бы добавить в избранноев окрестности переданной координаты. В эту ручку будут ходить клиенты с переданное в пуше координатой (в пуше будет передаваться координата фактической точки завершения поездки).

Таким образом, будет ручка '/4.0/userplaces/suggested-points', в которую будут передаваться данные пользователя из PA и точка с некоторыми координатами.

### Нагрузка

- из zerosuggest - будем возвращать точку в самом zerosuggest
- через пуш после поездки (проверяем фактическую точку Б) - до 200 rps, считаем по ordercommit как верхнюю оценку

Суммарно получаем 200 rps. Если включать только на международку (5%), то 10 rps.

Если не будем влезать по таймингам, то нужно будет завести базу, где будем предподсчитывать кластеры точек. Пересчитывать их будем после каждой поездки пользователя.


### Где брать точки?

Точки завершения заказов будем брать из routehistory/routehistory/get (45мс 99 перцентиль) ходить туда с параметром max_results из конфига. Также под экспериментом можем добавлять точки А.

### Как будем определять, что некоторую точку было бы неплохо добавить в избранное?

1. Если есть координата некоторой точки.
Пусть нам приходит некоторая точка. Будем рассматривать фактические точки завершения последних CONST_1 поездок за последние CONST_2 недель. Среди этих точек будем искать те, которые находятся ближе чем CONST_3 метров от нашей точки Б. Если их больше, чем CONST_4 штук, то считаем, что точка Б может быть в избранном. Проверяем, что пока что ее (= точки на расстоянии CONST_5 метров от нее) нет в избранном у данного пользователя (это поможет избежать дублирования при сохранении) (тут ходим в /userplaces/list, 100мс 99 перцентиль), тогда считаем, что эту точку надо добавить в избранное и возвращаем её.

2. Если нужно просто определить популярные точки для пользователя.

#### Эмпирически
Будем рассматривать фактические точки завершения последних CONST_1 поездок за последние CONST_2 недель. Посчитаем попарные расстояния между ними. Пофильтруем по расстоянию: уберем все связи, которые больше CONST_5 метров. Оставшиеся точки будем считать кластером, одну из точек (любую) обозначим главной. Тут также будем проверять, что точки уже нет в избранном у пользователя.

Тут $N^2$, но так как мы ограничиваем количество точек должно быть норм, но надо логгировать тайминги. Если будет слишком долго считаться, то заведем базу, где будем хранить текущие кластеры точек и после каждой поездки пересчитывать их. Также можно получать кластеры и подсчет точек в них из ml, посмотрим на этот вариант тоже.

#### Через umlaas-geo
В Африке среди первых 20 рекомендаций в umlaas-geo примерно 25-35% занимают фактические точки завершения заказа (https://yql.yandex-team.ru/Operations/YlRZb7q3k1JYXahf_acvghAl0-xQjeK7YcqQQRFrl7o=, нас сейчас интересует point_type = b, source != shotcuts). Можно поднять самую вероятную из этих точек в выдаче и обработать специальным образом:
- Отобрать поездки, закончившиеся рядом с этой точкой (из routehistory)
- Ограничить поездки по датам, посчитать их количество. Если поездок недостаточно, то не рекомендуем эту точку в избранное, выдача zerosuggest никак не меняется
- Если поездок достаточно, то передаем число поездок и дату самой ранней поездки в persuggest/zerosuggest, отмечаем эту точку специальным тегом, ставим на первое место в выдаче. Отдельно рассчитываем available_types по userplaces и передаем в отдельном поле.
- В persuggest/zerosuggest для точки с этим специальным тегом локализуем нужные тексты (вот тут придется добавлять дополнительные поля в ответ persuggest/zerosuggest)
- Клиенты смотрят на теги и для точки с нужным тегом правильно ее отображают, подставляя нужные тексты

Какие тут есть плюсы и минусы:
- Не нужно следить за тем, есть ли данная точка в избранном у пользователя, оно само фильтруется
- Нужно костыльно править выдачу umlaas-geo
- Обрабатываем одну точку, самую вероятную - полагаемся на то, что модель правильно ее предсказала, при этом обработка занимает $N$ вместо $N^2$ (но здесь нужно помнить, что в модели происходят даже более времязатратные вычисления, по сути мы просто отдаем их модели, а не делаем сами)
- Нужно костылить в umlaas-geo обработку точки с точками routehistory, смотреть на userplaces  чтобы посчитать available_types
- Придется протаскивать все нужные данные через persuggest/zerosuggest, добавлять новые поля в запросе и в ответе
- Этот метод будет работать только в тех странах, где в выдаче umlaas-geo есть фактические точки завершения заказа, то есть в странах с плохими картами (фактически нам только такие и нужны)
- Клиентам не нужно будет ходить в отдельную ручку и смешивать выдачу, точка будет приходить в обычном zerosuggest
- Это решение работает только для рекомендаций избранного в zerosuggest

Решили сделать так.

#### А как еще можно сделать?
Можно ходить в umlaas-geo за выдачей как ходит persuggest/zerosuggest (возможно, можно сделать небольшие доработки в umlaas-geo так, чтобы выдача состояла только из фактических точек завершения заказа и userplaces, но даже без этого мы будем получать нормальную выдачу в станах Африки), routehistory, userplaces и обрабатывать всё на своей стороне. Так как международка это менее 100rps, с нагрузкой всё будет ок.

Какие тут есть плюсы и минусы:
- Не нужно следить за тем, есть ли данная точка в избранном у пользователя, оно само фильтруется
- Можно вообще не править umlaas-geo
- Можно вообще не править persuggest/zerosuggest
- Обрабатываем одну точку, самую вероятную
- Этот метод будет работать только во всех странах, если сделать небольшие доработки в umlaas-geo так, чтобы выдача состояла только из фактических точек завершения заказа и userplaces
- Клиентам нужно будет ходить в отдельную ручку и смешивать выдачу (проверять uri точки)
- Это решение работает для любой точки входа, а не только для zerosuggest

### Как будем отображать адрес точки?

Адрес точки будет локазироваться по координате через yamaps. В дальнейшем можно локализовать по ближайшей POI.

### Откуда будем брать надпись "4 раза за последние 2 недели"?

Будем локализовать на бэке и возвращать в отдельном поле.

### Как будем считать сколько раз показали пользователю предложение добавить данную точку в избранное?

Локально храним на клиентах.

### Как будем избегать дублирования точек для добавления избранного и точек из zerosuggest?

Будет фильтроваться на стороне umlaas-geo.

### Какие доработки нужны?

#### В userplaces
Напишем ручку, которая по координате возвращает кандидатов на добавление в избранное.

#### В umlaas-geo

Из umlaas-geo/zerosuggest рекомендованная для добавления в избранное точка должна приходить с тегом (в поле tags) "suggested-userplace" и дополнительной информацией - числом поездок в окрестности этой точки и датой самой ранней из этих поездок. Эту информацию можно положить в новое опциональное поле additional_point_info, а в нем опциональное поле userplace_suggestion (additional_point_info для расширяемости)

```
UserplaceSuggestion:
    description: информация о рекомендуемом избранном адресе
    type: object
    additionalProperties: false
    required:
	  - count
	  - datetime
	  - available_types
    properties:
        count:
            description: число поездок в окрестности рекомендуемой точки
            type: integer
        datetime:
            description: время самой ранней поездки из поездок в окрестности этой точки
            type: string
            example: "2020-04-25T00:55:00+03:00"
         available_types:
         	description: доступные для добавления типы избранных адресов
         	type: array
            items:
              type: string
              enum:
                - home
                - work
                - other

AdditionalPointInfo:
	description: дополнительная информация об адресе
	type: object
    additionalProperties: false
    properties:
    	userplace_suggestion:
    		$ref: "#/definitions/UserplaceSuggestion"
```

Также в umlaas-geo должны быть следующие эксперименты:
- ограничение времени, за которое мы считаем поездки
- ограничение на минимальное количество поездок, после которого мы считаем точку популярной и рекомендуем добавить в избранное
- включение и выключение рекомендаций в избранное

#### В persuggest/zerosuggest

В zerosuggest нужно будет в локализовать тексты "4 раза за последние 2 недели" и "You have finished trips near this place 3 times..." и вернуть их. Ответ zerosuggest/InternalSuggestResultItem дополнится опциональным полем additional_point_info.

Отличать рекомендуемую в избранное точку от остальных на клиентах можно будет по тегу (в поле tags) "suggested-userplace".

```
UserplaceSuggestion:
    description: информация о рекомендуемом избранном адресе
    type: object
    additionalProperties: false
    required:
      - short_text
      - full_text
      - available_types
    properties:
    	short_text:
            type: string
            description: локализованная строка с информацией о 
              количестве и времени поездок в точку
            example: "4 раза за последние 2 недели"
		full_text:
			type: string
			description: локализованная строка с информацией о 
		  		количестве и времени поездок в точку
			example: "You have finished trips near this place 3 times already. Save it to your favorites and call a taxi here in one click"
		available_types:
			description: доступные типы для сохранения в избранное
			type: array
            items:
              type: string
              enum:
                - home
                - work
                - other

AdditionalPointInfo:
	description: дополнительная информация об адресе
	type: object
    additionalProperties: false
    properties:
    	userplace_suggestion:
    		$ref: "#/definitions/UserplaceSuggestion"
```
