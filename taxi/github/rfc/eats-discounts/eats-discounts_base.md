# Текущие скидки
Сейчас все скидки заводятся через админку Еды. И сам промодвижок находится в коре.

Скидки используются в следующих местах:
 - Каталог
    - Показываем, в каких ресторанах есть акции.
    - Показываем акции в шапке ресторана
 - Меню 
    - Строим категорию "Акции"
    - Получаем акционную цену блюд
 - Корзина
    - Применение акций к корзине
 - Чекаут
    - Создаем оффер, учитывая акции
    - Запуск чекера, проверяющего актуальность акций
# Предпосылки перехода на новый сервис скидок
Т.к флоу меню ритейла уже вынесен отдельно и находится в сервисе eats-products, то сейчас нельзя завести промоакции в ритейле, а хочется уметь это делать.

Предлагается вынести движок промоакций в отдельный сервис eats-discounts, который уже даже почти написан(не хватает некоторых доработок, см. ниже)

# Новый флоу акций
## Сервис eats-discounts
Сервис eats-discounts отвечает за хранение, заведение и матчинг скидок.

В сервисе уже написаны основные ручки fetch и match, которые отвечают за матчинг скидок.
Основные доработки, которые необходимо сделать:
- Ручка, которая принимает набор ресторанов, и возвращает в каких из них есть скидки
- Админка

Данный сервис был создан на подобии сервиса grocery-discounts и библиотеки discounts-match.
На wiki eats-discounts сейчас не совсем актуализированная информация(например, там скорее api лавки), но для общего ознакомления вот ссылки на вики:
- [Wiki eats-discounts](https://wiki.yandex-team.ru/taxi/backend/architecture/eats-discounts/)
- [Wiki grocery-discounts](https://wiki.yandex-team.ru/taxi/backend/architecture/yandex.lavka/grocery-discounts/)
- [Wiki discounts-match](https://wiki.yandex-team.ru/taxi/backend/userver/libraries/discounts-match/)

## Библиотека eats-discounts-applicator
Ответы сервиса eats-discounts достаточно нетривиальные, поэтому чтобы сделать работу с ними макисамльно простой, мы напишем библиотеку eats-discounts-applicator. Эта библиотека будет отвечать за работу со скидками, в ней будут реализованы методы, которые будут вызывать потребители(Например, получить товары, которые входят в категорию "Акции" для соответствующего place_id)

## Заведение скидок
В новом сервисе можно будет заводить скидки по жесткой привязке `place_id - [place_menu_item_id]`

Вообще, аналоговый сервис для лавки grocery-discounts позволяет заводить скидки в разрезе Старны/Городка/Лавки/Категории/Товара. Основная проблема, из-за которой мы не можем сделать в Еде также, это отсутствие единый айдишников товаров/категорий у одних и тех же продуктов/категорий в разрезе одного бренда. То есть у нас в двух Макдональдсах айдишники у "Чикенбургеров" будут разные.

# Ритейл (MVP)
Для начала опишу, как мы будем внедрять акции в ритейл.

Напомню, что в ритейле, сейчас нет акций и скидок, кроме изменений цен на продукты. Данную информацию мы получаем напрямую от магазинов.

## Cхема работы
### Каталог
Основные задачи в каталоге:
1. Показать пользователю в каких магазинах есть акции, явно выделив их картинкой. 

Решение:
1. Для этого в каталоге надо будет воспользоваться библиотекой eats-discounts-applicator, ее методом `GetPlacesDiscounts`(подробнее про методы смотри ниже).

### Меню 
Основные задачи в меню:
1. Получить товары, которые должны быть в категории "Акции".
1. Получить акционные цены на товары.

Решение:
1. Для этого в каталоге надо будет воспользоваться библиотекой eats-discounts-applicator, ее методом `GetDiscountItems`(подробнее про методы смотри ниже).
1. Для этого в каталоге надо будет воспользоваться библиотекой eats-discounts-applicator, ее методом `GetDiscountsForItems`(подробнее про методы смотри ниже).

### Корзина
Основные задачи в корзине:
1. Применить акции в корзине

Решение:
1. Для этого в каталоге надо будет воспользоваться библиотекой eats-discounts-applicator, ее методом `GetDiscountsForCart`(подробнее про методы смотри ниже).

### Чекаут
Основные задачи в чекауте:
1. Создавать оффер, учитывая акции
1. Запускать чекер актуальности акций

Решение:
1. Информация об акциях, которая входит в оффер, будет браться из корзины(Эта механика будет реализована в рамках переноса корзины).
1. Все чекеры постепенно будут переезжать в eats-cart, этот чекер будет в eats-discounts-applicator, и вызывать его мы будем в eats-cart. Чекаут будет дергать ручку, которая будет запускать чекеры.

Также в чекауте нам надо уметь получать скидки по способу оплаты. Для этого в текущей реализации чекаут напрямую будет ходить в eats-discounts, чтобы получать скидки. А после того, как появится отдельный микросервис офферов, он начнет использовать библиотеку eats-discounts-applicator.
### eats-discounts-applicator

#### GetPlacesDiscounts
`std::unordered_map<std::string, PlaceDiscount> GetPlacesDiscounts(std::vector<std::string>, UserData)` - принимает набор place-ов и возвращает активные скидки для этих place-oв.

В аргументы функции передается набор строк place_id и UserData:
```
struct UserData {
    std::string eater_id;
    std::string device_id;
}
```

В ответ функция отдает мапку, ключом которой будет place_id, а значением структура:
```
struct PlaceDiscount {
    std::string name;
    std::string description;
    std::string picture_url;
}

```

В самом методе мы будем ходить в [ручку eats-discounts](https://st.yandex-team.ru/EFFICIENCYDEV-12958), которая будет возвращать нам этот набор плейсов, где есть скидка, а также саму скидку.

#### GetDiscountItems
`std::vector<std::string> GetDiscountItems(std::string, UserData)` - принимает placeInfo, UserData и возвращает все товары, у которых есть какая-либо активная скидка.

В самом методе мы будем ходить в ручку fetch сервиса eats-discounts. Эта ручка по place_id вернет набор товаров со активной скидкой.

#### GetDiscountsForItems
`std::vector<PromoType> GetDiscountsForItems(std::vector<ItemForDisc>, UserData)` - принимает информацию о товарах и UserData, для которых мы хотим получить скидку.

```
struct ItemForDisc {
   std::string public_id;
   decimal64::Decimal<2> price;
   std::optional<decimal64::Decimal<2>> promo_price;
}

struct PromoType {
   std::string id;
   std::optional<std::string> detailedPictureUrl;
   std::string name: "Скидка для магазинов."
   std::string pictureUri;
}

struct ItemWithDisc {
   std::string public_id;
   decimal64::Decimal<2> price;
   std::optional<decimal64::Decimal<2>> promo_price;
   std:vector<PromoType> promo_types;
}
```

В самом методе мы будет ходить в ручку match. А дальше вытаскивать из этого ответа информацию, которая нам необходима, чтобы отобразить блюдо в меню.

#### GetDiscountsForCart
`GetDiscountsForCart(Cart, UserData)` - принимает набор товаров, который лежит в корзине, а также UserData и возвращает  корзину с акциями.

Апи данной функции должно быть такое же, как у ручки eats-core /internal-api/v1/place/menu/get-cart-discounts.

В самом методе мы будет ходить в ручку match. Получать актуальные скидки на каждый товар и на саму корзину, а после парсинга - применять их к корзине.

## Тикеты
Эпик https://st.yandex-team.ru/EDAJAM-40

Сами скидки ритейла будут реализованы в два этапа.
1 этап - возможность создавать денежные скидки.
2 этап - возможность создавать скидки товарами.

## 1 этап
### eats-discounts
1. Добавить мета-информацию скидок в eats-discounts ~ 3d https://st.yandex-team.ru/EFFICIENCYDEV-13020
1. Сделать ручку, которая по набору place-ов, отдает те, в которых есть скидка ~ 1w https://st.yandex-team.ru/EFFICIENCYDEV-12958
1. Синхронизовать текущие разрезы https://st.yandex-team.ru/EFFICIENCYDEV-12982
1. Написать админку ~ 2w https://st.yandex-team.ru/EFFICIENCYDEV-13019

### eats-catalog
1. Начать получать магазины со скидками ~ 2d https://st.yandex-team.ru/EDACAT-1058
### eats-products
1. Получать блюда для категории "Акции" https://st.yandex-team.ru/EDACAT-1057
1. Получать акционные цены на блюда https://st.yandex-team.ru/EDACAT-1056

Две задачи ~ 1w
### eats-cart
1. Для магазинов начать вычислять скидки через eats-discounts-applicator ~ 2d  https://st.yandex-team.ru/EDAJAM-54
1. Для магазинов использовать чекер актуальности скидок через eats-discounts-applicator ~ 3d https://st.yandex-team.ru/EDAJAM-46
### eats-discounts-applicator
1. Реализовать денежные скидки `GetPlacesDiscounts`~ 3d https://st.yandex-team.ru/EDAJAM-42
1. Реализовать денежные скидки `GetDiscountItems` ~ 3d https://st.yandex-team.ru/EDAJAM-43
1. Реализовать денежные скидки `GetDiscountsForItems` ~ 4d https://st.yandex-team.ru/EDAJAM-44
1. Реализовать денежные скидки `GetDiscountsForCart` ~ 4d https://st.yandex-team.ru/EDAJAM-45

## 2 этап
### eats-discounts-applicator
1. Добавить возможность для скидок товарами `GetPlacesDiscounts`~ 2d https://st.yandex-team.ru/EDAJAM-47
1. Добавить возможность для скидок товарами `GetDiscountItems` ~ 2d https://st.yandex-team.ru/EDAJAM-48
1. Добавить возможность для скидок товарами `GetDiscountsForItems` ~ 2d https://st.yandex-team.ru/EDAJAM-49
1. Добавить возможность для скидок товарами `GetDiscountsForCart` ~ 2d https://st.yandex-team.ru/EDAJAM-50


# Рестораны

В этом разделе опишу, как планирую переносить скидки ресторанов, здесь задача сложнее, потому что акции ресторанов уже есть, и надо полностью повторить текущий механизм

## Cхема работы
### Каталог
Основные задачи в каталоге:
1. Показать пользователю в каких магазинах есть акции, явно выделив их, картинкой.
1. Уметь группировать скидки по типу акций 
1. Показать акутальные акции в шапке ресторана

Решение:
1. Сейчас у акций в eats-discount, в отличие от акций в коре, нет так называемого "типа акций". Поэтому надо будет согласовать и ввести эти типы, а также написать или улучшить ручку, которая по набору places будет отдавать places, в которых акции есть(вместе с их типами и картинками). Это будет реализовано также через библиотеку в методе  `GetPlacesDiscounts`.
1. По ответу `GetPlacesDiscounts` мы будем группировать скидки по типу.
1. Будет использован метод `GetDiscountItems`, который будет возвращать акции для выбранного ресторана

### Меню 
Основные задачи в меню:
1. Получить товары, которые должны быть в категории "Акции"
1. Получить акционные цены на товары.

Решение:
1. По аналогии с ритейлом будем использовать `GetItemsWithDiscounts`.
1. По аналогии с ритейлом будем использовать `GetDiscountsForItems`.

Использовать эти методы будем в сервисе eats-restaurant-menu
### Корзина
Основные задачи в корзине:
1. Применить акции в корзине

Решение:
1. По аналогии с ритейлом будем использовать `GetDiscountsForCart`.

### Чекаут
Основные задачи в чекауте:
1. Создавать оффер, учитывая акции
1. Запускать чекер актуальности акций

Решение:
1. Информация об акциях, которая входит в оффер, будет браться из корзины(Эта механика будет реализована в рамках переноса корзины).
1. Перестанем использовать существующий чекер в коре, и начнем это делать в eats-cart.


Также в чекауте нам надо уметь получать скидки по способу оплаты. Для этого в текущей реализации чекаут напрямую будет ходить в eats-discounts, чтобы получать скидки. А после того, как появится отдельный микросервис офферов, он начнет использовать библиотеку eats-discounts-applicator.

## Дополнительные доработки для переноса акций ресторанов
### eats-discounts
1. Т.к в акциях коры реализована возможность создавать "акции на первый заказ"(и пр.), необходимо будет прикрутить поход в сервис статистики. В сервис мы будем ходить либо из библиотеки, либо из eats-discount - пока согласовывается.
1. Ввести типы акций.

### eats-catalog
1. Начать получать акции для выбранного ресторана в ручке /api/v2/catalog/<slug>(по эксперименту)
1. Начать смотреть на наличие акций в ресторане через библиотеку eats-discounts-applicator(по эксперименту)
1. Начать группировать акции по блокам(по эксперименту)
### eats-restaurant-menu
1. Начать строить категорию "Акции" через библиотеку eats-discounts-applicator(по эксперименту)
1. Начать начать получать акционную стоимость блюд через библиотеку eats-discounts-applicator(по эксперименту)

### core
1. Перестать запускать чекер актуальности акций в коре(по эксперименту)

### eats-cart
1. Начать применять акции для корзины через библиотеку eats-discounts-applicator(по эксперименту)
1. Начать запускать чекер актуальности акций для ресторанов(по эксперименту)


# План работ
Для начала мы сделаем MVP для ритейла, а потом по эксперименту вынесем рестораны

Почему именно так:
- В ритейле сейчас ничего нет, и основная продуктовая задача - это научиться заводить скидки и акции в ритейле, поэтому блокироваться на выносе акций ресторанов - это не совсем правильно
- Когда включим ритейл, мы сможем аккуратно проверить работоспособность сервиса eats-discounts и библиотеки eats-discounts-applicator, если что-то пойдет не так, акции в ресторанах никак не пострадают, акции в ритейле тоже(потому что их сейчас нет:))
- Для выноса акций ресторанов необходимо существенно больше доработок, мы не можем уменьшать продуктовые возможности акций ресторанов, а вот в ритейле мы можем реализовать какой-то минимальный функционал, а дальше наращивать продуктовые возможности
