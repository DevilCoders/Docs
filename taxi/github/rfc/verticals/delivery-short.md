# Проработка вертикали доставка

## Цель

Предоставить пользователям удобный способ пользоваться доставкой.

## Гипотеза

Вертикаль - способ объединения тарифов в одну карточку.

Сейчас на summary много тарифов, и ориентироваться в них сложно. Группировка тарифов может помочь пользователям быстрее находить нужную услугу.

https://wiki.yandex-team.ru/users/irbis/notes/taxi/Verticals

## Проблемы в текущей версии вертикалей

Текущая версия вертикалей использует mode (режим работы приложения) для группировки тарифов. В /zoneinfo в /zone_modes возвращают mode, среди которых может быть mode, у которых есть поле classes. Вся линейка тарифов с группировкой приходит /routestats в параметре splashes.

На мобильных клиентах это никак не используется.

### В /zoneinfo недостаточно данных

В /zoneinfo приложение получает всю необходиму информоцию для того, чтобы нарисовать линейку тарифов. В /routestats помимо цен могут прийти некоторые изменения в этой линейке (скрытие, недоступность тарифа или даже порядок тарифов).

Сейчас в /zoneinfo нет данных, чтобы нарисовать линейку тарифов с вертикалями.

### mode используется для двух целей

В первом варианте вертикалей получилось так, что mode обрело второй смысл. Теперь, помимо режима работы приложения, она означает группировку тарифов. Это запутывает и создает жесткую свзяь 1 к 1.

Скорее всего, многие вертикали будут просто группировкой тарифов без какого особого режима работы приложения. Также для вертикалей хочется добавить разных настроек: запирание внутри вертикали, полуоткрытое состояние карточки.

Решили отделить группировку тарифов от режима работы приложения, чтобы сделать гибче и потом было проще дорабатывать.

## Trade-off

### Сортировка тарифов и вертикалей

Для MVP решили не заморачиваться и вставить вертикаль на месте, где встречается ее первый тариф.

Также сортировка может меняться по экспериментам и в /routestats. В MVP пока не тратим на это время.

### Вертикали и /routestats

Для MVP /routestats никак не используется.

В /routestats сейчас (если включить) возвращается splashes. Это таже самая информация, что будем отдавать в verticals в ответе zoneinfo. Единственное, что дополнительно в splashes - это выбранный класс. Последний выбранный класс берется из параметров запроса selected_options_in_modes, т.е. клиенты уже знают, какой тариф должен быть выбран. Если его нет, то логично выбирать первый. В /routestats, судя по коду, сейчас выбирается последний, что странно и похоже на баг.

Скорее всего, в будущем из /routestats придется возвращать немного измененные вертикали для редких случаев. Для вертикали доставка это пока не нужно. Поэтому с /routestats ничего не делаем.

### Один тариф в нескольких вертикалях

Для MVP тариф может быть только в одной вертикали. Для доставки этого достаточно.

### Вертикали и mode

В будущем у вертикалей, скорее всего, появится свойство mode. Тут могут быть проблемы с тем, что тарифы внутри вертикали могут не иметь нужный mode. Нужно будет этот момент продумать. Скорее всего такие тарифы нужно отфильтровывать и слать алерты про ошибку в конфигурации.

Вертикаль доставка это сейчас никак не затрагивает.

## Доработки

### splashes -> verticals

Обсудили с мобильными клиентами. Вертикали пока никак не реализованы и термин splashes не используется. Мы все считаем, что не очевидно, что splashes связаны с вертикалями. Договорились использовать понятный термин verticals.

### Вложенность тарифов

Она уже есть, но нужно ее переосмыслить, как описано выше в разделе "проблема".

Предлгаю такое решение:
- Отделяем группировку тарифов от mode.
- В /zoneinfo возввращаем полную линейку тарифов совместно с вертикалями.
- В /routestats ничего не делаем.

Для MVP добавляем конфиг. Он описывает, какие группы есть в зоне. Внутри группы говорится ее название и какие классы в нее входят.
```
{
  "moscow": [
    {
      "type": "group",
      "id": "delivery",
      "title": "<танкерный ключ>",
      "default_tariff": "cargo",
      "tariffs": [
        {
          "class": "courier",
          "name": "<танкерный ключ>"
        },
        {
          "class": "cargo",
          "name": "<танкерный ключ>"
        }
      ]
    },
    {
      "type": "group",
      "id": "ultima",
      "title": "<танкерный ключ>",
      "default_tariff": "business",
      "tariffs": [
        {
          "class": "business"
        },
        {
          "class": "comfortplus"
        }
      ]
    }
  ]
}
```

В /zoneinfo добавить новый параметр запроса supported_vertical_types. Он позволит не возвращать лишнего на старых клиентах. И возвращать вертикали отдельным полем verticals. В нем будут группировка тарифов согласно конфигу и просто тарифы:
```
"verticals": [
  {
    "type": "tariff",
    "class": "econom"
  },
  {
    "type": "group",
    "id": "delivery",
    "title": "Доставка",
    "default_tariff": "cargo",
    "tariffs": [
      {
        "class": "courier",
        "name": "до 5 кг"
      },
      {
        "class": "cargo",
        "name": "до 20 кг"
      }
    ],
  }
]
```

#### default_tariff
В конфиге можно задать, какой тариф внутри вертикали выбрать по умолчанию, если /personalstate ничего не пришло. В ответе /zoneinfo вернется либо значение из конфига, либо (если тарифа нет) первое значение из списка тарифов вертикали.

### personalstate (@oleg-pe)
Ручка /personalstate сохраняет и возвращает состояние приложения для пользователя. В запросе и ответе уже есть поля selected_mode и selected_options_in_modes, но они никем не используются. Называются mode, т.к. в этот термин вложили второе значение (описано в выше).

Предлагается сделать так:
- Переименовываем в PersonalstateRequest поле selected_mode в selected_vertical
- Переименовываем в PersonalstateRequest поле selected_options_in_modes в selected_options_in_verticals
- Возвращаем эти поля в PersonalstateResponse

Бэкэнд является только “хранителем” стейта и никак его не модифицирует. Клиент ответственнен за заполнение selected_options_in_verticals, selected_class и selected_vertical. Бэкэнд не делает ни валидацию, ни мержинг данных.

Логика работы:
- в selected_class попадает выбранный текущий тариф (либо на общем барабане, либо внутри вертикали)
- в selected_vertical попадает выбранная текущая вертикаль, если вертикаль не выбрана, то это поле должно быть пустым или отсутствовать и это будет означать, что в поле selected_class выбран тариф на общем барабане
- в selected_options_in_verticals описывается какой тариф должен быть выбран внутри каждой вертикали, если такой вертикали нет или внутри нее нет selected_class, то брать дефолтный из поля verticals в ответе /zoneinfo

#### На будущее
Дополнительно обсудили и решили, что из-за органичений по времени не будем делать сейчас, а проработаем позже:

1. Есть желание не запоминать в /personalstate в selected_class некоторые тарифы (например, "Доставка"). Обоснование звучит так "если ты воспользовался один раз доставкой грузов не значит, что теперь тебе надо по дефолту открывать тариф Грузовой". Примерные идеи по реализации:
- Переработать сохранение в mongo, чтобы апдейтились только некоторые поля.
- Можно сделать так, чтобы клиенты не передавали selected_class - но тогда в personal_state просто не будет последнего выбранного.

2. Есть проблема с тем, что настройки с одного тарифа сейчас пробрасываются на остальные тарифы, но при этом могут примененяться только в конкретном тарифе. Например, "желтые номера" не актуальны для Бизнеса, но если их выбрать, то они пытаются примениться на бизнес и об этом пишется нотификация. Кажется, что на бекенде это учтено (в tariffs есть поле class, которое говорит о том к чему применяется `requirement`).

## Разработка

### Этап 0

- Добавляем конфиг ZONE_VERTICALS
- Добавляем supported_vertical_types в запрос /zoneinfo
- Добавляем вертикали в ответ /zoneinfo (поле verticales)

### Этап 0.5
Хочется сразу поправить /personalstate, чтобы перейти на термин verticals. Вертикаль доставка это не блокирует.
- Добавляем в /personalstate сохранение текущей вертикали и последний выбранный тариф внутри каждой вертикали

### Дальнейшие этапы

- Дорабатываем /personalstate как рассказано выше (отдельная проработка)
- Перерабатываем ответ с вертикалями из /routestats (отдельная проработка)
- Доработать вертикали, чтобы можно было один тариф в несколько вертикалей добавлять
  - Также нужно поправить zone_modes в ответе /zone_info (там есть tariff_splash, что по сути относится к вертикалям, а не к режимам работы приложения)
- Вынести всю логику вертикалей в микросервис (может, это не имеет смысла или невозможно)
