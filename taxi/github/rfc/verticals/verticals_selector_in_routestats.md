## Задача

Когда-то была сделана разработка для появления вертикалей в ответе `/routestats`.
Решение не было включено в проде. Надо возобновить работу с вертикалями в `/routestats`, добавив в них минимально необходимые данные - 
информацию о селекторе вертикалей.

## Необходимые изменения

### Поддержка вертикалей `/routestats`

Сейчас клиенты получают информацию о вертикалях из `/zoneinfo`. 
Ответы, содержащие вертикали, в `/zoneinfo` и `/routestats` разные. 
Это было сделано для того, чтобы, поддержав вертикали в `/routestats`, клиенты могли обогатить построенные на основе `/zoneinfo` вертикали новой информацией.
Проработка делалась до появления селектора вертикалей, тогда не предполагалось, что вертикали между запросами в `/zoneinfo` и `/routestats` могут быть полностью перестроены 
(допускалось только исчезновение части тарифов из вертикалей после учёта их видимости).
Пока есть опасения, что это может происходить: при переключении экспериментов между вызовами могут построиться сначала обычные вертикали, потом вертикали с селектором.
Тогда остаётся вопрос, как клиентам правильно перестроить вертикали.

Могут быть такие варианты:
1. Добавить в вертикали `/routestats` всю информацию, которая приходит в `/zoneinfo` и нужна для их построения, чтобы вертикали `/routestats` стали самодостаточными. 
Тогда клиенты при получении ответа `/routestats`, сильно отличающегося от `/zoneinfo`, смогут полностью перестроить вертикали.
Плюс такого решения - оно не предполагает новой клиентской логики. 
Минус - увеличится ответ ручки `/routestats`, который и так большой, будем пересылать ещё больше данных, ухудшится производительность.
2. Игнорировать на клиентах ответ `/routestats`, если вертикали не соответствуют `/zoneinfo`, продумав фоллбэк на клиенте.
Плюс решения - не надо добавлять ничего в ответ `/routestats`. Минусы - наличие клиентской логики там, где можно было бы всё сделать на бэкенде.

### Изменения в ответе `/routestats`

Чтобы принять решение, по какому пути пойти, надо сравнить текущие ответы ручек и оценить, какие поля придётся добавить.
Структура вертикали для одиночного тарифа одинаковая. А структуры вертикали из нескольких тарифов различаются.

Есть в `/zoneinfo`, но нет в `/routestats`:
```
title:
    description: название вертикали
    type: string
title_summary:
    description: название вертикали для отображения на summary; может
        содержать шаблонные параметры
    type: string
    example: "Ultima: $TARIFF$"
can_make_order_from_summary:
    description: можно ли делать заказ из саммари, не заходя в вертикаль
    type: boolean
icon:
    $ref: definitions.yaml#/definitions/image
    description: иконка вертикали, если поля нет, то брать иконку выбранного
        тарифа
image:
    $ref: definitions.yaml#/definitions/image
    description: изображение вертикали в развернутой карточке, если поля
        нет, то брать изображение выбранного тарифа
header_icon:
    $ref: definitions.yaml#/definitions/image
    description: изображение вертикали на хедере вертикали в развёнутой
        карточке
default_tariff:
    description: дефолтный выбранный тариф в вертикали из списка tariffs
    type: string
```

И изменения в структуре каждого тарифа:
```
name:
    description: название тарифа, если поля нет, то брать поле name из
        описания тарифа в max_tariffs
    type: string
description:
    description: описание тарифа, если поля нет, то брать поле description
        из описания тарифа в max_tariffs
    type: string
```

Выглядит значительным изменением, особенно с учётом того, что ситуация редкая, и можно сделать фоллбэк на клиентах. 
Пока в качестве фоллбэка предлагается перехдить к списку тарифов из `max_tariffs`.
Думаю, что лучше оставить `/routestats`, как есть, и только добавить селектор.

#### Добавление селектора 

Селектор добавим аналогично `/zoneinfo`. Эксперимент и конфиг можно переиспользовать. Добавятся:
- флаг `supports_verticals_selector` в корне запроса;
- в случае успешного формирования вертикалей для селектора добавление в корень ответа `/routestats` массива `"verticals_modes": ["verticals_selector"]`,
сигнализирующего клиентам, что они могут отображать селектор вертикалей (так же, как и в `/zoneinfo`).

Момент, специфичный для `/routestats`: может возникнуть ситуация, когда на клиентах закеширован zoneinfo 
(сейчас - 5 минут на Android, до перезапуска приложения на iOs), а в это время в эксперименте добавилась новая вертикаль. 
Клиенты её правильно построить не смогут. 
В такой ситуации надо не потерять тарифы из этой новой вертикали до перезапроса zoneinfo.
Для этого:
- клиенты будут передавать список построенных вертикалей;
- не построенные возвращать в ответе не надо;
- тарифы из них могут попасть в другие вертикали 
(пример: вертикаль Детского не строим, но Детский есть в вертикали Такси), тогда ничего не меняем;
- если тариф не попадает ни в одну построенную вертикаль - добавляем его в rest tariffs.
`/zoneinfo` для такого сценария должен всегда отдавать необходимый минимум для построения rest tariffs;
- предлагается не передавать в запросе `rest_tariffs`, если на клиенте построить её нельзя. 
Тогда селектор в таком случае, как описан выше, не будет строиться.

Изменения в api будут выглядеть так:
```
RoutestatsRequest:
    additionalProperties: false
    properties:
        supports_verticals_selector:
            description: поддержан селектор вертикалей
            type: boolean
        supported_verticals:
            description: |
                Список поддержанных вертикалей.
                Вычисляется на клиентах по ответу zoneinfo, 
                который может кэшироваться
            example: ["taxi", "ultima", "rest_tariffs"]
            type: array
            items:
                type: string
...

RoutestatsResponse:
...
    properties:
...
        verticals:
            ...
        verticals_modes:
            description: режимы работы вертикалей
            type: array
            items:
                type: string
```

## Этапы работы

1. Сделать предварительный рефакторинг кода вертикалей, чтобы изменение не было исключительно ухудшающим. 
Пока обсуждаются варианты: 
 - вынести в плагины `routestats`;
 - сделать либу в `uservices` и использовать и в `/routestats`, и в `/zoneinfo`;
 - оставить код в  `backend-cpp` и сделать рефакторинг там.
 
Предварительно код выносится в плагины `routestats`.

2. Добавить селектор вертикалей в `/routestats`.

Было бы правильно учесть видимость тарифов и в `/zoneinfo`, и в `/routestats`. 
Если это ещё не сделано, можно добавить по ходу разработки и там, и там. 
Пока что это необязательно - видимость проверяется на клиентах, но было бы неплохо.
