# Задача

Для аналитики нужно разделять заказы из вертикали и из обычной линейки тарифов, чтобы понять, как работают вертикали.

# Почему не сделать это на клиенте

Дейсвительно, вертикаль - это спосб отображения тарифов и к заказку не имеет никакого отношения. Проблема в том, метрика (аналтитические данные с мобильных клиетов) имеет потери. Последний раз, когда эти потери считали получилось 0,5%. Для эспериметов, связанных с деньгами и заказами, эти потери очень существенны.

Поэтому обычно данные для таких экспериментов берутся с бэкэнда. Им можно доверять, т.к. если нет заказа в БД, то и заказа, видимо, не было.

# Почему не сделать это по косвенным признакам

Была идея по наличию эксперимента понять была у пользователя вертикаль или нет.

К сожалению, этого недостаточно. Даже, если пользователь попал в эксперимент, он может не увидеть вериткаль, если в вертикали один тариф, или в линейки тарифов есть только вертикаль и 1-2 других тарифа. В этих случаях верикаль развернется в обычную линейку тарифов.

Также в бущудем тариф может оказаться в двух вертикалях. Т.е. нужно узнать не только факт попадания в вертикаль, но и в какую вериткаль попал тариф.

# Решение

Хранить vertical_id в заказе неправильно. Это некритичные данне, они нужны только на момент сбора статистики для аналитики. Поэтому предлагаю хранить их относительно короткое время в YT.

1. Создаем новый сервис для записи разной инфы в yt.
1. Убираем /orderdraft и /ordercommit за api-proxy
1. Добавляем в /orderdraft новое поле vertical_id.
1. На api-proxy получаем ответ /orderdraft, берем из него order_id и отправляем пару (vertical_id, order_id) в сервис записи в yt (пара пишется БД).
1. На api-proxy получаем ответ /ordercommit и подтверждаем order_id в сервисе записи в yt (происходит запись в лог отправки в YT).

## Зачем новый сервис

Я не нашел ничего подходящего.

Задача выглядит достаточно общей. Скорее всего его можно будет переиспользовать, чтобы добавлять похожую функциональность для других запросов.

## Почему не отдельный запрос, а новое поле в /orderdraft

Нужно обеспечить максимальную консистентность данных. Со стороны клиентов этого можно добиться на 100% только в случае отправки vertical_id в момент создания заказа.

## Что делать с замедлением работы основных ручек флоу заказа

Я вижу два пути:
- Не дожидаться в api-proxy ответов от сервиса записи в yt
- Ставить stq-таску из api-proxy вместо дерганья ручек нового сервиса

Вроде это невозможно сделать средствами api-proxy.

К тому же оба этих решения могут привести к потерям данным. Вряд ли таким большим и размазанным по времени, как с клиентов, но качество данных, за которое и идет борьба, может пострадать.

# Разработка

## Этап 0

- Добавляем в запрос /orderdraft параметр vertical_id.
- В монолите при успешном ответе /orderdraft пишем в лог для YT связку order_id и vertical_id.
- Настраиваем отправку этого лога в YT.

## Этап 1

Завершаем текущую проработку:
- Прорабатываем вариант с utm-метками.
- Выносим логику в отдельный сервис.
