# Вертикали

## История предыдущих изменений

Вертикали уже прорабатывали летом 2019 (modes.md). Тогда решили совместить понятие моды и вертикали в одно. Это никуда не поехало.

В марте 2020 решили сделать упрощенный вариант вертикалей для Доставки (delivery-short.md). В этом решение вертикали  отдельная сущность. Это уже в продакшене. Во время той проработки было срезано много углов.

## Существующие недоработки

1. /routestats не умеет вовзращаться вертикали ([TAXIBACKEND-28728](https://st.yandex-team.ru/TAXIBACKEND-28728)).
1. Тариф может быть либо в вертикали, либо в общей линейке тарифов ([TAXIBACKEND-28734](https://st.yandex-team.ru/TAXIBACKEND-28734)).
1. Вертикали не поддерживают mode ([TAXIBACKEND-28730](https://st.yandex-team.ru/TAXIBACKEND-28730)).
1. Вертикали не поддерживают мультикласс ([TAXIBACKEND-28733](https://st.yandex-team.ru/TAXIBACKEND-28733)).

## /routestats

В /routestats и /zoneinfo возвращается информация о тарифах в service_levels и max_tariffs, соответсвенно. Теперь в /zoneinfo добавлены вертикали. Сейчас их основная роль в группировке тарифов. Положение вертикали на линейке тарифов зависит от порядка тарифов.

При разработке вертикали доставка их добавили только в /zoneinfo. В /routestats порядок тарифов в service_levels может отличаться и именно его в конечном итоге используют на клиентах. Например, делался эксперимент, чтобы рядом со строительными магазинами тариф грузовой перемещался в начло списка.

Поэтому в /routestats тоже нужно возвращать вертикали.

### Вертикали в /routestats

Формат ответа с вертикалями в /routestats будет похож на ответ из /zoneinfo. Убраны неизменяемые поля (title, title_summary etc), сохранена структура и добавлено поле price (о нем дальше).

В запрос нужно добавить supported_vertical_types аналогично тому, как сделано в /zoneinfo.

### splashes в /routestats

Поле splashes было добавлено в самом первом варианте вертикалей. Во время проработки вертикали Доставка мы решили использовать более понятное слово verticals.

splashes будем заменять на verticals. Это безопасно, т.к. splashes не используется клиентами.

Также удаляем из запроса поле supported. Оно было добавлено, чтобы /routestats возвращал splashes только тем клиентам, которые поддерживают splashes. Оно не исопльзуется и не подходит для вертикалей, т.к. нужно будет передавать список поддерживаемых видов вертикалей.

Также удаляем из запроса поле selected_options_in_modes. Оно было добавлено на всякий случай и не используется клиентами. Обсудили с ними, нужно сейчас передавать в routestats информацию о выбранных внутри вертикалей тарифов. Никаких сценариев не придумали. Оставлять это поле на будущее нет смысла, т.к. для вертикалей его все равно нужно переименовывать в elected_options_in_verticals.

### alternatives и вертикали

Сейчас для некоторых тарифов могу предлагаться альтернативные варианты. Например, другая точка подачи, откуда поездка будет дешевле.

Вертикали - это способ групировки тарифов. Соответственно, приложение с поддержкой вертикалей сможет посмотреть, для какого тарифа предлагается альтернативнай вариант и поместить его внутрь нужной вертикали.

### is_hidden и вертикали

Пока не удалось до конца выяснить, зачем в service_levels возвращаются скрытые тарифы. На клиентах они просто не показываются.

Есть предложение в вертикалях в /routestats не передавать скрытые тарифы. В дальнейшем, когда будем думать о разворачивании вертикалей ([TAXIBACKEND-28398](https://st.yandex-team.ru/TAXIBACKEND-28398)) это должно будет упростить логику.

### Цена на саммари на карточке вертикали

Cейчас логика показа цены на карточке вертикали сделана на клиентах через эксперимент. При этом им приходится вынимать цену из строчки, т.к. она возвращается только строчкой. Это не хорошо. Нужно это поправить.

Цена на карточке вертикали на саммари может быть в двух вариантах:
- цена на выбранный тариф внутри вертикали;
- минимальная цена среди всех тарифов внутри вертикали.

Первый случай нужен тогда, когда можно сделать заказ, не заходя внутрь вертикали. Второй - наоборот. Для регулирования этого поведения предлагается добавить настройку в вертикаль ([TAXIBACKEND-28731](https://st.yandex-team.ru/TAXIBACKEND-28731)).

Также, если мы разрешаем делать заказ не заходя внутрь вертикали, то на карточке вертикали помимо ее названия должен быть указан тариф. Это требования закона об оказании услуг. Например, в вертикали Ultima быбран тариф Business, тогда карточка вертикали на саммари должна выглядеть так:

![](img/vertical_ultima_price.png)

То, в каком виде пишется заголовок вертикали на саммари, добавляется в таске [TAXIBACKEND-28729](https://st.yandex-team.ru/TAXIBACKEND-28729) (поле `title_summary`). В принципе тариф могут захотеть показывать на саммари даже если заказ можно сделать только зайдя в вертикаль.

**Итого**, получается, что нужно согласованно решить три задачи:
1. Возвращать цену на клиенты в удобном формате.
2. Возвращать признак, можно ли делать заказ из саммари, не заходя в вертикаль.
3. Возвращать шаблонизированный заголок, куда можно подставить название выбранного внутри вертикали тарифа.

#### Решение

Для цены нужно рассмотреть два случая:
- можно сделать заказ, не заходя в вертикаль;
- нужно зайти в вертикаль, чтобы сделать заказ.

В первом случае, клинеты могут просто взять поле `price` выбранного тарифа. Для второго случая можно на бэкэнде посчитать минимальную цену и вернуть ее в формате "от 99 $SIGN$CURRENCY$" в опциональном поле `price` в вертикали.

Заголовок вертикали на саммари сделан в таске [TAXIBACKEND-28729](https://st.yandex-team.ru/TAXIBACKEND-28729). Нужно возвращать `title_summary` согласованно с настройкой возможности сделать заказ, не заходя внутрь вертикали. Есть два варианта:
1. Оставить это на совести того, кто конфигурирует вертикаль. Если указал, что заказ можно сделать с саммари, то и `title_summary` соотвествующий напиши.
2. Фиксируем формат "Title: Tariff" на бэкэнде и будет возвращаться `title_summary` в этом формате, если у вертикали есть флаг `can_make_order_from_summary`.

Мне больше нравится второй вариант, т.к. в нем отсутсвует человеческий фактор и во время изменения с одного формата на другой не нужно будет менять в двух местах (данные могут из-за этого разъехаться и все равно остаться несогласованными). При необходимости можно будет дорабоать логику на бэке, а клиенты автоматически заработают, т.к. они уже будут уметь обрабатывать шаблонизированные строки вида "Ultima: $TARIFF$".

### Почему все доработки в монолите

Прямо сейчас идут несколько инициатив по выносу кода из монолита:
- [zoneinfo](https://st.yandex-team.ru/TAXIBACKEND-25871);
- [routestats](https://st.yandex-team.ru/TAXIBACKEND-28646);
- [visibility_helper](https://st.yandex-team.ru/TAXIBACKEND-27037).

Пока еще рано начинать их использовать. Поэтому было принято решение писать код для вертикалей внутри монолита, но думать о том, чтобы его легко можно было вынести в uservices (библиотеку или отдельный сервис).

## Поддержка тарифа в нескольких местах

TODO

## Поддержка mode в вертикали

TODO

## Поддержка мультикласса в вертикали

TODO
