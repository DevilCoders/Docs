## Задача
Поддержать селектор вертикалей для Summary 3.0.

Селектор вертикалей — дополнительный список вертикалей над основным списком тарифов.

![](img/vert_selector.png )

Ключевое отличие селектора вертикалей от обычных вертикалей с точки зрения логики бэкенда -
с бэка нельзя возвращать одиночные тарифы + будет дополнительный флаг,
который говорит, что нужно отрисовывать селектор вертикалей.

## Решение
Т.к. нельзя возвращать одиночные тарифы, то все лишние тарифы,
которые остались после группировки в вертикали, будут
складываться в еще одну вертикаль "Остальные тарифы" (название еще не точное).

Тут есть недостаток в том, что в одну вертикаль могут попасть совсем разношерстные тарифы.
Но это решается правильным заданием эксперимента с вертикалями.

## Продуктовые требования
Эксперимент:  
Эксперимент3, включающий на бэке логику с селектором `verticals_selector`.

C клиента может приходить информация о вертикалях:
- клиент присылает список поддерживаемых обычных вертикалей (означает, что он просто поддерживает вертикали),
- клиент присылает флаг о том, что поддерживает селектор вертикалей.

На основании этого бэк должен решить что вернуть.
Тут есть несколько вариантов:

1. клиент поддерживает вертикали, но не поддерживает селектор:
    
    бэк возвращает обычные вертикали

2. клиент поддерживает и вертикали, и селектор:

    На бэке проверяем включен ли эксперимент с селектором.    
    И возвращаем вертикали, которые подходят для селектора (без одиночных тарифов).

###### Более подробно про случай №2:
- Нужно завести отдельный эксперимент для включения логики селектора
- Если по какой-либо причине нам не удалось составить вертикали для селектора,
то нужно делать фоллбек на обычные вертикали
- Нужна поддержка одного и того же тарифа в нескольких вертикалях
- Нужно ввести минимальное количество вертикалей, меньше которого не будет работать логика селектора
- Нужно ввести минимальное количество тарифов в каждой вертикали
и если хотя бы в одной вертикали оказалось меньше тарифов, мы не передаем селектор,
а делаем фоллбек на обычные вертикали


## Необходимые изменения
Чтобы можно было разделить пользователей на тех, кому мы будем показывать обычные вертикали
и тех, кому селектор вертикалей, можно добавить информацию о вертикалях в эксперимент `verticals_selector`.
И задать схему эксперимента так же как и [схему конфига ZONEINFO_VERTICALS](https://github.yandex-team.ru/taxi/schemas/blob/develop/schemas/configs/declarations/zoneinfo/ZONEINFO_VERTICALS.yaml) но с необходимыми добавками.
Так же в этот эксперимент нужно добавить отдельный объект `rest_tariffs`
с настройками для вертикали "Остальные тарифы".

Тогда логика формирования вертикалей будет работать следующим образом:
если пользователь попал в эксперимент `verticals_selector`, то
все настройки вертикалей берутся из этого эксперимента.
А если пользователь не попал в этот эксперимент, то для него работает обычная логика вертикалей.


##### Общие изменения:
- получение флага "verticals_selector" из массива `supported` из запроса клиента в `zoneinfo`
- поддержка эксперимента, включающего на бэке логику с селектором
- в случае успешного формирования вертикалей для селектора
добавление в корень ответа zoneinfo массив `"verticals_modes": ["verticals_selector"]`,
сигнализирующий клиентам, что они могут отображать селектор вертикалей
(это массив, в котором перечисленны режимы работы вертикалей,
т.к. в дальнейшем могут быть другие режимы работы вертикалей)

##### Формирование вертикалей для селектора вертикалей:
- переработать логику добавления тарифов в вертикаль,
чтобы один и тот же тариф мог находиться в нескольких вертикалях (сейчас такого нет)
- тогда, после отработки основной логики вертикалей, у нас получится список вертикалей
и список тарифов, которые должны остаться на summary. Из списка одиночных тарифов убираем все,
которые уже есть в вертикалях и из оставшихся формируем вертикаль "Остальные тарифы"
(при хорошей настройке эксперимента вертикали с остальными тарифами просто не должно быть, 
все тарифы будут раскиданы по вертикалям)

##### Самый быстрый (multiselect)
Самый быстрый работает так:
на стадии zoneinfo клиент получает настройки для "самый быстрый",
а список тарифов для него берет из предыдущего ответа routestats,
потом из routestats получает новый список тарифов и по нему строит тариф "самый быстрый".

Первая итерация "самого быстрого" в селекторе вертикалей:
"самый быстрый" может быть только в одной вертикали и в нем могут содержатся только все доступные для "самого быстрого" тарифы(т.е. из разных вертикалей)

Для этого с бэка, для каждой вертикали(и в zoneinfo и routestats) в селекторе будет приходить объект `multiclass`:
```
multiclass : 
    type: object
    additionalProperties: false
    required:
        - tariffs
    properties:
        position: 
            type: integer
            description: | 
                позиция "самого быстрого" внутри вертикали
                отсутствие параметра position означает, что 
                multiclass нужно поставить в конце тарифов
        tariffs:
            type: array
            description: тарифы, которые нужно показать в "самом быстром" внутри данной вертикали
            items:
                type: string
                
```  
Наличие объекта `multiclass` в вертикали означает, 
что для данной вертикали нужно показывать "самый быстрый"

В первой итерации бэкенда объект `multiclass` будет приходить только для одной вертикали, a `tariffs` ни на что не будет влиять, 
т.к. "самый быстрый" будет строиться по всем доступным для него тарифам

В следующей итерации планируется улучшение:
"самый быстрый" может быть в нескольких вертикалях. 
И в каждой вертикали в "самом быстром" возможны различные наборы тарифов, которые задаются бэкендом

Для того, чтобы клиенты могли не хранить у себя в кэше тарифы из прошлого ответа routestats 
тарифы планируется присылать с бэка, из routestats и из zoneinfo. 
Для каждой вертикали будет свой список тарифов для "самого быстрого".   
Дальнейшая проработка будет после решения [задачи по выносу конфигурации позиции самого быстрого на бэк](https://st.yandex-team.ru/TAXIBACKEND-30849)

Также возможно расширение объекта `multiclass` для настроек отображения "самого быстрого" в разных вертикалях
( то, что сейчас передается в ответе zoneinfo в объекте multiclass и в alternative из routestats)


