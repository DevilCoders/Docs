 
# Проработка этапа 3 (доработка для Шереметьево)
## Основные проблемы которые необходимо решить 

1. Решение этапа 1 не позволяет встроиться в существующий диспатч в аэропортах (для определенных тарифов должен работать новый диспатч по коду, для остальных существующий с барабанами для пользователей и электронными очередями для машин)
2. Обработка заказа после ввода требует много лишних действий от водителя.
4. Плашка с вводом кода на таксометре появляется спутся 10 минут после въезда в зону.
5. После ввода кода может произойти ошибка назначения заказа без объяснения причин.


## Предлагаемые решения 
### Продуктово
(перенесено на след этап) 1. После ввода кода заказ водителю должен приходить в транспортинге (не может не принять заказ).
(перенесено на след этап) 2. Нужно проверять водителя как только он попал в очередь, в соответствии с настроенными требованиями (по тарифам, креслам и т.п.). (мы должны гарантировать, что на этапе посадки не должно возникнуть проблем с совместимостью заказа и водителя). 
3. Только для Шереметьево: Пользователь выбирает барабаном терминал -> выбирает тариф и требования -> в зависимости от выбранных условий появляется либо барабан с выбором точек посадки у терминалов (если не эконом), либо точка посадки по код диспатчу на подходящей по требованиям линии (если эконом).
4. Только для Шереметьево: за попаданием машины на 1-ю линию следит подрядчик по RFID меткам, которые завязаны на гос номера. Подрядчик сообщает нам о заезде/выезде машин на/с линии. Мы же сообщаем подрядчику о том какие машины нужно нагонять на линию.

### Технически
1. [учтено] Заводим коллекцию `code_dispatch.driver_info` с информацией о текущем статусе водителя в зоне код-диспатча:
```
{
  'park_db_id': 'park_id', # id парка
  'driver_id': 'driver_id', # id водителя
  'code_dispatch_area_id': 'svo', # идентификатор зоны диспатча
  'status': 'in_line|failure' # статуc (в очереди на линии|не может принимать заказ)
  'reasons_for_failure': [...]  # список причин, по которой данный водитель не может принимать заказы
                                # и должен покинуть район код-диспатча или выполнить некоторые рекомендации
}
```
2. [1д] Проверяем, что существующий механизм работы с электронными очередями на основе шлагбаумов нам подходит, и используем его. Если не подходит - [6д] разработки своего механизма.
3. [4д] Добавляем в партнерские ручки статуса таксометра (одиночную и балковую): 
    - дату и время принятия заказа исполнителем
    - включённые классы у водителя
    - статус заказа, которые есть на водителе, и который был назначен не Синтегро (мобильное приложение, партнёрская форма, колл-центр, что угодно)
    - признак, на какие линии-полигоны он может заезжать (конфиг, в котором есть соответствие тарифов линиям)
4. [6д] Необходимо доработать protocol в части нового (опционально разветвленного) флоу создания заказа (потребует доработки клиента):
   * доработка ручки suggest в сервисе persuggest (теперь перекрытия и пикап-поинты приходят там) - нужно помечать нашу точку для посадки по код-диспатчингу (в секции points) и добавить признак отложенного показа барабанов выбора столбов (в position_choices)
   * доработка ручки routestats - добавляем в информацию по тарифам, по какому флоу мы должны идти (либо по пути барабанов и столбов, либо по пути посадки в очередь код-диспатчинга)
10. [3д] Добавить мониторинг на все.
11. [5д] Интеграционное тестирование (бек + таксометр + клиенты + синтегро) и доработки по его результатам.
12. [2д] Запуск.

ИТОГО: 21-26д
