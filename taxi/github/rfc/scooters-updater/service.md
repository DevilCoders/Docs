**Название сервиса**

scooters-updater

**Какую продуктовую проблему решает сервис?**

Дает возможность обновлять прошивки самокатов.

**Почему нельзя решить эту задачу без разработки нового сервиса существующими решениями?**

Нет сервиса для обновления прошивок самокатов, это новая отдельная сущность.

**Как именно сервис будет решать поставленные перед ним задачи?**

Сервис будет:
- опрашивать самокаты о текущей версии прошивки
- хранить текущие версии прошивки самокатов
- отправлять запрос на обновление прошивки в самокат
- создавать новые версии прошивок и загружать файлы в S3.

Примерный флоу:
1. Храним текущие версии прошивок, установленных в самокатах и шкафах.
2. Храним все прошлые версии прошивок и ссылки на файлы.
3. Заводим новую версию прошивки и загружаем файл прошивки в MDS S3.
4. Бэкенд самокатов может спросить какие текущие версии прошивок.
5. Выбираем, какие самокаты мы хотим обновить и бэкенд дергает ручку на обновление устройства с определенной прошивкой.
6. Ждем пока самокат обновится и сохраняем новую версию прошивки устройства.

Возможные ручки:
1. Добавить новую прошику и загрузить файл прошивки в S3
2. Обновить прошивку самоката версии 1 и 2
3. Обновить прошивку самоката с собственным IoT
4. Вернуть версии прошивок
5. Вернуть текущую версию прошивки самоката

**Разрабатывается один сервис или система?**

Один сервис.

**С кем взаимодействует сервис?**

Обновления прошивки:

1. Запрос на обновление:
админка (tariff-editor) <-> scooters-updater <-> бекенд самокатов (scooters-backend + scooters-telematic) <-> самокаты

2. Загрузка прошивки:
самокаты <-> MDS S3

Сборка прошивки:
scooter-updater <-> MDS S3

**Какие базы использует?**

Postgres в PGaaS.

**Какие периодические процессы?**

Нет.

**Планируется обработка персональных данных**

Не планируется обработка персональных данных.

**Прикрепите схему того, где этот сервис находится в текущей инфраструктуре**

Яндекс.GO <-> Бекенд самокатов <-> scooters-updater

**Какие данные и по какой схеме сервис будет хранить в базе?**

```javascript
hardware_type
{
    vega_mcu,
    vega_gsm,
    audio_lock,
    audio_locate,
    audio_unlock,
    audio_battery_low,
    yandex IoT
}

Таблицы:

1) firmwares
{
  "id": "id",
  "hardware_type": "тип устройства, значения из hardware_type",
  "version": "Версия прошивки(как в SaaS)",
  "version_num": "Порядковый номер версии",
  "file_link": "Ссылка на файл в MDS S3",
  "comment": "Доп. информация о прошивке",
  "created_dt" "Дата создания прошивки"
}

2) scooters
{
  "id": "id",
  "external_id": "id в базе самокатов",
  "version" : "версия самоката, 1 или 2",
  "vega_mcu_firmware_id": "id прошивки vega_mcu",
  "vega_gsm_firmware_id": "id прошивки vega_gsm",
  "audio_lock_firmware_id": "id прошивки audio_lock",
  "audio_locate_firmware_id": "id прошивки audio_locate",
  "audio_unlock_firmware_id": "id прошивки audio_unlock",
  "audio_battery_low_firmware_id": "id прошивки audio_battery_low",
  "iot": "id прошивки yandex iot",
  "firmware_update_dt": "Дата обновления прошивки",
  "firmware_update_time": "Время установки последней прошивки"
}

```

**Какой объем данных будет храниться и какой объем будет изменяться в единицу времени?**

Меньше 200Mb

Изменений до 0.3Mb/s

**Какие операции над данными заложены?**

CRUD

**Есть ли какой-то стейт в памяти, как он обновляется и валидируется?**

Нет.

**Какая нагрузка ожидается?**

- 1 rps в обычное время
- 500 rps во время обновления (обновлять будем группами)

**Какие фолбеки предусмотрены на сам этот сервис?**

Нет. Не сможем обновлять устройства.

**Какие фолбеки предусмотрены внутри этого сервиса на взаимодействие с другими сервисами?**

Если недоступна база данных: не отвечаем на запросы по получению версий прошивок устройств и ссылок на прошивки в S3.
Если недоступна S3: не можем получить файл прошивки.

**Какие возможности масштабируемости закладываются?**

Увеличение базы, увеличение ram/cpu на инстансе, увеличение количество инстансов сервиса.

**Какие точки отказа есть в сервисе?**

- Отказ Postgres.
- Отказ MDS S3.
- Отказ scooters-backend

**Укажите ключевые продуктовые метрики сервиса, за которыми планируете следить**

- Версии прошивок самокатов.
- Кол-во самокатов с определенной версией
- Время обновления прошивки

**Укажите технические метрики**

- Количество запросов.
- Максимальное и среднее время ответа на запрос.
- Количество записей в бд.

**Какая функциональность ожидается в сервисе в будущем?**

Функционал, связанный с обновлением прошивок разных версий самокатов (1я версия самоката, 2я версия и собственный IoT)

**Какое изменение нагрузки планируется?**

Прямо пропорционально количеству самокатов.

**Активно ли будет изменяться сервис?**

Нет.
