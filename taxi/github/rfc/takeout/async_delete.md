## Задача

В `takeout` уже реализовано синхронное удаление данных. 
Почитать о нём можно [здесь](delete_personal_data.md).
Есть сервисы, которые удаляют данные долго, и синхронное удаление им неудобно. 
Для таких сервисов предложим асинхронную схему.

То же самое - с выгрузкой данных. Сейчас она реализована синхронно, 
но надо сделать асинхронную схему по аналогии с удалением.

## Где почитать про takeout?
Чтобы было проще реализовать предложенное решение, можно посмотреть:
- [презентацию](https://jing.yandex-team.ru/files/sia-raimu/takeout_data_deletion_2.pdf) про `takeout`;
- [статью](https://wiki.yandex-team.ru/users/e-usov/taxi-takeout/) про сервис `takeout` и выгрузку данных;
- [статью](https://wiki.yandex-team.ru/users/sia-raimu/udalenie-dannyx-po-takeout) про удаление данных;
- [вики Паспорта](https://wiki.yandex-team.ru/users/4ernyakov/takeout-2.0/) про `takeout` 
с общей схемой удаления данных из всех сервисов Яндекса;
- [вики Паспорта](https://wiki.yandex-team.ru/users/yakushevsky/takeoutrequirements/) с описанием API удаления.


## Решение
Можно предложить сервисам менять статус данных в базе самостоятельно для своего сервиса. 
Делать это будет нужно в ручке удаления.

Для уже реализованных ручек в подключенных сервисах надо будет добавить проставление статуса данных.
Для сервисов с синхронным удалением можно оставить удаление синхронным, но статус данных проставлять всё равно.

В ручке получения статуса данных в сервисе `takeout` проверять статус по сервисам и мержить со статусом категории.
Ручку `/status` подключенных сервисов стоит вызывать, только если в базе статус данных этого сервиса не найден.
Обычно такая ситуация будет возникать только при первом запросе Паспорта в наши сервисы, 
когда `takeout` ещё не хранит статусы, поэтому у каждого сервиса придётся спросить, хранит ли он данные.

## Часть 1. Асинхронное удаление.

### Изменения в ручках удаления подключенных сервисов
В ручках сервисов `/v1/takeout/delete/` нужно проставлять статус данных. 
Делать это нужно вызовом новой ручки `/takeout/set_data_status`.

### Изменения в STQ сервиса `takeout`
Записываем только время начала удаления и зовём ручку удаления. 
Ошибки сохраняем, если есть. Статус, что данные удалены, должен проставить реализующий ручку сервис.

### Изменения в базе `taxi_takeout`
Добавим в таблицу `deletions` новое поле `service`.
Сервисы, сохраняющие статус для своих данных, будут его заполнять. 
Для записей, сделанных из сервиса `takeout` для всей категории данных, поле будет NULL.

### Изменения в ручке status сервиса `takeout`
Будем искать в базе `taxi_takeout` все записи для категории данных и мержить записи от сервисов для составления ответа. 
Если какой-то сервис ещё удаляет данные, для всей категории вернём `delete_in_progress` и запрашивать статус по этой категории не будем.
Ручки `/v1/takeout/status/` подключенных сервисов будем звать только для тех сервисов, 
для которых данных в базе нет.

### Ручка сохранения статуса в базе
Сервис, реализующий ручку удаления, сам запишет в базу, что он удалил данные, 
или что удаление завершилось с ошибкой.

Для этого добавим в сервис `takeout` ручку `/takeout/set_data_status`:
```
/takeout/set_data_status:
    post:
        operationId: setDataStatus
        description: сохранение статуса данных сервиса по категории
        parameters:
          - in: body
            name: request
            description: тело запроса
            required: true
            schema:
                $ref: 'taxi-takeout/definitions.yaml#/definitions/SetDataStatusRequest'
        responses:
            '200':
                description: OK

SetDataStatusRequest:
    type: object
    additionalProperties: false
    required:
      - yandex_uid
      - category_id
      - state
      - service
    properties:
        yandex_uid:
            description: uid пользователя
            type: string
        category_id:
            description: id категории
            type: string
        state:
            description: состояние удаления данных
            type: string
            enum:
              - deleted
              - delete_failed
        service:
            description: название сервиса
            type: string
```

Внутри будет запрос в базу, сохраняющий состояние.

### Настройка алертов

Чтобы мониторить подвисшие удаления, можно посылать метрики на данные, которые слишком долго 
(больше 1-2 дней) находятся в статусе `deleting`. 
Статус данных проверяется при каждом вызове Паспортом ручки `/status`.
Паспорт дёргает ручку, когда пользователь заходит на страницу. 
Если посылать метрики при проверке статуса в этой ручке, 
мы пропустим те данные, по которым пользователь больше не заходил на страницу.

Поэтому можно завести крону, которая будет проверять статусы удаления по базе и посылать метрики, и на них настроить алерт.

### Повторное удаление

Когда у нас будет много подключенных сервисов + асинхронное удаление, 
может возникнуть проблема, что таска сервиса `takeout` на удаление будет переставляться много раз, 
и для каких-то уже удалившихся данных вызовутся ручки удаления. 
Тогда могут удалиться более свежие данные, которые пользователь создал за время с прошлого удаления.

Думаю, что пока можно отложить решение проблемы - до поддержки полей `to` и `from`. 
А потом продумать, как проверять статус удаления и не удалять то, что не требуется в этом запросе. 
Скорее всего, придётся сохранять в базу id запроса, `to` и `from`.

## Часть 2. Асинхронная выгрузка.

Можно реализовать асинхронную выгрузку по аналогии с асинхронным удалением.
Сейчас асинхронно выгружается только история поездок.
Задача решалась срочным фиксом в рамках [TAXIBACKEND-36060](https://st.yandex-team.ru/TAXIBACKEND-36060), можно изучить слинкованные тикеты.
Стоит переиспользовать созданную таблицу, но вынести решение в подключенные сервисы.
