## Соображения
Тарифы добавляются в новом сервисе, который интегрируем с сервисом аппрувов.
В тарифе храним маппинг с действий по линиям на б/ошки, страну и правила
применения ночных/праздничных надбавок.
Сервис ходит в нашу ручку с окнутыми драфтами, и мы обновляем тарифы у себя.

В конфиге храним общие интервалы расчёта, также отдельно в постгресе храним
правила для внепланового пересчёта (даты, логин, прочие условия и т п),
сразу заложимся на фронтенд для управления этими правилами.

По крону ходим в Компендиум и выгружаем оттуда рабочие смены и показатели
качества (средний CSAT и т. п.) сотрудников за период. Сохраняем у себя.

По крону ходим в OEBS и выгружаем оттуда региональные праздники сотрудников и,
если возможно, таймзоны.

По крону ходим в YT и заполняем стату действий в Крутилке за период, используя
выгрузку support-metrics. На основе актуальных тарифов классифицируем
действия на дневные/ночные/праздничные и т. п.

Формируем стату с группировкой по логину и признакам:
* работа днём
* работа ночью
* работа в праздники
* премия
При группировке учтываем признак работы в смену, если это подразумевает тариф.

Премиальную часть вычисляем на основе оценок качества из Компендиума, применив
повышающий коэффициент к дневным показателям (или к общим, нужно обсудить
с HR). Сохраняем результаты в драфт.

После ока драфта в отдельной stq-очереди выгружаем результаты вычислений
в сервис ясделки.

## Общая схема
* в отдельном сервисе две ручки для управления тарифами:
  * проверка драфта: сервис аппрувов ходит в неё с новым драфтом, ручка проверяет наличие пересечений с действующими тарифами и т. п.
  * заливка окнутого тарифа: сервис аппрувов кладёт в неё новый тариф (повторяется проверка как для драфта, тариф пишется в постгрес)
* в Компендиуме ручка загрузки саппортов и смен с регионами
* в 1С/OEBS ручка, откуда мы берём региональные праздники и, возможно, таймзоны сотрудников.
* в конфигах условия для старта расчёта: общие, с указанием периодов, регионов и т. п., и частные - для отдельного логиина и/или отдельного периода
* в новом сервисе кронтаска:
  * запускается по расписанию, проверяет в конфиге необходимость выполнять расчёт
  * ходит в ручку Компендиума, передаёт расчётный период и опционально логины, загружает список смен
  * ходит в ручку Компендиума, передаёт расчётный период и опционально логины, загружает показатели качества за период
  * ходит в 1С/OEBS за праздниками и таймзонами, загружает историю за период
  * ходит в YT и мапит реплику support-metrics на табличку действий саппортов, заполняя набор признаков: работа в смену, в ночь, в выходной/праздник и т. п
  * вычисляет статистику с группировкой по логину
  * ходит в сервис аппрувов с результатами вычислений, создаёт новый драфт
* в новом сервисе ручка для заливки окнутого драфта с расчётами, ставит в очередь stq-таску на заливку в ясделку
* в сервисе ясделки:
  * ручка принимает балком статистику б/ошек с группировкой по логину и признакам работы днём/ночью/в праздники/премия, асинхронно отдаёт статус
  * выплаты выгружаются в OEBS или в тикет + таблицу для 1С.

## Расписание
Запускаемся ежедневно, но сверяем текущую дату с конфигом, где будут указаны расчётные интервалы.
Вне расчётных интервалов обрабатываем только отдельных саппортов, если это требуется при увольнении и т. п.

Проверяем в постгресе признак внепланового пересчёта и соответствующий интервал, нужно для исправления ошибок.
Если дата совпадает с плановой, выполняем расчёт для всех.

Если регионы или смены хранятся без истории, загружаем их ежедневно в отдельной кронтаске и сохраняем историю у себя.

## Хранение
Храним тарифы, историю изменения регионов из OEBS и календарь смен из
Компендиума. В течение короткого времени храним копию лога действий саппорта
по тикетам, дополняем их признаками, на основе которых выполняем расчёт.

Примерно так:
```
CREATE TABLE piecework_tariff(
  piecework_tariff_id SERIAL PRIMARY KEY,
  line_conditions JSONB NOT NULL,
  country VARCHAR NOT NULL,
  datytime_begins TIME NOT NULL,
  datytime_ends TIME NOT NULL,
  date_from DATE NOT NULL,
  date_to DATE NOT NULL
);

CREATE TABLE pieceworker_action(
  pieceworker_action_id SERIAL PRIMARY KEY,
  login VARCHAR NOT NULL,
  ticket_id VARCHAR NOT NULL,
  action VARCHAR NOT NULL,
  created TIMESTAMP NOT NULL,
  zone VARCHAR,
  country VARCHAR,
  done_at_night BOOLEAN,
  done_at_holiday BOOLEAN
)
```

## Пожелания по API компендиума:
Хотим посылать в ручку период и получать список саппортов с оценками качества за период (средний CSAT и т. п.).

Пример запроса:
```
{
  "date_from": "2019-12-31T21:00:00Z",
  "date_to": "2020-01-15T21:00:00Z"
}
```

Ответ:
```
[
  {
    "login": "ivanov",
    "avg_csat_rate": 95.0
  },
  {
    "login": "petrov",
    "avg_csat_rate": 99.9
  },
  {
    "login": "petrov",
    "avg_csat_rate": 92.7
  }
]
```

Ещё хотим посылать в ручку период и получать список саппортов с таймстемпами начала/конца смены.
Возможно, захотим для каждого саппорта получать регионы, отпуска/больничные, а также даты трудоустройства/увольнения, если они попадают в период.

Пример запроса:
```
{
  "date_from": "2019-12-31T21:00:00Z",
  "date_to": "2020-01-15T21:00:00Z"
}
```

Ответ:
```
[
  {
    "login": "ivanov",
    "hired": "2020-01-01T21:00:00Z"
    "workshifts": [
      ["2020-01-02T07:00:00Z", "2020-01-02T015:00:00Z"],
      ["2020-01-03T07:00:00Z", "2020-01-03T015:00:00Z"],
      ...
    ],
  },
  {
    "login": "petrov",
    "workshifts": [
      ["2020-01-01T15:00:00Z", "2020-01-01T023:00:00Z"],
      ["2020-01-02T15:00:00Z", "2020-01-02T023:00:00Z"],
    ],
    "fired": "2020-01-03T21:00:00Z"
  },
  {
    "login": "petrov",
    "workshifts": [
      ["2020-01-04T15:00:00Z", "2020-01-04T023:00:00Z"],
      ["2020-01-05T15:00:00Z", "2020-01-05T023:00:00Z"],
      ["2020-01-14T15:00:00Z", "2020-01-05T023:00:00Z"],
      ...
    ],
    "vacations": [
      {
        "date_from": "2020-01-06T21:00:00Z",
        "date_to": "2020-01-13T021:00:00Z",
        "reason": "regular"
      }
    ]
  }
]
```
