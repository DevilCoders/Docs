# Задача

Необходимо заблокировать возможность переключить метод оплаты для пользователей, у которых изначально метод оплаты был cash (либо в процессе поездки был сменён на cash) и ручка определения мошенников вернула утвердительный вердикт.
Согласно [данным аналитиков из таски](https://st.yandex-team.ru/TAXIPROJECTS-1930), если бы мы не давали потенциальным мошенникам переключаться на другие типы оплаты с кэша, то мы бы сэкономили 1.04млн руб.

# Как это будет выглядеть для пользователя

Для пользователя, у которого оплата оказалась за Наличные, при этом мы его сочли фродером, в приложении исчезнет (или будет отсутствовать изначально) плашка со сменой метода оплаты. (текущий метод оплаты можно будет посмотреть в Деталях заказа в этом случае).

Если в какой-то момент пользователю из заблокированного заказа всё таки удастся запустить смену метода оплаты, то смена упадёт с ошибкой, так как ручки, которые могут сменить метод оплаты, ответят клиенту ошибкой в данном случае.

Можно было бы ещё пользователю показать какое-нибудь предупреждение, чтоб они не ломились в саппорт с вопросами "А почему нельзя сменить?"
Но мне кажется, это лишнее. Сказать пользователю напрямую, что мы подозреваем его во фроде - плохо. Просто оповестить пользователя о блокировке смены метода оплаты, по моему, тоже плохо, так мы просто сакцентируем внимание на блокировке и больше народа полезет в саппорт.
+ функционала на клиентах для этого пока нет, надо городить пуш или что-то ещё.

# Что делаем на бэкенде

Для блокировки смены метода оплаты на клиенте в totw есть уже работающий механизм. Клиент определяет, что пользователь может изменить по заказу, через массив allowed_changes. Следовательно чтобы заблокировать смену метода оплаты, будем просто удалять из этого массива объект с name: payment. Логику totw будем расширять через api-proxy.

Хотя на клиенте смена методов оплаты получается заблокирована, нужно также защитится и на бэке. Для этого в ручках changepayment и payorder также проверяем допустима ли смена метода оплаты для заказа и кидаем ошибку, если не допустима.

Проверку блочить/не блочить будем делать через ручку (точнее ручки), которые делаются тут:
https://st.yandex-team.ru/TAXIFRAUD-2025

# Проверка блочить/не блочить

Договорились, что в uantifraud будет сделано две ручки: check и get.
check - ручка, через которую будет запускаться вычисление вердикта.
get - ручка, через которую можно будет получить вердикт по order_id.

check - надо дёрнуть в начале заказа, до запросов в totw. Делать это будем в ручке orderdraft. Тайминги запроса ожидаются в пределах 50мс + соответственно, даже при ошибке влияние на orderdraft никакого не оказываем. Сюда передаём: order_id, phone_id, user_id + если есть device_id и yandex_uid.


Почему не ordercommit?
Провёл небольшое исследование https://yql.yandex-team.ru/Operations/X9x3vGim9fe3XjO_vz84T8GtF7DKMQPZnh3zDFUlwGQ= , которое показывает, что у большинства заказов разрыв между запросом в ordercommit и totw составляет от 0.05 с, а между orderdraft и totw от 0.2 с. 0.05 с антифроду не хватит, чтоб посчитать вердикт. А 0.2 с в большинстве случаев - хватит.
А что если времени где-то не хватит на расчёт?
Тогда при запросе в get будет установлен дефолтный вердикт для заказа, а расчёт оборвётся.

get - будем дёргать из totw, payorder и changepayment, когда надо выяснить вердикт по смене метода оплаты. В totw ответ будем кэшировать на первой итерации поллинга через api-cache, чтоб не перегружать ручку. Здесь тайминги ожидаются в пределах 10мс + сетевые флапы, скорость totw ухудшится не должна. Сюда передаём только order_id

# api-proxy и легаси

orderdraft, changepayment, payorder - не завёрнуты в api-proxy. Соответственно есть два варианта - сделать всё же небольшые ПРы в backend-cpp, либо завернуть ручки в api-proxy. Попытаюсь оценить время на оба варианта. Соответственно дальше будет вопрос, на сколько мы готовы потратить на это время сейчас.

# Что делать в случае неполадок?

В случае, если по каким-то причинам ручка проверки будет недоступна, то по умолчанию считаем, что оплату блокировать не нужно. Тогда в самом худшем случае просто не будет блокироваться смена метода оплаты для фродеров. Считаю такой вариант приемлимым.

В случае, если потеряется только часть запросов к ручке, то у кого-то из фродеров "мигнёт" возможность сменить метод оплаты. Это должно происходить крайне редко и городить из-за этого усложнение смысла также не имеет.

# Про эксперимент и выкатку

Фича будет закрыта экспериментом. Проверка эксперимента будет осуществляться в ручках orderdraft, taxiontheway, payorder и changepayment, чтобы не делать лишних запросов в новые ручки.

Эксперимент будет служить для запуска только на часть пользователей, а также как рубильник для фичи.

Запуск фичи будет производиться после выкатки всех частей через включение эксперимента.

# О метриках

Будем мониторить количество заказов: по которым был запрещающий вердикт, на которые был разрешающий вердикт, для которых вердикт вычислить не удалось.
Алерты навешу на слишком большое число незавершённых расчётов, на слишком большое количество запрещающих вердиктов. (возможно, удасться сделать умную проверку, и мониторить процент таких заказов, если нет то вычислю какое-то критическое значение для текущего количества заказов в ед. времени)

+ писать в лог строчку о вердикте с метками: order_id, user_id, user_phone_id.

# Задачи и сроки

0. (опционально) Завернуть ручки orderdraft, payorder и changepayment в api-proxy;
1. Добавить запрос в ручку check из orderdraft;
2. Добавить запрос в ручку get из totw + логику блокировки;
3. Добавить запрос в ручку get из changepayment + логику блокировки;
4. Добавить запрос в ручку get из payorder + логику блокировки;
5. Раскатка + проверка, что ничего не сломано.

Если заворачивать в api-proxy это приблизительно 2 недели;
Если не заворачивать то около 1.5 недель.

# Вопросы, которые прояснил в процессе

А если заказов у пользователя больше одного?
В этом случае клиент отдельно опрашивает по каждому totw и рисует отдельные карточки. Так что можно не рассматирвать отдельно этот случай.

Что делать, если блокируемый заказ в стране, где оплата за кэш невозможна?
Предполагаю, что если удалось начать заказ за кэш или переключить на кэш, то оплата за кэш в этой стране возможна.

Во всех ли клиентах работает логика с allowed_changes?
Да, во всех. Уточнил про ios/android uber/yandex
