# Какие проблемы решаем
1) Каждый потребитель пользуется int-api немного по-разному - лапшичный код.
2) Код живет в backend-cpp, что вызывает проблемы с нагрузкой и с написанием нового кода.
3) В ручках int-api не ведется учет потребителей, что не позволяет квотировать ресурсы, считать статистики, дебажить etc. В некоторых местах потребители идентифицируется по application, в некоторых все еще по sourceId, в некоторых не идентифицируются.
4) Нет единой вики по интеграциям и их учету, осложняет новые интеграции и плодит дублирование.

# Список потребителей
1) КЦ
2) ППЯ
3) Турбоаппы
4) Веб-сайт
5) Карты
6) Доставка
7) Диспа/Fleet
8) Алиса
9) Агентская схема Гепард
10) Корпы
11) **Кто-то еще?**

# Авторизационные прокси
1) ya-authproxy - авторизационая прокси, тут выполняется логика связанная с проверкой авторизации пользователя. Получение различных идентификаторов пользователя (yandex_uid, user_id, phone_id).
2) int-authproxy - внутренняя прокся, для Server-to-Server взаимодействия, за ней только одна ручка для ППЯ (zerosuggest).
3) Кц-прокся
4) Fleet-прокся
5) Диспа?
6) **Какие еще? Коллцентр, newbie и другие**

# Концепция распила
Распил int-api сейчас и в будущем должен опираться и помогать распилу протокола. Их отдельное существование вызывает дублирование логики (речь не только про ручки в backend-cpp, а про ручки цикла заказа в целом). 

Общая концепция распила по каждой ручке:
![](https://jing.yandex-team.ru/files/iv-ivan/Снимок%20экрана%202021-11-11%20в%2012.13.22.png)

- Application становится общеиспользуемой штукой - для разных app'ов будет включаться разная логика над core-логикой. Поэтому парсинг application уедет на авторизационные прокси (вроде уже есть), application также будет доступен в контексте запроса и будет логироваться в Request в каждом сервисе - тут пропатчим общий код во всех репозиториях. Yandex.Go (протокол) в этой концепции - одно из application (самое важное).
- Ручки, не нужные для цикла заказа, будут жить более менее обособленно и являться скорее плюшками. Это, например, /newbie.
- Будет собрана единая вики "Как сделать базовую интеграцию с Такси и какие плюшки есть"

Это светлое будущее, к которому можно прийти только итеративно. Давайте рассмотрим первую итерацию.

# Список ручек и планы по ним
Составлен по запросам к кластеру int-api + некоторые ручки уже вынесены оттуда, просто помним про них.

## Общее
Как было предложено выше:
- парсинг Application на авторизационных проксях, дальше кладем в Header (вроде уже есть, надо чекнуть)
- добавляем Application в контекст запроса, в логи Request
- Во всех ручках int_api надо уйти от source_id в пользу Application (Алиса?)

Также надо завести вики, как единую точку входа для всех интеграций. На ней описано, как завести ссовсем простую интеграцию с Такси, какие уже есть, какие есть ручки-плюшки, какие есть авториазционные прокси. Ссылки на дэшики по интеграциям и тд..

## /startup
Первая ручка куда ходим, тут проверяем авторизацию, получаем активные заказы, подписываем пользователя на пуши. Тут есть лишняя логики, которая по факту не нужна туроаппу (что-то связанное с лавкой и едой). Скорей всего для реализации White Label'ов потребуется дополнять эту ручку (например для управления темой, цветами аппа)

Ручка описана в api-proxy, ходит в следующие ресурсы:
- zalogin (авторизация)
- order-core (активные заказы)
- antifraud (antifraud-startup-is-spammer какая-то проверка антифрода)
- protocol-launch (не обязательная ручка, уже все разнесено в другие ресурсы)
- superapp.eda (для турбоаппа такси вообще не нужна)
- ucommunications (подписываем пользователя на пуши)

Что сделать:
- Убрать лишние источники, которые не нужны некоторым аппам (турбоаппам). Возможно - через создание новой ручки или будущую модульность в api-proxy (?)
- Выпилить protocol-launch из ручки

## /profile
Ручкой пользуется КЦ (еще Fleet, возможно логистика) - она создает пользователя user_id по номеру телефона, если надо, и отдает инфу о пользователе по телефону, дергается в начале флоу кц, нужно уточнить
Кто еще использует?

Что сделать:
По коду кажется сильно дублирует startup. Нужно перейти на api-proxy, подумать про объединение со startup (как минимум - нужно построение из тех же кирпичиков)

## /suggest
Данная ручка используется из турбоаппов лавки/еды/такси. Через api-proxy настроено проксирование в int-api, без какой-либо дополнительной обработки запроса/ответа. Ручка доступна без авторизации.

Что сделать:
- Ходить сразу же в сервис персаджест, выпилить int-api в этой цепочке. Тикет: TAXIBACKEND-29772

Все саджесты (per/zero etc.) должны стать коробочным решением SuggestAsAService, и лежать вне int-api. Потому что заказ можно делать и по координатам + они хорошо отделимы + есть группа, которая это сможет поддерживать

## /paymentmethods
Получение доступных способов оплаты. Способы оплаты получаются из разных сервисов, пока что есть фолбэк на ручку int-api, когда переключим все запросы на новую логику, можно будет его выпилить.

Что сделать:
- Ручка вынесена в api-proxy, но в бэк int-api все еще идут редкие запросы OPTIONS (меньше одного в минуту). Надо выпилить ресурс
- Подумать, нельзя ли выделить общую часть с другими paymentmethods ручками (тут тоже нужна будет модульность в api-proxy?)

## /estimate
Большая ручка для вычисления стоимости поездки, расчета eta, выписывание оффера. Пока что сложно выносится куда-то, нужно детальней погружаться.

Что сделать:
- Синк с Лешей Быковым, нужно распиливать по концепции вместе с routestats

## /orders/draft, /orders/commit
Ручки для создания и подтверждения заказа. Аналогичны протокольным ручкам.

Что сделать:
- Объединить с протокольными по коду - сейчас много дублирования - выделив core и часто меняющиеся места. Из-за дублирование возникли сложности, например, с запретом кроссграничных поездок - тупо забыли про int-api.

<details> 
  <summary>orders/draft - различия по коду и ActionItems </summary>

| int-api        | similar code   | protocol  |
| ----------- |-----------| -----|
|  |  | NotifyAntifraud |
|  | CreateDraft |  |
|  |  | VerticalsLogToYT |

Ручки почти объединины по коду, отличаются минимально:
1) Уточнить, почему нет антифрода в int-api и нужен ли он там. Если не нужен - сделать общий класс с возможностью отключать антифрод, заюзать его.
2) Закопать VerticalsLogToYT, им никто не пользуется.
3) Объединить код.
</details>

<details> 
  <summary>orders/commit - различия по коду и ActionItems </summary>

| int-api        | similar code   | protocol  |
| ----------- |-----------| -----|
| GetUserLegacy |  | GetUser |
| order |  | order_proc |
|  |  | order_tariff |
|  |  | user_exps |
| AgentChecks |  |  |
|  |  | if (state == Done) |
|  | CargoChecks |  |
|  | CrossborderChecks |  |
|  |  | NotifyAntifraud |
| IsSpammerBad |  | IsSpammerBetter |
| CheckLimitsBad |  | CheckLimitsBetter |
|  |  | CheckRestrictions |
|  |  | CheckAntifraud |
|  | SupportCommit |  |
|  |  | CreatePin |
| CommitBad |  | CommitBetter |

В ручках сильно задублирована логика, до int-api не доехало много улучшений:
1) Исследовать, что из order нужно в int-api, почему не order_proc через order-core?
2) Все плохое привести в соответсие с протоколом, посчитать статистику и добавить проверку "if (state == Done)".
3) Уточнить, почему нет антифрода в int-api и нужен ли он там. Если не нужен - сделать общий класс с возможностью отключать антифрод, заюзать его.
4) Уточнить, почему нет CreatePin в int-api и нужен ли он там. Если не нужен - сделать возможность отключать пин.
5) Объединить код. Единственное различие - наличие доп. проверок, типа агентской схемы. Допилить для такого включаемые/отключаемые плагины (подумать, как - через регистрацию плагинов, но статически. Или мб динамически?).
</details>

## /orders/search
Ручка аналогичная totw'у (taxiontheway). Возвращает статус по активным заказам пользователя.

Что сделать:
- Перейти на использование ручки из order-core (order-info) для получения базовой информации о заказе. Это пригодится потом для totw
- Для получения новых данных использовать сервис order-parts (?)
- По коду - выделить более маленькие, чем заказы, общие места с totw (инфа о водители), выделить их по коду, затем выносить в микросервисы.

Нужна отдельная проработка.

## /orders/cancel
Ручка для отмены заказа, в отличие от Яндекс Go, тут используется отдельная ручка для этого, там используется totw.

Что сделать:
- Отказаться от этой ручки - собрать аналог на api-proxy. Логика отмены заказа уже реализована в order-core. Цену платной отмены можно получать из сервиса прайсинга. В будущем поможет распилу totw.

## /changepayment
Ручка для изменения способа оплаты во время поездки. Запрос проксируется в протокольный обработчик - будет распиливаться вмести с ним.

Что сделать:
- Объединить с протокольными по коду, сейчас есть дублирование. Доработки в ручку при этом очень редки, она уже core по сути.

<details> 
  <summary>changepayment - различия по коду и ActionItems </summary>

| int-api        | similar code   | protocol  |
| ----------- |-----------| -----|
| user_id=ParseParams("user_id") |  | user_id=ParseParams("id") |
| GetYandexUidByAppOrSource |  | GetYandexUid |
|  | HandleInternal |  |

1) Сделать эквивалентную апишку (мб так - фоллбэк с user_id на id или наоборот)
2) Сделать одинаковую логику парсинга и получения yandex_uid (YandexGo - главный апп, но тоже апп)
3) Выпилить sourceId.
4) Объединить по коду.
</details>

## newbie
Ходим только из ППЯ (через бэк ППЯ), для того что бы узнать новый ли это пользователь или нет. Смотрим по uid. Для новых пользователей хотим показывать бэйджик со скидкой.

Что сделать:
- Добавить на вики.

# Пока не трогаем
## /changes
Ручка для проверки статуса изменения (для ручек changedestinations, changepayment). Запрос проксируется в протокольный обработчик - будет распиливаться вмести с ним.

Что сделать:
- Пока ничего. Будет распиливаться вместе с протоколом.

## /zoneinfo
Получение информации о зоне (тарифы, иконки, куча разной инфы). Обычный zoneinfo запрос уходит в int-api от туда проксируется в протокольный обработчик - будет распиливаться вместе с протоколом.

Что сделать:
- Пока ничего. Будет распиливаться вместе с протоколом.

## /changedestinations
Ручка для изменения точки Б во время поездки. Запрос проксируется в протокольный обработчик - будет распиливаться вместе с ним.

Что сделать:
- Пока ничего. Будет распиливаться вместе с протоколом.

## /zonaltariffdescription
## /nearestzone
## /changeaction

Что сделать:
- Пока ничего. Будет распиливаться вместе с протоколом.
