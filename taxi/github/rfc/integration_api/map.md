## Бизнесовая задача

### Описание

Предоставить коллегам из карт/ППЯ API для заказа Такси через приложение/сайт.
ППЯ делает со своей стороны web-view, которое будет ходить в наше API.
Делаем максимально абстрактно, что бы была возможность подключать и другие источники заказов (Турбоапп из ППЯ, наш сайт)

### Гипотеза

Заказ такси из приложения Я.Карт/ППЯ без необходимости установки приложения Такси даст дополнительные заказы.

### Дизайн

_%todo%_

### Продуктовые ограничения

1. Не поддерживаем предзаказ

## Архитектура

### Высокоуровневая архитектура

Позволяем получать цену и делать заказ через int-api из приложения карт/ППЯ.
Прикручиваем авторизацию пользователя в int-api с помощью PA

_%todo%_

### Влияние на цикл заказа

_%todo%_

### Компоненты

#### Сервис `int-api`

Сервис используется для создания заказов из КК, КЦ, алисы и других источников.
Дорабатываем сервис, что бы можно было авторизовать пользователей. 

#### Новый инстанс сервиса `passenger-authorizer`

Сервис используется для проверки авторизации пользователей.
Заводим новый инстанс, что бы разделить трафик основного мобильного приложения и подключаемых источников. 

#### Сервис `api-proxy`

Используется для заполнения нужных параметров запроса (yandex_uid, personal_phone_id) полученных из заголовков PA.

### API

_%todo%_

### Нагрузка

В данный момент, для получения информации о цене Карты ходят в ручки сервиса taxi-routeinfo.
мобильное приложение ходит в ручку trip_info, а веб в taxi_info.

Суммарная нагрузка на эти ручки: ~600 rps, 98 prc - ~300ms

### Внешние сервисы

_%todo%_

### Клиентская логика

_%todo%_

### Отказоустойчивость

#### Фолбэки

_%todo%_

#### Ограничение нагрузки

##### Правильное решение

Нужно уметь отрубать карты/ППЯ, в случае проблем с сервисом int-api, что бы не нарушать работу основных источников (КК, КЦ)

Команда инфраструктуры должна взять на себя внедрение и разработку балансера/прокси/механизма через который можно будет настроить квоты на кол-во запросов.
Нужно иметь возможность отрубать трафик отдельно для мобильного приложения и web версии Карт.

Делается тут: [TAXIINFRA-1327](https://st.yandex-team.ru/TAXIINFRA-1327)

Вероятней всего будет возможность регулировать запросы между сервисами по id TVM,
для ограничения отдельно трафика для мобильного приложения и web версии видимо придется заводить различные TVM id.

##### Костыль

Сроки разработки общего решения не известны. Вероятней всего разработка и внедрение данного решения займет продолжительное время 3-6 мес. На первое время делам костыль.
Обсудил с Ильей Шаровым, заводим новый кластер и настраиваем rate limit с помощью nginx конфига [TAXIBACKEND-26799](https://st.yandex-team.ru/TAXIBACKEND-26799)

### Мониторинги, алерты, бизнесовые графики, логи

_%todo%_

### Технические ограничения


### Этапы

#### Этап 0 (проверка гипотезы)

Экспериментом на низкий процент пользователей меняем логику кнопки "Заказать" (эксперимент на стороне карт).
Три эксперимента для тех, у кого нет приложения такси:

* Редирект в стор (как сейчас и есть)
* Отправляем в колл-центр — Попап «Позвонить в колл-центр»
* Редирект на сайт


#### Этап 1

1. Цены в Картах и Такси должны совпадать
2. Показываем сурж

##### Разработка
**Всю логику делаем поверх int-api. Для карт завели 2 source_id: _maps_web_ и _maps_app_ (возможно достаточно и одного)**

Для получения списков тарифов и доступных требований нужно сходить в ручки: [/nearestzone](https://pages.github.yandex-team.ru/taxi/schemas/Taxi_Documentation/Backend-cpp%20services/protocol/integration-api/nearestzone/#protocol-integration-api-nearestzone) и [zoneinfo](https://pages.github.yandex-team.ru/taxi/schemas/Taxi_Documentation/Backend-cpp%20services/protocol/integration-api/zoneinfo/#protocol-integration-api-zoneinfo)

> Ручку nearestzone можно пропустить, ручка zoneinfo принимает либо zone_name, либо point. 
> Таким образом если карты не планируют использовать кэширование результата ручки zoneinfo (по имени зоны) можно исключить поход в ручку nearestzone.

Далее идем в ручку [/orders/estimate](https://pages.github.yandex-team.ru/taxi/schemas/Taxi_Documentation/Backend-cpp%20services/protocol/integration-api/orders_estimate/#protocol-integration-api-orders_estimate)
как и колдун. 

> Нужно добавить source_id в конфиг [INTEGRATION_API_PHONELESS_APPS](https://tariff-editor.taxi.yandex-team.ru/dev/configs/edit/INTEGRATION_API_PHONELESS_APPS)
> что бы иметь возможность получать цену без номера телефона.

0. nearestzone (по точке и user_id, возвращает зону)
1. zoneinfo (по зоне/точке, возвращает инфу о тарифах и требованиях)
2. orders_estimate (для нужных тарифов, возвращает цену и формирует офер для выбранного тарифа)
> если в orders_estimate не передается блок user, то офер не создается

* Ручка /orders/estimate - получение информации по нескольким тарифам (сейчас только для выбранного) - [TAXIBACKEND-26698](https://st.yandex-team.ru/TAXIBACKEND-26698) - 4д.
* Ручка /orders/estimate - сделать так что бы цены были такие же как и в приложении (ручка routestats)
> На данный момент идет запуск/дороботка нового прайсинга. После чего ручки будут возвращать одинаковую цену 

#### Этап 1.2
1. Показывать цену с учётом скидки пользователя
2. Показывать скидку на такси
3. Прокидываем офер в приложение

##### Архитектура

**Пользователь не авторизован в паспорте**

Не сможет заказать такси, получить цену с учетом персональных скидок.
Авторизация пользователя в паспорте осуществляется клиентским приложение, Я.Такси никак не относится к этому процессу.
Со стороны карт показываем стандартную форму авторизации или регистрации. 

**Авторизован в паспорте**

~~_Вариант 1:_~~

Для создания пользователя имеется ручка /profile в int-api, но она принимает на вход номер телефона и yandex_uid.
И в этой ручке нет никакой проверки авторизации пользователей.
В таком случае решение получает плохим, т.к всем источникам нужно каким-то образом получить номер телефона и
uid из паспорта, проверить подтверждение номера. И нет проверки авторизации.
 
_Вариант 2:_

В такси есть сервис PA, который умеет по OAuth токену получать всю нужную информацию из паспорта самостоятельно.
Для супераппа еды и лавки, коллеги из команды Олега сделали ручку [/startup](https://tariff-editor.taxi.yandex-team.ru/control-api-proxy/endpoints/show/%2F4.0%2Fstartup) - аналог /launch,
которая по OAuth токену проверяет авторизацию пользователя и если нужно, то создаем нового пользователя такси (user_id).
Ручка /startup проксируется через PA -> AP -> 3.0/launch. Для интеграции Такси с Картами/ППЯ можно воспользоваться этой же ручкой. 

1) Отправляем запрос в [/startup](https://tariff-editor.taxi.yandex-team.ru/control-api-proxy/endpoints/show/%2F4.0%2Fstartup) для создания/проверки пользователя в Такси (user_id)
2) Получить из ответа статус: `authorization_status: authorized|unauthorized|phone_confirmation_required` и user_id в заголовке X-YaTaxi-UserId.
    * authorized: считаем что все ок, сохраняем user_id на клиенте в следующие разы ходим в /startup с заголовком X-YaTaxi-UserId: user_id
    * unauthorized | phone_confirmation_required: нужна авторизация/подтверждение телефона, данная возможность имеется в АМ. Показывается окно АМ.
после успешной авторизации/подтверждения дергаем повторно /startup. Если не удалось подтвердить, показывается ошибка из АМ (вроде должно работать из коробки) 

3) Авторизация выполнена.

Есть пара проблем:
1) В ручках int-api нет проверки авторизации (для КЦ эта проблема решается с помощью сервиса int-api-auth в py3)
2) Ручки int-api (/orders/estimate, /orders/draft, /orders/search)
требуют передачи номера телефона либо personal_phone_id. Одного user_id не достаточно.
3) Ручка /startup создает пользователя без поля source_id, а ручки int-api завязаны на это поле.

Решение.
1 и 2) Выносим int-api за PA + AP (прокидываем заголовки PA в тело запроса через AP). 
Данное решение решит проблему неавторизованных запросов и позволит использовать в ручках int-api данные полученные из заголовков PA (phone_id, yandex_uid).
Нужно заводить новый инстанс PA, конфигурировать роутинг ручек. 
Можно было бы использовать инстанс taxi_tc, но тогда возникает проблема - что мы не контролируем трафик от внешних источников,
в худшем случаем это может положить все такси.
Добавляем проверку source_id на уровне api-proxy, пропускаем запросы только с разрешенными source_id (white list).
3) Частичный уход от source_id в пользу бренда/приложения (подробности в [тикете](https://st.yandex-team.ru/TAXIBACKEND-26852) )

![схема](https://jing.yandex-team.ru/files/e-usov/map.png "Схема")

~~_Вариант 3 (быстрее варианта 2, но это не точно - не добавляем PA + AP):_~~ (после обсуждений это вариант отпал)

Авторизация работает по той же схеме, через ручку /startup. 
Отказываемся от внедрения PA в int-api (ручки остаются без авторизации). 
Вносим доработки в ручки int-api, что бы цикл обработки заказа, можно было проводить если передается только user_id.

В ручках по user_id получаем yandex_uid, phone_id из сервиса user-api.

Если мы хотим что бы в ручке /orders/estimate создавался оффер(после доработок), 
то в нее нужно ходить с полученным из /startup user_id.
Это значит что при построении маршрута в картах нужно ходить в ручку /startup, а уже после в /orders/estimate.

%todo%
* нужно понять заведутся ли пуши из коробки, если в ручке /startup создавать пользователя с нужными токенами
* нарисовать схему взаимодействия между сервисами/ручками

Проблемы:
1) Нет проверки авторизации в ручках int-api
2) Нужны доработки для работы только по user_id в запросах
 

**Итого:**

Делаем вариант 2.

##### Разработка

* Внедрение нового инстанса PA перед int-api (подробнее в тикете) - [TAXIBACKEND-26861](https://st.yandex-team.ru/TAXIBACKEND-26861) - 5д.
* Учет персональных скидок (плюс, мастеркард, промокоды) - [TAXIBACKEND-26778](https://st.yandex-team.ru/TAXIBACKEND-26778) - 5д. (сложно сказать, нужно более детально изучить работу скидок)
* Уход от source_id в пользу бренда/приложения (подробнее в тикете) - [TAXIBACKEND-26852](https://st.yandex-team.ru/TAXIBACKEND-26852) - 3д (mvp для новых источников)

#### Этап 2
1. Заказ Такси внутри приложения Карт

#### Этап 3
1. Добавляем возможность выбора тарифа


**Для этапов 2/3:**
Почему бы картам не использовать web-view заказа такси, которое разрабатывается для ППЯ?

### Как раскатываем

#### Раскатка этапа 1

1. Эксперимент будет настроен на стороне карт/ППЯ
2. С нашей стороны будем контролировать нагрузку, ограничиваем трафик

### Безопасность

Опасения: 
- фрод, могут начать парсить цены (не критично)
- ддос через запросы от карт (ограничиваем трафик перед int-api)
- авторизация