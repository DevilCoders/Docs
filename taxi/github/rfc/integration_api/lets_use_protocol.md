## Что хотим сделать

Цель - закопать старые ручки `int-api` в пользу тех, что использует Яндекс.Go (протокольных).

В файле `integration_api_future.md` подробно описаны проблемы `int-api` и концепция его распила. В настоящем rfc предполагаем, что фронты/клиенты будут содействовать переезду и со своей стороны поддерживать новые ручки.

## Как это хотим сделать

Общая схема перевоза ручки такая: 

1. В `ya-authproxy` пишем ручку, аналогичную ручке `passenger-authorizer` (быть может, со своими настройками, но с тем же апстримом)
2. а). Заводим ресурс в `api-proxy-critical`, имеющий тот же query, что и аналогичный ресурс протокола, но с другим сервисом - `int-api`.  
б). Ручку `api-proxy-critical` патчим аналогично [примеру](https://stackoverflow.yandex-team.ru/questions/1799)  
Здесь была [идея](https://t.me/c/1463474693/24958) избавиться от копипасты путём доработок `api-proxy`, но её не поддержали. Так что, кажется, стоит остановиться на описанном в rfc варианте.
3. Открытие ручек в `int-api`.

Т.о. обеспечиваем изолированность запросов турбоаппов (и, потенциально, других потребителей `int-api`) от протокола.

## Перевозимые ручки

Турбоаппы ходят в следующие ручки `int-api`:
* integration/orderscancel
* integration/orderscommit
* integration/orderscommit/wrapper
* integration/ordersdraft
* integration/ordersdraft/wrapper
* integration/ordersestimate
* integration/orderssearch
* v1/changedestinations
* v1/orderchat
* v1/zoneinfo  

От них и хочется избавиться в случае турбоаппов

Старые ручки мы трогать не будем. Мы поддержим на уровнях 2х проксей возможность ходить в новые ручки в `int-api` кластер. Далее перевыпустятся фронты и клиенты, натравленные в новые ручки. Встаёт вопрос: какие ресурсы изолировать?
Основной претендент - uroutestats. Есть ещё сервис zoneinfo, но пока, в отличие от uroutestats, он активно не используется для ухода от монолита.

С прицелом на светлое будущее (routestats живёт полностью вне backend-cpp) предлагаю изолировать uroutestats как критическую для ЦЗ компоненту. Zoneinfo же не трогать вообще и ходить только в протокольную ручку без uservices.

Логика выбора бекенда (`int-api`/`protocol`, `uroutestats`/`u-ia-routestats`) задаётся экспериментом (консьюмеры - `api-proxy-critical`, `uroutestats`).

Итого предполагается следующий план в порядке убывания приоритета:
1. estimate -> routestats
2. zoneinfo
3. search -> totw
4. cancel -> totw
5. draft, commit - тут, кажется, нужно прописать своё правило в `protocol-proxy` в отличие от других ручек
6. orderchat, changedestinations - аналогично

Не нужно себя обманывать - будут возникать десятки крупных и мелких проблем, даже если бек всё быстро сделает в полном объёме. Поэтому каждую ручку нужно перевозить вместе с фронтами (хотя бы один потребитель должен переезжать параллельно с беком). Потому что в ином случае очень вероятен рассинхрон или какая-нибудь несогласованность с клиентами, и переезд просто напросто заглохнет.

