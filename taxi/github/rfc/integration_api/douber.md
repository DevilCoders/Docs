# Задача
Предоставить коллегам из поиска API для заказа грузового Такси с колдунщика.
Сделать это безопасным для всех способом.

# Текущие API
Есть `Integration api` (далее int-api), изначально сделанный для коллцентра. Сейчас им пользуются:
- КЦ
- Корпы
- Алиса

Есть `protocol` (далее протокол, tc), которым пользуются:
- мобильные приложения
- вебсайт

# Требования
- колдунщик будет работать как с портальными аккаунтами так и с неавторизованными
- ходить будут с их бека на наш API

# Варианты
Обсуждали варианты:
<details>
<summary>Неподходящие варианты</summary>

## Дать доступ к int-api как есть
Сейчас пошли по этому пути (без анализа) но есть серъезный недостаток: телефон авторизуется на стороне колдунщика и передается в int-api, Такси этим процессом не управляет, и во-первых, не может доверять ему, а во-вторых, отсутствуют способы быстро закрыть этот канал в случае фрода.

## Дать доступ к протоколу
Даем доступ к протоколу, по аналогии с веб-сайтом. Недостаток: протокол это внутренний API, в котором много вещей, нужным только мобильным клиентам, и с него хочется потом переводить всех лишних потребителей на int-api. Поэтому не хочется туда подселять новых - придется потом переделывать.
Также, есть риск того, что даем дополнительный канал откуда может приходить нагрузка на протокол.

## На тест запустить колдун только на портальные акки
Антон против, но это кажется ~40-50% аудитории

## Договориться с Паспортом про фониши в вебе

## Доработать int-api, чтобы закрыть дыры в безопасности
Был вариант дать доступ к `/auth` и `/authconfirm` из протокола для авторизации телефона через нас, но эти ручки на вход требуют `user_id`, который выдают либо `/launch` из проткола либо его аналог `/profile` из int-api (причем второй - по номеру телефона, что влечет проблемы из пункта выше). Отсюда рождается необходимость добавления в int-api ручки-аналога `/launch`.
Следующая проблема: некоторые ручки в int-api (есть авторизационная прокся для КЦ но она авторизует только сотрудников Яндекса), не проверяют что `user_id` авторизован. Это надо исправить.
Еще хочется разделить нагрузку на существующий int-api и на новый, чтобы колдунщик не смог повлиять на заказы от КЦ.

## Вариант после обсуждения на встрече 11.09
1. Шаг 1. Минимальный сетап
  * Делаем второй инстанс int-api-auth для колдунов. В нём проверяется TVM вместо кук; фронтбэк серпа шлёт дату проверки номера телефона серпом, если она нас удовлетворяет, то юзер создаётся сразу авторизованным
На этом шаге наш риск — если серп выдаст большую нагрузку на создание пользователей. @a-konyshev предлагает ограничиться кластером из трех машин и рейтлимитером на nginx

2. Шаг 2. Впилить поддержку z-id
  * profile в int-api выдаёт z-id
  * делается поддержка z-id в auth/authconfirm
  * если z-id подтвержден в authconfirm, то последующий ланч обменивает z-id на полноценный [NB: теоретически этот флоу поддерживается вебом и старыми клиентами, практически надо это проверить]
</details>

---

## Доработки
### (Сделано) Этап 1 (эксперимент)
1. (Сделано) - [3d] Делаем новый `source_id` = `wizard`, а также новое приложение `wizard`. Колдунщик запускаем в `int-api`, доверяем их телефону, считаем что нагрузки большой не будет, и получаем доступ к их сервису для быстрого снятия нагрузки в случае проблем.
2. (Сделано) - [1d] Добавить новое приложение для колдунщика (https://wiki.yandex-team.ru/taxi/backend/new-application-procedure/?from=%252Ftaxi%252Fnew-application-procedure), и указать его в конфиге `PUSHLESS_APPS` чтобы приходили СМС (надо тестировать)

### Этап 1.5. Смотрим на результат эксперимента

### Этап 2 (промежуточный, но уже с авторизацией телефона на стороне Такси)
1. [2d] Дорабатываем в `int-api` ручку `/profile`:
  Если пришел запрос с `source_id`=`ХХХ` (из конфига, изначально там будет только `wizard`)
  - создаем юзера неавторизованным
  - сохраняем `personal_phone_id` в сервисе `user_api`. Ручка кажется есть: https://github.yandex-team.ru/taxi/uservices/blob/develop/services/user-api/docs/yaml/api/user_phones.yaml#L212
2. Для походов в `/auth` и `/authconfirm` используется новый кластер протокола `taxi-api-wizard`, который создается в этом тикете: https://st.yandex-team.ru/TAXIADMIN-12179

### Этап 3 (финальный)
1.  Добавить новую прокси `wizard-proxy` для колдунщика для:
  - (контроля за нагрузкой)
  - [1.5d] проверки по TVM
  - [3d] Проверять `user_id` на валидность, только для ручек процессинга заказов. Ручка в `user_api`: https://github.yandex-team.ru/taxi/uservices/blob/develop/services/user-api/docs/yaml/api/users.yaml#L22
  - [1d] проверять что переданный `personal_phone_id` соответствует сохраненному, в противном случае отказывать
  - [1d] (Завести сам сервис)
2. [3d] Добавить в `int-api` ручки `/auth` и `/authconfirm` - проксировать в протокол. Они должны:
  - авторизовывать телефон через СМС
  - заполнять флаг `Authorized` в `user_api`

## Отдельные доработки
### Пуши в чаты
1. [4d] Реализовать для source_id=wizard отправку пушей по аналогии с Алисой. 
Отправлять будем в том же формате как и для Алисы для простоты.
Сейчас это хардкод, надо расхардкодить и перевести на конфиги.

### Перевести авторизованных пользователей на авторизацию по yandex_uid вместо телефона
> не оценивалось детально
1. [?] Пофиксить баг, при котором при передаче yandex_uid могло создаться несколько записей в dbusers
2. колдунщик будет присылать yandex_uid
3. Проверять что этот yandex_uid валидный
4. Возможно, првоерят номер телефона или привязывать его к порталу. Не прорабатывалось

### Z-id для снижения кол-ва записей в БД в случае атак
> Не прорабатывался детально
1. Ручка `/v1/profile` выдает z-`user_id` для похода в `/auth`.
3. Реализовать https://st.yandex-team.ru/TAXIDATA-1356 чтобы `/auth` и `/authconfirm` работали с `z-id`.
4. Доработать новый прокси: добавлять во все запросы к int-api `personal_phone_id` для этого `user_id`
5. Дорабатываем отправку пушей. Поскольку текущее место отправки пушей - легаси, то возможно надо сделать отдельный сервис 

### Антифрод
> не прорабатывался детально
Поскольку в ручках int-api сейчас нет проверок на антифрод, а они нужны для запросов из недоверенных источников, к которым относится Колдунщик (точнее его пользователи), то, вероятно, нужно добавить проверок антифрода. Пока не прорабатывалось.


# Открытые вопросы
- Кросс-девайс. Пока не планируется, хотя и хочется.
