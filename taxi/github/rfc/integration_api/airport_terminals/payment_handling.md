## Безналичная оплата через терминал

Все корректирующие операции будут делаться по внешнему Payment API. 
Взаимодействие с платежным устройством, по сути, только при первичной операции.  
Внешнее API можно посмотреть в [partner_payment_api.yaml](./partner_payment_api.yaml)  

Новый сервис, в котором будут колбек-хендлеры и новый stq таски для взаимодействия с этим API подробнее описан в файле [new_service_for_payment_terminal_integraion.md](./new_service_for_payment_terminal_integraion.md)  

### Термины
- Reference Retrieval Number (RRN) – уникальный идентификатор
банковской транзакции

### Схема работы
1. Пользователь прикладывает карту к платёжному терминалу  
1. Терминал создаёт/обрабатывает транзакцию на заморозку необходимой суммы  
TODO вот тут подрядчики, предоставляющие терминал, предлагают сразу списывать. Вопросы к биллингу - ок ли нам с тем, что между созданием заказа и нахождением исолнителя эти деньги будут уже не у пассажира, но ещё не у водителя (видимо на каком-то счету яндекса?)  
TODO ещё один вариант - на терминале списывать и возвращать небольшую сумму для валидации карты, на наш бэкенд передавать rrn и по нему списывать только нужную сумму в конце поездки. Из плюсов - не нужно беспокоиться об отменах, списываем один раз и нужную сумму, не беспокоимся об отменах. Из минусов - на карте может быть недостаточно денег. В таких случаях в го мы начисляем долг, но тут это не имеет смысла, т.к. выписываем долг на фониш(?), долг не прорастёт в го  
1. Параметры транзакции прокидываются до турбоаппа, который отправляет нужные данные в запросе orderdraft.  
1. Отрабатывает orderdraft, RRN сохраняется в order_proc
1. Отрабатывает ordercommit
1. Исполнитель нашёлся
1. В procaas новый обработчик события assigned ставит stq таску, которая ходит в Payment API и списывает замороженную на шаге 1. сумму (TODO Или же списание происходит на стороне терминала? Мы же должны чек распечатать? Если на стороне бэка происходит как передавать данные нужные для печати чека?)  
1. Таска сообщает биллингу, что заказ оплачен (TODO обсудить с биллингом как это будет выглядеть, какие данные им нужны)
1. Биллинг производит необходимые со своей стороны действия (выплаты парку/партнёру?)
1. В это время пользователь забирает в терминале чек, по QR коду открывает отслеживание заказа в шарилке и идёт садиться в такси
1. Садится, едет по маршруту
1. Приезжает  

Печать чека  
TODO в конце ли происходит? Если не в конце что делать с печатью данных водителя, он может отменить заказ. Перепечатывать чек?
TODO возможны проблемы с биллингом, не можем списать деньги без исполнителя, может ли терминал отложить списание до того, как мы найдём исполнителя? Как это сделать?

### Но могут быть проблемы  

#### На шаге 2. после заморозки всё ломается, не можем сделать orderdraft  
TODO а что делать? Возможно замороженная сумма сама оттает без подтверждения списания после N минут?

#### На шаге 3. orderdraft фейлит 5xx  
Ретраим N раз, после неудачи приложение на стойке просит терминал отменить заморозку денег, высвечиваем окошко "сервис недоступен"

#### На шаге 5. ordercommit фейлит 5xx  
Аналогично предыдущему

#### На шаге 6. не нашёлся исполнитель  
Заказ уже создан, ставим в procaas STQ таску, которая отменит фриз денег  

#### Между шагом 6. и шагом 11. водитель отменяет поездку/заказ завершается ещё по каким-то причинам, не зависящим от пользователя
Пользователь ещё не сел. Ставим в procaas STQ таску, которая отменит снятие (не фриз) денег. Тут нужно корректно обрабатывать возможные гонки (заказ отменился сразу после нахождения водителя, ещё не пришёл запрос на списание, но уже пришёл запрос на его отмену)  
Возможно стоит дополнительно отправить СМСку пользователю о том, что заказ завершён  

#### На шаге 11. пользователь долго шёл, включилось платное ожидание  
Досписываем необходимую сумму.  
TODO тут нужно выяснить откуда брать сумму досписания  

#### На шаге 11. пользователь менят маршрут
TODO во-первых подумать как. Просит водителя? Или в шарилке поездки уже будет эта функциональность?  
Досписываем необходимую сумму.  
TODO тут нужно выяснить откуда брать сумму досписания  
TODO а если нужно списать меньшую сумму чем изначально?  


### Доработки  
1. В orderdraft  
В поле [payment](https://github.yandex-team.ru/taxi/backend-cpp/blob/99a587c7113ef589711e33716c31a27c872a6d52/protocol/docs/integration-api/yaml/orders_draft.yaml#L237) проставялется type: payment_terminal payment_method_id: {RRN}  
1. В procaas (и не только?) ставить необходимые stq задачи  
TODO подробнее расписать все постановки  
1. Сами stq задачи описаны в [new_service_for_payment_terminal_integraion.md](./new_service_for_payment_terminal_integraion.md)


