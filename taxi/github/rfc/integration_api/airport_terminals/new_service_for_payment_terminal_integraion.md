## Новый сервис для взаимодействия с внешним API проведения платежей  

sky-technologies-integration (TODO более общее решение? Что если в разных городах/странах будут разные подрядчики?)  

API - [partner_payment_api.yaml](./partner_payment_api.yaml)

Ниже описаны его необходимые компоненты

### Общее
TODO Колбеки будут вызываться снаружи, соответственно нужна какая-то прокси  

Авторизация (из документации API)  
Для проведения платежей необходимо заранее сгенерировать ECDSA пару ключей (рекомендуемая кривая P-521) и передать публичный ключ, которые будет использован для проверки подписи, высчитываемой по алгоритму ECDSA with SHA512.  
Также заранее можно предоставить адрес, на который будут отправляться callback-запросы с данными о сохранённой карте.  
Для операций отмены платжей должна быть сгенерированная отдельная пара и передан отдельный ключ.  
TODO какая у нас авторизация для нитеграции с внешними сервисами?    

Данные:
- merchant_id должен храниться в конфиге TODO где взять?

### База данных, хранящая запросы во внешнее API и их статусы  
Не нужна. Для контроля того, что нужная операция выполнилась, можно после успешного выполнения stq таски решедулить её на n минут вперёд. При начале работы таска проверяет статус операции, при необходимости повторяет запрос и опять решедулит себя.  
TODO Вот тут уточнить у партнёра, возможно они гарантируют, что после успешных вызовов их ручек, нужные операции у них будут выполнены и колбеки вызываны  

### stq для досписания  
sky_technologies_integration_process_extra_payment  
Ставится из procaas, в ситуациях, когда цена поездки увеличивается  
Использует ручки API initSession и completeMerchantAcquiring  

Необходимые данные:
- amount - сумма досписания
- currency - валюта заказа
- paymentCompletedCallbackUrl - [см.](#колбек-на-успешную-оплату-или-отмену)

### stq для отмены оплаты  
sky_technologies_integration_process_payment_reversal  
Ставится из procaas, в ситуациях, когда мы уже списали деньги, но заказ по каким-то причинам отменился  
Использует ручки API initSession и processPaymentReversal  

Необходимые данные:
- amount - сумма отмены, в данном случае == стоимость заказа
- currency - валюта заказа
- paymentCompletedCallbackUrl - [см.](#колбек-на-успешную-оплату-или-отмену)


### stq для отмены оплаты  
Не нужна отдельная, можно вызвать sky_technologies_integration_process_payment_reversal с amount == сумме, которую нужно вернуть

### Колбек на успешную оплату или отмену
v1/on_payment_completed
Получает request_id, использует ручки initSession и paymentStatus для проверки статуса оплаты/отмены.  
Если ошибка - ставит stq на ретрай  
Если успех - ставит stq на обработку успеха  
### stq для обработки успешной оплаты или отмены
sky_technologies_integration_handle_payment_completed  
Для отмены не делает ничего? (Логи/метрики?)  
Для досписания ходит в биллинг, запускает их внутренние процессы TODO узнать у биллинга какие  
