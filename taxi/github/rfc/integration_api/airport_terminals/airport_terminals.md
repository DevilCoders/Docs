# Железные терминалы в аэропортах (и не только)

Тикет: https://st.yandex-team.ru/TAXIPROJECTS-2808  
В клиентском продукте разрабатываем железные терминалы для вызова такси. Терминалы будут стоять в аэропортах, ТЦ, жд/автовокзалах и позволять заказать такси без использования приложения.

Цель проекта – разработать self-service решение заказа такси, которое улучшит пользовательский опыт и вырастит поездки новичков за счет новых точек входа (аэропорты, вокзалы, остановки, ТЦ)

На бэкенде будут использоваться ручки int-api, ниже описан общий флоу заказа и необходимые доработки  

Детали по реализации основынх частей подробно описаны в соседних файлах:
- авторизация - [authorization.md](./authorization.md)
- безналичаная оплата - [payment_handling.md](./payment_handling.md)

## Флоу заказа
figma - https://www.figma.com/file/7dRX7xDyTnGUS72PAuPvfL/Taxi-terminal?node-id=442%3A88882


1. Главный экран  

Вызов инициализационных ручек zoneinfo, nearestdrivers, etc.

![image](./images/1.png)

2. Ввод адреса

Ручка suggest

![image](images/2.png)

3. Экран саммари, карточка тарифа

Ручка orders/estimate

![image](images/3.png)

4. Выбор платной дороги

В int-api пока что не реализован, в MVP не нужен  
Варианты реализации:
- либо происходит переход estimate на routestats и мы пользуемся routestats, в котором для платных дорог всё готово (https://st.yandex-team.ru/TAXIBACKEND-38568)
- либо дорабатываем estimate, чтобы в нём были данные необходимые для реализации выбора платной дороги

![image](images/4.png)

5. Подтверждение телефона, авторизация

Нужно авторизоваться для создания заказа на телефон пользователя, варианты рассмотрены подробнее в [authorization.md](./authorization.md)  

После авторизации будет перезапрос estimate, не можем связать навторизованный оффер с авторизованным пользователем, возможно изменение цен. Продуктово мы с этим ОК, как минимум на время МВП  

![image](images/5.png)

6. Оплата картой у терминала

При оплате картой происходит взаимодействие нашего приложения, установленного на стойке, с платёжным терминалом. В результате на карте пользователя замораживается сумма заказа и терминал возвращает идентификатор транзакции.  
Подробнее процесс оплаты рассмотрен в [payment_handling.md](./payment_handling.md)  

![image](images/6.png)

7. Результат оплаты

При неуспешной оплате предлагаем попробовать ещё раз  
При успешной оплате делаем orderdraft, в запросе передаём идентификатор транзакции в методе оплаты  

После оплаты многое может пойти не так (не получилось сделать заказ, отмена заказа, не нашёлся водитель).  
Все корректирующие операции будут делаться по внешнему API. 
Взаимодействие с платежным устройством, по сути, только при первичной операции.  
Подробнее процесс оплаты рассмотрен в [payment_handling.md](./payment_handling.md)  

![image](images/7.png)

8. Заказ

После успешной оплаты картой (или при оплате наличными), ручки orderdraft, ordercommit


9. Экран поиска

После успешного создания заказа, ручка orders/search

![image](images/8.png)

10. Печать чека

Чек + QR код с шарилкой поездки  
Подробнее процесс оплаты (в том числе печать чека) рассмотрен в [payment_handling.md](./payment_handling.md)  


![image](images/receipt_hold.png) ![image](images/receipt_clear.png)

## Ожидаемыая нагрузка
В МВП планируется порядка дюжины устройств. При этом ожидаемая максимальная нагрузка на основные ручки флоу заказа - <1rps, на поллинг-ручки <10rps  

## Чекпоинты разработки
1. Настроены авторизация, прокси и все нужные для заказа ручки в нём. Можно сделать заказ по кэшу
1. Сделаны минимальные доработки необходимые для корректной работы нового способа оплаты - платёжный терминал. Можно сделать заказ с оплатой картой в платёжном терминале без доплат/отмен
1. Сделаны доработки в новом сервисе, который взаимодействует с партнёрским API, в procaas ставятся необходимые stq таски. Можно сделать заказ, отменить/поменять маршрут, при этом корректно возвращаются/досписываются деньги

## Оценка
TODO
1. Заведение авторизационной прокси - 2w
1. Доработки для авторизации пользователя - 1-2w  
1. Доработки в биллинге - ???mo

После MVP
1. Доработки для платных дорог - ???d
