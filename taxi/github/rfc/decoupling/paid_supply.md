## Платная подача
### Проработка при условии расчета одной цены ПП по водительскому тарифу
Пока решили так. Идея в том, чтобы дать работать ПП и декаплинг независимо друг от друга и в конце учесть цену ПП для водителя и пассажира.

#### Routestats
1. Делаем конфиг PAID_SUPPLY_FOR_DECOUPLING и заменяем текущий запрет ПП при декаплинге на проверку конфига.
2. Выносим из RoutestatsCalculator в price_calculations поля rounded_paid_supply_prices_ и rounded_original_paid_supply_prices_. Они считаются один раз, поэтому так можно сделать. А нам это позволит оторвать калькулятор, в который декаплинг положит клиентскую цену, от расчетов ПП, которые по водительской. В расчете итоговой цены для ответа ручки будем суммировать клиентскую цену из калькулятора и ПП из price_calculations.
3. И все, кажется, точек соприкосновения больше нет.

#### OrderCanceller
1. Прибавляем paid_supply_with_extra_paid_cancel_price_ к ценам отмены и для водителя и для пассажира. Логику конфига paid_supply_paid_cancel_with_minimal_in_waiting тоже берем.

#### Requestconfirm на завершение
1. Повторить логику отмены в случае отмены.
2. Так как мы не берем значение из extra при декаплинге, то при фиксе самим прибавить цену ПП к цене пассажира и водителя. А при таксометре - таксометр это сделает за нас.
3. Корректировку цен диспетчером мы тоже не поддерживаем, так что этот кейс тоже не попадает.

### Проработка при условии незасимого расчета цен для водителя и пассажира
#### Routestats
1. Не лезем в определение платной подачи, она сама определяет как включиться и считает цену.
Сохраняем tracker_resp.paid_supply_info в RoutestatsState/Data и отдаем в ApplyPLugins. Логику внутри GetEstimatedTimesWithAlternatives стараемся не трогать.
2. В плагине декаплинга два раза считаем цену через calculator.FetchPaidSupplyPrices.
3. В price_calculations пишем рассчитанную для пользователя цену ПП, и обе сохраняем в данных декаплинга. Чтобы иметь возможность прибавить эти цены к стоимостям поездки, если платная подача все-таки случится.
4. В CalcPaidCancelInDriving учимся декаплить цены отмены в драйвинге. Изначально хотели не делать для упрощения разработки. Но 1: не факт, что мы вообще имеем право не делать этого. Но 2: нормально избежать может оказаться не проще, чем сделать.

#### Setcar
1. Сеткар для декаплинга уже умеет отдавать два набора тарифов, забирая информацию из структуры decoupling в ордерпроке, научим забирать оттуда же и ПП.

#### Requestconfirm на принятие заказа
1. Ничего не надо делать: суммы там не обрабатываются.  order.performer.paid_supply  это просто флаг.

#### Totw, точнее OrderCanceller
1. Платная отмена платной подачи. Тоже нужно будет в расчете поддержать. По сути, повторить всю сложную логику отмены ПП два раза, включая paid_supply_paid_cancel_with_minimal_in_waiting.
2. Возможно, даже стоит сделать такую отмену бесплатной, а вопрос абуза решить просьбами клиентам так не делать, а то отрубим ПП. Если это выиграет заметное время разработки.

#### Requestconfirm на завершение
1. Повторить логику отмены в случае отмены.
2. Независимо прибавать цену платной подачи, аналогично DriverCost. 

#### Вопросы
1. requestconfirm на завершение: почему paid_supply_price прибавляется только к водительской цене. Для пользователя платная подача уже прибавлена к фиксе и пришла в поле extra? Ответ: Для пользователя ПП уже засуммирована на Таксометре.В setcar мы передаём фиксу, где ПП уже засуммирована (так можно, потому что мы знаем, в расширенном радиусе находится водитель или нет), и ещё отдельно цену платной подачи.
Видимо, сейчас для декаплинга туда идёт ещё одна фикса. И придётся ещё одну цену платной подачи тоже.
2. requestconfirm на завершение: как это работает, если в процессе поездки изменить точку Б и заказ пересчитается. Ответ: Так как на Таксометр мы отдельным полем в setcar передаём цену ПП, то он её сам суммирует к расчётной цене по счётчику.
3. Что имеется в вики https://wiki.yandex-team.ru/taxi/clientproduct/paidsupply/tech/ под корректировками цены? Ответ: корректировки диспетчера.