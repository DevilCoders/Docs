## Этап 1

#### API **GET /4.0/safety_center/v1/launch?order_id=uuid**
**order_id** - если есть, необязателен, при заходе в ЦБ из бокового меню - его не будет, например.

 
** Ответ 200:**
 ````
{
   "sharing": {
    "ui_type": "enabled_checkbox|disabled_checkbox|button", # если юзер фродер, то придет button, иначе вкл или выкл по дефолту чекбокс
    "contacts": [
      {
        "phone_number": "+79269072780",
        "name": "Денис",
      }
    ],
    "max_contacts": 5,
  },
  "emergency_number": "112", # определяем страну, берем из конфига номер для нее
  "country": "rus" # Если страну не удалось определить country: "", emergency_number: default из конфига
}
````

Этот API вызывается при открытии главного экрана центра безопасности. При переходе из него в страницу со списком контактов и изменении этого списка и возврате назад надо будет перезапросить этот API, так как **sharing_enabled** мог измениться. До получения ответа UI после перехода по кнопке помощи должен содержать только лоадер (уточнить с дизайнером).

 #### API **GET /4.0/safety_center/v1/contacts**
Клиент вызывает этот API на каждый заход на экран со списком контактов, без кэширования.
**ответ 200**
````
{
  "contacts": [
    {
      "phone_number": "+79269072780",
      "name": "Денис",
    }
  ],
  "max_contacts": 5,
}
````
**фолбек:** фолбекаетесь на список телефонов, который пришел в launch 
**бэкенд:** параметр max_contacts выставляется конфигом **SAFETY_CENTER_MAX_CONTACTS**
Номера телефонов хранятся в сервисе персональных данных. В бд сервиса хранятся только id для сервиса ПД. В запросах клиента передаются или отдаются сами телефонные номера.

#### API **PUT /4.0/safety_center/v1/contacts**
Клиент при любой модификации передает полный список контактов на сервер - и после добавления, и после удаления контактов.

запрос:
````
{
  "contacts": [
    {
      "phone_number": "+79269072780",
      "name": "Денис",
    }
  ],
}
````

ответ 200:
````
{}
````

ответ 409:
Может придти если на сервере уменьшим лимит в один момент, или баг в клиенте/сервере.
````
{
  "code": "contact_phones_limit",
  "message": "Можно добавить не более, чем %d номер(|-а|-ов)",
  "details": {
    "max_contacts": 4,
  }
}
````

#### API **PUT /4.0/safety_center/v1/share**

API вызывается клиентами при нажатии на кнопку "Позвонить в полицию" и "Поделиться положением".
API может вызываться с разных экранов и в разных флоу. В зависимости от этого выставляется "notification_type":

- **"notification_type": "emergency"** - вызывается на экране экстренной ситуации. Здесь клиент автоматически передает все контакты с которыми надо связаться.
- **"notification_type": "share_location"** - вызывается на экране "поделиться локацией". Здесь пользователь выбирает кому отправить смс.
- **"notification_type": "contact_request"** - может вызываться когда пользователь добавляет контакт через экраны экстренной ситуации или "поделиться локацией". Отправляет контакту смс с уведомлением о том что пользователь добавил его в контакты и просит связаться.
- **"notification_type": "instruction"** - ???
- **"notification_type": "crash_detection"** - ???
  
  
Обработка ошибок - как-то показать ошибку после завершения звонка.

Если в момент вызова координаты еще не пришли от ОС (гнапример, gps cold start), то координаты приложение не шлет.

После получения ответа 200 надо отрендерить нотификацию.

**запрос:**
````
{
  "order_id": "uuid", # если есть, необязателен, при заходе в ЦБ из бокового меню - его не будет, например.
  "idempotency_key": "uuid",
  "coordinates": [37.5, 84.1], # необязательное поле: просим у пользователя пермишен, если не дает - не шлем его координаты
  "accuracy":  10 # целочисленное в метрах
  "recipients": ["+798765433210", "+79876543211"], # список контактов которым направляется смс
  "notification_type": "share_location|emergency|contact_request",
}
````

**ответ 200 OK:**
````
{}
````

**ответ 200 не совсем ОК:**
````
{
  "need_send_as_message": true # клиенту надо перейти в SMS, отправлять с сервера не будем, будет true когда подозреваем фрод
  "message": {
    "text": "Я в беде, моя поездка https://...", # будет только если need_send_as_message == true
    "recipients": ["+7926..."], # будет только если need_send_as_message == true
  }
}
````

на бекенде
1. Пишем в отдельную таблицу emergency_events факт обращения: created_at, phone_id, order_id, coordinates. Оценить объем таблицы, нужна ли репликация в YT. Понять нужно ли в админки прокидывать информацию, или создание тикета уже дает нужные возможности.
2. Шлем SMS гарантированно для всех контактов если не фрод.
3. Строим антифрод пока простой, оперевшись на мониторинги. Разрешаем отправку через нас не более limit SMS в месяц от phone_id и для contact_phone_number.
4. Начинаем с заглушки, отдающей всегда переключение в SMS
5. Строим графики по числу обращений, числу юзеров с контактами и алертивших всего и за последнее время, числу контактов на юзера и всего, числу кейсов когда попросили отправить как SMS.
6. Создаем тикет в саппорте с приоритетом (тут надо изучить API, как это сделать надежно/идемпотентно).


## Этап 2
0. Админка для отображения всех обращений пользователя
#### API **GET /4.0/stories?order_id=uuid&context=ride_details|safety_center**
**order_id** - необязателен, если есть

**ответ 200:**
````
{
    "stories": [ # формат внутри объектов такой же как в /taxiontheway сейчас
        {
          "button_link": "https://taxi.yandex.ru/action/b2b-friend-referral/?utm_source=app&utm_campaign=stories_app&utm_medium=referal",
          "button_title": "Рекомендовать",
          "media": [
            {
              "content": "https://promo-stories.s3.yandex.net/080419_3years_b2b/ru/bfbfcf8ba55b554ce64470e8c4ac7645db26a9d7.mp4",
              "show_button": false,
              "type": "video"
            },
            {
              "content": "https://promo-stories.s3.yandex.net/080419_3years_b2b/ru/979b64036a68cb33d6eb4edb31f57a533e880f79.mp4",
              "show_button": false,
              "type": "video"
            },
            {
              "content": "https://promo-stories.s3.yandex.net/080419_3years_b2b/ru/086cf84031b4bd3cb3c6de6e698c8a736372b5cb.mp4",
              "show_button": false,
              "type": "video"
            },
            {
              "content": "https://promo-stories.s3.yandex.net/080419_3years_b2b/ru/58770eb3ba16fe1da049edf03aa4455aec6ea5c9.mp4",
              "show_button": false,
              "type": "video"
            }
          ],
          "name": "080419_3years_b2b",
          "teaser_image": "https://promo-stories.s3.yandex.net/080419_3years_b2b/ru/9e4f4f79f99667f07100939e1d6fddc1770bd116.png"
        },
    }
}
````

Не используем кэширование сториз на клиенте. Клиенты перезапрашивают сториз, когда им это нужно:
* в деталях поездки - один раз за поездку
* в ЦБ - на каждый заход в ЦБ

````
{
  "code": "invalid_order",
  "message": "что-то пошло не так"
}
````

### Клиентам
1. Используем старую логику в totw, если эксперимент в launch не включает в себя контекст "ride_details":
эксперимент:
````
"typed_experiments": {
  "items": [
    {
      "name":"new_stories",
      "value":{
        "enabled_contexts": ["ride_details", "safety_center"],
      }
    }
  ]
}
````
Если же контекст "ride_details" присутствует, то идем в новую ручку.
2. Ходим в новую ручку в ЦБ аналогично если контекст "safety_center" присутствует в эксперименте. Иначе, не показываем stories в ЦБ.

#### Отказоустойчивость
1. Если до ручки safety_center/launch не удалось достучаться за таймаут, то надо использовать фолбэк номер из эксперимента, рисовать UI, будто бы все хорошо
2. Отдельный вопрос фолбэкаться ли на локальный список контактов при недоступности safety_center/launch, или же фолбэкаться на кнопку "поделиться поездкой", или же вообще убирать UI элементы связанные с контактами.
3. При недоступности API листинга контактов, добавления контактов, шаринга координат и помощи - показывать ошибку. На клиенте оставить кнопку звонка в 112 и возможность отправлять смс с телефона кэшированным контактам (если есть).

бекенд
1. Делаем отдельный сервис
2. Хардкодим в нем сториз для ЦБ
3. Переносим логику из totw
4. Экспериментами отключаем на проде для деталей поездки и ЦБ, но клиентами сразу поддерживаем
5. Делаем фолбэк для сториз и в деталях и в ЦБ, возможно, (но не хочется), как фолбэк можно заюзать текущее поведение
6. Ходим в ML за персонализацией
7. В самом начала разработки нужно сделать нагрузочное тестирование, так как пишем на питоне3, и есть риски по нагрузке, так как ручка будет вызываться часто и везде в приложении. Нагрузочное тестирование делаем на отдельных load машинках с тупой логикой, которая только в постгрес ходит.


#### Как приложению работать с ошибками
1. Если 5xx или сетевая ошибка, то стандартный ретрай с экспоненциальными интервалами и случайными задержками n раз. Если в заголовке есть **retry-after**, то брать число секунд, через которое надо ретраить оттуда.
2. Если не 4xx ответ, то попытаться извлечь **message** из ответа. Если удалось, то показать его, иначе показать что-то стандартное про неизвестную ошибку.

#### Безопасность
Договорились использовать yandex_uid, зная что данные протухают со временем.

## Этап 3
1. решить: мы на самом деле не знаем положение пассажира а если и знаем его случайно то показываем контактам не его, пассажир может быть уже не в машине
2. антифрод улучшить при необходимости
3. доработки по сториз - ML

