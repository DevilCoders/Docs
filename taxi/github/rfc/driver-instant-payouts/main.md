### Архитектурное описание сервиса - driver-instant-payouts

### Название сервиса
driver-instant-payouts

### Какую продуктовую проблему решает сервис?
Мгновенные выплаты средств водителям таксопарков напрямую через банк
как в автоматическом режиме, так и под контролем таксопарков.
В будущем - СМЗ и ИП.

### Почему нельзя решить эту задачу без разработки нового сервиса существующими решениями?
На данный момент не существует сервиса,
который отвечал бы за мгновенную выплату средств водителям таксопарков,
а также хранил бы платежные реквизиты пользователей в токенизированном виде
и правила выплат.

### Как именно сервис будет решать поставленные перед ним задачи?
Сервис будет хранить банковские карты пользователей в токенизированном виде.
Сами карты будут храниться на стороне банка.
Сервис предоставляет ручки для таксометра и диспетчерской.
Для диспетчерской будут ручки добавления(настройка)/удаления  банка
для моментальных выплат, а также в будущем появится механизм
подтверждения/отклонения вывода средств для водителя.
Для таксометра будет ручка, которая позволяет
получить средства на карту водителя.
В сервисе будет реализована логика, которая будет проверять,
что баланс водителя после списания не станет меньше лимита
и в случае успеха проводить выплату через внешние сервисы (банки)

### Разрабатывается один сервис или система?
Один сервис

### С кем взаимодействует сервис?
- Front-End SuperWeb - для просмотра запросов на вывод средств и редакирования правил вывода.
- Таксометр - для просмотра правил вывода средств и создания запросов
- Биллинг - для изменения баланса водителя
- Внешние сервисы банков - для выплат средств на банковские карты
- STQ для операций с банком

### Какие базы использует?
Своя база для хранения номеров банковских карт пользователей
в токенизированном виде, списка запросов и правил вывода.

### Какие периодические процессы?
Нет

### Планируется обработка персональных данных
Нет

### Какие данные и по какой схеме сервис будет хранить в базе?
На момент запуска:
Таблица с привязанными банковскими картами водителя
- park_id - идентификатор парка
- driver_profile_id - идентификатор водителя в парке
- bank_id - идентификатор банка
- card_id - уникальный идентификатор карты для сервиса
- card_name - маска карты (1234********4321), последние 4 цифры или имя (альфа, сбер)
- token - токен, сгенерированный банком

В дальнейшем:
Таблица с запросами выплат
- request_id - идентификатор заказа. Нужен для подтверждения и отмены
- park_id - идентификатор парка
- driver_id - идентификатор водителя в парке
- amount - запрошенная сумма
- status - pending, approved, declined
- created_at - время создания запроса
- updated_at - время изменения статуса
- updated_by (author) - автор статуса

Таблица с правилами
- park_id - идентификатор парка
- rule_id - идентификатор правила
- name - название правила
- park_fee - комиссия парка
- min_fee - минимальная комиссия
- min_amount - минимальная сумма для единовременного вывода
- max_amount - максимальная сумма для единовременного вывода
- max_amount_per_day - максимальная сумма для вывода в день
- ...

### Какой объем данных будет храниться и какой объем будет изменяться в единицу времени?
Среднее количество активных водителей - 3.000.000
У водителя в среднем 1-2 банковские карты
Количество строк в таблице карт 3М - 6М
При среднем размере строки в 20-30б получаем 60-180 мегабайт.
1 водитель в среднем имеет 1-2 запроса на вывод средст (из 1 или 2 парков)
Количество строк в таблице запросов 3М - 6М
Получаем 60-180 мегабайт.
В одном парке в среднем 5 правил вывода.
Принимаем, что активных в среднем 300к парков.
Количество строк в таблице правил 1.5М - 2М
Получаем 30-60 мегабайт.
Итого 150-420 мегабайт.

### Какие операции над данными заложены?
- Чтение данных
- Создание и удаление токенов банковоских карт
- Создание запросов и изменение их статусов
- Создание и изменение правил выплат

### Есть ли какой-то стейт в памяти, как он обновляется и валидируется?
Нет

### Какая нагрузка ожидается?
На момент запуска MVP 5-10 rps
В дальнейшем увеличится на порядок.

### Какие фолбеки предусмотрены на сам этот сервис?
Фолбеки на сервис не планируются.

### Какие фолбеки предусмотрены внутри этого сервиса на взаимодействие с другими сервисами?
Не предусмотрено.

### Какие возможности масштабируемости закладываются?
Горизонтальное масштабирование

### Какие точки отказа есть в сервисе?
- Конфиги
- БД
- Внешние сервисы банка
- Биллинг
- STQ

### Укажите ключевые продуктовые метрики сервиса, за которыми планируете следить
- Количество водителей, которые пользуются сервисом
- Количество парков, которые пользуются сервисом
- Количество банков
- Распределение по банкам
- Оборот

### Укажите технические метрики
Дефолтные дашборды
Среднее время одной операции

### Какая функциональность ожидается в сервисе в будущем?
Хранение запросов на выплаты для рассмотрения парком.
Возможность создания и редактирования правил в рамках парка.
Добавление новых банков.

### Какое изменение нагрузки планируется?
Пропорционально количеству водителей.

### Активно ли будет изменяться сервис?
Да
