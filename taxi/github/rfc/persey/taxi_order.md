# Вызов такси для медработников

## Постановка

Утром каждого дня в каждой лаборатории есть список медработников с привязанными к ним маршрутами, по которым надо весь день ездить и собирать материал для анализов.

У медработников есть специальное мобильное приложение "Помощь.Рядом", в котором они видят маршрут на текущий день.

Есть водители, принимающие заказы в специальном тарифе "Лаборатория", которые забирают медработника из дома (или лаборатории), и возят весь день по маршруту. Водитель получает фиксированную оплату за день работы.

Нужно вызывать Такси для каждого медработника, а информацию о назначенном водителе пробрасывать в приложение Помощь.Рядом, чтобы медработник знал, какая машина едет, через сколько приедет, был телефон водителя для связи.

Срок на реализацию задачи -- несколько дней.

## Реализация

С учётом срочности задачи, предлагается следующая реализация. В дальнейшем задачу планруется доработать, на это будет отдельная проработка.

### Инициирование заказа

Предлагается сделать крон-таску, которая мониторит назначенные маршруты медработников, и в какой-то момент по определенному правилу (например, за полчаса до выезда) ставится STQ-таска для создания заказа в тарифе "Лаборатория". В заказ нужно пробросить номер телефона медработника, точку А. Точка Б для первого этапа не так важна, так как когда медработник сядет в машину, уже сможет устно давать водителю указания по адресам.

### Создание заказа

Создание заказа предлагается делать через integration-api, добавлением нового `order_source = persey`.

Заказ создается по следующему флоу int-api:

#### /profile

Создаем/получаем профиль пользователя (отдельный `user_doc`).

Минимальный запрос:
```json
{
  "sourceid": "persey",
  "user": {
    "phone": "+79001234567"
  }
}
```

В ответ получаем `user_id`:
```json
{
  "audience_category": "newbie",
  "dont_ask_name": false,
  "experiments": "[...]",
  "personal_phone_id": "416497e770fa47b99fa1de525567e1b3",
  "user_id": "eee9495a384741c7aca06bd9936dbc80"
}
```

#### /suggest

Ходим с точкой А за саджестами.

Запрос:
```json
{
  "action": "pin_drop",
  "position": [
    37.565327,
    55.567123
  ],
  "sourceid": "persey",
  "state": {},
  "sticky": false,
  "type": "a",
  "user": {
    "id": "eee9495a384741c7aca06bd9936dbc80",
    "personal_phone_id": "416497e770fa47b99fa1de525567e1b3"
  }
}
```

В ответе получаем `nearest_zone`:
```json
{
  "nearest_zone": "moscow",
  "...": "..."
}
```

#### /zoneinfo

Ходим за информацией по зоне.

Запрос:
```json
{
  "sourceid": "persey",
  "user": {
    "user_id": "eee9495a384741c7aca06bd9936dbc80",
    "personal_phone_id": "416497e770fa47b99fa1de525567e1b3"
  },
  "zone_name": "moscow"
}
```

По ответу проверяем, что в зоне поддерживаются тариф "Лаборатория" и `payment_method == cash`:
```json
{
  "max_tariffs": [
    {
      "class": "laboratory",
      "...": "..."
    },
    "{...}"
  ],
  "payment_options": {
    "cash": true,
    "...": "..."
  },
  "...": "..."
}
```

#### /orders/estimate

Создаем оффер для тарифа "Лаборатория" и способа оплаты "Наличные".

Запрос:
```json
{
  "payment": {
    "payment_method_id": "cash",
    "type": "cash"
  },
  "route": [
    [
      37.64180045,
      55.734440089
    ],
    [
      37.642034917,
      55.732787939
    ]
  ],
  "selected_class": "laboratory",
  "sourceid": "persey",
  "user": {
    "phone": "+70001234567",
    "user_id": "eee9495a384741c7aca06bd9936dbc80"
  }
}
```

Ответ:
```json
{
  "is_fixed_price": true,
  "offer": "f6b41106106ac82c1d18ec2809ec8dfc",
  "user_id": "eee9495a384741c7aca06bd9936dbc80",
  "...": "..."
}
```

#### /orders/draft

Создаем черновик заказа.

Запрос:
```json
{
  "class": [
    "laboratory"
  ],
  "id": "eee9495a384741c7aca06bd9936dbc80",
  "offer": "f6b41106106ac82c1d18ec2809ec8dfc",
  "parks": [],
  "payment": {
    "payment_method_id": "cash",
    "type": "cash"
  },
  "requirements": {},
  "route": [
    {
      "city": "...",
      "fullname": "...",
      "geopoint": [
        37.64180045,
        55.734440089
      ],
      "short_text": "...",
      "type": "organization",
      "uri": "ymapsbm1://org?oid=137373394866"
    },
    {
      "city": "...",
      "fullname": "...",
      "geopoint": [
        37.642034917,
        55.732787939
      ],
      "short_text": "...",
      "type": "organization",
      "uri": "ymapsbm1://org?oid=1222085109"
    }
  ],
  "sourceid": "persey",
  "zone_name": "moscow"
}
```

В ответ получаем id заказа:
```json
{
  "orderid": "4486ab98e53a3769bfb2bca11e4b235f"
}
```

#### /orders/commit

Создаем заказ из черновика.

Запрос:
```json
{
  "orderid": "4486ab98e53a3769bfb2bca11e4b235f",
  "sourceid": "persey",
  "userid": "eee9495a384741c7aca06bd9936dbc80"
}
```

Ответ:
```json
{
  "orderid": "4486ab98e53a3769bfb2bca11e4b235f",
  "status": "search"
}
```

### Информирование медработника о назначенном водителе

Информацию о текущем статусе заказа можно получить из ручки int-api `/orders/search`. Там есть (список неполный):
- статус заказа
- информация о водителе, в том числе телефон
- сколько времени ждать машину
- ссылка на шэринг маршрута

Запрос:
```json
{
  "orderid": "4486ab98e53a3769bfb2bca11e4b235f",
  "sourceid": "persey"
}
```
