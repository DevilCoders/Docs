**Название сервиса**

driver-promocodes

**Какую продуктовую проблему решает сервис?**

Сервис позволяет создавать промокоды водителей и отдавать информацию о выданных промокодах.
Также сервис хранит информацию о сериях промокодах (бывш. "номиналах"), определяющих количество промокодов, доступных к выдаче и необходимые парметры для них (валюту для комиссий / тэги для промокодов диспатча и т.д.)

**Почему нельзя решить эту задачу без разработки нового сервиса существующими решениями?**

В данный момент логика промокодов размазана по backend и backend-cpp,
используется база dbtaxi.

Нужно расширить функционал промокодов (добавить разные типы промокодов и ttl), а расширять и продолжать использовать для этого базу dbtaxi не хочется.

Нужен отдельный сервис, инкапсулирующий логику водительских промокодов и закрывающий собой хранилище промокодов.

**Как именно сервис будет решать поставленные перед ним задачи?**

Сервис предоставляет:
  1. Ручки получения/активации промокодов для таксометра
  2. Ручку добавления промокода (неперсонализированного изначально) в список доступных промокодов для таксометра
  3. Ручку получения/учитывания промокодов, активных у водителя в заказе (будет дергаться процессингом в биллинговой джобе)
  4. Ручки получения/создания серий промокодов + получения/создания (и балкового создания) промокодов для админки

  Ручки создания промокодов и серий будут проксироваться через АБК для записи в журнал аудита.
  Создание серии промокодов будет закрыто механизмом драфтов

**Разрабатывается один сервис или система?**

Один сервис

**С кем взаимодействует сервис?**

- driver-promocodes ходит в workshifts для проверки отсутствия активных смен у водителя в момент активации промокода
- При активации промокода отправляет данные в driver-tags.
- При создании промокода серввис отправляет сообщение водителю в ленту.
- В сервис ходит процессинг (биллинговая таска) и забирает/проставляет информацию о заказах и активных в них промокодах.

**Какие базы использует?**

Новая pg dbdriver_promocodes.

**Какие периодические процессы?**

Нет

**Планируется обработка персональных данных**

Нет

**Какие данные и по какой схеме сервис будет хранить в базе?**

***promocode_series***

```javascript
{
	"_id" : "926145376ea748b2890ea3dafdd3861c",
        "created_at" : <timestamp>,      // время создания
        "valid_until" : <timestamp>,         // время окончания
        "updated_at" : <timestamp>,      // время обновления
	"created_by" : "alexyarats",	              - кем создано
	"description" : <tanker_key>,	              - ключ описания серии
	"country" : "rus",           //
	"is_active" : true,	     // вкл/выкл серии
	"series_id" : "comission_nominal",            - название серии
        "limit_count" : 1000,	     // кол-во промокодов, которое может быть выданно с этой серией
	"version" : 1001,            // версия документа
	"used_count" : 1000,         // кол-во промокодов выданных с этой серией
	"duration_hours" : 1,        // время действия промокода выданного по этой серии 
        "currency" : "RUB",
        "tags" : ["dispatch_tag1"] // теги, проставляемые водителю при активации промокода
        "tariffs": ["econom"] // тарифы, в которых работает промокод. если поле отсутствует, промокод можно использовать в любых тарифах
        "type" : "commission"|"dispatch"|...                  // на что распространяется данная серия
}
```

***driver_promocodes***

```javascript
{
	"_id" : "06d817928c444568aaab49f683e866cb",
        "promocode_id": "123", // идентификатор промокода (может повторяться у разных водителей)
        "created_at" : <timestamp>, //время создания промокода
        "valid_until": <timestamp>, // время до которого данный промокод можно активировать
	"updated_at" : <timestamp>, // время обновления промокода
        "created_by" : "alexyarats", // кем создано
	"description" : "Тестовый промокод",          - заполняется саппортом при выдаче промокода	
	"series_id" : "comission_nominal",            - к какой серии относится данный промокод
	"park_id" : <park_id>,
        "driver_profile_id" : <driver_profile_id>,
        "chatterbox_ticket": "12345678", // при создании промокода необходимо указать тикет из чаттербокса либо из трекера
        "tracker_ticket": "12345678",
        "is_activated": true,           // водитель активировал промокод		
	"begin_at" : <datetime>,        // когда был активирован промокод (проставляется только при активации). Может не совпадать со временем, когда водитель нажал "активировать" (и проставил флаг activated), если были перебои в работе джобы, проставляющей тэги, либо сторонний сервис, необходимый для активации промокода, был недоступен
	"end_at" : <datetime>,          // когда завершится промокод (проставляется только при активации)
        "used_for_orders": ["alias_id1", "alias_id2", ..] // к каким заказам был применён
}
```

***common_promocodes***

```javascript
{
	"_id" : "123",
        "created_at" : <timestamp>, //время создания промокода
        "valid_until": <timestamp>, // время до которого данный промокод можно активировать
	"updated_at" : <timestamp>, // время обновления промокода
        "created_by" : "alexyarats", // кем создано
	"description" : "Тестовый промокод",          - заполняется саппортом при выдаче промокода	
	"series_id" : "series_id",            - к какой серии относится данный промокод
	"chatterbox_ticket": "12345678", // при создании промокода необходимо указать тикет из чаттербокса либо из трекера
        "tracker_ticket": "12345678",	
}
```

Коллекция common_promocodes нужна для создания неперсонализированных промокодов. Они, при создании, привязаны к серии, но не привязаны к водителю. Когда водитель нажимает на кнопку "добавить промокод", для него добавляется запись в driver_promocodes, и у серии увеличивается used_count.

**Какой объем данных будет храниться и какой объем будет изменяться в единицу времени?**

Всего в базе будет храниться ~1.5-2 Гб данных

В секунду будет изменяться ~6кб/с

**Какие операции над данными заложены?**

read, write, update

**Есть ли какой-то стейт в памяти, как он обновляется и валидируется?**

Нет

**Какая нагрузка ожидается?**

~250 rps

1. Получение + добавление + активация промокодов в таксометре: 100 RPS
2. ручки CRU (в будущем может появиться D) промокодов/серий для tariff editor: 1 RPS
3. ручка учета/получения промокодов, использованных в заказе: 150 rps

**Какие фолбеки предусмотрены на сам этот сервис?**

- В таксометре: водитель не увидит список своих промокодов / не сможет активировать промокод
- В админке: нельзя будет создать новый промокод/серию; нельзя будет увидеть существующие серии промокодов
- Для биллинга: если не удается получить информацию об активных промокодах водителю, фейлим таску рассчета комиссии и повторяем позже

**Какие фолбеки предусмотрены внутри этого сервиса на взаимодействие с другими сервисами?**

Фолбеки внутри сервиса:

при отказе бд не сохраняем новые промокоды и не активируем существующие, отвечаем 500-кой.

Внешние фолбеки:

- При отказе workshifts (получение смен водителя) не разрешаем активировать промокод на отключение комиссии, просим повторить позже
- При отказе сервиса тэгов: не разрашаем активировать промокод, для которого нужно проставить тэг, просим повторить попытку позже
- При отказе ленты водителя: все равно создаем промокод. В будущем может появиться джоба, досылающая водителям в ленту пропущенные уведомления

**Какие возможности масштабируемости закладываются?**

Шардирование базы, увеличение количества инстансов сервиса, отложенная обработка некоторых запросов за счет добавления периодических или stq тасок

**Какие точки отказа есть в сервисе?**

1. Отказ сервиса тэгов
2. Отказ бд
3. Отказ ленты новостей водителя
4. Отказ сервиса смен

**Укажите ключевые продуктовые метрики сервиса, за которыми планируете следить**

Количество выданных и использованных промокодов по категориям: на диспатч, на отмену комиссии и других, если появятся.

Количество активированных промокодов по водителям для отслеживания фрода

**Укажите технические метрики**

- Среднее время ответа на запрос
- Нагрузка на БД
- Время и успешность работы периодических джоб

**Какая функциональность ожидается в сервисе в будущем?**

Все, связанное с промокодами и их учитыванием при рассчете комиссий, диспатча и т.д.

**Какое изменение нагрузки планируется?**

Прямо пропорционально количеству активных водителей

**Активно ли будет изменяться сервис?**

Могут появляться новые типы промокодов и серий
