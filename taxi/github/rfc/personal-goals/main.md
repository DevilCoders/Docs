# Персональные цели

## О проекте
У юзера могут быть некоторые персональные цели, при выполнении которых ему начисляется бонус.
Пример цели: "Сделай 5 поездок по тарифу комфорт и получи промокод на 300 рублей по любому тарифу"

### О целях
Одновременно активна может быть только одна цель.

Возможные цели:
- Поездки днем/ночью
- Поездки по тарифу
- Использование определенных функций

Возможные бонусы:
- Промокод на X рублей
- X рублей на кошелек
- Кэшбек по кошельку

Список не окончательный и может пополняться.

### MVP
В качестве MVP предлагается сделать цель на количество поездок с бонусом в виде промокода.

## Userflow
Рассмотрим основные этапы взаимодействия юзера с целям.

### Список целей
Юзер должен видеть свои цели/цель в приложении и отслеживать прогресс по ним.
Цели должны отображаться в:
- Меню
- Саммари
- Карточка тарифа


### Достижение цели
По завершении заказа юзеру должна прийти нотификация о том, что цель выполнена и бонус начислен.

## Техническая реализация
Реализация подразумевает добавление нового сервиса goals.

### 0. Появление целей у юзера
Предполагается, что кто-то подготовит табличку где строкой будет идентификитор пользователя и цель, которую 
нужно перед ним поставить. Далее в админке будет вкладка персональные цели, куда можно будет эту табличку скормить.
Админка сходит во внутреннюю ручку постановки целей, которая добавит информацию о пользовательской цели и возможно
отправит нотификацию. Нотификацией может служить как пуш, так и нотификашка из п.5

### 1. Список целей с прогрессом.
Клинетское приложение на старте и получает список целей. 
Список целей может быть как отдельной ручкой, так и жить в существующей, например launch или personalstate.
Необходимо обсуждение с клиенсткой разработкой.
В этой ручке также возвращается прогресс выполнения цели. Ответ кешируется на клиенте и далее используется 
на всех нужных экранах.

Сценарий работы:
- Достать пользовательские цели
- Проверить что цели не протухли
- Вернуть активную, если такая имеется

Протухшие цели:
Если у персональной цели закончилась дата действия, то он считается протухшей и ее надо удалить.
Удаление планируется делать в этой ручки асинхронным запросом.
Альтернативным вариантом может быть периодическая cleanup таска.

Пример ответа: 
```json
{
  "goals": [
    {
      "id": "",
      "status": "(active|done|next)",
      
      "title": "5 поездок до скидки",
      "description": "<Длинный текст>",
      "details": [
        "Сделать 5 поездок",
        "За следующие 5 дней"
      ],
      
      "progress": {
        "total": 5,
        "current": 3
      },
      
      "conditions": {
        "tariffs": ["econom"]
      }
    }
  ]
}
```

### 2. Цели на карточке тарифа
**Update: Договорились не показывать цель на карточке тарифа в первой версии. Ждем новое саммари.** 
На карточке тарифа надо показать что поездка по этому тарифу будет влиять на прогресс цели.

Для этого в ответе списка целей надо передать условия по тарифу, 
тогда клиенсткое приложение без помощи бекенда сможет нарисовать.

Альтернативным вариантом может быть решение о показе на бекенда.
Для этого можно сделать плагин в роутстатс, который получит текущую цель и добавит поля в ответ.
```json
{
  "service_levels": [
    {
      "personal_goal": {
        "goal_id": "<goal_id>"
      }
    }
  ]
}
```

### 3. Прохождение цели
При успешном завершении заказа необходимо записать прохождение цели.
Эту задачу можно разделить на несколько частей:

#### 3.1 Процессинг py2
В status_hadling в момент успешного закрытия заказа ставится новая stq3 таска 
goals_processing которая будет заниматься регистрацией эвента (заказа).
Процессинг под конфигом. 

Полагаемся на то, что stq таска всегда поставится, поэтому фолбэка нет.
Логика такая: таск обязательно должен быть поставлен, чтобы юзер не потерял прогресс. 

#### 3.2 STQ3 таска регистрации
goals_processing ставится с аргументом виде order_id и выполняется при успешном завершении заказа

Основные задачи этой таски:
- Получение заказа из архива
- Проверка статуса заказа на complete
- Хождение в ручку записи события пока не запишется
- Хождение в ручку закрытия цели (если цель не закрыта, то ручка ничего не сделает)

#### 3.3 Ручка регистрации заказа
В сервисе goals есть ручка регистрации заказа для инкремента прохождения цели.

Пример запроса
```json
{
  "yandex_uid": "",
  "phone_id": "",
  
  "created": "",
  
  "order_id": "<order_id>",
  "order_data": {
    "_id": "",
    "request": {},
    "payment_tech": {}
  }
}

```

Сценарий работы:
1. Проверка есть ли у юзера активные цели. 
Достать цели, если есть, иначе вернуть 200ok

2. Проверка соответствия условий цели данному заказу.
Сюда входит 
- парсинг order_data из запроса. 
- Проверка тарифов, даты заказа, времени заказа, способа оплаты и т.п.

3. Запись в БД события цели.


### 4. Завершение цели

#### 4.1 Ручка закрытия цели
После записи события, необходимо закрыть цель, если она выполнена.

Сценарий работы:

1. Достать активную цель

2. Достать все события для этой цели.

3. Закрыть необходимое количество эвентов
Цель может быть: 5 поездок по тарифу эконом, но из-за мультизаказа поездок будет 6.
В этом случае закрыть нужно только нужное количество событий.
Закрытие события означает выставление у него user_goal_id, чтобы они не участвовали в прохождении другой цели.

4. Закрыть цель
Необходимо выставить status=done у пользовательской цели.

5. Запусть STQ3 таску goals_finish_processing
Завершение цели подразумевает, что все условия данной цели выполнились и можно начислять бонус.
Т.к необходима гарантия результата, то всем этим будет заниматься отдельная STQ3 goals_finish_processing.

#### 4.2 STQ3 таск goals_finish_processing
После достижения цели необходимо начилить соответствущие бонусы.
Для этого ставится таска с аргументом user_goal_id 

Сценарий работы таски:
1. Достать цель
2. Убедиться, что status=done и бонус еще не начислен
3. Понять какой бонус нужно начислить
4. Начисление различных бонусов до победы (coupon, personal_wallet, т.д)
5. Оповещение юзера о начислении


### 5. Оповещение пользователя 
Общая схема выглядит подобно фидбеку. 
- В launch отдается признак того, что есть новые достигнутые цели.
- При этом признаке клиент дергает некоторую ручку непросмотренных достижений
- Возвращается непросмотренная достигнутая цель.
- Клиент отправляет запрос о том, что нотификация принята, и больше ее присылать не надо.
Также сохраняет на диск признак того, что цель достижение увидел, чтобы в случае проблем с нетворком нотификашку
о прохождении больше не показывать.

#### 5.1 Launch
Сценарий работы:
- проверить, если ли новые достижения
- добавить в ответ признак если есть

Пример ответа
```json
{
  "personal_goals": {
    "notifications": true
  }
}
```
  
#### 5.2 Ручка новых достижений
Сценарий работы:
- клиент запрашивает новые достижения
- ручка возвращает список новых достижений

Пример ответа
```json
{
  "notifications": [
    {
      "goal_id": "",
      "title": "Скидка 10 %",

      "description": "Вы сделали 5 поездок, круто! Скидка на поездку ваша!",
      "progress": {
        "total": 5,
        "current": 5
      },
      
      "button": "Отлично"
    }
  ]
}
```

#### 5.3 Ручка просмотра достижения
Сценарий работы:
- клиент видит нотификацию 
- клиент шлет запрос о том, что нотификацию увидел
- нотификация больше не присылается и удаляется из базы

Пример запроса:
```json
{
  "goals": ["<goal_id>"]
}
```

### 6. Админка персональных целей.
Необходимо сделать админку персональных целей подобно админке промокодов, 
чтобы удобно можно было настраивать условия цели и раскатывать на пользователей.

### 7. Хранилище персональных целей.
**Все хранилища будут в postgres, для простоты восприятия примеры в json**

#### Таблица goals
Различные описания целей
Пример записи:
```json
{
  "id": "ride_goal",
  "created": "",
  "updated": "",
  "conditions": {
    "classes": [
      "econom"
    ],
    "days_start": "",
    "days_finish": "",
    "day-interval": ""
  },
  "bonus": {
    "type": "promocode",
    "series": "goals1234"
  }
}
```

#### Таблица user_goals
Цели конкретного пользователя
Пример записи:
```json
{
  "id": "user_goal_1",
  "goal_id": "ride_goal",
  
  "yandex_uid": "",
  "phone_id": "",
  "status": "(active|done|next|missed)",
  
  "bonus_gained": false,
  "bonus_date": ""
}
```

#### Таблица user_goals_events
Прогресс прохождения цели
Пример записи:
```json
{
  "id": "goal_event_1",
  "type": "ride|ya_plus_buy",
  "created": "",
  
  "user_goal_id": "<Выставляется при завершении цели>",
  
  "external_ref": "<order_id>",
  "external_data": {
    "_id": "<order_id>",
    "request": {}
  }
}
```

#### Таблица user_goals_notifications
Нотификаци о прохождении цели
```json
{
  "id": "goal_notification_1",
  "created": "",  
  "user_goal_id": ""
}
```

## Оценка по срокам
0. [5d] Инфраструктурная часть (окружение, бд) 
1. [2d] Начисление пользователям цели
2. [3d] Ручка списка целей 
3. [2d] Ручка регистрации заказа
4. [2d] Ручка завершения цели
5. [2d] Оповещение о завершении
6. [??] Админка целей
7. [3d] stq3 goals–processing
8. [3d] stq3 goals–finish–processing
9. [2d] Продуктовые метрики graphite/solomon
10. [1d] Внешяя ручка генерации промокода в сервисе купонов
