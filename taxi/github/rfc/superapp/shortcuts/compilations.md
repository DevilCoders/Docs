# Продуктовое описание

Хотим построить долговременные отношения с пользователей и использовать штору как инструмент для рассказов о городе и наших городских сервисах. Для этого хотим делать редакторские подборки контента, подходящего под контекст пользователя

<details>
  <summary>Скриншоты</summary>
![1](https://jing.yandex-team.ru/files/privet/2020-07-08T09:10:50Z.5490974.png)

![2](https://jing.yandex-team.ru/files/privet/2020-07-08T09:11:24Z.10191e9.png)

![3](https://jing.yandex-team.ru/files/privet/2020-07-08T09:12:08Z.ef16b2b.png)
</details>

Более конкретно, редактор в веб-интерфейсе формирует подборку (внешний вид и содержимое), задает аудиторию и публикует. Разметка содержимого (чтобы оно попало в подборку) вне скоупа данного RFC.

## Идея

"Подборка" представляет из себя шорткатную сетку, в которой для каждой клетки определен её размер, а также правило, по которому эта клетка должна быть "наполнена". Например, подборку

![1](https://jing.yandex-team.ru/files/privet/2020-07-08T09:10:50Z.5490974.png)

Можно описать как
```
[
    {
        размер: 2x3
        наполнение: шорткат от источников со сценарием grocery_category
    },
    {
        размер: 2x3
        наполнение: шорткат от источников со сценарием eats_place
    },
    {
        размер: 2x2
        наполнение: шорткат от источников со сценарием grocery_category
    },
    {
        размер: 2x3
        наполнение: шорткат от источников со сценарием media_stories
    },
    { ... },
    { ... },
]
```

При этом:
* Правила наполнения должны быть расширяемы, т.к. правило "шорткат со сценарием" слишком общее. Например, под `media_stories` подходит много медиашорткатов, но мы хотим в подборке именно "10 комедий на КиноПоиске". Аналогично с `eats_place` и `grocery_category`
* Для подборки должны существовать условия показа. Например: подборка показывается только там, где есть Еда и Лавка. В простейшем случае условием показа может быть "если все клетки заполнены",
* Потенциально для клеток подборки возможны фоллбеки вида "если тут нет Лавки, просто сделай соседний шорткат Еды больше". В данном РФЦ это не рассматриваем.


TODO: что делать если я взял в 2x2 какой-то eats_place, но у него не влезает заголовок?

## Архитектурные моменты

Что понятно сейчас:
1) "Наполнением" подборки должен заниматься блендер
2) При наполнении может учитываться интент пользователя, потенциально — его контекст (есть ли активный заказ в Такси/Еде, етц)

Высокоуровнево можно начать с чего-то такого:
```
            shortcuts-source1 shortcuts-source2 ...
                          |    |
                          v    v
   collections-source --> blender
```

`collections-source` может эволюционировать следующим образом:

Этап 1: Источником подборок являются конфиги/эксперименты3.0

Этап 2: Источником подборок является ручка в inapp-communictaions (потенциально — 4.0/inapp-communications/shortcuts) [требует дополнительных согласований с командой inapp]

## Описание коллекции

Коллекция представляет из себя
* Опциональный заголовок
* Набор элементов, для каждого из которых определены
* * Правила наполнения элемента (например, здесь шорткат Еды или Лавки)
* * Кастомизации элемента (например, задать элементу оверлей)

### Правила наполнения элемента

В идеальном мире правила для наполнения элементов коллекции максимально гибкие, и могут выглядеть так: "на этом месте должна быть либо пиццерия с рейтингом выше 4.8, либо набор для приготовления еды из Лавки".

Такие правила можно описать с помощью предикатов в экспериментах 3.0 https://wiki.yandex-team.ru/taxi/backend/architecture/experiments3/Manual/#exp-predicate-types , однако на начальном этапе такой подход кажется оверкиллом: нужно подпилить матчер из экспериментов, сформулировать кварги, подумать о перфомансе.

На начальном этапе предлагаю сконцентрироваться на простых правилах:
* Шорткат со сценарием из списка
* Шорткат с мета-тегом из списка
* Шорткат со сценарием из списка и мета-тегом из списк

Переход на более мощный матчер предлагаю проработать отдельно в зависимости от требований.

*Что если элемент не удалось наполнить в соответствии с правилами?*

На начальных этапах коллекция считается валидной только если все элементы в ней удалось наполнить, продукт ок.

### Кастомизация элемента

Мы однозначно хотим определять оверлеи для элементов коллекции, однако потенциально захотим изменять и другие параметры (например, заголовок или подзаголовок).

На данный момент продуктовые допущения таковы:
* Оверлей не зависит от контекста запроса v1/products (т.е. его не нужно "рендерить" и подставлять параметры). При возникновении такого требования можно будет воспользоваться компонентом из https://github.yandex-team.ru/taxi/rfc/pull/473
* Ответственность за "корректность" оверлея целиком на авторе коллекции
* Оверлей не зависит от сработавшего условия матчинга (расширяемо в будущем)

### Пример JSONа с описанием коллекции:

```json
{
    "title_key": "some_collection_title_tanker_key",
    "items": [
        {
            "size": {
                "height": 2,
                "width": 2,
            },
            "one_of": [
                {
                    "type": "scenario",
                    "scenario": "eats_place"
                },
                {
                    "type": "meta_tag",
                    "meta_tag": "weekend"
                },
                {
                    "type": "scenario_meta_tag",
                    "scenario": "eats_place",
                    "meta_tag": "pizza"
                },
            ],
            "customizations": [
                {
                    "type": "overlay",
                    "text": "...",  // used by default
                    "text_key": "...", //  needs to be localized, overrides "text"
                    "text_color": "...",
                    "shape": "sticker|badge",
                    "background": {"color": "..."},
                    // no attributed_text at the moment
                }
            ]
        },
        {
            "size": {
                "height": 2,
                "width": 4,
            },
            "one_of": [ {"...": "..."} ]
        }
        { "...": "..." }
    ]
}
```


## Изменения в API

### Коллекции в ответе блендера

Уже сейчас блендер может отдавать "коллекции" в grid.cells, добавив метаинформацию в grid.blocks.

Для передачи заголовка коллекции можно добавить к блоку опциональное свойство "title", в котором будет содержаться локализованный заголовок.

### Передача оверлеев из блендера

К свойству Shortcut.content в ответе блендера предлагаю добавить опциональное свойство `overlays` https://github.yandex-team.ru/taxi/uservices/blob/681a3ddea8381d7504557fc9960d8aef8e950d37/services/blender/docs/yaml/api/api.yaml#L133

```yaml
Shortcut:
    # ...
    content:
        # ...
        overlays:
            type: array
            items:
                type: object
                additionalProperties: true
```

Сервис `shortcuts` при наличии такого поля будет проксировать значение из него, вместо наклеивания "собственных" оверлеев.

Оверлеи могут приходить как от источника (в будущем), так и проставляться бленедром в результате собирания коллекции

### Передача тегов из источника в блендер

К свойству Shortcut.content предлагаю добавить опциональное свойство `meta_tags` https://github.yandex-team.ru/taxi/uservices/blob/681a3ddea8381d7504557fc9960d8aef8e950d37/services/blender/docs/yaml/api/api.yaml#L133

```yaml
Shortcut:
    # ...
    content:
        # ...
        meta_tags:
            type: array
            items:
                type: string
```

Теги проставляет источник шорткатов, блендер будет использовать их для фильтрации в коллекцию.

### Итого в мвп

* Блендер берет коллекцию из эксперимента
* Пытается её заполнить согласно правилам
  * Если хотя бы одну клетку не получилось заполнить, блендер считает коллекцию "незаполняемой"
* Отдает используя grid.cells/block

## Задачи бекенда

### MVP / Этап 1

* [inapp-communications] Отдавать теги коммуникации в шорткате (1d)
* [blender] Реализация коллекций по эксперименту `superapp_shortcuts_collections`
  * [blender] Базовая реализация с матчером scenario (?d)
  * [blender] Реализация матчера meta_tag (?d)
* [shortcuts] Доподдержать коллекции в shortcuts (2d) *(здесь, потенциально генерировать псевдошорткат для title)*

### Дальнейшие задачи

Попытался описать какие сервисы мы потенциально будем трогать дальше

* [shortcuts-admin/eda-shortucts/ML?] Разметка meta_tag в шорткатах Еды и Лавки
* [inapp-communications] Перенос `superapp_shortcuts_collections` в ответ inapp-communications/shortcuts
* [blender] Переход на использование коллекций из ответа inapp-communications
* [promotions] Новый тип промо-акций: коллекция шорткатов
* [inapp-communications] Поддержать коллекции из promotions
* [blender] Применять оверлей из коллекции на шорткат
* [shortcuts] Использовать оверлей из шортката

### Места для развития

* Уйти от "коллекция может быть одна, получается из эксперимента" до "есть источник коллекций с ранжированием, который может предоставить несколько коллекций"
* У редактора должна быть возможность переопределять визуальные элементы шортката в коллекции: задать свой подзаголовок, свой оверлей для Еды
* Как сделать формирование секций удобным для редакторов с приемлимой по CPU ценой?