# Продуктовое описание

Тикет в ST: https://st.yandex-team.ru/TAXIPROJECTS-1494

Сейчас кирпичик доставки реализован через диплинк. С этим есть проблемы:

1) Переход на саммари через диплинк возможен из разных состояний приложения, и клиенту необходимо выполнить дополнительную работу при открытии саммари. Поэтому при нажатии на кирпич доставки пользователю показывается "крутилка".
2) По-умолчанию диплинк использует локацию пользователя, а не положение пина.  У диплинка возможны квери-параметры start-lon/lat, однако у них есть проблемы на некоторых устройствах

Кроме того, для кирпича доставки хочется расширять функционал:
* Указывать tariff, а не service_level
* \[Опционально\] Иметь возможность открывать карточку тарифа / вертикали
* \[Потенциально в будущем\] Указывать точку Б / передавать дополнительную метаинформацию

И так далее

## Предлагаемое решение

Заводим новый клиентский тип шортката, удовлетворяющий всем требованиям, просим клиентов сообщать поддержкуо вертикалей в `v1/products`

Пока не рассматриваем расширение `taxi:expected-destination`, т.к. продуктовый кейс для него пока не кристаллизовался.

### Запрос

В корень запроса `v1/products` добавляем объект `supported_vertical_types` аналогично `/zoneinfo`.

В `shortcuts.supported_features` добавляем клиентский тип `taxi:header-summary-redirect`

### Ответ

Пример нового типа шортката

```json
{
    "type": "taxi:header-summary-redirect",
    "title": "Доcтавка",
    "icon_tag": "taxi_delivery_icon_tag",
    "width": 3,
    "height": 1,
    "background": {
        "color": "#F1F0ED"
    },
    "action": {
        "class": "express", // optional
        "vertical": "vertical_id", // optional
        "state": "expanded|collapsed|anchored", // optional, default collapsed
    }
}
```

* Внешние параметры отображения аналогичны `header-deeplink`
* При нажатии на такой шорткат необходим переход на саммари в точке пина

**action.class**

Аналогичен `class` из /zoneinfo.max_tariffs.class, клиент должен перейти на саммари с выбором этого тарифа

> Что если `action.class` отсутствует на саммари?

Нужно реализовать фоллбек на "обычный" переход на саммари с использованием тарифа из `personalstate` и отправить событие в аппметрику.

**action.vertical**

Идентификатор вертикали из /zoneinfo.verticals, см. https://github.yandex-team.ru/taxi/rfc/pull/337

> Что если `action.vertical` отсутствует на саммари?

**SIC**: это крайне вероятная ситуация, нужно реализовать фоллбек перехода на саммари к тарифу `action.class` (если есть) и отправить событие в аппметрику.

**action.state**

Форсирует раскрытие тарифа (для карточек аналогично кнопке `i`) на саммари.
При поддержке клиентом вертикалей возможны три состояния из https://wiki.yandex-team.ru/users/irbis/notes/taxi/Verticals/ : `collapsed`, `anchored`, `expanded`.

Если клиент не поддерживает вертикали, возможны состояния `collapsed` и `expanded`.

По-умолчанию `collapsed`.

### Кейсы

#### Отсуствуют и `class`, и `vertical`

Это баг на бекенде, нужно реализовать фоллбек на "обычный" переход на саммари и отправить событие в аппметрику.


#### Присутствуют и `class`, и `vertical`

Это валидный кейс, нужно перейти на саммари с выбором конкретного класса в конкретной вертикали (в теории один класс может принадлежать нескольким вертикалям)

### Реализация на бекенде

#### Когда использовать "нативный" кирпичик для доставки

В эксперимент эксперимент3.0 `superapp_bricks_appearance` добавляем ключ-значение вида:
```json
{
  "taxi_header_delivery": {
    "enabled": true,
    "icon_tag": "shortcuts_bricks_courier",
    "title_key": "superapp.delivery.service_name",
    "background_color": "#F1F0ED",
    "active_text_color": "#000000",
    "disabled_text_color": "#AAAAAA",
    "class": "express",
    "vertical": "delivery",
    "state": "expanded"
  }
}
```

Шорткат с типом `taxi:header-summary-redirect` должен использоваться для кирпичика Доставки **вместо** `header-deeplink` при выполнении следующих условий:
1) Клиент поддерaживает тип `taxi:header-summary-redirect`
2) В эксперименте `superapp_bricks_appearance` значение `taxi_header_delivery.enabled` равно `true` (это значение необходимо добавить, по-умолчанию оно равно `true`. Использоваться будет как рубильник)

Если условия не выполняются, использовать `header-deeplink`.

Значения для `class`, `state`, `vertical` брать из эксперимента.