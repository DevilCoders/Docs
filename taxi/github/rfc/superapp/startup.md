## Бизнесовая задача

### Описание

Клиенты выносят всю реализованную логику взаимодействия с супераппом в SDK
[Ссылка на тикет с продуктовым описанием](https://st.yandex-team.ru/TAXIPROJECTS-1017).
Для этого SDK необходимо реализовать новую логику проверки авторизации и сообщения клиентам основных  
https://st.yandex-team.ru/TAXIBACKEND-25750

### Гипотеза

https://wiki.yandex-team.ru/yandexmobile/browser/tz/eda/#kljuchevyemetriki

### Дизайн

https://wiki.yandex-team.ru/yandexmobile/browser/tz/eda/#pp
https://www.figma.com/file/M3z7br7BiAO72ARJNT7haL/%D0%95%D0%B4%D0%B0-%D0%B2-%D0%9F%D0%9F-%D0%B8-%D0%91%D1%80%D0%BE?node-id=0%3A1

### Продуктовые ограничения

#### Этап 0

## Архитектура

### Высокоуровневая архитектура
https://wiki.yandex-team.ru/yandexmobile/browser/tz/eda/eatssdkauth

### Backend-Компоненты 
![Диаграмма](/superapp/startup.png)

### API

Ручка `/4.0/startup`:

Ручка меняет свое поведение в зависимости от наличия/отсутствия двух передаваемых полей от клиента: токена и user_id
> стоит отметить, что во всех валидных случаях ручка должна отдавать 200 и инициализационные параметры superapp'а 
> - 500 в ответе подразумевает какую-то нештатную ситуацию, в рамках которой суперапп недоступен
> - 403 в ответе подразумевает проблемы с авторизацией, причинами которой могут быть антифрод, просроченный токен

Рассмотрим разницу в поведении (`+` - поле присутствует и валидно, `-` - поле отсутствует)

1. Токен: +, UserId: + <br>
* `P-A` стандартным образом валидирует пользователя + валидирует номер телефона по его дате валидации (будет сделано по https://st.yandex-team.ru/TAXICOMMON-1549) <br>
`startup api-proxy` осуществляет лишь поход за заказами (ручка `/multiorderstate`) + забирает данные из экспериментов 3.0 (`superapp_parameters`) и отдает информацию клиентам, однако может измениться логика в зависимости от валидности/невалидности телефона
  * Телефон валиден <br>
    * возвращается `"authorization_status": "authorized"`
    * `startup api-proxy` осуществляет поход за заказами в `/multiorderstate` в случае, если телефон валиден
  * Телефон невалиден <br>
    * есть активные заказы - возвращается `"authorization_status": "authorized"`
    * нет активных заказов - возвращется `"authorization_status": "phone_confirmation_required"`

2. Токен: +, UserId: - <br>
**Продуктово данный флоу означает следующее**: во внешнем приложении клиент авторизован через паспорт, но пока не зарегистрирован в нашей системе (т.е. первое обращение нового пользователя в ручку startup)<br>
данный флоу требует доработок со стороны `P-A` (необходимо научиться работать без user_id) + в launch будет реализована возможность похода в паспорт не только по токену, но и по уиду.
Данный функционал реализуется по таске: https://st.yandex-team.ru/TAXIORDER-613 (вынос launch за api-proxy) <br>
Таким образом:
* `P-A` ходит в паспорт, получает данные о пользователе, прокидывает их хедерами в `startup api-proxy`
* `startup api-proxy` осуществляет поход в launch (при этом проксирует хедеры от `P-A`) для генерации user_id 
  * Телефон валиден <br>
    * возвращается `"authorization_status": "authorized"`
    * `startup api-proxy` не осуществляет поход за заказами в `/multiorderstate`
  * Телефон невалиден <br>
    * возвращается `"authorization_status": "phone_confirmation_required"`

3. Токен: -, UserId: + <br>
**Продуктово данный флоу означает следующее**: пользователь неавторизован, и у него выписан временный user_id (поздняя авторизация)<br>
* `P-A` в данном случае работает по флоу 'allow-late-login' 
* `startup api-proxy` не осуществляет поход в launch и не осуществляет поход за заказами

4. Токен: -, UserId: - <br>
**Продуктово данный флоу означает следующее**: пользователь неавторизован, и у него еще не выписан временный user_id (поздняя авторизация)<br>
* `P-A` в данном случае работает по флоу 'proxy-401' 
* `startup api-proxy` осуществляет поход в launch чтобы выписать user_id и не осуществляет поход за заказами

### Изменения в `P-A`

#### Валидация телефона (https://st.yandex-team.ru/TAXICOMMON-1549)
В рамках проверки валидации телефона предлагается добавить в `P-A` флаг
"validate_phone": true/false
по которому, `P-A` будет проверять дату подтверждения телефона из паспорта (по аналогии с ф-ей GetPhoneConfirmationState)

#### Работа с пользователями без user_id (https://st.yandex-team.ru/TAXIORDER-613)
будет реализовано в рамках выноса launch за api-proxy

### Нагрузка
У кого можно уточнить - @nufina

RPS, на который нужно расчитывать
1500 rps - ПП https://yasm.yandex-team.ru/panel/dkhlynin.morda_searchapp/

к цифрам надо закладывать запасы:
минус ДЦ
спецсобытия (2х)

**TODO:** 
более точно определить кол-во рпс при запуске по зонам/регионам (утвердить какие-то первоначальные планы у менеджмента)

### Внешние сервисы

#### Используемые сервисы
1) `P-A`
2) `api-proxy`
3) внешние сервисы супераппа 

##### Этап 1:
* используем protocol /3.0/launch для того, чтобы создать пользователя
* не ходим в `multiorderstate` вообще (и не реализуем его) - клиенты ходят по-старому в tracking сервиса напрямую

##### Этап 2:
* используем zalogin (у команды инфраструктуры есть планы по переносу туда создания пользователей)
* из `multiorderstate` ходим только в еду за трекингом заказа (других сервисов пока нет)

### Клиентская логика

https://wiki.yandex-team.ru/yandexmobile/browser/tz/eda/eatssdkauth/

### Отказоустойчивость

Недоступность `4.0/startup` - приводит к недоступности супераппа во внешних сервисах (не происходит инициализации супераппа)
* недоступность протокола (/3.0/launch) приводит к невозможности создать новых пользователей - /4.0/startup пятисотит для кейсов когда на клиентах нет user_id
* недоступность внешних сервисов по трекингу заказа (в нашем случае еда) не приводит к недоступности ручки /4.0/startup

### Мониторинги, алерты, бизнесовые графики, логи

Бизнесовые:
- кол-во заказов еда/лавка (в payments-eda нужно будет реализовать разделение статистики по user-agent'у источнику, если это еще не сделано)

Технические:
- работоспособность api-proxy
- работоспособность протокола / рпс `/3.0/launch`
- работоспособность конечных ручек трекинга
- под вопросом, но хорошо бы мониторить кол-во попаданий в флоу 1-4 (по токенам / user_id), чтобы понимать оперативно какую-нибудь проблему 

### Технические ограничения

В плане RPS пока что кажется что никаких проблем api-proxy / P-A проблем не испытывают <br>
особо тщательно надо будет следить за 
- протоколом (раскатывать ППЯ нужно будет маленькими батчами, чтобы единовременное кол-во регистраций не положило протокол)
- внешими системами (трекинг еды)

### Как раскатываем

#### Раскатка этапа 1

В рамках первого этапа планируется внедрение в ППЯ (поисковое приложение Яндекса)

Продуктовая раскатка этапа будет осуществляться возможностями ППЯ

#### Техническая раскатка

В рамках технической раскатки планируется добавление следующих экспериментов-конфигов:
* `superapp_startup_user_creation` - по которому можно будет отключить походы в protocol (таким образом мы отключаем технически отображение супераппа у пользователей без user_id)
* `superapp_startup_orders_tracking` - по которому можно будет отключить в трекинг к конкретному сервису (таким образом можно будет отключить поход в сервис, в случае проблем на их стороне)

TODO на новые этапы: возможно стоит подумать о интеграции с сервисом статистики / реализацией circuit breaker
TODO: список кваргов

### Безопасность

С точки зрения безопасности - во многом повторяется логика launch по инициализации пользователей. По сути /4.0/startup просто инкапсулируем логику launch + добавляет походы за экспериментами суперапп.