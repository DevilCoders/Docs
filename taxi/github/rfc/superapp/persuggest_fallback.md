# Проблема

При падении сервиса persuggest у пользователей пропадают шорткаты и, как следствие, суперапп целиком.

# Почему так

Шорткаты в клиентском приложении отображаются при получении в `*suggest` ручках эксперимента `superapp_shortcuts` https://tariff-editor.taxi.yandex-team.ru/experiments3/show/superapp_shortcuts.
При падении persuggest не происходит возврата typed_experiments в ответе `*suggest` ручек, и, как следствие, у пользователей пропадают шорткаты.

# Решение

## Этап 1 — при падении persuggest возвращать typed_experiments из другого сервиса

Эксперимент `superapp_shortcuts` имеет следующих консумеров:
* client_protocol/suggest_pin_drop
* client_protocol/suggest_finalize
* persuggest/finalsuggest
* client_protocol/suggest_geomagnet
* client_protocol/suggest_redirect

Это значит, что необходимо будет внести изменения в две api-proxy ручки:
* 3.0/suggest
* 4.0/persuggest/v1/finalsuggest

### Вариант 1 — через exp3-matcher [развиваем]

Все ручки, в которых приходит superapp_shortcuts стоят за апи-прокси, поэтому можно реализовать фоллбек typed_experiments аналогичный 3.0/launch:
* Если персаджест отключен или в его ответе отсутствует typed_experiments
* Сходить в exp3-matcher за typed_experiments

#### Какой консумер использовать?

Используем `"client_protocol/suggest_" + request.body.action`

#### Какие кварги передавать?

* `is_fallback` — форсируем `true` чтобы была возможность создавать явно-фоллбечные клозы и отличать фоллбечный матчинг

Используемые в superapp_shortcuts кварги / их передача будет выглядеть так:
* `application` — воспользоваться https://st.yandex-team.ru/TAXIEXP-417, если есть проблемы с поддержкой, посмотреть на `value#request-application` в api-proxy
* `version` — аналогично ^
* `country_by_ip` — в рамках этой задачи предлагаю не передавать, в будущем можно воспользоваться трансформацией https://st.yandex-team.ru/TAXIEXP-389 и заголовком `X-Remote-IP`
* `phone_id` — можем взять из PA
* `point_a` — можем взять из запроса (request.body.position при request.body.type == "a") (тут посмотреть как передается в persuggest чтобы повторить пведение)
* `point_b` — ^ аналогично
* `point_eda_region_id` —  дорого брать, в фоллбеке можем пожертвовать, не передавать
* `point_services` — дорого брать, в фоллбеке можем пожертвовать, не передавать
* `point_type` — взять из request.body.type (если request.body.type = oneOf("a", "b"))
* `yandex_uuid` — берем из заголовка X-AppMetrica-UUID
* `zone` — можем взять из `protocol-nearestzone`, который активируется при фоллбеке

Дополнительно, кварг билдер persuggest потребляет следующие легко передаваемые кварги
https://github.yandex-team.ru/taxi/uservices/blob/develop/services/persuggest/experiments3/kwargs_builders/persuggest.yaml :
* `user_id` — из PA
* `yandex_uid` — из PA
* `yandex_device_id` — берем из заголовка X-AppMetrica-DeviceID

**sic** нынешние клозы superapp_shortcuts сильно зависят от кварга `point_services`. Предлагается реализовать "фоллбечный" клоз в superapp_shortcuts, который будет зависеть только от зон. В него добавить как минимум зоны присутствия Лавки (Москва, Санкт-Петербург, Нижний Новгород), как максимум — сконвертировать полигоны Еды в Таксишные зоны, перечислить их все в фоллбечном клозе.

### Вариант 2 — через superapp-misc [отказываемся]

В superapp-misc можно написать ручку, которая будет рассчитывать все необходимые для superapp_shortcuts кварги, и возвращать typed_experiments оттуда. При нерабочем персаджесте брать typed_experiments.superapp_shortcuts из него.

Плюсы такого подхода:
* Передаем все необходимые кварги
* Если нас интересует только superapp_shortcuts, конфиг апи-прокси будет проще

Минусы:
* При фоллбеке каких-то ещё экспериментов сильно усложнится конфиг апи-прокси персаджеста
* superapp-misc — продкутовый и активно развивающийся сервис, его падание более вероятно, чем exp3-matcher

## Этап 2 — отвязать наличие шорткатов от persuggest

Ходить в v1/products независимо от persuggest, что полностью отвяжет шорткаты от персаджеста. На первый взгляд это можно реализовать через перенос эксперимент superapp_shortcuts в v1/products.

Однако это потребует дополнительной проработки с участием мобильных клиентов, т.к. меняет флоу вызова ручек, а также меняет логику выбора главного экрана. Цитируя ihelos@:

> насколько я помню - на клиентах основной проблемой было непонимание того, какой интерфейс отображать до ответа products (во всяком случае мне так объяснили почему нельзя легко реализовать фолбек с шорткатов на список саджестов такси)
> кажется здесь придется подробно пересмотреть флоу взаимодействия клиентов с ручками при сдвиге пина + кажется в рамках этой проработки можно будет подумать о том, чтобы какие-то лишние ручки убрать (насколько я помню, клиенты ходят в обязательном порядке и в zerosuggest и в products)

Итог: прорабатываем это отдельно, вне этого рфц.