## Бизнесовая задача

### Описание

Endpoint для отображения виджетов (шорткатов) на клиентах. Виджеты вызываются с системных экранов (не требуется запуск приложения).

### Что хотим получить

Фичеринг на ios, переходы с виджета в приложение.

## Дизайн

<img src="https://jing.yandex-team.ru/files/ihelos/Widgets.png" width="300"/>

Договорились для MVP показывать ~цену, а не точную (так как не так легко по offer_id восстановить весь саммари, не возвращая все данные из routestats)

Пример недостатка такого подхода (см отличие цен): <br>
<img src="https://jing.yandex-team.ru/files/ihelos/2020-12-02%2022.54.02.jpg" width="300" />
<img src="https://jing.yandex-team.ru/files/ihelos/2020-12-02%2022.54.06.jpg" width="300" />
- продуктово окнуто

### Клиентское API

Концептуальное отличие от шорткатов - 
1) в шорткатах размер выдачи сильно больше, в MVP ожидаем 1 шорткат-виджет, дальше есть планы на отдачу нескольиких (единицы, не десятки) виджетов
2) в виджетах облегченная логика отображения (не нужна работа с сеткой, не нужно задавать размеры виджетов)
3) клиент получает данные по виджету целиком (трудозатратна реализация нескольких запросов)

Ручка `4.0/mlutp/v1/widgets`. Из запроса и ответа можно выкидывать поля, если

```json5
{
   "position": [lon, lat], // pin position
   "state": {
       "selected_class": "<class>", // "econom", "comfort", ...
       "location": [lon, lat]
       "accuracy": "...",
       "known_orders": [   // not required for mvp
           "taxi:<taxi_order_id>:revision", // revision from totw
           "eats:<eats_order_id>",  // maybe not needed now
           "grocery:<grocery_order_id>" // maybe not needed now
       ],
       "l10n": {
           // as in `/suggest` endpoint
       }
   },
  "media_size_info": {
    "screen_height": 1920,
    "screen_width": 1080,
    "scale": 2.5
  }
}
```

Response:
Header:
```
X-Polling-Delay: 3600 // seconds
```

Body:
```json5
{
    "widgets": [
      {
            "id": "some_id",
            "title": "Some title",
            "subtitle": "Some subtitile",
            "background": {
                // при наличии и image_tag и image_url -
                // image_url приоритетнее
                "image_tag": "...", // optional
                "image_url": "...", // optional
                "color": "..."
            },
            "overlays": [
                {
                    "text": "до 5л",
                    "text_color": "#00",
                    "background": {
                        "color": "#fff"
                    },
                    "image_tag": "some-tag-for-poi",
                    "shape": "sticker|bubble|poi"  // allowed shapes depend on shortcut type
                }
            ],
            "action": {
                "type": "deeplink", // только диплинк
                "deeplink": "", 
            },
        }
    ],
    "typed_experiments": {
        "items":[
            {
              "name":"widget_refresh_on_position_diff",
              "value": {
                  "enabled": true,
                  "distance_meters": 5000
              }
            }
        ]
    }
}
```

## Фолбеки клиента
1) при недоступности ручки у клиента есть предыдущая версия виджета - ее можно продолжать отображать
2) если по какой-то причине виджета нет - зашить на клиентах текст, или отдать в typed_experiments в `launch` (TODO - дообсудить)
```json5
{
  "name":"widget_fallback",
  "value": { 
      "field1": "key1", // TODO: необходимы ли переводы?
      "l10n": {
        "key1": "localized text"
      }
  }
}
```

## Общий флоу бэкенд взаимодействия:
<img src="https://jing.yandex-team.ru/files/ihelos/Widget.png" width="600"/>

## Оценка нагрузки
Для понимания читающего приведу следующие цифры:
- Количество уникальных iphone пользователей в dbusers = `36045099` <br>
https://yql.yandex-team.ru/Operations/X8YJCFPzVIxOzKzpRqDM6A2-jAmUKeq78uIkI8ZGhGM= 
- Количество уникальных активных iphone пользователей за ноябрь = `10489740` <br>
https://yql.yandex-team.ru/Operations/X8fBDWim9fe3TUgTG_MeyaVpZg7JmrnssIvF8rSiTNM=
- Количество уникальных активных iphone пользователей за день = `3319638` <br>
https://yql.yandex-team.ru/Operations/X8e85CyLNSobLFRXuSLIVeBGxk_vHau-Dqfq-JUpBcE=

Согласно статье: https://sensortower.com/blog/iphone-widget-apps-month-two - приблизительно 10-15% 
пользователей ios 14 попробовали виджеты

Поэтому считаю, что до 10% пользователей такси смогут использовать виджет.
**Важная особенность** взаимодействия виджета с бэкендом в том, что для запроса в бэк пользователю не нужно открывать приложение.
Достаточно открыть экран меню в телефоне, на котором находится этот виджет. Поэтому рассматриваю не дневных пользователей для оценки, а месячных.
Т.e. 10% от 10 489 740 == считал, что теоретически 1kk пользователей могут поставить виджет.

С перезапросами раз в день (что продуктово не ок) = `~10-40рпс` (эта нагрузка на случай если мы совсем не будем справляться) <br>
С перезапросами раз в 10 минут (что продуктово ок) = `~1000-4000 рпс` (оценка сверху)

<details>
<summary>почему 10 минут</summary>

```
Юрий Болотов, [2 дек. 2020 г., 14:25:53]:
Я поговорил с эффективностью, в целом если раз в пять-десять минут дергать, то вряд ли цена сильно вырастет
Но нам в любом случае на экране виджета нужно не прямо цену писать, а с каким-то уточнением, типа ~157 рублей или «от 157 рублей»
```

</details>

**Итог расчетов:**
- в расчетах очень много условностей;
- интуитивно кажется, что виджетом будут пользоваться сильно меньше людей (например 1% пользователей), и соответсвенно рпс будет не большой (~200 рпс);
- запасной план (пункты в порядке приоритета) на случай если весь мир - ложь, а я ошибся в расчетах: <br>
1) калибровка `X-Polling-Delay` - управление поллингом;
2) управление "перезапросом от изменения расстояния" widget_refresh_on_position_diff;
3) можно кешировать ответ persuggest на уровне api-proxy на продолжительный срок (так мы ухудшим качество саджеста, но позволим пережидать нагрузку);
4) можем не ходить в прайсинг (а например взять запрос полегче, типа route-matrix и возвращать только eta);
5) весь интерфейс виджета настраивается с бэкенда + есть диплинк, теоретически можно будет придумать фолбечный виджет;

<details>
<summary>про обновление саджеста</summary>

```
Женя Зарубкин, [3 дек. 2020 г., 10:19:22]:
Привет! А по времени часто меняется первый саджест в шорткатах?

привет
у нас есть фичи по получасу, то есть может и раз в полчаса по идее
```

</details>

- отвергнутые (почти что) идеи плана Б:
1) можно было бы убрать нагрузку с Persuggest брав избранные адреса, но есть информация `где-то 3 процента - это пользовательские адреса в б`
- на будущее:
1) для дальнейших раскаток новых типов виджетов:
<img src="https://jing.yandex-team.ru/files/ihelos/2020-12-02%2020.44.19.jpg" width="500"/>
можно будет управлять доступностью нового типа виджета например со стороны бэкенда и раскатывать постепенно

## Финальная схема до НГ
<img src="https://jing.yandex-team.ru/files/ihelos/Widget_final.png" width="600"/>

если что-то идет не так см. пункт запасного плана итога расчетов

## Задачи:
1) Реализация тикета в persuggest (по аналогии с шорткатной ручкой) [2-3d]
2) Реализация конфига api-proxy (здесь же все лимиты) [2d]
3) Реализация дашборды с мониторингами ресурсов, алертов по фолбекам [1d]

## Планы на будущее:
1) Несколько виджетов в выдаче (если виджеты полезны);
2) Виджеты для uber;