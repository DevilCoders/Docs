## Бизнесовая задача

### Описание

В Такси, Поисковом приложении Яндекса(ППЯ) и Браузера есть возможность заказать Еду.
- В ППЯ и Браузере Еда работает через специальный EatsSdk, подробнее можно прочитать тут: https://wiki.yandex-team.ru/yandexmobile/browser/tz/eda/eatssdkauth/. Если коротко, то приложение для авторизации ходит в /4.0/startup, а далее все делает веб вью Еды
- В Такси шторка еды для авторизации использует данные такси, напрямую дергая /3.0/launch.

Главная проблема в том, что сейчас заказ Еды не работает для неавторизованного пользователя.
![img](https://jing.yandex-team.ru/files/rgnlax/IMAGE%202020-04-01%2009%3A10%3A29.jpg)

В рамках этой проработки будет рассматриваться возможная реализация флоу неавторизованного пользователя, далее **ФНП**

### Гипотеза

Около половины пользователей срезается по причине авторизации. 
Если давать таким пользователям формировать корзину, а в момент покупки предлагать авторизоваться, то это сильно увеличит заказы.

### Техническая проблема
Для неавторизованного юзера в сервисе Такси документ не хранится в базе. Вместо этого, ему выписывается специальный Zuser-id, который имитирует обычный user-id, но не лежит в базе.
В момент авторизации создается пользователь и к нему прикапыается известный zuser-id. Это позволяет сохранить корзину при авторизации.

#### В Такси

Проблема в Такси возникает из-за специфики авторизации, а именно пользователь всегда авторизуется сначала фонишем, а затем портальным аккаунтом. Авторизация по сути означает запрос в launch со старым user_id, но новым токеном (фонишным или портальным). В случае фониша так и работает, zuser-id сохраняется для фонишной записи.
В случае портальной авторизации дела обстоят иначе. Оба клиентских приложения (ios + android) проводят апгрейд с фониша на портал, через запрос в launch без user_id, но с портальным токеном.
Это старая концепция залогина, описанная тут (https://wiki.yandex-team.ru/taxi/backend/useridentity/):
> Также клиенты после Залогина не передают id=user_id на бэк при смене UID, чтобы новый UID попал в новый документ db.users. Это поведение добавили для поддержки транзакционности при перелогине пользователя из фониша в портал, но потом решили расширить как концепцию для всего флоу авторизации после Залогина.

Так, как фонишный user_id не передается в запрос апгрейда, бэкэнду неоткуда достать zuserid и соответственно корзина при таком действии теряется.

Может показаться, что таких кейсов довольно мало, то на самом деле нет. Сразу после авторизации фонишем Такси предлагает навязчиво связаться фулскрином:
![img](https://jing.yandex-team.ru/files/rgnlax/IMAGE%202020-04-01%2009%3A33%3A58.jpg)

Кажется, таких кейсов достаточно много, что проблему нельзя игнорировать.

В такси нужно поддержать шорткаты -- для этого есть такой тикет: https://st.yandex-team.ru/TAXIBACKEND-27216
Коротко: шорткаты нормально заводятся для неавторизованного пользователя и показывают Еду.


#### В Бро и ППЯ

В этих приложения сущестует только портальная авторизация. Авторизация работает через ручку /4.0/startup.
Стартап под капотом работает как лонч, если ему передавать user_id и токен, он проведет все нужные связки.
В ППЯ нужно поддержать ФНП совместно с EatsSdk и браузер автоматически заработает. 
Тажке нужно поддержать плавную раскатку через флажок allow_late_login в стартапе

## Решение 

### Этап 0

#### Правка в ППЯ
- Поддержать отсутствие авторизации в ППЯ (всегда отправлять zuserid в стартап)
- Поддержать флажок allow_late_login для А/Б тестирования
- Поменять хосты для балансировки с rate-limit
Так как прогрев сопровождается ростом rps до 2000, необходимо ходить в наш бэкенд через балансировщик с rate-limit. 
Для этого нужно поменять хосты. Подробнее тут: https://st.yandex-team.ru/TAXICOMMON-2064.

#### Правки в EatsSdk
Поддержка для корректной работы с ФНП.
Точные правки будут обсуждаться ППЯ с Едой.


#### Правка в startup
Стартап сейчас ходит в протокольный лонч, неоходимо аккуратно (под экспериментом) перевести его на сервис zalogin.
Подразумевается правка в api-proxy. Необходимо убедиться, что установлена опция allow_late_login на стороне PA.

Для плавной раскатки, в ответе стартап необходимо возвращать признак, что доступен ФНП.
Предлагается модифицировать протокол так:
```{
  "authorization_status": "authorized",
  "orders": [],
  //НОВОЕ ПОЛЕ
  "allow_late_login": true,
  "parameters": {
    "api_base_url": "https://tc.mobile.yandex.net/4.0/",
    "billing_base_url": "https://pcidss.yandex.net/api/",
    "eats": {...},
    "grocery": {...},
    "l10n": {...},
    "support_info": {...},
    "tracking_api": "https://tc.mobile.yandex.net/4.0/eda-superapp/api/v2/orders/tracking",
    "tracking_polling_interval": 600,
  }
}
```
Значение можно положить в parameters через эксперимент
https://tariff-editor.taxi.yandex-team.ru/experiments3/show/superapp_parameters_startup_ru?type=experiments&consumer=api-proxy%2F4.0%2Fstartup, но тогда будет сложнее раскатывать его на разную аудиторию, так придется на все группы дублировать body эксперимента


#### Правка в сервисе zalogin
От сервиса залогина требуется научиться связывать zuser-id к портальному документу. 
Для нормального решения требуется передавать с клиента user_id. 
Для кейсов, когда пришли без user_id, но с портальным токеном нужно:
- Достать все привязанные фониши к данному порталу
- Найти наиболее подходящий среди них с zuser-id
- Сохранить найденный zuser-id в новом портальному документе

Наибольшую сложность представляет найти наиболее подходящий фониш.
![img](https://jing.yandex-team.ru/files/rgnlax/Снимок%20экрана%202020-04-01%20в%2010.29.38.png)
По итогам исследования (https://yql.yandex-team.ru/Operations/XoRACp3udgiKJ1fQhhsrpK7BHlfxRnMUNiK3o51H2jw=) 90% порталов имеют 1 привязанный фониш 
Есть и странные кейсы, но их немного:
![img](https://jing.yandex-team.ru/files/rgnlax/Снимок%20экрана%202020-04-01%20в%2010.30.27.png)

То есть в большинстве случаев, задача сводится к просто найти фониш, в остальных можно смотреть по updated.

### Этап 1

#### Правки в клиентах Такси
При апгрейде с фониша на портал необходимо отправлять user_id в launch.
При логауте удалять предыдущий известный user_id

#### Правки в сервисе zalogin
Требуется нормально решение внутри zalogin.
Предлагается реализовать схему, предложенную Олегом Ермаковым
![img](https://jing.yandex-team.ru/files/rgnlax/IMAGE%202020-04-01%2010%3A32%3A49.jpg)

1. Когда клиент приходит с user_id + портальный токен, создавать нового пользователя
2. В момент логаута также создавать нового юзера.

### Отказоустойчивость

Недоступность `4.0/startup` - приводит к недоступности супераппа во внешних сервисах (не происходит инициализации супераппа)
* прогрев ППЯ приводит к +2000rps, ручка zalogin должна выдержить, в противном случае суперапп будет недоступен. Прогрев выключен сейчас.

### Мониторинги, алерты, бизнесовые графики, логи

Бизнесовые:
- в payments-eda нужно реализовать разделение статистики по user-agent'у источнику
https://grafana.yandex-team.ru/d/fz-8s71Zk/payments-eda?orgId=1

Технические:
- работоспособность api-proxy
- работоспособность zalogin / рпс `/4.0/startup`
- количество новых пользователей в dbusers 

### Технические ограничения

В плане RPS пока что кажется что никаких проблем api-proxy / P-A проблем не испытывают <br>
особо тщательно надо будет следить за 
- серивисом zalogin, так как лонч ходит в залогин, есть риск положить и Такси

### Как раскатываем

#### Раскатка этапа 0
- Перевод стартапа на ручку залогина.
Делаем под экспериментом в первую очередь. Спецэффектов не ожидается

- Добавляем в ответ стартапа allow-late-login под экспериментом.

- ППЯ + Бро поддерживает новые хосты + late-login

- Теперь мы можем нашим экспериментом включать в ППЯ late_login.
    + Включаем эксперимент в сервисе залогин для zuser_id
    + Включаем late-login на ту же группу пользователей

- Включаем late-login для Такси.


#### Раскатка этапа 1
Аккуратно под экспериментом переводим клиентов
Детальная проработка будет позже.

### Безопасность

С точки зрения безопасности - ничего не изменяется


### Скоуп
#### Этап 0
Такси:
- [2d] Правка в zalogin 
- [2d] Правка в startup 
- [2d] Мониторинг заказов
- [2d] Список ручкек в /4.0/superapp без авторизации
- [?] Нарастить мощность сервиса zalogin

ЕatsSdk:
- Поддержать X-Taxi-User-Ids 

Фронт Еды:
- Перезагрузка веб вью при авторизации

Бэкенд Еды:
- Поддержать перенос корзины

ППЯ:
- Поддержать плавную раскатку через флаг в стартап
- Поддержать ФНП (Правильно отправлять user_id)
- Поменять хосты
