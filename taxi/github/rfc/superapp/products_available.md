## Опросник для ревью комитетом

> Этот опросник нужен для [архитектурного ревью комитетом](https://forms.yandex-team.ru/surveys/25357/). Его можно будет скопировать.

**Название сервиса**

superapp-core

**Какую продуктовую проблему решает сервис?**

В рамках разработки супераппа, постоянно появляется необходимость дописать какой-то функционал, который:
1. Слишком сложный для **api-proxy**
2. Слишком маленький для создания отдельного сервиса

Примеры:
1. available-payment-types - доступность зон
2. Шаблонизация переводов для `v1/startup`
3. Принятие решения по поводу доступности сервисов супераппа

**Почему нельзя решить эту задачу без разработки нового сервиса существующими решениями?**

В данный момент для решения данной задачи используются experiments3.0, но есть проблемы с консистентностью данных о доступности. Например, у Еды, в зависимости от времени суток, меняются зоны доставки, что сложно учесть с помощью текущего инструмента. 
Новый сервис позволит добавить собственную логику доступности сервисов для проведения A/B тестов.

**Как именно сервис будет решать поставленные перед ним задачи?**

Сервис будет заниматься управлением состоянием супераппа

**Разрабатывается один сервис или система?**

Сервис

**С кем взаимодействует сервис?**

На данный момент сервис будет использовать experiments3.0 для обогащения данными ответов других сервисов

**Какие базы использует?**

Базы не использует

**Какие периодические процессы?**

Переодические процессы не используются

**Прикрепите схему того, где этот сервис находится в текущей инфраструктуре**

На основной цикл заказа не влияет

**Какая нагрузка ожидается?**

Ожидается нагрузка от 2000 RPS на ручку `v1/availability`, это рассчитано следующим образом:
1. Количество рпс из такси соответствует ручки `3.0/suggest` && `3.0/finalsuggest` (1к)
2. ППЯ - по средним прикидкам от коллег из Большого Яндекса, получается около 1к

**Какие фолбеки предусмотрены на сам этот сервис?**

В api-proxy, в качестве фолбека на сервис, будем собирать ответ из эксперемента3.0.
При недоступности данной ручки/сервиса, происходит отключение показа супераппа в приложениях.

**Какие фолбеки предусмотрены внутри этого сервиса на взаимодействие с другими сервисами?**

Отказ ручки доступности сервиса Еды:
- Отключаем показ еды и лавки в супераппе / Используем значение из эксперемента;

Фолбек шорткатов описан в соседнем rfc.

**Какие возможности масштабируемости закладываются?**

Проработка API с учётом неограниченного количества сторонних сервисов

**Какие точки отказа есть в сервисе?**

Внешние сервисы:
1. http://catalog-service.c3po.eda.tst.yandex.net/
2. Сервис лавки (в разработке)

При недоступности внешних сервисов будет включаться фолбек.

**Укажите технические метрики**

core-files, 500, 499 ошибки

**Какая функциональность ожидается в сервисе в будущем?**

Этапы разработки:

1. Переход от эксперементов к ручке доступности сервисов -  7д
   * Логика api-proxy - 3д
   * Новый сервис с ручкой `v1/availability` - 4д

**Какое изменение нагрузки планируется?**

Нагрузка будет изменятся в соответствии с ручкой `3.0/finalsuggest` + неопределённое количество нагрузки со стороны ППЯ

**Активно ли будет изменяться сервис?**

Планируется, что данный сервис будет точкой входа супераппа в такси


## Бизнесовая задача

Решаем проблему неконсистентности состояния между реальной доступностью сервисов и доступностью сервисов в супераппе.

### Продуктовые ограничения

#### Этап 1

1. Переносим логику из `superapp_screens` experiments 3.0

## Архитектура

Будем использовать существующую ручку в api-proxy `4.0/mlutp/v1/products`, которая будет агрегировать данные из ручек доступности всех сервисов супераппа и передавать в ручку `v1/availability` сервиса `superapp-core`, а также заниматься формированием шорткатов.

В рамках первого этапа, в качестве источника будет использоваться ручка еды `v1/availability`

![superapp_core](https://jing.yandex-team.ru/files/ulturgashev/superapp_core.png "Архитектура")

### API

POST ручка api-proxy `4.0/mlutp/v1/products`:

#### Коды ответов:
- `200` - ok
- `5xx` - Ретраим 1 раз с задержкой 300мс, кроме 503(на ios, на 503 ответ ретраев не происходит)

Устройство рейтраев на Android клиентах:

Вычисление задержки между следующим запросом происходит по следующей форуле:

`delay = 500 * 2^N ms, где N in [0, M]`

`N = rand(0, min(r - 1, M))` , где r - номер текущего ретрая r in [1, k], M = 4 - выбрана эмперически

request
```json
{
    "position": [lon, lat],
    "shortcuts": {
        "supported_types": ["taxi:expected-destination", "deeplink"] // No shortucts if shortcuts.supported_types is not sent
    },
    "state": {
        "screen_type": "main",  // "main" | "on_order"
        "known_orders": [
            "taxi:<taxi_order_id>:revision",
            "eats:<eats_order_id>",
            "grocery:<grocery_order_id>"
        ],
        "fields": [{
           "type": "a",
           "position": [lon, lat],
           "uri": "ymapsbm1:\/\/org?oid=1351660327",
           "entrance": "6"
        } /* "b", "mid1", "mid2", etc */]
    }
}
```

response
```json
{
    "modes": [
        {
            "mode": "taxi",
            "parameters": {
                "product_tag": "taxi",
                "available": true,  // доступность сервиса в данной точке
                "teasered": true,  // использовальзовать ли teaser для данной карточки optional
                "teasering_factor": 0.1,  // optional
                "show_splash": true,  // показ сплеша, optional
                "show_disabled": true,  // показывать ли карточку при недоступности сервиса, optional
            },
            "offers": ... // shortcuts
        },
        {
            "mode": "eats",
            "state": {
                ...
            }
        },
        {
            "mode": "grocery",
            "state": {
                ...
            }
        }
    ],
    "products": [
        {"tag": "taxi", "service": "taxi", "title": "Yandex.Taxi"},
        {"tag": "eats", "service": "eats", "title": "Yandex.Eda"},
        {"tag": "grocery", "service": "grocery", "title": "Grocery"}
    ]
}
```

POST ручка superapp-core `v1/availability`:

request
```json
{
    "position": [lon, lat], // pin position
    "state": {
        "screen_type": "main",
        "known_orders": [
            "taxi:<taxi_order_id>:revision",
            "eats:<eats_order_id>",
            "grocery:<grocery_order_id>"
        ],
        "fields": [{
           "type": "a",
           "position": [lon, lat],
           "uri": "ymapsbm1:\/\/org?oid=1351660327",
           "entrance": "6"
        } /* "b", "mid1", "mid2", etc */]
    },
    "services": [
        {
            "type": "eats",
            "is_available": true
        },
        {
            "type": "grocery",
            "is_available": true
        }
    ]
}
```

response
```json
{
    "modes": [
        {
            "mode": "taxi",
            "parameters": {
                "product_tag": "taxi",
                "available": true,  // доступность сервиса
                "teasered": true,
                "show_splash": true,  // optional
                "teasering_factor": 0.1,  // optional
                "show_disabled": true,  // optional
                // переключает поведение дисмисса карточки супераппа
                // default иили отсутвие - означают старое поведение поведение (когда после скрола карточка дисмиссится сразу)
                // hide_or_bounce - новое поведение, когда перед скрытием будет работь bouncing
                "hide_strategy": "default" | "hide_or_bounce", // optional
                // Переключает поведение ресайза карточки супераппа при скролле или других событиях:
                // default или отсутствие - означает старое поведение (карточка имеет фиксированный размер и позицию, вне зависимости от скролла или других событий)
                // resize_along_scroll_axis - новое поведение: карточка меняет размер и позицию при скролле контента внутри нее:
                // - разворачивается на max размер при скролле контента в карточке вниз
                // - сворачивается в min размер при свайпе/скролле контента в карточке вверх
                "resize_strategy": "default" | "resize_along_scroll_axis" // optional
            }
        },
        ...
    ],
    "products": [
        {"tag": "taxi", "service": "taxi", "title": "Yandex.Taxi"},
        {"tag": "eats", "service": "eats", "title": "Yandex.Eda"},
        {"tag": "grocery", "service": "grocery", "title": "Grocery"}
    ]
}
```


### Клиентская логика

- Ручка `4.0/mlutp/v1/products` дёргается последовательно с ручкой `finalsuggest`, необходимо передавать все известные точки маршрута (A, B и промежуточные) в `state.fields`;
- При смене состояния заказа(создание, изменение точки Б), необходимо передёрнуть ручку с новыми точками, чтобы обновить статус;
- Клиент всегда дёргает ручку со всеми имеющимися точками маршрута(a, b, mid1, ...)
- Клиент должен передавать признак текущего экрана

|эксперементы| | |
|--|--|--|
|products|superapp_shortcuts||
|False|False| доступность берётся из superapp_screens, шорткаты отключены (необходимость запроса ручки - отсутствует) |
|False|True| доступность берётся из superapp_screens, шорткаты включены |
|True|False| доступность берётся из v1/products, шорткаты отключены |
|True|True| доступность берётся из v1/products, шорткаты включены |


ППЯ:
- Необходимо дёргать данную ручку с интересующей координатой

### Технические ограничения

### Как раскатываем

Расскатываем с помощью клиентского эксперемента3.0 в launch `products` со значением:
```
{
  "enabled": true
}
```

Данный эксперемент определяет, является ли `v1/products` источником доступности сервисов

### Безопасность

Личные данные пользователей не храним
