# Новый экран "выбора парков" + новая точка входа в саморег Еды/Лавки

Связанные задачи:
- проект: https://st.yandex-team.ru/TAXIMETER-11920
- бэк:  https://st.yandex-team.ru/TAXIMETERBACK-12193
- фронт: https://st.yandex-team.ru/TAXIMETER-11920
## Мотивация

### Контекст
Сейчас идет перевод курьеров Еды на работу через Про (вместо старого приложения курьеров Еды).
Также мы активно привлекаем новых курьеров в Еду и рассылаем коммуникации вида "Просто поставь Про и начни работу курьером Еды".

Сейчас флоу логина в Про выглядит так:

- Пользователь вводит номер телефона, затем вводит код подвтверждения (из СМС или по flash-call). После этого, приложение получает с бэка список аккаунтов, доступных для логина.

- Если у исполнителя только один активный аккаунт на этом телефоне, то он сразу логинится в приложение, т.е. видит карту.

- Если у него несколько активных аккаунтов, то он сначала видит промежуточный экран "Выбор парка", где он должен выбрать тот аккаунт, в который он хочет войти.
Аккаунты он различает между собой по названию парка. Для СМЗ водителей "парк" называется просто "Самозанятый".

### Как выглядит дизайн сейчас
![Old park selection screen](/partners/driver-login/images/oldlist.jpg)

### Проблемы

1. На текущий момент, около 15% курьеров Еды также имеют аккаунт в Я.Про. Т.е. они работают курьерами Еды через старое приложение, и также работают водителями/доставщиками через Я.Про. Если такой исполнитель, после переноса его аккаунта в Про, зайдет в приложение, то он увидит экран "Выбор парка" и для него может быть не очевидно, какой из аккаунтов относится к  работе обычным курьером, а какой относится к Еде.

2. В Про есть флоу саморегистрации, в котором можно стать курьером Еды, но он показывается только тем исполнителям, у которых на логине вообще нет активных аккаунтов - т.е. пришедшим впервые и уволенным. Если исполнитель, у которого уже есть активный аккаунт в Про, увидит коммуникацию "Стань курьером Еды" - ему будет непонятно как это сделать - ведь после ввода телефона он сразу логинится, минуя саморегистрацию.

3. Помимо проблем с курьерами Еды, еще есть предположение, что старый дизайн экрана "Выбор парка" в принципе неудобен для исполнителей с несколькими аккаунтми, ибо на нем показаны все парки вперемешку, и по названию парка может быть непонятно, какой тип работы в нем доступен.

## Предложение

1. Меняем экран "Выбор парка" на "Вид деятельности".
На нем показываем доступные парки списком, разбитым по "типам работы".
Категории:
- Такси (развоз пассажиров)
- доставка (пешие и авто-курьеры)
- Курьеры Еды

2. Внизу экрана показываем кнопку "Стать курьером Еды" (только если у него еще нет активного аккаунта в Еде). Показываем ее только в тех городах, где есть такая возможность.
Нажатие на кнопку открывает веб-вью с формой регистрации курьера Еды: https://reg.eda.yandex/?utm_source=yandex_pro

3. Показываем этот экран даже тем исполнителям, у которых только один аккаунт (но не всегда, см. ниже).

### Варианты нового дизайна

![New park selection screen](/partners/driver-login/images/newlist.png)

Окончательный вариант будет выбран по итогам UX-тестирования.

## Альтернативы
- Кажется, что категории парков отображать больше и негде, кроме как на том же экране где и обычно.
- По поводу привлечения курьеров Еды - можно показывать баннер "Станьте курьером Еды" в профиле водителя (и в первое время, так и будет).
Однако баннер - это не системное решение. В профиле на так много места для баннеров, он может быть скрыт другим, более приоритетным баннером.
Мы должны обеспечить для новых Курьеров максимально простой флоу - скачал Я.Про, ввел телефон, зарегался курьером.

## Риски

### Лишний экран, которого раньше не было
Поскольку новый экран начнет показываться исполнителям даже с одним аккаунтом, это может вызывать у них раздражение: лишний экран, лишний клик после ввода телефона.

Поэтому таким исполнителям мы не будем показывать этот экран вечно. Мы будем сохранять на бэке кол-во показов этого экрана исполнителям, и если они так ни разу и не тапнули на вариант "Стать курьером" после N показов, то больше не будем показывать им этот экран (см. раздел "Реализация").

### Каннибализация сапплая
Если больше водителей станут работать курьерами Еды, они могут перестать возить пассажиров/доставки.

Считаем, что это допустимо. Если человек сменил работу водителем на работу курьером Еды, значит работа водителем ему не нравилась (по любым причинам). И он бы мог уйти из нашего сервиса вообще. А так он начнёт работать у нас же.

## Реализация

Меняем формат списка парков, доступных для логина, который отдаёт ручка `/v1/driver/login`.

Для этого заводим новый шаг (step) вида `select_db_categorized` на замену `select_db`.

Начинаем отдавать новый формат ответа, если пользователь попал в эксперимент 3.0 на бэке.

### API

```
type: object
additionalProperties: false
required:
    - step
    - token
    - domains_by_category
properties:
    step:
        type: string # 'select_db_categorized'
    token:
        type: string
    title:
        type: string # Заголовок/подзаголовок всего экрана теперь передаем с бэка.
    subtitle:
        type: string
    domains_by_category:
        type: array
        items:
            type: object
            additionalProperties: false
            required:
              - category_type
              - category_title
              - category_subtitle
              - items
            properties:
                category_type:
                    type: string # e.g. 'taxi', 'delivery' etc
                category_title:
                    type: string # e.g. "Такси" или "Доставка"
                category_subtitle:
                    type: string # e.g. "Возите пассажиров" или "Доставляйте посылки"
                items:
                    type: array
                    items:
                        $ref: '#/definitions/LoginParkListItem'
    become_eats_courier: # опциональное поле
        type: object
        additionalProperties: false
        properties:
            title:
                type: string
            url:
                type: string # ссылка на форму регистрации
```


### Клиентская логика
Получив ответ с шагом `step = select_db_categorized` Я.Про поймет, что нужно показать новый вид экрана (более старые версии Я.Про в эксперимент не попадут).
Отображем список парков, разбитый по категориям и тексты с бэкенда.
Также отображаем кнопку "Стать курьером Еды", если в ответе есть поле `become_eats_courier`.

Если Я.Про получит старый формат ответа (т.е. `step = select_db`), то обработает по старой логике, т.е.
- если там только один аккаунт - то сразу логинимся в него, без промежуточного экрана
- если несколько аккаунтов - то показываем старый формат экрана "Выбор парка".

### Логика бэкенда
#### Категоризация парков
Когда собираем парки водителей для показа, разбиваем их по категориям по следующей логике:
- сначала смотрим по конфигу парков Еды - если он в конфиге, то считаем что это парк Еды, остальное не важно. Возвращем его в категории `eats_courier`.
- Иначе, смотрим поле `park_specificatin` в dbparks.
- Если там есть `delivery` - считаем этот парк логистическим (даже если там есть и taxi и delivery). Возвращаем его в категории `delivery`.
- Если там нет delivery, но есть taxi - считаем этот парк таксишным (пассажирским), возвращаем категорию `taxi`.
- Если нет `taxi`, либо список вообще пуст, но все еще доступен для логина - показываем его как "таксишный", пишем ERROR в лог, настраиваем алерт по логам.

#### Показ кнопки "Стать курьером"
Если у исполнителя на момент логина уже есть аккаунт курьера Еды, то кнопку не показываем.

В посттгрес `driver-login-db` прикапываем, сколько раз уже показывали эту кнопку исполнителю.

Если у исполнителя на момент логина несколько доступных аккаунтов, то кнопку показываем безусловно (т.к. он и так увидит промежуточный экран и флоу для него не ухудшается).

Если у исполнителя только 1 аккаунт, то сравиваем кол-во показов с лимитом из эксперимента 3.0. При превышении лимита - больше не показываем кнопку и промежуточный экран (т.е. на Я.Про вернется ответ в старом формате с одним парком, и Я.Про сразу залогинит исполнителя в аккаунт).

Сможем провести A/B тестирование и оценить, как разные значения лимита показов влияют на метрики исполнителя.

В том же эксперименте делаем рубильник, который будет включать безусловный показ кнопки, без учета лимита - на случай, если в каком-то городе наступил жесткий андерсапплай курьеров.

## Раскатка
Включаем эксперимент на процент, проводим A/B тесты на несколько групп:
- исполнители с одной аккаунтом
- исполнители с несколькими аккаунтми

Смотрим на метрики
- конверсия в совершение успешной поездки после логина
- количество повторных попыток логина (если выросло - скорее всего есть баги во флоу)
- прирост регистраций курьеров Еды.

## Дальнейшее развитие

Возможно, добавятся новые категории. Например, захотим выделить самозанятых. Или разделить "пеших доставщиков" и "автокурьеров".

В будщем добавим возможность водителям с активным аккаунтом попасть в саморегистрацию и создать новую аккаунт **любого типа, а не только курьером Еды**.