# Логин для водителей через Яндекс.Паспорт

## Ссылки

* [Эпик 1](https://st.yandex-team.ru/TAXIPROJECTS-1602)
* [Эпик 2](https://st.yandex-team.ru/TAXIPROJECTS-1817)
* [Арх. ревью](https://st.yandex-team.ru/TAXIARCHREVIEW-419)

## Глоссарий

* yandex_uid - идентификатор пользователя из Яндекс.Паспорта

* Таксометровая сессия - сущность "session" из driver-authorizer'а,
содержит в себе park_id и driver_profile_id

* Паспортная сессия - таксометровая сессия, в которой указан yandex_uid

* Таксометровый токен - "token" из driver-login'а, создается после
аутентификации водителя (сейчас после подтверждения номера телефона,
в будущем альтернативно после входа в Паспорт). Позволяет выбрать парк.

* Паспортный токен - OAuth-токен паспорта, с которым можно сходить в ЧЯ
и обменять его на yandex_uid 

## Цели

Всю работу можно разделить на два этапа
1. Реализовать возможность входа через Паспорт для профилей,
в которых уже заполнен yandex_uid.
2. Реализовать возможность заполнять yandex_uid в существующих профилях 
("привязывать Паспорт") в процессе входа.

## План

Большая часть подготовительной работы выполнена, в профилях водителей
уже можно хранить yandex_uid, driver_authorizer умеет 
хранить паспортные сессии, а driver_authproxy - умеет их проверять.

Осталось реализовать только непосредственно процесс входа.

Предлагаю выполнить это следующим образом:

### Первый этап
1. Добавить в DRIVER_AUTHPROXY_ROUTE_RULES поле auth-type для конкретных префиксов.
Сделать в driver-authproxy поддержку двух значений - driver-session
для старого поведения, optional-passport-only для нового.
Optional-passport-only означает "Проверить паспортный 
токен и пропустить, не проверяя таксометровую сессию". 
При этом если паспортный токен есть - добавить заголовок X-Yandex-UID,
а если токена нет - пропустить без заголовка.  
Был вариант попробовать обойтись без auth-type, хитрой обработкой proxy-401,
но ОКи предложили разделить эти сценарии по auth-type.

1. Перенести driver-login за driver-authproxy (auth-type: optional-passport-only).
Поведение driver-login'а при этом не меняется.

1. Добавить в driver-login шаг "passport". Он должен принимать 
проверенный yandex_uid от driver-authproxy и создавать таксометровый токен, 
привязанный к yandex_uid (без номера телефона). Возвращает "выбор парка".
При этом в апи driver-login'а поле "номер телефона" становится необязательным.
Черновик: https://github.yandex-team.ru/taxi/uservices/pull/20580

В результате получится следующий процесс:
1. Клиент опеределяет способ входа - через Паспорт. 
Доступность входа через Паспорт будет определяться, 
скорее всего, через loc_config с учетом экспериментов.
Будет ли у пользователя выбор Паспорт/телефон - TBD, должны определить менеджеры.

1. Клиент проводит паспортную аутентификацию. Получает токен из аккаунт-менеджера,
если на девайсе уже есть паспортный вход, или открывает паспортный экран входа.
В результате на клиенте появляется паспортный токен.

1. Клиент вызывает driver-login с паспортным токеном (шаг "passport").
Driver-authproxy заменяет паспортный токен на yandex_uid, driver-login создает
таксометровый токен, привязанный к yandex_uid вместо телефона, и возвращает 
список профилей.
Здесь нужно дополнительно обработать на клиенте 401 при невалидном паспортном токене.

1. Клиент показывает стандартный выбор парка (дальше все то же что и обычно).
Кажется, на всех последующих шагах тоже нужно добавить обработку на клиенте 401
при невалидном паспортном токене.

Q&A:

Q: Зачем добавлять auth-type в driver-authproxy? Может быть пусть driver-login
получает трафик напрямую и сам ходит в паспорт проверять токены?  
A: Во-первых, driver-authproxy выполняет функцию не только авторизации,
но и роутинга. Планируется сосредоточить эту функцию в одном месте, то есть
перенести вообще все сервисы, в которые ходит таксометр, за driver-authproxy.
Во-вторых планируется сосредоточить работу с паспортом в одном месте.
Driver-authproxy уже умеет работать с паспортом, там есть кеш паспортных токенов.

Q: Что будет с запросами, если паспортный токен станет невалидным?  
A: Driver-authproxy ответит клиенту 401.
Кажется, поведение клиента в этом случае может не меняться:
клиент попытается пойти в driver-login и получить новую сессию,
а там возникнет та же 401, и подключится обработчик, 
который знает, что это из-за паспорта.
Но этот момент нужно будет дополнительно проработать с клиентом.

### Второй этап
Эта часть проработана менее детально
Постановка - см. [Эпик 2](https://st.yandex-team.ru/TAXIPROJECTS-1817).

Планируемый процесс:
1. Клиент определяет способ входа - через Паспорт.

1. Клиент проводит паспортную аутентификацию.

1. Клиент вызывает driver-login с паспортным токеном (шаг "passport").
Если нашлись профили по yandex_uid - возвращаем их для выбора парка.
Если нет - возвращаем шаг "введите номер телефона для привязки профилей"

1. Водитель вводит номер телефона, подтверждает его через SMS/Flashcall

1. Во всех профилях с этим номером телефона yandex_uid заполняется
значением из шага "passport".

1. Стандартный "выбор парка". Создается паспортная сессия,
введенный номер телефона больше не используется

Q&A:

Q: Водитель привязал два профиля (с одинаковым номером телефона)
через новый процесс (теперь у этих профилей еще и одинаковый yandex_uid),
потом пришел в третий парк, там его зарегистрировали по (тому же) номеру,
как ему войти в третий профиль через Паспорт?  
A: Во-первых, водитель может зайти в третий профиль по номеру и
привязать там Паспорт (это предусмотрено, но за рамками текущего документа).
Во-вторых, это TBD - менеджеры должны определить как заполнять yandex_uid
при создании профиля.

Q: А что с саморегистрацией? Как связать саморегистрацию и паспорт?  
A: В данный момент есть нерешенные проблемы, связанные с использованием
паспортной авторизации для саморегов. В рамках этого документа
паспортная авторизация несовместима с саморегистрацией. Тем не менее, кажется,
что именно с точки зрения driver-login'а проблем нет - в конце саморегистрации
можно создать профиль с уже заполненным yandex_uid.
