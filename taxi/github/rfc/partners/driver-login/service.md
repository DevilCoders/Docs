**Название сервиса**

driver-login

**Какую продуктовую проблему решает сервис?**

Занимается входом и выходом исполнителя из аккаунта.

**Почему нельзя решить эту задачу без разработки нового сервиса существующими решениями?**

Сервис был выделен из легаси-сервисов driver-protocol и taximeter-*.
Изолирует цельный кусок логики. Уже полностью введён в эксплуатацию.

**Как именно сервис будет решать поставленные перед ним задачи?**

Ручка для входа в аккаунт - логин
Ручка для выхода из аккаунта - логаут
Периодический процесс для логаута водителей, у которых закончилась (expired) сессия

**Разрабатывается один сервис или система?**

Один сервис

**Сколько и какие сервисы входят в систему?**

-

**С кем взаимодействует сервис?**

1. Какие (микро-)сервисы и как используются.
`driver-authorizer` - пересоздать сессию на логине, удалить на логауте
`personal` - поменять номер телефона водителя (идентификатор, передаваемый в аргументах) на `phone_pd_id`
`communications` - для отправки пуш-уведомлений на клиент
`passport-internal` - для подтверждения номера телефона

множество сервисов для выяснения возможности логина, сборки ответа ручки логина и "посылки событий" логина:
  - contractor-random-bonus
  - driver-mode-subscription
  - driver-order-misc
  - driver-orders
  - driver-protocol
  - driver-profiles
  - driver-status
  - driver-ui-profile
  - fleet-parks
  - fleet-synchronizer
  - fleet-vehicles
  - parks
  - parks-certifications
  - reposition
  - taxi-driver-support
  - selfreg
  - unique-drivers

2. Как гарантируется идемпотентность внешний операций
при походе в сервис `driver-mode-subscription` явно передаётся X-Idempotency-Key, в остальных случаях идемпотентность не является необходимой

3. Как поддерживается консистентность данных при частичных отказах
в процессе логина некоторые операции (и пишущие, и читающие) не являются критичными - при их провале водитель всё ещё может быть залогинен
если критичная операция проваливается - исполнитель залогинен не будет, приложение-клиент будет ретраить до успеха. Rollback уже применённых изменений в таком случае не производится.

4. Как организованы ретраи внешних сервисов
обычными средствами HTTP-клиента

**Какие базы использует?**

Mongo: stats.login_stats
Redis: taximeter-base, taximeter-temp
Нововведение:
Postrges: driver-login-db

**Какие периодические процессы?**

Периодический процесс для логаута водителей, у которых закончилась (expired) сессия

**Прикрепите схему того, где этот сервис находится в текущей инфраструктуре**

1. Как технически проект влияет на цикл заказа.
При недоступности сервиса исполнители не смогут войти в аккаунт, а значит, выйти на линию и получать заказы

2. Кто будет потребителями сервиса.
Исполнители

**Какие данные и по какой схеме сервис будет хранить в базе?**

Время последнего успешного логина `last_login_at_ts` (сейчас хранится в монге dbdrivers.drivers)

Потом из Redis можно перенести:
хэшированные авторизационные токены
дистлоки периодик-таски логаута и самого логина по номеру телефона
блокировки повторного запроса смс
счётчики flash_call для фолбека на смс
начало смены (возможно, будет отдельный сервис)

**Какой объем данных будет храниться и какой объем будет изменяться в единицу времени?**

на каждого исполнителя:
64 байта id + 8 байт последнего логина

На каждый номер телефона
16 байт номера + 32 байта хэша + 2 boolean флагов

+ индексы = 200 байт
На 10 млн водителей - 2 Гб

**Какие операции над данными заложены?**

все

**Есть ли какой-то стейт в памяти, как он обновляется и валидируется?**

пока нет, в будущем могут появиться кэши

**Какая нагрузка ожидается?**

Текущая:
80 RPS в логин (все шаги)
30 RPS в логаут

**Какие фолбеки предусмотрены на сам этот сервис?**

План на ближайшее будущее:
При недоступности сервиса отдавать клиенту ответ "сервис недоступен, попробуйте снова через N секунд".

**Какие фолбеки предусмотрены внутри этого сервиса на взаимодействие с другими сервисами?**

План на ближайшее будущее:
При недоступности критичных сервисов отдавать клиенту ответ "сервис недоступен, попробуйте снова через N секунд".

**Какие возможности масштабируемости закладываются?**

Масштабируется горизонтально по входящему RPS
по количеству водителей с просроченной сессией в единицу времени есть теоретический предел, текущие значения ниже этого предела в ~20 раз

**Какие точки отказа есть в сервисе?**

Походы в другие сервисы и БД

**Укажите ключевые продуктовые метрики сервиса, за которыми планируете следить**

Доля успешных flash_call
Количество запрошенных смс в минуту
Количество залогиненных водителей в минуту
Количество разлогиненных водителей в минуту (через ручку и через периодик-таску)

**Укажите технические метрики**

Стандартные

**Какая функциональность ожидается в сервисе в будущем?**

Лучшее поведение при недоступности сторонних сервисов
Логин через Паспортный аккаунт
Посылка событий логина и логаута в логброкер

**Какое изменение нагрузки планируется?**

Пропорционально количеству исполнителей - несколько десятков процентов за год

**Активно ли будет изменяться сервис?**

Нет, только небольшие правки
