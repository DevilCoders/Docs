## Опросник для ревью комитетом

> Этот опросник нужен для [архитектурного ревью комитетом](https://forms.yandex-team.ru/surveys/25357/). Его можно будет скопировать.

> После его написания можно пробежаться по списку из [этой статьи](https://stackoverflow.blog/2020/04/06/a-practical-guide-to-writing-technical-specs/). Он подскажет, какие аспекты еще стоит осветить.

**Название сервиса**

qc-notifications

**Какую продуктовую проблему решает сервис?**

Рассылка нотификаций об изменении состояния экзамена, вынесении резолюций и, 
в будущем, о других событиях в qc. Сервис должен позволять оформить подписку 
на конкретные события.

Сервис должен поддерживать нотификацию водителей и парков. 
А также рассылку "специальных" пушей.


**Почему нельзя решить эту задачу без разработки нового сервиса существующими решениями?**

Сейчас все рассылки делаются децентразовано в основном из кода С#.
Некоторая часть уведомлений водителей о предстоящих экзаменах делается на 
[py3](https://github.yandex-team.ru/taxi/backend-py3/blob/develop/services/taxi-qc-exams/taxi_qc_exams/crontasks/prenotify_drivers.py).
Хочется объединить всю логику по формированию "списка рассылки" по сущности в одном месте 

**Как именно сервис будет решать поставленные перед ним задачи?**

В первой версии сервис самостоятельно будет отслеживать изменения 
состояний водителей (state/list). Также сервис будет отслеживать получение 
резолюций по текущим проверкам (pass/list)
По полученным данным формировать события и отправлять их заинтересованным лицам.
В дальнейшем в qc будет выделен отдельный сервис агрегирующий события от системы.

**Разрабатывается один сервис или система?**

Сервис будет частью системы qc сервисов

**Сколько и какие сервисы входят в систему?**

qc-notifications
quality-control
feeds
driver-profiles

**С кем взаимодействует сервис?**

* Чтение из сервиса quality-control
    * При чтение данные сервиса не модифицируются, поэтому идемпотентность не нужна
    * Данные выгребаются по курсору. Курсор не двигается пока не обработаны все данные
    * Есть сервисный _QOS_
* Отправка сообщений в сервис feeds v1/create
    * В качестве ключа идемпотентности будет использован уникальный идентификатор события.
    * Мы не считаем событие обработанным пока не уведомили всех потребителей.
    * Будут сервисные ретраи (QOS). 
    Дополнительно будут ретраи за счет периодических процессов (Stq или Periodic Task).
    У каждого события будет лимит по времени, в течении которого его имеет смысл пытаться отправить
* Получение списка водителей по автомобилю (driver-profiles)
    * При чтение данные сервиса не модифицируются, поэтому идемпотентность не нужна
    * Курсор основной джобы не двигается пока не обработаны все данные
    * Есть сервисный _QOS_
    
**Какие базы использует?**

Будет использована коллекция qc.qc_jobs_data для хранения текущего курсора
(Возможно!) Будет использован Postgres для формирования списка сообщений.
Будет несколько таблиц по типам рассылок.


**Какие периодические процессы?**

* Таска получения событий изменения состояний (POST /state/list)
* Таска получения резолюций по проверкам (POST /pass/list)
* Таска рассылки сообщений водителям
* Таска рассылки email'ов в парки

Последние две возможно будут заменены на stq процессы.

**Прикрепите схему того, где этот сервис находится в текущей инфраструктуре**

1. На цикл заказа не влияет.
2. Потребителем сервиса будет система "контроля качества".

**Какие данные и по какой схеме сервис будет хранить в базе?**

Возможно, все задачи можно будет возложить на stq, поэтому нам не понадобится БД.
Поэтому детально схема БД не проработана. 

***TODO!!! Проработать схему БД***
*Какие таблицы, индексы, уровни изоляции транзакций, особенности запросов и тп.
Объем хранимых данных, как их подразумевается чистить. Ресурсы под СУБД (cpu, ram, disk).*

**Какой объем данных будет храниться и какой объем будет изменяться в единицу времени?**

...

**Какие операции над данными заложены?**

...

**Есть ли какой-то стейт в памяти, как он обновляется и валидируется?**

Нет

**Какая нагрузка ожидается?**

Суммарно ожидается не более 20 rps "событий"
По 3000 изменений в 5 минут состояний (state/list) и проверок (pass/list)

**Какие фолбеки предусмотрены на сам этот сервис?**

В случае недоступности сервиса. Водители/парки не смогут получить информацию 
о блокировках через ленту. Но смогут увидеть ситуацию из других источников
(диагностики, например).
Если сервис восстановится в течении какого-то времени (актуальности сообщений), 
то сообщения будут-таки отправлены


**Какие фолбеки предусмотрены внутри этого сервиса на взаимодействие с другими сервисами?**

При недоступности quality-control курсор будет заморожен. 
Дальнейшие события мы начнем обрабатывать с той точки, на которой остановились.
При недоступности driver-profiles мы заморозим только курсор связанный с автомобилями
При недоступности feeds задачи будут копиться в очереди stq и/или в БД

**Какие возможности масштабируемости закладываются?**

Сейчас у нас достаточный запас прочности. Поэтому естественный рост переживем естественным путем

**Какие точки отказа есть в сервисе?**

Невозможность создать задачу в stq очереди и/или положить задачу в Postgres
Недоступность монги для вычитки/сохранения текущего курсора

**Укажите ключевые продуктовые метрики сервиса, за которыми планируете следить**

...

**Укажите технические метрики**

Количество сообщений по каждому из событий
Количество "пропавших" сообщений, которые так и не успели отправить
... 

**Какая функциональность ожидается в сервисе в будущем?**

Этапы разработки:
1. MVP -4д:
    Две крон-таски отслеживания изменений в state, pass
    Прямо в них отправка текущих пушей по очереди во все источники текущие источники

**Какое изменение нагрузки планируется?**

Естественный рост связанный с количеством водителей в сервисе.

**Активно ли будет изменяться сервис?**

Нет.
