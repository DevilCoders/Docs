## Описание существующего решения на .NET

### Экзамены
* ДКК (dkk)
* ДКВУ (dkvu)
* Брендинг (branding)
* СТС (sts)
* Паспорт (identity)


* Кресла/Бустеры

### Описание работы

Текущая админка написана на C# состоит из следующих частей
* Daemon импорта
* Пуллы над Redis'ом
* Ручки для Толоки/Нирваны (для сторонней проверки или расспознавания)
* Логика по отправке проверок в ML
* UI интерфейс асессоров
* Логирование действий асессоров
* Отправка пушей водителям (текстовых + 840(check))
* Тегирование водителей (метки)

#### Daemon импорта
* Выгребает проверки из qc (ручка /state/list)
* Паспорт: обогощает проверки данными паспорта из identity_docs (если были заданы ранее)
* Вытаскивает из dbdrivers/dbcars информацию о машине/водителе
* Проверки в статусе pending расскладывает по "пуллам", остальные пропускает
* Отправляет проверки ДКК в ML

#### Пуллы
1. ДКК
    * Все
    * Регулярные
    * Города
    * Уровни городов
    * Страны
    * Категории
    * Вызванные
    * Заблокированные
    * Тарифные (обычные)
    * Тарифные (заблокированные)
    * Tолока
2. ДКВУ
    * Все
    * Общие
    * Вызваннаые
    * Заблокированные
    * По странам
3. СТС
    * Все
    * Обычные
    * Заблокированные
    * Вызыванные
    * По городам
    * По уровням городов
    * По странам
    * Автокод
4. Брендинг
    * Все
    * По странам
5. Паспорт
    * Все
    * По странам
    * Заблокированные
    * Нирвана

6. Кресла
    * Все кресла
    * Кресла по городам
    * Все бустеры
    * Бустеры по городам


#### Ручки толоки, нирваны и автокода

Это специальные ручки для сторонней обработки. Они имеют очень похожий 
[aпи](https://taximeter-xservice.taxi.yandex.net/swagger/index.html).

Обработчики в них выгребают проверки из пуллов Толоки (ДКК), 
Автокода (СТС) и Нирваны (Паспорт) соответственно.
В качестве ответа можно прислать:
* резолюцию - да/нет/не знаю
* сообщение водителю
* список фотографий, которые нужно переделать
* набор данных для водителя

#### Логика по отправке проверок в ML
Делается по непосредственно перед раскладкой проверок ДКК по пуллам. 
Резолюция ML полностью передается дальше по цепи. Использоваться может только в толоке.
ML управляет тем, куда дальше пойдет проверка. 

#### UI интерфейс

Позволяет:
1. Просмотреть фотографии
2. Посмотреть историю ФК (возможно по разным фильтрам)
3. Посмотреть основные данные водителя, которые нужно проверить
4. Заполнить/исправить новые данные.
5. Переключится между фильтрами
6. Выбрать проверку в фильтре
7. Отправить резолюцию ок/блок
8. Оставить замечания
9. Отметить неудачные фотографии
10. Отправить водителя/машину в ЧС

#### Логирование действий асессоров

Логируются следующие события:
* Поступление проверки (первый синк в pending'e)
* Добавление проверки в фильтр (*qc_type, qc_filter*)
* Резолюция (*results.version, results.block, results.ml, results.changes, 
qc_type, qc_filter, resolution, assessor_login, assessor_type, assessor_comment, 
data*)

Во все события добавляются общие поля:
*timestamp, qc_id, qc_date, images, db, park_name, city, driver_id, 
driver_name, car_id, car_number, car_brand, car_model, car_color, car_year, 
tags, driver_license, driver_license_pd_id, pass_id*

#### Отправка пушей и коммуникаций водителям
После принятия резолюции отправляется 840 пуш (driver/check)
Отправляются следующие коммуникации (+ email означает email в парк):
1. ДКК         
    * AddTempBlock + email
    * RemoveTempBlock + email
    * DkkWarning + email
2. ДКВУ
    * DkvuError + email
    * DkvuMinorRemarks
    * DkvuSuccess
3. Паспорт
    * IdentityError + email
    * IdentitySuccess
4. СТС
    * StsError
    * StsMinorRemarks
    * StsSuccess
    * AvtocodError
5. Брендинг
    * DkbSuccess
    * DkbError + email
    * DkbMinorRemarks
6. Кресла/бустеры
    * DkbChairSuccess
    * DkbChairError + email
    * DkbBoosterSuccess
    * DkbBoosterError + email


#### Тегирование водителей (метки)
Метки загружаются для каждого водителя/машины из dbdrivers/dbcars соответственно 
в момент отображения проверки асессору. Ассесор видит все доступные метки 
(задаются [конфигом](https://tariff-editor.taxi.yandex-team.ru/dev/configs/edit/TAXIMETER_TAG_SETTINGS)).
И текущие отмеченные у машины. Обновление меток происходит при принятии резолюции.
