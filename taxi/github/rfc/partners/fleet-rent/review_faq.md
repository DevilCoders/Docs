# Ответы на вопросы из архитектурного обзора

## Какую проблему решает сервис?

Сервис обеспечивает возможность организации периодических списаний между водителем (в т.ч. СМЗ) и таксопарком

## Почему нельзя решить эту проблему существующими решениями?

Сейчас это решается через work_rule,
 что не даёт возможности назначать периодических списаний водителям, не привязанным к таксопарку (СМЗ).

## Как именно сервис будет решать поставленные перед ним задачи?

Сервис должен сохранять расписание периодических списаний в базе 
 и периодически производить их через fleet-transactions-api

## С кем взаимодействует сервис?

Сервис создаёт в fleet-transactions-api события о периодических списаний

## Идемпотентность

Создание или изменение периодических списаний требует от клиента сгенерировать ключ идемпотентности

## Консистентность

Консистентность нужно обеспечить констреинтами в базе

## Какие базы использует?

pg: [taxipgaasfleetrent](https://yc.yandex-team.ru/folders/foopimuu1d20nbcn3tak/managed-postgresql)

## Какие периодические процессы?

- само периодическое списание
- проверка остатка на балансе водителя
- рассылка уведомлений о начале/окончании периодических списаний
- рассылка уведомлений о выходе за лимит баланса

## Прикрепите схему того, где этот сервис находится в текущей инфраструктуре

1. _Как технически проект влияет на цикл заказа_ - на цикл заказа не влияет
2. _Кто будет потребителями сервиса_ - диспа и, в будущем, таксометр

## Какие данные и по какой схеме сервис будет хранить в базе?

- данные периодических списаний
- историю принятия/отклонения условий периодических списаний водителем и парком
- история статусов проводок, отправленных в fleet-transactions-api

## Какой объем данных будет храниться и какой объем будет изменяться в единицу времени?

На первых этапах ожидается не более ~10Гб общего объема хранилища

## Какие операции над данными заложены?

- операции создания условий периодических списаний
- операции создания записи о событии принятия/отклонения условий периодических списаний

## Есть ли какой-то стейт в памяти, как он обновляется и валидируется?

Весь стейт находится в базе

## Какая нагрузка ожидается?

Порядка пары сотен RPS после запуска на полную мощность

## Какие фолбеки предусмотрены на сам этот сервис?

Кеши и перезапросы на клиентах  
В случае полной недоступности - пользователь не сможет создать новое периодическое списание

## Какие фолбеки предусмотрены внутри этого сервиса на взаимодействие с другими сервисами?

Запланированные списания будут закладываться в таблицу БД на случай недоступности fleet-transactions-api

## Какие возможности масштабируемости закладываются?

Сервис масштабируется горизонтально

## Какие точки отказа есть в сервисе?

Сервис критически зависит от доступности базы
Также, при недоступности fleet-transactions-api невозможно будет производить своевременные списания,
 которые, при долгосрочном отсутствии связи, придется производить "задним числом"

## Укажите технические метрики

- rps
- успешные/неудачные операции с базой
- размер таблиц

## Какая функциональность ожидается в сервисе в будущем?

- Удержание залога по списанию (в т.ч. накопительного залога)
- Привязка списаний к выходу водителя на линию
- Разнообразие объектов, по которым можно создать списание

## Какое изменение нагрузки планируется?

Нагрузка будет пропорциональна востребованности фитчи (предварительных оценок рынка нет)

Поскольку списания необходимо производить в заданное время суток,
 нагрузка на расчёт списаний будет наибольшей в рабочие часы

За каждую активную запись о периодическом списании ожидается 
- 1 запрос на подборе кандидата (проверка доступности авто),
- 1 запрос при открытии экрана списаний в таксометре
- 1/{page_size} запросов на список активных списаний в диспе

Нагруженность процесса создания записи о периодических списаний:
- создание записи в диспе
- пуш уведомления в таксометр
- получение информации на таксометре
- подтверждение на таксометре
- запись времени подтверждения
- пуш уведомления в диспу

## Активно ли будет изменяться сервис?

Да
