{{ToC}}

### О сервисе

Сервис предназначен для организации периоических списаний с водителей в пользу таксопарков.

Проект:
https://st.yandex-team.ru/TAXIPROJECTS-941

Окружение:
https://st.yandex-team.ru/TAXIADMIN-11778

БД:
https://st.yandex-team.ru/TAXIADMIN-11777

Сервис закрыт TVM `fleet-rent`

#### Команда

Разработка: staff:ctacyok

Менеджер: staff:stikhnenko

#### Клиент

Сервис предоставляет схему для генерации клиента

service.yaml
```yaml
clients:
  services:
    - fleet-rent
```

### Устройство системы

Система стостоит из одного сервиса на python3 и его ПГ

taxi-fleet создает записи о периодических списаниях,
    на основании которых, периодическая задача создает списание через fleet-transactions-api

#### Архитектура

Сервис состоит из:
 - веб-сервера, предоставляющего возможность управлять записями о периодических списаниях в БД
 - крон-задач, производящих списание

```
Описание компонент, их взаимодействия. Картинки приветствуются, для чего можно использовать ((/wiki/vodstvo/diagrams/ разные диаграммы)).
Каким образом предполагается аутентифицировать пользователей.
Какая предполагается нагрузка на старте и какие прогнозы по росту.
Какова критичность сервиса и какие уровни деградации допустимы.
Какая платформа/язык программирования/сторадж выбран и почему. Если используются БД — какие предполагаются выборки, какие индексы предполагается создать.
Какие потенциальные точки отказа. Какие действия необходимы в случае неработоспособности компонент.
Как предполагается переживать недоступность ДЦ.
Что логируется в сервисе, какие планируются мониторинги и оповещения. Каким образом понимать, что сломалось и что нужно чинить.
```

#### Dataflow

Основная сущность сервиса - запись с параметрами периодического списания

В первой версии такая запись представляет собой одну строку в БД,
    содержащую время её создания, период, время принятия/отклонения условий и время прерывания периода.  
Редактирование этой записи ограничено на уровне интерфейса сервиса.

Для поддержки возможности использовать фильтры на GUI присваиваются состояния:
- new : у записи нет отметки о принятии, отклонении или прерывании
- accepted : у записи есть отметка о принятии условий, но нет отметки о прерывании
- rejected : у записи есть отметка об отклонении условий
- terminated : у записи есть отметка о прерывании договора

В дальнейшем, при развитии сервиса планируется добавить зависимую сущность - временной ряд изменений в условиях договора.
Такая сущность позволит обеспечить возможность редактирования условий периодических списаниях  
    с возможностью восстановить состояние на любой момент времени в прошлом  
Парк создает/изменяет драфт записи об периодических списаниях, водитель его подтверждает, 
после чего периодическая задача может периодические списания по оговорённому алгоритму

В продолжение развития сервиса появится отдельная сущность смены, создающаяся на каждый отдельный день,  
    обозначающая запланированный выход водителя на линию (м.б. интеграция с путевыми листами)

##### Периодические списания

Бизнесовая задача сервиса - удержание с баланса водителя по определенным параметрам

Основной вид таких списаний - ежедневные списания c возможностью пропуска списаний в определённые дни:
 - номер дня недели: указываются номера дней в которые необходимо проводить списания
 - номер дня месяца: указываются номера дней в которые необходимо проводить списания
 - число прошедших дней с начала договора (m/n): циклы длинной m+n, где m дней подряд списания выполняются, n - пропускаются

(Описания других видов списаний будут добавляться по мере имплементации)

#### API

[Schemas](https://github.yandex-team.ru/taxi/schemas/tree/master/schemas/services/fleet-rent)

#### Нагрузка

Нагрузка упирается в вычислительный ресурс бд

#### Деплой

Nanny:
 - [stable](https://nanny.yandex-team.ru/ui/#/services/catalog/taxi_fleet-rent_stable/)
 - [pre-stable](https://nanny.yandex-team.ru/ui/#/services/catalog/taxi_fleet-rent_pre_stable/)
 - [testing](https://nanny.yandex-team.ru/ui/#/services/catalog/taxi_fleet-rent_testing/)

### Ссылки

#### st

[Баги и доработки](https://st.yandex-team.ru/TAXIMETERBACK/order:updated:false/filter?tags=opteum_rent&resolution=empty())

#### Kibana

#### Grafana
