**Название сервиса**

contractor-random-bonus

**Какую продуктовую проблему решает сервис?**

Показывает исполнителям "случайные награды" для удержания их на линии в приложении `Uber Driver` (впоследствии, возможно, и в Яндекс.Про).

Какие-то награды выдаются после накопления прогресса, который вычисляется и показывается сервисом - [продуктовое описание](https://wiki.yandex-team.ru/taxi/partnerproducts/buber/uberdriverbonussystem).

**Почему нельзя решить эту задачу без разработки нового сервиса существующими решениями?**

Сервис `subvention-view` отображает только субсидии, приходящие из биллинга.
Обработка разнородных наград - смены, промокоды, повышенный приоритет, физические награды, выходит за рамки его ответственности.

Расчёт времени на линии/заказе уже делался в нескольких местах:
[Геобукинг](https://wiki.yandex-team.ru/taxi/efficiency/project-management/active-projects/geo-booking-improvements/Redizajjn-uchjota-vremeni-v-statuse-free/) - но бОльшая часть из этого здесь не нужна, и встраиваться не так просто
[Усталость](https://wiki.yandex-team.ru/taxi/backend/architecture/driver-weariness/#arxitektura) - использует deprecated хранилище статусов, тоже не подходит

**Как именно сервис будет решать поставленные перед ним задачи?**

поллинговая ручка для приложения исполнителей - будет отдавать текущую случайную награду для отображения
награды будут работать по обычному флоу, например, субсидия типа "персональная цель" или "0% комиссии сервиса на следующие N заказов", или "повышенный приоритет на N часов"
Факт выдачи случайной награды = наличие соответствующего тега на исполнителе. Теги будут запрашиваться в сервисе `driver-tags`. Соответствие награда <-> тег будет фиксировано, новые награды будут появляться очень редко.


появляются награды выдаваемые по накоплении прогресса - он увеличивается за нахождение на линии и на заказе и уменьшается за пропуски/отмены заказов
сервис рассчитывает прогресс исполнителей периодическим процессом, отдаёт прогресс в ручке поллинга, и по накоплении 100% запрашивает выдачу награды в `driver-metrics`


Сначала прогресс будет рассчитываться приблизительно - раз в 1-2 минуты запрашиваются статусы активных исполнителей в балковой ручке `driver-status`
Впоследствии будет введён сервис `contractor-status-history`, который будет отдавать уже агрегированную историю


**Этапы разработки**

1. 
Заводим новый сервис с ручкой поллинга

2. 
Добавляем детализацию по награде в ручку поллинга

3.
Включаем периодический процесс, рассчитывающий прогресс по текущим статусам
Заводим БД, храним прогрессы и все выданные за прогресс награды

Далее:
Переходим на сервис истории статусов
Реализуем откладывание награды "на потом" и её активацию

**Разрабатывается один сервис или система?**

Один сервис

**С кем взаимодействует сервис?**

 - приложение исполнителей `Uber Driver`
 - `driver-tags` для определения наличия наград
 - `driver-status` для расчёта прогресса до появления истории статусов
 - `contractor-status-history` для расчёта прогресса по истории статусов
 - `driver-metrics` для запроса на выдачу награды

**Какие базы использует?**

Вводится база, в которой хранится:
прогресс исполнителей
доступные и активированные награды
вспомогательные данные - дистлоки, время последнего успешного запуска периодического процесса и т.п.

**Какие периодические процессы?**

Пересчёт прогресса:
раз в 1 минуту - запрос текущих статусов по активным исполнителям в `driver-status`, увеличение прогресса в соответствии с правилами (из конфига). Считаем, что полученый статус держался весь период до следующего запуска процесса

**Планируется обработка персональных данных**

Нет

**Какие данные и по какой схеме сервис будет хранить в базе?**

Прогрессы:
Каждая запись - id исполнителей (park_id + driver_profile_id), значение прогресса (от 0 до 100), вспомогательные поля - created_at, last_updated_at и т.п.

Доступные и активированные награды:
id исполнителя, id награды, тип награды (имя тега), вспомогательные поля - время получения (доступности), время активации (факт выдачи) и т.п.

**Какой объем данных будет храниться и какой объем будет изменяться в единицу времени?**

Для `Uber Driver`:
всего зарегистрировано около 100 тыс. водителей
за сутки активны около 10 тыс

Прогрессы:
каждая запись порядка 250 байт, т.е. всего 20-30 мегабайт
историю прогрессов можно складывать в yt

Активированные награды:
В день каждый активный водитель получает не более 5 наград, каждая запись по 300 байт, получим 15 мегабайт в день
т.е 5-10 Гб должно хватить на год

**Какие операции над данными заложены?**

Прогресс:
Добавление записи при выходе исполнителя на линию
Обновление из периодической таски
Возможно, удаление при отсутствии активности в течение некоторого времени

Активированные награды:
Добавление записи при накоплении прогресса
Обновление при фактической выдаче

**Есть ли какой-то стейт в памяти, как он обновляется и валидируется?**

Нет

**Какая нагрузка ожидается?**

Для `Uber Driver`:
Интервал поллинга около 5 минут, т.е. 350 rps на всех водителей, только на активных - несколько десятков rps 
все остальные ручки очень редкие, в сумме порядка 1 rps

**Какие фолбеки предусмотрены на сам этот сервис?**

Поллинг наград:
Если недоступен сам сервис - ничего страшного, награда не отобразится, хотя и сработает как нужно, если соответствующий сервис работает штатно.

Награды за прогресс:
Прогресс пересчитается как только сервис станет доступен

**Какие фолбеки предусмотрены внутри этого сервиса на взаимодействие с другими сервисами?**

Если недоступен `driver-tags` - награда не отобразится. Сработает ли - зависит от соответствующего сервиса.
Если недоступен `driver-status`, то некоторое время не будут обновляться прогрессы
Если недоступен `contractor-status-history`, то некоторое время не будут обновляться прогрессы
Если недоступен `driver-metrics` - запросы на выдачу награды идут через stq и будут ретраиться до конца

**Какие возможности масштабируемости закладываются?**

Сервис масштабируется горизонтально - rps растёт пропорционально количеству исполнителей.

**Какие точки отказа есть в сервисе?**

Внешние походы в `driver-tags`, `driver-status`, `contractor-status-history`, `driver-metrics`
БД

**Укажите ключевые продуктовые метрики сервиса, за которыми планируете следить**

Продуктовые метрики собираются аналитиками - поставщиками соответсвующих тегов.

Со стороны сервиса добавляется: 
Средний накопленный прогресс при завершении работы

**Укажите технические метрики**

стандартные

**Какая функциональность ожидается в сервисе в будущем?**

откладывание награды "на потом":
появится ручка для принятия предложения о награде - активировать сразу или отложить
`driver-metrics` будет возвращать награду без активации (навешивания тега), она попадёт в БД сервиса в "доступные, но не активированные награды"
активировать награды будет исполнитель через ручку, для активации будет сделан поход в `driver-metrics`

**Какое изменение нагрузки планируется?**

x2-x3 в течение года, пропорционально росту `Uber Driver`

**Активно ли будет изменяться сервис?**

В зависимости от успешности. Если идея не сработает и эффективность платформы не вырастет, сервис и функциональность будут удалены

## Архитектура

### API

GET ручка `/driver/v1/random-bonus/v1/polling`

Ответ ручки: Список текущих случайных наград.
Формат награды прорабатывается с клиентом.

### Клиентская логика

Водительское приложение опрашивает ручку для поллинга.
Ручка возвращает список наград, каждая из которых отрисовывается на клиенте.
Также ручка возвращает прогресс, его тип - для дешёвой награды (первая за смену) или дорогой (все остальные), и правила расчёта - скорость роста за статус на линии и на заказе, штраф за пропуск/отмену заказа, штраф за уход с линии

Прогресс отображается на клиенте, растёт по такой же логике, синхронизируется с бэкендом раз в 5-10 минут через ответ ручки поллинга

### Технические ограничения

-

### Как раскатываем

В поллинговую ручку будет ходить приложение `Uber Driver`, начиная с некоторой версии.

Участие в программе накопления прогресса можно закрыть экспериментом 3.0 на логине

### Безопасность

Не планируется работать с ПД

