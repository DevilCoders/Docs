 ## Опросник для ревью комитетом

> Этот опросник нужен для [архитектурного ревью комитетом](https://forms.yandex-team.ru/surveys/25357/). Его можно будет скопировать.

> После его написания можно пробежаться по списку из [этой статьи](https://stackoverflow.blog/2020/04/06/a-practical-guide-to-writing-technical-specs/). Он подскажет, какие аспекты еще стоит осветить.

**Название сервиса**

orders-state

**Какую продуктовую проблему решает сервис?**

Данный сервис решает проблему отказоустойчивости цикла заказа в новой системе поллинга.
Про новую систему поллинга, можно почитать [тут](https://github.yandex-team.ru/taxi/rfc/pull/367)

**Почему нельзя решить эту задачу без разработки нового сервиса существующими решениями?**

Сейчас все ручки системы поллинга находятся в сервисе `superapp-misc`. 
Но это уменьшает отказоустойчивость всей системы в целом.
Хочется, чтобы при отказе сервиса с основной ручкой `orders/state`, клиенты могли продолжить поллить ранее полученые заказы


**Как именно сервис будет решать поставленные перед ним задачи?**

Сервис будет представлять батчовые ручки для доступа к различным партам заказов такси/еды/драйва.
В будущем, прокси еды и драйва переедут в отдельные сервисы, чтобы в случае проблем с данным сервисом, у пользователей не ломались заказы из других сервисов.

**Разрабатывается один сервис или система?**

...

**Сколько и какие сервисы входят в систему?**

...

**С кем взаимодействует сервис?**
1. Какие (микро-)сервисы и как используются: Сервис использует api-proxy `3.0/taxiontheway`, сервис еды и ручку `v2/orders/tracking`. На первом этапе, в батчовом totw(`taxi/v1/orders/state`) будет делать N запросов в `api-proxy/3.0/taxiontheway`, в будущем, распилим totw на части по частоте изменения. Трекинг еды - уже батчовый, пока что будем проксировать запросы и предоставлять свой API. 
2. Как гарантируется идемпотентность внешний операций: Идемпотентность гарантируется конечными сервисами. Данный сервис является прокси и лишь предоставляется батчовый интерфейс доступа к данным.
3. Как поддерживается консистентность данных при частичных отказах: Консистентность, гарантируется, конечными сервисами.
4. Как организованы ретраи внешних сервисов: Ретраи будут лишь на стороне ПА (2 ретрая), клиенты - показывают признак устаревших данных/отсутсвия интернета.

**Какие базы использует?**

На данный момент, state-less сервис.

**Какие периодические процессы?**

-

**Прикрепите схему того, где этот сервис находится в текущей инфраструктуре**

![structure](https://jing.yandex-team.ru/files/ihelos/superorders_stage_1-Новая%20схема%20Этап%201.png)

Данный сервис будет является одним из need_request - партом.

1. Как технически проект влияет на цикл заказа: Имеет прямое влияние на цикл заказа
2. Кто будет потребителями сервиса: Мобильные клиенты

**Какие данные и по какой схеме сервис будет хранить в базе?**

-

**Какой объем данных будет храниться и какой объем будет изменяться в единицу времени?**

-

**Какие операции над данными заложены?**

-

**Есть ли какой-то стейт в памяти, как он обновляется и валидируется?**

-

**Какая нагрузка ожидается?**

Ожидается нагрузка до 4к rps с учётом текущей нагрузки на `3.0/taxiontheway` и ручку трекинга еды

**Какие фолбеки предусмотрены на сам этот сервис?**

Будет рубильник в лонче. В случае проблем, будем отключать новую систему полинга - возвращаясь к текущей.

**Какие фолбеки предусмотрены внутри этого сервиса на взаимодействие с другими сервисами?**

1. Для батчового тотв-а, возможная точка отказа - api-proxy. Если откажет api-proxy, в качестве решения, возможно, переключение в PA роутинга прямо на протокол. Поэтому, рубильника в лонче должно хватить, чтобы отключать нагрузку на api-proxy, и клиенты ходили в старый `3.0/taxiontheway`
2. Для батчового трекинга - фолбек отсутсвует (влияет только на показ карточки на экране мультизаказа).

**Какие возможности масштабируемости закладываются?**

возможно горизонтальное маштабирование

**Какие точки отказа есть в сервисе?**

Нехватка ресурсов, баги в коде.

**Укажите ключевые продуктовые метрики сервиса, за которыми планируете следить**

Количество заказов в батчовых запросах(возможно, так можно будет ддосить сервисы, будем ограничивать). 

**Укажите технические метрики**

Стандартный набор метрик.

**Какая функциональность ожидается в сервисе в будущем?**

Этапы разработки:

1. Перенос текущих прокси ручек из сервиса superapp-misc 1d
   1. Сокрытие персональных данных в ответе ручек (1-2d)
2. Разбиение totw на парты - ? задача не быстрая, сложно оценить

**Какое изменение нагрузки планируется?**

от 0 до 4к

**Активно ли будет изменяться сервис?**

Да


## Бизнесовая задача

### Продуктовые ограничения

#### Этап 1

1. Если ломаются новые ручки поллинга, то после отключения новой системы поллинга, нужно будет перезапросить лонч(перезапустить приложение) чтобы вернулась работоспособность приложения.
2. В случае отключания новой системы поллинга, миникарточки еды/лавки на экране мультизаказа - показываться не будут (только кирпич).

## Архитектура

### API
### Технические ограничения

Данные пункты описаны в RFC:
1.

### Как раскатываем

#### Раскатка этапа 1

1. По эксперименту `superapp_multiorder` на стафф.
2. На процент на всех.

#### Техническая раскатка

За раскатку отвечает эксперимент 3.0, который работает в ручке `/launch` и может раскатываться по следующим аргументам: `personal_phone_id`, `phone_id`, `yandex_uid`.

### Безопасность

В ответах ручек - нужно будет скрыть персональные данные, 
