# Описание ручки /4.0/mlutp/v1/taxi/v1/orders/state

Ручка позволяет получить состояние заказов.

Данная ручка является частью новой системы полинга заказа в такси. Новая, батчовая версия ручки `3.0/taxiontheway`.

## Этап 1

### Особености реализации

- Для отмены заказа, клиенты должны использовать старую ручку `3.0/taxiontheway`
- Делаем N запросов для каждого заказа в `3.0/taxiontheway`, что накладывает свои особенности на ответ данной ручки.
- Проксирование запросов в `3.0/taxiontheway`: `extend_freecars - missing, format_currency - always true`
- Если получение всех заказов в запросе зафейлилилось - отдаём 500. Данное поведение, необходимо для мониторинга проблем.

### API
path: `/4.0/mlutp/v1/taxi/v1/orders/state`

Возможные коды ответа:

200 - ОК
401 - Ручка будет под ПА, дергать её без авторизации смысла не будет
500 - Не обновляем карточку/показываем признак устаревших данных, продолжаем полить в соответствии с правилами поллинга `orders/state`.

#### request
```
{
    "supported": ["feature1", "featute2"],
    "orders":[
        {
            "orderid":"order1",
            "tag": "encoded_part_tag"
        }
    ]
}
```

#### response
```
{
    "orders": [
        {
            // taxiontheway: 200 - all fields from 3.0/taxiontheway
        },
        {
            // taxiontheway: 404
            "error": {
                "update_status": "expired" - заказ уехал в архив, убираем карточку заказа
            }
        },
        {
            // taxiontheway: 500/timeoute
            "error": {
                "update_status": "stale" - ошибки получения заказа на стороне сервера, не обновляем карточку/показываем признак устаревших данных
            }
        }
    ]
}
```

#### Изменение API парта TOTW

Для того чтобы в будущем, было проще разделять totw на части в зависимости от частоты их изменения, необоходимо вынести часто меняющуюся часть `driver.car` из объекта `driver`.

Для этого, будем дублировать значение `driver.car` в объекте:

```
"performer_realtime_info": {
    "position": [lon, lat]
}
```

**Важно: текущая ручка 3.0/taxiontheway уже сейчас отдаёт новое поле, но закладываться на это можно лишь в том случае, если на клиентах будет реализован фолбек на сторое поле. Это необходимо, по причине того что в случае переключения трафика 3.0/totw из api-proxy на protocol, данное поле - будет отсутствовать** 

### Фолбеки

Текущая топология ручки:

`client -> PA (2x2000) -> mlutp/v1/taxi/v1/orders/state (2x2000) -> api-proxy/3.0/taxiontheway (2x3500) -> protocol`

В данной схеме, могут быть 2 типа проблем:
1. Ломается `api-proxy`
2. Ломается `mlutp/v1/taxi/v1/orders/state`

Варианты решения:
1. Реализовать фолбек с `api-proxy` на прямой поход в `protocol` внутри `mlutp/v1/taxi/v1/orders/state`, который будет включаться в ручную(могут быть кейсы когда `api-proxy/totw` ломается по причине поломки `protocol/totw`) - не будет сделано на 1 Этапе;
