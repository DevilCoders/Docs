# Получение активных заказов еды в новой системе поллинга

## Задача 
- Отдавать список активных заказов еды и их состояние для новой системы поллинга в `launch` и `mlutp/v1/orders/state`, далее `orders/state`;

### Концепция
- Текущая концепция `orders/state`, подразумевает что у ручки имеется доступ к состояниям заказа (для запросов из `launch`), и указании на источник для обновления состояния на клиентах;

## Прокси активных заказов еды
Данный вариант предпологает под собой реализацию прокси над ручкой активных заказов еды (v2/orders/tracking).

Прокси решает следующие проблемы:
1. Унификацию API;
2. Мониторинг ошибок из коробки;
3. Управление нагрузкой посредством кэширования ответа ручки трекинга еды;

### API
path: `/4.0/mlutp/v1/eats/v1/orders/state`

request:
```
{
    "force": true | false,
    "orders": [
        {
            "orderid":"777777-888888",
            "tag": "encoded_part_tag"
        }
    ]
}
```

response:
```
{
    "orders": [
        {
            "status": "order.created",
            "title": "string",
            "description": "string",
            "eta": 0,
            "delivery_at": "2020-05-27T11:01:40Z",
            "order": {
                "id": "777777-888888",
                "status": {
                    "id": 0,
                    "date": [
                        "2018-10-01T17:00:00+0300"
                    ]
                },
                "location": [37.640632, 55.736473],
                "is_asap": true,
                "delivery_type": [
                    "native",
                    "marketplace"
                ],
                "shipping_type": "delivery"
            },
            "place": {
                "name": "Mc Donalds",
                "location": [37.640632, 55.736473],
                "address": "улица Льва Толстого, 14Ас6",
                "location_link": "http://example.com",
                "comment": "string"
            },
            "courier": {
                "name": "Albert",
                "location": [37.640632, 55.736473],
                "is_hard_of_hearing": false
            },
            "created_at": "2018-10-01T13:10:00+0300",
            "service": "grocery"
        }
    ]
}
```

Изменения:
Camel case -> snake_case

`order.orderNr` -> `order.id`

Удаление depricated полей:
1. `order.deliveryTime`
2. `time`
3. `contact`

Удаление неиспользуемых клиентами полей:
1. `statuses` - показ статусов будет в webview
2. `actions` - отмена, и другие действия будут в webview
3. `client_app` - не используется
4. `payment` - информацию об ошибках не отображаем
5. `contacts` - информация о контактах будет в webview

Nullable -> optional:
1. `eta`
2. `delivery_at`
3. `courier`

Изменение формата:
`location` -> geojson format

### Разбиение на парты
С учётом первого этапа, и отсутствием функционала принудительного обновления обновления парта. Предлагаю, не делить данный модуль на куски.

### Обработка ошибок:
В случае сетевых проблем, ретраим.
В случае 500 - ретраить не нужно, ретраи будут на стороне ПА.

## Изменения на клиентах
- После запуска ручки `orders/state`, перестаём полить ручку трекинга еды;
- Оставляем интервал фонового полинга ручки в 90сек;


## Поддержка мультизаказа в launch
- На текущий момент, проверка мультизаказа реализована на бэке еды, в ручке создания заказа. На первом этапе, предлагаю, захардкодить флаг, и оставить обработку ошибок создания заказа в webview, а в будущем, попросить коллег из еды предоставить возможность получения доступности мультизаказа для пользователя.   

### Этап 1
1. Делаем прокси ручку в сервисе `superapp-misc` без кэширования. Т.е. учёт тегов производиться не будет, всегда будем обновлять состояние заказа;
2. Прохождение аудита и добавление проксирования из ПА в internal ручку;
3. Реализовываем запрос в прокси ручку из `orders/state` для получеия заказов из `launch`;
4. Circuit breaker на основе сериса статистика для уменьшения нагрузки на сервис еды, в случае проблем.

### Этап 2
1. Поддержка кэширования и тэгов соответственно...
