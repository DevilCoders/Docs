# Перенос ручки /4.0/stories из сервиса taxi-stories в inapp-communication

## Описание проблемы
Сервис taxi-stories был разработан для того, чтобы отдавать пользовательские
истории в Центре Безопасности. В разработанном MVP для заведения новой истории
нужно было (позже шаги 2 и 3 перенесли на сторону сервиса):
* создать ее в админке
* сконвертировать в нужный формат скриптом
* добавить историю в конфиг `STORIES_STUBS_V2`
* добавить `ID` истории в `STORIES_BY_COUNTRIES`

После `taxi-stories` появился сервис `promotions`, который в числе прочего тоже позволяет 
создавать сторизы. Хотелось бы, чтобы одинаковый по сути функицонал был в одном
месте и возможные доработки тоже велись в рамках одного сервиса. Поскольку
клиентские ручки `promotions` почти полностью переехали в сервис `inapp-communications`,
то будет разумно перенести ручку `/4.0/stories` туда же.

Админка сервиса находится в монолите py2.

## Кто ходит в /4.0/stories
Клиенты запрашивают ручку с экранов (присылают разное поле `context`):
* Центр безопасности
* Еда
* Лавка
* Кэшбек/Плюс
* Бизнес-аккаунт

### Сторис в протоколе
Еще сторизы отдаются из протокольного `totw`,
который берет их из локального монго-кэша. При распиле `totw` новым клиентам нужно
будет начать ходить в /4.0/stories в inapp.

#### Алгоритм выборки сторис в протоколе
Вторые эксперименты рассматривать не буду, т.к. на момент написания
rfc в проде не было ни одной активной истории, публикуемой через
вторые эксперименты.

* кэшируется монго-коллекция `dbpromo.promo_stories`
* по пользователю матчатся третьи эксперименты (консьюмер `protocol/totw:stories`)
* если история включена в эксперименте (`{"enabled": true}`) и `{"active": true}` в монго-кэше — возвращаем

#### Кварги для exp3 по консьюмеру `protocol/totw:stories`
Отправляемые:
* информация о приложении (`application`, `platform`, `version`, `application.name`, `application.store_country`, `application.platform`, `application.full_version`, `application.platform_full_version`, `application.brand`)
* информация о зоне и стране (`zone`, `country`)
* метод оплаты в текущем заказе (`payment_option`, `payment_type`)
* тариф в текущем заказе (`tariff_class`)
* `phone_id`
* `user_id`
* `yandex_uuid`
* `yandex_uid`
* сурж в текущем заказе (`surge_value`)
* заказ с платной подачей (`is_paid_supply`)
* валюта заказа (`currency`)
* заказ по фиксированному тарифу (`is_fixed_price`)
* информация о маршруте (`point_a`, `point_b`, `midpoint_count`, `is_destination_set`, `point_mid<index>`)

Реально используемые (из продовых экспериментов):
* информация о приложении (`application`, `version`)
* гео (`country`)
* `phone_id`
* информация о маршруте (`point_b`)
* тариф в текущем заказе (`tariff_class`)

#### Предлагаемые изменения
* `{"active": true}` из монги переносим в новые сторизы в promotions в поле `extra_fields`
* этим же сторизам проставляем `consumer = {'totw'}`
* выносим получение сторизов из кода `taxiontheway` в api-proxy ручку `/3.0/taxiontheway`
* делаем запрос в новую ручку `/4.0/totw-stories` в сервис `inapp-communications`, куда передаем указанные выше кварги для exp3, полученные из ответа источника `order-core-orderinfo` (в который ходит `/3.0/taxiontheway`) (`point_a`, `tariff_class`, `point_b`)
* отдаем актуальные сторизы по текущей протокольной логике (consumer, exp3, active)

Ответ `/4.0/totw-stories` можно закэшировать по переданному `order_id` средствами
api-proxy на `5`-`10` минут (задается конфигом `INAPP_TOTW_STORIES_CACHE_CONTROL`). Если принимать средний ответ, содержащий сторизы для `totw` за 15 кб, то при пиковой нагрузке на весь кэш понадобится порядка 43 мб пространства в кэше.

Сейчас в `/3.0/taxiontheway` в пике прилетает 3к рпс. Пиковая нагрузка на `/4.0/totw-stories` будет примерно такого же порядка, но средняя гораздо ниже за счет кэширования ответов.


## Сколько rps приходит в /4.0/stories
В среднем это 100 rps, до 150 rps в пике.

## Решение
* отключить старую админку
* сконвертировать сторизы из монги под формат `promotions`
* сконвертировать сторизы из конфигов под формат `promotions` (`STORIES_STUBS_V2`, `STORIES_CASHBACK_STUBS`)
* настройки показа по зонам нужно взять из конфигов (`STORIES_BY_COUNTRIES`, `PROMO_STORIES_SETTINGS`)
* статус опубликованности нужно взять из конфига (`PROMO_STORIES`)
* проверить, что они отдаются в ручке `/internal/list` сервиса `promotions` (они попадают в кэш в `inapp-communications`)
* написать логику, которая по входящему параметру `context` будет возвращать такие сторизы в ручке `inapp-communications`
* написать конвертер из формата сторизов `promotions` в формат, который понимают клиенты
* перевести клиентов на новую ручку через `Passenger-Authorizer` и `api-proxy` (для постепенного перевода трафика на новую по эксперименту)

После этого можно будет освободить ресурсы сервиса `taxi-stories` (машинки и монго-коллекция) и удалить ненужные конфиги (в группах `promo_stories` и `stories`). Также можно будет освободить ресурсы `api-proxy`, пустив трафик напрямую через `Passenger-Authorizer`.

### Дальнейшее развитие
После того, как клиенты научатся показывать сторизы из `promotions` в тех местах,
где сейчас показываются старые сторизы, со стороны бэкенда никаких изменений
не потребуется, т.к. клиенты и так уже получают новые сторизы. Старые просто
нужно будет перестать заводить.

## Декомпозиция и оценка
* [TAXIBACKEND-29738](https://st.yandex-team.ru/TAXIBACKEND-29738) — отключение старой админки (1d)
* [TAXIBACKEND-29740](https://st.yandex-team.ru/TAXIBACKEND-29740) — конвертер из старого формата в формат `promotions` (2d)
* [TAXIBACKEND-29741](https://st.yandex-team.ru/TAXIBACKEND-29741) — извлечение конвертированных историй из кэша (4d)
* [TAXIBACKEND-29742](https://st.yandex-team.ru/TAXIBACKEND-29742) — конвертер в старый клиентский формат (2d)
* [TAXIBACKEND-29743](https://st.yandex-team.ru/TAXIBACKEND-29743) — перевод клиентов и проверка (2d)
* [TAXIBACKEND-31528](https://st.yandex-team.ru/TAXIBACKEND-31528) — вынос протокольных сториз в api-proxy (4d)
