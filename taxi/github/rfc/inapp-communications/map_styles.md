## Стили карты

### Бизнес-описание

Сейчас клиент получает стили карты в `typed_experiments` ручки `launch`.
У этого решения есть проблема отсутствия кэширования и, как следствие, увеличение нагрузки на вызов `launch`,
а также использование экспериментов не по назначению, что усложняет администрирование стилей.

### Видение

Клиенту нужны стили карты для разных тем, мод и вертикалей.
Стили редко обновляются: скорее всего в аналогичной конфигурации нужно использовать тот же стиль, что и в прошлый раз.
Стили могут терять актуальность, т.е. становиться более не нужными, например из-за отключения какой-либо моды.
Нужно иметь возможность тестировать обновления стилей через эксперименты.

### Ручка POST /4.0/inapp-communications/v1/map-styles

Ручка служит для обеспечения клиента необходимыми для работы стилями.

Стиль имеет два идентификатора: id и etag.
id используется клиентом для получения стиля по конфигурации (тема, мода, вертикаль...) - это функциональный идентификатор.
etag используется для уникальной идентификации содержимого стиля при обновлении кэша.

В запросе клиент передаёт
список запрашиваемых стилей по ID,
а также (опционально) спискок etag'ов стилей из своего кэша для проверки на инвалидацию.

Сервер шлёт в ответ
определения запрошенных стилей
и список etag'ов стилей, которые нужно удалить из клиентского кэша.


По сути тут две независимых процедуры: инвалидация стилей из кэша и запрос на обновление стилей по ID.
Было принято решение объединить их в один запрос для упрощения логики на клиенте.


#### Примерная логика использования ручки

##### Сервер

Сервер возвращает клиенту запрошенные стили,
а также формирует список инвалидированных стилей для удаления из клиентского кэша.

Для этого удобно держать два индекса по хранилищю стилей:
- составной по id и версии стиля
- по etag

Примерная логика обработки запроса сервером (без всяких возможных оптимизаций):
- клиент запросил некоторый стиль с ID123 и сообщил, что у него есть стили с некоторыми etag'ами
- по индексу (id, etag) находим и записываем в ответ запрошенный стиль
- по индексу etag выбираем отсутствующие на сервере стили клиента, заполняем ими поле ответа remove_styles

На добавление нового стиля в таблицу вешаем триггер, который по индексу (id, etag) удаляет стили с таким же ID старше N версий,
то есть для каждого ID на сервере хранятся не более N etag'ов прошлых версий.
Когда у клиента в кэше версия не старше N - она не будет удалена, а значит, она будет использована для отрисовки, пока клиент ждёт ответа с более актуальной версией стиля.

Эксперименты и специальные стили (например тематические для событий) можно делать прозрачно для клиента, добавив в ID стиля на сервере дополнительную колонку.

##### Клиент

Клиент поддерживает кеш стилей с индексами по id'шникам и по etag'ам.

Кэш чистится с помощью отправки в запросе на сервер всех etag'ов из кэша.

При отрисовке карты клиент сам определяет, какой стиль (по id) ему нужен, например - ночная тема бизнес такси,
и запрашивает стиль по этому id в кэше.
При этом в кэше может не найтись такого стиля, и тогда будет использован fallback, а может найтись актуальный или устаревший (про это клиент пока не знает).

Внутри кэша обращение к содержимому стиля опосредовано индексом по etag'у.
Так, для разных функциональных ID может быть назначен один и тот же по содержанию (и по etag'у) стиль, и не придётся получать на сервере и хранить локально несколько его копий.

Клиент:
- всегда имеет хотя бы один fallback стиль
- при отрисовке карты идёт в кэш за стилем, а если там нет — берёт fallback стиль
- асинхронно с запуском делает запрос стиля по этому ID и (опционально) всеми etag'ами стилей из своего кэша
- получает ответ; если пришла новая версия запрошенного стиля — перерисовывает карту с новым стилем
- удаляет из кэша устаревшие стили из ответа сервера с пмощью индекса по etag'ам



#### API ручки


```yaml
paths:
  /4.0/inapp-communications/v1/map-styles:
    post:
      description: |
        ### Описание

        Ручка обновления стилей карт пользователя. Возвращает определения запрошенных стилей, если на клиенте не последняя версия, а также список неактуальных стилей для удаления из кэша.

        ### Пример запроса

        Клиент запрашивает два стиля, из которых один у него есть в кэше, и передаёт содержимое кэша на валидацию.
        ```json
        {
          "requested_styles": [
            {
              "id": {
                "mode": "sdc",
                "theme": "light"
              },
              "etag_from_cache": 0
            },
            {
              "id": {
                "mode": "boats",
                "theme": "underwater"
              },
            }
          ],
          "styles_on_device": [0, 1, 2],
        }
        ```

        ### Пример ответа

        Сервер отвечает для первого ID новым определением стиля, т.к. имеющийся у клиента уже устарел.
        Для второго ID, который у клиента ещё не использовался (т.к. кэш пустой), сервер указывает переиспользовать стиль, уже имеющийся на клиенте, путём указания его etag'а.
        Также сервер просит удалить из кэша один стиль.
        ```json
        {
          "requested_styles": [
            {
              "id": {
                "mode": "sdc",
                "theme": "light"
              },
              "etag": 30,
              "style" : [
                {
                  "types": "polyline",
                  "stylers": {
                    "scale": 0.35,
                    "lightness": 0.5
                  },
                  "elements": "geometry"
                },
                {
                  "tags": {
                    "any": [
                      "admin",
                      "urban_area",
                      "poi",
                      "land",
                      "structure"
                    ]
                  },
                  "types": "polygon",
                  "stylers": {
                    "color": "F9F7F2"
                  },
                  "elements": "geometry.fill"
                },
              ]
            },
            {
              "id": {
                "mode": "boats",
                "theme": "underwater"
              },
              "etag": 2
            }
          ],
          "remove_styles": [1]
        }
        ```

      x-taxi-middlewares:
          api-4.0:
              pass-not-authorized: true
      parameters:
        - in: header
          name: User-Agent
          type: string
          required: true
        - in: body
          name: body
          required: true
          schema:
              $ref: "#/definitions/MapStylesRequest"
      responses:
          200:
              description: OK
              schema:
                  $ref: "#/definitions/MapStylesResponse"

definitions:
  MapStylesRequest:
      type: object
      additionalProperties: false
      properties:
          requested_styles:
              type: array
              items:
                  type: object
                  additionalProperties: false
                  properties:
                      id:
                          $ref: "inapp-communications/definitions.yaml#/definitions/MapStyleId"
                      etag:
                          type: integer
                  required:
                    - id
          styles_on_device:
              type: array
              items:
                  type: integer
      required:
        - styles_on_device

  MapStylesResponse:
      type: object
      additionalProperties: false
      properties:
          requested_styles:
              type: array
              description: запрошенные стили, для которых есть обновления
              items:
                  type: object
                  additionalProperties: false
                  description: |
                      Этот стиль нужно добавить в кэш.
                      Если у клиента в кэше есть определение стиля с этим etag'ом, поле style в ответе может отсутствовать -
                      это означает, что клиент должен использовать имеющееся в кэше определение для запрошенного ID.
                  properties:
                      id:
                          $ref: "inapp-communications/definitions.yaml#/definitions/MapStyleId"
                      etag:
                          type: integer
                      style:
                          $ref: "inapp-communications/definitions.yaml#/definitions/MapStyle"
                  required:
                      - id
                      - etag
          remove_styles:
              type: array
              description: неактуальные стили
              items:
                  type: integer
                  description: стиль с этим etag можно удалить из кэша

  MapStyleId:
      type: object
      additionalProperties: false
      properties:
          app:
              type: string
          mode:
              type: string
          theme:
              type: string
```
