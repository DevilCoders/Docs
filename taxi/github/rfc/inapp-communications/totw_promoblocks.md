# Промоблоки в поездке

## Что чего хотим

Как известно, промоблоки уже существуют на саммари. Каждый промоблок имеет свой набор виджетов (см. структуру `PromoblockItem` библиотеки `communications-cache`). Хотим уметь строить аналогичные структуры на клиентах во время поездки. Примерно см. на скрине ниже.
![totw_promoblock](https://jing.yandex-team.ru/files/uta123/totw_promoblock.png "totw_promoblock")

В частности, уже сейчас хотим уметь строить:
* Промоблоки для заказа другому
* Промоблок расшара поездки администратору семейного аккаунта (доработка других бэкендов велась в [тикете](https://st.yandex-team.ru/TAXIBACKEND-38200 "тикете"))

## Изменения

Далее предлагаю решать задачу в 2 этапа, т.к. для второго этапа понадобятся доработки фронта.

__Этап 1__

Добавление промоблока расшара поездки администратору семейного аккаунта

__Этап 2__

Добавление промоблока заказа другому и всех других

### Клиенты

__Этап 1__

Проработка в [rfc](https://github.yandex-team.ru/taxi/rfc/pull/975 "rfc")

__Этап 2__

Не требуется

### order-core: ручка /v1/tc/order-info

__Этап 1__

Проработка в [rfc](https://github.yandex-team.ru/taxi/rfc/pull/975 "rfc")

__Этап 2__

Вытащить `extra_user_phone_id` из базы и отдать в ответе.

### api-proxy: ручка /3.0/taxiontheway

__Этап 1__

Проработка в [rfc](https://github.yandex-team.ru/taxi/rfc/pull/975 "rfc")

__Этап 2__

* Прокидываем `extra_user_phone_id` в запрос к `inapp-communications`.
* Добавить в ключ кеша статус заказа и водителя. Это позволит не показывать неактуальные плашки в пути (написано "человек поедет", а он уже едет).

Пример к `promotions.promoblocks`:
```
{
    // ...
    "promotions": {
        "promoblocks": {
            "items": [
                {
                    "title": {
                        "items": [
                            {
                                "type": "text",
                                "text": "Поедет Иван"
                            }
                        ]
                    },
                    "text": {
                        "items": [
                            {
                                "type": "text",
                                "text": "Он сможет отслеживать заказ в Go"
                            }
                        ]
                    },
                    "icon": {
                        "image_url": "..."
                    }
                    "widgets": {
                    },
                    "configuration": {
                        "type": "list"
                    }
                }
            ]
        }
    }
}
```

### inapp-communications: ручка /inapp-communications/v1/promos-on-the-way

Структуру промоблоков можно оставить текущей (той, что есть в __/4.0/inapp-communications/promos-on-summary__). В целом, логика сохраняется. В дальнейшем при необходимости в этой ручке также можно будет организовать сбор промоблоков из источников.

__Этап 1__

Проработка в [rfc](https://github.yandex-team.ru/taxi/rfc/pull/975 "rfc")

__Этап 2__

* Добавляем необязательное поле `extra_user_phone_id` в запросе.
* Добавляем в консьюмер __totw/promotions__ кварг заказа другому.
* Матчить эксперименты промоблоков и добавлять их в ответ ручки.
* Доработка промоблоков. Существующее поле `configuration.type` расширяем новым значением `list`, а к возможным значениям `display_on` добавляем строку `totw`. Если из источников (в том числе `promotions`) не пришло поле `display_on` - то по умолчанию в `inapp-communications` будем выставлять `display_on == [summary, tariff_card]` в ручке __/4.0/inapp-communications/promos-on-summary__ и `display_on == [totw]` в ручке __/inapp-communications/v1/promos-on-the-way__. При этом как подать это в админке - тонкий момент. Без пояснений у маркетологов могут будут возникать вопросы и непонятки (пришло не там, где надо/не пришло, где надо). Но с Наташей Типсиной пришли к тому, что пока можем реализовать простой вариант с одноуровневым выбором элементов `display_on`.

*Оффтоп*, который я выяснял, пока писал rfc: домик плюса умеет строить промоблок, но делает это кривовато. Они ходят в ручку __/4.0/inapp-communications/communications__ и получают оттуда истории, а одну из историй преобразуют в промоблок. Это место тоже можно обговорить в будущем. Завести для них своё значение `display_on` и отдавать промоблоки в ручке __/4.0/inapp-communications/communications__.

### promotions

__Этап 1__

Не требуется

__Этап 2__

1. `promotions` не умеет в тоггл-виджеты промоблоков. Все текущие промоблоки с тогглами приходят из других источников. Нужно добавить.
2. Поддержать работу с полями `display_on`, `configuration`.

### Фронты

__Этап 1__

Не требуется

__Этап 2__

1. Поддержать виджет `toggle` для промоблоков в админке Яндекс.Go коммуникаций.
2. Поддержать работу с полями `display_on`, `configuration`.
Второй пункт я вижу так:
- `configuration` - опционально
* `configuration.type` - просто выпадающий список из некоторого конфига
* `configuration.backgroud_color` - типичный выбор цвета, уже есть во многих местах админки
- `display_on` - опционально, простой список. К сожалению, существующее клиентское API уже завязано на это поле, так что задепрекейтить его нельзя. На текущий момент нам нужно уметь на саммари выбирать подмножество `{summary, tariff_card}`, а во время поездки - из `{totw}`. Но, как отметил выше, будет просто выбирать из всех возможных вариантов.
