# Cashback Stories

## Проблема

Мы делаем новую плюсовую систему с кешбеком и новой бонусной программой, которая затрагивает целый яндекс, хочется синхронизировать коммуникации и настраивать их в одном месте по заданным условиям

Все приложения/сайты получают информацию от нашего бекенда и отрисовывают у себя.
Функционал:

* Админка
* Загрузка по сервисам
* Учет факторов: регион, наличие подписки
* Приоритет сторизов
* Ротация показа: скрывать при определенном количестве просмотров


# Проработка

Предполагается взаимодействие клиент-бекенд (клиентом может выступать как веб приложение, так и мобильное), сторизы будут точечно раскатываться (по наличию плюса, по количеству баллов, по локации пользователя и тд), поэтому нужна некоторая авторизационная-прокся, которая могла бы авторизировать пользователя и дополнительно на бекенд прокинуть информацию о пользователей 

## Прокся

### Основные вопросы

* какие методы авторизации
* с кем хотим интегрироваться
* какие клиенты/пользователи
* какие методы планируется добавлять


### Методы авторизации

Запросы будут идти как со стороны web'a, так и со стороны клиентских приложений, соответсвенно со сотороны web необходима авторизация по session_id, а со стороны клиентов oauth


### Сервисы для интеграции

* Такси
* Еда
* Драйв
* Афиша


### какие клиенты/пользователи

фониши\порталы, нужна авторизация через паспорт


### Методы

Ручка получения коммуникаций, ручка пометки комуникации прочитанной (не в MVP)


## Сторизы

Сейчас в такси есть сервис promotions, который внутри себя хранит различные коммуникации, в том числе и сториз, сервис достаточно медленный поэтому для взаимодействия с клиентами есть inapp-communications, который является кешем сервиса promotions. 

### inapp-communications

Основная ручка в inapp-communications это /4.0/inapp-communications/communications, она на вход получает следующие данные:
* Геопозицию (широту и долготу пользователя), эта геопозиция передается в эксперимент для матчинга коммуникаций
* параметрый экрана в media_size_info
* список поддерживаемых полей в условии показа коммуникации
* поддерживаемы действия пользователя
* стейт: order_id заказа, экран, выбранный тариф, способ оплаты, зона и тд

все эти параметры передаются в эксперименты 3.0, каждый сматченный эксперимент это коммуникация, на основе каждого сматченного эксперимента формируется коммуникация

В ответе ручка возвращает массив сторизов:
* Каждая сториз имеет заголовок, суб заголовок, превью, фон, текст, изображение, время показа
* Ссылки на изображение ведут на mds



### Ручка для внешних сервисов

Предлагается оставить api ручки таким же, удалив только ненужны поля, которые специфичны для такси: зона, order_id, tariff_class и тд, ручка будет называться /4.0/communications



## Флоу потребителей

* Сходить в ручку
* Сходить в mds


# Разработка

## MVP Первый этап

* Делаем ручку в inapp-communications 


## MVP Второй этап

поддерживаем реализацию Олега Ермакова https://github.yandex-team.ru/taxi/rfc/pull/473/files?short_path=d5f2b14#diff-d5f2b147dfa34f3637cc95fb64305a89

Делаем промоблок в одном из наших сервисов (скорее всего плюс):
* Написать ручку создания сторизов


Делаем каунтер просмотров сториз (когда инфраструктура переведет сторизы на feeds):
* Надо написать ручку отмечающую сториз как просмотренную, при достижении N просмототров удалять сториз из канала
