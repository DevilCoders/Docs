## Промо-плашка "Ваш заказ из Яндекс.Маркета"

### Бизнес-описание

Сейчас клиент может заказать доставку своей покупки из Маркета по клику в Лавке, а не в Доставке, что не логично.

Флоу предполагается следующий:
- Если у пользователя есть активные заказы Маркета с доставкой, на кирпичике Доставки отображается цифра 1 в кружочке.
- Пользователь тапает на кирпичик Доставки и переходит на саммари, где над кнопкой "Заказать" нужно отобразить плашку "Ваш заказ из Яндекс.Маркета".
- По тапу на плашку открывается либо список заказов (если их больше одного), либо карточка с заказом, если он один.
- Дальше пользователь может дозаказать еще продуктов из Лавки, чтобы за одну доставку ему привезли все сразу.

- Бизнесовое описание проекта есть [здесь](https://st.yandex-team.ru/LOGPROD-190).
- Задача доработок бэка и клиентов [здесь](https://st.yandex-team.ru/TAXIPROJECTS-1969).

### Как делать

Предлагается добавить новый источник промоплашек, который интегрировать в ручку `/4.0/inapp-communications/promos-on-summary` сервиса `inapp-communications`.

Можно было бы сделать плашку на базе сервиса `inapp-communications`, если бы плашка была статическая.
Однако требуется некая логика, завязанная на заказы ПВЗ (пункты выдачи заказов), поэтому будет отдельная ручка.
Ручку предлагается добавить в сервис `cargo-misc`, так как этот сервис является источником активных заказов ПВЗ, отдаваемых в ручке `launch`.

#### Доработки на клиентах

Чтобы избежать гонки в активных заказах доставки, клиенты будут передавать в запрос к ручке `/4.0/inapp-communications/promos-on-summary` массив `state.known_orders`, содержащий идентификаторы заказов, полученных из ответа ручки `launch`.

Формат записей в массиве:
```json
{
  "state": {
    "known_orders": [
      "taxi:<taxi_order_id>:revision",
      "eats:<eats_order_id>",
      "grocery:<grocery_order_id>",
      "shipment:<shipment_id>"
    ],
    ...
  },
  ...
}
```

Сейчас промоплашки показываются:
- на саммари над кнопкой заказать: https://jing.yandex-team.ru/files/alexeybykov/promo_summary.jpg
- в карточке тарифа: https://jing.yandex-team.ru/files/alexeybykov/promo_tariff_card.jpg

Промоплашки доставки не хочется показывать в карточке тарифа.
Для этого в ответ для промоблока добавляется опциональное поле `show_only_on_summary`, которое говорит, скрывать ли промоплашку в карточке тарифа.

Пример промоблока с новым полем в ответе ручки `/4.0/inapp-communications/promos-on-summary`:
```json
{
  "offers": {
    "promoblocks": {
      "items": [
        {
          "id": "pickup_points_shipment_promo:cargo:b1c6f2ef994941caa00d5cfe05823156",
          "display_on": ["summary"],
          "meta_type": "pickup_points_shipment_promo",
          "supported_classes": [
            "cargo"
          ],
          "title": {
            "items": [
              {
                "type": "text",
                "text": "Ваши заказы из Boxberry"
              }
            ]
          },
          "text": {
            "items": [
              {
                "type": "text",
                "text": "Доставка в один клик"
              }
            ]
          },
          "widgets": {
            "deeplink_arrow_button": {
              "deeplink": "yandextaxi://route?tariffClass=cargo&expandingState=true",
              "color": "#000000",
              "items": []
            }
          }
        }
      ]
    }
  }
}
```

Соответствующее изменение в схеме:
```yaml
PromoblockItem:
    type: object
    properties:
        display_on:
            description: |
                Список мест, в которых нужно отображать промоблок.
                Если список не передан - промоблок отображается во всех
                предусмотренных местах.
            type: array
            items:
                type: string
                enum:
                  - summary
                  - tariff_card
```


#### Доработки в сервисе `inapp-communications`

Добавляем новый тип промо - `cargo_pickup_points_orders`, который включается, только если есть активные заказы ПВЗ, о чем будет понятно по списку `known_orders`.
Будем ходить в сервис `cargo-misc` за промоплашкой, если есть активные `shipments` в присланном `known_orders`.
Список известных `shipments` будем передавать в запросе к сервису `cargo-misc`, чтобы в промоплашке учитывались только они.

#### Доработки в блендере

Разработчик блендера (@tilgasergey) сказал, что скорее всего не потребуется доработок, чтобы для тарифов определенной группы всегда показывать определенную плашку.
Кажется, здесь достаточно при наличии активных `shipments` на тарифах вертикали "Доставка" показывать промо, полученные в сервисе `cargo-misc`, иначе можно показывать что-то с более низким приоритетом.

#### Доработки в сервисе `cargo-misc`

Добавляем ручку `/pickup-points/v1/shipments/promos`, которая возвращает промоплашку, если у пользователя есть активные заказы.

RPS у ручки будет небольшим первое время, так как сейчас я не нашел запросы в проде, которые бы возвращали активные заказы ПВЗ: [логи](https://kibana.taxi.yandex-team.ru/goto/e41efa773902af98abe487bd087a9fb8).
Если всегда будут приходить активные `shipments`, то оценка сверху на RPS ручки - 250 в пике, судя по ручке `/4.0/inapp-communications/promos-on-summary`: [графана](https://nda.ya.ru/t/5JMoPG8W3bbHzo).

Ручка будем принимать `personal_phone_id` пользователя и список `shipment_id`, для которых нужно получить промоплашку:
```(json)
{
  "personal_phone_id":"46baa0fc4e0a4d0795f50664795863b1",
  "shipment_ids": [
    "f753a489f6014ebf88958af2f7394323",
    "99360fd6a09645f4aa22b1386a8600d9"
  ]
}
```

В ответе будет промоплашка в формате, ожидаемом сервисом `inapp-communications`, пример ответа можно посмотреть [здесь](https://github.yandex-team.ru/taxi/rfc/blob/master/inapp-communications/summary_promoblocks_internal.md).
