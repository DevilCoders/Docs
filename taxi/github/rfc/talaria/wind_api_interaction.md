
**Название сервиса**

Talaria proxy

**Какую продуктовую проблему решает сервис?**

Для интеграции самокатов wind в приложение yango, нам необходимо ходить за данным в апишки wind которые находятся вне контура яндекса в amazon cloud


**Как именно сервис будет решать поставленные перед ним задачи?**

https://st.yandex-team.ru/SECREVIEW-1458  
https://st.yandex-team.ru/TAXIARCHREVIEW-845

Нам нужен надежный и секьюрный способ взаимодействия server to server с внешним апи


**Разрабатывается один сервис или система?**

Один

**С кем взаимодействует сервис?**

- Внешний api wind
- personal

**Какие базы использует?**

Никаких

**Какие периодические процессы?**

Никаких

**Какие данные и по какой схеме сервис будет хранить в базе?**

Будем хранить только связку personal_phone_id -> wind user_id в LRU cache

**Какой объем данных будет храниться и какой объем будет изменяться в единицу времени?**

Уточняю

**Какие операции над данными заложены?**

Никаких

**Какие данные пользователей будут храниться в сервисе?**

В LRU кеше будем держать связку personal_phone_id -> wind user_id

**Есть ли какой-то стейт в памяти, как он обновляется и валидируется?**

Только LRU cache для связки personal_phone_id -> wind user_id

**Какая нагрузка ожидается?**

Уточняю

**Какие фолбеки предусмотрены на сам этот сервис?**

Никаких

**Какие возможности масштабируемости закладываются?**

Горизонтальные и вертикальные


**Какие точки отказа есть в сервисе?**

Внешний апи партнера

**Укажите ключевые продуктовые метрики сервиса, за которыми планируете следить**

Уточняю

**Укажите технические метрики**

Количество 5xx
 
**Какая функциональность ожидается в сервисе в будущем?**

В будущем хотим сделать это единым прокси сервисом для партнера wind, при возможном появлении других партнеров так же можем использовать этот прокси

**Какое изменение нагрузки планируется?**

Уточняю

**Активно ли будет изменяться сервис?**

активно


# Архитектура

## Общий флоу

Данный прокси задумывается как единая точка взаимодействия для клиентов, для определения в какой бекенд ходить предлагается использовать api_tags, присылать заголовок x-api-tag в заголовке к каждому запросу. По api_tag прокси будет понимать в какой бекнд проксировать запрос.

## Как будет устроено взаимодействие с wind

Для начала мы должны получить phone_number текущего пользователя, делать это будем через сервис personal, сервис talaria-proxy призван под капотом производить обмен personal_phone_id -> wind userId и далее проксировать все запросы с wind userid идентификатором дальше в talaria-services, связку personal_phone_id -> wind userId будем кешировать в LRU кеше, далее все запросы будут проксировать к talaria-services, а они в свою очередь уже будут ходить в wind api имея все идентификаторы.

## Как будет организованно server to server взаимодействие с wind?

Придумываем и обмениваемся api key, далее присылаем api key в заоловках к каждому запросу, так же для большей безопасности коллеги добавляем наш ip в свой whitelist.


### Схема работы 
![image](static/proxy/talaria_proxy_flow.jpg)


## Оценка
- [2w] Создать сервис `talaria-proxy` и реализовать логику проксирования, подписи и валидации jwt токенов
