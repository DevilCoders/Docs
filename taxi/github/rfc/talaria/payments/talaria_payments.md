# Ответы на вопросы архревью

**Название сервиса**

talaria-payments

**Какую продуктовую проблему решает сервис?**

Мы делаем самокатную интеграцию с Wind (компания поглощается нами) в Израиле, где Wind для всех платежей использует внешнего партнера - tranzila. Нас это не устраивает по следующим причинам:
- пользователь не сможет использовать для оплаты карты уже введенные в yango
- схема с оплатой через tranzila плохо сочетается с аудиторскими проверками
  
Для решения вышеописанных проблем предлагается:
1. создать сервис при помощи которого Wind сможет проводить все платежи через наш TRUST
2. создать механизм миграции пользовательских карт из tranzila в наш сервис (вероятно частично будет реализован в этом сервисе, но основная часть будет реализована внутри траста)
3. создать механизм регистрации всех платежных транзакций и изменений баланса кошелька в нашем тлоге. 


**Почему нельзя решить эту задачу без разработки нового сервиса существующими решениями?**

На текущий момент не существует никаких решений для интеграции с Wind и Tranzila.


**Как именно сервис будет решать поставленные перед ним задачи?**

Основным инструментом решения поставленных задач будет служить сервис transactions. Разрабатываемый сервис будет адаптировать внешние запросы от wind во внутреннии для transactions. Все транзакции будут сразу клириться.


**Разрабатывается один сервис или система?**

1 сервис 

Дополнительно можно было бы создать еще сервис для авторизации внешних запросов от Wind, но этот вопрос прорабатывается отдельно (и вероятно будет решен как-то единообразно для всех сервисов принадлежащих Яндексу но находящихся при этом вне инфраструктуры Яндекса) поэтому с этим имеет смысл повременить. Пока вопрос не будет окончательно решен будем авторизовывать по api-ключу непосредственно в этом сервисе.

Также возможно потребуется создать сервис для работы с wind-пользователями, но тогда будем делать это отдельно (с отдельным архревью).

**С кем взаимодействует сервис?**

Wind -> talaria-payments -> transactions:
- запуск платежных транзакций
- получение информации о транзакциях
- рефанд

transactions -> talaria-payments -> Wind: 
- колбэк для изменения состояния транзакции (через stq)


Все операции идемпотентны - для обеспечения используется соответствующий ключ в запросе, который будет транслироваться в сервис  `transactions`. 



**Какие базы использует?**

БД не используем. Делаем stateless сервис (с небольшой оговоркой на то, что некий временный стейт может сохраняться в stq)

**Какие периодические процессы?**

Скорее всего никаких. Если только не захотим сделать периодическую миграцию карт пользователей из tranzila в trust (но это решение будет временным, т.к. постепенно Wind полностью перейдет на оплату через нас)


**Прикрепите схему того, где этот сервис находится в текущей инфраструктуре**

Схема предельно проста: Wind -> talaria-payments -> transactions (по сути этот сервис это адаптация внутреннего сервиса transactions для внешних запросов от Wind)


**Есть ли какой-то стейт в памяти, как он обновляется и валидируется?**

не планируется

**Какая нагрузка ожидается?**

не более пары десятков rps

**Какие фолбеки предусмотрены на сам этот сервис?**

Фолбэки не предусматриваются. Но в случае отказов сервиса, колбэк по уже начатой транзакцию будет дожиматься через ретраи stq.

**Какие фолбеки предусмотрены внутри этого сервиса на взаимодействие с другими сервисами?**

Фолбэки не предусматриваются.

**Какие возможности масштабируемости закладываются?**

сервис стейтлес и прогнозируемая нагрузка очень мала => нам тут не на что закладываться 

**Какие точки отказа есть в сервисе?**

- сервис transactions

**Укажите ключевые продуктовые метрики сервиса, за которыми планируете следить**

За продуктовыми метриками скорее всего через этот сервис следить не будем. Но при необходимости конечно можем следить за платежами.

**Укажите технические метрики**

стандартные, ничего необычного


**Какая функциональность ожидается в сервисе в будущем?**

Разработка планируется в 2 этапа.

Этап 1:

Цель этапа- интеграция yango->wind которая должна позволить нам оплачивать поездку на wind-самокате через приложение yango (карточками yango). Целимся успеть к 1 мая 2022. В рамках этого этапа:
1. Создаем сервис talaria-payments как обертку над сервисом transactions для адаптации его под Wind. Через это API Wind будет проводить платежи из yango но не из приложения Wind
2. СОздаем механизм миграции банковских карт tranzila->trust


Этап 2:

Цель этапа - подготовиться к аудиторским проверкам. Дедлайн - 1 сентября 2022. В рамках этого этапа:
1. Wind начинает проводить платежи в своем приложении через наш сервис
2. Создаем механизм регистрации всех изменений по платежам и кошельку в тлоге


**Какое изменение нагрузки планируется?**
с единиц rps до десятков

**Активно ли будет изменяться сервис?**

    скорее всего пишем код 1 раз и надолго



# Архитектура

общую диаграмму последовательности можно посмотреть [здесь](wind-rfc/payments_sequence_diagram.plantuml)

## API

API описано [здесь](wind-rfc/payments.md)

### ручка /payments/create 

Создаем в сервисе `transactions` новый `invoice`, запускаем по нему транзакцию и сразу же запускаем клир.

### ручка /payments/retrieve

Проксируем вызов в ручку `/transactions/invoice/retrieve`

### ручка /payments/update

Вызываем `/transactions/invoice/update`

### колбэк на изменение состояния транзакции

Создаем stq-колбэк который будет вызываться из сервиса `transactions` при обновлении статуса транзакции.
В нем: 
1. если поймали неуспешный холд или клир вызываем колбэк Wind и передаем статус `failed`
2. если поймали успешный клир вызываем колбэк Wind и передаем статус `success`


### механизм миграции карт
Создаем stq таску в сервисе talaria-payments. Эта stq будет вызываться при первой авторизации пользователя yango как пользователя wind. Внутри будем вызывать ручку в трасте, которую также нужно будет написать

Ручка в трасте сначала сходит в wind за данными пользователя, затем пойдет в tranzila чтобы получить PAN, затем преобразует и сохранит данные .


### ручка для получение yandex_uid по wind_user_id

Эта ручка может понадобиться Wind для получения yandex_uid

Пока самая непонятная часть. По wind_user_id мы можем получить телефон, далее по нему можем получить набор yandex_uid (как фонишей так и портальный) или вообще не получить (если этот пользователь еще не зарегался в yango).

Тут надо отдельно прорабатывать что делать с незареганными пользователями: можем ли мы создавать yandex_uid налету (скорее всего нет) или можем ли мы проводить транзакции для каких-то внешних пользователей или на крайний случай проводить все транзакции по фиктивному пользователю.

Пока можно быо бы обойтись тем, что создать базу и сохранять в нее все новые связки yandex_uid->wind_user_id а для преобразования wind_user_id->yandex_uid просто использовать самую актуальную запись в бд по этому wind_user_id (и такая запись всегда обязана быть в этой базе, т.к. на первом этапе у нас будут только пользователи yango).

Совсем в идеале нужно обойтись без этой ручки. yandex_uid должен быть проброшен в wind на всех этапах, которые требуют исполнения платежей (также как и payments_method)


# Оценка 1-го этапа

[1d] создание механизма авторизации по api-ключу
[3d] ручка /payments/create 
[1d] ручка /payments/retrieve 
[2d] ручка /payments/update
[2d] механизм колбэка на изменение состояния транзакции через stq
[5d] механизм миграции карт из tranzila в trust
[2d] запуск миграции карточек в talaria-proxy (или в новом сервисе talaria-users) при обнаружении нового пользователя
[5d?] (скорее всего не будем делать) ручка в сервисе talaria-proxy (или в новом сервисе talaria-users) для получения yandex_uid по wind_user_id (тут большая неопределенность пока в том ка будем делать и возможно нужно закладывать больше)


ИТОГО: 
16d ~= 4w (с запасом)

