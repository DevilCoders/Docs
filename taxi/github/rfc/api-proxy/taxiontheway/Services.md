## Описание сервисов

## Текущие вопросы к ревьюерам
1. Илья - ок такая схема с отменой через сервис order-canceller? Детали в order_canceller.md
2. Юра - мб стоит объединить order-info и order-route-info? Детали в order_info.md и order_route_info.md
3. Сергей Усков - ок схема со сбором данных о водителе в сервисе driver_info? Детали в driver_info.md
4. Никита - кажется, с тобой мы обсуждали софтсвитч, поэтому прошу тебя посмотреть на order_phones. Если не по адресу, буду искать дальше.
5. Вова - глянь на сервис hourly_rental, насколько похоже на правду.


##  Disclaimer
0. Здесь описание сервисов, схема распилки в Split scheme table.md
1. Верхнеуровнево идея такая:
  - Есть order-core/order-info - он должен дать нам основную часть order_proc заказа. Цена, точки А-Б, базовая информация о водителе. Его ответа в общем случае достаточно.
  - Помимо этого он должен дать нам базовые данные для других сервисов, вроде driver_id, phone_id пассажира итд.
  - И есть набор микросервисов, которые принимают order_id и какие-то доп параметры в виде того же driver_id.
  - Эти микросервисы ходят за своими специфичными данными в прок или свою базу и готовят свою часть ответа.
  - Вначале практически все сервисы ходят в прок, позже начинают забирать данные себе в базу и перестают ходить в прок.
  - Данные из прока микросервисы получаются через ручку order-fields сервиса order-core
  


## Вопросы и иногда ответы
#### Насколько обязательно вернуть эксперименты клиенту?
Эксперименты можно вернуть пустые. А вот конфиги на платформе экспериментов, когда начнем их возвращать - нельзя.
#### Будет ли кеш в api-proxy?
Важный момент. В кеше можно было бы держать эксперименты или ответы редко обновляющихся ручек.
#### Проверка, что заказ принадлежит пользователю
order-core/order_info уже ищет прок с учетом юзера. Если order_info не найдет нужный прок, вызывать следующие ручки не будет иметь смысла.
Так что order_info неявнно еще и делает авторизацию.
Но в сервисе кеша над проками тоже нужно искать по order_id+user_id/yandex_uid.
И когда сервисы будут забирать себе данные из прока, и они должны будут искать по order_id+user_id/yandex_uid.


##  Полный перечень необходимых микросервисов
+ order-core
+ order-info(NEW)
+ order-canceller(NEW)
+ performer-info(NEW)
+ order-route-info(NEW)
+ order-phones(NEW)
+ user-api
+ preorder
+ hourly-rental(NEW)
+ reorder(NEW)
+ multiorder(NEW)
+ code_dispatch
+ taxi-stories
+ tips(NEW)
+ feedback
+ feedback_info(NEW)
+ exp3-matcher


## order-core/order_info
Достает основные данные по заказу из монги.
Уже существует и даже используется на группе разработки инфраструктуры пользовательских продуктов.
Все остальные данные нужно постепенно прицеплять к ответу order-info.

Нужно добавить в ответ. Илья писал про private data, но я не нашел.
phone_id
driver_id
park_id
due
Мб что-то еще.
####  Fallback
Точно не 200. В зависимости от ответа сервиса или 500 или 404 или что-то еще.

<hr>
## Микросервисы


## Получение микросервисами данных из прока
Раньше здесь была проработка сервиса над активными заказами в order_proc. Концепция поменялась, теперь мы будем пользоваться ручкой order-fields сервиса order-core. Ручка универсальная, то есть получает список полей прока, которые нужно вернуть.


##  order-info(NEW)
Сервис, в котором можно спросить инфу по заказу. Подробнее в order_info.md

### Ручка /cost
Расчет текущей стоимости поездки.
### Ручка /changes
Изменения в заказе, которые можно внести и которые уже внесены.
### Ручка /route_sharing
Вернуть route_sharing_url из прока.
### Ручка /extra_contact_phone
Если в проке есть extra_contact_phone, то сходить в user-api за номером телефона и вернуть его.
### Ручка /granted_promotions
Заполняет поля order_granted_promotions и higher_class_dialog на основании granted_promotions из прока.


## Сервис order-canceller(NEW)
Правила отмены, расчет стоимости и собственно отмена.
Подробнее в order_canceller.md

Важно: этот сервис будет рассчитывать на то, что прайсинг уже умеет считать отмену. То есть до того момента, как  будет готов прайсинг, отмену нужно делать через старый taxiontheway. То есть отмена - идем в taxiontheway, обычный запрос - собираем данные по сервисам.

### Ручка cancel
Собственно, отмена. Если запрос отмены, то идем сюда, если нет, то в order_info/cost.
### Ручка cancelled_by
Кем был отменен заказ, если он отмененен
### Ручка cancel_rules
Правила отмены


## Сервис performer-info(NEW)
Сервис получения данных по водителю, выполняющему заказ. Специально для taxiontheway по сути,
и подобных мест, где нужна инфа о водителе в контексте заказа.
Подробнее в performer_info.md

### Ручка driver_info
Достает данные по водителю. 
### Ручка deaf_driver
Если водитель глухой, то добавляет нужные модификации в ответ.
### Ручка park_info
Достает данные по парку 


## Сервис order-route-info(NEW)
Информация о маршруте заказа и текущей позиции водителя на нем.
Подробнее в order_route_info.md

### Ручка driver_pos
Ходит в трекер за позицией водителя, driver_id берет из прока.
### Ручка route_info
Формирует инфу о маршруте. В driving водителя к пассажиру, в transporting - от текущей точки к точке назначения.
### Ручка candidates_cars
Cходить в трекер за позициями найденных лукапом водителей. Это координаты на основании того, что лежит в кандидатах.


## Сервис order-phones(NEW)
Сервис будет хранить контактную информацию, связанную с заказом.
Подробнее в order_phones.md
### Ручка driver_phone
Вернет телефон водителя с софтсвитчом


##  Сервис user-api
### Ручка user_phones/get
Достает данные по юзеру.
####  Fallback
Можно дефолтное значение взять.

### Note
Стремно конечно ради одного флага ходить, но возможно, данные о телефоне еще где-то окажутся нужны.

```json
{
    "user_phone_id": "some_phone_id"
}
```

```json
{
   ...
   "is_loyal": false,
   ...
}
```

## Сервис chat
####  Ручка check_enabled(NEW)
Проверяет, если чат водителя с пассажиром активен, заполняет driverclientchat_enabled
####  Fallback
Можно не возвращать.

### Note
Сейчас этот флаг лежит в проке, но можно двигаться в сторону уменьшения прока и хранить этот флаг в сервисе
чата по order_id.

```json
{
    "order_id": "some_order_id"
}
```

```json
{
   "driverclientchat_enabled": false,
}
```


## Сервис preorder
#### Ручка status_info(NEW)
Проверяет, если предзаказ, то заполняет status_info
####  Fallback
Можно не возвращать.

```json
{
    "order_id": "some_order_id"
}
```

```json
{
  "status_info": {},
  "max_waiting_time": "",
  "departure_time": ""
}
```


## Сервис hourly_rental(NEW)
####  Ручка status_info
Проверяет, если букинг, то заполняет status_info.
Подробнее в hourly_rental.md


## Сервис reorder(NEW)
Отвечает за реордер и автореордер.
Подробнее в reorder.md
#### Ручка suggest_reorder
Готовит кнопку с предложением реордера.
#### Ручка autoreorder
Информирует об автореордере.


## Сервис multiorder(NEW)
Берет на себя логику работы с мультизаказом.
Подробнее в multiorder.md
####  Ручка order_info
Если мультизаказ, возвращает имя заказа. И информацию, можно ли сделать еще один заказ.


## Сервис code_dispatch
####  Ручка order_info(NEW)
Проверяет, если заказ по коддиспатчу, то заполняет code_dispatch.
Можно будет заодно забрать данные из order_proc.extra_data в сервис.
####  Fallback
Можно не возвращать.
```json
{
    "order_id": "some_order_id"
}
```

```json
{
  "code_dispatch": {}
}
```


## Сервис taxi-stories
###  /4.0/stories
Достает промоистории.
#### Fallback
Ничего, не показываем stories.

### Note
Эта инфа занимает 600+ строк в ответе. 600 строк текста это конечно мелочи, но это все едет в логи, занимает место и мешает их читать.

**Можно выпилить это из tow.**
Уже есть ручка для историй и клиенты даже умеют в нее ходить из Центра безопасности. Допилить немного и все.
stories.taxi.yandex.net/4.0/stories?order_id=5d9179c7d48e395783dc3f5b64d1ac5c&context=safety_center
Предлагаю создать задачку на клиенты.
@privet
Нужно убедиться, что taxi-stories не загнется от totw-РПСа.
Сейчас при передаче order_id идет поход в archive_api, чтобы проверить, что данный заказ принадлежит пользователю. Нужно поправить параметры ручки или даже сделать новую, чтобы не делать авторизацию.

**Можно научиться опрашивать с пониженной частотой**
Тогда нужно научить сервис stories понимать новый context и соответственно возвращать нужные stories.

```json
{
  "context": "taxiontheway",
  "order_id": "some_order_id"
}
```

```json
{
  "stories": [
    {
      "button_link": "https://odna.co/poll/PUQrCWuThPeb3EkN2TbFaF",
      "button_title": "",
      "media": [],
      "name": "20200129_RU_questions_kids",
      "teaser_image": "https://promo-stories.s3.yandex.net/20191114_RU_questions_kids/ru/ c2b4fe1ff7910f674c706f3a4658de4f1f01cd43.png"
    },
  ]
}
```

## Сервис tips(NEW)
Берет на себя логику чаевых.
Подробнее в tips.md
Возможно, и для оплаты пригодится, в частности, в проекте с чаевыми по корпоплате.
### Ручка order_tips
Достает чаевые из ордерпрока. Позже можно начать хранить чаевые в сервисе.
### Ручка tips_suggestions
Значения чаевых на выбор.


## Сервис feedback
Старый сервис фидбеков.
Подробнее в feedback.md
### Ручка 2.0/retrieve(NEW)
Достает текущий фидбек из своей базы.

## Сервис feedback_info(NEW)
Отвечает за информацию об оценках: тексты и типы причин оценок.
Подробнее в feedback_info.md
### Ручка low_rating_reason
Достает причины низкой оценки водителю
### Ручка feedback_badges
Достает тексты и типы причин оценки, и для хороших и для плохих оценок


## exp3-matcher
Новый сервис от команды Никиты Илясова. И в нем будет ручка, которую можно будет использовать из api-proxy для клиентских экспериментов.
Именно клиентские эксперименты это скорее вопрос api-proxy и сервиса exp3-matcher, потому что это не специфичная для totw вещь, она для всех ручек актуальна.

Часть переписки про это:
Руслан Алиев, [26.03.20 16:35]
а мы можем тогда как-то через api-proxy возвращать клиентские эксперименты?
Ilya Sidorov, [26.03.20 16:36]
нет, для этого @Rainburst готовит сервис
Ilya Sidorov, [26.03.20 16:36]
там фишка в том, что есть ещё какие-то переводы и прочая логика
[ONLINE] Nikita Ilyasov, [26.03.20 16:37]
[In reply to Руслан Алиев]
Только exp3 marcher ещё не в проде.  Но такая ручка  в нем будет, да. С переводами
[ONLINE] Nikita Ilyasov, [26.03.20 16:38]
А логику и переводы наверное не очень хочется тащить в api-proxy, да, @Lol4t0?
[ONLINE] Nikita Ilyasov, [26.03.20 16:39]
Клиент должен нормально переживать отсутствие экспериментов
Ilya Sidorov, [26.03.20 16:39]
если появится технология запуска в отдельном процессе локального кеша, тогда можно будет думать

### Ручка v1/experiments
####  Что делает
Получает список экспериментов по кваргам и консумеру. Кварги берем из заказа, консумер taxiontheway.
Полный список кваргов здесь protocol/lib/src/views/taxiontheway.cpp/PrepareKwargsBuilderForExperiments3
#### Fallback
Ничего, не показываем эксперименты. С экспериментами можем себе позволить.

