# Что
Выносим чаевые из `db.orders` в базу чаевых


# Зачем

Убираем зависимость от order-proc и db.orders при сохранении чаевых, тк из-за них у сервиса нестабильные тайминги и есть фон ошибок. Ожидаемый результат после всех изменений:
1. Ощутимое улучшение стабильности ручки tips/update-tips
    * Уменьшение фона ошибок до нуля
    * Улучшение таймингов: 50ms в 95 перцентиле
2. Уменьшение нагрузки на чтение из `db.orders`

# Как

## План

### Этап 1: Выключение protocol/feedback
Для начала нам надо перестать использовать protocol/feedback, чтобы быть уверенными что все запросы на обнолвение чаевых проходят через сервис tips

1. Изменяем ручку api-proxy/feedback таким образом чтобы в protocol/feedback запросы шли только при отключении конфига

После этого у нас есть гарантии что все запросы на изменение чаевых проходят через сервис чаевых если не включили фолбэк

2. Включаем проверку чаевых в базе tips

### Этап 2: сохранение значений чаевых в tips
1. Делаем миграцию базы
2. Изменяем stq-таску и ручку обновления чаевых таким образом чтобы писать чаевые в базу сервиса tips
3. Делаем выгрузку чаевых в YT (через сервис репликации)

Добавляем в базу новые поля:
* `tips_type` - enum (percent, flat)
* `tips_value` - str (float?)
* `created_time` - datetime, используем для защиты от гонок по аналогии с passenger-feedback

Для того чтобы бороться с гонками клиентских запросов используемый передаваемый в фидбеке параметр `created_time` по аналогии с ручкой сохранения фидбека - пишем новое значение чаевых в базу только если `request_created_time > db_created_time`

В stq при создании заказа из processing2 также кладём `tips_type` и `tips_value`. В самой stq-таске пишем все эти значения в базу ТОЛЬКО если в базе уже нет записи. Если в базе есть запись, то значит пользователь уже выставил новые чаевые через фидбек и перезаписывать их не надо

### Этап 3: депрекация protocol/feedback
На этом этапе нам нужна гарантия что все чаевые всегда будут проходить через сервис tips, поэтому:
1. Полностью выпиливаем фолбэк на протокол из api-proxy/feedback

Тк чаевые - не критичный флоу для работы сервиса, то можно согласиться с рисками что если passenger-feedback или tips лежат то могут быть проблемы с чаевыми

Не забываем также выпилить:
1. Конфиг для переключения на протокол в api-proxy
2. Ручку protocol/feedback
3. Ручку passenger-feedback/v1/feedback

### Этап 4: использование чаевых из tips
На этом этапе мы можем начать использовать значения чаевых из tips а не из `db.orders`, тк теперь мы уверены что чаевые в нашей базе всегда правильные - все запросы по изменению чаевых проходят через сервис tips. Однако нам все ещё необходимо обновлять `db.orders` и `db_order_proc`, тк их используют аналитики и по ним строятся продуктовые метрики

1. Переписываем код ручек need-hold-tips и get-tips-sum на использование значений из базы tips
2. Переписываем код ручки update-tips: В tips значение пишем сразу, а вместо обновления `db.orders` и `db_order_proc` ставим stq-таску "update_order_proc"
3. Заводим stq-таску "update_order_proc": она берёт значение чаевых для заказа из базы и пишет его в `db.orders` и `db_order_proc`

Тк для бизнес-логики мы используем базу tips, то запись в базу заказов уже не обязана быть синхронной чтобы всё нормально работало, а для аналитики и продуктовых метрик можно позволить себе писать в базу с задержкой. Использование stq-таски позволит нам:
1. Улучшить тайминги ручки update-tips
2. Увеличить надёжность ручки update-tips (не будем зависеть от доступности order-core и db.orders)
3. Не сломать продуктовые метрики и рассчёты аналитиков

### (Опциональный) Этап 5: выпиливание из db.orders
Тк продуктово чаевые в `db.orders` больше не нужны, можно перестать писать их в коллекцию `db.orders`. Для этого:

1. Нужно написать об этих планах на общую рассылку - "планируем перестать писать чаевые в db.orders, плс напишите как вы их используете и зачем". Тут ещё надо уточнить что мы убираем не "списанные чаевые" (они в payment_tech), а "выбранные пользователем чаевые" (они в creditcard.tips)
2. Поговорить с аналитиками и создателями продуктовых дашбордов по чаевыем. Возможно они и так используют payment_tech и их не затронет
3. Выпилить из tips код и stq-таску "update_order_proc"

## Оценка по времени

Грубая оценка такая:
1. Этап 1: 0.5 дня
2. Этап 2: 2 дня
3. Этап 3: 2 дня
4. Этап 4: 2 дня
5. Этап 5: 2 дня

Итого: 8.5 дней
