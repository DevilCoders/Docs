# Что
Показываем чаевые водителю только тогда когда уверены что пользователь их не изменит

# Зачем
Потому-что у водителей куча негатива из-за того что чаевые отменяют, "забирая" у них со счёта деньги. Подробнее в тикете [TAXIPROJECTS-1708](https://st.yandex-team.ru/TAXIPROJECTS-1708)

# Как

Данная проработка рассчитывает, что изменения из [RFC#643](https://github.yandex-team.ru/taxi/rfc/pull/643) уже сделаны.

## Учимся определять что чаевые не будут изменены
Сейчас чаевые задаются только в двух местах:
1. При создании заказа (дефолтные чаевые)
2. При сохранении фидбека (пользователь выбирает чаевые)

При этом пользователь может изменить чаевые:
1. Сколько угодно раз во время поездки - запросы в protocol/feedback идут при каждом нажатии чаевых
2. _Один_ раз после окончания поездки - запрос в protocol/feedback отправляется только после нажатия на кнопку "Далее" на экране фидбека (todo: отправляется ли при сворачивании фидбека?)

Внутри фидбека мы знаем происходит этот запрос во время поездки или после её окончания: фидбек ходит в order-core, и по нему определяет находится ли заказ в статусе "FINISHED". Мы можем прокинуть это поле как флаг "tips_is_final" вместе с сохранением чаевых.

**Что делаем**: прокидываем флаг `is_final` вместе с отметкой про чаевые из ручки protocol/feedback и сохраняем его в базу `tips`.

## Не списываем чаевые пока они могут измениться

За снятие чаевых в первый раз отвечает [код сервиса tips](https://github.yandex-team.ru/taxi/uservices/blob/cedaaa50f45899aba39e9db34234076ec5fe6116/services/tips/src/utils/orders.cpp#L440).

Нужно изменить следующие вещи:
1. Завести эксперимент для раскатки нового флоу чаевых
2. Если эксперимент включён для данного заказа:
  * Использовать `time_before_take_tips` из эксперимента а не из конфига
  * Списывать чаевые если: прошло больше чем `time_before_take_tips` ИЛИ (есть положительный фидбек И этот фидбек финальный)


### Эксперимент

Потребители: tips

Используемые параметры эксперимента: phone_id, country

Структура эксперимента:
```json
{
    "time_before_take_tips": 86400
}
```
В поле `time_before_take_tips` указываем время в секундах после которого считаем что чаевые "зафиналились" и их можно списывать. Возможные значения, с которыми стоит провести эксп:
* `86400` - сутки, ожидается что 100% чаевых финалятся за это время. У пользователей могут быть вопросы "что за списание через сутки после поездки", зато у водителей гарантировано должна пропасть "боль"
* `10800` - три часа, ожидается что 95% чаевых финалятся за это время. Скорее всего закроем большинство "болезненных" ситуаций для водителей, но при этом не сильно ухудшим UX пользователей

## Учим update_transactions откладывать операцию на правильное время
Сейчас мы определяем нужно ли запланировать итерацию update_transactions на основании [ответа ручки need-hold-tips](https://github.yandex-team.ru/taxi/backend/blob/develop/taxi/internal/order_kit/invoice_handler.py#L4359). При этом ETA следующей итерации рассчитывается на основании [захардкоженого значения](https://github.yandex-team.ru/taxi/backend/blob/e8e6052e1baa3cfd5a857902cf8f3e08f7184251/taxi/internal/order_kit/invoice_handler.py#L4365).

Нам нужно планировать следующую операцию на время `time_before_take_tips` которое мы используем в сервисе tips.

Самое простое решение - расширить ответ ручки tips/need-hold-tips, добавив туда поле time_before_take_tips, и использовать значение этого поля для рассчёта eta в update_transactions.

## (Опционально) Рассылаем пользователям push-уведомление "скоро спишем у вас чаевые"
Так как списание может произойти сильно позднее завершения поездки (максимум - через сутки), то пользователей можно заранее предупреждать о списании пушом "не нравится - измените чаевые на экране фидбека в приложении"

Пуши будем отсылать через сервис ucommunications

### Вариант 1
Пуш можно слать из функции need-hold-tips - в этом случае мы можем высылать его сразу после окончания заказа.

Плюсы:
* Всегда отправим пуш пользователю

Минусы:
* БОльшая нагрузка на ucommunications (запросы при каждом вызове need-hold-tips)

### Вариант 2
Пуш можно слать из processing2.0 после завершения поездки походом в ucommunications

Плюсы:
* Не нужно городить дополнительную логику в need-hold-tips

Минусы:
* При раскатке эксперимента в него попадут заказы которые уже завершены, для них клиентам не придёт пуш


# Ограничения

## Только в России
Новый флоу чаевых мы можем раскатить только на РФ, так как в РФ мы платим за операцию процент от суммы транзакции, в то время как в других странах есть фиксированная стоимость. Если мы раскатим этот флоу в другие страны, то у нас увеличится количество операций (из-за того что чаевые будут всегда отдельно) и увеличатся операционные расходы

__ВАЖНО__: это ограничение надо прописать в описании эксперимента, чтобы потом случайно его не раскатили по незнанию на другие страны

## Плавная раскатка экспериментом
Новый флоу может уронить количество чаевых, так как они будут списываться позже и мы (опционально) будем предупреждать пользователя о списании. При раскатке надо следить, что чаевые не сильно просели

## Чаевые станут медленнее для водителей
Раньше дефолтные чаевые холдились через 30 минут после окончания поездки и сразу отображались на счету водителя.

Теперь в поездках где стоят дефолтные чаевые и пользователь не закрыл окно фидбека после поездки (например, просто закрыл приложение) - мы будем списывать чаевые только когда уверены что пользователь не отменит (максимум - через сутки)

## Отключение эксперимента
При отключении эксперимента обработка чаевых вернётся на старый флоу, чаевые будут списаны по старым условиям. Ничего не потеряется.

# Другие варианты решения
Отсутствуют.

Были следующие идеи:
1. Создать промежуточный hold-счёт для баланса водителей, отображать водителям только cleared-операции
2. На стороне клиента таксометра скрывать чаевые которые находятся в статусе hold

В итоге пришли к пониманию что ни в коем случае нельзя что-то "скрывать" от водителя, так как это либо будет видно на других счетах либо ухудшит прозрачность выплат

# Сроки

Грубая оценка сроков. Не учитывает сроки оставшихся задач из [RFC#643](https://github.yandex-team.ru/taxi/rfc/pull/643).

1. `≈0.75 дня` Прокинуть флаг `is_final` и сохранить его в базе
  * Миграция базы
  * Прокидывание из api-proxy/feedback
  * Сохранение поля в базе
2. `≈0.75 дня` Снимать чаевые только когда пользователь не может их изменить
  * Завести эксперимент по которому мы будем раскатывать
  * Добавить новую логику проверки
3. `≈0.75 дня` Пофиксить расчёт ETA для планирования итераций update_transactions
  * Добавить новое обязательное поле в ответ ручки
  * Изменить расчёт ETA в update_transactions
4. `≈0.75 день` Настроить пуш-уведомления для пользователей
  * Завести танкерные ключи (с помощью менеджера)
  * Ходить в ucommunications

Итого: `≈3.5 дня`