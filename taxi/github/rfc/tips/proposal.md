# Чаевые через Applepay
Хотим добавить возможность оставить чаевые используя Applepay


## Как чаевые работают сейчас
Сейчас оплата чаевых доступна только через карту.

Бывает два типа чаевых:
* Дефолтные (процент, выставляется в настройках для каждой карты в приложении)
* После поездки (фиксированные)

После поездки чаевые отображаются только если она была оплачена по карте.

Вся информация по чаевым хранится прямо в заказе (order/order_proc):
```
{
    "billing_tech": {
      "service_orders": {
        "tips": "9d9a4a8ccad65b2c8c0c65f89a45b019_tips"
      },
      "transactions": [
        {
          "billing_response": {
            "status": "cancelled",
            "basket_rows": [
              {
                "amount": "25.50",
                "service_order_id": "9d9a4a8ccad65b2c8c0c65f89a45b019_tips",
                "quantity": "0.00"
              }
            ],
            "orders": [
              {
                "service_product_id": "643753730233_107182161_tips",
                "service_order_id": "9d9a4a8ccad65b2c8c0c65f89a45b019_tips",
                "service_product_name": "Tips for drivers",
                "orig_amount": "25.50"
              }
            ]
          },
          "sum": {"tips": 255000},
          "initial_sum": {"tips": 255000}
        }
    ],
    "creditcard": {
      "tips": {
        "type": "percent",
        "value": 10
      },
      "tips_perc_default": 10
    },
    "payment_tech": {
      "type": "card",
      "driver_without_vat_to_pay": {"tips": 0},
      "sum_to_pay": {"tips": 0},
      "without_vat_to_pay": {"tips": 0},
      "user_to_pay": {"tips": 0}
}
```

Обработка транзакций биллингом происходит в цикле заказа (update_transactions в монолите python2). Часть логики (биллинг) сейчас находится в процессе переноса в сервис transactions.

Используется тот же тип инвойса что и для такси. Бизнес-логика чаевых размазана там же. Например, TIPS_DONT_RESET_COUNTRIES ([конфиг](https://tariff-editor.taxi.yandex-team.ru/dev/configs/edit/TIPS_DONT_RESET_COUNTRIES?name=TIPS_DONT_RESET), [код](https://github.yandex-team.ru/toporkovm/backend/blob/develop/taxi/internal/order_kit/invoice_handler.py#L3730)).

Дефолтные чаевые списываем когда поездка окончена и оценка за поездку не отрицательная - спустя пол часа после завершения поездки.

При обновлении чаевых в конце поездки (на экране оценки) protocol/feedback обновляет order.creditcard и (если надо) вызывает update_transactions_iteration. Если пользователь выставил оценку, то чаевые списываем сразу (не ждём пол часа).

Чаевые часто (всегда?) пробиваются отдельным чеком ([тык](https://wiki.yandex-team.ru/users/toporkovm/taxi-tips/#testy)).


### Отображение чаевых в приложении
Отображение чаевых регулируется ответом TOTW.

Если `tips.available == True`, то будет отображён интерфейс чаевых ([код](https://github.yandex-team.ru/taxi/backend-cpp/blob/fd5300919d5cf01e5c9bca9ae29fa48cf054b44d/protocol/lib/src/views/taxiontheway.cpp#L1915-L1916)). tips.available проставляется только для оплаты по карте ([код](https://github.yandex-team.ru/taxi/backend-cpp/blob/fd5300919d5cf01e5c9bca9ae29fa48cf054b44d/common/orderkit/src/models/order.cpp#L213-L216)).

Чаевые могут отобразиться в статусах transporting и complete


### Изменение чаевых в приложении
Все обновления чаевых вызывают ручку protocol/feedback. Ручка updatetips _не используется_ ([1](https://st.yandex-team.ru/ITAXI-2390#5d972defa2b79e001d83a12f), [2](https://st.yandex-team.ru/ITAXI-7831#5e7a2cfbb656f949e3407bdd)).

При смене чаевых во время поездки UI не блокируется, ручка feedback будет дёргаться до победного конца. При этом походы в ручку feedback реализованы через очередь: если для заказа поступает новый запрос, а старый не отправлен - то старый запрос удаляется и заменяется новым. Запросы которые не были отосланы сохраняются персистентно (переживают перезапуск приложения) и высылаются при первой возможности.


### Изменение и списание чаевых
Все изменения вносимые пользователем сохраняются ручкой protocol/feedback в orders/order_proc заказа - в поля order.creditcard.

Обработка чаевых начинается после завершения поездки:
1. в update_transactions [вызывается](https://github.yandex-team.ru/taxi/backend/blob/5ffac8effec134ff74cb03c7f85e13bf9451e6cb/taxi/internal/order_kit/invoice_handler.py#L3368) функция _set_tips_sum
2. в [_set_tips_sum](https://github.yandex-team.ru/taxi/backend/blob/5ffac8effec134ff74cb03c7f85e13bf9451e6cb/taxi/internal/order_kit/invoice_handler.py#L3736) [проверяется](https://github.yandex-team.ru/taxi/backend/blob/5ffac8effec134ff74cb03c7f85e13bf9451e6cb/taxi/internal/order_kit/invoice_handler.py#L4355) что для заказа можно снимать чаевые (заказ закончен, оплата по карте, etc)
3. _set_tips_sum обновляет поля order.payment_tech, добавляя туда последнюю информацию по чаевым из order.creditcard
4. После этого transactions (пока код биллинга в backend, скоро будет вынесен) начинает обработку транзакии (в следующей итерации update_transactions)

## Что будем делать
Первым делом подключим applepay на старом флоу. Для этого нужно дождаться как фикс нескольких транзакций applepay доедет из траста до биллинга. После этого достаточно будет небольших изменений на клиенте и в бэкенде для того чтобы заработали чаевые через applepay.

Затем начнём процесс отделения чаевых от заказа. Начнём переносить логику в отдельный сервис tips, будем создавать отдельный инвойс для оплаты чаевых, отвяжем процесс оплаты чаевых от цикла заказа. Не забудем и про админку, добавив отображение и рефанд чаевых с использованием нового сервиса.


### Этапы

#### 1 Этап (MVP): чаевые applepay через старый флоу
Делаем чаевые через старый флоу (по аналогии с картами). В итоге пользователь сможет оставить чаевые во время поездки или в конце поездки.

1. (TRUST) Сделать фикс нескольких транзакций через applepay
2. (Billing) Поддержать фикс нескольких транзакций через applepay
3. (Бэкенд) Поддержать applepay как возможный тип оплаты
    1. Добавить эксперимент для раскатки чаевых applepay
    2. Возвращать tips.available в totw по эксперименту
    3. Разрешить (по эксперименту) обновлять чаевые в update_transactions
4. (IOS) Отображать чаевые для applepay во время и в конце поездки, в summary при получении токена (по эксперименту)

#### 2 Этап: отделение чаевых от флоу заказа
1. (Billing) Поддержка нового типа инвойса
2. (Billing) Связываение нескольких корзин по order_tag
3. (Бэкенд) Новый сервис tips
4. (Бэкенд) Интеграция нового флоу в update_transactions
5. (Бэкенд) Ручки для админки
    * Просмотр чаевых заказа
    * Рефанд чаевых заказа
6. (Бэкенд) Отправление пушей с чеком
7. (Проработка) Чаевые для стран где чеки печатает не траст
    * Нужны доработки в receipt-fetching
    * Нужно изучить юридическую сторону чаевых в этих странах
8. (Проработка) Интеграция новых инвойсов с billing-payment-adapter (для рассчёта с парками)

#### Цели на будующие этапы
Перечисленные здесь цели могут быть запланированы в дальнейшем и требуют дополнительной проработки (RFC)

* Подключение googleplay
    * Требует ещё одного фикса от TRUST (переход с payture на сбер)
* Дефолтные чаевые для applepay/googlepay
* Оплата чаевых другим способом оплаты (например, корп.счёт + applepay)
    * Требуется согласование с проектным офисом
    * Необходимо продумать UX пользователя (в какой момент спрашивать подтверждение оплаты)
* Перенос логики чаевых в сервис tips (перечень мест с чаевыми в коде и порядок переноса в будет в отдельном RFC)
    * Перенос бизнес логики (напрмер, вычисление фиксированных чаевых для заказа)
    * Вынесение чаевых из коллекции orders
* Чаевые в истории заказов



### Схемы взаимодействия сервисов
#### Чаевые после поездки
На схеме видно текущий флоу по которому обновляются чаевые

![](https://jing.yandex-team.ru/files/toporkovm/tips_update.png)

На первом этапе сохраним использование старого флоу. На втором этапе начнём отделять чаевые от поездки и перейдём на новый флоу. Синим отмечены новые элементы системы.
![](https://jing.yandex-team.ru/files/toporkovm/tips_clear.png)

Схема взаимодействия с transactions выглядит вот так:
![](https://jing.yandex-team.ru/files/toporkovm/mvp_service_interaction_stq-5.png)

#### Админка
При вынесении чаевых в отдельный инвойс потребуется добавить ручки для админки:
![](https://jing.yandex-team.ru/files/toporkovm/admin-2.png)

### Почему будем делать так
#### Зачем сначала делать на старом флоу
Потому-что так мы быстрее выпустим фичу в прод:
1. Ожидаемые изменения на бэке - одна строчка
2. Не придётся ждать поддержки нового типа инвойса от биллинга
3. Доработки для админки будут не нужны, так как используем старый флоу

#### Зачем нужен отдельный сервис
1. Чтобы для развития чаевых не писать новый код в монолит
2. Не забиваем order/order_proc этой инфой
3. Создаём один общий сервис куда можно вынести всю логику чаевых
4. Некоторые планируемые сценарии невозможно реализовать as-is (чай другим способом оплаты)

#### Почему сервис в uservices
Работа с чаевыми происходит в куче мест, например, судя по [старому арх-ревью](https://st.yandex-team.ru/TAXIARCHREVIEW-104), в totw - это 3к нагрузки. По мере роста сервиса и переноса туда логики работы с чаевыми нагрузка будет расти.

#### Зачем нужно дорабатывать transactions
Это позволит работать с чаевыми как с отдельным инвойсом (корзиной), и в последствии упростит поддержку.
1. Упрощаем логику заказа, убирая лишние сущности
2. На следующих этапах позволит использовать разные способы оплаты для заказа и чаевых (например, корп.счёт + чаевые с applepay)

#### Зачем ходим в коллекцию orders
Чтобы не спрашивать у пользователя подтверждение для оплаты чаевых: мы можем переиспользовать токен из заказа


### Как отвязаться от цикла заказа
На втором этапе мы начинаем отвязывать чаевые от цикла заказа - делаем оплату чаевых через отдельный инвойс.

Наиболее простым способом видится хук в коде update_transactions - в функции _set_tips_sum. Отсюда можно ставить stq-таску:
```
    IS status=complete AND payment_type IN configs.cool_payment_types [apple]
        stq_client.new_tips_stq_queue(order_id)
        async.return_value()
```

В параметрах stq передаём только order_id. Все остальные параметры мы возьмем напрямую из заказа в момент выполнения таски.
Дальше обработка транзакций чаевых будет происходить аналогично тому как это происходит в заказе.

Создание новой транзакции:
1. Таска ходит за транзакцией чаевых в transactions
2. В transactions нет такой записи
3. Таска ходит за заказом в orders
4. По информации из заказа создаём новую транзакцию (если чаевые не нулевые)
5. Если создать не удалось (Конфликт), то запись уже создала другая таска. На всякий случай перезапускаем

Обновление транзакции:
1. Таска ходит за транзакцией чаевых в transactions
2. В transactions есть такая запись
3. Таска ходит за заказом в orders
4. Таска сверяет new_tips (из заказа) и old_tips (из transactions)
5. Если значения расходятся, вызывается transactions/update, в который передаётся текущая версия транзакции и новые значения
6. Если версии не совпадают, то случилась гонка: в этом случае перезапускаем таску - в новой итерации мы точно обновим до последней версии


Так как обработка транзакций чаевых начинается после окончания заказа, то возможно не более одного обновления заказа - если пользователь больше чем через пол часа вернётся в приложение на страницу фидбека и проставит другие чаевые. 

### Хранение данных
На первом этапе пробуем обойдись без своей базы: данные о чаевых пишем в transactions. Для того чтобы сматчить заказ и транзакцию чаевых генерируем id транзакции чаевых из id заказа:
```
{order_id}_tips
```

### Взаимодействие с transactions
#### Списание чаевых
Для списания денег нужно:
1. Создать новый инвойс
2. Добавить в инвойс сумму на списание
3. Дождаться холда денег для этой суммы
4. Начать клирить инвойс
5. Убедиться что клир прошёл успешно

Transactions работает асинхронно - для шагов 3 и 5 раз в N секунд пуллим /retrieve (см. схему "чаевые после поездки" выше).

Чтобы не держать stq-процесс в ожидании обновлений и разбить код на более мелкие части - после шагов 1, 2 и 4 можно создавать stq-таски.

#### Частота поллинга
Ручку /retrieve следует дёргать не чаще одного раза в 10 секунд - транзакции происходят не очень быстро.

#### Обработка ошибок
Транзакция может провалиться по разным причинам на этапах холдинга и клира. Например, недостаточно денег на карте или не прошла проверка антифрода.

В случае возникновения таких ошибок отменяем снятие чаевых (заменяем значение для списания на 0) - мы [уже так делаем](https://github.yandex-team.ru/taxi/backend/blob/749189a083c39d8649b97f87535a273391add827/taxi/internal/order_kit/invoice_handler.py#L3766) для чаевых через карту.

### Доработки transactions (комманда биллинга)
В сервисе `transactions` учимся обрабатывать чаевые в отдельной корзине (новый инвойс).
Также создаём отдельную mongo-коллекцию для чаевых.

Тажке нужно определиться с тем как задавать для разных корзин траста одинаковый order_tag.


### Переисопользование токена заказа
Чтобы не запрашивать токен повторно можно переиспользовать токен из заказа пользователя. Для этого мы будем брать платёжную информацию из заказа для создания нового инвойса в трасте
```
payments.type = applepay
payments.method = order.payment_tech.main_card_payment_id
payments.billing_id = order.payment_tech.main_card_billing_id        
```

### Доработки ТРАСТа
Для того чтобы банк пропустил несколько транзакций надо при создании корзины чаевых в трасте указать тот же order_tag что и при создании корзины заказа.

На данный момент невозможно проведение нескольких транзакций по одному токену из-за технических ограничений на стороне ТРАСТа - сломанной интеграции с банком. В планах ТРАСТа есть фикс интеграции. После этого фикса станет возможным проведение нескольких транзакций по одному токену.


### Ограничение по странам
В некоторых странах деньги списываются через ТРАСТ, а пробитие чеков происходит через внешние кассы. Для этих стран требуется научить сервис `receipt-fetching` выбивать чеки для чаевых. Также в этом случае возможны юридические вопросы, нужно будет посоветоваться с юристами.

В MVP запустим чаевые в те страны СНГ, в которых ТРАСТ пробивает чеки. Ограничение сделаем через использование клиентского эксперимента.

### Доработки в приложении
Необходимо добавить отображение чаевых для новых типов оплаты (если сейчас не в эксперименте, то добавить эксперимент).

Также надо будет добавить информацию о чаевых на summary applepay при запросе денег (см. рекомендации по чаевым в [доках applepay](https://developer.apple.com/design/human-interface-guidelines/apple-pay/overview/checkout-and-payment/)).

### Интеграция с админкой
В админку добавим отображение чаевых в интерфейсе заказа и возможность рефанда чаевых у заказа. Для этого заиспользуем Админку-Без-Кода (АБК).

#### Чаевые для заказа
При открытии интерфейса заказа админка будет ходить в сервис tips и доставать информацию о чаевых для данного заказа.

#### Рефанд чаевых
Для рефанда чаевых в сервис транзакций отправляется новое значение чаевых - 0. Это сработает даже если деньги уже были списаны (cleared).

### Нагрузка на сервис
Зависит от:
1. Количества заказов такси
2. Процента заказов с чаевыми

Сервис можно масштабировать горизонтально через увеличение количества инстансов

### Метрики
Продуктовые:
1. Количество заказов с чаевыми
2. Средние чаевые
3. Метрики чаевых в tableu (будет следить менеджер)

Технические:
1. Стандартные для ручек (RPS, тайминги, bad RPS)
