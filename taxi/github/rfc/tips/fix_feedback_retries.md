# Что
При раскатке [фидбека за api-proxy](https://st.yandex-team.ru/TAXIBACKEND-29559) обнаружилась проблема: Иногда возникает конфликт при сохранении нового значения чаевых в db.orders, и мы возвращаем ошибку HTTP 409. Клиенты перезапрашивают только HTTP 5xx, поэтому эти запросы не перезапрашиваются и новые значения чаевых не сохраняются

# Где проблема
Проблема возникает из-за ошибок HTTP 409 которые возвращают сервисы passenger-feedback и tips при запросе из ручки [api-proxy/3-0-feedback](https://tariff-editor.taxi.yandex-team.ru/control-api-proxy/endpoints/show/My0wLWZlZWRiYWNr)


## passenger-feedback/passenger-feedback/v2/feedback

| № | Причина | Надо ли перезапрашивать | Текущая ошибка | Будующая ошибка |
|---|---------|-------------------------|----------------|-----------------|
| 1 | Не нашли заказ в order/order_proc | НЕТ | HTTP 409 | HTTP 404 |
| 2 | Дубликат при сохранении в feedbacks | НЕТ | HTTP 409 | HTTP 409 |

Кажется, что №1 должна быть HTTP 404, тк по смыслу у нас не конфликт, а №2 не надо перезапрашивать так как конфликт уникальности ключа не уйдёт при новых запросах

Фиксить фидбек не обязательно, но было бы неплохо исправить "заказ не найден" на http404 для того чтобы по приборам было понятнее что происходит

## tips/internal/tips/v1/update-tips
| № | Причина | Надо ли перезапрашивать | Текущая ошибка | Будующая ошибка |
|---|---------|-------------------------|----------------|-----------------|
| 1 | Не вернулся user_id при обновлении order_proc | НЕТ | HTTP 409 | HTTP 404 (?) |
| 2 | HTTP 409 при обновлении заказа через order-core | ДА | HTTP 409 | HTTP 409 |

Кажется, что №1 никогда не должен стрелять, так-что можно не трогать этот вариант.

Следует исправить второй вариант - при получении HTTP 409 от order-core следует ещё пару раз попробовать обновить чаевые перед возвращением ошибки. Ретраи на уровне api-proxy для ошибок HTTP 4xx невозможны, так что эту логику следует добавить в код сервиса.

# Как фиксить
1. Для tips на уровне сервиса добавляем запросы в случае HTTP 409 при обновлении чаевых через order-core
2. Если после перезапросов в tips опять получили HTTP 409, то возвращаем на клиенты HTTP 5xx чтобы клиенты пере-запросили ручку
3. [optional] Фиксим коды ошибок: в passenger-feedback меняем один из ответов на HTTP 404

Плюсы решения:
1. Без доработок на клиентах
2. Дёшево (быстро) делается

Минусы решения:
1. На приборах будут 5xx ошибки при штатном поведени, можем из-за этого шума не увидеть реальных ошибок
