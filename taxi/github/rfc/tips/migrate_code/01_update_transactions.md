# Что
Выносим бизнес-логику по обработке чаевых из update_transactions в сервис tips

__ПОЯСНЕНИЕ__: выносим только бизнес-логику, взаимодействие с transactions/TRUST не трогаем, в отдельную коллекцию пока не выносим, отдельный тип инвойса пока не пилим

# Зачем
1. Разбираем монолит
2. Собираем всю связанную с чаевыми логику в одном месте

# Как
0. Запрашиваем доступ от сервиса tips к базе заказов
1. Копируем логику по которой обновляются чаевые в новый сервис
2. Впиливаем под конфигом+экспериментом поход в новую ручку сервиса вместо использования логики update_transactions
3. Настраиваем кучу мониторингов и алертов чтобы быть уверенными что всё хорошо

## Что будем выносить
В update_transactions есть два места, связанных с чаевыми:
1. функция `_set_tips_sum`, вызываемая из `_update_transactions_iteration`
2. функция `_need_hold_tips`, вызываемая из `_calc_next_update_eta`

Логику связанную с этими функциями мы перенесём в отдельные ручки сервиса tips

Также есть несколько мест, где чаевые обнуляются по каким-то условиям (переход на чаевые, рефанд, etc) - проставляется `tips=0`. Эти места пока трогать не будем:
* `_save_ride_sum_to_pay.sum_to_pay_upd` (refund)
* `_close_with_cash.sum_to_pay_upd` (cash)
* `_update_order_with_accept.sum_to_pay_upd` (driver not accepted)
* `_mark_order_paid_py_cash.sum_to_pay_upd` (cash)
* `_move_back_to_cash.sum_to_pay_upd` (cash)

__Почему эти места не трогаем?__: Там нет какой-то связанной бизнес-логики - если дошли до этого вызова, то чаевые нужно обнулить (выставить tips=0). Эти места мы будем выносить когда чаевые переедут в БД сервиса и будут обрабатываться отдельным инвойсом

__Что с [копипастой](https://github.yandex-team.ru/taxi/backend-py3/blob/cc61f38cdec323b80b9b8af2c65131dabb4aaaa6/services/archiving/archiving/rules/orders/filters/orders.py#L322) в сервисе архивации?__: Обсудил с ребятами из архивации. Этот код надо будет выпилить после полного переезда чаевых из объекта заказа. Пока-что это не проблема, потому-что сервис архивации не архивирует заказы младше пяти дней. Время жизни заказа в базе не будет меняться пока не будут вынесены чаевые - один из основных блокеров.

## Ручка POST /tips/v1/set-tips-sum
Принимает на вход order_id
Ходит за заказом в базу, ходит за фидбеком к заказу
Повторяет бизнес-логику из update_transactions
Если надо - обновляет заказ в базе
Возвращает HTTP 200 {}

В эту ручку можно ходить только как часть флоу update_transactions

__Идемпотентность?__: При повторном вызове ручки всё будет хорошо, так как переносимая бизнес-логика не накладывает каких-либо ограничений: если чаевые уже обновились (при первом вызове), то во второй раз они просто не будут изменены

__Конкурентность?__: Чтобы что-то теоретически сломалось, нужно чтобы:
1. Пользователь выставил во время поездки чаевые
1. Поездка закончилась
1. Начали одновременно выполняться два `update_transactions`, одновременно пошли в сервис tips
2. В момент между первым и вторым запросом сервиса к базе заказов пользователь проставил в приложении чаевые (после конца поездки)
3. первый запрос завис после получения заказа из базы, и второй запрос обогнал бы его на выполнении
4. после этого не было бы ни одной итерации `update_transactions`

При этом если пользователь после конца поездки ставит чаевые, то будет запущена ещё одна stq-таска update_transactions, которая точно "выправит" чаевые

__Нагрузка?__: Зависит напрямую от количества заказов. Так как в ручку приходят только запросы только при вызове update_transactions после окончания заказа, то нагрузка ощутимо меньше чем на update_transactions. Количество заказов - меньше 100 в секунду (по логам ordercommit), при ожидаемых двух-трех итерациях update_transactions после окончания заказа в среднем выходит RPS в районе 250 при полном переключении

## Ручка GET /tips/v1/need-hold-tips
Принимает на вход order_id
Ходит за заказом в базу, ходит за фидбеком к заказу
Повторяет бизнес-логику из update_transactions
Возвращает HTTP 200 {"need_hold_tips": true|false}

В эту ручку следует ходить только как часть флоу update_transactions (но если вне флоу, то ничего плохого не случится)

__Нагрузка?__: Аналогично с предыдущей ручкой; надо добавить код чтобы ходить только после окончания заказа. Ожидаемая нагрузка до 300 RPS

## Требования к вынесению
Строгих требований к таймингу update_transactions нет, но необходимо аккуратно раскатывать и иметь возможность всё выключить, так как дело касается core-части заказа.

Так как тайминг не супер-критичен, вынести функционал за ручку сервиса (который сходит за заказом в базу) - норм.

## Как будем выносить
Для контроля над вынесением повторим [подход](https://github.yandex-team.ru/toporkovm/backend/commit/7e052d278aeba689cb34584dc91603a96a3e7658#diff-4f8b1432aa13a9578ffd7bdaa494bfeeR111), используемый для вынесения transactions из backend-py2:
1. Создадим конфиг для выключения фичи (выключена по дефолту)
2. Создадим эксперимент для плавного контроля над раскаткой фичи

Если конфиг включён, то ходим за экспериментом. Если эксперимент также включён, то вместо обработки в update_transactions ходим (блокирующе) в новый сервис. Если произошла ошибка (или таймаут) при хождении в эксперименты или в сам сервис, то фолбечим на код в update_transactions.

Чтобы не создавать просто так нагрузку, основные проверки (например, что заказ завершён), оставим в update_transactions перед вызовом сервиса. Описание процесса установки чаевых опишем на вики

Также у сервиса tips нет unstable. Чтобы в unstable не ходить в несуществующий сервис мы не будем включать в этом окружении конфиг.

## Технические мониторинги
Работа ручек:
* RPS
* Тайминги (перцентили)
* Запросы с HTTP-ошибками

База:
* Тайминги хождения в базу (получение, обновление)

## Продуктовые мониторинги
По трафику на сервис можно снимать метрики. Все метрики предлагается разделить по зонам и по тарифам

1. Процент поездок с чаевыми
2. Размер чаевых (средний, перцентили)
3. Процентный размер чаевых (от стоимости поездки; средний, перцентили)
4. Процент выбора кастомных чаевых (против предложенных пользователю значений)
5. Процент использования дефолтных чаевых
6. Процент заказов в которых уменьшают чаевые
7. Процент заказов в которых увеличивают чаевые
8. (?) Процент рефанда чаевых (фрод)
9. (?) Успешная обработка чаевых

__Дублирование мониторингов?__: Часть мониторингов уже есть у аналитиков. Надо обсудить что уже есть, что нам нужно, что лучше продублировать чтобы был реалтайм (у продуктовых мониторингов задержка в день)

### Метрики
Для построение продуктовых мониторингов будем слать метрики в solomon
Ко всем сенсорам добавляем зону, тариф

__Как строить общие графики по сенсорам?__: отсылать одну и ту же метрику с метками зоны+тарифа и без, так как на стороне соломона нет возможности нормально реализовать агрегацию

__Как отсылать метрики?__: Надо  делать агрегированнные метрики (что-то за минуту), и агрегации должны быть в коде

#### Процент поездок с чаевыми
На каждый приходящий в `_set_tips_sum запрос` шлём булевую метрику "выставлены ли чаевые"

__Один и тот же заказ вызывает ручку несколько раз__: Да, и мы однозначно можем посчитать только заказы в которых не было чаевых и их выставили. Возможно стоит оставить эти метрики только в tableu - там уже есть точные метрики по чаевым (хоть и с задержкой в сутки)

#### Размер чаевых
На каждый приходящий в _set_tips_sum запрос шлём метрики "размер чаевых", "процентный размер чаевых"

__Шлём только если она меняется?__: Да, иначе даные будут совсем нерепрезентативные

__При смене чаевых метрика за прошлое значение становится лишней__: Да, и мы кажется ничего не можем с этим сделать. При просмотре графиков надо будет учитывать эту неточность

#### Процент заказов с уменьшением/увеличением чаевых, дефолтные чаевые
Мы можем посчитать эти метрики сравнивая чаевые установленные в заказе (если уже установлены) и новое значение чаевых. Это как минимум поможет нам понять насколько стоит доверять графику размера чаевых, так как чем больше изменений размера - тем больше неточностей в графике размера чаевых

Также тут же можем смотреть использовались ли дефолтные чаевые или были выбраны какие-то другие, сравнить соотношение процентных чаевых и flat-чаевых

#### Процент рефанда чаевых
Эта метрика под вопросом, так как для её реализации надо будет городить отдельно stq, так как процесс рефанда при фроде кажется не задействует update_transactions. Эта метрика позволила бы нам следить за фродом с использованием чаевых и механизма моментальных выплат. Подробнее тут:
https://st.yandex-team.ru/TAXIBACKEND-28806

#### Успешная обработка чаевых
Подразумевается проверка, что после работы сервиса с чаевыми всё хорошо - создали транзакции, списали деньги.

Думаю что такая проверка не окупится: самый простой вариант это сделать - сделать stq-таску которая будет мониторить заказ и слать метрики. При этом в stq-таске придётся придумывать сложную логику проверки "успешности" чаевых.

Имхо - достаточно корректно менять информацию о чаевых (реализовать бизнес-логику), и не следить за теми частями оплаты которые мы никак не трогаем

## Алерты
* На аномалии в технических мониторингах (ошибки, тайминги) настраиваем алерты в телеграм с теганьем ответственных (меня)
* На часть логируемых ошибок (?)

Информацию про настроенные алерты добавим на вики сервиса