## Опросник для ревью комитетом

**Название сервиса**

tips

**Какую продуктовую проблему решает сервис?**

Позволяет оставить чаевые к поездке используя applepay (позже - и другие способы оплаты)
В планах вынесение логики работы с чаевыми и отделение чаевых от цикла заказа

**Почему нельзя решить эту задачу без разработки нового сервиса существующими решениями?**

backend (py2) заморожен, а текущая логика работы с чаевыми связана с циклом заказа такси (update_transactions).
Также сейчас невозможно использовать разные типы оплаты для заказа и чаевых.

**Как именно сервис будет решать поставленные перед ним задачи?**

При оплате поездки через applepay в конце поездки будет возможность оставить чаевые.
При выборе чаевых будет запрошена авторизация через applepay touch_id.
Вся платёжная информация будет передана на бэк, после чего в сервисе transactions будет создана новая транзакция и начата её обработка.

**Разрабатывается один сервис или система?**

Один сервис

**Сколько и какие сервисы входят в систему?**

1. Сервис tips: вся информация о чаевых и бизнес-логика

**С кем взаимодействует сервис?**

protocol/feedback -> tips
проставление чаевых в конце поездки

АБК -> tips
получение информации о чаевых, рефанд чаевых саппортом

tips -> transactions
создание, изменение, получение транзакции чаевых


Идемпотентность внешних операций при обращении к сервису tips достигается использованием версий документа и optimistic locking.

TODO 3. Как поддерживается консистентность данных при частичных отказах?
TODO 4. Как организованы ретраи внешних сервисов?

**Какие базы использует?**

Не использует - данные по транзакциям находятся в сервисе transactionsю


**Какие периодические процессы?**

Никаких

**Прикрепите схему того, где этот сервис находится в текущей инфраструктуре**

Чаевые после поездки
![](https://jing.yandex-team.ru/files/toporkovm/mvp_service_interaction.png)
![](https://jing.yandex-team.ru/files/toporkovm/mvp_service_interaction_stq-1.png)

Админка
![](https://jing.yandex-team.ru/files/toporkovm/admin-1.png)


Как технически проект влияет на цикл заказа:
1. При окончании поездки с applepay пользователю будет предложено оставить чаевые


**Есть ли какой-то стейт в памяти, как он обновляется и валидируется?**

Нет

**Какая нагрузка ожидается?**

Нагрузка на MVP:
ORDERS_PER_SECOND * APPLEPAY_SHARE * TIPS_SHARE ≈ 100 * 0.15 * 0.1 ≈  1.5 RPS

Нагрузка при переносе функционала из монолита:
≈3000 RPS (totw)

**Какие фолбеки предусмотрены на сам этот сервис?**

При краткосрочной недоступности сервиса stq-таски гарантируют то что мы не потеряем транзакции.


**Какие фолбеки предусмотрены внутри этого сервиса на взаимодействие с другими сервисами?**

В случае если transactions недоступен заного планируем выполнение stq-таски через какое-то время.

**Какие возможности масштабируемости закладываются?**

Горизонтальное масштабирование через увеличение количества инстансов сервиса

**Какие точки отказа есть в сервисе?**

сервис transactions

**Укажите ключевые продуктовые метрики сервиса, за которыми планируете следить**

1. Количество заказов с чаевыми
2. Распределение по чаевым
3. Средние чаевые

**Укажите технические метрики**

1. Стандартные для ручек (RPS, тайминги, bad RPS)


**Какая функциональность ожидается в сервисе в будущем?**

0. Перенос логики работы с чаевыми в один сервис
1. Чаевые для других способов оплаты (googlepay, кошелёк)
2. Смена чаевых во время поездки для новых способов оплаты
3. Возможность оплатить чаевые другим способом оплаты (например, поездка по карте и чаевые по applepay)
4. Дефолтные чаевые для новых способов оплаты
5. Чаевые в истории заказов

**Какое изменение нагрузки планируется?**

Ежегодное увеличение RPS в полтора раза (общий рост такси)

**Активно ли будет изменяться сервис?**

ДА
