## Задача
[TAXIPROJECTS-2719](https://st.yandex-team.ru/TAXIPROJECTS-2719)


## Продуктовые требования:
Для пользователей, которые впервые пользуются средством микромобильности (сейчас только самокат, возможно что-то еще в будущем), необходимо показать онбординг — коммуникацию, разъясняющую правила пользования сервисом. Онбординг имеет несколько ограничений:
* Для разных типов транспортных средств онбординг свой
  * Пример: онбординг для самокатов и велосипедов разный
* Для разных городов онбординг может быть свой
  * Пример: в Москве замок обязателен, в Краснодаре нет, нужны разные онбординги. При этом, если пользователь, посмотревший онбординг в Краснодаре, приезжает в Санкт-Петербург (где замков также нет), еще раз смотреть тот же самый онбординг он не должен


## Как работает сейчас:
* Клиент хранит у себя факт прохождения онбординга (один флаг)
* Клиент запрашивает онбординг, если нужно, в ручке ``/4.0/scooters/v1/config``
* Онбординг не зависит от локации
* Онбординг проходится один раз независимо от типа транспортного средства и города


## Варианты реализации:
### 1. Доработать текущий флоу
Логика работы:
* клиент создает оффер походом в ``/offers/create``, оттуда получает тип ТС
* клиент сразу же идет в ручку ``/4.0/scooters/v1/config`` с локацией и типом ТС, получает нужный онбординг [фактически rps(``/4.0/scooters/v1/config``) == rps(``/offers/create``)]
* проверяет, смотрел ли пользователь данный онбординг и показывает его, если нужно

| + | - |
| - | - |
| меньше всего разработки на бэкенде | чтобы построить карточку оффера, нужно сходить в 2 ручки с клиента — тут возрастает время и вероятность ошибки |

### 2. Унести логику онбординга в ручку ``v1/products``
Логика работы:
* Клиент идет в ``/4.0/mlutp/v1/products/screen/scooters-discovery``, город уже знает
* получает в ответе ручки маппинг (город & тип ТС) -> тип онбординга
* хранит информацию о прохождении онбордингов разных типов у себя
* клиент идет в ``/offers/create``, получает оффер и тип ТС
* выбирает нужный онбординг, и показывает его, если нужно

| + | - |
| - | - |
| мало разработки на бэкенде | онбординг не покажется при скане QR-кода |
|  | субъективно: неочевидное место хранения онбордингов, может породить дополнительные корнер-кейсы |

### 3. Унести логику онбординга в ручку ``offers/create`` (api-proxy)
Логика работы:
* Клиент идет в ``/offers/create``
* ``/offers/create`` создает оффер, по офферу понимает тип ТС
* (опционально) можно определить город не только по локации, но и по офферу
* ``/offers/create`` c типом ТС и городом/локацией идет за онбордингом в ``/4.0/scooters/v1/config``

Тут можно упростить последний этап, перенеся логику из ``/4.0/scooters/v1/config`` в ``/offers/create``, но тогда это решение нельзя будет обобщить на Таларию [как обобщить: у Таларии будет свой "``offers/create``", который будет тоже ходить в ``/4.0/scooters/v1/config`` за онбордингом]

| + | - |
| - | - |
| достаточно простая логика на клиенте | ``/offers/create`` скорее всего незначительно замедлится (не так сильно, как в 1 варианте) |
| обработка ошибок с клиента (например, ручки ``/4.0/scooters/v1/config``) перемещается в api-proxy | |

### 4. Доработка в слоях и на клиентах
Логика работы:
* сервис ``layers`` знает локацию и тип ТС, ручки ``v2/objects`` и ``v1/cluster`` в объекте самоката/парковки возвращает дополнительное поле, по которому клиент может понять тип онбординга. [к action'у [PickScooter](https://a.yandex-team.ru/arc/trunk/arcadia/taxi/uservices/services/layers/docs/yaml/definitions.yaml?rev=r8798727#L1127) добавится поле ``onboarding_type``]
  * в ``pick_scooter``-action'е одиночного самоката будет ``onboarding_type`` (в ``v2/objects``)
  * в ``car_details[i]`` элементе будет лежать поле ``onboarding_type`` (в ``v1/cluster``)
  * в ``pick_scooter_parking``-action'е парковки не будет данного поля, т к онбординг маппится на самокат, а не на парковку
* клиент еще до запроса к ``offers/create`` понимает, нужно ли будет показывать онбординг по данному ТС
* дальше работает текущий флоу с единственным изменением: в ``/4.0/scooters/v1/config`` отправляется локация и тип онбординга

#### Запрос к ``/4.0/scooters/v1/config``
```(json)
{
    "typed_experiments": {
        "items": <items>
    },
    "onboarding_type": <onboarding_type_from_layers>,
    "position": [<lon>, <lat>]
}
```

| + | - |
| - | - |
| несложные изменения на клиентах | |
| создание оффера совсем не замедляется | |
| легко расширяется на все объекты, которые возвращают слои (в т ч на Таларию) | |

### Открытые вопросы:
* Где хранить факт прохождения конкретного онбординга?
  * На клиенте: хранится не бинарный флаг прохождения онбординга, а список из пройденных
  * На бэкенде: хранится в табличке в БД с фактом прохождения пользователем онбординга, забирается сетевым походом
  
  Предлагаю оставить хранение на клиенте, т к:
  * сейчас у такого решения нет очевидных недоставков
  * хранение на бэкенде влечет к дополнительному походу по сети и точке отказа
