## scooters-ops(-*)? межсервисное взаимодействие

### 1. Терминология

**Драфты (drafts)** - это предварительные сервисные задачи (зарядить самокат, переместить самокат из точки A в точку B).
**Работа (job)** - конкретная работа, которую должен проделать курьер в конкретной точке (сфотографировать самокат, заменить батарею в самокате, сдать аккумуляторы в шкаф). Похожа на draft. Но один draft может разложиться в несколько работ в разных точкам (draft перезарядить аккумулятор предполагает несколько работ - получить аккумулятор, заменить аккумулятор в самокате, сдать аккумулятор).
**Точка (point)** - точка на карте, где курьер может произвести какое-то количество работ (job).
**Миссия** - совокупность точек с работами, расположенными в некотором порядке.


### 2. scooters-ops-dispatch <-> scooter-backend

Диспатчу нужны данные о всех самокатах. Возможно, самокат еще не нужно перезаряжать, но будет эффективнее перезарядить его сейчас.

Эти данные диспатч получает из сервиса scooter-backend (монолит Драйва).
Данные можно получать через либу-кеш scooters-positions.

Вообще данные из монолита приходят примерно в таком формате - https://paste.yandex-team.ru/6155604. Если чего-то нет в scooters-positions, то можно добавить.

Взаимодействие тут однонаправленное. **Модифицирующих операций нет**


### 3. scooters-ops-dispatch <-> scooters-ops


#### 3.1 Получение драфтов

Информацию о задачах, которые нужно произвести над самокатом, диспатч получает из сервиса scooters-ops в виде драфтов (drafts). В каждом драфте есть vehicle_id, по которому можно матчить самокаты, получаемые из scooter-backend.

Драфт выглядит примерно так

```
{
    "draft_id": <str>,
    "type": "<str>",
    "created_at": "<timestamp>",
    "typed_extra": <dict>
}
```

Для начала решили, что диспатч будет на каждую свою итерацию (не чаще одного раза в секунду) запрашивать все актуальные драфты.
Это по крайней мере сейчас решит много вопросов синхронизации данных между сервисами.
В дальнейшем стоит подумать об инкрементальном обновлении кеша (когда количество драфтов разрастется).


#### 3.2 Создание миссии

Задача диспатча - превратить какое-то количество драфтов в миссию. То есть после некоторой работы диспатч должен создать миссию через scooters-ops и передать туда список драфтов, на основе которых сделана миссия.


Пример запроса на создание миссии (api работ может поменяться). Здесь уже довольно низкоуровневые данные. То есть прямо по шагам нужно описать, что будет делать курьер.

```
POST /scooters-ops/v1/missions/create?mission_id=<uuid|idempotency-token>

{
    "related_drafts": [
        ...
    ],
    "performer_id": <db_uuid>,
    "points": [
        {
            "id": "<uuid>",
            "type": "depot",
            "jobs": [
                {
                    "id": "<uuid>",
                    "type": "pickup_batteries",
                    "payload": {
                        "pickup_count": 3
                    }
                }
            ]
        },
        {
            "id": "<uuid>",
            "type": "scooter",
            "payload": {
                "scooter_id": "<uuid>"
            },
            "jobs": [
                {
                    "id": "<uuid>",
                    "type": "exchange_battery"
                }
            ]
        },
        {...},
        {...},
        {
            "id": "<uuid>",
            "type": "depot",
            "jobs": [
                {
                    "id": "<uuid>",
                    "type": "return_batteries",
                    "payload": {
                        "return_count": 3
                    }
                }
            ]
        },
    ]
}
```

Содание миссии не означает, что она точно будет выполнена. Обработка созданной миссии происходит асинхронно относительно создания миссии через ручку. То есть миссия может провалиться еще не начавшись. В этом случае миссия зафейлится, а связанные с ней драфты снова станут доступны.


#### 3.3 Балковое изменение миссий во время исполнения

Диспатч может в произвольные моменты времени захотеть поменять одну или несколько миссий.
Причем может быть такое изменение, которое перебрасывает точки с работами из одной миссию в другую.

Делаем одну ручку, в которую передаем изменяемые миссии в их новом виде.
Операция асинхронная. При вызове ручки `/scooters-ops/v1/missions/update/bulk/request` возвращается id операции.
Результат операции можно узнать из ручки `/scooters-ops/v1/missions/update/bulk/request`

```
POST /scooters-ops/v1/missions/update-bulk/request

{
    "requests": [
        {
            "mission": {...},
            "related_drafts": ["<uuid>", ...]
        }
    ]
}
```

В поле `related_drafts` для каждой миссии нужно указать те драфты, которые ранее
не были привязаны ни к одной миссии, но теперь используются.

```
GET /scooters-ops/v1/missions/update-bulk/result?update_id=<uuid>

{
    "result": "ok|error",
    "error": {  // optional - absent if result == ok
        "code": "machine_readable_code",
        "message": "some comments about error"
    }
}
```

Сервис scooters-ops сам вычислит нужные операции для приведения миссий в требуемое состояние и применит их.

В идеальном мире либо все миссии изменятся как надо, либо состояние не поменяется.
Для тех случаев, когда мы можем без похода в карго сказать, что в целевое состояние нельзя перейти это будет выполняться.
Для тех же случаев, когда мы будем взаимодействовать с карго, такого сказать нельзя.
Плюс курьеры в этот момент будут работать и может произойти гонка состояния точек.

Тут можно поработать над откатом изменений, но на первом этапе делать это слишком сложно.


**Отменить миссию**

```
POST /scooters-ops/v1/missions/cancel?mission_id=<uuid>&mission_revision=<int>
```

> Отменить миссию можно, если у курьера нет на руках какого-то
> ресурса - батарейки, воскресители, самокаты
