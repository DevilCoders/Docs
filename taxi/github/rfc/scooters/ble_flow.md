## Проблема
Достаточно часто у самокатов нет подключения к нашей телематике, по вине оператора, или любой другой причине. В такие моменты:
* пользователь не может завершить парковку, и ему приходится звонить в поддержку.
* пользователь не может начать поездку - мы не зарабатываем, и теряем пользователей, т.к. это выглядит как плохо работающий сервис.

Хотим использовать bluetooth-протокол для блокировки/разблокировки самокатов через клиентское приложение.

## Задача

[TAXIPROJECTS-2597](https://st.yandex-team.ru/TAXIPROJECTS-2597)

* В клиентских приложениях: Реализовать ble-протокол взаимодействия с самокатом.
* В бекэнде: реализовать флоу начала/завершения поездки и передачи секретов для коннекта клиентского приложения для ситуаций, когда конекта с самокатом нет.

В bluetooth-флоу не будут работать следующие фичи:
* Обновление локации самокатов
* Проверка завершения на парковке
* Замедление в медленных зонах
* Кнопка "Где самокат"
* Обновление заряда в приложении

В следующих итерациях:
* Автоматизировать включение bluetooth-флоу при отсутсвии коннекта к самокату, если оно хорошо себя покажет при ручном включени
* Поддержать открытие крышки через BLE в таксометре для энерджайзерах.
* Другие сервисы кикшеринга используют bluetooth, чтобы проверить, что пользователь действительно находится

## Решение

### В общих чертах

1. При каждом коннекте самоката на бекэнде генерируем новый bluetooth пароль с доступами только на операции блокировки/разблокировки.
2. При походе клиента в `/tag/evolve`, если коннекта с самокатом по интернету нет:
    1. Проверяем включен ли эксперимент для ble-флоу.
    2. Вместо ошибки отдаем клиенту mac-адрес и пароль.
3. Клиент коннектится по mac-адресу к самокату (для ios-коннекта дополнительно нужен IMEI и name). Если не получилось, пишем ошибку.
4. Клиент получает communication key через ble-команду `Verifying Device KEY & Getting Communication KEY (0x01)`, используя полученный от бекэнда пароль.
5. Клиент, используя полученный communication key, отправляет ble-команду: `Unlocking Command (0x05) + Cable Lock Command (0x81)/Locking Command (0x15)` в зависимости от кейса: начало/завершение поездки.
6. В случае успешного результата клиент идет в `/tag/evolve` с флагом использования ble-флоу (`ble_flow_is_used: true` в body).
7. Бекэнд переводит флоу поездки в нужный статус.

Документация по BLE-протоколу: https://nda.ya.ru/t/6xtdD54h4HedBP

### Логика на бекэнде

Вариант 1. Мета-программирование через api-proxy:
1. Добавляем в секцию `telematics` в беке драйва возможность получить mac-адрес и ble-пароль и берем их из ручки `/sessions/current`. Включаем через gvar `telematics.ble_info.decode=true`.
2. Чтобы не отдавать клиенту пароль когда не надо, в обычные вызовы ручки `/sessions/current` добавляем оверрайдим gvar `telematics.ble_info.hide=true`.
3. Пишем конфиг api-проскси, который, если эксперимент на ble-flow включен:
    * При ошибке connection_not_found от телематики на `/tag/evolve` ходит в `/sessions/current` и возвращает клиенту mac-адрес и пароль.
    * При наличии в body `ble_flow_is_used: true` ходит в `/tag/evolve` с флагом `ignore_telematic`.
### Взаимодействие с клиентом

Ответ на `/tag/evolve`, если коннекта с самокатом нет и эксперимент включен:
```yaml
schema:
    type: object
    additionalProperties: false
    required:
      - mac
      - password
      - imei
      - name
    properties:
        mac:
            type: string
        password:
            type: string
        imei:
            type: string
        name:
            type: string
            default: ZK600
```

Пример:
```json
{
  "bluetooth": {
     "mac": "78:05:41:0C:7C:56",
     "password": "2df52527",
     "imei": "862869030775758",
     "name": "ZK600"
  }
}
```

После успешного выполнения команды по блютузу клиент идет в `/tag/evolve` с параметром в body:
```
ble_flow_is_used: true
```

### Безопасность

Ограничение на bluetooth-пароль:
* 8 байт.
* Генерация рандомно при каждом коннекте самоката к бекэнду.
* Пароль позволяет выполнять только данные операции с самокатом: `Verifying Device KEY & Getting Communication KEY (0x01), Unlocking Command (0x05), Locking Command (0x15), Cable Lock Command (0x81)`.
* Отдаем пароль на клиент только, когда у самоката нет коннекта к интенету.

Полная документация по BLE-протоколу (ч.2, стр. 27) https://nda.ya.ru/t/6xtdD54h4HedBP

Реализацию протокола -- проприетарный код, к которому мы не имеем доступа. Но можем просить китайцев добавлять обрантно совместимые фичи.
В протоколе есть шифрование (описание в документации выше).
