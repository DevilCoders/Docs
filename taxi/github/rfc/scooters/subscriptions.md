# Подписка на самокаты

## Вектора Атаки
### 1. CRUD подписок (может есть какой-то готовый сервис)
<details><summary>Не выстрелившие подходы (для истории)</summary>
<p>
- Что-то из Плюса (узнал у @rgnlax о возможностях)
  - !!не сможем продавать подписку без Плюса!! Можно использовать новую версию подписки Плюс, со специальной опцией "самокаты".
  Это можно настроить в медисервисах и сразу не нужно будет думать про создание, списание, настройки и т.д.

  - Медиасервисы со специальным [тарификатором](https://wiki.yandex-team.ru/tarifikator/) (узнать у @melnikov-s)
  У них есть всё что нужно, и возможно получится собрать кастомную "не плюсовую подписку".
  Если так, то команда @rgnlax может помочь с бэкендом (т.к. они целятся в универсальное решение).
    - -- в текущей реализации - они только с Плюс-ом продают, а нам его стоимость будет значительной частью от стоимости всей подписки
      - тут решили дождаться Дениса из отпуска, чтоб начать процесс согласования цен
    - -- пока нет реализации периодом меньших, чем месяц (а нам нужны недели и дни)

- Что-то из Биллинга (узнал у @usyrname о возможностях)
  - -- [LEGACY](https://st.yandex-team.ru/GMSP-1038#61ade026c654ba0066660443)! [Траст](https://wiki.yandex-team.ru/trust/payments/api/subscriptions/)
    - ++ подписки с произвольным интервалом
    - ++ автоматическое списание с привязанных карт и ручное с выдачей URL-а для Web-а
    - ++ можно менять цену подписок по регионам и/или на лету
    - ++ есть [триалы и скидки на старт подписки](https://wiki.yandex-team.ru/trust/payments/api/subscriptions/#podpiskisoctart/introperiodom)
      - -- но это только в рамках одного продукта (а нам, скорее всего, придётся заводить несколько: с/без плюса * день/неделя/месяц)
    - ++ [нотификации](https://wiki.yandex-team.ru/trust/payments/api/subscriptions/#notifikacii) могут заменить stq-based pooling подход на trust-based pushing. Только вот pooling выглядит надёжнее в плане возможности перезапуска/тюнинга с нашей стороны.
    - -- нельзя менять период у существующих подписок (нам такое вроде норм)
  - Больше тут вариантов нет.
  Как сказал @abekbulatov, логики расписаний у них нет. Поэтому оно будет больше на "Какой-то свой велосипед" походить.
</p></details>

- Какой-то свой велосипед
  - оплата:
    - Траст: продукты/корзины/списания
      - ++ работает в тестинге, нормальная документация
      - -- поддержка в канале не отвечает, только через тикеты => всё долго
    - transactions-сервис
      - ++ поддержка активно отвечает
      - -- **TBD:** пока не получается заставить его работать на тестинге
    - тегами драйва
      - ++ выглядит изи => для MVP - самое то
      - ++ переиспользуем существующий UI для аудита (например операций командами поддержки)
      - -- отдельно от Таларии (Q: ну да и норм, у Таларии же своё уже рабочее есть и смысл сейчас ломать?)
  - продление - тут, наверное, можно что-то на STQ наколхозить
    - если сервис списания недоступен - не отменяем подписку, а даём пользоваться неоплаченной
    - Делаем только для оплаты картой
    - Apple/Google Pay - пока не делаем, т.к. привязки могут протухнут за месяц-то
  - хранилище:
    - велосипед на PG :scream_cat:
      - хотя, схема нам не нужна => можно и на нереляционной БД сделать
      - объём данных/изменений (см. arch-review.md)
        - 800МБ (на 2022 год)
        - изменений:
          - << 48 rows/sec
          - << 13 KB/sec
      - кеширование = не нужно для 20-30rps
        - ++ частота чтения >> обновления
        - -- по 1 записи на пользователя
    <details><summary>Не подошёл, т.к. не получится унифицировать с Таларией (и прочими будущими самокатными бэками)</summary>
    - !Талария! хранить данные прямо в тегах Драйва (там можно даже типизированую схему организовать)
    <p>
      - ++ уже есть аудит, какой-никакой но интерфейс для поддержки
      - завести свой тип тега для подписок и хранить id-подписки в значении тега
        или использовать какой-то существующий (можно спросить Сергея из Драйва)
        - **TBD:** цеплять actions на теги с определённым значением
      - костыль для получения тегов пачками для продления
        - вешаем 2 тега на пользователя:
          - subscription--<sub_id> (с дедлайном)
          - subscription-autoprolongate (без дедлайна)
        - ищем пользователей по тегам с фильтрами:
          - Один из: subscription-autoprolongate
          - Отсутствие тега: subscription--<sub_id>
    </p></details>

### 2. Управление ценообразованием (бесплатный анлок)
- Вешаем тег на пользователей.
- Создаем disable_action на отключение экшена [Стоимость посадки](https://scooters.yandex-team.ru/#/settings/actions/base_acceptance_price) (который и добавляет эту стоимость).

### 3. Клиентское протокол/взаимодействие
- Про новые шторы вынес в PR #1022.
- Существующая карточка самоката:
  - Добавить строку "Бесплатная посадка" / "Активная подписка"
    - карточка выдаётся из Двайвовой ручки `POST /4.0/scooters/api/yandex/offers/create?car_number=`, а нам бы удобнее uservices-ная
    - **TBD:** договориться с Клиентами про новую/существующую ручку для возврата статуса подписки


# Проработка своего Велосипеда
## Создание/правка/удаление вариантов подписок
Идея в том, чтобы сделать тарифы/варианты максимально динамичными (например через эксперименты/конфиги),
чтоб можно было предлагать разные цены/опции для разных регионов и/или АБ-тестов.
Но при этом сохранять параметры выбранной/оплаченной подписки в списке активных подписок, чтоб потом (например при автопродлении) можно было понять, доступен ли ещё такой тариф, или уже нет.
Пример конфига:
```json
// 1й клоз: Синедар
{
  "evening_online": {
    "title": "У Ларька",
    "description": "Идеальный вариант чтобы весь вечер гонять до ларька за добавкой",
    "period": "4h",
    "price": { "value": "100", "currency": "RUB" },
    "kind": "free_unlock"  // по сути, это будет замэпплено в имя тега в Драйве
  }
}

// default
{
  "daily": {
    "title": "Дэйли",
    "description": "Идеальный вариант чтобы погонять на выходных, посмотреть город. Можно отменить в любой момент.",
    "period": "1d",
    "price": { "value": "190", "currency": "RUB" },
    "kind": "free_unlock"
  }
}
```

## Подписка/продление/отмена
### При подписке
1. сохраняем тариф/продукт в базу:
```json
{
  "id": "daily",
  "period": "1d",
  "price": { "value": "190", "currency": "RUB" },
  "kind": "free_unlock"
}
```
2. инициируем оплату
3. при успешной оплате (если что-то не получилось - пробуем ещё раз через какое-то время):
    - ставим тег в Драйве
    - обновляем запись подписки

### Для продления
заводим STQ на конец периода текущей подписки.
А в нём уже ищем подписку по `id`, и проверяем, что цена не изменилась.
Если цена изменилась - уведомляем пользователя, а если увеличилась - то не продлеваем автоматом.
Таким образом можно легко добавлять новые тарифы и отключать старые.

### При отмене
**TBD:** нужна продуктовая проработка в т.ч. по возврату денег
Технически можно завершить текущую подписку, удалив тег в Драйве и обновив запись.

### Повторная покупка (или покупка нескольких подписок)
Выглядит полезным, например для смены недельной подписки на помесячную.
Технически, можно создать +1 запись в базе с новыми параметрами и поставить ей дату автопродления на конец текущей подписки.
**TBD:** но нужна продуктовая проработка, а пока что запретим покупать несколько (уникальным индексом по kind и yandex_uid).

![sequence diagram](./subscriptions/subscription.png)

<details><summary>Не выстрелившие подходы (для истории)</summary>
<p>
## Проработка варианта с Трастом

### !! Внезапно [выяснилось](https://st.yandex-team.ru/GMSP-1038#61ade026c654ba0066660443), что подписки в Траст - это LEGACY !!

### Создание/правка/удаление вариантов подписок
Нужен какой-то UI, не ходить же curl-ом в ручки.
1. Настраивать варианты подписки в Админке Драйва через создание тегов/экшнов.
2. Задавать желаемые варианты подписок конфигом (без кваргов которые) и **?периодически?** синкать каким-то нашим сервисом в Траст.
  - ?Q: как выводить ошибка? Через логи - не очень удобно

### Подписка/остановка/продление

#### Подход на [нотификациях](https://wiki.yandex-team.ru/trust/payments/api/subscriptions/#notifikacii) (проще, но мы нас пушит Траста)
|Клиент| |наш сервис| |Траст| |Драйв|
|-|-|-|-|-|-|-|
||>|генерация ID-подписки из UID|||||
||||< проверка по уникальному ID и создание/удаление подписки >||||
||<|?Q: выдача клиенту URL-а для оплаты|||||
|||&nbsp;|||||
||||< нотификация создания/продления/**?удаления?** подписки||||
||||создание/удаление тега пользователя (с deadline) --|---|>||

#### Подход на STQ
|Клиент| |наш сервис| |Траст| |Драйв|
|-|-|-|-|-|-|-|
||>|генерация ID-подписки из UID|||||
||||< проверка по уникальному ID и создание подписки >||||
||<|?Q: выдача клиенту URL-а для оплаты|||||
|||запуск STQ для проверки статуса оплаты|||||
||||< проверка оплаты >||||
||||создание тега на пользователя (с deadline) --|---|>||
|||запланирование STQ на конец периода для проверки продления|||||
</p></details>
