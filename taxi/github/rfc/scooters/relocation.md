### Проблема

Арендуя самокаты люди развозят их по городу так, что создают дефицит предложения в местах повышенного спроса.
А в местах, где спрос почти нулевой скапливается много простаивающих самокатов.
Это роняет утилизацию и уменьшает количество денег, которые мы зарабатываем с города.

В сезоне 2021 были попытки решать эту проблему руками. Это очень трудоемко, субъективно и не масштабируется.

### Бизнес задача

Перемещать самокаты в рамках города таким образом, чтобы уравнивать спрос и предложение.
Начнем с перемещения один раз в сутки. Дальше через эксперименты придем к нужной периодичности.


### Метрики успеха

1. Выравненный баланс
2. Больше поездок
3. Больше денег
4. Больше денег с учетом костов релокации


### Ограничения

Полная задача релокации - это найти дисбаланс в спросе и предложении, определить какие самокаты на какие парковки нужно переместить и построить оптимальные маршруты перемещения с учетом доступности водителей и грузовых машин.

Здесь есть 2 логические части - найти дисбаланс спроса и предложения и построить оптимальные маршруты на местности.
Понятно, что для большей оптимальности эти 2 задачи нужно решать совместно.
Мы же пока решили решать эти задачи раздельно в двух отдельных сервисах разными командами.

Сервис scooters-ops-relocation будет отвечать за рассчет дисбаланса спроса и предложения.
Сервис scooters-ops-dispatch за построение оптимальных маршрутов.

В дальнейшем, когда появятся данные будем думать, где нужно воссоединиться. И нужно ли.


### Алгоритм

1. Каждый город поделен на полигоны.

2. Для каждого полигона считаем статистики за период [T, T+N]:

- сколько самокатов было на момент T (default)
- сколько самокатов закончили аренду в полигоне за период (in)
- сколько самокатов начали аренду в полигоне за период (out)
- сколько самокатов были релоцированы из полигона за период (relocated_out)
- сколько самокатов были релоцированы в полигон за период (relocated_in)
- сколько самокатов находятся в полигоне, но недоступны для аренды по разным причинам (out_of_lease)

3. Считаем для каждого полигона баланс по формуле

```
balance = ( out + relocated_out ) / ( default + in + relocated_in )
```

Формула хороша тем:

— что величины можно взять за всю историю, если начальная эвристика за день не подойдет, то есть всегда возвращать город в начальное состояние
— в будущем можно предсказывать MLем, а не смотреть в прошлое
— всегда меньше единицы

1. Считаем баланс в регионе (Москва, Краснодар, etc) за период

```
demand = sum(p.out + p.relocated_out for p in region_polygons)
supply = sum(p.in + p.default + p.relocated_in for p in region_polygons)

region_balance = demand / supply
```

5. Считаем, сколько каждый полигон может отдать/принять чтобы приблизиться к среднему балансу

Учитываем:

- если значение баланса очень близко от среднего значения, то полигон не трогаем
- минимальное количество самокатов в полигоне (здесь принимаем во внимание метрику eta пользователя до ближайшего самоката)
- вместимость парковок

6. Выбираем самокаты, которые нужно релоцировать
7. Выбираем парковки, в которые нужно релоцировать самокаты. Выбираем рандомно внутри полигона с учетом capacity

**На выходе получаем**

1. Список самокатов для релокации
2. Список парковок с указанием количества самокатов, которые нужно туда переместить


### Детали реализации

**Полигоны**

Список полигонов для каждого города можно хранить в конфиге как это делается в [SCOOTERS_ZONES](https://tariff-editor.taxi.yandex-team.ru/dev/configs/edit/SCOOTERS_ZONES?group=scooters). Полигоны для каждого региона сгенерируем скриптом один раз.


**Статистики**

Для каждого полигона нужно считать статистики за период.
В период экспериментирования период рассчета будет меняться. Ориентируемся на день, но может меняться.

Считать статистики можно по потоку событий. Будем в базе хранить поток интересующих нас событий за какой-то ограниченный период. Формут примерно такой

```
CREATE TABLE events (
    event_id TEXT PRIMARY KEY,  // для идемпотентности
    polygon_id TEXT NOT NULL,   // можно вычислять как hash(точки полигона) или брать из конфига
    event_type TEXT NOT NULL,   // income, outcome, relocated_in, relocated_out
    dt TIMESTAMPTZ NOT NULL
)
```

Количество событий в сутки =
    <количество аренд в сутки> + <количество самокатов>.

Количество аренд в сутки = 8500 (максимум 2021) * 20000 (колво самокатов в 2022) / 3500 (колво самокатов в 2021) ~ 50К

То есть количество событий, которые влияют на баланс в сутки = 70К

Будем делать примено такой запрос

```
select count(*) from events
where dt between A and B
group by (polygon_id, event_type)
```

Хранить за неделю тоже ок. За месяц менее ок.

Как вариант можно отгружать эти данные на YT и для больших периодов делать YQL запрос. Так как у нас нет требований realtime, то можем позволить себе делать эти запросы долго. Главное тут подумать о работе в 2 ДЦ сразу.


Сами события будем принимать просто в ручку и сразу писать в БД. Рейт событий не должен быть выше 1 rps (50К / 86400).


Для каждого самоката хочется еще считать время простоя. Эту метрику можно использовать как запасную.
Опеределять её можно как "время от последнего завершения поездки на данном самокате". Если по этому самокату нет событий, значит событие было слишком давно и можем отдавать признак "стоит слишком долго".


### Рассчет формулы

Для экспериментирования с формулой будем использовать js-pipeline.
На вход алгоритму будем подавать:

- словарь полигонов, где ключ - это hash полигона, а значение - это метаданные и статистики
- список самокатов с метаданными
- список парковок с метаданными

На выход алгоритма ожидаем:

- список самокатов
- список парковок


### Поставка данных

Данные о завершенных поездках с точками A и B можно поставлять из scooters-misc. Там уже есть distlock, которые поставляет эти данные в биллинг

Алтернатива тут - это поставлять данные о завершенных поездках в procaas и уже там отправлять события в scooters-ops-relocation чтобы обновлять статистики.


Данные о релокации будем брать из procaas. Там будет событие о завершении миссии. По этой миссии можно понять, что она была о релокации и какие именно самокаты были релоцированы. Брать эти данные из самого сервиса scooters-ops-reposition нельзя так как после него еще есть dispatch и реальный мир, в котором самоката вообще может не быть на месте.
