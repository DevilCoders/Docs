## Задача
https://st.yandex-team.ru/SCOOTERDEV-802
Нужно научиться мониторить исполнителей и отсылать уведомления тогда, когда исполнители долго находятся где-либо, или скипают скутеры.

## Проблема
В данный момент ни что не мешает исполнителю миссии взять заказ, и выполнять его весь день.
Хотим мониторить следующие события:
1. Курьер долго находится на точке
2. Курьер долго идёт до точки
3. Курьер пропустил точку(задачу) в приложении

Все таймауты хочется уметь задавать через конфиг.

----
## Алгоритм

### 1. Оповещения о пропуске джобы
Если курьер в Про нажимает кнопку, что он хочет пропустить, то в этот момент карго дёргает нашу ручку. В этой ручке мы проставим джобе статус ```skipped``` и  добавлим запись в таблицу ```monitoring_notifications``` c типом ```job_skipped```.

### 2. Оповещение о таймауте
Есть таблица ```scooters_ops.missions_history```, в которую логируются разные события по ходу миссии: начало миссии, прибытие на точку, окончание работ на точке и т.д.

Типичная миссия в этой таблице выглядит так:
1. начало миссии (```mission_started```)
2. Прибытие на точку (```point_arrived```)
3. Окончание работ на точке (```point_complted```)
4. повторение пунктов 2-3
5. Окончание миссии (```mission_completed```)

Для мониторинга, предлагаю завести таска мониторинга ```MonitoringWorker``` типа ```PgLockedPeriodicWithConfig```.

Данная таска будет делать следующие действия:
1. Достает все активные на текущий момент миссиям.
2. Достаем для них события из таблицы ```missions_history```.
3. Для каждой миссии по событиям считаем интервалы (время на точке, время от точки до точки), и если время будет больше чем ```eta * x```, то добавляем запись в таблицу ```monitoring_notifications``` c типом ```timeout_in_point``` / ```timeout_between_points```
3. Для каждой мисии по событиям считаем время с начала послденего действия(движение к следующей точке, прибытие в точку и начало работ). Если время с начала действия больше чем ```eta * x```, то добавляем запись в таблицу ```monitoring_notifications``` c типом ```timeout_in_point``` / ```timeout_between_points```

Откуда возьмем eta:
* eta точка-точка: нам будут передавать при создании миссии.
* eta на точке: в конфиге зададим eta для каждого типа джоб, просуммируем все джобы на точке.

### 3. Таска нотификации
Для осуществления нотификаций в разные каналы связи заведем таску ```NotifierWorker``` типа ```PgLockedPeriodicWithConfig```.

Данная таска будет делать следующие действия:
1. Доставать из таблицы ```monitoring_notifications``` все записи, не помеченные как ```completed```.
2. В зависимости от типа записи в соответсвии с __конфигом3.0__ будет отправлять оповещения и помечать строку как ```completed```.

---
## Каналы отправки сообщений:
#### телеграм
 * будем отсылать так же, как в scooters_misc - отправлять сообщения через ScooterAccumulatorBot.
 * Одно событие - одно сообщение.
#### трекер
 * есть клиент под названием ```startrek```. Пилился в этом [ПР](https://a.yandex-team.ru/review/2329512)
 * На каждую пропущенную точку самоката, будем создавать тикет в стартреке.
 * Настройку очереди нужно занести в конфиг.


## Описание таблиц
----
```sql
CREATE TYPE scooters_ops.monitoring_notification_type AS ENUM(
  'timeout_in_point',
  'timeout_between_points',
  'job_skipped'
);

CREATE TABLE IF NOT EXISTS monitoring_notifications (
    idempotency_token  TEXT NOT NULL UNIQUE,

    mission_id   TEXT,
    point_id     TEXT,
    job_id       TEXT,
    type         scooters_ops.monitoring_notification_type,

    completed    BOOLEAN DEFAULT False,
    recipients   NOT NULL DEFAULT '[]'
);
```

* ```idempotency_token``` - это будет токен идемпотентности. будет выглядеть как ```{mission_id}_{point_id}_{job_id}_{type}```. Позволит не записать в эту таблицу два раза подряд по одному и тому же событию
* ```completed``` - флажок, показывающий, что все оповещения, которые должны были быть отправлены по конифгу, отправлены, и больше не надо обрабатывать эту запись.
* ```recipients``` - здесь будем хранить информацию о том, куда уже отправили оповещение.
Это поможет не отправлять сообщения второй раз в телеграм, если стартрек будет пятисостить, и наоборот.

Пример:
```json
"recipients": [
  {"type": "telegram", "chat_id": ..., "sended": False},
  {"type": "st", "queue": "DUTY", "sended": True}
]
```



## Необходимые задачи
---
1. https://st.yandex-team.ru/SCOOTERDEV-853 Эта ручка бы проставляла статус skipped у джобы, и добавляла бы в таблицу ```monitoring_notifications``` запись с типом ```battery_exchange_skipped```
2. https://st.yandex-team.ru/SCOOTERDEV-851
