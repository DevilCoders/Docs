## Диспатч самокатов

### Какие задачи решает сервис

Здесь и далее опираюсь на https://github.yandex-team.ru/taxi/rfc/blob/master/scooters/ops-missions.md  
Архревью сервиса будет **scooters-ops-dispatch** проходиться тут: https://st.yandex-team.ru/TAXIARCHREVIEW-970  
Архревью сервиса **scooters-ops** проходилось тут: https://st.yandex-team.ru/TAXIARCHREVIEW-953  

Кратко:  
Есть самокаты, которые могут разрядиться. Когда мы считаем, что их пора зарядить, то они становятся недоступными для клиентов. Есть специально выделенные курьеры (энерджайзеры), которые могут им заменять аккумуляторы на заряженные. В одного курьера влезает не более N аккумуляторов. Они перемещаются тоже на самокатах. Требуется спланировать для курьеров заказы вида: забери заряженные аккумуляторы, последовательно заряди эти самокаты и верни разряженные аккумуляторы обратно.  
И есть похожая задача "воскрешения" самоката, когда помимо замены аккумулятора надо еще специальным инструментом (снасть) его "вернуть в строй".  
А еще есть необходимость перемещать самокаты в зоны с повышенным спросом. Соответственно надо решить задачу как оптимальным образом фургон вместимостью не более N самокатов отправить забрать определенные самокаты и выгрузить их в заданных зонах.  
Думаю для обоих задач (и перезарядки, и перемещения) неплохо держать в голове возможность исполнителя перемещаться не только на доступных сейчас транспортных средствах (например, зарядка самокатов в будущем может быть и на автомобиле).


Сервис будет пытаться оптимальным образом объединять драфты в миссии и пытаться назначить их на исполнителей.
На данный момент считаем, что работы можно разделить на 3 группы:
1. Перезарядка или воскрешение самоката (в точке P)
2. Перемещение самоката (забрать в точке P1 + выгрузить в точке P2)
3. Прочие вспомогательные: забрать из лавки аккумуляторы, инструмент для воскрешения (снасть) и т.п.

Соответственно на начальном этапе планируется два основных модуля:
1. Перезарядка + воскрешение самокатов
2. Перемещение самокатов

Деление на два модуля обусловлено тем, что эти задачи решаются двумя разными алгоритами (хоть один из них и можно свести к другому https://st.yandex-team.ru/EFFICIENCYDEV-16382).

Предполагается, что на этапе MVP будут реализованы лишь сильно упрощенные версии алгоритмов и будут оставлены возможности по их дальнейшей оптимизации. Такая информация будет помечена в документе тегом **[postMVP]**.

### Перезарядка и воскрешение самокатов

Упрощенная для MVP версия алгоритма будет примерно такая:  
крон-таска запускается с определенной периодичностью (например раз в минуту) и делает следующее:
1. Собирает всю необходимую информацию
2. Для работ по перезарядке/воскрешению самокатов определяет из какой лавки они могут быть заряжены 
3. Находит кандидатов для каждой лавки из п.1
4. Пытается для кандидатов, лавок и драфтов по перезарядке/воскрешению собрать миссии
5. Миссии, которые удоволетворяют определенным критериям, пытается создать через запросы в `scooters-ops/v1/missions/create`

Для решения задачи нам нужна следующая информация:
1. Список драфтов (`scooters-ops/v1/drafts/actual`)
2. Список шкафов с аккмуляторами (https://a.yandex-team.ru/arc/trunk/arcadia/taxi/uservices/services/scooters-misc/docs/yaml/api/admin_api.yaml#L17 или https://a.yandex-team.ru/arc/trunk/arcadia/taxi/uservices/services/scooter-accumulator/docs/yaml/api/api.yaml#L66)
3. Список кандидатов (сервис `candidates`) (местоположение, ETA до ближайших лавок, вместимость аккумуляторов и т.п.)
4. **[postMVP]** Карта всех самокатов (сервис `scooter-backend` через бибилотеку https://a.yandex-team.ru/arc/trunk/arcadia/taxi/uservices/libraries/scooters-positions), карта повышенного спроса и т.п (`scooters-surge`)
5. **[postMVP]** Информация о уже выполняющихся миссиях (сервис `scooters-ops/v1/missions/performing`) (для оптимизации в процессе выполнения)

MVP-версия алгоритма предполагает быть максимально простой. Примерно аналог того, что запущено сейчас (https://a.yandex-team.ru/arc/trunk/arcadia/taxi/uservices/services/scooters-misc/src/stq/tasks/scooters_misc_dispatch.cpp#L102).
Дальнейшие шаги по доработке предполагают (порядок выполнения шагов не строгий):
1. Подключение велосипедного (или самокатного?) роутера (можно попробовать договориться о добавлении функционала в граф) для оценки расстояния между точками
2. Кэширование ответов роутера (п.1), что может потребовать использования БД (redis?)
3. Использование более лучших алгоритмов (предполагается оптимизировать на модели на основе исторических данных)
4. Подсчет приоритетов для каждого самоката в зависимости от спроса/предложения и окружающих его самокатов (одинокостоящий разряженный самокат зарядить приоритетнее, чем самокат рядом с десятью заряженными)
5. Оптимизация уже запланированных и выполняющихся миссий
6. Создание/подключение аналога `driver-scoring` для возможности в админке задавать веса для алгоритмов

### Перемещение самокатов

В целом задача очень похожа на перезардяку и воскрешение.
Упрощенная для MVP версия алгоритма будет примерно такая:  
крон-таска запускается с определенной периодичностью (например раз в минуту) и делает следующее:
1. Оценивает необходимость выполнения работ
2. Находит подходящих кандидатов
3. Пытается для кандидатов и работ по перемещению собрать миссии
4. Миссии, которые удоволетворяют определенным критериям, пытается создать через запросы в `scooters-ops`

Дальнейшие шаги по улучшению:
1. Подключение роутера (вероятно этот шаг будет уже в MVP!). Вероятно тут может потребоваться как автомобильный, так и велосипедный
2. Использование более лучших алгоритмов
3. Создание/подключение аналога `driver-scoring` для возможности в админке задавать веса для алгоритмов

### Прочие технические детали

В начале никакие кэши не храним и запускаем сбор данных на каждой итерации запуска. Затем, по мере роста числа самокатов и нагрузки, будем думать об оптимизациях. Например делать инкрементальные кэши и т.п.

Количество ресурсов, которое будет требоваться сервису зависит от множества факторов, в том числе какой алгоритм будет выбран и каким образом он будет настраиваться. Пока что мне видится старт с 2 cpu в каждом ДЦ, а потом рост до 16-32 cpu.

При планировании архитектуры закладываемся на ~10000 самокатов на старте (сейчас, насколько мне известно, чуть меньше) и рост примерно в 10 раз.
