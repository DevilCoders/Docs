# Генерация офферов

## Контекст
В рамках добавления тарифа Фикс [TAXIPROJECTS-2432](https://st.yandex-team.ru/TAXIPROJECTS-2432) появилась идея вынести генерацию офферов из Драйва.

Плюсы: 
* уменьшение зависимости от Драйва 
* расширяемость на Wind

Предлагаю в этом rfc обсудить только генерацию офферов, для детального обсуждения Фикса (все, что после бронирования) будет отдельное rfc.

## Как работает генерация офферов сейчас: 
Клиент приходит в ``scooters-offers-create`` (api-proxy), запрос проходит в ``offers/create`` (scooter-backend) там создается оффер и записывается в таблицу ``drive_offers``. После этого клиент приходит в ``scooters-offers-book`` (api-proxy) с id оффера, запрос проходит в ``offers/book``, бэкенд ищет оффер в базе и бронирует его.
![schema](https://jing.yandex-team.ru/files/detinin/current_state.drawio.png)

## Как может работать генерация офферов вне Драйва
### Вариант 1 — мимикрировать под оффер, с которым умеет работать Драйв
Где-то вне Драйва можно написать генератор офферов, который будет принимать начальную и конечную точки, и какую-нибудь дополнительную информацию (про пользователя и самокат), и возвращать оффер. Прокси между клиентом и Драйвом ходит в генератор, получает оффер, и подсовывает его в запросе к платформе самокатов.
![schema](https://jing.yandex-team.ru/files/detinin/new_state.drawio.png)

#### Входные данные
* есть понимание, как работает фикс, что нужно ``scooter-backend``'у для построения оффера (2-5d):
  * теоретически: тип оффера, пользователь, номер самоката, локации точек A, B, продолжительность и расстояние поездки, стоимость во всех статусах, лимиты по времени и пробегу (после которых идет пересчет), способ оплаты, процент кэшбека, время создания и жизни оффера, тип страховки, необходимость депозита
  * практически: нужно в тестинге создать MVP-оффер (без всяких ненужных для ЦЗ самокатов свойств) и потестить его

#### Декомпозиция 
* сделать свой оффер вне Драйва — 2w
  * MVP построения оффера — конфиг + поход в суржер (2d)
  * поход в роутер + поход за зонами замедления + расчет цены (1.5w)
  
  результат этого этапа: есть ручка, которая строит офферы

* принимать готовый оффер в Драйве — 1w
  * написать "переходник" с внешнего оффера на оффер Драйва (можно в Драйве, можно вне) 
  * написать ручку ``offers/add``, которая принимает готовый оффер и кладет его в базу

  результат этого этапа: после вызова http-ручки с json'ом оффера появляется новая запись в drive_offers

* заложить какое-то время на интеграцию и переход, настроить метрики, последить за работой — 1w

  результат этого этапа: офферы полностью строятся вне Драйва и работают внутри Драйва

#### Куда смотреть
* метрики ok/bad rps внешнего генератора офферов и (что важнее) ok/bad rps ``offers/add`` (проверять, что создаем валидные офферы)
* количество / продолжительность поездок не должны упасть после перехода (тут нет идеальной метрики, т к продукт в принципе зависит от дня/времени/погоды)

#### Подробнее про офферы Драйва
Вот [тут](https://a.yandex-team.ru/arc/trunk/arcadia/drive/backend/offers/actions/fix_point.h#L35) описан ``FixPointOffer``. Технически это наследник ``PackOffer`` (оффер, у которого включены минуты и километры). Отличие в том, что ``PackOffer`` настраивает сам пользователь, а ``FixPointOffer`` настраивает бэкенд в зависимости от маршрута (и еще много чего, но сейчас не так важно).

Вот [тут](https://a.yandex-team.ru/arc/trunk/arcadia/drive/backend/offers/offers/standart.h#L41) описан ``StandartOffer`` — это привычный поминутный тариф. У него тоже много драйвоспецифичных полей, которыми мы не пользуемся.

### Вариант 2 — сделать новый оффер и научить Драйв с ним работать
Идея такая: встроить в Драйв "внешний" оффер. Для этого потребуются изменения в цикле заказа Драйва. Кажется, что тут много минусов:
* сильно больше разработки, чем в 1 варианте
* высок риск поломать что-то Драйву

Мне кажется, что этих минусов достаточно, чтобы не рассматривать дальше этот вариант.

___
### Как все-таки прийти в состояние, когда вне Драйва писать быстрее/проще, чем внутри?
Тут можно много обсуждать, напишу, что думаю:
* в Драйве есть "ядро" — цикл заказа. Из-за монолитной архитектуры многие части (офферы) сильно с ним связаны
* из-за сильной связности многие изменения требуют дописывания кода в Драйв (чтобы не ломать связи с "ядром")
* моя идея в том, чтобы начать распил с выноса "ядра" — будет проще научить работать "наше ядро" с сущностями Драйва, чем наоборот

### 1 итерация:
* ``scooters-offers-create`` собирает данные из разных ручек про антифрод/подписку/курьеров
* ``scooters-offers-create`` идет в ``/scooters-offers/v1/offers-create`` (uservices)
* ``/scooters-offers/v1/offers-create`` идет в ``scooter-backend``, получает оффер, дополняет его чем нужно, кладет в базу, возвращает в ответе в клиентском формате
