Дизайн [тут](https://www.figma.com/file/APbRKVYn8nj6eyBy6aeYxb/Scooter?node-id=824%3A287743)

[Обшая логика работы промокодов/купонов в Wind](https://wiki.yandex-team.ru/users/denistimoshin/pro-kupony-v-vinde/)

Простыми словами можно описать логику таким образом, что есть две сущности - промокод и купон.

Промокод это сущность, которая сама по себе не несет никаких выгод для юзера, а лишь является средством получения купона, который в свою очердь уже описыват какую-то выгоду.

Купон пользователь может выменять за промокод, но это не единственный способ получить купон:
- купон пользователю можно выдать в админке винда;
- пользователь может получить купон пройдя опрос в винде (факт выдачи происходит на стороне бэкэнда после того, как приложение дергнет ручку о том что юзер прошел опрос);
- если пользователь припаркует самокат на определнной парковке (выдача происходит на стороне бэка винда).

Со стороны клиентского бэка винда есть три ручки для промокодов/купонов:
- ручка активация промокода **POST /v1/promotionCodes/records**, по вызову которой происходит выдача купона юзеру, если промокод валидный;
- **GET /v1/user**, в ответе которой есть массив купонов юзера;
- **GET /v1/user/expiredCoupons**, которая возвращает список протухших/использованных купонов.
  
## Флоу в go/yango:

В приложении есть точка входа на экран с купонами юзера, которая является шорткатом в шторе на дискавери самокатов. Чтобы сформировать этот шорткат бэк должен в ручке **4.0/mlutp/v1/products/screen/scooters-discovery** понять по полю **state.location**, что пользователь находтися в Израиле и вернуть шорткат.

Объект шортката в ответе:
```json
{
  //...
  "items": [
    //...
    {
      "attributed_subtitle": { // attributed_text
        "items": [
          {
            "font_weight": "regular",
            "color": "textMinor",
            "font_size": 13,
            "text": "Enter promo code",
            "font_style": "normal",
            "type": "text"
          }
        ]
      },
      "background": {
        "color": "#F1F0ED"
      },
      "overlays": [
        {
          "shape": "bottom_right",
          "image_tag": "image_scooters_coupon" // надо завести иконку с таким тэгом
        }
      ],
      "width": 6, // на всю ширину
      "shortcut_id": "discovery_scooters_coupons:d26f9aaa...",
      "action": {
        "type": "scooters_coupons"
      },
      "title": "Discounts",
      "type": "action-driven",
      "height": 1
    }
  ]
}
```

Появился новый экшен **scooters_coupons**, который открывает экран с купонами.

По тапу на шорткат открывается экран со списком купонов и полем, по тапу на которое открывается окно для ввода промокода. 

Чтобы получать инфу о купонах, предлагаю 2 варианта на выбор:
1. в ручку **external/sessions/current** добавить объект coupons, который бы брался из виндовой ручки **GET /v1/user** (формат купонов винда по ссылке на вики сверху), когда в заголовке приходит **апитэг**;
   - **плюсы:**
      - минус одна точка отказа по сравнению с отдельно ручкой;
      - т.к. при вызове **external/sessions/current** и так идет обращение **GET /v1/user** (предположительно, нужно уточнить у бэка), то никаких дополнительных запросов к винду делать не надо;
      - т.к. в перспективе **external/sessions/current** хотим разделить на несколько ручек, в числе которых предположительно будет **user/state**, то т.к. купоны являются свойством пользователя, логично будет держать их именно здесь.
   - **минусы:**
      - возможна ситуация, когда запустившись в Израиле мы получим ответ **external/sessions/current** по апитэгу wind, со списком купонов, потом отлистав карту в РФ, тапнув на самокат передргнется **external/sessions/current** с апитэгом rus и в ответе уже не будет купонов, но шорткаты не перезагружаюся при изменения карты и там будет шорткат на купоны, поэтому тапнув по нему у нас не будет никакой инфы для показа. В целом кейс экзотический и большим минусом не является;
      - не очень хочется, чтобы **external/sessions/current** сильно разрасталась, т.к. она и так полинговая на данный момент, но с распилом этой ручки должно стать лучше.
2. ~~сделать отдельную ручку **GET v1/user/coupons**, которая также обращалась бы за списком купонов в виндовую ручку **GET /v1/user**.~~
    - **плюсы:**
        ~~можем подмешать в ответ просроченные/использованные купоны, чего не хотелось бы делать в **external/sessions/current**, потому что нужно дергать **GET /v1/user/expiredCoupons**;~~
    - **минусы**
       ~~т.к. купоны могут потребоваться не только на экране со списком, а еще и на экране карточки самоката, то там придется тоже дергать эту ручку, и это жирный минус по сравнению с **external/sessions/current**, т.к. в ней промокоды доступны всегда в любом месте.~~

В заголовок запроса ручки session **external/sessions/current** нужно бобавить заголовок **Timezone-Offset** для правильного формарования времени в ответе.

Формат объекта с купонами в ответе:
```json
{
  // Вынесли на уровень выше, для починки мест, где нужна шаблонизация валютой
  "currency_rules": { // для формирования строки со скидкой в самом купоне
      "code": "ILS",
      "sign": "₪",
      "template": "$VALUE$ $SIGN$$CURRENCY$",
      "text": ""
  },
  // ...
  "discounts": {
    "is_promotion_code_input_available": true, // дает возможность включить/выключить ввод промокодов
    "coupons": [
      { // купон с типом voucher, который дает скидку на общий чек
        "id": "8255d821-fcd3-4cb5-bc3d-e1c44585672e",
        "start_at": "2018-01-28T12:08:48.372+03:00", // формат даты в ISO 8601
        "expire_at": "2023-01-28T12:08:48.372+03:00", // формат даты в ISO 8601
        "title": { // attributed_text
          "items": [
            {
              "font_weight": "regular",
              "color": "textMain",
              "font_size": 16,
              "text": "Some happy title!",
              "font_style": "normal",
              "type": "text"
            }
          ]
        },
        "type": "voucher",
        "subtitle": {
          "items": [
            {
              "font_weight": "regular",
              "color": "textMain",
              "font_size": 16,
              "text": "Some happy subtitle",
              "font_style": "normal",
              "type": "text"
            }
          ]
        },
        "discount": { // attributed_text
          "items": [
            {
              "font_weight": "regular",
              "color": "textMinor",
              "font_size": 13,
              "text": "$SIGN$$CURRENCY$",
              "font_style": "normal",
              "type": "text"
            }
          ]
        }
      },
       { // купон с типом percentOff, который скидку процента от общего чека
        "id": "8255d821-fcd3-4cb5-bc3d-e1c44585672e",
        "start_at": "2018-01-28T12:08:48.372+03:00", // формат даты в ISO 8601
        "expire_at": "2023-01-28T12:08:48.372+03:00", // формат даты в ISO 8601
        "title": { // attributed_text
          "items": [
            {
              "font_weight": "regular",
              "color": "textMain",
              "font_size": 16,
              "text": "Some happy title!",
              "font_style": "normal",
              "type": "text"
            }
          ]
        },
        "type": "percent_off",
        "subtitle": {
          "items": [
            {
              "font_weight": "regular",
              "color": "textMain",
              "font_size": 16,
              "text": "Some happy subtitle",
              "font_style": "normal",
              "type": "text"
            }
          ]
        },
        "discount": { // attributed_text
          "items": [
            {
              "font_weight": "regular",
              "color": "textMinor",
              "font_size": 13,
              "text": "10%",
              "font_style": "normal",
              "type": "text"
            }
          ]
        }
      },
      { // купон с типом free_unlock, который дает бесплатный старт и у него нет поля discount
        "id": "9255d821-fcd3-4cb6-bc3d-e1c44585673a",
        "start_at": "2018-01-28T12:08:48.372+03:00", // формат даты в ISO 8601
        "expire_at": "2023-01-28T12:08:48.372+03:00", // формат даты в ISO 8601
        "title": { // attributed_text
          "items": [
            {
              "font_weight": "regular",
              "color": "textMain",
              "font_size": 16,
              "text": "Free anlock is awesome!",
              "font_style": "normal",
              "type": "text"
            }
          ]
        },
        "type": "free_unlock",
        "subtitle": { // attributed_text
          "items": [
            {
              "font_weight": "regular",
              "color": "textMain",
              "font_size": 16,
              "text": "Some happy subtitle",
              "font_style": "normal",
              "type": "text"
            }
          ]
        }
      }
    ]
  }
}
```
### Изменение offers/create

Начинаем использовать поле subtitle, но на клиентах необходимо шаблонизировать данное поле с использованием `currency_rules`
{
  ...
  "subtitle": "10 $SIGN$$CURRENCY$ off",
  ...
}



Таким образом есть три типа купонов: voucher, percentOff и free_unlock. Массив купонов в ответе  **GET /v1/user** отсортирован по **expire_at**, где в начале ккупоны с самой ранней датой.

В окне с купонами по тапу на поле для ввода промокода открывается экран, где юзер вводит строку и по тапу на кнопку отправляется запрос к ручке **POST v1/coupons/activate**. Бэк в свою очередь идет к винду в ручку **POST /v1/promotionCodes/records** с этой строкой и в случае успеха приходит пустой ответ и 200.

Формат запроса:
```json
{
    "promotion_code": "some_string"
}
```

После успешного использования промокода, происходит перезапрос ручки, которая возвращает промокоды, в ответе должен быть новый выданный промокод.

### Ошибки вызова 1/user/coupons/activate ###
Винд при запросе ручки **POST /v1/promotionCodes/records** возвращает поле **result**:
```json 
{
    //...
    "result": 0 // -1, -100, -500, -501, -502, -503, -504 
}
```

Предлагаю такой мапинг:
| Wind result | Description                                         | Http code | Response body                                                                           |
| ----------- | --------------------------------------------------- | --------- | --------------------------------------------------------------------------------------- |
| 0           | Success                                             | 200       | ```{}```                                                                                |
| -500        | Promotion code does not exist                       | 404       | ```{"reason": {"code": "unknown_promocode", "title": "", "description": ""}}```         |
| -504        | Unknown promotion code                              | 404       | ```{"reason": {"code": "unknown_promocode", "title": "", "description": ""}}```         |
| -501        | Promotion code outdated or has been used            | 404       | ```{"reason": {"code": "expired_or_used_promocode", "title": "", "description": ""}}``` |
| -502        | Valid group code has already been used (хз что это) | 404       | ```{"reason": {"code": "expired_or_used_promocode", "title": "", "description": ""}}``` |
| -503        | User has already bind a promotion code              | 404       | ```{"reason": {"code": "expired_or_used_promocode", "title": "", "description": ""}}``` |
| -100        | User does not exist                                 | 500       | ```{"reason": {"code": "unknown", "title": "", "description": ""}}```                   |
| -1          | Other unknown error                                 | 500       | ```{"reason": {"code": "unknown", "title": "", "description": ""}}```                   |

Далее, когда купон получен пользователем тем или иным способом, он по логике винда по какому-то приоритету среди имеющихся пользовательских купоново применеяется к следующей поездке. Таким образом после получения купона, он должен учитываться при создании офера на бэке.

Для ввода купона, используем виджет купонов из такси.
Для отображения ошибок используем только значение поле `description`
Если поле отсуствует или пустое - нужно использовать дженериковый текст ошибки("Что-то пошло не так")

### Про создание офера ###

Для создания офера клиент дергает ручку **offers/create**, наш бэкенд идет в виндовую ручку **GET /v1/boards/:boardId**, в ответ приходит объект **defaultBoardPriceModel** с ценой на поездку и анлок, но важный момент, что никакой информации о скидке по купонам в нем нет по той причине, что купоны применяются **только после завершения поездки, причем применится не один из имеющихся купонов, а все** с условием, что они разных типов.

Например, если у пользователя есть три купона разных типов - **freeUnlcok, voucher, percentOff**, то алгоритм применения будет такой:

Пользователь сделал поездку на самокате, где стоймость анлока **unlockingCents=2 ils**, стоймость минуты поездки **pricingAmountCents=1 ils** и время поездки занимает 5 минут **t=5**, то:
1) сперва считается финальная стоймасть поездки **ridePrice = unlockingCents + t * pricingAmountCents = 2 + 5 * 1 = 7**;
2) потом берется купон с типом **freeUnlcok** и из стоймости вычитается сума анлока **ridePrice = ridePrice - unlockingCents = 7 - 2 = 5**;
3) далее бертся купон с типом **voucher**, который дает скидку **discount = 2 ils**, то **ridePrice = ridePrice - discount = 5 - 2 = 3**;
4) последним берется купон с типом **percentOff**, который дает скидку **discount = 10%**, то **ridePrice = ridePrice -  ridePrice * discount = 3 - 3 * 10% = 2.7**;
5) в итоге, финальная стоймость поездки составит **ridePrice = 2.7 ils**.

Важный момент, что хоть к одной поездке могут примениться три купона, все они должны иметь разный тип, т.е. если у пользователя есть два купона с типом **voucher**, то возьмется только один из них. Если у пользователя два купона разных типов, то они оба будут применены к поездке.

Также, если у пользователя есть купон с типом **voucher** со скидкой 5 ils, а он делает поездку стоймостью 3 ils, то купон применится на эти 3 ils и будет считаться использованным, а оставшиеся 2 ils "сгорят".

Из-за того, что купоны применяются уже после совершения поездки, а не во время создания офера, то нет возможности точно указать на карточке самоката, какой точный дисконт получит пользователь и поэтому у нас есть два варианта как мы можем на карточке самоката показать скидку:
1) ~~**безопасный** вариант - можем сказать, что к этому оферу бдет применена некая скидка по знанию факта наличия купонов у пользователя, но точное значение скидки мы не покажем;~~
2) ~~**небезопсаный** вариант - можем подсветить пользователю на карточке самоката, что к поездке будут применены такие-то конкретные купоны, но проблема в том, что если на бэке поменяется логика применения купонов и, например, там сделают так, что применить можно только один купон к поездке, а не несколько, то на клиенте у нас будет показываться старая логика, где мы говорим о том, что применим 3 купона и это очень опасно.~~
3) с бэкенда в ответе **external/sessions/current** будет приходить поле **discounts.offer_promo_title**.

### Отображение суммы скидки по купонам на экране истории поездок ###

**TBD**
