# Тариф "Фикс"
[TAXIPROJECTS-2432](https://st.yandex-team.ru/TAXIPROJECTS-2432)

## Продуктовый сценарий
Пользователь при создании оффера указывает точку Б, мы предлагаем ему цену. Если пользователь соглашается, мы не тарифицируем его поминутно, а списываем нужную сумму единоразово (здесь умышленно опускаем рассмотрение корнеркейсов, которых может быть много). Гипотеза: введение такого тарифа позволяет растить транспортные поездки (за счет новых точек входа на саммари).

## Контекст
В [rfc по генерации офферов](https://github.yandex-team.ru/taxi/rfc/pull/1017) обсуждается вынос геренации офферов из Драйва. Здесь рассмотрим все моменты, в которых принимают участие мобильные клиенты.

## Выбор точки B
Тут зависит от города и требований к сервису в нем:
### Города с парковками (Москва, Краснодар)
#### Требования
Самокаты можно оставлять только на парковках. Пина на экране ``choose_b`` нет (потому что неясно, что он будет показывать). Пользователь вводит адрес —> мы подсказываем ему ближайную парковку к этому адресу и рисуем зону, в пределах которой можно завершить поездку (на парковках) за фиксированную цену. Пользователь может отзумиться и выбрать другую парковку, но выбрать случайную точку мы ему не дадим.
#### Реализация
* клиенты приходят с желаемой локацией из ``/finalsuggest`` в ``/v2/objects`` ([пример запроса](https://paste.yandex-team.ru/6219326))
* ``/v2/objects`` возвращает им парковки (ближайшая парковка к желаемой локации приходит "выбранной")
* у парковок на этом экране есть action с ``type: select_as_destination``
* ``/offers/create`` возвращает оффер или ошибку, из-за которой оффер создать не удалось
* если оффер создался, то ``/offers/create`` возвращает полигон зоны завершения (вот [пример](https://paste.yandex-team.ru/6189635), см. ``finish_area`` и ``finish_area_border``, формат можем поправить, если нужно) (обсудили на встрече, почему не в ``/v1/polygons``, решили, что всем ок)
* пользователь может поменять выбранную парковку (но не может выбрать место, где нет парковки)

#### Оценка
3-4d

### Города, где можно оставлять самокаты везде (сейчас таких нет)
#### Требования
Самокаты оставлять можно везде. Пин на экране ``choose_b`` есть. Пользователь вводит адрес -> мы показываем ему полигон, в границах которого можно оставить самокат. Пользователь может выбрать другую локацию, мы покажем ему новый полигон.

#### Что меняется в реализации
* пользователь может выбрать локацию без парковки (на основе ответа ``/offers/create``)
* клиенты должны отображать пин (на основе ответа ``/offers/create``)

#### Важно
Окнули с [Денисом Мухрыновым](https://staff.yandex-team.ru/muhrynov), что сейчас не поддерживаем

#### Оценка
+2d к основному сценарию
## Нотификации
Нужны нотификации о скором пересчете и о факте пересчета. 
Формат пуша:
* в качестве основы возьмем то, что шлет Драйв ([пример](https://paste.yandex-team.ru/6213940))
* в ``payload.extra`` добавим поле ``type: scooters_on_order``, по нему клиенты будут понимать, что этот пуш нужно отобразить при открытом приложении (по умолчанию пуши в этом случае не показываются)
Оценка: 2d

## Маршрут проходит через зону замедления (реализация зависит от того, где генерится оффер)
* если внутри Драйва, то нужно ходить в велороутер вместо авто и учитывать зоны замедления. Оценка: 3d
* если вне, то нужно изначально прикручивать поход в велороутер (в рамках генерации офферов в целом), 1w

## Выделение финишной парковки на экране totw
На детальной карточке заказа в идеале должен строиться маршрут до парковки. Однако, если пользователь его закроет, финишная парковка должна внешне отличаться от других (над ней будет баббл "едем сюда"). Для того, чтобы бэкенд вернул этот баббл, нужно в запросе к слоям в поле ``state.scooters.destination`` передать локацию финиша в формате ``[lon, lat]``. Взять ее можно из ответа ``/sessions/current``: поле ``segment.session.specials.current_offer.finish`` (там оно передается строкой вида "lon lat")

## Раздел "о тарифе Фикс"
В ответе ``/offers/create`` есть поле ``offers[i].detailed_description``. В нем лежит html'ка, которую нужно будет открыть при тапе на кнопку "о тарифе Фикс". Поддерживается локализация на русский и английский языки

## Клиентское API Драйва
Сейчас клиентское API Фикса в Драйве выглядит следующим образом:
* ``offers/create`` в массиве ``offers`` возвращает офферы. В каждом оффере есть поле ``type``. Для обычного оффера ``type = standart_offer``, для фикса ``type = fix_point``
* в объекте ``offers[i]`` будет приходить ``short_name`` (Указать адрес) и ``subname``(от 100₽) — это ключи, по которым можно будет найти танкерные ключи в секции ``l10n`` эксперимента [scooters](https://tariff-editor.taxi.yandex-team.ru/experiments3/experiments/show/scooters/current)
* чтобы узнать, есть ли фикс для конкретных локации & пользователя & самоката, клиенты дергают ``offers/create``. Если фикс есть, то вернется оффер с ``type = fix_point`` и ``isFake = true`` (это такой специальный "сигнальный" оффер — в базу он не сохраняется, забукать его нельзя)
* чтобы построить оффер Фикса с точкой B, нужно передать координаты точки B параметром ``user_destination``. Опционально, можно указать параметр ``offer_builder_type=fixpoint_offer_builder``, и тогда в массиве офферов вернется только Фикс (вообще говоря, мне такой подход не очень нравится, т к клиентам незачем знать, что такое ``offer_builder``)
* клиенты отображают плашку активного заказа на основании ответа ``sessions/current``. Нужно научиться отображать и заказы по фиксу (``sessions[0]['segment']['session']['current_offer']['type'] = 'fix_point'``)
* при превышении рассчитанного времени/пробега пересчитывается стоимость — детализация отображается в ``sessions/current`` (см. ``sessions[0]['segment']['session']['specials']['current_offer_state']``, и там ``waiting_price``, ``overtime_price``, ``overrun_price``)
* После завершения поездки финальную стоимость можно узнать, сходив в ручку ``https://tc.tst.mobile.yandex.net/4.0/scooters/sessions/history?session_id=<session_id>``. Она может отличаться от той, что приходила в ``/sessions/current``, если был перерасчет

## Ошибки:
### Пользователь пытается завершить поездку не там, где нужно (в зоне работы сервиса)
#### Что в Драйве
В ``sessions/current`` есть поле ``sessions[0]['segment']['session']['specials']['current_offer_state']['is_correct_finish_position'] = bool``, [пример](https://paste.yandex-team.ru/6165737). Если сейчас пытаться завершить поездку "не там", то клиент спросит, уверен ли я в этом. Если нажать, что уверен, уходит обычный запрос к ``tag/evolve``, а бэкенд, зная текущую локацию, понимает, нужно ли что-то пересчитывать.
#### Что хотим в Самокатах
**Описание логики псевдокодом:**
```(python)
is_in_finish_area = post('/tag/evolve?dry_run=true')
if is_in_finish_area:
  post('/tag/evolve')
else:
  should_do_recalculation = ask_user_to_do_recalculation()
  if should_do_recalculation:
    post('/tag/evolve?user_choice=accept')
  else:
    pass
```
**API:**
* клиент идет в ``/tag/evolve`` с ``dry_run=1`` завершать поездку
* если самокат не в зоне завершения, бэкенд вернет ``400`` с ``error_code=scooter_is_not_in_fix_finish_area`` ([пример](https://paste.yandex-team.ru/6299025))
* если пользователь готов завершить аренду с пересчетом, клиент идет в ``/tag/evolve`` c ``user_choice=accept``

**Оценка:** 2d

### Пользователь хочет построить фикс до точки, где сервис не работает
API:
* ``offers/create`` ответит ошибкой ([пример](https://paste.yandex-team.ru/6299013)). (можно ориентироваться на ``400`` и ``cannot_drop_car_in_destination`` в ``error_details["special_info"]["error_code"]``)

Оценка: 1h (уже есть в Драйве, нужно только проверить)

### У самоката не хватит заряда, чтобы доехать
Сейчас Драйв такое не обрабатывает, надо дописать.

API:
* в случае запроса с локацией точки B (построение конкретно фикса) ``/offers/create`` вернет ошибку ``not_enough_charge`` ([пример](https://paste.yandex-team.ru/6213654))
* в случае первого запроса (по ответу которого клиенты понимают, доступен ли фикс), бэкенд просто не вернет оффер фикса
 
Оценка: 2d

### Пользователь указывает слишком близкую/далекую точку B
API:
* ``offers/create`` вернет ошибку ``too_close_destination`` / ``too_far_destination`` ([пример](https://paste.yandex-team.ru/6214989))

Оценка: 1h (уже есть в Драйве, нужно только проверить)

## Как будем следить за пересчетом (backend-only)
При пересчете оффера можно отправлять событие в ``event_log`` ([код](https://a.yandex-team.ru/arc_vcs/drive/backend/offers/actions/pack.cpp?rev=r8894408#L755)), и потом смотреть их в кибане/YT
