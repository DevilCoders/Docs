## Название сервиса
scooters-subscription

# Задачи сервиса
## Какую продуктовую проблему решает сервис?
Хранение и автопродление подписок на Самокаты

## Почему нельзя решить эту задачу без разработки нового сервиса существующими решениями?
Рассмотрели следующие неподходящие решения:
- Тарификатор Медиабиллинга (https://wiki.yandex-team.ru/tarifikator/) - требует подписку на Плюс - может оказаться слишком дорого
- Подписки Траста (https://wiki.yandex-team.ru/trust/payments/api/subscriptions/) - легаси, больше не поддерживаются

Причины:
1) сроки - у нас хард дедлайн старт сезона в Мск/Спб и важно уже иметь готовую реализацию (условное mvp) к февралю. Мы можем на себе обкатать эту подписку и собрать список проблем и зафиксить до старта. Подписка Плюса делает сейчас свой тарификатор для таких сервисов как мы (я не могу на весь чатик писать их названия, сорри), но там есть большие риски к старту сезона не успеть сделать все необходимое с обеих сторон - а нам важно быть на старте сезона с подпиской

2) экономика - они готовы пойти на серьезное удешевление оффера подписки именно Плюса с включенными самокатами, но непонятно как будет сходиться экономика у нас и у них, это тоже время на обсуждение и придумывание этих самых офферов.

3) неПлюсовики - нет полной уверенности, что те пользователи, которые без Плюса будут готовы купить помимо самокатов еще и Плюс - нужно обьяснять им, что они получают дополнительно. То есть тут большая продуктовая работа и наша и их

Что на будущее:
Мы не рвем с ними связь и я буду участвовать в проработке совместной подписки, где мы все эти блокеры будем обсуждать. 
Но в новом сезоне мы в подписке Плюса не будем.

## Как именно сервис будет решать поставленные перед ним задачи?
- CRUD для хранения подписок
- Возврат активной подписки по пользователю
- Периодическое автопродление подписок, если было включено пользователем

## Разрабатывается один сервис или система?
Один сервис

# Взаимодействие

## Сервис внутренний или внешний?
Внутренний

## С кем взаимодействует сервис?
- transactions-ng (оплата автопродления подписки)
- scooter-backend (выставление тегов для управления тарификацией)
- stq (автопродление, ожидание оплаты)
- experiments3

## Какие базы использует?
postgres

## Какие периодические процессы?
- проверка оплаты
- автопродление подписок
  - заводим STQ на конец периода текущей подписки минус какой-то настраиваемый гэп
  - в нём уже ищем подписку по `id`
  - если цена подписки увеличилась - то не продлеваем автоматом, а уведомляем пользователя о скорой отмене
  - запускаем оплату по старому привязанному методу оплаты
    - в коллбэке успешной оплаты обновляем запись и теги в Драйве 

# Хранение и обработка данных

## Планируется обработка персональных данных
Нет

## Какие данные и по какой схеме сервис будет хранить в базе?
subscriptions
- id
- yandex_uid
- product_id
- created_at
- payment_method_id
- payment_id
- activated_at
- expired_at
- autoprolongate
- offer (jsonb { "price", "currency", "insurance" })

subscriptions_history
- history_event_id
- history_user_id
- history_originator_id
- history_action
- history_timestamp
- history_comment
- все колонки таблицы subscriptions

## Какой объем данных будет храниться и какой объем будет изменяться в единицу времени?
Всего на 2022 год: 920МБ = (1.5М пользователей в 2022) * (280 + 332)
(если каждый будет с подпиской, для пользователей без подписки - записей не будет)

Изменений:
- << 48 rows/sec (rps) * 2 (history)
- << 15 KB/sec (rps * (280 + 332))

Размер записи subscriptions ~= 280 байт (
- 36 - id uuid
- 10 - yandex_uid text
- 36 - product_id uuid/text
- 8 - created_at datetime
- 36 - payment_method_id
- 36 - payment_id uuid
- 8 - activated_at datetime
- 8 - expired_at datetime
- 1 - autoprolongate bool
- 100 - offer jsonb
)

subscriptions_history ~= 332 байт 280(subscriptions) + 52 (
- 8 - history_event_id bigint
- 10 - history_user_id text
- 10 - history_originator_id text
- 10 - history_action text
- 4 - history_timestamp integer
- 10 - history_comment text
)

## Какие операции над данными заложены?
- поиск активных подписок по yandex_uid
- создание/обновление подписок

## Есть ли какой-то стейт в памяти, как он обновляется и валидируется?
Нет.
Для 24rps похоже что нет смысла делать кеш.

# Отказоустойчивость и масштабируемость

## Какая нагрузка ожидается?
Сейчас <= 3rps.
В следующем сезоне увеличится до 24rps (x8 с ростом количества пользователей).

## Какие фолбеки предусмотрены на сам этот сервис?
Фолбэк на чтение - сообщаем пользователю, что не удалось загрузить подписку, но, в силу того, что данные как бы дублируются и в Драйве, то расчёт стоимости идёт с учётом подписки.

Фолбэк на запись в базу - либо повторяем запросы клиентом т.к. они идемпотентны, либо оно сломалось в STQ и само перезапусится.

## Какие фолбеки предусмотрены внутри этого сервиса на взаимодействие с другими сервисами?
- transactions-ng - задержка активации подписки, задержки списания денег - продлеваем возможность пользоваться
(лучится само-собой, повторными запусками STQ)
- scooter-backend - (лучится повторными запусками STQ)

## Какие возможности масштабируемости закладываются?
Увеличение в 8 раз числа пользователей Самокатов 192k -> 1.5М пользователей к концу 2022 года.

## Какие точки отказа есть в сервисе?
- БД
- Смежные сервисы

# Метрики

## Укажите ключевые продуктовые метрики сервиса, за которыми планируете следить
Количество активных подписок
	
## Укажите технические метрики
Стандартные мониторинги микросервиса и БД postgress
Монитоинг ручек.

# Планы роста

## Какая функциональность ожидается в сервисе в будущем?
- поддержка новых механик подписок
- поддержка других самокатных бэков (сейчас их уже 2: scooters-backend и wind)

## Какое изменение нагрузки планируется?
Рост за счёт увеличения количества пользователей самокатов.
Ожидаётся x8 (192k -> 1.5M) активных пользователей к концу 2022 года.

## Активно ли будет изменяться сервис?
Да
