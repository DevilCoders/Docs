### В чём проблема?

Подробно можно ознакомиться в [тикете](https://st.yandex-team.ru/GOFIXME-58).

### Как решить проблему?

К сожалению, поправить сколковские бекэнды мы не можем. Остаётся только решать на своей стороне. В тикете сказано о возможности вынесения логики получения доступа в Сколково через stq. Предлагаю делать это вне `backend-cpp`. Поискав по сервисам, никакого подходящего места не нашёл. Заводить окружение под одну только stq, которая будет вызываться, судя по текущим логам, ~2р/мин, - перебор. Не очень подходящее место, но всё же смотрится лучше остальных - `toll-roads`. Что скажете?

### Получение нового токена

Токен, благодаря которому можно получать разрешение на въезд на территорию, время от времени отваливается. Просыпаться посреди ночи, чтоб его запросить и обновить, - дело неблагодарное. Нужно автоматизировать.

#### Вариант 1. Небезопасный

Через конфиг и крону. Плохо, т.к. токен должен быть секретным. С другой стороны, у нас всё равно сейчас один токен на прод и тестинг, а поскольку все имеют root'ов на все тестинги...

#### Вариант 2. Не согласован с идеологией Сколково, но работает

Суть - держать токен в memstorage. Это относительно безопасно, но будет несколько запросов в апи Сколково.  
Запрашивать, кажется, нужно в двух случаях:  
1. Кеш пуст - старт сервиса  
2. Отваливается по токену (по ответу Сколково-апи можно понять, когда это так)  

Всего 2 инстанса toll-roads - не уложим Сколково. Проблема в том, что, как заверили в чатике интеграции, старый токен должен слетать, притом сразу же. Но как показывает практика (курление) - не слетает.

#### Вариант 3. Тоже с недостатками

Можно при ошибке неправильного токена ставить stq в ещё одну, новую очередь F, отвечающую только за обновление токенов, и сохранять результат в таблицу, в которой 2 поля: (timestamp, token). Берём запросами ту запись, что имеет максимальный timestamp. В очереди F ставим задачи только с одним константным task_id, чтоб не ставить несколько задач. stq сначала добавляет запись, затем удаляет все, кроме этой новоиспечённой. redis'а, к сожалению, нет в toll-roads, но есть pg.

stq - система at least once, поэтому не факт, что здесь тоже не будет гонок. Но, учитывая всё вышесказанное, шанс косяков ~0.(0)%.
