# Cross-device

В данный момент разрабатываем только для флоу алисы.

## Задача:
У пользователя должна быть возможность заказать такси в алисе и увидеть его в приложении на телефоне


## Необходимые изменения

* Обнаружение заказов с других устройств (другой user_id)
* Работа с заказами с другим user_id

### Обнаружение заказов с других устройств (другой user_id)

Для получения заказов используется ручка `/launch`. В рамках кросс-девайса, в ответ ручки (в `orders_state.orders` и `orders`) будут подмешаны "чужие" (т.е. не-этого-user_id) `orderid`.

В случае с Алисой, будут подмешаны заказы с тем же yandex_uid и source: 'alice'.

__Важно__: этого недостаточно для полноценного и качественного обнаружения "чужих" заказов на устройстве (мобильное приложение не дает подходящих для задачи гарантий по вызову /launch).
В будущем решение этой проблемы может опираться на:
1) Новую ручку для поллинга и получения новых заказов (например, /orderstate)
2) Новые пуши

В данном рфц этот вопрос не рассматривается.

#### Реализация

В данный момент в /launch присутствует фильтрация заказов по комбинации (user_id, phone_id):

```
orders = db.order_proc.find({
    'order.user_id': USER_ID,
    'order.phone_id': PHONE_ID,
    'order.status': {'$in': [STATUSES]}
})
```

Для кросс-девайса было бы удобно заменить user_id на yandex_uid, однако:

1) По order.user_uid нет индекса (и его скорее всего не дадут создать)
2) У некоторых пользователей отсутствует yandex_uid (и непонятно как его добавлять)

В качестве альтернативы можно избавиться от фильтрации по user_id в монго-запросе, заменив её на фильтрацию на стороне бекенда:
```
orders_chunk = db.order_proc.find({
    'order.phone_id': PHONE_ID,
    'order.status': {'$in': [STATUSES]}
})
if user.yandex_uid and user in alice_crossdevice_exp and crossdevice_config_enabled:
    orders = [o for o in orders_chunk if o['order.user_uid'] == YANDEX_UID]
else:
    orders = [o for o in orders_chunk if o['order.user_id'] == USER_ID]
```

Также возможна грануляция кросс-девайса по source (например, отдай мне заказы с моего устройста и с Алис с таким же yandex_uid — в этом поможет поле 'order.source')

Недостатки:
1) Гоняем больше трафика между order_proc и протоколом для пользователей с несколькими устройствами (сколько их?)

Оценки:
* Модификация /launch для кросс-девайса Алисы с рубильником ALICE_ALLOW_CROSSDEVICE - 1д

## Авторизация в ручках взаимодействующих с заказом

Список ручек:
* /launch
* /taxisearch
* /taxiontheway
* /taxiroute
* /feedback
* /changecorpcostcenter
* /changepayment
* /changeaction
* /changecomment
* /changedestinations
* /changeclientgeosharing
* /changeporchnumber
* /changes

Формально некоторые из этих ручек не могут быть использованы в кросс-девайсном флоу на данный момент (/changeclientgeosharing , см ниже), однако лучше закрепить за ними возможность такого поведения (будут добавлены тесты)

Некоторые ручки проверяют соответсвие request.body.user_id/auth.user_id и order.user_id (например, отмена заказа в totw или смена точки Б). Такие ручки неизбежно ходят в dbusers, и для их работы можно добавить конфигурируемую авторизацию по yandex_uid (регулируется конфигом CROSSDEVICE_ENABLED).

Также существует проблема обработки некоторых изменений:
"Например есть проблема с totw payment_changes статус обработан он или нет хранится исключительно на клиенте. Также фидбек приоритетней на клиенте.", заведен тикет https://st.yandex-team.ru/TAXIBACKEND-23972



### Шаринг пользовательского местоположения (live location) при кросс-девайсе

У пользователя есть возможность шарить свою локацию с водителем. Для этого он отправляет свое местоположение (по user_id) в /clientgeo, далее сервис user-tracker отдает её потребителям.

Сейчас при кросс-девайсе это работать не будет — посылаемый клиентским приложением user_id отличается от order.user_id, фактически клиент будет посылать свою локацию "вникуда". В теории можно было бы сматчить заказы Алисы по yandex_uid'у, однако это потребовало запроса в dbusers/usersapi и order_proc, что слишком тяжело для такой ручки.

В качестве быстрого решения отключаем шаринг локации пользователем для кросс-девайса.

#### Отключение шаринга локации юзера в UI [сейчас не делаем]

На данный момент мы это не реализуем, т.к. продуктовая ценность крайне мала. Ниже для истории оставлены рассмотренные варианты.

__Вариант 0 — новое поле в /totw отключающее шаринг

В корень ответа /taxiontheway добавляется поле
`"clientgeo": {"disabled": true|false (default: false)}` — прямое указание не показывать кнопку шаринга локации на клиенте (по функционалу аналогично ответу /clientgeo `{enabled: false, ...}`)

__Вариант 1 — использовать существующие механизмы (плохая идея: сломает пуши и еще что-нибудь) [отклонено]__

Сейчас клиенты НЕ показывают шаринг, если `isMultiOrder || !gpsTrackingEnabled || !enabledOrderStatus || isOrderForOther`

* isMultiOrder — определяется по количеству заказов в /launch
* gpsTrackingEnabled — клиентская настройка
* enabledOrderStatus — слишком большой рубильник
* isOrderForOther — зависит от наличия extra_contact_phone в /totw и /taxisearch

В качестве грязного хака для кроссдевайсных заказов можно в /totw посылать "extra_contact_phone" равный телефону пользователя

Вердикт: сломает пуши и еще что-нибудь, клиенты против.

__Вариант 2 — новый объект в /totw с хитрой логикой [отклонено]__

`{"order_owner": {"user_id": XXX, "source": YYYY}}` — В будущем клиент сам может понять "с каким" user_id нужно отправлять запросы /clientgeo.

Вердикт: Выглядит как костыль, никому не нравится.

### Как кроссдевайс взаимодействует с ограничениями мультизаказа?

В случае с Алисой, пользователь-Алиса обладает тем же phone_id, что и потенциальный "подхватыватель" заказа. Таким образом, ограничения по phone_id продолжают действовать.

### Не стрельнет ли антифрод?

Уточняю у d4rk@, но при беглом просмотре всё ок.

## Метрики

Дашборд https://grafana.yandex-team.ru/d/NHXjNiKWk/taxi-alice?orgId=1

* Отслеживать количество 403/401 и прочих NOT_AUTHORIZED на графиках

Создать дашборд по всем потенциальным ручкам, следить за всплесками (из-за малого количества заказов может не помочь)

* Отслеживать количество кросс-девайсных "подхватов"

На данный момент сложно проанализировать. Возможные варианты:
1) LOG_INFO() в /launch'е при отдаче заказа с "чужим" user_id (см "Обнаружение заказов с других устройств (другой user_id)", и итоговый анализ при помощи кибаны/YT (минусы: не риал-тайм)
2) Отправка в соломон (минусы: притащить соломон в /launch, некорректная метрика)
3) Отправка в отдельную коллекцию / сервис-аггрегатор (минусы: громоздко)

* Отслеживать количество заказов сделанных через Алису


### Оценки

* /launch и /taxi* ручки - 2d
* /change* ручки — 1d
* метрики и дашборды — 1-2d
* доделки — 1d
* запуск — 2d

