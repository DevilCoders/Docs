##  Задача
Сейчас клиенты, выбирающие в качестве способа оплаты корпоративный счёт, видят в приложении цену.
Необходимо сделать доработку, позволяющую скрывать цену для таких пользователей. 
При выбранной корпоративной оплате цена не будет показываться, что может позволить в дальнейшем менять её 
(например, делать выше, чем для оплаты самим пользователем, предполагается, что это потребуется не на первоначальном этапе) 
и сильнее различать работу при выборе разных способов оплаты.

 ### Детали задачи
 Необходимо иметь возможность задавать, для каких корпоративных клиентов цена будет показываться, для каких - скрываться.
 Также было бы хорошо иметь возможность выбирать, что показывать на клиенте вместо цены.
 
 ## Где встречается цена
 Сейчас цена на клиенте видна:
 1. На саммари, показом управляет ручка `/routestats`. Цену скрывать надо.
 2. В карточке заказа. Цену скрывать надо. Ручка `/taxiontheway`, поля `cost`, `cost_message`, ... .
 3. В истории заказов. Пока скрывать цену необязательно, но надо рассмотреть такую возможность.
 
 Для того, чтобы скрывать цену и всю связанную информацию в `/taxiontheway`, скорее всего, потребуется хранить признак скрытия цены 
 рядом с заказом, в order_proc. 
 
 ### История заказов
 Сейчас история заказов получается из сервиса `orderhistory`. 
 Сервис не знает, как устроены заказы (Такси, Еда, QR), про которые он отдаёт ответ, и ничего в истории не меняет.
 Таксишные заказы получаются из сервиса `ridehistory`, надо изучить, откуда он берёт заказы. Если из `order_proc` - скорее всего, 
 задача на бэкенде решается одновременно с решением задачи скрытия цены в `/taxiontheway`.
 
 ### Кэшбек
 Сейчас на саммари, помимо цены поездки, показывается величина кэшбека. 
 Если её тоже надо скрывать - это надо обсуждать и прорабатывать отдельно.
 
 ## Взаимодействие с b2b продуктом
 
Сейчас взаимодействие с корпоративным счетом происходит с помощью ручки `/v1/corp_paymentmethods` сервиса `taxi-corp-integration`.
Она позволяет получить информацию о корпоративном счёте перед заказом и используется в протоколе в `paymentmethods`. 
Один из вариантов - использовать эту ручку, другой - добавить новую в том же сервисе.
 
 Простые варианты (обойтись экспериментом, без изменения на стороне b2b продукта), с моей точки зрения, подходят только для mvp, 
 потому что в перспективе затрагивается значительная часть флоу заказа.
 ### Вариант 1
 В ручке `/v1/corp_paymentmethods` уже есть флаг `hide_user_cost`. 
 Он когда-то добавлялся для [проекта](https://st.yandex-team.ru/TAXIBACKEND-12938#5afddc2176c7ea001c91eda5), 
 который не был реализован. Флаг остался и заполняется в false, в протоколе - значение сохраняется и никак не используется.
 Можно его переиспользовать для новой задачи.
 
 Плюсы:
 - api уже есть
 - ручка выглядит подходящей для этого флага
 - если нам потребуется информация при расчёте стоимости поездки 
 (например, для повышения стоимости для таких клиентов), мы будем хранить её рядом с остальной информацией о корпоративном счёте
 
 Минусы:
 - если мы захотим получать эту инфоормацию только перед показом цены, то в имеющейся ручке много того, что нам не нужно
 ### Вариант 2
 Новая ручка в сервисе `taxi-corp-integration`
 Плюсы и минусы противоположны первому варианту
 ### Вариант 3
 Для быстрой проверки гипотезы брать информацию сразу из эксперимента или конфига, 
 проверять не на стороне корпоративных продуктов и возвращать в протокол, показывать или не показывать цену, 
 а проверять эксперимент или конфиг сразу в протоколе прямо перед показом цены.
 
 Плюсы:
 - быстрое решение
 - от решения будет проще всего отказаться, если фича не полетит
 
 Минусы:
 - не получится добавить дополнительную логику на стороне корпоративного продукта, 
 использовать значение для более сложной логики - только проверка гипотезы
 - эксперимент может поменяться во время поездки, с этим придётся как-то работать в протоколе
 - решение создаёт техдолг
 
## Возможные детали реализации
Все доработки надо закрыть экспериментом. 
Эксперимент может содержать выбор, что показывать вместо цены - тогда это надо дополнительно обсуждать с клиентскими разработчиками 
(более подробно - в описании доработок на клиенте). 
Выбор можно настроить по пользователям. 
Также самих корпоративных клиентов можно либо настроить по проценту от `corp_client_id`,
либо завести конфиг, в котором указать `corp_client_id` тех, для кого будем скрывать оплату.

## Этапы разработки
### Разработка mvp 
Только скрываем цену в момент заказа. 
На этом этапе действительно можно обойтись экспериментом.
- обсудить детали (перечислены в разделе "Клиентская разработка для mvp реализации") с клиентскими разработчиками
- если остановились на эксперименте - завести эксперимент, если нет - тогда доработка на стороне b2b продукта
- доработка в ручке `/routestats`. Доработку пока делать в протокольной ручке, а не в новом сервисе `routestats`.
В протоколе ответ ручки формируется в `BuildServiceLevels`.
### Клиентская разработка для mvp реализации
В рамках проработки пообщались с клиентской разработкой на тему скрытия цены только в `/routestats`.
Также посмотрели, как сейчас будет выглядеть приложение, если заменить цену в `description_parts` в `service_levels` на `***`.

Предварительно так:
- Можно передавать в `description_parts` в `service_levels` другие символы, цена на клиенте будет заменена на них, доработки на клиенте не нужны.
Проверено в приложении под iOs, выглядит ок. Но при выборе такой реализации надо учесть довольно много деталей, код править в нескольких местах в `/routestats`.
Поэтому можно рассматривать такой вариант, но с пониманием, что он выглядит опасным, доработка на бэкенде будет не в одном месте, и впоследствии надо будет перейти с него на другое решение.

![](img/no_price_summary.jpg)

![](img/no_price_tariff_card.jpg)

- Тарифы в `alternatives`. Чтобы рядом с основными тарифами на саммари со скрытой ценой не показывались 
такие же тарифы с нескрытой, необходимо также скрыть цену в `alternatives` (`description_parts` и `price` в`details`, и то, и другое в `service_levels`)

- Учитывать доступность тарифов. Для недоступных тарифов (`tariff_unavailable`) цену не стоит скрывать, она наклиенте заменена на прочерк.

- Для вертикалей: если всё заменять на символы - должны показываться эти символы, если пожелания другие 
(на вертикали не заменять на символы, показывать что-то другое), то это надо будет прорабатывать отдельно.
Сейчас цена для вертикали формируется на клиентах, должна показываться минимальная цена из тарифов в вертикали.
Проверили на iOs и Android, при замене на `***` цена на вертикали не сломается.
Возможно, впоследствии цена будет формироваться из ответа `/routestats`, когда-то разработали, но клиенты на такое решение не перешли.
Тогда смотреть `VerticalPriceFormatter` в `/routestats` и общаться с клиентами.

![](img/no_price_vertical_card.jpg)

- Самый быстрый. Проверили на iOs, при замене на `***` цена "Самого быстрого" не сломается.

![](img/no_price_the_fastest.jpg)

![](img/no_price_the_fastest_card.jpg)

- Скидки. Необходимо найти все места, где ещё может появиться цена (например, в зачёркнутом виде, при скидке) и не забыть тоже их скрыть.
На данный момент, должно быть достаточно поменять поле цены без скидки `original_price` в `service_levels`.
 
### Подготовка к возможным доработкам после mvp
Отказ от принятия решения по эксперименту в пользу нового поля или новой ручки.
### Клиентская разработка после mvp
Предпочительный вариант  - завести новый флаг в `/routestats`, по которому клиенты будут понимать, что цену надо скрыть.
Предлагается такой вариант, потому что переданный с бэкенда символ может быть не поддержан в некоторых шрифтах, 
поэтому можно было бы оставить логику с символом на клиенте.
### Скрытие цены в момент поездки. 
Имеет смысл изучить и, возможно, сделать одновременно со скрытием цены в истории.
- проработать скрытие цены в `/taxiontheway`
- договориться с клиентами, и начать передавать одно из полей (например, `cost`) аналогично доработке в `routestats` или проще, 
если на саммари будет несколько вариантов, в отличие от карточки заказа
 