# Гипотеза
Более быстрое ображение цены на саммари (на высоких перцентилях - сотни миллисекунд) увеличит конверсию в заказ.

# Метрика
Конверсия в заказ

# Возможные варианты

## 1. На стороне клиента
### 1.1 Запрашиваем сначала малое количество тарифов
Гипотеза в том, что на тарифах, где меньше машин, поиск eta отрабатывает в несколько (4 - TODO проверить) раз быстрее, и они более нужны юзеру, поэтому их запрашиваем сразу, остальные - параллельно. Перерисовываем тарифы после получения второй части.
### 1.2 Сначала запрашиваем цены без ЕТА, потом до-запрашиваем ЕТА
В этом случае routestats не будет знать, есть машины или нет (без ЕТА это можно понять только очень приблизительно, через `candidates/searchable`), и у юзера будет моргать доступность тарифов. Вариант кажется не очень хороший.

## 2. На стороне бека
### 2.1 Ускорение сортировки водителей - через фоллбек
У `lookup_ordering/ordering-bulk` есть фоллбек на поход в `driver-scoring`, который считает ЕТА очень грубо но очень быстро (вроде как на 150мс быстрее на p95 и 250мс на p98). Можно использовать этот фоллбек для подсчета ЕТА на пине всегда, но, кажется, ЕТА будет сильно неточным. Как вариант, дозапрашивать точное ЕТА вторым запросом.
### 2.2 Ускорение сортировки водителей - через настройку driver-scoring
Саша Голубев предлагает потюнить ответ `driver-scoring`, чтобы он укладывался в нужный нам тайминг, при незначительном ухудшении точности расчета ЕТА (например, отключая сложные фильтры). Пока жду ответа от эффективности. 

# Предлагаемый вариант
1.1 + 2.2 (по 2.2 будет дополнено позже)
Если 2.2 не получится - можно попробовать 2.1, посчитав и согласовав снижение точности ЕТА.

# Предлагаемый флоу
## Включенность фичи
- в launch приходит эксперимент, регулирующий фичу. Фича должна выключаться в местах, где тарифов и так мало, и включаться только в крупных городах, где она будет полезна.

## Флоу
- в запрос `routestats` на саммари клиенты добавляют новый параметр `"service_level_filter" = "popular_tariffs_only"`
    - бек при этом считает и отдает `service_levels` только на популярные тарифы (скорее всего это будет выбранный и тарифы с большим количеством машин)
    - для тарифов, которые не вернулись, в `service_levels` передаются заглушки, чтобы клиенты могли отрисовать шиммер
- параллельно с этим запросом, клиенты идут в новую ручку `get_all_service_levels` (имя надо придумать лучше), которая вернет все тарифы (для простоты, чтобы клиенты просто заменили все информацией с бека). Ответ полностью аналогичен полю `service_levels` в `routestats`
    - параметры этой ручки - подмножество параметров  `routestats`, пока не выяснял, какое именно
- при получении ответа от `routestats`, отрисовываются цены на саммари. По непришедшим тарифам показывается шиммер или что-то (нужен дизайн)
- при получении ответа от `get_all_service_levels` - заменяем на клиентах этот ответ в модели. Если ответ пришел до ответа `routestats` - запоминаем и ждем `routestats`.

# Связь с вертикалями
В текущем дизайне Вертикалей, ЕТА показывается только для выбранного тарифа, которое (кажется) берется из основной модели ответа `routestats`, поэтому тут изменений не потребуется.