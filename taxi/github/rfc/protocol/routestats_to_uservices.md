## Опросник для ревью комитетом

> Этот опросник нужен для [архитектурного ревью комитетом](https://forms.yandex-team.ru/surveys/25357/). Его можно будет скопировать.

**Название сервиса**

`routestats`

**Какую продуктовую проблему решает сервис?**

1. Трата лишних часов на разработку в `backend-cpp`
2. Медленнее докатывается до прода из-за долгих релизов, автотестов и тп
3. Боль от разработки в `backend-cpp`
4. Легко свалить прод, так как монолит

**Почему нельзя решить эту задачу без разработки нового сервиса существующими решениями?**

Если делать только в `api-proxy` - то дальнейшая разработка слишком усложнится. Нужен сервис, куда легко добавить небольшой кусок логики.

**Как именно сервис будет решать поставленные перед ним задачи?**

1. Включаем обработку `/routestats` новым сервисом-проксей по эксперименту.
2. Сервис прокся идет в новую протокольную ручку-аналог `/routestats` без авторизации. Авторизация уходит в Passenger Authorizer.
3. Новая протокольная ручка отдает не только текущий ответ, но и весь свой контекст добавляет в ответ: тарифы, цены, скидки. Это нужно, чтобы второй раз не фетчить это в новом сервисе.
4. Новые фичи пробуем писать только в новом сервисе, меняя ответ протокольного роутстатс и используя данные из контекста. Не очень сложно будет дописывать фичи, которые не требуют новых API вызовов. Сложнее, если нужны новые походы по сети, зависящие по данным от того, что считает внутри протокольный роутстатс: или мы делаем их в новом сервисе непараллельно, или вместе с ними выносим часть старых походов в новый сервис.
5. Гипотеза: в такой схеме можно будет 1/3 всех продуктовых правок роутстатс делать только в новом сервисе через 1-2 месяца после запуска. И 2/3 через несколько месяцев.

Ближайшее развитие если гипотеза подтверждается:
1. Продумываем систему плагинов
2. Постепенно выносим куски фетчинга данных из протокола в новый сервис: например, фетч ETA из `driver-eta`

Дальнейшее развитие если гипотеза подтверждается:
1. Рефактироим код
2. Форсируем распил на микросервисы, например, сервис офферов
3. Объединение оффера и заказа в будущем

**Какая функциональность ожидается в сервисе в будущем?**

Этапы разработки:

1. Прототип для проверки гипотезы технической достижимости: 2-3 недели. Смотрим вместе с руководителями в продукте и инфраструктуре. Если все ок - идем на арх ревью.
2. Продумываем систему плагинов и переносим 1-2 фичи из протокола на них: 1 неделя
3. Запуск: 1 неделя
4. Обучаем и помогаем разработчикам не писать в протоколе. Проверяем в течение месяца гипотезу, что n% правок удалось убрать из роутстатс и от этого был профит.

**Обоснование необходимости проверить гипотезу**

Последние 20 правок `/routestats` и ложатся ли они целиком на разработку только в новом сервисе:

1. новый прайсинг довнедряют - антисурж фиксят - НЕ ЛОЖИТСЯ
2.	коммендантский час - с конфигом по тарифам обновляем unavailable_reason в тарифах - идеально ЛОЖИТСЯ на правку только в новом сервисе, из данных нужно только страну и таймзону каждого тарифа
3.	новый прайсинг - купоны фиксят - НЕ ЛОЖИТСЯ
4.	меняют параметры регистрации пина в буферном диспатче - пришлось бы перенести 400 строк изолированной логики регистрации пина в новый сервис, поэтому ЛОЖИТСЯ
5.	добавляет брендинг визы - полностью ЛОЖИТСЯ, нужны только цены и скидки
6.	добавляют параметр в запрос за виртуальными тарифами - НЕ ЛОЖИТСЯ
7.	регистация пина в буферном диспатче с нуля - сразу сделали бы в новом сервисе, ЛОЖИТСЯ
8.	добавили фолбэк на танкерные ключи про недоступность тарифа - НЕ ЛОЖИТСЯ
9.	добавили mt altpins - ЛОЖИТСЯ, вроде только новые поля
10.	новый прайсинг фиксят - НЕ ЛОЖИТСЯ
11.	фиксанули поход в ml - НЕ ЛОЖИТСЯ без выноса
12.	тюним price modifier для кэшбека - НЕ ЛОЖИТСЯ
13.	не отдаем брендинги для скрытого тарифа - ЛОЖИТСЯ легко
14.	брендинги для кэшбека - ЛОЖИТСЯ вместе с переносом 200 строк изолированного кода про кошелек
15.	фикс плагина предзаказа по фиксу - ЛОЖИТСЯ вместе с переносом 200 строк изолированного плагина предзаказа
16.	новый брендинг - легко ЛОЖИТСЯ
17.	поход в новый сервис за eta для курьерского тарифа - скорее НЕ ЛОЖИТСЯ, так как нужно сначала перенести расчет цен в новый сервис и слать его в протокольный роутстатс
18.	фикс price modifier кэшбека - НЕ ЛОЖИТСЯ
19.	новый прайсинг - НЕ ЛОЖИТСЯ
20.	тултипы кэшбека в брендингах - ЛОЖИТСЯ

Почему вложить разработку в проверку гипотезы может быть выгодно:

1. у нас в среднем 3.5 правки routestats в неделю. Каждая правка в монолит это **+4ч** на ожиданиях тестов, выкатках, ревью, изучении кода, более тщательном кодинге и тп.
2. из них 70% продуктовых изменений (и 45% всех) должны ложиться на новую схему и не требовать изменения монолита по моим прикидкам выше по последним 20 правкам
3. если считать более пессимистично, что только 33% всех правок сможем перевести на эту схему, то это окупится через `(3недели*40ч/4ч./3.5правки в неделю/4.5недель в месяце)/0.33 = 6 месяцев`. Если учесть, что наших правок только половина, то на уровне компании окупится еще раньше.

