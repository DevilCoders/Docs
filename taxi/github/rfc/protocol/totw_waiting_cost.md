# Продуктовое описание

Хотим рисовать таймер бесплатного ожидания и стоимость платного ожидания 
когда закончилось бесплатное. Также нужно где-то хранить цвет текст и разные тексты
в зависимости от того, сколько времени осталось до завершения бесплатного ожидания. 

[Эпик](https://st.yandex-team.ru/TAXIPROJECTS-1941)
![Дизайн](./img/waiting_cost.jpeg)

## Старая логика таймера

В ответе `/3.0/taxiontheway` уже добавляли поле со временем завершения бесплатного ожидание в рамках задачи 
[EFFICIENCYDEV-2347](https://st.yandex-team.ru/EFFICIENCYDEV-2347)

Эта фича на бэке работает по пользовательскому эксперименту [mvp_timer](https://tariff-editor.taxi.yandex-team.ru/experiments/users/edit/mvp_timer),
а время регулируется конфигом [UNPAID_WAITING_SECONDS](https://tariff-editor.taxi.yandex-team.ru/dev/configs/edit/UNPAID_WAITING_SECONDS),
судя по конфигу в проде, фича включена только на эконом в Омске и Нижнем Новгороде.

В корень ответа `/3.0/taxiontheway` добавляется опциональный объект `status_info`:
```json
{
    "status_info": {
        "free_waiting_until": "2020-11-11T19:58:24+0400"
    }
}
```

## Новая логика

Клиентам нужны следующие данные, что бы все корректно отрисовать:
- время бесплатного ожидания / время когда начинается платное ожидание
- стоимость платного ожидания (всего или стоимость минуты)
- новый текст и цвет текста в зависимости от состояния таймера

Логику получения каждого поля опишу отдельными пунктами ниже.

### Время бесплатного ожидания 

Для нового таймера используем это же поле `free_waiting_until` (как и для старого таймера), так же присылаем время до которого ожидание бесплатное.
На бэке тут потребуется доработка, нужно получать время бесплатного ожидания не из конфига, как сейчас, а из тарифа.
Так же следует выпилить старый эксперимент по пользователям [mvp_timer](https://tariff-editor.taxi.yandex-team.ru/experiments/users/edit/mvp_timer)
и перейти на эксперимент 3.0.

Создаем новый эксперимент для бэка, которым будем контролировать отдачу дополнительных данных для отображения нового таймера.
Раскатываем по версиям, что бы на старых клиентах не отображался старый таймер. Если эксп выключен, данные не отправляем.

### Стоимость ожидания

Стоимость платного ожидания сейчас считается в новом прайсинге в момент завершения поездки по данным полученным с таксометра.

Для получения стоимости платного ожидания ходим в ручку прайсинга `/v2/recalc_order` и берем значение от туда. Ручка принимает на вход только order_id.
В ответе придёт уже точное значение платного ожидания на данный момент.
Полученное значение платного ожидания предлагаю прокидывать в новом поле, рядом с `free_waiting_until`:

```json
{
    "status_info": {
        "free_waiting_until": "2020-11-11T19:58:24+0400",
        "waiting_price": 58
    }
}
```

При таком решении добавляется 1 поход в ручку прайсинга из totw'a (ходим из api-proxy), в статусе waiting порядка ~15% от всех запросов (средняя нагрузка totw'a 3k rps), 
нагрузка на прайсинг получается ~500rps

На клиенты прокидываем цену в виде числа. Клиенты буду самостоятельно подставлять эту цену в шаблон с валютой `currency_rules.template`. 
Если цена больше > 1000 (берем из экспа), то на бэйджике будет отображаться строка "1k", данная логика также реализуется на клиентах.

### Цвет и тексты

Нужно доработать код на бэке, что бы заполнялось поле `status_info.translations.card.title_template`, 
в зависимости от того сколько времени осталось до завершения бесплатного ожидания. Клиенты уже умеют обрабатывать данное поле и отображать текст из него.
 
Цвет передаём в объекте `status_info` с бэка. Таким образом финальный ответ будет выглядеть так:

```json
{
    "status_info": {
        "free_waiting_until": "2020-11-11T19:58:24+0400",
        "waiting_price": 45.7,
        "title_color": "#FF0000", 
        "translations": {
            "card": {
                "title_template": "Платное ожидание"
            }
        }
    }
}
```

### Фолбэки

На бэке могут возникнуть какие-то проблемы и некоторые поля могут не прийти, следует фолбэчится следующим образом:

_1) Не пришёл блок `translations` и поле `title_color` (крайне маловероятно)_
Фолбэчимся на дефолные значения, показываем текст который показывается обычно - "Вас ожидает"

_2) Не пришло поле waiting_price (возможно при проблемах в прайсинге)_
Бэйджик с ценой не рисуется на клиентах, либо рисуем последнее известное значение (если есть)
