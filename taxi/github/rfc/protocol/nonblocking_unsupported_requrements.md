# Недоступные требования не блокируют заказ

Хотим сделать так, чтобы при выборе тарифа с недоступным пожеланием (далее НП)
можно было сделать заказ. При этом в большинстве случаев НП будет игнорироваться,
в остальных будет показано предупреждение, например:
"Недоступно пожелание: Детское кресло"
Или в случае если таких несколько (таких случаев мало):
"Недоступны пожелания: Детское кресло и другие"

Новое поведение управляется экспериментом unsupported_requirements_warnings (далее просто "эксперимент"),
тексты (точнее шаблоны) для предупреждения передаются отдельным полем unsupported_requirements_warnings_tpl в zoneinfo.

При попадании в соответствующий эксперимент все пожелания станут tariff_specific:

1. При возврате на предыдущий тариф выбор пожелания сохраняется (не сбрасывается в клиентском флоу)
2. routestats показывает цены и ETA во всех тарифах без учета НП
3. Если пользователь жмет Заказать после выбора тарифа с НП оно сбрасывается.

### Изменения в бекенде

zoneinfo:
  * по эксперименту выставляем всем требованиям tariff_specific
  * передаем клиенту матрицу тариф-требование где нужно показать предупреждение
  * заполняем unsupported_requirements_warnings текстами из Танкера (2 вида текстов)

routestats:
  * от показа ETA и цены по всем тарифам вырастет нагрузка,
    запускать надо на маленький процент и обязательно сделать сравнение технических метрик: насколько эксперимент
    повышает суммарное время запроса driver-eta и pricing-data-preparer

ordercommit:
  * по эксперименту выставляем всем требованиям tariff_specific


### Эксперимент nonblocking_unavailable_requirements

позволяет для зоны и тарифа задать требования, для которых надо выдать предупреждение.
(При необходимости кроме стандартного предупреждения warn схема позволяет добавить другие, скажем с подтверждением)

Пример значения:
```
__default__:
  __default__:
    warn:
      - childchair_for_child_tariff
moscow:
  __default__:
  econom:
    warn:
      - ski
      - double_childchair_moscow
```

В zoneinfo списки объединяются: `__default__.__default__`, `__default__.<category>`, `<zone>.__default__`, `<zone>.<category>`
На клиент в Москве приходит `max_tariffs[].unsupported_requirements_warnings`:
```
{
  "warn": ["ski", "childchair_for_child_tariff", "double_childchair_moscow"]
  # здесь могут быть другие виды предупреждений в будущем помимо warn
}
```


Схема:
```
schema:
    type: object
    properties:
        __default__:
            $ref: '#/definitions/ZoneSettings'
    required:
      - __default__
    additionalProperties:
        $ref: '#/definitions/ZoneSettings'
    definitions:
        ZoneSettings:
            type: object
            properties:
                __default__:
                    $ref: '#/definitions/TariffRequirements'
            required:
              - __default__
            additionalProperties:
                $ref: '#/definitions/TariffRequirements'

        TariffRequirements:
            type: object
            properties:
                warn:
                    description: требования для которых показывать предупреждение
                    type: array
                    items:
                        type: string
            additionalProperties: false
```

### (клиентам) Текст предупреждения при выборе тарифа с неподдерживаемым пожеланием.
В zoneinfo будет новое поле unsupported_requirements_warnings_tpl:
```
{
  "one": "Недоступное требование: $req$",
  "few": "Недоступные требования: $req$ и другие"
}
```
в шаблон `$req$` подставить значение из supported_requirements[].label

### (клиентам) Изменения в логике tariff_specific по эксперименту
1. Перестаем показывать попап при нажатии на кнопку заказа в случае наличия теста для попапа
2. Перестаем показывать плашку о НП в случае отсутвия текста для попапа (логика актуальна только для ios клиентов)
3. При наличии нескольких тарифов с одним и тем же tariff_specific требованием отключение требования для одного тарифа приводит к отключению этого требования на всех тарифах
4. При наличии НП по эксперименту принимаем решение о показе предупреждения либо никак не сообщаем о наличии НП пользователю
5. При наличии не tariff_specific тербований в ответе /zoneinfo не учитываем эксперимент на клиенте (равносильно тому, что он не пришел). В противном случае нужно учитывать возможность одновременного показа старой блокирующей плашки о НП и нового предупреждения о наличии НП.


### НП из-за способа оплаты
    Пока остается как было, будем прорабатывать отдельно.
    
    Если ничего не менять то в случае если UnsupportedRequirementsForPaymentMethod
    находит НП, routestats не покажет цену и проставит соответствующее unavailable_info
    В поведении клиента ничего не поменяется: если выбрали такое требование и способ оплаты для него недоступен,
    то не будут показаны цены и кнопка заказать будет недоступна с текстом
    "Этот способ оплаты недоступен для выбранной опции"

### Этапы запуска

#### Этап 1: 1% с одним Детским креслом
Ввиду того, что эксперимент неоднозначно влияет на такую бизнес-метрику как вероятность заказа без нужного требования
так и на технические метрики по нагрузке на driver-eta и прайсинг будем запускать в выделенной зоне на 1% пользователей.
_Важно_: В зоне не должно быть нескольких требований Детских кресел, как например в Москве. Подходят зоны, в которых есть только childchair_for_child_tariff и редиректы (например himki).

#### Этап 2: 100% с одним Детским креслом
После получения результатов раскатываем на 100% в зонах где только только одно кресло.

#### Этап 3: объединение Детских кресел
будет делаться в рамках отдельной задачи, см. проработку
https://st.yandex-team.ru/TAXIPROJECTS-1908#5f91cfca8f6e4163894de8fb

