# Отображение требований к поездке в зависимости от способа оплаты

### Что уже есть:
В текущей реализации можно выбрать способы оплаты, которыми нельзя оплачивать определенные требования. Это делается через конфиг *PAYMENT_TYPES_IGNORED_BY_REQUIREMENTS*. Недостаток текущего решения, что сейчас клиенты в таком случае просто показывают надпись "Выбранный способ оплаты недоступен". Неочевидно, что проблема именно в требованиях, а также нет кнопки "Сбросить недоступные пожелания".


### Доработки:
Надо сделать новый конфиг наподобие *PAYMENT_TYPES_IGNORED_BY_REQUIREMENTS*. Только он должен быть более гибким, чтобы мы могли легко запрещать какие-то способы оплаты для выбранных требований или наоборот разрешать только определенные способы оплаты. Название конфига - *PAYMENT_METHODS_FOR_REQUIREMENTS*.

Если способ оплаты не подходит для какого-то выбранного требования(по конфигу), то в ответе routestats в поле tariff_unavailable возвращать code "unsupported_requirements_for_payment_method" + соответствующий текст в поле message. (вместо "unsupported_payment_method"). А также добавить опциональное поле для каждого тарифа "unsupported_requirements" - множество требований из-за которых невозможен заказ. Это множество нужно, чтобы клиенты могли удалять эти требования по кнопке "Сбросить недоступные пожелания".


### Задачи:
1. Поменять code и message в ответе routestats в поле tariff_unavailable в случае, когда текущий способ оплаты не поддерживает оплату выбранного(ых) требования(й).(по конфигу)
2. Заменить старый конфиг на новый, поменять логику работы с конфигом и удалить старый конфиг. Очень важно уметь отличать семейный аккаунт от бизнес-аккаунта, поэтому в конфиге надо будет писать не "coop_account", а "business_account"/"family_account". Также это надо учесть в логике работы с конфигом.
3.  В случае кейса "unsupported_requirements_for_payment_method" или "unsupported_requirement" в ответ routestats для соответсвующего тарифа добавлять множество "unsupported_requirements" в котором будут хранится требования, которые надо удалить. (это множество состоит из требований, которые не подходят по причинам "unsupported_requirement" + "unsupported_requirements_for_payment_method").
Иными словами - если есть выбранные требования, которые не подходят из-за тарифа, а также из-за способа оплаты, то они все попадут в это множество. Таким образом после нажатия на кнопку "сбросить недопустимые требования" будет повторный поход в routestats, после которого можно будет сделать заказ.



### Изменение схемы конфига PAYMENT_METHODS_FOR_REQUIREMENTS:


``` 
schema:
    type: object
    properties:
        __default__:
            $ref: '#/definitions/RequirementSettings'
    required:
      - __default__
    additionalProperties:
        $ref: '#/definitions/RequirementSettings'
    definitions:
        RequirementSettings:
            type: object
            properties:
                any_payment_method_by_default:
                    type: boolean
                exception_payment_methods:
                    type: array
                    items:
                        type: string
            required:
              - any_payment_method_by_default
              - exception_payment_methods
            additionalProperties: false     
```

### Изменение API:


``` 
RoutestatsResponse:
    ...
    service_levels:
        items:
            properties:
            ...
                unsupported_requirements:
                    description: Множество неподдерживаемых требований
                    items:
                        description: название требования
                        type: string
                    type: array
            ...
        ...
    ...        
```

### Работа старых клиентов:
1. Будет настроен клиентский эксперимент route_additional_information_step, с помощью которого требование "термосумка"(а так же другие требования при необходимости) будет недоступно. Эксперимент будет смотреть на версию клиента, и если она старее X.X.X, то требование не будет показываться. Таким образом пользователь не сможет выбрать требование, которое будет зависеть от способа оплаты.
2. Опциональное поле "unsupported_requirements" никак использоваться не будет.
3. Логика с ошибкой "unsupported_requirement" останется та же.
4. Даже если пользователь как-то сможет выбрать требование, зависящее от способа оплаты, то тариф будет недоступен с  кодом "unsupported_requirements_for_payment_method" и соответствующим текстом, заказ будет невозможен, но кнопка "Сбросить недоступные требование" не появится.

Таким образом для поддержки старых клиентов особые доработки на бекенде не нужны.


###  Tickets:
1. TAXIBACKEND-30954 - разработка ограничения требования по способу оплаты [7 дней, с учетом рефакторинга backend-cpp]
