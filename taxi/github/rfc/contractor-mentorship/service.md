**Название сервиса**

contractor-mentorship

**Какую продуктовую проблему решает сервис?**

Сейчас программа наставничества находится в веб-форме. В связи с этим кол-во водителей проходящих программу очень мало. Хотим добавить новые точки входа в программу и расширить функционал:
1. Показывать всем водителям новичкам оффер на вступление в программу
2. Автоматически формировать заявку на участие в программе наставничества
3. Сообщать в чатах водителю о новых наставниках/новичках
4. Сообщать в чатах наставнику о промокодах за программу

**Почему нельзя решить эту задачу без разработки нового сервиса существующими решениями?**

На данный момент водитель с его личными данными заполняет форму на сайте и после этого crm матчит наставника и новичка.

Нужен отдельный сервис, который будет собирать водительские данные для матчинга и отдавать привественные водительские сообщения.
На клиент будем отдавать сматченных водителей, диплинк на вотсап, номер телефона, фио и сообщения

**Как именно сервис будет решать поставленные перед ним задачи?**

- Сервис собирает данные водителя и отправляет заявку на мэтчинг с наставником в yt crm. 
- Сервис хранит информацию о сматченных водителях и предоставляет наставнику и новичку контакты друг друга.

Сервис предоставляет:
  1. Водительскую ручку для получения списка новичков/наставников и сообщений по каждому контакту:
     1. Получает все связки park_id driver_id по переданному newbie_park_id newbie_driver_id(из БД) из driver-profiles новичка
     2. Получает все связки park_id driver_id по переданному mentor_park_id mentor_driver_id из driver-profiles наставника
     3. Возвращает запись из БД со статусом `initialized`, `in_progress`, `finished`, `succeed` с фильтром по park_id, driver_id наставника и новичка
     4. Получает информацию о роли и статусе участника в программе по park_id driver_id из БД
     5. Считает кол-во непрочитанных сообщений и составляет сообщения для каждого диалога
     6. Возвращает всех новчиков или наставников в зависимости от роли участника в программе и каунтер прочитанности
  2. Водительскую ручку прочитанности:
     1. Получает все связки park_id driver_id по переданному newbie_park_id newbie_driver_id(из БД) из driver-profiles новичка
     2. Получает все связки park_id driver_id по переданному mentor_park_id mentor_driver_id из driver-profiles наставника
     3. Обновляет `newbie_last_read_at` и `mentor_last_read_at` на now() в зависимости от роли участника
  3. Водительскую ручку для подтверждения участия в программе наставничества:
     1. Получает все связки park_id driver_id по переданному park_id driver_id из driver-profiles
     2. Проверяет создана ли уже запись в БД с данными связками
     3. Создаётся в базе запись с park_id, driver_id новичка и статусом `created`, если ещё не создана
  4. Идемпотентную stq-таску на формирование заявки в yt-crm, которая создаётся при запросе в ручку подтверждения участия в программе наставничества(см. п. 3):
     1. Получает все связки park_id driver_id по переданному park_id driver_id из driver-profiles
     2. Получает matching по полученным park_id driver_id из базы со статусом `created`. Если нет записей, то завершает работу.
     3. Асинхронно получает:
        1. город из trackstory(координаты) и geobase
        2. арендованная машина или своя из fleet-rent
        3. телефон из driver-profiles(phone_id) и personal
     4. Сохраняет полученные данные в ыте(пример таблицы: https://yt.yandex-team.ru/hahn/navigation?path=//home/taxi-crm/drivers/logs/DRIVERMARKETING-325/production/new_drivers_mentors_offer_accepted) по пути `//home/taxi/production/features/mentorship/new_drivers`
        1. Далее crm будет ходить в эту таблицу и делать матчинг в свою таблицу(см п. 6)
  5. Дистлок таску, импортирующию данные о матчинге водителей из yt-crm:
     1. Табличка: https://yt.yandex-team.ru/hahn/navigation?path=//home/taxi-crm/drivers/logs/DRIVERMARKETING-325/production/new_drivers_mentors_distribution
     2. Получает все записи в ыте, где connected_dttm > original_connected_dttm
     3. Получает по полученным park_id driver_id все park_id driver_id из driver-profiles
     4. Обновляет им статус на matched(tz = utc)
     5. Запускает stq-таски на отправку состояний каждого матчинга наставникам и новичкам (п. 5)
  6. Дистлок таску, импортирующие данные о прогрессе новичка из yt-crm:
     1. Табличка: https://yt.yandex-team.ru/hahn/navigation?path=//home/taxi-crm/drivers/logs/DRIVERMARKETING-325/production/results_to_send
     2. Получает все записи в БД новичков, срок участия в программе которых >= 7 (status=`initialized`) или >= 14 (status=`in_progress`) дней
     3. По полученным park_id, driver_id получает udid в driver-profiles
     4. Получает информацию о прогрессе новичков
     5. Заносит данные в таблицу `results`
     6. Запускает stq-таски на отправку состояний каждого матчинга наставникам (п. 5)
  7. Дистлок таску, завершающую программу наставничества:
     1. Пример таблички: https://yt.yandex-team.ru/hahn/navigation?path=//home/taxi/production/features/driver-promocodes/mentoring/finished_promocodes_to_add_TAXICRM-6689_2021-09-27
     2. Раз в сутки загружает все `entity_id`
     3. Всем водителям с park_id_driver_id = entity_id и status=`finished` запускает stq-таски на отправку состояния прохождения программы
     4. Всем водителям, срок которых участия в программе > 14 дней и status = 'final_notified' ставит статус = `failed`
  8. STQ-таску, отправляющая информацию о изменении состояния прохождение программы в client-events через балковую ручку:
     1. о новом матчинге - Переводит статус в `initialized`
     2. о промежуточном прогрессе - Переводит в статус `in_progress`
     3. об итоговом прогрессе - Переводит в статус `finished`
     4. о выданном промокоде - Переводит в статус `succeed`
  9. Репликацию в ыть и архивацию мэтчингов старше 3х месяцев после успешного прохождения
  
**Разрабатывается один сервис или система?**

Один сервис

**С кем взаимодействует сервис?**

- Yt-таблица crm для получения матчинга водителей
- Yt-таблица crm для создания заявки на матчинг водетелей
- Yt-таблица crm в ыте для получения новых промокодов
- Отправляет информацию о изменении состояния в client-events
- Сервис ходит за phone_id в driver-profiles 
- Сервис ходит за телефоном в personal
- Для получения gps ходит в trackstory и через geobase получает город
- Для получения ip последнего логина сервис ходит в yt, который реплицирует БД driver-login
- Сервис ходит за получением информации о аренде авто в fleet-rent

**Какие базы использует?**

Новая ydb dbcontractor_mentorship.

1. Быстрее вставка данных
2. Выгоднее при < 15 TPS
3. Удобнее в управлении(serverless)

**Какие периодические процессы?**

- Регулярный импорт новых матчингов в Yt-таблице crm
- Регулярный импорт данных о завершении программы из yt
- Регулярный импорт о процессе новичка из yt-crm

**Планируется обработка персональных данных**

- Номер телефона

**Какие данные и по какой схеме сервис будет хранить в базе?**

***matchings***

```javascript
{
	"id": <uuid>,
	"created_at": <timestamptz>,
	"matched_at": <timestamptz> nullable,	// datetime когда сматчили
	"mentor_park_id": <uuid> nullable,     // park_id ментора
	"mentor_driver_id": <uuid> nullable,     // driver_id ментора
	"newbie_park_id": <uuid>,     // park_id новичка
	"newbie_driver_id": <uuid>,     // park_id новичка
	"status" : <enum>       // (created, requested, matched, initialized, in_progress, finished, succeed, failed) - смысл ниже
    "mentor_promocode": <string> nullable       // промокод наставника
    "completed_at": <timestamptz> nullable,      // datetime выдали промокод и наставничество закончилось
    "original_connected_dttm": <timestamptz> nullable,        // datetime последней снихронизации с ытём, будет индекс
    "newbie_last_read_at": <timestamptz> nullable,       // время последнего чтения сообщения новичком
    "mentor_last_read_at": <timestamptz> nullable,       // время последнего чтения сообщения наставником
}
```

```
created - новичок запросил участие
requested - запрос отправлен в ыть
matched - новичок сматчен с наставником
initialized - новичок проинформирован о наставнике, а наставник о новичке
in_progress - наставник проинформирован о прогрессе новичка после 7 дней
finished - наставник проинформирован о завершении программы новичка после 14 дней
succeed - новичок успешно прошёл программу, через 21 день удаляется
failed - новичок неуспешно прошел программу, через 21 день удаляется
```

***status_transitions***

```javascript
{
	"id": <uuid>,
	"matchings_id": <uuid>    // FK на matchings
	"created_at": <timestamptz>,
	"from": <enum>,      // enum статуса, который сменили
	"to": <enum>,        // enum статуса, на который сменили
}
```

***results***

```javascript
{
     "newbie_driver_id": <uuid>,    // uuid newbie
     "newbie_park_id": <uuid>,     // dbid newbie
     "rate_avg_7d": string         // avg 7d rating
     "rate_avg_14d": string        // avg 14d rating
     "avg_dp_7d": string           // avg 7d activity
     "avg_dp_14d": string          // avg 14d activity
     "sh_7d": string               // avg 7d sh
     "sh_14d": string              // avg 14d sh
     "correct_answers": string     // correct answers for test
     "passed_test_flg": string     // test is passed
}
```

**Какой объем данных будет храниться и какой объем будет изменяться в единицу времени?**

Всего в базе будет храниться ~2-3 Гб данных

10 qps

**Какие операции над данными заложены?**

read, write, update

**Есть ли какой-то стейт в памяти, как он обновляется и валидируется?**

Нет

**Какая нагрузка ожидается?**

В пределах 10 rps

1. Заявка на участие в программе - 1-2 rps
2. Получение списка водителей наставников/новичков - 3-4 rps
3. Получение сообщений по водителю - 3-4 rps

**Какие фолбеки предусмотрены на сам этот сервис?**

- В Yandex.Pro: водитель не увидит список сообщений от новичков/наставников
- Для ытя: не будут создаваться заявки на матчинг

**Какие фолбеки предусмотрены внутри этого сервиса на взаимодействие с другими сервисами?**

Фолбеки внутри сервиса:

при отказе бд не создаётся запись в бд о матчинге и водитель не видит сообщения с матчингом в таксометре, но заявки создаются.

Внешние фолбеки:

- При отказе одного из driver-profiles, personal, driver-trackstory, fleet-rent - заявка создаваться не будет

**Какие возможности масштабируемости закладываются?**

Шардирование базы, увеличение количества инстансов сервиса, отложенная обработка некоторых запросов за счет добавления периодических или stq тасок

**Какие точки отказа есть в сервисе?**

1. Отказ бд
2. Отказ stq
3. Отказ ытя

**Укажите ключевые продуктовые метрики сервиса, за которыми планируете следить**

Количество новых запросов на участие в программе.

**Укажите технические метрики**

- Среднее время ответа на запрос
- Нагрузка на БД
- Время и успешность работы stq

**Какая функциональность ожидается в сервисе в будущем?**

1. Механизм матчинга водителей
2. Проверка на успешность прохождения программы и выдачи промокодов
3. Все, что связано с наставничеством

**Какое изменение нагрузки планируется?**

Прямо пропорционально количеству водителей в программе наставничества

**Активно ли будет изменяться сервис?**

Могут появляться новые требования к матчингу и заявкам на матчинг

**Комментарии**

1. Нужен будет ытевый робот на тестинг и прод для походов в таблицы crm и внесения записей в таблицу new_drivers
2. Если сменится алгоритм матчинга, то код менять не придётся, способ заливки останется тот же
