# yandex-taxi-conductor-helpers
Набор скриптов для автоматизации работы с кондуктором.
## Требования
* Дырка до https://c.yandex-team.ru
* ssh-доступ и sudo без пароля на все тестовые и боевые dom0-хосты
* python-jinja2
* python-requests
## Использование
### conductor_helper.py
Доступные опции:
```
usage: conductor_helper.py [-h] [--project PROJECT] --service SERVICE
                           [--l3abc L3ABC] [--no-http] [--https] [--external]
                           [--ipv4] [--no-stable-slb] [--no-testing-slb]
                           [--unstable-slb] [--no-prestable]
                           [--unstable-dc-num UNSTABLE_DC_NUM]
                           [--unstable-host-num UNSTABLE_HOST_NUM]
                           [--testing-dc-num TESTING_DC_NUM]
                           [--testing-host-num TESTING_HOST_NUM]
                           [--stable-dc-num STABLE_DC_NUM]
                           [--stable-host-num STABLE_HOST_NUM]
                           [--ostemplate OSTEMPLATE] [--rootsz ROOTSZ]
                           [--salt-version SALT_VERSION] [--ssd] [--debug]
                           [--dry-run] [--continue] [--im-feeling-lucky]
```

`--project` - проект в кондукторе, по умолчанию taxi
`--service` - имя поднимаемого сервиса, будет использоваться как префикс имени машин и суффикс имени группы (многословные стоит писать через дефис, в имени группы они будут заменены на подчеркивания)
`--l3abc` - проект, который использовать при создании балансера, по умолчанию vopstaxi
`--no-http` - не поднимать балансер на 80 порту
`--https` - поднять балансер на 443 порту
`--eexternal` - поднять балансер с внешними адресами
`--ipv4` - поднять балансер с в4-адресами
`--no-stable-slb` - не делать балансер над стейблом
`--no-testing-slb` - не делать балансер над тестингом
`--unstable-slb` - сделать балансер над анстейблом
`--no-prestable` - не создавать престейбл
`--unstable-dc-num` - количество датацентров в анстейбле, по умолчанию 1 (если 0, то анстейбл не будет создан)
`--unstable-host-num` - количество хостов в каждом датацентре в анстейбле, по умолчанию 1, если 0 (то анстейбл не будет создан)
`--testing-dc-num` - количество датацентров в тестиге, по умолчанию 2, если 0 (то тестинг не будет создан)
`--testing-host-num` - количество хостов в каждом датацентре в тестинге, по умолчанию 1 (если 0, то тестинг не будет создан)
`--stable-dc-num` - количество датацентров в стейбле, по умолчанию 3, если 0( то стейбл не будет создан)
`--stable-host-num` - количество хостов в каждом датацентре в стейбле, по умолчанию 1 (если 0, то стейбл не будет создан)
`--ostemplate` - шаблон с какой версией убунты использовать, по умолчанию trusty, может быть trusty и xenial (в lxctl create будет передано правильное имя в зависимости от сегмента и окружения)
`--rootsz` - размер корня, в том же формате, что и у lxctl, по умолчанию 100G
`--salt-version` - версия солта, которую накатить при настройке, по умолчанию 2018.3.0-yandex3
`--debug` - очень много дополнительного вывода. ОЧЕНЬ много.
`--ssd` - выбирать только хосты с SSD, по умолчанию выбираются только хосты с HDD
`--dry-run` - не выполнять никаких действий с побочными эффектами
`--continue` - не искать новые хосты, если с прошлого раза остался файлик с ними
`--im-feeling-lucky` - не спрашивать подтверждения при выборе dom0 и после создания групп в кондукторе

Если все пойдет хорошо, то произойдет следующее:
1. Скрипт соберет информацию о загруженности всех dom0 машин по ssh
2. Выберет наименее загруженные машины в наименее загруженных датацентрах
3. Предложит проверить, правильно ли все выбрано. На этом этапе данные будут сдамплены в файл, который надо будет поправить руками, если что-то пойдет не так. Важно не забыть поправить поле segment (l2 или l3), если у заменяемого хоста он отличается. От сегмента зависит то, как именно будет наливаться машина (в l2 требуется руками прописать днс, в l3 - надо запускать selfdns-client, а так же в разных сегментах используются разные темплейты).
4. Сгенерирует хосты
5. Если среди хостов есть те, которые будут наливаться в l2-сегменте, то продложит прописать их в днс.
6. Добавит хосты, группы и воркфлоу в кондуктор.
7. Пропишет ответственных в голем.
8. Предложит проверить все ли ок в кондукторе и големе. Лучше тщательно проверить, что все группы и хосты создались и у всех групп правильные родители. АПИ кондктора не очень стабильно и были прецеденты, когда отвечая 200 оно не добавляло родительские группы.
9. Запустит по ssh наливку всех машин.
10. Скрипт завершися, но наливка продолжится - успешность уже придется проверять вручную.
11. Будут созадны балансеры (по умолчанию - над стейблом и тестингом) через L3 API.

Предполгается:
* у сервиса есть все 4 окружения
* выкатка в стейбл невозможна без выкатки в престейбл
* в престейбле ровно одна машина
* престейбл-группа входит в стейбл

Так же при первом запуске скрипт попросит сходить за OAuth-токеном. После этого он будет лежить в `~/.config/conductor/oauth`.

## Выбор dom0
С каждой железки собирается несколько параметров:
* LoadAverage15 (la15)
* количество ядер (cpu_num)
* количество занятой памяти без учета кэшей (mem_nocache)
* количество памяти в сумме (mem_total)
* свободное место в vg00 (disk)

После этого высчитывается метрика загруженности:
1. Если disk < 200 гб, то загруженность считается +inf, поэтому хост выбывает из игры. Больше диск никак не влияет на выбор.
2. Высчитываем загрузку по памяти mem_load = mem_nocache / mem_total, что дает нам число от 0 до 1.
3. Загрузку по процессору считаем как cpu_load = la15 / cpu_num. Если cpu_load больше 1, то считаем загруженность равной +inf и хост опять же выбывает.
4. Представляем загрузку по памяти и процессору как координаты в двумерном пространстве и считаем длину вектора load = sqrt(mem_load^2 + cpu_load^2)

Кандидатами на заселение новых виртуалок будут хосты с наименьшей загруженностью в тех датацентрах, где сумма загруженности всех кандидатов наименьшая.

## Процесс наливки
На железку будет залит скрипт, который:
1. Сделает lxctl create с нужными параметрами в зависимости от сегмента и окружения (разные шаблоны в тестинге/анстейбле и стейбле, а так же в зависимости от того, l2 это сегмент или l3).
2. Если мы в l2 сегменте, то сделает lxctl conduct
3. Добавит файл setup.sh в корень виртуалки и добавит его запуск в rc.local, весь вывод будет литься в /setup.log (внутри виртуалки)
4. Запустит виртуалку.

После запуска виртуалки скрипт будет считать свою работу выполненной и дальше нужно будет ловить момент, когда виртуалка нальется до конца. Наливка делает следующее:
1. Дождется поднятия сети (в цикле пинг до днс-резолвера)
2. Если мы в l3-сегменте, то будет дернут selfdns-client
3. Убедится, что не запущен по какой либо причине apt
4. apt-get update
5. apt-get install файликов солта
6. Двухкратный salt-call state.highstate
7. agent.sh
8. И под конец скрипт удалит сам себя.