# PyMLaas
Репозиторий питоновской версии сервиса такси для применения моделей машинного обучения.

[Кто мы, что мы, какова наша цель в этом мире?](https://wiki.yandex-team.ru/taxi/ML/)

[Кто я, что я, для чего я живу?](https://wiki.yandex-team.ru/taxi/ML/youngfighter/)

[Где я, что это, зачем это, что мне с этим делать?](https://wiki.yandex-team.ru/taxi/ML/MLaas/)

## Свод правил репозитория и службы
1. **Общий подход по умолчанию** — так как мы ориентируемся на долгосрочную перспективу, то предполагается, что по умолчанию мы отдаём предпочтение общим решениям нежели частным. Это означает, что, например, если в процессе написания кода понадобилось реализовать какую-нибудь стандартную метрику качества регрессии, то сперва нужно поискать её реализацию в utils и только в случае её отсутствия нужно писать самому, затем перенести в utils, написав тесты и пройдя ревью, а не оставлять в своём проекте. *Тогда общий код будет развиваться и совершенствоваться (более оптимальные решения), также повышается вероятность найти баги, если они есть, и исправить их.*
2. **Системное решение проблем** — если что-то не работает надо починить системно, а не костылять под себя. Это касается нерабочего окружения, прокидывания ssh ключа, использования Нирваны, поднятия ручек на виртуалках и таргете, использования lfs и так далее. *Очень редко бывают персональные технические проблемы, как правило, одинаковые проблемы повторяются у разных людей, решая их системно и документируя подходы, мы облегчаем решения этих же проблем в будущем у других членов команды.*
3. **Ревью продакшн и общего кода** — всё, что будет работать в продакшене должно пройти ревью и быть в общем стиле. Это же касается общего кода, которым пользуются все пользователи репозитория (utils). *Помимо минимизации ошибок, обмена опытом и прокачки скиллов друг друга, мы упростим чтение кода. Умение сразу писать читабельный код упрощает написание проектов в долгосрочной перспективе (они сразу пишутся в хорошем дизайне, что упрощает написание экспериментов).*
4. **Репозиторий для кода** — все большие файлы с данными, бинарники и модели нужно хранить в YT/MDS/... Средние файлы (от 5 Mb до 50 Mb) можно также коммитить в lfs. Ноутбуки храним только в lfs. *Это влияет на производительность PyMLaaS World и любые другие checkout-ы репозитория. Блокнот это потенциально большой объект, который не влияет на работу либы, поэтому проще всегда держать его в lfs.*


## Development environment
Мы пишем код в Python 2 virtual environment с фиксированными версиями пакетов.
[Почитай о virtualenv](https://virtualenv.pypa.io/en/stable/userguide/#usage), иначе могут приключиться неловкие ситуации.

1. Добавьте public ssh key на github.yandex-team.ru в "Settings" -> "SSH and GPG keys"
2. Добавьте в `~/.ssh/config`
```
Host <some_name>
   Hostname <server_address>
   ForwardAgent yes
```
3. Добавьте приватный ключ в ssh-agent `ssh-add <path_to_your_private_ssh_key>` (на локальной машине)
4. Склонируйте репозиторий  и перейдите в него `cd <path_to_your_repo>`
5. Установите необходимые deb пакеты `sudo tools/setup-dev-env.sh`
6. Создайте virtual environment так `virtualenv <path_to_virtual_env>` или так `python -m virtualenv <path_to_virtual_env>`
7. Активируйте его `source <path_to_virtual_env>/bin/activate`
8. Обновите submodules `git submodule update --init`
9. Сконфигурируйте virtualenv, выполнив `sh tools/setup-dev-venv.sh`

## Правила репозитория
### git
#### pre-commit-hook
Чтобы обезопасить себя от хаоса, соблюдаем некоторые правила.
Ставим прекоммитный хук, на проверку размеров файлов (<10 mb) и корректности json и yaml:

```bash
git-pre-commit-hook install --plugin file_size --plugin json --plugin yaml
```

#### LFS

Для больших файлов используем [Git LFS](https://git-lfs.github.com).
Чтобы залить большой файл, нужно указать что его нужно отслеживать с помощью lfs:
```bash
git lfs track "my_big_file"
```

Вместо конкретного файла можно указать папку, или расширение/маску:
```bash
git lfs track 'assets/*'  # только один уровень
git lfs track "*.csv"
```

Некоторые расширения уже указаны в ```.gitattributes```.

Склонировать репозиторий без lfs файлов можно командой:
```bash
GIT_LFS_SKIP_SMUDGE=1  git clone https://github.yandex-team.ru/taxi/pymlaas.git
```
Вместо файлов будут тексты  с суммами и размером. Скачать файлы можно потом с помощью:
```bash
git lfs pull
```

#### Настройка .gitignore
В проектах у вас будут создаваться разные некоммитные файлы (датасеты, pkl, whl и так далее). 
**Коммитить их не нужно, даже в lfs**.
 
 Вы можете захотеть добавить их или некоторые папки в .gitignore.
 **Так тоже делать не надо :)** – ведь эти файлы специфичны именно для вашего клона репозитория, они не нужны в общем репозитории.
 
 Но игнорировать файлы/папки всё равно хочется, поэтому прописывайте их в файл ```.gitexcludes```, **но никогда не коммитьте этот файл**. Кстати, не забудьте выполнить ```git config --global core.excludesfile ~/.gitexcludes```.
 


## Локальный запуск pymlaas
1. Скачиваем ресурсы – `make download`
1. Запускаем pymlaas – `make run`

## Запуск в jupyter notebook
Прочитайте [здесь](https://anbasile.github.io/programming/2017/06/25/jupyter-venv/), но можно сделать так:
1. `source <path_to_virtual_env>/bin/activate`
2. `ipython kernel install --user --name=<kernel_name>`

## zoo
zoo – это папка под наши проекты и утиль, в ней мы будем хранить ВСЁ.

**Она не ревьюится РАЗРАБОТЧИКАМИ, но это не значит, что в неё можно всё подряд коммитить**.

Основная местная достопримечательность – zoo.utils,
здесь мы скапливаем все общие фичи и функциональность для дальнейшего переиспользования.

**zoo.utils ревьюится нашей командой, цель этого – эффективный и правильно работающий код в общем утиле**.

В zoo.examples есть различные примеры использования библиотек из утиля.

Также в zoo будут создаваться папки под проект, в которых вы можете писать любой код и которые по умолчанию ревьюиться не будут.
Но вы всегда можете попросить других поревьюить с целью проверки своего кода.

**Крайне рекомендуется делать ветки под фичи, а не проекты, как написано [здесь](https://wiki.yandex-team.ru/taxi/ML/MLaas/addnewhandle/#nachalorazrabotki)**.
Это упростит процесс катки сервиса в прод. И объяснение неаффектящих прод коммитов в релизном тикете.

## Несколько жизненных советов
1. Добавьте alias на активацию virtualenv в .bashrc – `alias pymlaas_env=source <path_to_virtual_env>/bin/activate`
1. В проектах делать project_config.py, который будет хранить все основные константы и, что более важно, реализовывать функцию `get_project_cluster`, используя `zoo.utils.nile_helpers`, учитывая все зависимости проекта. Например, как здесь __zoo/queue_etr/initial/project_config.py__
1. Если сломается pip, то переустановите его, выполнив `curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py && python get-pip.py --force-reinstall && rm get-pip.py`
1. Регулярно делайте rebase на upstream develop для поддержания актуального состояния кода утиля – `git fetch upstream develop && git rebase upstream/develop`. Но будьте внимательны, rebase может зафейлиться!
1. Не храните весь код в ноутбуках, выносите логику в питоновские скрипты. Приучить себя трудно, но код блокнотов упрощается, его легче будет понять другому человеку и, самое главное, будет проще потом настроить регулярный процесс, например, по обновлению модели или построение отчёта по качеству
1. **Не коммитьте пароли в репозиторий**. Если что-то такое нужно, сделайте по аналогии с __zoo.utils.mongo_helpers.py__
1. Держите в голове, что код скорее всего придётся [нирванизировать](https://wiki.yandex-team.ru/taxi/ML/Instrukcija-po-nirvanizacii-prodakshn-processa) и проектируйте функции и классы с учётом этого
1. Организовывайте папку проекта как пакет, чтобы можно было простым способом запускать скрипты на Нирване (об этом ниже)

## Обновление версий или добавление новых библиотек

Список библиотек вместе с версиями указывается в файлах `pymlaas/requirements.txt` и `zoo/requirements.txt` (соответственно зависимости pymlaas и zoo). Многие библиотеки зависят от других библиотек и устанавливают часто самую свежую версию, однако это ломает стабильность в нашем репозитории (версия конкретного коммита может перестать работать), поэтому мы фиксируем все ограничения на версии в `venv-constrainints.txt`.

Если вы добавляете новую библиотеку или поднимаете версию у старой, то необходимо обновить `venv-contraints.txt`. Есть два способа.

Первый способ.
1. Добавить в соответствующий `requirements.txt` новую библиотеку или исправить версию у существующей.
1. Установить виртуальное окружение с нуля. Если вы повышали версию, то у вас будут возникать конфликты с `venv-contraints.txt`, которые необходимо вручную исправить (если вы не уверены, что эти изменения ничего не сломают, можно спросить кого-нибудь ещё).
1. Обновить `venv-contraints.txt` с помощью скрипта `tools/update-venv-constraints.sh`.

Второй способ.
1. В развёрнутом и активированном окружении установить или обновить нужный вам пакет. Важно, чтобы никаких посторонних пакетов в виртуальном окружении не было установлено.
1. Обновить `venv-contraints.txt` с помощью скрипта `tools/update-venv-constraints.sh`.

В любом случае все изменения будут видны в pull-request. 

## Запуск на Нирване

[Workflow для примеров](https://nirvana.yandex-team.ru/flow/318c2d6b-c57e-4209-989a-6a93b3be7be3/graph). Не запускайте в этом workflow, если надо, копируйте к себе

Готовы первые версии кубиков и демонстрационных графов, которые позволяют запускать любые скрипты из этого репозитория на Нирване (с учётом всем зависимостей, автоматически, без регистрации и смс): [граф с локальными действиями](https://nirvana.yandex-team.ru/flow/408107e7-2d79-466b-97d8-2d1cf8c8560c/3fc165d3-107f-44c2-86ca-d56788559f4a/graph), [граф с хождением на Хан](https://nirvana.yandex-team.ru/flow/408107e7-2d79-466b-97d8-2d1cf8c8560c/7d6b9889-8f60-4bf8-bd26-518ee904abc5/graph)

Не видите разницы в графах? Вот в этом и фича!

**Важно**. Для больших процессов с Nile лучше использовать официальный кубик Nile. Особенно если нет зависимостей от сторонних библотек.

С вопросами по использованию кубика и запросами дополнительной функциональности обращайтесь к [Илье Ирхину](https://staff.yandex-team.ru/tylorn).

Альтернатива – не создавать PyMLaas World, а просто выкачивать репозиторий и подкладывать как архив с кодом в другие кубики.


## Сборка volume с системой для Nirvana
Для конфигурации deb пакетов в системе нужно собирать её образ. 
Для этого нужно воспользоваться [Sandbox](https://sandbox.yandex-team.ru).

Вот [пример сборки](https://sandbox.yandex-team.ru/task/275969168/view).
Нужно будет склонировать и заполнить owner-a и т.д. а в поле `Setup scripts URLs` указать путь до  `tools/build-sandbox-volume.sh` в своём репозитории.

Собранный архив нужно будет подкладывать как `job-volume` в кубик [Build pymlaas virtualenv
](https://nirvana.yandex-team.ru/operation/c294a132-284b-4f97-b8da-679f90e425db). 
 

## Python обёртки C++ кода
Используя PyBind11, можно вызывать C++ код из под питона. Это ускоряет работу кода и упрощает перенос в MLaas.

С вопросами по использованию обёрток обращайтесь к [Владу Воротилову](https://staff.yandex-team.ru/vladvo).

### TODOs
- [ ] On macOS boost.locale library compiled with iconv library, on Ubuntu with ICU. Both should use ICU.
- [ ] It's more convenient to link boost statically (simpler to send binaries to map operations on YT), but nobody have succeded in this for now.

### Install C++ dependencies
* Мы используем pybind11 для создание обёрток плюсовых классов, нужно получить актуальную версию этой библиотеки:
```bash
git submodule init
git submodule update
```

Далее нужно установить boost (Нужно скомпилить только system and locale libs):

**TODO** Написать зачем это нужно сделать

```bash
./bootstrap.sh --with-libraries=system,locale --prefix=/usr/local
./b2
sudo ./b2 install
```

### Build
Да Маке для сборки можно использовать CLion.
Для сборки мы используем cmake. Находясь в корне репозитория нужно выполнить:
* Release версия
```bash
mkdir Release
cd Release
cmake -DCMAKE_BUILD_TYPE=Release ..
make
```
* Debug версия
```bash
mkdir Debug
cd Debug
cmake -DCMAKE_BUILD_TYPE=Debug ..
make
```

Также можно находясь в корне репозитория сделать `make so-build` – создаст папку `cmake_build`, где соберёт всё в release mode.

Команда `make so-clean` удалит `cmake_build` и ВСЕ `*.so` в `zoo`. Поэтому не храните кастомные `*.so` в репозитории – кладите их в virtuaenv.


### Run
Для запуска просто импортируете нужный модуль

Для запуска в nile не забудьте указывать DevelopPackage

Example can be found here __zoo/suggest/cpp/tests/test.py__
* Compile your binaries
* Send all *.so files and DevelopPackage to operation.
```python
files = [
        nfl.TableFile(CITIES_PATH, 'cities'),
        nfl.DevelopPackage(ZOO_ROOT),
    ] + so_helper.get_all_remote_files()
```
* Set up your job to make so files accessible
```python
job = job.env(operations_environment=dict(LD_LIBRARY_PATH='.'))
```
* Import wrapper modules inside map operation
```python
@with_hints(files=files)
def dataset_mapper(records):
    from zoo.suggest.cpp import CandidatesExtractorCpp
    from zoo.suggest.cpp import FeaturesExtractorCpp
```
* Run
