**DEPRECATED**
**Этот плагин устарел. Используйте плагин pg.**

## Работа с плагином postgresql

Описываем в service.yaml свои БД:

```yaml
postgresql:
  databases:
      - name: test_database
        use_as_default: true
      - name: other_database
...
```

Примечание:

1. Одну из БД можно пометить как БД по умолчанию (`use_as_default`)
2. Если БД всего одна, то она и будет БД по умолчанию

Далее в коде в `context` у нас есть плагин: `context.postgresql`

Для того чтобы обратиться к БД код должен решить что ему нужно:

1. Название БД (если БД одна или нужна дефолтная - указывать не нужно)
2. Номер шарда (если шард один или нужен нулевой - указывать не нужно)
3. Тип соединения (если `master` - указывать не нужно)


**Важно**: Плагин запрещает использовать conn вне секции with.
Если попытаться, то будет выбрасывать исключение `RuntimeError`.

Итого для обращения к `master` дефолтной БД используем следующий код:

```python

async with context.postgresql() as conn:
    rows = await conn.fetch('SELECT * FROM table')

```

## Более редкие случаи

Если нужен шард или `slave`, то можем определить их:

```python
from taxi import pg

async with context.postgresql(shard=3, mode=pg.SyncSlave) as conn:
    rows = await conn.fetch('SELECT * FROM table')
```

Если нужна неосновная БД то можно передать её имя:


```python
from taxi import pg

async with context.postgresql(shard=3, mode=pg.Master, db='dbname') as conn:
    rows = await conn.fetch('SELECT * FROM table')
```

или

```python
from taxi import pg

async with context.postgresql.dbname(shard=3, mode=pg.Slave) as conn:
    rows = await conn.fetch('SELECT * FROM table')
```

## Opentracing события


1. Факт начала выборки соединения из пула отмечается событием
`database use connection`
2. Запрос `fetch` отмечается `database fetch`
3. Запрос без данных (execute) отмечается событием `database execute`
4. Транзакции отмечаются событием `database transaction`.

Во всех случаях в тегах присутствует `dbname` указывающий на БД.

Для запросов `fetch`, `execute` так же в тегах присутствует имя файла и строка
вызова.

Если потребуется написать враппер для `fetch`, `execute`, то для правильной
идентификации необходимо проинкрементировать принятый `framelevel` (по
умолчанию = 1) в этих функциях. Число - указывает на сколько надо подняться
по стеку до нужного места.


## Транзакции

Поддерживаются только with версия транзакций.

для использования нужно применить `async with` следующим образом:


```python
from taxi import pg

async with context.postgresql.dbname() as conn:
    async with conn.transaction():
        await conn.execute('DELETE * FROM table WHERE id = 123')
```

Любое исключение - откатывает транзакцию, в противном случае производится
коммит транзакции.



Любое исключение - откатывает транзакцию, в противном случае производится
коммит транзакции.



## Отладка

Когда Вы отлаживаете код в тестах - то иногда хочется видеть какой итоговый SQL
получился/выполняется и какой у него explain.

Плагин реагирует на переменную окружения `DEBUG_SQL`:

1. Если эта переменная установлена в какое-либо нераспознанное значение, то
все обращения к БД логгируются в stdout.
2. Можно более тонко управлять отладкой:

```DEBUG_SQL=stderr,explain,contains=BLA```

Ключевые слова в переменной окружения следующие:

* `stdout`, `stderr` - в какой поток направлять отадку
* `explain` - выводить не только запрос, но и его EXPLAIN
* `inline` - при выводе запроса подставлять переменные в запрос
  ($1 заменится реальным значением - удобно для того чтобы скопировать
  запрос и выполнить его далее руками на базе)
* `contains=text` - выводить отладку только по запросам, которые внутри себя
  содержат указанный текст (пометку). Удобно, если у Вас выполняется много
  запросов, а Вам надо понаблюдать только за одним.
