# Система тикетов сервиса найма

## Ещё одна тикетная система?

Решили назвать систему "тикетной", так как у заявок найма есть статусы и
метаинформация (впрочем, как у заказов Такси). Это единственно общее со
стартреком, жирой, зендеском и тому подобными системами.

Чем отличается:
- Это всё же специализированная база данных, без GUI и вообще без UI.
- Рассчитанная на создание тикетов роботами.



## Архитектура

### Требования к системе

150 * 10^6 тикетов в год. Сейчас некоторые статусы не сохраняются, хотя
было бы интересно для аналитики (быстрая проверка контакта скаутом).

Возможность разделения очередей по базам. Мы не хотим, чтобы один канал
влиял на другие. Например, чтобы роботы лендингов не влияли на
обрабатываемые вручную тикеты (скауты, операторы КЦ, и т.д.).


### Данные

Данные в системе делятся на пользовательские (тикеты в очередях со всей
метаинформацией и статистикой по очереди) и настройки (описание
воркфлоу, настройки очереди, и т.д.).

Данных с настройками мало (мегабайты), меняются редко. Клиенты держат
копию базы настроек в виде инкрементально обновляемого кэша. На практике
отставание кэша составляет 1-2 секунды, но гарантированное время
получение настроек самым последним клиентом - 100с (задаётся конфигом).
Эта гарантия требует выведения из эксплуатации (500 на ping) сервиса,
который не может получить настройки более 100с.

Пользовательские данные делятся на горячие (тикеты в работе и недавно
закрытые тикеты) и холодные. Холодный сторадж можно считать репликой
горячего, тикеты туда попадают с небольшой задержкой (балком по оплогу),
но даже после закрытия какое-то гарантированное время (определяется
настройками очереди) остаются в горячем сторадже, что можно использовать
для поисков по недавно закрытым тикетам.

Холодные данные шардированы по очереди и по дням (попадание тикета в
конкретную таблицу определяется временем создания, которое не меняется).
Данных в каждом шарде должно быть немного (до 10Гб вместе с единственным
индексом на id тикета).

Единственная быстрая операция по холодным данным  - поиск тикета по id,
для чего у каждой пары очередь+день известны границы (минимальный и
максимальный номерат тикетов в таблице, могут немного пересекаться), так
что поиск тикетов - это log(days, 2) плюс ещё один логарифмический поиск
внутри таблицы. Любые другие операции над холодными данными - это full
scan, то есть число таких операций ограничено, и эти операции потребуют
асинхронного апи для пользователей системы.

Горячие данные шардированы по очереди, их не может быть много (до 20Гб
вместе со всеми индексами). Для каждой очереди создаётся по две таблицы
гарантированно в одной базе для атомарности операций, одна таблица для
статусов и интерпретируемой метаинформации (индексируется, используется
в поисках), другая - для неинтерпретируемой.

Интерпретируемая метаинформация ограничена целыми int64 и строками
длиной до 128байт. Система поисковых запросов по метаинформации
ограничена операциями равенства (`a == 1 AND b == '123'`).

Для специализированных поисков (по старым закрытыми тикетам, для
нечётки поисков, и т.д.) нужно строить внешние индексы, которые можно
наполнять по oplog-у.

Если вдруг данных в одной очереди станет много, предложим заказчикам
подумать (это какой-то супер странный кейс для тикетной системы). Если
всё же захотят, пошардируем по id. Для холодных данных проще, добавим
информацию по числу шардов для дневной таблицы. Для горячих в настройки
очереди попадёт число шардов, шард будет определяться по номеру тикета,
номер тикета - при создании nonce (то есть возможны пропуски в номерах
тикетов), а поиски склеим на клиенте базы (то есть будут прозрачными для
клиента системы).


### СУБД

Пока все данные хранятся в одном постгресе в разных таблицах.

Целевая картина:
* 2-3 отдельных небольших быстрых базы:
  * Отдельная база для настроек, так как это единая точка отказа. В этой
    же базе будут храниться настройки шардирования горячих данных.
  * Будет видно, стоит ли разделять на две базы:
    * Данные по холодным шардам. Данных немного, но диапазоны тикетов в
      шарде будут обновляться часто.
    * Данные по медленным операциям, требующим асинхронного апи. Данных
      опять же немного, но будут часто поллиться на предмет готовности.
* Кластер для холодных данных на медленных sata-дисках. Шард кластера -
  отдельная база размером ~10Гб. Это может быть как часть данных по
  одному дню большой очереди, так и несколько дней нескольких небольших
  очередей.
* Кластер для горячих данных. Шард кластера - отдельная база размером
  ~20Гб, что опять же может быть шардом большой очереди или же
  несколькими шардами небольших очередей.



## FIXME



## TODO

1. Аналитика по эффективности использования индексов.
  - Собирать и визуализировать статистику по используемым индексам.
  - Предупреждать о неэффективном использовании индексов.
2. Научиться выделять квоты.
  - Объём горячих и холодных данных.
  - Число CRUD операций.
3. Научиться строить индексы автоматически.


## Про апи

```
    get_nonce_to_create_ticket:
        ---
        200 OK + nonce

    create_ticket:
        nonce: <none>
        queue: <queue>
        meta:
            block1: <block1>
            block1: <block2>
        indexed_meta:
            field1: value1
            field2: value2
        ---
        200 OK + ticket_id
        400 no queue
        409 invalid nonce

    update_ticket:
        expected:
            meta.block1 version: 11
            meta.block2 exists: false
            ticket.status: status5
            ticket.resolution: ???
            ticket.version: 4
        set:
            meta.block1: <new block>
            status: <new status>
            queue: <new queue>
        unset:
            resolution
            meta.block3
        ---
        200 OK + {version: {status: 1, meta.block1: 2, ...}}
        409 bad versions + [would be nice] unmet conitions info

    find_tickets:
        query:
            queue: <queue>
            status: <status>
            resolution_status: <resolved | noresolution | any=default>
            resolution: <resolution code>
            ticket_id: ticket_id
        projection:

    oplog:
        last_known_opid: 1
        max_ops: 100
        filter: tickets
        ---
        200 OK + x-polling-delay + [(op1, diff), (op2, diff), ...]
```


## pg

```
tickets:
    id | queues_id | status | resolution

tickets_meta:
    id | tickets_id | meta_name | meta_data | revision

workflow:
    graph:
        status1 -> [
            status2,
            status3 + resolution,
            status4 - resolution,
        ]
        status2 -> [status1, status4]
        ...
    terminal_statuses:
        status5:
            resolutions: fixed, ...
    indexes:
        indexed_field1_num:
            name: <name>
        ...
        indexed_field5_num:
            name: <name>
        indexed_field1_str:
            name: <name>
        ...
        indexed_field5_str:
            name: <name>
```

## Консольный клиент

Для ручных операций можно использовать консольного клиента. Он предоставляет
простой интерфейс к API сервиса. Клиент назодится в папке скриптов внутри
самого проекта: `hiring-st/scripts/client.py`.
На все запросы клиент показывает запрашиваемый адрес, HTTP коды ответов,
и тело ответа в виде json.
По умолчанию используется `unstable` окружение. Но его можно менять с помощью
параметра `--env` или задавать имя хоста напрямую через параметр `--host`.

### Примеры использования клиента

Посмотреть справку по операциям:

```
$ hiring-st/scripts/client.py --help
```

Получение очереди по ее идентификатору:

```
$ hiring-st/scripts/client.py --queue hiring/www/lids
http://hiring-st.taxi.dev.yandex.net/v1/queue
200 OK
{'created_ts': 1562000344,
 'description': 'Лиды с сайтов поиска работы',
 'meta': {'fields': [{'deprecated': False, 'field': 'source', 'type': 'string'},
                     {'deprecated': False, 'field': 'phone', 'type': 'string'},
                     {'deprecated': False,
                      'field': 'firstname',
                      'type': 'string'},
                     {'deprecated': False,
                      'field': 'lastname',
                      'type': 'string'},
                     {'deprecated': False,
                      'field': 'middlename',
                      'type': 'string'},
                     {'deprecated': False, 'field': 'city', 'type': 'string'},
                     {'deprecated': False, 'field': 'age', 'type': 'integer'},
                     {'deprecated': False,
                      'field': 'profession',
                      'type': 'string'},
                     {'deprecated': False, 'field': 'payment', 'type': 'float'},
                     {'deprecated': False, 'field': 'sex', 'type': 'string'},
                     {'deprecated': False,
                      'field': 'driver_license',
                      'type': 'string'}]},
 'queue_id': 'hiring/www/lids',
 'revision': 7,
 'updated_ts': 1562146745,
 'workflow_id': 'hiring/www/lids/v1'}
```
