## Сверки
Для Postgres и MySQL доступна сверка первоисточника с документами в YT, для
Mongo - сверка первоисточника с очередью репликации.

При сверке Postgres и MySQL по правилу, описанному ниже, из первоисточника вычитываются все документы
за определенное временное окно, прогоняются через (пре)мапперы и сравниваются
c документами на YT, соответствующими им по первичному ключу (ключевым колонкам в терминах YT).

При сверке Mongo хэши документов первоисточника сравниваются с хэшами документов в очереди репликации (подробнее ниже).

### Настройка сверки

Для того, чтобы сверка заработала, необходимо:

1. (только для Postgres/MySQL). Заполнить ключ `verification_settings` в разделе `destinations` правила репликации
по описанному там формату.

2. В разделе {{ description_replication_admin }} нажать кнопку создания драфта (**edit/изменить**)
в появившемся выпадающем поле выбрать **инструмент** (**tool**) **verification**.

3. В **target_names** будут отображены те таргеты, для которых настроена сверка в коде. Сейчас доступны два типа сверок:
       * Postgres/MySQL <--> YT. В админке такие типы сверок будут доступны после настройки правила по пункту 1 и выкатки измененного правила.
         Такие сверки проводятся путем выгрузки данных из базы за указанный период, которые сравниваются с документами YT.
       * Mongo <--> Mongo Queue. В админке такие типы сверок доступны автоматически, и проводятся путем сверки хэшей BSON'ов документов
         монги с хэшами BSON'ов документов в очереди репликации. В случае несоответствия хэшей документы еще раз сравниваются явно в виде словарей.
   Выберите нужный тип таргета в **target_names**. Сверку Mongo <--> Mongo Queue можно отличить по префиксу **staging_** в таргете, все остальные
   варианты включают сверку с YT.

4. В **action** надо выбрать действие, которое требуется совершить со стейтом сверки. Действия аналогичны действиям
над стейтами репликации. При **init** стейт инициализируется, при **enable/disable** - включается/выключается, при **remove** - стейт
сбрасывается (информация об ошибках сверки при этом удаляется).

### Диагностика ошибок сверки и их починка

Для оперативной диагностики на машинках генерируются monrun-алерты по группам ответственных за правила репликации, на
которые можно подписаться через juggler. Темплейт monrun-алерта - **replication-{responsible}-verification**.
Подробнее об этом можно прочитать в [разделе](#responsible) документации про ответственные команды.

В juggler-алертах предоставлена агрегированная информация о количестве ошибок в сверке. Явно ошибки можно посмотреть,
кликнув на сверяемый таргет в админке репликации. Откроется мини-окно с JSON-ом, где в `verification` -> `fails` можно
будет увидеть все ошибки сверки в развернутом виде.

При слишком большом количестве ошибок сверки процесс сверки останавливается. В таком случае необходимо
починить все ошибки на источнике и сделать реинит стейта сверки через админку (remove->init). В таком случае
все предыдущие ошибки сбросятся.
