# YT RAW
**RAW данные** - это данные из источника с минимальными преобразованиями.
[Подробнее про определение](https://wiki.yandex-team.ru/dmp/architecture/data-layers/raw/).
В этом формате мы храним данные в техническом **YT** слое. Зачем это нужно:

* В **RAW** будут все данные as is по ключу, то есть автоматически попадут все новые колонки
* **RAW** автоматически становится источником для перестроения других таблиц
  (драфты в админке: **yt_ctl -> build_struct/initialize_columns**)
* Все будущие объекты для аналитики (dwh) будут использовать сырые слои
* **YT RAW History** - аналог обычного **YT RAW**, является [историей изменений](yt_raw_history.md)

## Куда пишется
Пишется в YT, типичный путь вида: `//home/{project}/../raw/../{table}`.

## Типы
- Инкремент:
  - обновление раз в N минут
  - динамические таблицы в YT, возможно, партицированные по годам, месяцам или дням
  - нужно поле created_at/updated_at на источнике и индекс по нему
  - если на источнике есть удаления, часть данных может терять актуальность
- Снапшот:
  - обновление раз в сутки или по расписанию
  - статические таблицы в YT
  - полная перевыгрузка с подменой таблицы, подхватывает удалаления данных, индекс не нужен
  - не стоит так выгружать таблицы размера более 5-10Мб

## Схема данных
- **primary key**, возможно композитный, как на источнике (чтобы не происходило дедупликации)
- колонка с именем **doc** хранящая все данные с источника "как есть"
- колонка с именем **etl_updated** хранит время записи в YT данной строки

Вот так выглядит типичный raw слой в YT:

![RAW](_images/yt_raw_example.png "YT RAW")

Здесь `order_id`, `point_id` - композитный **primary key** из источника,
а **doc** хранит все данный в yson формате. При этом такие данные как даты, Decimal и
прочие неподдерживаемые yson типы будут храниться как yson-объекты с мета-атрибутами. Последнее позволяет работать в
YQL с полем `doc.created_ts` как с простой строкой, но при этом остается возможность узнать, что на источнике это была дата.

## Описание в правилах

### $raw
Данный маппер предназначен для создания т.н. таблиц "сырого слоя" (
документ из БД для всех источников сохраняется as is как YSON-объект на YT,
при этом в атрибутах значений указывается исходный тип данных в том случае, если тип
нативно не поддерживается YT, к примеру `bit` из постгреса или `datetime.datetime` из питона).

Пример raw-таблицы в yt: [ссылка]({{ link_to_raw_yt_example }})

Пример правила с $raw маппером: [ссылка]({{ link_to_raw_rule_example }})

Настройки в секции `target` правила репликации у этого мапперы следующие:

* `raw_settings` *required* — секция настроек маппера.
    * `yt_columns_info` *required* — поле для описания колонок в YT-таблице с raw даннымми.
       Здесь должны указываться только те поля, которые входят в первичный ключ в источнике + партицирующая
       колонка, если для таргета настроено партицирование.
        * `name` *required* — имя колонки в YT-таблице.
        * `type` *required* — тип колонки в YT-таблице.
        * `sort_order` - указать `ascending`, если колонка должна входить в ключ на YT
        (обычно совпадает с primary key источника, но бывают исключения)
        * `description` - описание колонки в YT-таблиц
        * `cast` — алиас функции, которая будет использоваться для обработки
        колонки. См. доступные функции в секции [мапперы](mappers.md#rabota-s-mapperami)
        * `input_column` — имя входной колонки, если оно отличается от имени колонки на YT.
        * `input_transform` — алиас функции, которая принимает на вход документ целиком и отдает
         единственное значение. См. подробное описание в секции [мапперы](mappers.md#rabota-s-mapperami)
        * `expression` - техническое пол, указывать не обязательно. См. подробное описание в секции [yt-таргета](yt_target.md#strukturirovannyj-sloj-yt-targets//tableyaml)
    * `description` — опциональное поле, позволяющее указать описание таблицы на YT. Если оно не указано,
    описание будет сгенерировано автоматически.
    * `raw_column_name` — опциональное поле, позволяющее указать имя колонки с документами в
    "сыром виде" (YSON-объект с типами источника). По дефолту - `doc`.
    * `pre_map_funcs` - опциональное поле для добавления дополнительных премапперов.
    * `partitioning` - см. описание `partitioning` для [yt-таргета](yt_target.md#strukturirovannyj-sloj-yt-targets//tableyaml).
    * `yt_attributes` - опциональное поле для передачи дополнительных параметров
      (см. описание атрибутов для [yt-таргета](yt_target.md#strukturirovannyj-sloj-yt-targets//tableyaml) - все, кроме `schema`).
      Например, для снэпшотов можно передать `dynamic: false`.

### Персональные данные в raw {#personal}
1. Если вы пишите в raw слой персональные данные, то правильнее всего хранить их одним из следующих способов:
   - Если источник внутренний (в контуре Яндекса), то стоит перейти на хранение [Personal ID](https://wiki.yandex-team.ru/taxi/backend/architecture/personaldataservice/) в самой базе с помощью сервиса `personal`.
   - Если источник внешний, то реплицировать нужно по API (прямой пуш в очередь репликации). В yaml файле с правилом нужно будет добавить `plugin_parameters` для интеграции с сервисом `personal`, подробнее [тут](../../sources/internal/api.md)).
2. При необходимости завести таблицу, в которой приватные данные будут лежать в открытом виде, нужно ограничить доступ до папок с этими таблицами через ACL YT.
3. Также можно с помощью [премапперов](mappers.md) отфильтровать приватные данные и реплицировать без них. Информация об этих данных будет утеряна, так что в этом случае лучше иметь 2 вида правила: с персональными данными и без.

### Таймзоны
Для postresql таймзона - это специфика того, как драйвер читает данные и фактически это просто сдвиг от UTC.
То есть на уровне драйвера можно задать другую таймзону и она станет иначе отображаться.
Поэтому в RAW формате мы храним все даты в виде строк в UTC.
При этом в базе все же рекомендуется хранить данные с таймзоной,
подробнее: [timestamp-vs-timestamptz](https://wiki.yandex-team.ru/taxi/backend/userver/postgres/timestamp-vs-timestamptz/).

### $bson
Данный маппер предназначен для создания таблиц на YT, содержащих данные в сыром
bson-формате (доступно только для типа источника `mongo`). Настройки в секции `target`
правила репликации у этого мапперы следующие (настройки опциональны, можно указать
в таргете `mapper: $bson` и все нужное сгенерируется с дефолтными значениями):

* `bson_settings` — секция настроек маппера (опционально).
    * `id_column` — опциональное поле для описания id-колонки.
        * `cast` — алиас функции для обработки id-колонки.
        Каст должен обращать выходную колонку в строку.
        * `input_column` — имя входной колонки, см. в `columns` выше.
        * `output_column` — результирующее имя колонки в BSON-таблице.
    * `hash_column` — опциональное поле для описания колонки c хэшом документа.
        * `use` — должна ли быть колонка с хэшом в получившемся документе, `false` по умолчанию.
