## Ответственность за правила репликации
За каждую группу правил нужно указать ответственных.
Первая команда в списке ответственных в `plugins/config.yaml` за группу правил будет
являться владельцами правил, и будет иметь права
на ОКи драфтов (но этого не достаточно, проверьте, что выпонен 3-й пункт), а также должна мониторить свои правила самостоятельно.
Остальные прописанные команды будут влиять только на мониторинги.
Если мониторинги не настроить, то остается вероятность, что **никто не узнает**,
что конкретно ваше правило перестало работать.
В админке можно
[отфильтровать все правила по ответственным]({{ link_to_admin_responsible }}).

Что нужно для этого сделать:

1. Прописать нужную группу в yaml, ключ `responsible`.
[Пример в коде]({{ link_to_responsible_yaml }}).
Для этого нужно либо найти группу в конфиге
[**DEV_TEAMS**]({{ link_to_dev_teams_config }}),
либо добавить туда новую и попросить ответственных менеджеров одобрить драфт.
В [тестинге]({{ link_to_dev_teams_config_testing }})
этот конфиг можно не трогать, если вам не будут нужны мониторинги в тестинге.
2. После [выкатки правил](deploy.md) при наличии команды в конфиге **DEV_TEAMS**
будут сгенерированы monrun-алерты, на которые можно подписаться через
juggler-генератор.
Алерты будут генерироваться на машинках %%taxi_replication_tasks.
[Текущие алерты]({{ link_to_responsible_juggler_cfg_repo }}).
Пример [pull-request]({{ link_to_responsible_juggler_alert_pr }})
в juggler-генератор, тут можно настроить уведомления в telegram или startrack,
[подробнее]({{ link_to_wiki_juggler_generator }}),
ревью просить в [чате репликации]({{ link_to_replication_telegram_chat }}).
Нужные имена алертов будут соответствовать следующим шаблонам,
вместо {responsible} будет ваша команда:

    * **replication-{responsible}-delay** - этот алерт про то, насколько давно не было
    успешных запусков репликации. Проблемы, по которым их может не стать бывают разные,
    в общем случае нужно открыть админку и проверить логи проблемных правил.
    Если самостоятельно разобраться не удастся,
    стоит обратиться в чат поддержки репликации со всеми ссылками и результатами
    проделанной самодиагностики.
    Если вам будет казаться, что мониторинг часто включается не по делу, стоит
    обратиться в чатик, мы работаем над уменьшением ложных срабатываний.
    Как погасить алерт (выключив таргет) на время:
    [пример драфта]({{ link_to_alert_downtime_draft_example }}).

    * **replication-{responsible}-verification** - это алерт об ошибках [сверки](verification.md).
    Если вы не пользуетесь сверками, подписываться на него не надо.

    * **replication-{responsible}-invalid-docs** - это алерт о [невалидных документах](invalid_docs.md).

3. После того как вы начнете получать уведомления об алертах, стоит настроить
возможность ставить аппрувы для своей команды. Возможно, права на ОКи у вас уже
есть, это можно проверить создав пробный драфт в проде.
В общем случае доступы запрашиваются через тикет,
[форма для создания]({{ link_to_approve_drafts_access_create_ticket }}).
В тикете стоит указать ответственных и имя команды из конфига **DEV_TEAMS**.
Что стоит знать при аппруве драфтов:
    * {{ admin_alert_message }})
    * [Общая информация](drafts.md)
4. Можно также настроить алерты, которые будут измерять отставание репликации от `now`. 
Для этого обратитесь в [чат поддержки]({{ link_to_replication_telegram_chat }}) репликации.
Не забудьте уточнить имя правила.

## Как смотреть пулл-реквесты правил репликации {#review-pull-requests}

1. Источники
    1. Имена правил должны быть полностью самостоятельными:
    по имени должно быть понятно, что это такое.
    Хорошей практикой будет добавлять префиксом к имени правила имя папки с группой
    правил, в которой оно лежит (если это ничему не противоречит).
    2. Проверить, был ли объявлен этот источник ранее, в каком-либо
    другом правиле. Если источник объявлен как снашпот, нужно убедиться,
    что рост данных в нём будет чем-то физически ограничен.
    Проверить, что правильно указаны ключевые колонки, а также
    тип колонки с датой, по которой идёт итерация.
    3. Если источник объявлен впервые и имеет тип postgres или mysql,
    необходимо добавить raw-таргет: [информация]({{ link_to_raw_doc }}).

2. При объявлении новых YT таргетов:
    1. Убедиться что колонки sort_order совпадают с ключевыми колонками
    источника, либо содержатся как подмножество.
    2. Убедиться что пути, по которым лежат данные — правильные.
        1. Соответствует ли префикс проекту.
        2. Соответствует ли путь [нормам]({{ link_to_yt_wiki_choose_path }}),
        принятым в YT для проекта.
        3. Нет ли приватных данных в этом таргете? Если есть, то
        нужно либо выбрать private директорию,
        либо позаботиться о том, чтобы ограничить доступы к своим нодам,
        либо не реплицировать какие-то конкретные колонки.

3. Если в PR'е происходит что-то "нестандартное", либо затрагиваются крупные
коллекции (вроде заказов такси), либо у вас просто не хватает экспертизы
в сервисе, то ревью стоит пройти в
[чатике репликации]({{ link_to_replication_telegram_chat }}).
