# Драфты репликации
- Драфты позволяют сделать все базовые изменения для ваших правил, будь то включение правил или перестроение YT таблиц
- Часть базового функционала
  ([копирование/перемещение YT таблиц](https://wiki.yandex-team.ru/taxi/backend/datastorage/kak-rabotat-s-yt/#obshhieinstrumentydljarabotysyt))
  остается на скриптах
- [Получение прав и алерты](responsible.md)
- В тестинге можно окать свой драфт самому себе
**Как создать драфт**
1. Открываем админку {{ description_replication_admin }}
2. Переходим на вашу группу правил
3. Слева внизу кнопка "Изменить". Все фильтры, что вы применете ранее, повлияют только на отображение правил

## change_state
Первый тип драфта: будет выбран по умолчанию. Останется выбрать действие (**action**) и нужные таргеты ниже.

![Изменение состояния правил](_images/draft_change_state.png "Изменение состояния правил" =420x320)

### init
  - первое включение, для **not_initialized** таргетов
  - [Опционально] **initial stamp** - начальная дата иницализации в местном времени. Всё ранее этой даты будет пропущено.
    Также, в случае если выбрана репликация вида **source->queue_mongo**, предварительно будет очищена очередь.
    **Для таргетов ИЗ queue_mongo** (колонка "тип источника") учтите, что в очереди всего лишь малая часть данных,
    в отличии от первоисточника правила
  - [Опционально] **target_unit_ids** - указываем нужные YT  кластера явно, если нужно включить только конкретные. При этом все остальные не подпадающие под условия таргеты будут зафильтрованы. Это может быть полезно в случаях, если хочется проверить правила, например, в тестинге, а ресурсов на всех кластерах на это нет.

### remove
- удаление состояний, репликация отключается без сохранения состояния, можно вызывать всегда
- для "тип таргета" **queue_mongo** (и только для него) при наличии флажка **drop_queue** - будет полностью обнулена очередь.
  Есть риск потерять часть данных, если они еще не были отреплицированы.
  Можно смотреть на графиках по **unreplicated docs**,
  можно предварительно сделать **disable** и подождать, пока не будет **unreplicated docs = 0**
### enable
- возобновление репликации, доступно только для **disabled** таргетов
### disable
- временная пауза, доступно только для **enabled** таргетов (для полной остановки используйте **remove**)
- очередь будет копиться, а через несколько дней придет алерт, что таргет выключен слишком долго
### disable_and_schedule_enable
- временное выключение. Укажите дату включение в местном времени, но не ранее чем через 10 минут после активации драфта
- [пример](https://tariff-editor.taxi.yandex-team.ru/replications/draft/412542).
  В поле **event_id** - произвольный набор английский символов без пробелов. [Тикет на упрощение](https://st.yandex-team.ru/TAXIDATA-3402)

## yt_ctl
### add_columns
Для небольших групп правил можно выставить в `plugins/config.yaml` параметр и тогда этот драфт **не нужен**
(но только если у вас нет других конфликтов по колонкам в yt/yaml-правиле):
```
yt:
      auto_add_columns: true
```
Операция добавления колонок легкая, а обратная вызывает длительный **map-reduce**, в некоторых случаях колонки нужно добавить руками, драфтом (**например, для заказов такси**).
Добавлять колонки можно **только для структурированных слоев** (для которых явно описан yaml с колонками), для сырых (RAW, BSON) это делать нельзя.

- [пример](https://tariff-editor.taxi.yandex-team.ru/replications/draft/358049)
- новые колонки нужно добавить в таблицы **до** выкатки кода

### sync_table
Копирование таблиц между кластерами.
Как работает:
- На время операции останавливается репликация из очереди (руками запись в источник при этом можно не останавливать)
- Мы отмонтируем все таблицы, мерджим в статические и через Transfer Manager копируем на нужные кластера во временные таблицы
- Делаем дополнительный мердж на каждом кластере, чтобы чанки таблиц были готовы стать [динамическими](https://yt.yandex-team.ru/docs/description/dynamic_tables/dynamic_tables_mapreduce#convert_table)
- Подменяем таблицы и включаем репликацию

Какие есть настройки:
- ставим флажок **full_sync**, чтобы взять атрибуты из yaml. **[!]** Это поможет, если вы меняли колонку хеширования или ключи сортировки. В этом случае кастомные параметры слетят к дефолтным из yaml
- можно ставить **full_sync** и **yt_base_cluster** (источник) = **yt_clusters**, в этом случае будет просто перестроение таблицы по yaml

### build_struct
Полное перестроение таблицы из **RAW** или **BSON** слоя сырых данных.
Не будет работать только для eternal мода партиций в таблице-назначении.

Как работает:
- На время операции останавливается репликация из очереди в данные таблицы (запись в источник при этом можно не останавливать)
- Выполняется freeze на YT таблиц **RAW** (или **BSON**), чтобы подтянулись все unflushed данные для мап-редьюса и сразу unfreeze
- Если нужно, таблица-назначение для перестроения колонки копируется на кластер с **RAW**
- На кластере с **RAW** запускается мап-редьюс, для полного перерасчета таблиц
- После расчета таблицы будут последовательно подменены и примонтированы на каждом кластере. Даунтайм будет только на этот момент (секунды для каждого кластера)
- В самом конце включается репликация в исходную таблицу

[Пример драфта](https://tariff-editor.taxi.yandex-team.ru/replications/draft/424957)

При создании драфта необходимо указать base_table_yt_cluster - это кластер YT,
который будет являться источником данных для перестроения.

Какие есть настройки:
- **yt_clusters** - про кластера выходных таблицы, таблица источник берется произвольно
- выбираем таргеты для перестроения внизу (только те, что нужно перестроить), **raw_rebuild_path** указываем только если не указано **raw_rebuild_data** в правиле в yaml
- **ignore_duplicates** - позволяет игнорировать дубликаты ключей на выходе маппера. Без флажка
  скрипт будет падать при наличии дубликатов.
- правило до применения драфта может быть выключено или включено, RAW слой должен быть включен

### initialize_columns
Пересторение конкретных колонок по **RAW** или **BSON** слою сырых данных.
Абсолютно все **не null** поля и ошибки маппера будут пропущены (всегда останутся старые значения, их не трогаем).

Как работает:
- На время операции останавливается репликация из очереди в данные таблицы (запись в источник при этом можно не останавливать)
- Выполняется freeze на YT таблиц **RAW** (или **BSON**), чтобы подтянулись все unflushed данные для мап-редьюса и сразу unfreeze
- Если нужно, таблица-назначение для перестроения колонки копируется на кластер с **RAW**
- На кластере с **RAW** запускается мап-редьюс, для расчета новых значений колонок
- Если выставлен **do_insert_rows** - будет выполнено insert_rows во все кластера таблицы для пересчета колонки. С флагом update=True, то есть старые значения останутся какими были.
- Если не выставлен **do_insert_rows**, то после расчета таблицы будут последовательно подменены и примонтированы на каждом кластере. Даунтайм будет только на этот момент (секунды для каждого кластера). Старые значения колонок при этом останутся какими были.
- В самом конце включается репликация в исходную таблицу

[Пример драфта](https://tariff-editor.taxi.tst.yandex-team.ru/replications/draft/606136)

При создании драфта необходимо указать base_table_yt_cluster - это кластер YT,
который будет являться источником данных для инициализации.

Какие есть настройки:
- **yt_clusters** - про кластера выходных таблицы, таблица источник берется произвольно
- выбираем таргеты для перестроения внизу, **raw_rebuild_path** указываем только если не указано **raw_rebuild_data** в правиле в yaml
- **do_insert_rows** - ставим, если изменных записей не более 30.000.000 (иначе скрипт упадет). Без флажка будут подменены итоговые таблицы

Если таблица пишется из разных источников (partial_update)
При перестроении нужно выбирать [таргет] связанный с [источником] у которого есть [колонки, мапящиеся из этого источника].
То есть выбор таргета в нужном правиле повлияет на выбор источника.

## yt_remove
- выбираем нужные yt таргеты для удаления таблиц
- ставим **recursive**, если таблица партицирована
- правильный порядок действий:
  - **change_state** -> **remove** на нужные yt таргеты, чтобы не пришли алерты и кроны не падали
  - **yt_remove** на нужные yt таргеты
  - `опционально` **change_state** -> **init** на нужные yt таргеты, чтобы новые таблицы создались

## invalid_docs
[Читать здесь](invalid_docs.md)

## verification
[Читать здесь](verification.md)

## deploy_sandbox_resources
Релиз правил. Вызывается только из вкладки "Все группы". Явно вызывать не нужно (создаст робот при релизе).
[Подробнее](deploy.md)
