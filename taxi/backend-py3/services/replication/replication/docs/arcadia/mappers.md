## Работа с мапперами

{% note warning %}

[Сырые слои данных](generated-targets.md) имеют автогенерированные мапперы

{% endnote %}

Мапперы — это инструменты для преобразования данных из источника в понятный приёмнику формат.
Они описываются в yaml формате следующим образом:

* Обязательный ключ `columns` — это список из правил,
по которому будут обрабатываться колонки исходного документа. Поля:
    * `output_column` — результирующее имя колонки.
    * `input_column` — имя входной колонки исходного документа. При этом, если есть необходимость вытащить вложенное на несколько уровней
    в словарь поле, то нужно разделить его точками. Например, если исходный документ следующий:
    <code style="color: DarkBlue">{'data': {'target': 'value'}}</code>,
    то указав в качестве `input_column`: **data.target**, мы получим на вход значение
    <code style="color: DarkBlue; font size=35;">'value'</code>.
    * `cast` — алиас функции, которая будет использоваться для обработки колонки.

    {% note tip %}

    [Доступные](https://a.yandex-team.ru/arc_vcs/taxi/dmp/dwh/replication_rules/replication_rules/plugins/cast.py) по умолчанию `cast` функций.

    {% endnote %}

    * `input_transform` — используется вместо `input_column`. Здесь указывается ключ словаря `INPUT_TRANSFORM`
    (при условии что он лежал в соответствующей области видимости, подробности ниже),
    значения в этом словаре — функции, которые на вход принимают весь исходный документ, а на выходе отдают одно обработанное значение.
    Соответственно, `input_transform` нужно использовать в случае, если стандартных методов `cast` недостаточно. Метод не должен менять исходный документ.
    * `nullable` — опциональный параметр (**true** по умолчанию),
    если указать **false**, то выходной колонке будет запрещено принимать значение `None`. Дальнейшее поведение маппера регулируется
    флагом `nulls_in_non_nullable`, по умолчанию документ будет считаться невалидным.
* `pre_map_funcs` — это список функций "пре-мапперов"
  (**обязательно**: генераторов), которые применяются к исходному документу
  до его обработки полоконочным маппером `columns`. Соответственно,
  если пре-мапперов указано 2 или больше, то каждый следующий должен ожидать
  на вход документ, формат которого задаёт предыдущий.
  Более того, пре-мапперы способны генерировать более одного документа (каждая запись реализуется через yield генератора),
  либо работать как фильтры — не возвращая документов вообще. Описанный в `columns` поколоночный маппер должен быть рассчитан на
  возвращаемый последним пре-маппером формат документа. Пре-мапперы не должны менять исходный документ.
* `nulls_in_non_nullable` — поведение при получении `None` для колонок,
  у которых явно выставлено `nullable`: **false**. По умолчанию документ будет считаться невалидным,
  что соответствует значению **fail**. Здесь можно выставить **filter**, в этом случае документы будут просто пропускаться.
* `test_skip_reason` — если вы не хотите по каким-то причинам писать тесты на маппер, укажите её здесь явно.

Добавление нового кода осуществляется следующим образом:
есть глобальный каталог `plugins/`, также можно создать такой же католог в нужном скопе правил: `{rule_scope}/plugins/`.
В нем обязательно должен лежать файл `__init__.py`, в котором можно объявить словари: `CAST`, `INPUT_TRANSFORM` или `PREMAP`,
ключами которых будут именами соответствующих преобразований, а значениями — сами преобразования. Например:
```python
def _add_ten(value):
    return value + 10

CAST = {
    'add_ten': _add_ten,
}
```

При этом если файл `plugins/__init__.py` лежит не в глобальной области видимости, то имена преобразований будут видны только
для соответствующего скопа правил. Если преобразований очень много, то можно добавлять свои модули вида `{rule_scope}/plugins/custom.py`,
при этом в `{rule_scope}/plugins/__init__.py` нужно добавить следующие строки для активации:
```python
MAP_PLUGINS = [
    'custom',
]
```

Теперь в модуле `custom.py` можно также объявлять `CAST`, `INPUT_TRANSFORM` или `PREMAP`. Импорты в кастомных модулях
допустимо делать только через точку (вида `from . import custom`).
