## Описание всех скриптов сервиса
Скрипты запускаются через админку запуска скриптов: в качестве **URL** скрипта указывается ссылка на соответствующий
коммит в репозитории [tools-py3](https://a.yandex-team.ru/arc_vcs/taxi/infra/tools-py3/taxi_replication_tasks/),
каждый аргумент указывается с новой строки. **PYTHONPATH** указывается произвольный.

### Управление состоянием репликации
#### Использование
* Скорее всего, вам нужны [драфты](drafts.md) - они выполняют все основые функции,
этот скрипт остается для нестандартных сценариев
* Инициализация всех правил группы example_rule
```bash
--rules
example_rule
--actions
init
```
* Выключение всех правил группы example_rule
```bash
--rules
example_rule
--actions
disable
```

#### Аргументы
* `--rules` — список правил для обработки, по умолчанию все правила
* `--destinations` — аргумент используется для фильтрации полученных правил по приёмникам. Тут указываются те же названия, что идут ключами поля destinations в yaml-описании правила
* `--actions` — последовательность операций, которую нужно совершить с правилом. Порядок учитывается. Если не указывать, то будет выведено текущее состояние правил. Доступные опции:
    * **disable**: выключение
    * **enable**: включение
    * **init**: начальная инициализация
    * **remove**: выключение и удаление
    * **rollback**: откат состояния на указанное параметром `--rollback` количество секунд
    * **update_info**: обновить метаинформацию
    * **update_last_replication**: установить указанную параметром `--new-ts` дату, или обновить sequence_key параметром `--new-sequence-key`
* `--source-types` — аргумент используется для фильтрации полученных правил по типам источников
* `--source-names` — аргумент используется для фильтрации полученных правил по именам источников
* `--source-unit-names` — аргумент используется для фильтрации полученных правил по unit_name источника
* `--target-types` — аргумент используется для фильтрации полученных правил по типам приёмников
* `--new-ts` — дата, которую нужно установить для правил при использовании `--actions` **update_last_replication**
* `--new-sequence-key` — выставить новый sequence_key при использовании `--actions` **update_last_replication**. Формат: **123456,int**.
* `--initial-ts` — дата инициализации репликации. Выставляется автоматически для очереди как `now()` минус несколько часов, но есть возможность задать вручную. Учитывается при архивации очереди (все документы менее этой даты могут быть архивированы).
* `--rollback` — относительное время в секундах, на которое нужно откатить выбранные правила. При этом необходимо наличие операции **rollback** в `--actions`
* `--client-names` — этот аргумент _сейчас_ используется только для фильтрации полученных правил по yt кластерам
* `--update-all-meta-info` — обновить метаинформацию для всех инициализированных правил, используется без указания `--actions` и `--rules`
* `--print-full-info` — выводить на экран полную информацию о правиле
* `--ensure-confirm-ids` — обновить соответствия таргетов и их коротких имён
* `--read-only` — получить состояния правил (без возможности редактирования)

### Управление YT таблицами, с которыми работает сервис
#### Использование
```bash
yt_ctl [имя инструмента] [аргументы]
```

#### [alter_table] YT добавление/удаление/переименование колонок таблиц {#yt-alter_table}

#### Использование
Используйте только для удаления/переименования колонок.
Для добавления колонок пользуйтесь
[драфтом](drafts.md#add_columns).

* Удаление колонок (будет вызван полный мап-редьюс):
```bash
alter_table
replica/example/example_rule
--del-columns
extra_column
extra_column_dict
```

#### Аргументы
* `paths` — пути к таблицам или директориям для изменения схемы.
* `--rule-names` — укажите имена правил, чтобы отфильтровать ненужные кластера.
* `--add-columns` — имя и тип колонки для добавления разделённые запятой: `column_name,yt_column_type column_name_2,yt_column_type_2 ...`, возможные типы колонок: `int64`, `uint64`, `any`, `double`, `boolean`, `string`
* `--rename-columns` — для переименования колонок указываются старые и новые имена, разделённые запятыми: `column_name,new_column_name column_name_2,new_column_name_2 ...`.
**Эта операция вызывает мап-редьюс и должна быть использована на больших таблицах только при крайней необходимости!**
* `--del-columns` — указываются имена колонок для удаления: `column_name column_name2`.
**Эта операция вызывает мап-редьюс и должна быть использована на больших таблицах только при крайней необходимости!**
* `--allow-indexes-modify` — разрешить обработку индексов для операций --rename-columns и --del-columns
* `--client-names` — имена YT клиентов, на кластерах которых нужно будет выполнить операции. По умолчанию будут использованы все для данной таблицы
* `--dry-run` — используйте этот флаг для тестового запуска, реальных действий выполнено не будет, в выводе будет информация о планируемых операциях
* `--preferable-main-clients` — приоритет выбора клиентов для операций там, где это возможно. Например, выбор кластера для мап-редьюса
* `--do-not-preserve-attributes` — по умолчанию будут сохранены текущие атрибуты таблицы. Вы можете сбросить их и использовать атрибуты из yaml, при использовании данного флага
* `--auto-merge-mode` — метод автоматического объединения чанков для сохранения чанковой квоты. По умолчанию максимизируется экономия квоты. Опции: disabled, relaxed, economy
* `--default-settings-automerge` — если выбран этот флаг, YT сам определит необходимые параметры для автомерджа

### [copy] YT Копирование/перемещение {#yt_ctl-copy}
#### Использование
* Пример:
```bash
copy
--copy-operations
//home/taxi/first_path/example_rule,//home/taxi/other_path/example_rule
--client-names
hahn
--move
```
* [Пример скрипта](https://tariff-editor.taxi.yandex-team.ru/dev/scripts/8d703465a3164ac7ab8d75b7033f66bb?__timestamp=1615917162150&arguments=move&name=main)

#### Аргументы
* `--copy-operations` — полные пути исходного узла и узла назначения соответственно, разделенные через запятую
* `--recursive` — рекурсивное копирование/перемещение
* `--move` — если использвать этот флаг, объект будет перемещен
* `--force` — принудительное копирование/перемещение
* `--freeze` — если указать этот флаг, дочерние динтаблицы узла будут зафрижены, а не отмонтированы
* `--client-names` — имена YT клиентов, на кластерах которых нужно будет выполнить операции.

### [remove] YT Удаление объектов {#yt_ctl-remove}
#### Использование

* Пример:
```bash
remove
//home/taxi/testing/replica/example/example_rule
--client-names
hahn
```
* [Пример скрипта](https://tariff-editor.taxi.yandex-team.ru/dev/scripts/3131bdc4c1084324b67e74af645648c8?__timestamp=1615916930548&arguments=yt_ctl)

#### Аргументы
* `paths` — полные пути узлов YT для удаления
* `--recursive` — рекурсивное удаление
* `--force` — принудительное удаление
* `--force-short` — разрешить удаление околокорневых узлов YT
* `--client-names` — имена YT клиентов, на кластерах которых нужно будет выполнить операции.

### [table_toolkit] Инструменты для работы с YT таблицами {#yt_ctl-table_toolkit}
#### Использование
* Пример:
```bash
table_toolkit
//home/taxi/testing/replica/example/example_rule
--actions
unmount
mount
--client-names
hahn
```
* [Пример скрипта](https://tariff-editor.taxi.yandex-team.ru/dev/scripts/f8ed45ca83b74ea7a4511437d50ba9c3?__timestamp=1615916930548&arguments=yt_ctl)

#### Аргументы
* `paths` — полные пути к таблицам
* `--actions` — действия, которые нужно последовательно совершить с динамической таблицей. Доступные действия: unmount, freeze, remount, reshard-tablet-count, unfreeze, set-attributes, mount, force-compact
* `--allow-dir` — флаг, который указывает, можно ли скрипту работать с директориями
* `--reshard-tablet-count` — желаемое количество таблетов в динтаблице. Внимание: этот атрибут передает в YT желаемое количествоновых таблетов, но количество таблетов будет определено системой автоматически.
* `--skip-non-dyntables` — если установлен этот флаг, скрипт не упадет, если встретит во время работы объект, не являющийся динтаблицей
* `--set-attrs` — атрибуты, которые нужно выставить при использовании действия --set-attrs. Формат: `{атрибут},{новое значение},{(опционально) тип значения}`
* `--client-names` — имена YT клиентов, на кластерах которых нужно будет выполнить операции.

## Вспомогательные инструменты для работы с сервисом репликации
### Использование
```bash
python -m replication.tools.main [имя инструмента] [аргументы]
```

### [drop_staging_collections] Очистка очередей репликации
#### Использование
```bash
drop_staging_collections
--rule-name
example
--shards-num
3
```

#### Аргументы
* `--rule-names` — имена правил репликации
* `--shards-num` — число шардов коллекции в очереди. По умолчанию коллекция считается нешардированной
* `--db-cluster` — кластер, на котором находится коллекция-очередь для правила, по умолчанию - replication_queue_mdb_1
* `--dry-run` — используйте этот флаг для тестового запуска, реальных действий выполнено не будет, в выводе будет информация о планируемых операциях
