# Пример работы с постгресом

Примеры работы можно посмотреть в коде. В примерах:
- конфигурация
- создание схемы
- работа с топологией (мастер, синхронная и асинхронная реплики)
- работа с шардирами (с единственным шардом, точнее)
- функции в схеме `pg_temp`, создаваемые на коннект
- хранение запросов в файлах
- генерация запросов из jinja2-шаблонов

Не хватает:
- примеров миграции (так и не договорились до единого способа)


## Рекомендации

Храните sql в файлах, используйте для этого плагины `postgres_queries` и
`sqlt`. Параметризуйте запросы стандартным способом во избежание sql
sql-инъекций.

При использовании sqlt SQL-инъекции исключаются автоматически.

Делите данные на горячие и холодные. В планах pgaas предоставить
конфигурации с sata-дисками.

Не делайте базы больше 20Gb. С большими базами всё сложнее, от
построения индексов до дампов и миграций.

Шардируйте. Шардирование уникально для каждого сервиса (вплоть до того,
что шарды могут быть описаны в базе), но писать его можно единообразно
(см. работу с плагином pgshards в примере, лучше так же делать везде).

Не сохраняйте на сервере хранимые процедуры. Если нужно, положите ваши
plpgsql функции в схему `pg_temp`. В коде есть пример.


## TODO

https://st.yandex-team.ru/TAXITOOLS-743
Научиться кастомизировать число соединений.

https://st.yandex-team.ru/TAXITOOLS-744
Написать плагин для стандартной конфигурации с одним шардом.

https://st.yandex-team.ru/TAXIPLATFORM-140
Уже выбрать единый способ проведения миграций.

https://st.yandex-team.ru/TAXIPLATFORM-141
Определиться с политиками выведения сервисов с постгресом из
эксплуатации.

https://st.yandex-team.ru/TAXIPLATFORM-142
Добавить поддержку prepared statements в драйвере.
