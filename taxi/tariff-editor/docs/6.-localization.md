Запуск автоматизированной локализации происходит командой `localize`. Для ее использования нужно установить npm пакет `taxi-localization`

Конфиг для скрипта должен лежать в корне проекта и называться `localization.config.json`. Конфиг содержит следующие настройки:
* repo - название репозитория (tariff-editor)
* project - название проекта в танкере (tariff-editor)
* keyset - название кейсета в танкере (common)
* apiHost - базовый урл АПИ танкера (https://tanker-api.yandex-team.ru)
* host - базовый урл интерфейса танкера (https://tanker-beta.yandex-team.ru)
* authPath - путь до файла auth.json с токеном авторизации в танкер. выстраивается относительно папки, где лежит конфиг (./scripts/localization)
* diffPath - путь до папки, куда будут складываться diff-файлы. выстраивается относительно папки, где лежит конфиг (./scripts/localization/diffs)

Команда имеет следующие параметры:
*  Target: `-t=<path>` - Путь к директории, которую нужно перевести, единственный обязательный параметр
*  Diff: `-d` или `-d=<file>` - Если не указан файл, то создает json с собранными изменениями. Если файл указан, то при локализации будет брать ключи из файла. Указывается просто имя файла, который лежит в папке, указанной в `diffPath` в конфиге
*  Sync: `-s` - Заливать ли локализацию в танкер, по умолчанию - нет (Если нет, то сорсы не меняются)
*  Print: `-p` - Выводить ли все собранные переводы в консоль
*  Branch: `-b=<branch>` - В какую ветку танкера лить переводы, по умолчанию - `test`
* Config: `-c=<path>` - Путь до папки, в которой лежит файл `localization.config.json`, по умолчанию используется папка из которой запущена команда

### Подготовка к запуску
Для того, чтобы команда `localize` работала, необходимо в папке `./packages/scripts/src/localization` завести файл `auth.json`, в котором будет лежать ваш токен. Этот файл добавлен в gitignore и не должен заливаться в репозиторий.

Файл имеет формат
```json
{
    "token": "<token>"
}
```

Токен можно получить перейдя по [ссылке](https://nda.ya.ru/3SjQY7).

### Пример (пишем в танкер переводы, подставляя ключи из файла):

```bash
localize -t=./static/bundles/orders -d=static_bundles_orders_2018_09_21_12_00.json -s
```

### Флоу локализации
* Создаем выгрузку с изменениями в json, и атачим к тикету в Стартреке.

```bash
localize -t=<folder> -d
```
* Указываем в комментарии список дубликатов ключей, выводимый скриптом, если таковые имеются
```
Translation contains <N> items with same keys and different text.
key: driver
value1: Водитель
value2: водитель

key: unlock wu
value1: Разблокировка ВУ
value2: Разблокировать ВУ

key: no
value1: нет
value2: Нет

key: yes
value1: да
value2: Да

key: locked.
value1: Заблокирован.
value2: Заблокировано.
```
* Дожидаемся ручной правки json, которая также прикладывается к тикету
* Прогоняем скрипт с новым файлом
```bash
localize -t=<folder> -d=<diff file>
```
* Если скрипт выводит сообщение о том что в Танкере существуют некоторые ключи, то указываем список этих ключей в комментарии к тикету, и ждем ОК, что так и должно быть. Пример вывода скрипта:

```
Tanker already has some of imported keys (they will be ignored):
driver
find
reason
zendesk_ticket
status
no
yes
```
* Проверяем через вывод в консоль итоговый результат
```bash
localize -t=<folder> -d=<diff file> -p
```
* Если все ок, то запускаем скрипт в прод режиме, проверяем что все залилось в Танкер, и отдаем ПР на ревью
```bash
localize -t=<folder> -d=<diff file> -s
```
* Призываем менеджера и сообщаем, что на перевод появился новый ключ.
* По умолчанию скрипт работает с веткой Танкера `test`, переводчики переводят в ней же, после того, как переводы готовы, мерджим ее в ветку `master`

### Резолв дубликатов
* Если дубликаты возникли внутри json файла с выгрузкой изменений, то они будут иметь проперти `isDuplicate: true`, в `meta`. Разрешить эту ситуацию можно двумя способами. 
1. Заменить дублирующее поле `key` на уникальное значение и выставить `isDuplicate: false`, тогда в танкер попадут оба ключа c их вариантами текстов.
2. Выставить дубликату целочисленное неотрицательное значение в поле `priority`, тогда в танкер попадет только ключ с наивысшим приоритетом и его текст. Среди равных приоритетов больше нуля выберется первый попавшийся, так что так не стоит выставлять приоритеты, все ненулевые приоритеты должны отличатся.
* Если дубликат возник с танкером, то тут тоже два способа решить проблему:
1. Если текст, который уже есть в танкере, подходит, то заменяем ключ в выгрузке на тот что в танкере, и тогда он по-сути проигнорируется при импорте в танкер.
2. Заменить ключ на уникальный, чтобы в танкер попал новый текст.

### Примечания
* Надо не забыть сделать выгрузку переводов в Бункер для тестирования, и опубликовать переводы в Бункере перед выкаткой в прод. Проект в Бункере находится по [ссылке](https://bunker.yandex-team.ru/taxi-tariff-editor/tanker)
* Следите за тем чтобы текст в ключе содержал осмысленную для перевода фразу, если текст разбивается какой-то разметкой на части, которые только в совокупности составляют предложение, то нужно создать темплейт с разметкой, который будет лежать под одним ключом


### Работа с i18n utils

**Использование плюральной формы:**
1. Заводим строки в файле
1. Создаем перевод через `localize -t=<folder> -d` и проходим все шаги до получения ссылок в танкере.  
  Строки теперь выглядят так `i18n.print('section.string')`
1. Открываем ссылки в танкере и жмем [Добавить плюральные формы]
1. Добавляем плюральные формы и жмем [Сохранить изменения]
1. Публикуем переводы в [бункере](https://bunker.yandex-team.ru/taxi-tariff-editor/tanker)
1. Теперь указываем цифру от которой будет зависеть перевод
  ```ts
  const getMyString = (count: number) => i18n.print('section.string', {count}),
  ```

**Использование переменных**
1. Заводим строку и в строке указываем переменные:  
   `'Деактивация через %days% %hours%'`
1. Создаем diff файл и выгружаем в танкер
1. Теперь мы можем подставить значения через placeholder
```ts
const deactivationAfter = (days: number, hours: number) => i18n.print('tag_queries.deactivation_after',
  placeholder: {
    days: i18n.print('section.days', {count: days}),
    hours: i18n.print('section.hours', {count: hours}),
  }
}),
```
