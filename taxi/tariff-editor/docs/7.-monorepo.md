### Общая информация

Весь репозиторий разбит на пакеты - так называемый монорепозиторий. В качестве тулзы, облегчающей управление пакетами, используется [Lerna](https://github.com/lerna/lerna).

Разбиение на пакеты требуется поскольку проект стал очень большим и над ним работает несколько команд, а пакеты позволяют лучше структурировать код и облегчить его поддержку, сборку и деплой. В перспективе хочется научится релизить пакеты абсолютно независмо, сейчас релиз отдельных пакетов возможен но имеет ряд ограничений.

Все пакеты содержат Typescript, ничего не компилится в js, это происходит при сборке.  

На данный момент есть следующие служебные пакеты:
* `@tariff-editor/tsconfig` - хранит конфиг с общими настройками Typescript, которые наследуются большинством других конфигов в пакетах
* `@tariff-editor/types` - хранит общие `d.ts` файлы (утилитарные типы, типы уровня приложения)
* `@tariff-editor/vendors` - пакет с общими зависимостями
* `@tariff-editor/webpack` - пакет с утилитами вебпака
* `@tariff-editor/core` - хранит общий функционал - утилиты, общие саги и компоненты
* `@tariff-editor/main` - рутовый пакет, содержащий базовый лейаут и инициализирует приложение. Остальные пакеты догружаются асинхронно.
* `@tariff-editor/server` - хранит нодовую часть приложения, она общая на все пакеты
* `@tariff-editor/scripts` - хранит различные скрипты (сборка, инициализация репозитория и тд)
* `@tariff-editor/linter` - хранит кастомные правила tslint
* `@tariff-editor/tools` - хранит нодовые утилиты используемые в ряде других пакетов, например в линтере, скриптах, сервере, вебпаке
* `@tariff-editor/tests` - хранит общие настройки для тестов

Прочие пакеты продуктовые и содержат собственно различные разделы Админки

### Как заводить новый пакет

1. Создать папку в packages, которая имеет следующее наполнение

```
packages
|
|---/my-package
|     |---/src
|     |     |---/bundles
|     |     |---routes.ts
|     |     |---index.ts
|     |     |--- ...
|     |---tsconfig.json
|     |---package.json
|     |---webpack.config.ts
|     |---jest.config.js
```
Где:
- Папка `bundles` содержит бандлы, описание которых можно посмотреть [тут](/arcadia/taxi/tariff-editor/docs/1.-bandles.md)
- package.json - содержит список зависимостей пакета, включая зависимости на другие пакеты
- webpack.config.ts - конфиг сборки
- jest.config.js - конфиг тестов
- tsconfig.json - содержит настройки тайпскрипта, большинство таких конфигов наследует базовый из пакета `@tariff-editor/tsconfig`
- routes.ts - файл, агрегирующий роутинг ваших бандлов
- index.ts - мейн файл, пока больше для удобства импорта пакета
- `...` - (/api, /components, /utils, /sagas) по аналогии с core пакетом, то что общее для вашего пакета

Примеры нужных файлов можно посмотреть в любом продуктовом пакете (НЕ из списка служебных приведенного выше)

2. Добавить вебпак конфиг пакета в [дев мидлвару](/arcadia/taxi/tariff-editor/packages/server/src/middleware/dev/index.ts) сервера

3. Запустить npm run init

### Требования к содержимому пакета
 - Навигация бандлов должна подключатся через `extendRoutes` и `extendNavigation`
 - Пакет должен содержать только typescript, в противном случае поскольку он будет подключен опосредованно через node_modules, то компилятор будет ругаться, что есть js файлы без деклараций
- Пакет не должен иметь импорты из пакетов, которые не указаны в package.json, такое может случайно случится при копи пасте, за этим следит плагин вебпака, который был настроен в пункте 2 создания пакета

### Замечания

* Алиасы в пакеты для `webpack` надо настраивать через путь к `node_modules` (например `node_modules/@tariff-editor/core/src/utils/`)
* Алиасы в пакеты для `jest` надо настраивать через реальный путь к пакету (например `<rootDir>/packages/core/src/utils/`)
* В связи с тем, что `webpack` не умеет резолвить алиасы в массив путей, в отличие от конфига Typescript, надо следить чтобы все пути для одного алиаса в `tsconfig` смотрели в одну папку
* При инициализации репозитория помимо `npm i` надо еще делать `lerna bootstrap`, для этого уже заведен скрипт `npm run init`
