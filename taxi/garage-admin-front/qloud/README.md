# Общее описание

В этом каталоге содержатся вспомогательные файлы для сборки и загрузки образов
компонентов проекта в qloud.
В документе описывается что и как там работает, что нужно сделать для того,
чтобы обновить образ.

## Про qloud

qloud - это система для запуска приложений в докер-контейнерах, реализованная
в яндексе и развернутая на их серверах. Для управления предоставляется
веб-интерфейс, через который можно задать настройки приложений вразных
окружениях, запустить/остановить/обновить приложения.
Более подробно можно почитать тут: https://wiki.yandex-team.ru/qloud/doc/

Веб интерфейс для управления приложениями тут: https://platform.yandex-team.ru/projects/taxi-outsource-marketplace
Для доступа к нему нужно:
* включенный vpn яндекса
* логин в паспорте passport.yandex-team.ru
* права (запрашивать у PM) для доступа к платформе и конкретно к проекту taxi-outsource-marketplace
* для захода в контейнеры нужно создать пару ключей ssh и попросить я-тим
  админов чтобы они добавили ваш публичный ключ где-то там у них, чтобы можно
  было ходить в контейнеры по ssh.


## qloud и маркетплейс

Для ytmarketplace в данный момент созданы три приложения:
* backend - собственно маркетплейс, то, с чем работают гости, водители и
  такоспарки
* backoffice - админка для модераторов + оттуда биллинг забирает начисления по
  звонкам
* extmocks - наши заглушки к внешним сервисам (по факту можно считать это
  нерабочим, потому из extmocks нет доступа к маркетплейсу, то есть эмуляция
  звонков нормально не работает)

Для каждого из приложений есть окружения testing & stable.
testing - для тестирования
stable - продакшн, с ним работают конечные пользователи

Например, backend-testing:
https://platform.yandex-team.ru/projects/taxi-outsource-marketplace/backend/testing

В этом окружении мы можем:

- посмотреть переменные окружения (кнопка Variables) (менять можно только через
  draft, смотри ниже)
- посмотреть адрес контейнера чтобы зайти в него по ssh (блок с названием
  backend, в нем кнопка "ISS OK") - в открышемся окошке адреса контейнеров в
  колонке Hosts
- Обновить приложение до новой версии - блок с названием backend, кнопка Update.
  Дальше в открывшемся окне надо выбрать нужный Tag (версия образа) и нажать Update.
- Поменять настройки приложения - Нажать на кнопку Create draft, и в блоке
  с название контейнера (например, ssr-driver) нажать кнопку Edit.
  После завершения редактирования нужно либо
  задеплоить - нажать "Deploy Draft", либо сохранить для дальнейшего
  редактирования - нажать "Commit draft".


## Настройки (конфигурация) приложений в qloud

Для каждого окружения есть ряд отличающихся параметров, они задаются через
переменные окружения. Переменные окружения для контейнера можно задать либо
через общие переменные приложения (кнопка variables в интерфейсе платформы),
либо через переменные окружения компонента. Выше в качестве примера
рассматривался ssr-driver, чтобы изменить его переменные нужно нажать в его блоке
на edit и в открывшемся окне выбрать секцию "Variables" (редактировать можно
только через Draft).

Актуальные значения переменных также всегда можно посмотреть зайдя в контейнер
по ssh и выполнив команду `env`.

# Сборка и обновление образа

## Сборка

Для того чтобы обновить приложение в кулауде нужно предварительно собрать новый
докер-образ и залить его в docker-registry яндекса.
Для этого необходим доступ на запись к:
* registry.yandex.net/taxi/taxi-outsource-marketplace/ssr-driver
и доступ на чтение к registry.yandex.net/taxi/baseimages/taxi-base-qloud-xenial
(Доступы запрашивать у яндекс-админов).

Для упрощения сборки/заливки/тегирования сделан Makefile.

Сборка образов:
* перейти в каталог qloud
* увеличить параметр IMAGE_VERSION (версию) в Makefile
* запустить сборку `make all` - команда запускает сборку статики, синхронизирует
  статику и исходники проекта с контекстом докера, собирает образы с нужными
  тегами.
* убедиться, что сборка прошла без ошибок

## Обновление

**Важно** знать какие миграции имеются в новой сборке и к чему они относятся.
Контейнеры в приложении backend и backoffice соединяются с одной БД, поэтому
необходимо сначала деплоить backend, а после backoffice на одинаковые версии сборки.
Возможен и обратный вариант, сначала backoffice, затем backend, в случае когда
миграции касаются таблиц, используемых только в административной части.

Для обновления образов в кулауде нужно:
* загрузить образ в яндекс-registry: `make push` (можно использовать
  команду `make all_push` для пуша сразу же после сборки)
* обновить контейнер ssr-driver в testing-окружении
* протестить обновление в тестинге

Если все хорошо и получено добро на обновлени от PM, то обновить образ в stable.
Но перед этим  нужно зафиксировать версию в нашем репозитории.
Это можно сделать так:
* `make fix_version` - команда создаст гит-ветку
  `new-qloud-названиесборки-version-версия из Makefile`, закоммитит все изменения из текущей
  директории (по идее должен быть изменен только Makefile - в нем прописывается
  новая версия).
* `make tag` - команда создаст гит-тег с новой версией ytmarketplace
* `git push origin <текущая ветка>`
* `git push --tags`

Можно воспользоваться командой, которая выполнит все предыдущие действия разом:
 `make push_new_branch`

После этого можно обновить версию образа в стейбл-окружении и обязательно после
деплоя проверить что обновление прошло нормально, посмотреть логи в
стейбл-контейнерах на предмет ошибок.


## Имеющиеся приложения

Приложения:

* ytmarketplace - основное приложение марктеплейса которое публично доступно
* ext_mocks - заглушки на внешние сервисы (есть везде кроме прода)
* backoffice - админка модераторов

backoffice отличается от ytmarketplace тем, что он должен быть доступен только
из внутренней сети яндекса. Он является тем же самым приложением, что и
ytmarketplace но в нем выключены некоторые роуты. Это поведение задается
выставлением специальной переменной окружения `ROUTES_DISABLED`.

Чтобы выключить админку модераторов нужно выставить `ROUTES_DISABLED` в:
```
ROUTES_DISABLED=yandex_idm,admin,billing
```
Чтобы выключить все кроме админки модераторов и списка объявлений:
```
ROUTES_DISABLED=calls,stats,subscribes,taxiparks_api
```

Дополнительно backoffice отдает начисления в биллинг. Сделано так для того, чтоб
не выставлять наружу внутренние сервисы. backoffice доступен только во внутренней
сети яндекса в отличие от приложения backend

## Инструкция по деплою вкратце

1. перейти в каталог qloud
1. в Makefile повысить IMAGE_VERSION
1. `make all_push`
1. `make push_new_branch` - зафиксировать изменения для сборки в отдельную ветку
1. в панели управления Create draft и смена версии сборки ssr-driver
1. чтобы легко ориентироваться в статусе контейнера при деплое указать _ssr-driver:<номер версии> - краткое описание изменений_
