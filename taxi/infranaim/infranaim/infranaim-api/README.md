##Сервис INFRANAIM-API

Сервис позволяет создавать корректно размеченные тикеты в Zendesk по входящим данным.

###Пример:
Перед тем, как начать пользоваться сервисом необходимо:

  - ___А)___ Создать документ валидации входящих данных в коллекции `api_routes`
  - ___Б)___ Создать документ разметки входящих данных в коллекции `incoming_markup`

___А. Для создания документа валидации входящих данных потребуется:___
  ##### Обязательно:
 - Согласованный роут ручки. Пример: конечный урл будет таким: ``BASE_URL/api/v1/submit/create``, для документа необходим ``/v1/submit/create``;
 - Токен. Требования для токена: 42+ символов, в бд хранится sha256 хэш;
 - Согласованные поля тикета, содержание которых сервис пропустит в Зендеск
  ##### Опционально:
  - Комментарий по умолчанию - будет использован в случае, если во входящих данных комментарий не пришёл. Произвольная строка с длиной 501 символ;
  - Тема тикета по умолчанию - будет использована в случае, если во входящих данных тема не пришла. Тема, как правило, одна на задачу. Максимальный размер темы - 51 символ
  ##### Пример:
  При наличии следующего документа в коллекции `api_routes`
  ````
  {
    "route": "/v1/submit/create",
    "comment": "Test comment",
    "subject": "Test subject",
    "allowed_properties": [
        "name",
        "phone",
        "medium",
        "source"
    ],
    "token": TOKEN
  }
  ````
  И при запросе
  ```
  curl -X POST BASE_URL/api/v1/submit/create
       -H 'Content-Type: application/json'
       -H 'token:  TOKEN'
       -d '{
             "params": {
               "name": "Name Surname",
               "phone": "+79998885544",
               "comment": "My comment",
               "transaction_id": 1234,
               "medium": "Dedium"
             }
           }'
  ```
  Происходит:
  - а) Проверка существования роута `/v1/submit/create`
  - б) Проверка токена этого роута
  - в) Сборка итогового входящего документа:
  ```
  {
    "name": "Name Surname",  -- Из тела запроса 
    "phone": "+79998885544",  -- Из тела запроса
    "comment": "My comment",  -- Из тела запроса
    "medium": "Dedium",  -- Из тела запроса
    "subject": "Test subject"  -- Из документа в api_routes
  }
  ``` 
  !Hint: поле `transaction_id` было пропущено, поскольку не значится в `allowed_properties` документа из `api_routes`
  
___Б. Для создания документа разметки данных необходимо:___
  ##### Обязательно:
  - Согласовать разметку тикетов вашего сервиса с аналитиками проекта
  - На основании их требований создать документа в коллекции `incoming_markup`
  ##### Пример:
  Есть документ разметки вида:
  ```
  {
	"_id": ObjectId("5c13c43573bf7c196c4415f9"),
	"type": "/v1/submit/create",
	"created_dttm": datetime.datetime(2018, 11, 28, 13, 46, 24, 412000),
	"created_by": "mira_killian | Мира Киллиан",
	"updated_dttm": datetime.datetime(2018, 11, 28, 13, 46, 24, 412000),
	"updated_by": "mira_killian | Мира Киллиан",
	"start_dttm": datetime.datetime(2018, 9, 4, 12, 21, 11),
	"end_dttm": null,
	"comment": "https://st.yandex-team.ru/INFRANAIM-2127",
	"unique_attributes": {},
	"mandatory_markup": {
		"source": {
			"name": "Online landings inbound",
			"tag": "ol_landings_inbound"
		},
		"medium": {
			"name": "Online",
			"tag": "online"
		},
		"brand": {
			"name": "Yandex.Taxi",
			"tag": "brand_yandex_taxi"
		},
		"advertisement_campaign": {
			"name": "Inbound from landings",
			"tag": "landings_inbound_campaign"
		}
	},
	"secondary_markup": {
		"city": {
			"name": "Ростов-на-Дону",
			"tag": "ростов_на_дону"
		},
		"vacancy": {
			"name": "Водитель",
			"tag": "водитель_вакансия"
		}
	},
	"from_ticket_markup": {
		"transaction_id": {
			"name": "855",
			"tag": "855"
		}
	}
  }
  ```
  где:
  - `type` - один из признаков уникальности разметки, в данном случае это роут, на который пришли данные;
  - `unique_attributes` - признаки уникальности разметки. Можно использовать в случаях, когда один поток данных необходимо размечать различными способами. Например, если пришло`{"vacancy": "driver"}`, то разметка ставит источник `Source_Drivers`, иначе - `Source_Scouts`. С тем же успехом можно использовать две ручки в системе. В данном примере можно оставить пустым;
  - `mandatory_markup` - признаки, которыми будут перезаписаны поступившие данные;
  - `secondary_markup` - признаки, которыми будут перезаписаны поступившие данные, если в поступивших данных нет ключей из него. либо если значения по этим ключам пустые. Например, если пришло `{"city": ""}` или `{}`, а в документе разметки есть `{"city": "Казань"}`, то подставится `Казань`, а если пришло `{"city": "Москва"}`, то отправится `Москва`;
  - `from_ticket_markup` - признаки, которыми будут перезаписаны поступившие данные, если в поступивших данных нет ключей из него. Например: если пришло `{"city": ""}`, то отправится пустое значение, а если `{}`, то возьмётся значение из документа разметки
  Уникальность разметки определяется сочетанием признаков `type` и `unique_attributes`
  
  Итоговый тикет, который будет отправлен в зендеск:
  ```
  {
    "name": "Name Surname",  -- Из тела запроса 
    "phone": "+79998885544",  -- Из тела запроса
    "comment": "My comment",  -- Из тела запроса
    "medium": "online",  -- Из тела разметки
    "subject": "Test subject"  -- Из документа в api_routes,
    "source": "ol_landings_inbound",  -- Из тела разметки
    "brand": "brand_yandex_taxi",  -- Из тела разметки
    "advertisement_campaign": "landings_inbound_campaign",  -- Из тела разметки
    "city": "ростов_на_дону",  -- Из тела разметки
    "vacancy": "водитель_вакансия",  -- Из тела разметки
    "transaction_id": "855"  -- Из тела разметки
  }
  ``` 
