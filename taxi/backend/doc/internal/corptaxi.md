## Корпоративное такси

### Изменения в клиентском протоколе

#### /3.0/paymentmethods
Добавляем новую ручку [`/3.0/paymentmethods`](../../taxi/client_protocol/protocol_3_0/schema/docs/paymentmethods.md),
которая возвращает список доступных методов оплаты для пользователя.


#### /3.0/order
Меняем поле `payment` в `/3.0/order` и `/3.0/orderdraft` (при этом сохраняем
обратную совместимость, т.е принимаем поле `payment` и в старом, и в новом
формате).
Для наличных оно будет выглядеть так:
```json
{
    "...": "...",
    "payment": {
        "type": "cash"
    },
    "...": "..."
}
```

Для карт так (`tips` переносятся на уровень выше):
```json
{
    "...": "...",
    "tips": {
        "type": "percent",
        "value": 5
    },
    "payment": {
        "type": "card",
        "payment_method_id": "card-0123456"
    },
    "...": "..."
}
```

Поле `"tips"` в новом формате можно передавать всегда.
Даже при оплате наличными, в этом случае бэкенд разберется, что делать с tips.


При такой передаче метода оплаты для карт не надо передавать
```requirements: {creditcard: true}```, т.к бэкенд может сам догадаться, что
заказ по карте.



Для корпоративного счета так:
```json
{
    "...": "...",
    "payment": {
        "type": "corp",
        "payment_method_id": "corp-0123456"
    },
    "...": "..."
}
```

Добавляем новые причины 406 в `/3.0/order` и `/3.0/orderdraft`:
* 406 - при попытке вызвать корпоративное такси, когда пользователь не является корпоративным клиентом:
    `{"error": {"code": "NOT_CORP_CLIENT", "text": text}}`
* 406 - при попытке вызвать корпоративное такси, когда пользователь превысил лимит:
    `{"error": {"code": "CORP_LIMIT_EXCEEDED", "text": text}}`
* 406 - когда нельзя вызвать корпоративное такси в выбранном городе:
    `{"error": {"code": "CORP_CITY_DISABLED", "text": text}}`
* 406 - когда нельзя вызвать корпоративное такси по данной категории:
    `{"error": {"code": "CORP_CLASS_DISABLED", "text": text}}`


#### /3.0/taxiontheway и /3.0/taxisearch
В `/3.0/taxiontheway` добавляем поле `payment`.
В поле `payment` передается информация о текущем способе оплаты заказа.
Например, для заказа за наличные:
```json
"payment": {
    "type": "cash"
}
```

Для заказа по карте:
```json
"payment": {
    "type": "card",
    "payment_method_id": "card-012345"
}
```

Для заказа по корпоративному счету:
```json
"payment": {
    "type": "corp",
    "payment_method_id": "corp-012345"
}
```

В поле `tips` добавляем флажок `available`, который сообщает, что чаевые
доступны/недоступны (например, для заказов по корпоративному счету чаевые недоступны)

```json
{
    "...": "...",
    "tips": {
        "type": "percent",
        "value": 0,
        "available": false
    },
    "...": "..."
}
```

В "available_methods" добавляется тип оплаты "corp".
```json
{
    "...": "...",
    "allowed_changes": [
        {
            "name": "payment",
            "available_methods": ["card", "corp"]
        },
    ],
    "...": "..."
}
```

Добавляем поле `payment_changes`, в котором живет массив изменений способа
оплаты и причины этих изменений. Это поле заменяет собой `updated_requirements`
и новые клиенты могут игнорировать `updated_requirements` и смотреть
в `payment_changes`.

Формат поля `payment_changes`:
```
{
    "...": "...",
    "payment_changes": [
        {
            "from": {
                "type": "card",
                "payment_method_id": "card-012345"
            },
            "to": {
                "type": "cash",
            },
            "reason": {
                "code": "UNUSABLE_CARD",
                "text": "Некий текст для показа пользователю"
            }
        },
        {
           "from": {
               "type": "corp",
               "payment_method_id": "corp-012345"
           },
           "to": {
               "type": "cash"
           },
           "reason": {
               "code": "INITIATED_BY_USER",
               "text": "Некий текст для показа пользователю"
           }
        }
    ],
    "...", "..."
}
```


#### /3.0/routestats

Поле `payment` становится таким же, как и в `/3.0/order`. `tips` не передаем.
C requirements.creditcard та же история, что и с `/3.0/order` - не надо
передавать, если payment передается в новом формате.

#### /3.0/cities
В поле `payment_options` добавляем флажок `corp`.
```json
{
    "...": "...",
    "payment_options": {
        "corp": true
    },
    "...": "..."
}
```
* "corp": true - в городе можно ездить по корп. счету


#### /3.0/couponcheck
С полем `payment` та же история, что и в `/3.0/order`. `tips` не передаем.
C requirements.creditcard та же история, что и с `/3.0/order` - не надо
передавать, если payment передается в новом формате.


#### Волшебные комментарии и запросы
* paywith-corp012345 - вернуть в `payment` `/3.0/taxiontheway` корпоративный счет
* paychanges-unusable - вернуть в `payment_changes` изменение с карты на наличные
* paychanges-user - вернуть в `payment_changes` изменение с корп. счета на наличные (возможно, нереальная ситуация в проде, но на всякий случай)
* если передать `service_level: 90` и способ оплаты корп. счет в `/3.0/order`, то получите 406 в ответ.


#### /3.0/routestats на будущее
ВНИМАНИЕ: в первую итерацию для routestats 406 и service_level в новом формате не делаем,
то что написано ниже - для обсуждения.
Добавляем в запрос возможный параметр `service_level` (такой же смысл, как и в
`/3.0/order`)

Добавляем в запрос флажок `"check_order": true`.

Если `"check_order": true`, то
`/3.0/routestats` может вернуть 406, если нельзя сделать заказ с переданными
параметрами. Например, при попытке вызвать корпоративное такси по тарифу "бизнес":
    `{"error": {"code": "CANT_CORP_TAXI", "text": text}}`
