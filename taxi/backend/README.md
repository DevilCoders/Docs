Бэкенды Яндекс.Такси
====================

Полезные ссылки
---------------

*   [устройство сервиса][adminwiki]
*   [проект в TeamCity][teamcity]
*   [документация на протокол таксопарков][doctaxi]
*   [документация на протокол клиентских приложений][docclient]
*   [документация на протокол биллинга][docbilling]


Рассылки
--------

*   [общая][mailtaxi]
*   [блоги][mailtaxiblogs]
*   [разработка][mailtaxidev]
*   [крон-таски][mailtaxicron]
*   [коммиты][mailtaxicommits]


Протоколы
---------

Бэкенды Я.Такси реализуют два основных API, таксопарковый и клиентский (пакеты yandex-taxi и yandex-taxi-client, соответственно).

API таксопарков используется для передачи заказов нашим партнерам. Это закрытый протокол, каждый партнер использует для работы свой секретный API-ключ, выдаваемый вручную при заключении договора. Взаимодействие производится по HTTPS, если партнер поддерживает эту возможность. [Документация на этот протокол][doctaxi] поддерживается группой документирования.

API клиентского приложения используется для взаимодействия с мобильными приложениями Я.Такси (айфон, андроид) и с сайтом Я.Такси, который представляет собой легкий джаваскриптовый фронтенд. Мы не публикуем документацию на этот протокол наружу, но при желании любой подготовленный человек может его исследовать, имея на руках мобильное приложение. Взаймодействие производится всегда по HTTPS для защиты передаваемых персональных данных пользователя. [Документация на этот протокол][docclient] поддерживается разработчиками бэкендов Я.Такси.


Что внутри
----------

В клиентском и таксопарковом API используется twisted.web.
В админке и биллинге используется django.
Часть задач выполняется воркерами celery.
Все они связаны между собой единой базой MongoDB.


Партнерское тестовое окружение
------------------------------

Помимо обычных окружений (development, testing, production, stress), в Яндекс.Такси принято еще одно неформальное окружение - партнерский тестинг. Технически это окружение принадлежит к production, раскатывается кондуктором вместе с production и поддерживается администраторами по SLA production. Это окружение полностью изолировано от основного production, имеет свою отдельную админку и кабинеты партнеров. Используется для тестирования интеграции с новыми партнерами перед включением их в боевой сервис.


Continuous Integration
----------------------

Бэкенды Я.Такси состоят из 9 пакетов:

*   yandex-taxi - реализация протокола для работы с таксопарками
*   yandex-taxi-admin - админка, см. документацию в папке admin
*   yandex-taxi-cabinet - кабинет партнера, см. документацию в папке cabinet
*   yandex-taxi-client - реализация протокола для работы с мобильными приложениями и фронтендом сайта
*   yandex-taxi-import - крон-таски, импортирующие данные от партнеров, производящие регулярное обслуживание базы

Snapshot-версии собираются в TeamCity при каждом обновлении ветки develop репозитория на гитхабе и автоматически выкатываются в тестинг. Сборка этих версий никак не отражается в репозитории. Они получают номер предыдущего релиза с суффиксом, обозначающим количество коммитов с предыдущего релиза. При сборке snapshot-версий TeamCity автоматически составляет запись в changelog.

Release-версии собираются в TeamCity при каждом обновлении ветки master репозитория на гитхабе (согласно git-flow) и автоматически выкатываются в тестинг. При автосборке релизной версии TeamCity не меняет содержимое changelog, это нужно сделать самостоятельно или с помощью скрипта release. Версия пакета берется из changelog обычным способом. В репозитории релизы обязательно помечать тегом debian/номер релиза, это необходимо для правильного формирования записей в changelog.

Hotfix-версии собираются в TeamCity при каждом обновлении ветки master репозитория на гитхабе (согласно git-flow) и автоматически выкатываются в продакшен хотфиксом (если быть точным, создается тикет в кондукторе - выкладка происходит вручную). Действуют все те же правила, что и для сборки релизов, но номер версии должен заканчиваться суффиксом hotfixN, где N - номер хотфикса относительно предыдущего релиза. При этом на тестинг выкладывается снапшот-версия с примененным хотфиксом (согласно git-flow).


[adminwiki]: http://wiki.yandex-team.ru/YandexMobile/Admining/Groups/mobiletaxi
[teamcity]: https://teamcity.taxi.yandex-team.ru/project/YandexTaxi?projectTab=overview&mode=builds
[doctaxi]: http://doc.yandex-team.ru/taxi/server-protocol/concepts/about.xml
[docclient]: https://github.yandex-team.ru/taxi/backend/wiki/protocol_3_0
[docbilling]: http://wiki.yandex-team.ru/market/projects/partnerUI/taxi#statistika

[mailtaxi]: http://ml.yandex-team.ru/lists/taxi/
[mailtaxiblogs]: http://ml.yandex-team.ru/lists/taxi-blogs/
[mailtaxidev]: http://ml.yandex-team.ru/lists/taxi-dev/
[mailtaxicron]: http://ml.yandex-team.ru/lists/taxi-cron/
[mailtaxicommits]: http://ml.yandex-team.ru/lists/taxi-commits/


## Форматирование кода (нужен пакет [taxi-deps-py3](https://github.yandex-team.ru/taxi/deps-py3#installation))

* `make format` - форматирование всех файлов в репозитории
* `make smart-format` - форматирование только измененных файлов в репозитории
