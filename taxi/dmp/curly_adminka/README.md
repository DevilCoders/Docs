## curly adminka

**Мотивация:** пакет призван упростить или предоставить альтернативный способ создание скриптов в [админке](https://tariff-editor.taxi.yandex-team.ru/dev/scripts).

По задумке авторов админки, основной способ создания скрипта - через графический интерфейс (веб-морду), однако, за фасадом ГУя спрятано обращение по http-протоколу, которое и предлагается использовать через CLI.

Все аргументы, которые можно определить в ГУ-интерфейсе,- можно определить и посредством пакета curly_adminka.

Название пакета намекает, что взаимодействие с админкой будет происходить посредством условного курла (в противовес веб-морде).

**Для начала использования нужно:**
 - установить данный пакет: `pip3 install git+https://github.yandex-team.ru/taxi-dwh/curly_adminka.git`
 - получить персональный [oauth-token](https://wiki.yandex-team.ru/taxi/backend/Adminka-bez-koda/?from=%252Fusers%252Fmvpetrov%252Fadminka-bez-koda%252F#oauth)
 - определить конфигурацию (см.далее)
 - воспользоваться консольной утилитой для создания скрипта в админке, например: `adminka --help`

**Конфигурирование создаваемого скрипта:**

 Параметры создаваемого скрипта собираются из следующих источников (совпадающие ключи предыдущего источника затираются последователем):
 1. конфигурационный файл из домашней папки `~/.curly_adminka.yaml` (создает пользователь по своему усмотрению на основе шаблона config_default.yaml, ищи в корне репозитория)
 2. конфигурационный файл, определенный пользователем в качестве опции командной строки
 3. аргументы командной строки (самый высокий приоритет)

примечание: возможно полезной покажется коллекция аргументов запуска (куча стартовавших ранее скриптов, гарантий и поддержки не предполагается) https://paste.yandex-team.ru/1303328

**Токенизация аргументов:**

В интерфейсе админки необходимо позаботиться о том, чтобы разбивать передаваемые аргументы по строкам (один аргумент = одна новая строка), эту логику необходимо соблюсти и здесь.

Реализованы следующие способы:
 - утилитой click: предпочтительный способ, применяется всегда, если аргументы переданы через командную строку. деление осуществляется согласно правилам linux: по пробельным символам, совокупность инструкций, заключенная в кавычки, рассматривается, как единое целое
 - утилитой shlex: применяется при передаче аргументов через конфигурационный yaml. поведение аналогично утилите click
 - если в конфигурационном файле аргументы заданы списком, то никаких манипуляций над ним совершено не будет: считаем, что пользователь самостоятельно выполнил эту работу

**Особенности:**
 - пакет можно использовать только на локальной машине (по причинам, обусловленным безопасностью, доступ с девелоперских машин в продакшн-админку невозможен)
 - аргумент `url`: при создании скрипта через ГУИ нужно самому получить хэш свежего коммита в адресе модуля (о чем большинство пользователей регулярно забывает); curly_adminka делает это автоматически, достаточно указать адрес в формате `taxi_dmp_taxi_etl/migrations/TAXIDWH-4458.py` (допустимы и другие способы, подробнее см. curly_adminka.git_helper.format_module_name)
 - `request_id`: для предотвращения создания скриптов с одними и теми же аргументами на стороне админки реализован следующий механизм: фронтенд по своим внутренним правилам генерирует уникальный ключ (по виду, MD5), который передает бэкенду в теле основного запроса. бэкенд, получив ключ, который уже видел, игнорирует запрос и отвечает, что скрипт уже создан ранее; в противном случае - скрипт будет создан; в пакете curly_adminka реализована эмуляция поведения фронтенда: передаваемые аргументы складываются в строку, от которой берется хэш MD5, этот хэш считаем уникальным ключом. В случае необходимости пересоздать скрипт с теми же параметрами, что ранее, необходимо запустить утилиту с ключом `--force` (замечено: через какое-то время (сутки?) бэкенд перестает учитывать ранее виденный `request_id` и отдавать ошибку)

**Использование (entry_point=adminka):**
 - ```adminka --ticket=TAXIDWH-1366 --comment="DO NOT OKAY PLEASE!" -- python taxi_dmp_taxi_etl/dmp_cli.py run std python 'some.module --some_argument' 'some.other.module --some_other_argument'```
 - обратите внимание: установлена обязательная структура позиционных аргументов: `execute_type url arguments`. такая реализация предполагает, что скрипт может разрабатываться/тестироваться за рамками утилиты curly-adminka (например, в рамках dmp-cli), а затем строка запуска будет скопирована без неизменной, но с добавлением префикса `adminka`
 - если необходимо создать пачку скриптов одинаковых по всем параметрам, кроме аргументов, то можно так: ```cat some_file | xargs -I{} adminka --ticket=TAXIDWH-1366 --comment="DO NOT OKAY PLEASE!" -- dmp-runner taxi_dmp_taxi_etl/dmp_cli.py run std task {}``` (подразумевается, что some_file построчно содержит в себе некие таски; помните про обязательную структуру позиционных аргументов)
 - если вынести вообще все аргументы в конфигурационный файл, то можно просто: `adminka`
 - предполагается, что на практике будет использоваться какой-то комбинированный вариант: статичные параметры хранятся в конфиге, активно меняющиеся - передаются из командной строки
