# dwh-migrations
Миграции, исторические пересчеты и т.п.

**Важно**

- Мы должны создавать скрипты в админке с типом запускаемого скрипта `dmp-runner`! `psql`, `python` работает только для бекенда, но не для нас:
  `python` не поддерживает вложеные сервисы (meta_etl катается в кондукторной группе taxi_dmp_chef_elt) и запускает все под пользователем `root` вместо `www-data`;
  `psql` - использует предустановленные бэкендовские коннекты.
- Стандартные действия выполняются с помощью dmp cli. Если какой-то кастомный скрипт используется часто и в нескольких группах, то его стоит добавить в cli.

**Единый CLI**

- все скрипты со стандартными операциями переехали в `dmp_suite.cli`
- точка вызова cli в dwh-migrations -- `taxi_dmp_***_etl/dmp_cli.py`, для вложенных сервисов `taxi_dmp_chef_etl/***_etl/dmp_cli.py` 
- полная документация по возможностям cli в админке находится в [taxi-dwh/dwh-cli-doc > Prod CLI](https://pages.github.yandex-team.ru/taxi-dwh/dwh-cli-doc/tools_prod.html)
- если нужно указать путь до файла (например, для sql-запроса), указывается полный путь от корня репозитория

Код: [taxi-dwh/dwh > dmp_suite/dmp_suite/cli](https://github.yandex-team.ru/taxi-dwh/dwh/tree/develop/dmp_suite/dmp_suite/cli)


**Примеры комманд CLI**

- запуск какой-либо загрузки: `taxi_dmp_***_etl/dmp_cli.py run std` или `taxi_dmp_chef_etl/***_etl/dmp_cli.py`
- запуск `sql`: `taxi_dmp_***_etl/dmp_cli.py run sql`
- операции `yt`: `taxi_dmp_***_etl/dmp_cli.py yt`


## Структура репозитория

Верхняя папка, например, ``taxi_dmp_taxi_etl``, папка соответствует 
кондукторной группе, на машинках которой будет выполнен скрипт из этой папки.

Для ``taxi_dmp_taxi_etl`` это - https://c.yandex-team.ru/groups/taxi_dmp_taxi_etl.

Группы (продакшен):
- ``taxi_dmp_atlas_etl`` - Атлас
- ``taxi_dmp_taxi_etl`` - Такси
- ``taxi_dmp_eda_etl`` - Еда
- ``taxi_dmp_chef_etl`` -  Шеф + Мета


Структура внутри:
- ``dmp_cli.py`` - cli c командами для частого использования
- ``migrations`` - "одноразовые" скрипты, чаще всего делаются в рамках 
какого-либо тикета. Структура тут пока на усмотрение разработчика 

В директорию ``deprecated`` переносятся директории кондукторных групп выведенных из эксплуатации. 

## Запуск и согласование

Скрипты запускаются через админку бекенда: https://tariff-editor.taxi.yandex-team.ru/dev/scripts

В URL скрипта надо вставить ссылку на файл из определенного коммита master'а. 
Это требование аудита - нужно иметь однозначное понимание того, какой код был 
выполнен на проде.

> Как быстро получить ссылку на файл с хэшом коммита:
> 1. перейти на нужный файл в интерфейсе Github
> 2. нажать ``y``
> 3. скопировать ссылку из адресной строки браузера
> 4. Профит! 

Для запуска нужно собрать 2 аппрува: от разработчика и от менеджера(удобнее через чатик "TAXI DWH Im OK"). Админка 
гарантирует, что скрипт после аппрува будет запущен строго 1 раз. Подробнее про 
возможности админки можно почитать тут: https://wiki.yandex-team.ru/taxi/backend/architecture/scripts/.

Один и тот же скрипт можно запустить несколько раз с одинаковыми или разными 
аргументами. Аргументы передаются как аргументы командной строки.

Скрипты запускаются в виртуальном окружении из репозитория: https://github.yandex-team.ru/taxi-dwh/dwh.
Т.е. доступны все библиотеки, ``loader``-ы, ``settings`` и прочее.

Права для запуска и аппрува: https://idm.yandex-team.ru/system/taxiadmin/.

## Запуск стандартных загрузок

Для запуска стандартных загрузок следует использовать ``dmp_cli.py run std``: 
- запускает все под роботом, а не под root
- можно запускать загрузку как sh скрипт, так и питонячий модуль напрямую
- можно передавать аргументы загрузки (и для shell и для python)
- дефолтно ждет лока 1 час, если он занят

### Примеры использования в админке

Запуск одного python модуля с блокировкой и с аргументами:
```
run
std
python
-l 
raw_mdb_orders
layer.yt.raw.mdb.orders --start_date=2018-05-01 --end_date=2018-05-01
```

Запуск нескольких python модулей с блокировкой только для второго скрипта и с аргументами:
```
run
std
python 
-l 
None raw_mdb_orders2
layer.yt.raw.mdb.orders --start_date=2018-05-01 --end_date=2018-05-01
layer.yt.raw.mdb.orders2 --start_date=2018-05-01 --end_date=2018-05-01
```

Запуск shell скрипта с аргументами
```
run
std
sh
raw_mdb_orders 2018-05-01 2018-05-01
raw_mdb_orders2 2018-05-01 2018-05-01
```

Запуск "таска" с блокировкой (где eda_etl.layer.yt.ods.food.bigfood.brand.loader - python module, а task - название атрибута модуля с инстансом таски)
```
run
std
task
--lock-names
ods_eda_bigfood_brand
eda_etl.layer.yt.ods.food.bigfood.brand.loader.task
```

Больше примеров: [taxi-dwh/dwh-cli-doc > Prod CLI > run std](https://pages.github.yandex-team.ru/taxi-dwh/dwh-cli-doc/tools_prod.html#dmp-cli-run-std)

Как это выглядит в админке

![Run standard loader](doc/img/run_loader.png)

Каждый аргумент пишется с новой строчки, т.к. аргументы могут содержать пробелы
(например, в стандартных загрузках имя локов через пробел или имя загрузки со 
всеми аргументами через пробел -- это один аргумент для `run std`).


## Особенности и/или открытые вопросы

1. Скрипты созданные с `python` вместо `dmp-runner` запускаются из под ``root``, если они делают какие-либо файлы, 
которые потом могут быть использованы в рамках регулярных процессов, то это 
может привести к проблемам.
2. ...
