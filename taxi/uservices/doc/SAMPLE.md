# Проекты-примеры

Пример `userver-sample` расположен в директории `services`.

## userver-sample

Пример содержит демонстрацию трёх возможностей:
- эхо-ручка - возвращает переданные ей аргументы и значения по пути `/echo` в теле ответа в виде Json.
- Redis - ручка, которая сохраняет в Redis переданные ей аргументы и значения по пути `/redis-set`
и получает их по пути `/redis-get`, формируя Json в теле ответа.
- Mongo - ручка, которая сохраняет в MongoDB переданные ей аргументы и значения по пути `/mongo-set`
и получает их по пути `/mongo-get`, формируя Json в теле ответа.
- Flatbuf - ручка, которая демонстрирует работу с FlatBuffers. По пути `/sum` в теле запроса передается
структура `InputType` с двумя полями `arg1` и `arg2`, в теле ответа структура `ResultType` с полем `sum`
и значением суммы переданных аргументов.

Пример:

```
# Следующая команда собирает и запускает сервис-пример в тестовом окружении
$ make start-userver-sample
# Эхо-сервис
$ curl 'localhost:1180/echo?hello=world&foo=bar'
>> {"foo":"bar","hello":"world"}
# Работа с Redis
$ curl 'localhost:1180/redis-set?hello=world&foo=bar'
$ curl 'localhost:1180/redis-get?hello=1&foo=1'
>> {"foo":"bar","hello":"world"}
# Работа с MongoDB
$ curl 'localhost:1180/mongo-set?hello=world&foo=bar'
$ curl 'localhost:1180/mongo-get?hello=1&foo=1'
>> {"foo":"bar","hello":"world"}
```

# Структура проекта микросервиса

Рассмотрим структуру микросервиса на основе проекта `echo`.

## CMakeLists.txt

Файл сборки проекта, вызывает функцию `create_service`. Оставить без изменений.

## src/main.cpp

Файл является точкой входа сервиса и содержит регистрацию необходимых компонентов, которые будут использоваться в дальнейшем.
Файл `main.cpp` из проекта echo содержит минимально необходимый набор компонентов. Краткое описание:
- `Logging` - поддержка логирования
- `Tracer` - поддержка OpenTracing
- `Secdist` - секреты (ключи, пароли)
- `StatisticsStorage` - сбор статистики
- `Server` - связующий компонент
- `TestsuiteSupport` - нужен для инвалидации кешей (в тестах)
- `Mongo` - клиент доступа к MongoDB. Поскольку может потребоваться доступ к разным базам, компоненту передаётся имя секции конфига для инициализации
- `TaxiConfig` - конфиг динамических параметров сервиса
- `HttpServerSettings` - параметры для HttpServerBase
- `Echo` - пользовательский обработчик (его реализация находится в `src/handlers`)
- `TestsControl` - поддержка тестов
- `Ping` - обработчик `/ping`
- `ServerMonitor` - обработчик запроса статистики

Доступ к компонентам из других компонентов осуществляется с помощью вызова метода `components::ComponentContext::FindComponent<T>()`
, где `T` - имя класса нужного компонента.

## src/handlers/

В этой директории располагаются файлы реализации компонента-пользовательского обработчика. В примере `echo` имеется реализация класса `echo::handlers::Echo`,
который служит обработчиком пути `/echo`.
Для возможности быть обработчиком класс должен наследоваться от компонента `server::handlers::HttpHandlerBase` и переопределять его следующие методы:
- `HandlerName` - имя обработчика для логов. Обязательно возвращать содержимое `kName`.
- `HandlerRequestThrow` - тело пользовательского обработчика. Может бросать исключения в случае ошибок.

Также в классе имеется обязательная специальная строковая константа `kName`, которая определяет имя компонента в конфиге для инициализации (см. ниже).

## configs/

Здесь располагаются основные файлы конфигурации для разных видов сборок:
- `config.yaml` - основной конфиг.
- `config_dev.yaml` - конфиг для разработки, используемый по умолчанию при ручном локальном запуске.

Некоторые параметры конфига вынесены в файл переменных для их раздельного конфигурирования под разные окружения.
Файл переменных указывается в основном конфиге.
В проекте имеется несколько файлов переменных, все они начинаются с имени `config_vars.*`.

`secdist_dev.json` хранит ключи и секреты для окружения разработчика.

### Конфигурационный файл сервиса

По умолчанию сервис использует в качестве конфига файл `config_dev.yaml`, расположенный в рабочей директории.
Можно задать другой файл конфига с помощью параметра `--config`.

В продакшне используется файл `config.yaml`, который помещается при установке пакета в `/etc/yandex/taxi`.

### Структура конфига

Конфиг описывается в формате YAML. В нём присутствуют параметры подстановки (начинаются с символа `$`).
Они вычитываются из файла переменных, указанного в поле `config_vars`.
Параметры подстановки используются следующим образом:
```
param_name : $config_param
param_name#fallback : <default_value>
```
В примере значение параметра `param_name` необходимо считать из файла переменных. Если это значение отсутствует, то вместо него используется `<default_value>`,
указанное в `param_name#fallback`.

### Описание компонентов

Компоненты описываются в секции `components` конфига.
Http-ручки являются обычными компонентами и настраиваются в конфиге наряду с другими компонентами.
Ручка для примера `echo` имеет имя `handler-echo`, заданное компоненту `echo::handlers::Echo` в константе `kName`. У неё три параметра:
- `path` - определяет путь в запросе (напр., `/echo` для `localhost:1180/echo`).
- `task_processor` - имя исполнителя задач (TaskProcessor); позволяет исполнять разные ручки в разных пулах корутин, чтобы одни ручки не мешали другим.
- `parse_args_from_body` - если задано `true`, то содержимое парсится как дополнительный набор аргументов.

## testsuite/tests_<имя_сервиса>/

Имя директории с тестами должно начинаться префиксом `test`. Тесты для сервиса базируются на модуле `testsuite`, который использует `pytest`.
Базовый набор файлов для теста включает:
- `__init__.py` - пустой файл для создания пакета Python.
- `conftest.py` - файл конфигурации пакета тестов, о нем можно почитать в `pytest`. Файл генерируется из шаблона и импортирует содержимое модуля <имя_сервиса>_plugins.
Последний модуль генерируется автоматически и содержит в себе стандартные фикстуры для работы с mongo или postgre. Также в нем генерируется объект-фикстура с именем taxi_<имя_сервиса>,
который впоследствии передаётся аргументом в функции тестирования.

- `test_<name>.py` - файл с тестами, который должен начинаться префиксом `test`. Все тесты в файле представляют собой функции, также начинающиеся префиксом `test` и принимающие
фикстуру с именем taxi_<имя_сервиса>. Эта фикстура создается в процессе кодогенерации и импортируется в файле conftest.py.

# Создание нового микросервиса

За основу можно взять пример эхо-сервера. Все файлы, содержащие в имени название проекта, должны быть переименованы.

## src/main.cpp

Переименовать компонент `handlers::Echo`, добавить недостающие компоненты (напр., `Redis`).

## src/handlers/

Переименовать класс обработчика, расширить его при необходимости. Задать имя `kName`, которое будет использоваться в конфиге.

## configs/

### config_dev.yaml

Необходимо изменить:
- формат лога по пути `components_manager.components.loggers.access-tskv.pattern`
- имя компонента пользовательского обработчика и путь к нему

### config.yaml

Необходимо изменить:
- путь к файлу переменных в `config_vars` (обычно достаточно заменить часть пути с именем проекта после `/etc/yandex/taxi/` на `${PROJECT_SHORT_NAME}` из `CMakeLists.txt`)
- размещение файлов лога:
    - `components_manager.components.loggers.default.file-path`
    - `components_manager.components.loggers.access.file-path`
    - `components_manager.components.loggers.access-tskv.file-path`
- формат лога по пути `components_manager.components.loggers.access-tskv.pattern`
- имя компонента пользовательского обработчика и путь к нему
