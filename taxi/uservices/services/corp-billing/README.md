# Биллинг b2b-платформы

## Виды аккаунтов

Биллинг b2b опирается на счета (аккаунты) Биллинга Такси. Про аккаунты можно
прочитать на вики:
- https://wiki.yandex-team.ru/taxi/backend/billing/billing-accounts/
- https://wiki.yandex-team.ru/taxi/backend/billing/Kakie-external-entity-id-ispolzovat/

Счета b2b-клиентов (а также их сотрудников):
- Типы entity (**попросить биллинг завести `entity_kind`s: `b2b_client`,
  `b2b_client_department`, `b2b_client_employee`**):
  - `corp/b2b_client/<client.external_ref>`
  - `corp/b2b_client_employee/<employee.external_ref>`
- Типы agreement:
  - Для контроля бюджета (доступно только для `b2b_client_employee`):
    - `eats/YYYY-MM`
  - Для общего учёта потреблённых услуг:
    - `eats/orders` - можно получить ответ на вопрос "сумма потреблённых
      услуг в период [T1, T2]". **Только такого вопроса нет, назначение
      счёта непонятно, возможно, надо выпилить.**
- Типы `sub_account`:
  - payment - сумма услуги без НДС
  - payment/vat - НДС

Примеры всех типов счетов:

    corp/b2b_client/{id}          | eats/orders  | RUB | payment
    corp/b2b_client/{id}          | eats/orders  | RUB | payment/vat

    corp/b2b_client_employee/{id} | eats/orders  | RUB | payment
    corp/b2b_client_employee/{id} | eats/orders  | RUB | payment/vat
    corp/b2b_client_employee/{id} | eats/2019-10 | RUB | payment
    corp/b2b_client_employee/{id} | eats/2019-10 | RUB | payment/vat

Открытые вопросы:
- Нужно ли учитывать географию в бюджетах и вообще в agreements?
  - Компенсация за Еду в Москве 9к, в Екб 6к. Можно закрепить за
    сотрудником лимит (группа "Москва", группа "Екб") и сравнивать
    с ним, для этого не нужны отдельные счета.
  - Если будет международный клиент с одним аккаунтом, надо как-то
    решать вопрос отчётности, бюджетов и налогов в разных странах с
    одной валютой (Финляндия и Литва, например).
    - Для таких клиентов можно заводить по b2b-аккаунту в каждой
      стране, это разом решает все вопросы (кроме отсутствия общей
      отчётности, если она нужна).
    - Для контроля бюджета можно заводить группы лимитов как в
      примере с Москвой и Екб выше, назначая каждому департаменту
      какую-то уникальную группу.
    - Для отчётности не факт что вообще нужно учитывать страну.
    - Для налогов, если не отдельные аккаунты, остаётся только
      добавлять страну в структуру счетов.
- Как Биллинг будет получать операции для tlog?
  - Как будто могут просто брать операции со счёта клиента
    `corp/b2b_client/{id} | eats/orders | * | *`.
  - Только к распоряжению надо добавлять какой-нибудь `external_ref`
    договора (для "Команды Яндекс.Такси" тоже что-нибудь явно
    передавать).
- Нужен ли agreement `eats/orders`? Для чего? Если только для tlog,
  возможно, нужен какой-то специальный счёт.


## Виды распоряжений

Пока только одно - "измени балансы счётов датой `event_at`". При этом
предыдущая версия транзакции откатывается.

См. выше - есть открытый вопрос про tlog.


## Авторизация операций

Пока проверяем только бюджетные счета сотрудников b2b-клиентов.
Получаем траты по бюджетному счёту и смотрим, сколько ещё осталось
от лмита. Если хватает на оплату услуг, авторизуем, иначе запрещаем.


## TODO:
- Пробросить `customer_sum` и `performer_sum` в мету распоряжения.
- Попросить биллинг завести `entity_kind`s: `b2b_client`,
  `b2b_client_department`, `b2b_client_employee`.
- Вынести в сервисы:
  - tariffs
  - калькулятор
- Вынести в библиотеки:
  - vats
  - countries (список стран, у нас оставить только список поддерживаемых
    стран и валют в этих странах)
  - currencies (список валют, у нас оставить только список
    поддерживаемых валют)
  - type money
- Преобразовать `service_type` в service + countries. Потому что сейчас
  играет роль "услуга в стране".
- Поддеражть:
  - Проверка действующих договоров
  - Проверка балансов предоплатных клиентов
  - Обещанные платежи для предоплатных клиентов, чтобы не игрались с порогами
  - Департаменты (их нет)
  - Бюджеты клиентов и департаментов
  - Локализацию временных лимитов (сейчас считаются по utc)
  - Лимиты по времени (с 10:00 до 12:00) и по зонам (выделить геометрию)
