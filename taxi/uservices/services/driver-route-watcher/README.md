# Driver-route-watcher
Сервис для отслеживания положения водителей на маршруте.

## Входы выходы
На вход получает:
- позиции водителей (из шины geobus, канал channel:yagr:position)
- команды start/stop:
  - по stq от сервиса processing (будет переделано на доставку через logbroker)
  - по ручкам /start-watch, /stop-watch

Выход:
- http ручка /timeleft - eta и текущая позиция на маршруте
- канал channel:eta шины geobus

## Что делает
Выполняет притягивание текущего положения водителя к маршруту и выдает eta и
позицию на этом маршруте.
Маршрут строится при наличии текущей координаты и конечной точки.
Конечные точки получаются из команд start и отменяются командами stop.
При отмене сверяются текущие отслеживаемые точки и ожидаемая отслеживаемая точка
в команде стоп, если точки не совпадают, зачит пытаемся сделать что-то не то и
отмена не происходит.

## Отслеживание нескольких точек
Возможно получение нескольких конечных точек от разных сервисов, но
отслеживается только одна. Какая именно из точек отслеживается определяется
конфигом DRIVER_ROUTE_WATCHER_SERVICES_PRIORITIES. Сервис определяется по tvm.
Если во время отслеживания приходит новая точка от более приоритетного сервиса,
то начинается отслеживаться эта новая точка.
Если во время отслеживания приходит новая точка от менее приоритетного сервиса,
то она запоминается и будет отслеживаться после завершения отслеживания текущей точки (в порядке приоритета если точек несколько)

## Отслеживание при неизвестной точке назначения
Можно указать нулевые координаты точки отслеживания, тогда будем считать что мы
не знаем куда едет водитель, но он куда-то едет по заданию от сервиса.
При этом не выполняется построений маршрутов, и прогнозов eta.
Соответственно данные не отправляются в шину eta.
Приоритеты точек все еще работают и не дадут отслеживать менее приоритетные
сервисы.

## Особености отслеживания заказов
Точки А и Б заказов (а также промежуточных точек) получаются через очереди stq:
- driver_route_watcher_new_destination
- driver_route_watcher_reset_destination
При этом сервис указывается одним из полей таски. Возможные значения поля
service таски stq:
- "processing:driving" - при движении водителя к точке А
- "processing:transporting" - при движении водителя к точке Б
- "processing" - при завершении заказа при этом поле source интерпретируется как
точка сервиса "processing:driving", а точки из поля "destinations" как точки
сервиса "processing:transporting"
Если заказ без точки Б, то:
Приходит таска из очереди driver_route_watcher_new_destination с пустым списком в "destinations"
В этом случае в обработчике мы генерируем destination с "неизвестной точкой назначения".
При получении таски из очереди driver_route_watcher_reset_destination в которой
только 1 точка (source), мы отменяем эту точку с сервисом "processing:driving" и
пытаемся отменить "неизвестную точку назначения" с сервисом "processing:transporting"

## Некоторые подробности внутренней реализации
На каждом инстансе сервиса есть несколько Worker-ов.
Каждый вокер обрабатывают и хранит свою часть водителей.
У каждого воркера есть mpsc-очередь сообщений и корутина которая разгребает эту очередь.

Для каждого водителя в Worker создается RouteWatcher который хранит RouteWatcherData и RouteWatcherFsm.

### Состояния fsm
1. WaitDataState - состояние в котором нехватает текущей позиции и/или точки
   назначения. Ожидаем точку назначения и текущую позицию водителя.
   Переходим в это состояние из любого при получении последнего StopWatchMessage
2. RouteRequestState - состояние в которое попадаем когда получаем и позицию и точку назначения.
   по завершении запроса генерурет сообщение RouteMessage или RouteFailedMessage
3. TrackingState - состояние когда получен маршрут (RouteMessage) в состоянии RouteRequestState.
   В этом состоянии происходит притягивание к текущему маршруту при получении
   новой позиции и обновление eta.
4. FalbackTrackingState - состояние когда по какой-то причине маршрут не получен (RouteFailedMessage).
   В этом состоянии не происходит притягивания к маршруту. Eta расчитывается по linear-router.
   По просшествии определнного конфигом DRIVER_ROUTE_WATCHER_RETURN_TO_TRACKING_TIMEOUT времени производится очередная попытка получить маршрут.
5. UnknownDestinationState - состояние в которое переходим если получаем
   "неизвестную точку назначения".
   В этом состоянии мы не вычисляем никакого Eta, а ждем завершения отслеживания
   неизвестной точки.
   Состояние нужно для реализации заказов без точки Б, что-бы как-то
   сигнализировать что водитель на заказе куда-то едет, и не будет ехать в
   указаные другими сервисами точки пока не отвезет клиента.
