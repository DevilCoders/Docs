
# Table of Contents

1.  [Слаг](#slug)
    1.  [Входные параметры](#slug-input-params)
        1.  [Пример запроса](#slug-example-request)
    2.  [Логика работы](#slug-logic)
        1.  [Поведение в случае если заведение недоступно по точке](#slug-unavailable-by-location)
    3.  [TODO](#slug-todo)
2.  [Расчет доступности заведения](#availability)
    1.  [Доставка](#availability-delivery)
        1.  [Доставка Еды](#availability-delivery-native-delivery)
        2.  [Доставка курьером заведения (маркетплейс)](#availability-delivery-marketplace)
        3.  [Костыли](#availability-delivery-cruches)
    2.  [Самовывоз](#availability-pickup)
3.  [Таймпикер](#timepicker)
    1.  [Алгоритм составления таймпикера](#timepicker-algorithm)
    2.  [Костыли](#timepicker-cruches)
    3.  [Едадень](#timepicker-edaday)
    4.  [Доставка](#timepicker-delivery)
    5.  [Самовывоз](#timepicker-pickup)
4.  [Резолв зон доставки](#resolve)
    1.  [Алгоритм](#resolve-algorithm)
5.  [Доставка](#delivery)
    1.  [Расчет времени доставки](#calc-delivery-time)
        1.  [Маркетплейс](#calc-delivery-time-marketplace)
        2.  [Лавка](#calc-delivery-time-lavka)
        3.  [Доставка Еды](#calc-delivery-time-native)
    2.  [Расчет стоимости доставки](#calc-delivery-fee)
    3.  [Сурж](#surge)
        1.  [Доставка такси](#surge-taxi-delivery)
        2.  [Найтивная доставка](#surge-native-delivery)
        3.  [Маркетплейс](#surge-marketplace)
        4.  [Taxi Undersupply](#taxi-undersupply)
6.  [Промоакции](#promos)
    1.  [Кеш](#promos-cache)
7.  [Яндекс.Плюс](#yandex-plus)
    1.  [Слаг](#yandex-plus-slug)
    2.  [Каталог](#yandex-plus-catalog)

-   [X] Расчет стоимости доставки
-   [X] Таймпикер
-   [X] Резолв зон доставки
-   [X] Сурж
-   [X] Расчет доступности заведения
-   [X] Яндекс.Плюс
-   [X] Расчет времени доставки
-   [X] Промоакции
-   [ ] Избранное


<a id="slug"></a>

# Слаг

Ручка `/eats-catalog/v1/slug/{slug}` (в старом каталоге
`/api/v1/catalog/{slug}`) возвращает данные об отдельно взятом заведении
и информацию о возможности, скорости и способе доставки из него.
Информация о заведении включает юридическую информацию о заведении -
его адрес, ИНН, юридическое лицо и прочие данные, которые каталог
получил из eats-catalog-storage (никакие дополнительные манипуляции с
этими данными не производятся). Так же возвращается информация о
расписании работы заведения, которая формируется в качестве текста на
основании интервалов работы заведения, которые попадают в текущие
сутки, по часовому поясу пользователя.

[Документация ручки](https://pages.github.yandex-team.ru/taxi/schemas/Taxi_Documentation/Uservices/eats-catalog/api/slug/#eats-catalogv1slugslug)


<a id="slug-input-params"></a>

## Входные параметры

Ручка принимает несколько параметров, которые влияют на результат
ее выдачи:

-   `slug` - предается в пути запроса и позволяет передать уникальный
    человекочитаемый идентификатор заведения.
-   `longitude`, `latitude` - опцианальные параметры запроса, которые
    позволяют передать гео позицию, в которую требуется доставить
    заказ из заведения.
-   `deliveryTime` - время, к которому требуется доставить заказ в
    формате RFC3339 (`2006-01-02T15:04:05+07:00`). Если значение не
    передано, то предполагается текущее время по серверу, если
    отправленное значение находится в прошлом, по времени сервера, то
    также будет использовано текущее время.
-   `shippingType` - способ доставки заказа может быть либо доставка
    (`delivery`), либо самовывоз (`pickup`). В случае если данный
    параметр не передан ручка предполагает, что запрос сделан со
    значением `delivery`.


<a id="slug-example-request"></a>

### Пример запроса

    curl \
    -H"x-ya-service-ticket: $SERVICE_TICKET" \
    -H"x-device-id: $X_DEVICE_ID" \
    -H"x-platform: $X_PLATFORM" \
    -H"x-app-version: 0.0.0" \
    --url "http://eats-catalog.eda.tst.yandex.net/eats-catalog/v1/slug/azbukavkusa_leningradskij_prospekt_52?latitude=55.73442&longitude=37.583948"

    {
      "payload": {
        "foundPlace": {
          "place": {
            "id": 134135,
            "name": "Азбука вкуса",
            "description": null,
            "slug": "azbukavkusa_leningradskij_prospekt_52",
            "market": false,
            "tags": [
              {
                "id": 39,
                "name": "Вегетарианская"
              },
              {
                "id": 599,
                "name": "Детское меню"
              },
              {
                "id": 27,
                "name": "Пироги"
              },
              {
                "id": 235,
                "name": "Завтраки"
              },
              {
                "id": 593,
                "name": "Выпечка"
              },
              {
                "id": 8,
                "name": "Русская"
              },
              {
                "id": 642,
                "name": "Продукты"
              }
            ],
            "priceCategory": {
              "id": 2,
              "name": "₽₽",
              "value": 0.5
            },
            "rating": 4.8,
            "ratingDescription": null,
            "ratingCount": "200+",
            "minimalOrderPrice": 0,
            "minimalDeliveryCost": 0,
            "isNew": false,
            "isStore": false,
            "currency": {
              "code": "RUB",
              "sign": "₽"
            },
            "items": [],
            "promos": [],
            "picture": {
              "uri": "/images/3529621/5e432f19abe14be8009e9343429b8d5e-{w}x{h}.jpg",
              "ratio": 1.33
            },
            "isPromoAvailable": false,
            "personalizationStrategy": null,
            "deliveryConditions": "Доставка и сборка 179–304 ₽",
            "previewDeliveryFee": "",
            "promoTypes": [],
            "type": {
              "id": 1,
              "name": "Ресторан"
            },
            "features": {
              "ecoPackaging": {
                "show": false
              },
              "delivery": {
                "isYandexTaxi": true
              },
              "badge": null,
              "favorite": null,
              "map": null,
              "yandexPlus": null
            },
            "business": "shop",
            "brand": {
              "slug": "azbukavkusa"
            },
            "address": {
              "location": {
                "latitude": 55.79728,
                "longitude": 37.541027
              },
              "short": "Ленинградский проспект, 52",
              "city": "Москва"
            },
            "promo": [],
            "sharedLink": "http://core.eda.tst.yandex.net/restaurant/azbukavkusa_leningradskij_prospekt_52?utm_campaign=web&utm_medium=referral&utm_source=rst_shared_link",
            "footerDescription": "Исполнитель (продавец): ООО \"Городской супермаркет\", 115054, ул. Валовая, д. 8/18, ИНН 7705466989, рег.номер 1027705012312.<br>Режим работы: с 00:00 до 24:00",
            "deliveryThresholds": [
              {
                "name": "на заказ до 499 ₽",
                "orderPrice": {
                  "min": 0,
                  "max": 499
                },
                "deliveryCost": 304
              },
              {
                "name": "на заказ 500-1999 ₽",
                "orderPrice": {
                  "min": 500,
                  "max": 1999
                },
                "deliveryCost": 254
              },
              {
                "name": "на заказ от 2000 ₽",
                "orderPrice": {
                  "min": 2000,
                  "max": null
                },
                "deliveryCost": 179
              }
            ],
            "availablePaymentMethods": [
              0,
              1,
              2,
              4
            ],
            "constraints": {
              "maximum_order_price": {
                "value": 6000,
                "text": "6000 ₽"
              }
            },
            "messages": {
              "thresholds": {
                "title": "Условия сборки и доставки",
                "footer": "В стоимость входит доставка и сборка заказа"
              },
              "constraints": {
                "title": "Лимиты"
              }
            }
          },
          "locationParams": {
            "deliveryTime": {
              "min": 40,
              "max": 50
            },
            "available": true,
            "distance": 7.487659153909531,
            "availableFrom": null,
            "availableTo": "2021-02-08T23:30:00+03:00",
            "eatDay": 0,
            "availableByTime": true,
            "availableByLocation": true,
            "availableSlug": null,
            "availableShippingTypes": [
              {
                "type": "delivery"
              }
            ],
            "prepareTime": {
              "readyAt": null,
              "minutes": 0
            },
            "availableNow": true
          },
          "surge": null
        },
        "availableTimePicker": [
          [
            "2021-02-08T18:00:00+03:00",
            "2021-02-08T18:30:00+03:00",
            "2021-02-08T19:00:00+03:00",
            "2021-02-08T19:30:00+03:00",
            "2021-02-08T20:00:00+03:00",
            "2021-02-08T20:30:00+03:00",
            "2021-02-08T21:00:00+03:00",
            "2021-02-08T21:30:00+03:00",
            "2021-02-08T22:00:00+03:00",
            "2021-02-08T22:30:00+03:00",
            "2021-02-08T23:00:00+03:00",
            "2021-02-08T23:30:00+03:00"
          ],
          [
            "2021-02-09T00:00:00+03:00",
            "2021-02-09T00:30:00+03:00",
            "2021-02-09T01:00:00+03:00",
            "2021-02-09T01:30:00+03:00",
            "2021-02-09T02:00:00+03:00",
            "2021-02-09T02:30:00+03:00",
            "2021-02-09T03:00:00+03:00",
            "2021-02-09T03:30:00+03:00",
            "2021-02-09T04:00:00+03:00",
            "2021-02-09T04:30:00+03:00",
            "2021-02-09T05:00:00+03:00",
            "2021-02-09T05:30:00+03:00",
            "2021-02-09T06:00:00+03:00",
            "2021-02-09T06:30:00+03:00",
            "2021-02-09T07:00:00+03:00",
            "2021-02-09T07:30:00+03:00",
            "2021-02-09T08:00:00+03:00",
            "2021-02-09T08:30:00+03:00",
            "2021-02-09T09:00:00+03:00",
            "2021-02-09T09:30:00+03:00",
            "2021-02-09T10:00:00+03:00",
            "2021-02-09T10:30:00+03:00",
            "2021-02-09T11:00:00+03:00",
            "2021-02-09T11:30:00+03:00",
            "2021-02-09T12:00:00+03:00",
            "2021-02-09T12:30:00+03:00",
            "2021-02-09T13:00:00+03:00",
            "2021-02-09T13:30:00+03:00",
            "2021-02-09T14:00:00+03:00",
            "2021-02-09T14:30:00+03:00",
            "2021-02-09T15:00:00+03:00",
            "2021-02-09T15:30:00+03:00",
            "2021-02-09T16:00:00+03:00",
            "2021-02-09T16:30:00+03:00",
            "2021-02-09T17:00:00+03:00",
            "2021-02-09T17:30:00+03:00",
            "2021-02-09T18:00:00+03:00",
            "2021-02-09T18:30:00+03:00",
            "2021-02-09T19:00:00+03:00",
            "2021-02-09T19:30:00+03:00",
            "2021-02-09T20:00:00+03:00",
            "2021-02-09T20:30:00+03:00",
            "2021-02-09T21:00:00+03:00",
            "2021-02-09T21:30:00+03:00",
            "2021-02-09T22:00:00+03:00",
            "2021-02-09T22:30:00+03:00",
            "2021-02-09T23:00:00+03:00",
            "2021-02-09T23:30:00+03:00"
          ]
        ]
      }
    }


<a id="slug-logic"></a>

## Логика работы

![img](img/slug.png)


<a id="slug-unavailable-by-location"></a>

### Поведение в случае если заведение недоступно по точке

В случае если заведение оказалось недоступным при первичном поиске
по слагу и фильтрации зон по гео позиции пользоваетеля, происходит
две вещи:

1.  Запрос в eats-catalog-storage, по бренду и точке, которым мы
    пытаемся найти доступное заведение того же бренда, слаг
    которого необходимо вернуть в ответе (в поле `availableSlug` в
    `locationParams` или аналогичном поле ошибки 404, в случае если
    заведения с переданным слагом не существует, правда не могу
    пока представить как может быть что мы найдем бренд
    неизвестного заведения).
2.  Каталог, по-прежнему, должен вернуть данные о заведении в
    ответе (если его удалось найти, но не удалось зарезолвить
    зону), где все поля-флаги доступности заведения имеют значение
    `false` и пустой таймпикер.


<a id="slug-todo"></a>

## TODO

-   Абсолютно непонятно почему мы предпочитаем вернуть
    availableSlug как слаг заведения, на которое нужно перенаправить
    пользоваетля вместо того чтобы вернуть ему данные доступного
    заведения прямо на той же странице. Тут скорее всего есть
    какая-то причина на фронте, и нужны доработки на ручке резолва,
    но хотелось бы разобраться.


<a id="availability"></a>

# Расчет доступности заведения

Расчет доступности заведения (availability) пытается определить
доступен ли заказ и доставка из заведения в выбранный момент времени
и если заказ доступен, то до какого момента времени он будет
доступен, а если недоступен, то с какого момента он станет
доступен. При этом найденное время, с которого доступен заказ
округляется вверх до ближайших 30 минут (13:32 -> 14:00), а время до
которого доступен заказ округляется вниз до ближайших 30 минут: это
делается для того чтобы времена совпадали с значениями в таймпикере.

Для расчета доступности заведения используется расписание указанное
на зонах доставки заведения - так как пользователь может
одновременно попадать в несколько зон, пред тем как определить
доступность заказа все расписания зон, в которые попадает
пользователь соединяются в одно, которое описывает реальное
расписание работы заведения в гео позиции пользователя.
В остальном расчет стоимости доставки представляет из себя поиск
интервала работы заведения, в который попадает текущее время или
время предзаказа (предзаказом считается время заказа, которое
отдалено от текущего больше чем на 15 минут).


<a id="availability-delivery"></a>

## Доставка


<a id="availability-delivery-native-delivery"></a>

### Доставка Еды

Доставка считается доступной в том случае если время заказа,
выбранное пользователем попадает в интервал работы заведения и при
это это время отдалено от текущего не больше чем на 48 часов и в
случае предзаказа проверяется, что выбранное время превышает
минимальное время, к которому возможна доставка заказа, исходя из
расчета дистанции между заведением и пользователем по прямой.


<a id="availability-delivery-marketplace"></a>

### Доставка курьером заведения (маркетплейс)

Расчет доступности для маркетплейсов ничем не отличается от
расчета доступности для доставки Еды за исключением того что для
маркетплейсов мы не добавляем длительность доставки к времени до
которого доступна доставка из заведения потому что считаем, что
курьер маркетплейса престает работать вместе с заведением.


<a id="availability-delivery-cruches"></a>

### Костыли

-   EDADEV-36376 ограничиваем время, до которого возможна доставка
    заказа текущим днем.


<a id="availability-pickup"></a>

## Самовывоз

Самовывоз из заведения считается доступным:

-   для ASAP текущее время попадает в интервал работы заведения;
-   для предзаказа, если время предзаказа удалено от текущего
    не больше чем на 3 часа и находится в тех же сутках. Для
    закрытого заведения используются все те же правила, за
    исключением того что время предзаказа должно попадать в интервал
    работы заведения.
-   если время, когда заказ будет готов удалено от времени конца
    работы заведения больше чем на 30 минут.


<a id="timepicker"></a>

# Таймпикер

Таймпикер представляет из себя массив времен, которые необходимо
передать на фронтенд чтобы отобразить список времен, на которые
пользователь может оформить предзаказ. В данном массиве всегда
присутствует строго 2 элемента: первый содержит времена для
сегодняшнего дня, второй для завтрашнего. Времена в таймпикере
разделяются между собой интервалом в 30 минут, по сути дела это
должен быть тот же самый интервал, до которого округляется время, с
которого доступно заведения и до которого доступно заведение при
расчете доступности, в противном случае возможна ситуация
предзаказа на время, которое недоступно в таймпикере.

    [
          [
            "2021-01-25T12:00:00+03:00",
            "2021-01-25T12:30:00+03:00",
            ...
            "2021-01-25T23:30:00+03:00"
          ],
          [
            "2021-01-26T00:00:00+03:00",
            "2021-01-26T00:30:00+03:00",
            ...
            "2021-01-26T23:30:00+03:00"
          ]
    ]


<a id="timepicker-algorithm"></a>

## Алгоритм составления таймпикера

Для того чтобы составить таймпикер для текущего запроса сначала
необходимо получить расписание всех доступных зон для данного
запроса - они являются основанием для составления
таймпикера. После получения расписаний они сортируются по
возрастанию и сжимаются таким образом чтобы получить минимальное
количество непересекающихся интервалов.
В качестве начального времени таймпикера всегда берется текущее
время по серверу, последнее время в таймпикере зависит от
выбранного в запросе способа получения заказа.


<a id="timepicker-cruches"></a>

## Костыли

-   [EDADEV-36625](https://st.yandex-team.ru/EDADEV-36625) в случае заведение недоступно и у него нет
    расписания в будущее, то есть таймпикер будет пустым, нужно
    заполнить таймпикер текущим временем по серверу для того чтобы
    не сломать клиент. Такая необходимость должна возникать только
    на слаге.


<a id="timepicker-edaday"></a>

## Едадень

Важной частью алгоритма построения таймпикера является Едадень
(без понятия откуда взялось это название). Едадень - это день для
пользователя - предполагается, что пользователю проще воспринимать
время доставки заказа как "сегодня" если заказ сделан поздно
вечером и будет доставлен в начале следующих суток. Например если
заказ сделан в 23:00 и доставят его в 00:30, то на каталоге нужно
отобразит время доставки как "сегодня в 00:30" вместо "завтра в
00:30".
Данная логика работает следующим образом - если текущее время по
серверу, в часовом поясе пользователя, больше 21:00 и меньше
00:00, то любое время до 06:00 в таймпикере или расчете времени
доставки должно отображаться как сегодня, для интервала с 00:00 по
21:00 сутки кончаются в полночь.


<a id="timepicker-delivery"></a>

## Доставка

Для доставки курьером в качестве ограничения таймпикера сверху
выступает конец следующего дня, то есть максимальное количество
значений в таймпикере бывает только в полночь, когда потенциально
между первым и последним временем в таймпикере содержатся времена в
интервале в 47 часов 30 минут.
Таймпикер для доставки не может начинаться раньше чем ближайшее
возможное время доставки заказа в найденных зонах.
Для доставки курьерами Еды таймпикер может заходит за верхнюю
границу расписания работы заведения, поскольку предполагаемая
доставка может быть осуществлена после закрытия, для маркетплейса
предполагается, что курьер заканчивает работать вместе с заведением
и таким образом не может доставить заказ после закрытия.


<a id="timepicker-pickup"></a>

## Самовывоз

Правила построения таймпикера для самовывоза отличаются от доставки
тем, что максимальная продолжительность таймпикера может ровняться
только трем часам и таймпикер самовывоза никогда не отображает
следующие сутки, то есть второй элемент пикера у него всегда
пустой.
NOTE: возможно имеет смысл вычитать из верхней границы работы
заведения максимальное время опоздания пользователя (30 минут)
чтобы обеспечить большую вероятность получения заказа.


<a id="resolve"></a>

# Резолв зон доставки

Резолв зон доставки - это операция производимая для каждого заведения
в выдаче каталога, которая позволяет выбрать из всех зон доставки, в
которые физически попадает пользователь только одну. Данные этой зоны
после резолва используются для определения типа курьера, который
доставит заказ, стоимости доставки заказа и минимальной стоимости
корзины.


<a id="resolve-algorithm"></a>

## Алгоритм

По своей сути алгоритм резолва зон доставки представляет из себя
сортировку, которая поднимает в вверх наиболее подходящую зону
заведения и опускает вниз менее подходящие, после чего выбирается
первая зона.
Ранжирование происходит по следующим полям (в порядке приоритетности):

1.  Способ доставки. Предпочитается тот способ доставки (курьерская
    доставка или самовывоз), с которой пользователь пришел на каталог.
2.  Время до открытия заведения в данной точке - для зон, в которых
    заведение открыто время до открытия считается за 0.
3.  Тип курьера. Предпочтение отдается в пользу любого типа курьеров,
    кроме такси, что позволяет показывать доставку такси только в том
    случае если заведение закрыто во всех остальных зонах, все
    остальные зоны выключены или просто отсутствует.
4.  Предположительное время доставки. Важно заметить, что это не то же
    самое время, которое используется для отображения времени доставки
    на выдаче, а фиксированное значение заданное в админке для каждой
    отдельной зоны.
5.  Минимальная стоимость доставки. Предпочитается зона, у которой
    наименьшая минимальная стоимость доставки, без учета суржа или
    расчета стоимости сервисом eda-delivery-price.
6.  Минимальная корзина. Предпочитается зона с наименьшей минимальной
    стоимостью корзины.

В случае если все вышеперечисленные поля оказались равны для двух и
более зон, то предпочтение отдается той, у которой наименьший
идентификатор, что позволяет сохранять консистентность результатов
резолва для одной точки.


<a id="delivery"></a>

# Доставка


<a id="calc-delivery-time"></a>

## Расчет времени доставки

Расчет времени доставки позволяет определить примерное время, к
которому пользователь может получить свой заказ из выбранного
заведения.
В подавляющем большинстве случаев время доставки рассчитывается с
помощью ML: ручкой `umlaas-eats/v1/catalog` для первых N заведений в
выдаче каталога или ручкой `plotva-ml-eats/eats/cart_eta/v1` для
выдачи слага, в случае если не удалось рассчитать время доставки с
помощью ML или заведение не попало в первые N заведений, то расчет
времени производится по одному из следующих алгоритмов.


<a id="calc-delivery-time-marketplace"></a>

### Маркетплейс

Для маркетплейсных заведений расчет времени доставки не
производится - в качестве времени доставки используется значение,
которое заведение самостоятельно указывает для каждой зоны
доставки, к которому добавляется среднее время готовки заказа и
дополнительное время готовки заказа. Время доставки заказа может
быть увеличено в случае суржа.


<a id="calc-delivery-time-lavka"></a>

### Лавка

Время доставки для Лавки фиксировано для всех случаев кроме
доставки Такси, время для которой рассчитывается по правилам
расчета для найтивной доставки. Фиксированное время доставки для
Лавки содержится в кеше настроек региона, который заполняется из
ручки коры `/server/api/v1/export/settings/regions-settings`.


<a id="calc-delivery-time-native"></a>

### Доставка Еды

Расчет времени доставки курьером Еды или Такси производится исходя
из расстояния между заведением и клиентом, рассчитанным по прямой,
скорость курьера содержится в кеше ручки коры
`/server/api/v1/export/settings/couriers-stats`, которая возвращает
скорость для разных типов курьеров, в зависимости от расстояния,
которое курьеру нужно преодолеть, пример ответа ручки:

    {
        "electric_bicycle": {     # тип курьера - электровелосипед
            "nearby": {
                "distance": 0.1,  # минимальная дистанция
                "tempo": 12,      # скорость курьера
                "fixTime": 1      # фиксированное время, которое добавляется к доставке
            },
            "near": {
                ...
            },
            "far": {
                ...
            },
            "faraway": {
                ...
            }
        }
    }

Полная формула расчета времени доставки:
`round(distance_km) * tempo + fixTime + avg_preparation + extra_preparation`

-   `distance_km` - расстояние между заведением и клиентом по прямой.
-   `tempo` - скорость курьера из ручки курьерских настроек, зависит
    от того насколько далеко клиент от заведения и какой тип курьера
    закреплен за зоной доставки, в которую попал клиент.
-   `avg_preparation` - среднее время готовки заведения.
-   `extra_preparation` - добавочное время доставки, указанное
    заведением.

Время доставки никогда не может быть меньше 15 минут так как это
минимальное возможное время готовки, которое допустимо в
eats-catalog.

Рассчитанное время найтивной доставки можно увидеть в INFO логе
eats-catalog с сообщением начинающимся с `delivery time:`


<a id="calc-delivery-fee"></a>

## Расчет стоимости доставки

Расчет стоимости доставки имеет несколько этапов каждый из которых
переопределяет или модифицирует предыдущий:

1.  Резолв зоны доставки позволяет получить трешхолды, которые
    позволяют определить стоимость доставки для определенной
    стоимости корзины - данные трешхолды хранятся вместе с данными о
    зоне доставки в eats-catalog-storage, из которого eats-catalog
    получает данные.
2.  Получение суржа и условий доставки (трешхолдов) из сервиса
    eda-delivery-price. Сурж может переопределить стоимость доставки для
    нашей доставки (курьеры Еды/Таксисты), а для лавки установить минимальную
    стоимость корзины (сумма цен всех позиций), начиная с которой можно сделать
    заказ.
3.  Ограничение стоимости доставки максимальной суммой из настроек
    региона.

![img](img/calculate-delivery-cost.png)


<a id="surge"></a>

## Сурж

Сурж представляет из себя механизм позволяющий ограничивать спрос на
заказ из заведения, используемый, в основном, в случаях, когда
наблюдается нехватка курьеров, способных доставить заказ из
заведения. Для разных типов заведений сурж оказывает разный эффект,
на некоторых он может быть отключен с помощью опции **ignore_surge**,
которая настраивается в админке Еды для бренда.
Сурж возможен только в том случае если пользователь собирается
сделать заказ с доставкой ASAP (на время удаленное от текущего не
более чем на 15 минут).

Так как сурж расчитывается исходя их времени, в которое был сделан
запрос, существует большая вероятность, что при повторных запросах
к ручкам каталога пользователь будет получать разное значение
суржа, для того чтобы избежать подобных проблем используется сервис
eats-offers. Сервис eats-offers хранит в себе "оффер" для каждой
отдельной сессии пользователя, который меняется только в случае
изменения основных параметров поиска (локация или время доставки),
таким образом данный оффер представляет из себя наиболее надежный
источник информации о том когда пользователь впервые увидел выдачу,
которая в данный момент запрашивается у каталога (время создания
оффера по сути дела равно времени первого запроса пользователя)
поэтому время создания оффера используется для запроса суржа.

<a id="surge-taxi-delivery"></a>

### Доставка такси

Заведения, для которых была зарезолвлена зона доставки, на которой
работает доставка Такси так же не участвуют в расчете суржа
заведения, Такси имеет свой механизм суржа (см. Taxi Undersupply)


<a id="surge-native-delivery"></a>

### Нативная доставка

Для доставки силами курьеров Еды сурж проявляется в виде надбавки
за доставку заказа - в зависимости от интенсивности недостатка
курьеров увеличивается или уменьшается стоимость доставки
заказа. Для пользователя, в таком случае, отображается сообщение,
которое сообщает о том, что доставка из данного заведения будет
платная, на каталоге, на карточке заведения, отображается значок
суржа.

Для того чтобы не получилось такого что стоимость доставки не
выходит за пределы разумного на регионах существует настройка,
которая ограничивает максимальную стоимость доставки курьерами Еды
и отдельно максимальную стоимость доставки курьерами Такси, оно
должно применяться после суржа и запроса стоимости доставки.

1.  Яндекс.Лавка

    В Лавке доставка исторически была бесплатная (кроме случаев, когда
    доставка осуществляется Такси) поэтому, несмотря на то что
    доставка Лавки тоже найтивная, сурж не может проявляться в виде
    надбавки за доставку заказа, вместо этого сурж Лавки увеличивает
    минимальную стоимость корзины для создания заказа, а вместе с этим
    модифицирует все условия доставки таким образом чтобы не было
    возможности сделать заказ за сумму меньшую чем стоимость из суржа.


<a id="surge-marketplace"></a>

### Маркетплейс

Для маркетплейса сурж проявляется в качестве надбавки ко времени
доставки в процентах, это очень странная логика, которую никто до
конца не понимает, но она существует.


<a id="taxi-undersupply"></a>

### Taxi Undersupply

Undersupply представляет из себя механиз, который позволяет
отключать на заведении возможность заказа с доставкой Такси в случае
если наблюдается недостаток в курьерах Такси.
**Данная фича еще не до конца реализована и используется только на
каталоге.** В будущем предполагается, что сурж будет возвращать
данные о недосаплае Такси и тогда заведение будет помечаться как
недоступное в выдаче.


<a id="promos"></a>

# Промоакции

Промоакции необходимы в каталоге для отображения активных промок и
для некоторых видов фильтрации. Промоакции на каталоге зависят от
времени доставки и наличия суржа на момент запроса - это два
фактора, которые могут изменить видимость промоакции.

В данный момент нет возможности делать запрос на получение
промоакций в рантайме ручки так как это создает слишком большую
нагрузку на сервис `eats-core`, поэтому было принято решение
кешировать промоакции на стороне `eats-catalog`.


<a id="promos-cache"></a>

## Кеш

Кеш представляет из себя простой full-update-only кеш поверх ручки
коры `/server/api/v1/promo/active`, который обновляется с регулярным
интервалам запрашивая постранично все активные промоакции.
Для некоторых промоакции ручка присылает флаг `disabled_by_surge`,
который сообщает, что промоакция не должна быть отображена в случае
если заведение суржит.
В данных момент `eats-catalog` запускается не дожидаясь наполнения
кеша промоакций, но при запуске в прод должен дожидаться, для того
чтобы минимизировать вероятность "мигания" промоакций при
перезапросах каталога.


<a id="yandex-plus"></a>

# Яндекс.Плюс

На каталоге отображается информация о доступности и значении
кеэшбека Яндекс.Плюс при заказе из заведения. Единственным
ограничением для запроса кэшбека в ответе ручек `eats-catalog`
являяется наличеие заголовка `x-yandex-uid` во входящем запросе, все
остальное упарвление находится на стороне сервсиа `eats-plus`.


<a id="yandex-plus-slug"></a>

## Слаг

Для отображения кэшбека в ручке слага делается запрос к ручке
`eats-plus/internal/eats-plus/v1/presentation/cashback/place`,
которая возвращает знаенме кэшбека, в процентах, текст - префикс,
который необходимо вернуть в ответе вместе с отформатированым
значением кэшбека, иконку, текстовое описание и инфомацию
необходимую для отображения кнопки, которая чаще всего в едет в Дом
Плюса.


<a id="yandex-plus-catalog"></a>

## Каталог

Отображение кэшбека на каталоге значительно проще чем отображение
кэшбека на слаге - оно представляет из себя только значение кэшбека
и иконку, котрые запрашиваются из ручки
`eats-plus/internal/eats-plus/v1/presentation/cashback/places-list`.

