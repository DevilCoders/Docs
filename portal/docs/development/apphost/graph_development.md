# Разработка графов

Графы Морды живут в Аркадии [https://a.yandex-team.ru/arc/trunk/arcadia/apphost/conf/verticals/MORDA](https://a.yandex-team.ru/arc/trunk/arcadia/apphost/conf/verticals/MORDA)

### Как создать тестовый граф через UI?
Необходимо в Horizon UI сделать копию существующего графа (например, граф morda_searchap из вертикали ``MORDA``), отредактировать как вам необходимо и сохранить его. После этого на хосты вертикали (включая Авохамстер) приедет новое описание графа под именем `testing_{выбранное_вами_имя_графа}@N`, где `N` - номер ревизии. После этого в запросе в Авохамстер достаточно будет добавить CGI-аргумент `graph=testing_{выбранное_вами_имя_графа}@N`.

Подробней про редактирование графов смотрите [документацию Horizon UI](https://wiki.yandex-team.ru/horizon/Redaktirovanie-grafov-iz-UI/)

### Как сделать запрос в конкретный граф?
- добавить отладочный cgi-аргумент `graph=some_graph_name`

### Как отображать некоторые URL'ы в нужный граф?
Если в вашей задаче требуется создать новый граф и направлять в него часть приходящих в Авокадо запросов или добавить поддержку новых URL'ов в существующий, то после отладки сделайте коммит в [конфигурацию роутинга для HTTP-адаптера](https://a.yandex-team.ru/arc/trunk/arcadia/apphost/conf/verticals/MORDA/_routing_config.json)


### Разработка с локальным аппхостом

Для разработки графов есть возможность не использовать UI графы, а использовать "локальный" аппхост.
Что для этого нужно прежде всего:
* счекаутить аркадию (arc). Например, `~/arc/arcadia`
* счекаутить морду. Например, `/opt/www/morda-v133d0`
* перейти в морду, //попробовать// запустить аппхост с помощью `./tools/apphost_start_local.sh`

под капотом такая команда:

`ya tool apphost setup --tvm-id 50 -y -p "./" -a "$HOME/arc/arcadia" --run-app-host -P 21000 arcadia --vertical MORDA`

В результат команды в подкаталоге MORDA скачивается конфиг аппхоста и бекендов, запускается horizon-agent, запускается аппхост. Запущенный аппхост следит за изменениями в графах и подгружает их автоматом. Далее запущенный аппхост можно найти на порту 21000, а его http-adapter на порту 21004.
В него можно отправлять запросы, примерно так:

```
curl 'localhost:21004/?srcrwr=MORDA__MORDA_GO_BACKEND%3Amorda-dev-v133.vla.yp-c.yandex.net%3A20400&dump_source_request=MORDA_BACKEND&dump_eventlog_only=1&eventlog_format=html' -H "X-Yandex-Internal-Request: 1"
```

Чтобы работали дебажные параметры, нельзя забывать про хедер `X-Yandex-Internal-Request`

Второй вариант использования локального аппхоста - использовать portal-hamster.yandex.ru и переопределять **аппхост**. Сам аппхост при старте предложит такой вариант, подставив нужный хост и порт. Пример:

```
curl /https://portal-hamster.yandex.ru/?srcrwr=APP_HOST:morda-dev-v133.vla.yp-c.yandex.net:21000:10000000'
```

Главный недостаток - **новые** бекенды нужно предварительно закоммитить в trunk.
