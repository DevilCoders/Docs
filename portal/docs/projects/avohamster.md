# Avohamster
## Что это такое
Avohamster (Avocado + Hamster) является специальной "копией" продового сервиса, на котором располагается Apphost и Go-сервант Авокадо (на данный момент такими хостами являются продовые сервисы Geohelper'а), но предлагающий возможность переопределять используемые бэкенды для разработки, отладки и тестирования, как это сделано в Хамстере (hamster.yandex.ru), являющийся копией поискового сервиса.


Авохамстер живёт по адресу: http://avocado-dev.yandex.net.

## Как начать работать
1. Установите на свою dev-машину arc и ya
2. Смонтируйте Аркадию как arc-репозиторий, обязательно создав поддиректорию `src/a.yandex-team.ru`, чтобы должным образом работала сборка Go:

    ```
    $ mkdir -p avocado_arc/src/a.yandex-team.ru
    $ arc mount -m avocado_arc/src/a.yandex-team.ru/ -S avocado_arc/.fuse_storage
    ```

3. Убедитесь, что от Авохамстера до вашей dev-машины есть доступ. Хосты Авохамстера проживают в макросе `_MORDADEVNETS_`, поэтому если ваша dev-машина находится вне этого макроса, то закажите дырку в Puncher'е, указав один или несколько портов, который вы будете использовать для запуска Go-серванта.

	[Ссылка на предзаполненную форму](https://nda.ya.ru/t/T226iQKX3cJEDM).
4. Соберите программу Go-серванта:

    ```
    $ cd avocado_arc/src/a.yandex-team.ru/portal/morda-go
    $ ya make
    ```

5. Установите на вашу dev-машину базу geobase. Для этого зайдите в таску по сборке геобазы и скачайте свежую базу во [владке resources](https://sandbox.yandex-team.ru/task/992359234/resources).
Загруженный файл нужно поместить в путь `/var/cache/geobase/geodata5.bin`


6. Запустите Авокадо-сервант, передав через аргумент командной строки порт, который будет прослуживать сервер на наличие gRPC-запросов от Apphost'а:

	```
    $ ./cmd/avocado/avocado -port=27777
    2021/02/20 12:54:49 Starting Avocado...
    2021/02/20 12:54:49 Add srcrwr=MORDA__AVOCADO_SERVICE:morda-dev-v195.sas.yp-c.yandex.net:27777 to override Go-servant backend in requests to Avohamster
    2021/02/20 12:54:49 For example: http://avocado-dev.yandex.net/geohelper_avocado/ping?srcrwr=MORDA__AVOCADO_SERVICE:morda-dev-v195.sas.yp-c.yandex.net:27777
    ```

	С этого момента вы можете делать запрос в Авохамстер с переопределённым бэкендом Авокадо-серванта, который вы запустили на своей dev-машине. Для этого в запрос добавьте CGI-аргумент вида `srcrwr=MORDA__AVOCADO_SERVICE:<FQDN_вашей_машины>:<порт>`, как это сделано в подсказке выше.

	Более подробно об отладочных опциях смотрите [в документации Apphost'а](https://doc.yandex-team.ru/apphost/pages/cgi.html)

### Рецепты

#### Где смотреть логи?
На данный момент записи в логах производятся в двух местах:

- eventlog клиента Apphost'а, который находится непосредственно на хосте Авохамстера
- локальные логи, генерируемые Go-сервантом

##### Eventlog

В заголовках ответа Apphost возвращает поле `X-Yandex-Req-Id`, в котором будет находиться некоторый уникальный идентификатор запроса. Авокадо поддерживает работу с SETrace, который может заходить на хосты через `sky run` и парсить порождаемые Apphost'ом логи. Для отслеживания запроса по графу достаточно перейти в [SETrace UI](https://setrace.yandex-team.ru/ui/) и ввести значение хэдера.

Также в целях отладки доступна воможность переопределять идентификатор, выставив собственное значение в хэдере.

##### Локальные логи
Go-сервант может сам генерировать события, которые отправляются в стандартный вывод, файл или сокет (последний вариант предназначен только для работы на продакшне для совместимости с Unified Agent). На данный момент логирование доступно только для ручек ПП, проксирующих запросы в Geohelper, и только на уровне ошибок и предупреждений.
