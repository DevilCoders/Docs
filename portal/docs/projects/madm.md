# MADM

## Таргетирование

Таргетирование в новых экспортах возможно по полям

* `domain` - all ru by kz ua com com.tr kub all-com.tr
* `content` - all big mob tel touch ?
* `lang` - all ru uk be kk tt tr
* `geo` - по регионам

Порядок сравнения при таргетировании от более точного к менее точному значения поля

## Замешивание mix mode
Предполагается возможность замешивания, те когда в выдачу могут попасть все строчки экспорта с domain=ru и domain=all
однако включение этого надо указывать ЯВНО
(либо в настройках экспорта, либо в параметрах вызова)
при этом кажется, что замешивание по языку, это ересь

## фильтрация

get_static_data предполагает фильтрацию, до окончательного таргетирования
(для mix это не существенно)
те если мы найдем строчки для региона А - и все будут выключены фильтром
то мы будем искать данные для более общего региона ABC

## MordaX::Block::get_static_data

### Аргументы
`$req, $block, %ARGS`

* `all` - вернуть все строки ([ row, row, row ... ]) пока без фильтрации filter + dated
* `first` - вернуть первую из найденной
* `random` - вернуть произвольную из найденной (равномерно)
* `random_weighted` - вернуть произвольную из найденной согласно весу в поле weight
* `mix` - разрешить замешивать данные по всем вариантам ключа задается или в функции или в опция экспорт
* `no_mix_content` (актуален только при наличии mix)
* `no_mix_domain` (актуален только при наличии mix)
* `no_mix_lang` (актуален только при наличии mix) (стоит требовать чтобы такого не было)
* `no_mix_geo` (актуален только при наличии mix)
* `dated` - отфильтровать по дате-вермени (работает с полями from - to|till)
* `date_filter_arg` - ключ req c с которым производить сравнение `test`
* `enabled` - возвращает только те, где не стоит disabled
* `bk` - фильтрация по флагу бк если он задан в поле bk
* `exp` - по полю exp если поле задано и пользователь в эксперименте exp
* `timed` - отфильтровать по времени дня (time_from time_till)
* `week_day` - фильтр по дням недели. Фильтрует по полю week_day. Возможные значения: **1-7** для обозначения конкретного дня недели (7 - воскр); **holiday** - суббота, воскресенье + праздничные дни; **before_holiday** - день перед праздником или перед выходными; **workday** - то же самое, что 1,2,3,4,5; **weekend** - то же самое, что 6,7; **before_workday** - день перед рабочим днем. Примеры: "3, holiday"; "before_holiday, holiday"; "4,5,6"
* `yandex` - по внутренним сетям (yandex + YandexInternal)
* `filter` - фильтр функция `sub { my ($req, $data, $args) = @_, 1 }` `test` возможно она инвертирована из-за code_run (пытаюсь исправить)
* `filter_args` - ref_hash передающийся третим параметром в filter `test`
* `exact_index_search` - при указании этого флага данные будут выбираться следующим образом: если по заданным критериям найдены данные, они будут возвращены. (Если они все disabled или отфильтрованы по дате, или еще каким-то образом отключены, будет возвращаем пустой массив). Если данных по заданному критерию не существует, тогда будет произведен поиск вверх (например, по гео-региону). Эта опция нужна для предотвращения поиска вверх в случае, если данные заданы, но они отфильтрованы.
* `started_geo` - задать начальный регион для поиска (по умолчанию используется req->GeoByDomainIp, иногда нужно задать вручную, вся остальная логика сохраняется)

### Возвращает

* `UNDEF` при ошибке
* `[]`  если нет данных/экспорта или ничего не найдено
* `[ row row ]` по умолчани
* `row` или `undef` - по запросу c first random random_weighted, undef если ничего не найдено (нет экспорта)

где row это hash из одной строчки

### Пример

```perl
my $data  = MordaX::Block::get_static_data( $req, 'postcards' , first => 1, dated => 1);
```

## Описание экспорта
Чтобы сделать экспорт понимаемым для `get_static_data` надо настроить опции

```perl
   $MADM::ExportTypes::formats{'postcards'} = {
         options => {
             v => 2,
             index => [ qw/domain lang geos/ ],
             mix => 1, # optional
             dated => 1, # optional
             week_day => 1, # optional
             timed => 1, # optional
             yandex => 1, # optional
             trash_after_till_days => 30, # optional
             ignore_trash_after_till => 1, # optional
          }
          format => {
          ...
```

* `v => 2` переключает madm на новый генератор
* `index => [ field list ]` - какие поля используются в индексе, индекс может быть построен только по полям domain content geo|geos lang, название полей строгое, другие поля будут проигнорированы, geo|geos превращаются в одно поле индекса. Либо можно использовать "text_key" (см. ниже).
* `mix => 1` включит для данного экспорта замешивание данных, те поиск данных по всем возможным вариантам индекса
* `dated` `timed` `week_day` `yandex` - значения для фильтрации по умолчанию (используются в MADM::Selector)
* `trash_after_till_days` - устанавливает период времени в сутках, когда данные перестают сохранятся (считается от значения поля till). По умолчанию 5 суток.
* `ignore_trash_after_till` - игнорируем протухание данных. Они будут сохраняться всегда.

### Как задать произвольный ключ для индекса - text_key:

```perl
options => {
    v => 2,
    index => [qw/text_key/],
    text_key => 'yandexuid',
},
format => [
    yandexuid => {
        type => 'string',
        optional => 1,
    },
    ...
```
