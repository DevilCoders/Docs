# Мониторинг и алерты greenbox
Все панели непосредственно гринбокса расположены в головане.
Есть еще [мониторинг редиса](https://yc.yandex-team.ru/folders/foocqso83qg8i157m8tr/managed-redis/cluster/mdbpceivm7uenj2nsk6a?section=monitoring) на который можно посмотреть, если есть подозрение, что умер редис (на панелях гринбокса будет видно, что что-то не так с редисом либо путем до него, в мониторинге редиса можно проверить, где и что именно).

## Логирование

В мирное время все логи кладутся в [error booster](https://error.yandex-team.ru/projects/avocado/projectDashboard?filter=service%20%3D%3D%20greenbox).
Если по какой-то причине логирование сломалось, логи будут писаться в stderr на самих хостах. Если сервис живет в няне, это значит, что рядом с бинарем `greenbox` будет файл `greenbox.err` с логами. Помимо этого туда же пишутся некоторые логи о запуске и выключении серванта, они в эррор бустер не отсылаются.

## Мониторинг

Есть две основные панели графиков гринбокса, [внутренняя](#internal) и [внешняя](#external), обе достижимы через [дерево панелей голована](https://wiki.yandex-team.ru/golovan/userdocs/panels/menutree/).

### Внутренняя панель {#internal}

[Portal/Greenbox/greenbox internals](https://yasm.yandex-team.ru/menu/Portal/Greenbox/greenbox_own/)
Показывает различную внутреннюю статистику гринбокса.
![снимок панельки](internal.png)
Сначала идут общие графики:
* График фейлов обновления метрик - суммируется для всех хостов, 0, если все нормально, 1, если у хоста соответствующий модуль не смог обновить метрики. Если этот график зашкаливает, часть метрик будет нести мало смысла.
* График фейлов логирования. Говорит сам за себя, если там не 0, то ошибки не доходят до еррор бустера (или куда гринбокс настроили их отправлять). Само по себе катастрофой не является, но за этой не-катастрофой может подкраться настоящая катастрофа (ее можно будет заметить по другим метрикам, но адекватных сообщений о происходящем получить не получится), поэтому чинить такое надо как можно раньше. Если вдруг такое произошло, что и логирование померло, и сам гринбокс начал помирать, то можно сходить на сами хосты и смотреть stderr, т.к. логирование при фейлах фоллбэчится именно туда. 
* График фоллбэков редиса. Сам по себе не очень страшный, но если начинает зашкаливать, то это повод проверить живость хостов редиса и сети до него.

Затем идут графики для каждого экспорта и алерты для них.
* Возраст экспорта - максимум по хостам. Если скачет выше желтой линии, то экспорт пуллер не справляется с своевременной доставкой данных, либо эти данные не могут дойти до редиса. Если выше красного, скорее всего что-то в механизме доставки данных совсем сломалось, и надо бежать чинить. Можно проверять живость экспорт пуллера, можно посмотреть на [графики его попыток загрузить данные](https://yasm.yandex-team.ru/chart/itype=wfront;hosts=ASEARCH;signals=export-puller_unistat-http_push_*) в пункты назначения (обычно это гринбокс). Несколько позже перевезу этот график на эту панель гринбокса, а также добавлю еще полезных в этом месте метрик.
* Графики ошибок и фейлов. Без лишнего контекста, если значения выше 0 (кроме, может, мелкого фона), что-то поломалось.
  * Corrupted data - в редисе вместо читаемых данных что-то странное. Нужно либо откатывать гринбокс, либо откатывать экспорт пуллер, либо, если не тот, ни другой не обновлялся, ковырять редис клиентом и смотреть, что же там такое.
  * Spoiled data - в редисе безнадежно протухшие данные, либо до редиса достучаться не получается, и данные в локальном кэшэ безнадежно протухли. Если горит, значит поломался механизм доставки данных (смотреть график возраста данных выше).
  * Redis - ошибки взаимодействия с редисом. Сейчас включают в себя таймауты, но вскоре будут разделены.
* Метрики локального кэша
  * Hits - попадания в кэш, нечто вроде рпс (на деле в основном запросы в редис балковые, у новостей, например, вполне может браться 12 или больше ключей за раз)
  * Spoiled - попадания в кэш в данные, которые уже больше полминуты лежат в кэшэ. Небольшой фон - нормально, т.к. данные периодически локально протухают и достаются снова из хранилища.
  * Misses - промахи в локальный кэш. Если их много - это значит, что в гринбокс постоянно приходят запросы на новые уникальные ключи, имеет смысл искать проблему в сервисах, от которых идут запросы. Небольшой фон - нормально по нетривиальным причинам.
* Метрики удаленного кэша (хранилища, т.е. редиса) - попадания и промахи. Если промахов много - что-то не так с входящими запросами либо с данными в редисе.

Эта панель автоматически строится по алертам.

### Внешняя панель {#external}
[Portal/Greenbox/greenbox as backend](https://yasm.yandex-team.ru/menu/Portal/Greenbox/greenbox/)
Показывает статистику по вершинам гринбокса с точки зрения аппхоста (сервера, который посылает запросы в эти вершины), а также некоторые графики использования ресурсов порто контейнера. Также содержит алерт фейлов по вершинам, который является максимумом среди всех вершин процентного отношения зафейлившихся запросов ко всем входящим запросам.
Эта панель обновляется руками, при появлении новых вершин гринбокса нужно добавить их в список в начале шаблона панели.

## Алерты {#alerts}
[template/alert/portal.greenbox](https://yasm.yandex-team.ru/template/alert/portal.greenbox/)
Стандартный шаблон алертов инфры морды плюс упомянутый в внешней панели алерт на фейлы вершин гринбокса. Помимо этого есть ряд алертов на внутренние метрики гринбокса. Каждый из этих алертов соответствует одному из графиков, в [секции про внутреннюю панель](#internal) описано, что они значат.

В шаблоне есть перечисление экспортов:
```jinja2
<% set greenbox_exports_data = [("topnews", 0)] %>
```
В списке перечисляются пары (имя экспорта, время обновления). Если время обновления выставлено в 0, тогда берется время жизни по умолчанию (80 секунд). Время жизни определяет пороги для алерта, который следит за возрастом данных в кэшэ. Если возраст данных превышает время обновления - это варн, если превышает двойное - крит.
**После модификации шаблона его нужно применить**.