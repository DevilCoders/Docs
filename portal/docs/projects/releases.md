# Релизы

Хотя возможность выкатить релиз "руками" остается доступной, настоятельно рекомендуется использовать релизы в Arcadia CI. Всю необходимую информацию о релизах можно найти на страницах соответствующих сервисов в проекте Portal (Arcadia -> Projects -> Portal):
* [Avocado](https://a.yandex-team.ru/projects/home/ci/releases/timeline?dir=portal%2Fmorda-go%2Fcmd%2Favocado&id=avocado)
* [Greenbox](https://a.yandex-team.ru/projects/home/ci/releases/timeline?dir=portal%2Fmorda-go%2Fcmd%2Fgreenbox&id=greenbox)
* [MordaGo](https://a.yandex-team.ru/projects/home/ci/releases/timeline?dir=portal%2Fmorda-go%2Fcmd%2Fmorda-go&id=morda-go)

Подробно про основные понятия и релизы можно прочитать в документации к [CI](https://docs.yandex-team.ru/ci/).

## Принципиальная схема релиза

Релиз состоит из следующих этапов:
1. Build - проверка major событий, сборка ресурса для выкладки, создание релизного тикета
2. Testing - релиз ресурса в sandbox в testing, активация testing Nanny сервиса, обновление статуса релизного тикета,
прогон тестов напротив тестинга
3. Prepare stable - релиз ресурса в sandbox в stable, prepare stable Nanny сервиса
4. Stable - активация stable Nanny сервиса полокационно с ручным подтверждением, выкладка на hamster

## Как выкатить релиз

Для того, чтобы собрать и выкатить новый релиз, необходимо

1. Перейти на страницу сервиса и нажать `Run release` в правом верхнем углу, либо выбрать опции для определенного коммита и выбрать там `Run release`
2. В предложенной форме появится возможность выбрать коммит в `trunk`, от которого собирать релиз, версию конфига `a.yaml` (если неясно, какая нужна — то нужна последняя) и релизный flow
3. Нажать `Run release`. Откроется окно релизного flow и начнутся выполняться кубики в порядке зависимостей
4. В релизном flow есть шаги, которые требуют ручного подтверждения (выкладка в stable, активация локаций и т.п.). Понять что шаг требует ручной активации можно по силуэту Гендальфа перед соответствующим кубиком.
5. После выполнения всех шагов релиз помечается состоявшимся

## Как откатить релиз

Откат (rollback) доступен только для последней стадии релиза (stable). Подробно про механизм откатов можно прочитать в [документации CI](https://docs.yandex-team.ru/ci/release#rollback).

Для того, чтобы откатить релиз на одну из предыдущих стадий, необходимо:
1. Перейти на страницу сервиса, выбрать один из предыдущих релизов и нажать `Rollback to`
2. В предложенной форме появится возможность выбрать rollback flow для выполнения. В этом месте
можно выбрать активацию snapshot'а дефолтным рецептом или locationwise с ручным подтверждением.
3. Проследить за выполнением шагов отката из stable.

Технически, rollback flow - это отдельный релиз, имеющий свою версию в рамках Arcadia CI, однако, выполняющийся поверх имеющихся артефактов.

В двух словах как это работает: после запуска rollback flow все артефакты, созданные на предыдущих (до stable) этапах собираются и передаются в rollback flow. Среди артефактов, в том числе, содержится артефакт с версией snapshot'а, активированного в базовом релизном flow. Таким образом, тасклеты, выполняющие откат, узнают нужный id snapshot'а и прожимают для него activate.

Важно помнить, что если по какой-то причине snapshot, на котором запустился rollback flow, был вытеснен из prepared, то для активации такой версии потребуется значительно больше времени, поэтому не рекомендуется откатываться на сильно старые версии.
