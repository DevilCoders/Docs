# Граф поискового приложения (она же "прямая схема")

## Что это такое {#what_is_it}
Конструкция, включающая в себя:
* Apphost как входную точку и навигатор по сервисам в процессе обработки запроса
* Карточки Новостей и Погоды обрабатываются и создаются независимо и конкурентно текущему легаси на Perl'е, который медленно разбираем

Команда Морды отвечает за следующие бэкенды:

* Morda Go – новый бэкенд, разрабываемый платформой Авокадо. Команда разработки платформы  предоставляет фреймворк с доступом к низкоуровненным сущностям пользовательского запроса (куки, флаги экспериментов, устройство, версия и платформа приложения и так далее), а команда разработки продукта их использует за реализацию бизнес-логики или предлагает это реализовать смежной команде. Отвечает за:
  * Формирование запросов во внешние к Морде сервисы (Новости и Погода)
  * Слияние полученных результатов с текущим легаси
  
* Morda Perl - текущий legacy-монолит, который разбираем. Для постепенного переноса у нас есть:
  * Данные в теле ответа, необходимые для обработки в Авокадо (`data_for_avocado` для Новостей)
  * Специально заведённая ручка `perl_init`, которая принимает ровно такой же запрос, как и `perl_legacy`, но 
  * Div-рендерер карточек – необходим для генерации готовых к рендеру div2-контейнеров по данным из сервисов
* Geohelper (написан на Node.js) – используется для получения свёрстанных карточек в формате div2.

Упрощённая схема графа ПП. Розовым обозначены узлы с бэкендом в Morda Perl, голубым в Morda Go:
![](https://jing.yandex-team.ru/files/yanykin/2021-11-24T14:11:33Z.02c3e8c.png)

Основные узлы:

* PERL_LEGACY – вся имеющая логика Morda Perl + часть бизнес-логики Новостей, отвечающая за формирование запроса.
* PERL_INIT – облегчённая версия PERL_LEGACY, которая процессит только входные данные (вызывает функции вида `input_something($req)`). Используется для получения данных от тех компонент, которые в Morda Go пока не сделаны.
* TOPNEWS_SUBGRAPH – подграф, который собирает дивную карточку Новостей. Внутри себя содержит узлы Morda Go и поход в дивный рендер.
* PATCHER – вклеивает карточки в основной ответ от Morda Perl, включая основную карточку Новостей, версию в мини-карточке и Погоду
* SPLITTER (не показан на графе) – служебный узел для обработки данных из `data_from_avocado`, нужен для Погоды

## Что и где смотреть (про мониторинги) {#monitors_and_alerts}
* Панели в Головане:
  - графа ПП : http://yasm/menu/Portal/Avocado/apphost_template_morda_searchapp/
  - подграфа Новостей: http://yasm/menu/Portal/Avocado/apphost_template_top_news/
* Панели ошибок Error Booster:
  - для сервиса Avocado: https://error.yandex-team.ru/projects/avocado/projectDashboard?period=hour
  - для сервиса Morda Go: https://error.yandex-team.ru/projects/morda/projectDashboard?filter=runtime%20%3D%3D%20go&period=hour

## Где смотреть логи {#where_to_find_logs}
* Каждому запросу выставляется уникальный идентификатор в HTTP-хэдере ответа `X-Yandex-Request-ID`. С его помощью можно отследить ход выполнения запроса по всем узлам графа и выбранным инстанстам соответствующих бэкендов через [SETrace](https://setrace.yandex-team.ru).

* Бинарники `morda-go` и `avocado` генерируют записи в лог при каждом вызове функции log2.Error, log2.Warn или log2.Info (или более совершенного модуля log3). Логи настроены через Unified Agent и оттуда они попадают или на локальную машину в виде текстового файла, или в Error Booster.

## Как разрабатывать и отлаживать {#how_to_develop_and_debug}

* Собрать бинарник на dev-стенде через `ya make` и запустить
* Зайти на Хамстер и сделать запрос в портальную ручку, переопределив бэкенд через `srcrwr=MORDA__MORDA_GO_APP_BACKEND:<hostname_вашего_дев_стенда>:<указанный_выше_порт>`
* Зайти в отладочную версию ПП, переопределить в дебаг-панели значение HOST_HOME, чтобы приложение ходило в Хамстер с вашим бэкендом

* Если между узлами планируется передавать данные, то желательно использовать Protobuf-айтемы вместо JSON-объектов: это повышает удобство использования в коде и в отладке.

### Как разрабатывать дивную карточку (вёрстка в Geohelper'е) {#changes_in_div_renderer}
* Поднять локально стенд ГХ (ссылка на инструкцию)
* Как-то определить порт (например, 10299)
* Использовать хостнейм и порт дев-стенда как новое имя бэкенда через отладочный параметр: `&srcrwr=MORDA__GEOHELPER_NODEJS_HTTP_PROXY:<dev_stand_hostname>:10299`
