## Что это такое

Проект smoothie является прокси-сервером для рассылки пушей в Поисковое Приложение, Браузер и тп.
Пуши рассылаются с таргетированием по geo на android и ios приложения почти всех версий.
Пуши бывают разной тематики. Каждая тематика имеет свою частоту рассылок, допустимое время отправки и прочие правила рассылок.

## Принципиальная схема работы

На экспортящей ферме морды работают скрипты-генераторы-пушей, которые загружают локальные данные и формируют запросы в смузи.
Например, [пуши высокого уровня пробок](https://github.yandex-team.ru/morda/main/blob/dev/scripts/export_to_smoothie_traffic.pl).

Также есть возможность отправить разовые пуши из [madm](https://madm.yandex-team.ru/edit?export_file=pushes&stage=production), в этом случае пуши будут сформированы [скриптом](https://github.yandex-team.ru/morda/main/blob/dev/scripts/export_to_smoothie_manual.pl).

В админке смузи можно разрешить отправку пушей без подтверждения, в другом случае нужно подтверждать отправку вручную в очереди.

## Где админка

[Админка](https://smoo.viewer.yandex-team.ru/view/)

[Получить доступ](https://idm.yandex-team.ru/#rf-role=FtyJg4tk#user:wwax@viewer/smoo.viewer.yandex-team.ru/user(fields:();params:()),rf-expanded=FtyJg4tk,rf=1)

## Исходный код

[В Гитхабе](https://github.yandex-team.ru/morda/smoothie)

## Инфраструктура

### Тестинг

Отсутствует

### Продакшн

[conductor](https://c.yandex-team.ru/groups/portal_clop/edit)

На хостах продакшена работает Percona XtraDB Cluster, так что в целом она достаточно отказоустойчива.

## Настройки балансера

[l3-balancer](https://l3.tt.yandex-team.ru/service/2772)

## Как поднять себе окружение

Разработка собрана в docker (и база данных тоже).
Нужно счекаутить репозиторий и выполнить ``make up`` (установив предварительно docker, конечно же).
Заполучить дамп базы данных с продакшена и загрузить её к себе.
Текущее окружение разработки развернуть на morda-v6.search.yandex.net (настроен nginx /etc/nginx/sites-enabled/dev.ngx под домен 1-wwax-smoothie-s6.wdevx.yandex.ru)

## Сборка и релиз
Sandbox task **BUILD_PORTAL_MORDA_SMOOTHIE**
Запускается через **$ make release**
Деплой через [кондуктор](https://c.yandex-team.ru/packages/portal-morda-smoothie)

## Логи и графики

[Логи в YT](https://yt.yandex-team.ru/hahn/#page=navigation&path=//statbox/smoo-send-log)

**content_id** - ключ "уникального" события
**geo** - регион
**in_exp** - эксперименты, на который было разослано
**msg** - текст пуша
**name** - канал в смузи
**pid** - идентификатор процесса в бекенде смузи (чтобы было проще анализировать логи)
**push_id** - id из таблицы queue
**receivers** или **target** - условие для резолвинга получателей
**reqid** - идентификатор запроса от СУПа или BASS, по которому можно склеить наш лог с их
**type** - тип уведомления (push - только пуш, push_card - пуш с карточкой, card - только карточка)
**url** - ссылка в пуше

[Состояние бэкенда](https://yasm.yandex-team.ru/panel/smoothie_queue)
[Состояние базы данных](http://graphite.wdevx.yandex.net/grafana/dashboard/db/percona-xtradb-cluster-clop)

## План failover учений
1. Остановить mysql, наблюдать за ошибками бекенда и haproxy. Должно всё работать (рассылки, добавление, админка).
1. Остановить backend, наблюдать за ошибками haproxy. Должно всё работать (рассылки, добавление, админка).
1. Остановить haproxy, на оставшихся серверах должно всё работать (рассылки, добавление, админка).

## Ansible
https://github.yandex-team.ru/dkhlynin/portal-ansible

## Реплика на s2.clop
https://wiki.yandex-team.ru/users/wwax/notes/db/pxc/#kakpochinitreplikunas2.clop

## Бекап mysql
```
cat /etc/cron.d/portal-clop-admin
->pxc_backup.sh
```
[репозиторий](https://github.yandex-team.ru/dkhlynin/portal-ansible/blob/master/ansible/roles/portal_clop/files/scripts/pxc_backup.sh)

## Обновление секретов
[Тут](https://yav.yandex-team.ru/secret/sec-01cn1kvp8zx1byvssn1svg9qt2) лежит токен от пуш-бота
Настройки секретов хранятся тут /etc/yandex/yav-deploy/defaults.conf
Чтобы его обновить, нужно пойти в продакшн и обновить ``sudo -E yav-deploy --debug``

## Как чинить, если что-то пошло не так
### Дебаг пушей и карточек в приложении, в СУПе
https://wiki.yandex-team.ru/Morda/push-notify/Instrumenty-debaga/

## Детальное описание

### Термины

**ПП** - поисковое приложение

**СУП** - транспорт для рассылки пушей zador@ https://doc.yandex-team.ru/Search/sup-api-guide
**Datasync** - сервис, где ПП хранит свои настройки подписки, а также смахивания карточек

**Пуш** - уведомление, отправляемое на устройство пользователя. Для отправки пуша нужно получить пуш-токен пользователя.
**Топики (темы) подписок** - тег в СУПе theme, на который мы таргетируем рассылки. Если пользователь подписан на топик, тег имеет значение "подписан", если отписан - тогда значение "отписан"
**Конфиг подписок** - json из бекенда морды, в котором перечислены все топики, на которые мы сейчас рассылаем пуши и карточки
**opt-in** - подписка выключена по умолчанию и пользователь должен явно на неё подписаться, чтобы начать получать пуши и карточки
**opt-out** - подиска включена по умолчанию и пользователь может отписаться от неё, чтобы перестать получать пуши и карточки
**Локальная фильтрация пушей** - фильтрация на стороне приложения, позволяющая не показать пуш, если он не удовлетворяет каким-то текущим условиям клиента
**Сайлент пуш** - пуш, который не может быть отрисован системой. Для отрисовки требуется пробудить приложение, которое будет рисовать пуш.
**Пуш без нотификации** - пуш без вибрации, сигнала и прочих эффектов для пользователя
**install_id** - это uuid-appmetrika из приложения 
**device_id** - идентификатор устройства приложения

### Возможности
Сервис умеет рассылать массовые пуши с ограничениями по регионам и временному окну.
Поддерживает AB-эксперименты на уровне таргетов (пока нельзя сделать разные тексты на разные эксперименты, или разные ссылки, можно только ограничить аудиторию, которая получит пуш).
Можно исключить получателей, которые имеют другие установленные приложения (например, разослать пуш всем, у кого нет приложения метро)
Пуши могут быть в режиме opt-in, opt-out
Разные типы пушей можно рассылать на разные топики, которые поддержаны в приложении android-6.60

### Как это всё работает в деталях

#### Рассылка пушей и карточек

![съема](https://wiki.yandex-team.ru/Morda/push-notify/Dokumentacija-pro-proektu/.files/untitleddiagram-1.png)

На бекендах морды работают экспортящие скрипты, которые генерируют карточки - export_*_cards.pl
На бекендах морды работают экспортящие скрипты - **export_to_smoothie***, которые читаю файлы от export_*_cards.pl и шлют уведомления.
Они отправляют в smoothie-api запросы на создание событий. На этом работа экспортящих скриптов закончена.

Когда в смузи создается событие, для него расчитывается время жизни и очередь рассылки.
В смузи работает скрипт, который активирует рассылку в бекенде смузи.
Когда в очереди подходит время отправки (считается по send_from), тогда в СУП отправляются пуш-реквесты (на рассылку пушей).
Во всех этих запросах на рассылку указывается таргет.
Здесь работа бекенда смузи закончена.

СУП получает такой запрос, ставит его в очередь. Когда идет рассылка СУПа, то таргет превращается в конечных пользователей, которым и рассылаются пуши.
Когда СУП отправил пуш, то он попадает в google или apple, где уже доставляется их транспортами на устройство пользователя.
Здесь СУП свою работу закончил.

#### Карточки и пуши из madm
Карточки дизастера, метро и перекрытий на дорогах показываются по данным madm'а.
Для карточек формируется card_id и этот же card_id отсылается в url пуша (за это отвечает скрипт madm/scripts/export_madm_push.pm, который создает события в смузи).
За счет синхронности формирования card_id работает отскролл до этих карточек.
Карточку можно смахнуть, но она будет продолжать приходить в ответе морды. Но она будет скрыта за счет клиентской фильтрации.

#### Как устроены подписки/отписки в приложении
![схема](https://wiki.yandex-team.ru/Morda/push-notify/Dokumentacija-pro-proektu/.files/podpiskivprilozhenii.png)

Приложение получает список тем (для пушей, карточек) от морды через [api](http://yandex.ru/portal/subs/config/0?app_version=7000500&os_version=6.0&app_platform=android&geo_by_settings=213).

Когда пользователь подписывается или отписывается от темы, то приложение пишет в DataSync состояние настроек.
СУП читает realtime-лог DataSync'а и проставляет у пользователя значения в тег theme ([Например](https://beta.mobsearch.yandex.ru/psuh/v2/tags/c0183451e673cff87c6bde17ca51de8b))
Если пользователь подписан на тему, то там будет значение типа assist_disaster_push_on, если отписан то - assist_disaster_push_off
В зависимости от типа темы (opt-in, opt-out) тег может присутствовать у пользователя или отсутствовать.
Темы проставляются как для пушей, так и для карточек.
Когда отправляем пуш, то в таргете указывается: %%theme!='assist_disaster_card_off' && theme!='assist_disaster_push_off'%% - это значит, что пользователь НЕ отписывался.
Если это opt-in подписка, тогда в таргете будет %%theme=='assist_disaster_card_on' && theme=='assist_disaster_push_on'%% - это значит, что пользователь явно подписался.

В морде состояние тем и набор тем управляется экспортами:
**subs_cards** - карточки морды
**subs_acards** - карточки ассиста
**subs_pushes** - пуши

#### Как работают эксперименты
Рассылки пушей через СУП поддерживают AB-эксперименты.
Для этого в пуш-реквест нужно добавить exp_id в формате %%EXPERIMENTS-16969%% [подробнее](https://push-beta.n.yandex-team.ru/docs/api-guide.html#_%D0%9F%D0%BE%D0%B4%D0%B4%D0%B5%D1%80%D0%B6%D0%BA%D0%B0_%D1%8D%D0%BA%D1%81%D0%BF%D0%B5%D1%80%D0%B8%D0%BC%D0%B5%D0%BD%D1%82%D0%BE%D0%B2)
Если на разные testid нужно отправлять разные пуши, то нужно заводить отдельные EXPERIMENTS (иначе там есть проблема с подсчетом результатов эксперимента)
Этот же эксперимент можно включать для приложения и для морды, чтобы сформировать единое поведение для экспериментальной группы.

При рассылке СУП резолвит пуш-реквест в конечных пользователей, затем для каждого найденного пользователя получает testid, в которые он входит. Если testid из поля exp_id входит в testid пользователя, тогда считается, что он попал в эксперимент. (Из-за этих нюансов дробления пользователей условия включения указываются не в conditions для эксперимента, а в receivers в пуш-реквесте)

В логах СУП есть колонка testid, по которой можно понять, кто попал в эксперимент или эталон.

#### Админка
В админке можно управлять каналами и таргетами. В канале есть таргеты, которые описывают правила рассылки пушей на разные приложения и их версии.

#### Управление каналами
**Для канала задается:**
**name** - имя канала
**event_type** - тип события
**settings_geos** - регионы, для которых можно создавать события
**settings_timelines** - диапазон по местному времени, когда можно создавать события
**pri** - приоритет пушей этого типа (!!high!! - пуш будет отправлен в другую очередь супа и отправится немедленно, !!(green)norm!! - то без изменений)
**ttl** - время жизни события. Пока одно событие живет, новое создано не будет
**ttp** - время, в течение которого нужно отправить пуш по новому событию
**ttvp** - время, в течение которого пуш будет отображаться на устройстве после получения
**throttling_sec** - политика троттлинга пушей в СУП, чтобы всей стране не пришли пуши одновременно
**is_data_only** - слать пуши без ограничений рейтлимитером (для особо скоростных пушей)
**install_policy** - политика лимитера пушей в СУП на install_id
**content_policy** - политика дедубликации пушей в СУП по content_id
**allow_no_geo** - возможно создание пуша без указания значения geo, тогда в таргетах не будет тега geo
**push_approved** - пуш подтвержден автоматически
**push_enabled** - разрешено слать пуши
**enabled** - канал включен (создаются события)

Через базу сейчас можно отредактировать заголовок пушей для всего канала, например:
```
update settings set localize='{"default": {"title": "Важное в СМИ"}}' where id=3 limit 1;
```

#### Управление таргетами
**Для таргета задается:**
**platform** - appsearch_android/appsearch_ios/mobyabro_ios и прочее. Платформа влияет на имена приложений, куда шлём. Значение для платформы задается через базу в таблице **settings_platform**!!*!!
**staff** - есть режимы **staff** - слать на стафф, **prod** - слать на !staff, **all** - слать на всех
**no_notify** - отправлять пуш без нотификации
**receivers** - версии приложений
**apps** - ограничения на наличие других приложений
**url**!!*!! - ссылка в пуше (либо задается при создании события, либо берется из таргета).
**icon**!!* *!! - иконка в пуше, необязательный параметр, если не задана то будет пуш без иконки. (Все приложения имеют некоторую иконку по умолчанию, но это нужно уточнять в каждом случае). В поле с иконкой, можно задать необязательный параметр "i" через ";", без пробельных символов. i может принимать значения 1 и 2.  i=1 - дефолтная иконка ПП; i=2 - когда нужно использовать иконку Алисы. Пример: %%https://yastatic.net/s3/home/apisearch/alice_icon.png;i=1%%
**topic_push** - имя топика для пуша
**topic_card** - имя топика для карточки
**type** - opt-in/opt-out (состояние подписки по умолчанию opt-in=выключена, opt-out=включена)
**exp** - эксперимент, на который слать пуши и карточки
**descr** - человекопонятное описание этого таргета, если нужно
**preview** - какое условие для рассылки получится в итоге
**enabled**	- таргет включен

!!*!! - ссылка в пуше может принимать значения:
key:MYKEY - если указано таким образом, то будет выбран url под ключом MYKEY, а в случае его отсутствия пуш отправлен не будет
Какое-то иное значение - будет отправлено в таком же виде

!!* *!! - ссылка на иконку может принимать значения:
key:MYKEY - еси указано таким образом, то будет выбрала иконка под ключом MYKEY из данных события, а в случае его отсутствия пуш отправлен не будет
Какое-то иное зчачение - будет отправлено в таком же виде

**settings_platform**!!*!! - сейчас редактируется только вручную через базу. Можно задать имена приложений и транспорт.

#### Подтверждение событий
На [странице](https://smoo.viewer.yandex-team.ru/view/queue.html) можно подтверждать события, для которых в настройках НЕ установлена галочка **push_approved**
Пока событие не подтверждено, изменения в событии (текст, например), будет обновляться.
После подтверждения обновления не происходит.

#### Создание любых событий через madm
Здесь заведен [раздел](https://madm.yandex-team.ru/edit?stage=production&export_file=pushes), где можно вручную создать пуш на любые подключенные устройства

**push_from_local, push_to_local** - время того региона, куда нужно отослать пуш
**push_text** - текст пуша, который будет отправлен во все платформы по умолчанию
**push_text_ios** - текст пуша для ПП на ios
**url*** - набор ссылок, которые будут отправлены на разные платформы 
**ttl_sup** - время рассылки пуша в СУП
**uniq_id** - уникальный идентификатор события для дедубликации в smoothie

Эти события будут создаваться в канале manual [здесь](https://smoo.viewer.yandex-team.ru/view/)
Изменить версии приложений и другие настройки можно в админке smoothie

#### Автоматическая отправка событий про трансляции
Для отправки пушей с трансляциями через madm нужно:
заполнить в [разделе](https://madm.yandex-team.ru/edit?stage=production&export_file=media_events_episodes) поля:
- event_name
- push_text
- выставить галочку push
В **option** есть опция **event_push_period_in_min**, которая управляет интервалом времени, за которое будет создано новое событие.
Если в тексте написано "Начнётся через 10 минут" и включена отправка без подтверждения, то оптимальным будет использовать 11-12 минут.
Если включена отправка через подтверждение, то нужно поставить чуть больший интервал, чтобы успеть сходить в админку и проверить, подтвердить.

При создании события оно будет отправляться в smoothie в канал с тем же именем, которое написано в **event_name**.
Все пуши будут отправляться по подписке с помощью указания доп.тега: `mordaEvent=='strm_<content_id>'`

#### Примеры запросов на создание событий

```
{
    'name' : 'some_name',
    # optional, если в настройках канала указать allow_no_geo
    'geo'  : 'some_geo',
    'data' : {
        'localization' : {
            'ru' : {
                'push' : {
                    'msg'     : 'some_msg',
                    'msg_ios' : 'some_msg_for_ios', # optional
                    'url'     : {
                        'default'    : 'some_default_url',
                        'custom_url' : 'some_custom_url', #optional
                    },
                },
                # optional
                'card' : {
                    'text' : 'some_text',
                },
            },
        },
    },
    'v'  : 2,
}
```

Можно добавлять такие значения:
**sup_content_id** - если нужно для разных пушей использовать один и тот же content_id у СУПа (например, пуши погоды, когда морда и погода отсылают пуши и их нужно дедублицировать по content_id)
[пример](https://github.yandex-team.ru/morda/main/blob/dev/scripts/export_to_smoothie_weather.py#L200)

**content_id** - если нужно форсировать уникальный ключ для события (например, отправка медалей, начала передачи и тп - для каждого события создается свой content_id, иначе они будут считаться одним событием)
[пример](https://github.yandex-team.ru/morda/main/blob/dev/scripts/export_to_smoothie_football_2018.pl#L200)

**uniq_postfix** - если нужно отсылать пуши с кастомным системным названием (например, для пушей про начало трансляции добавляется id трансляции, тогда можно будет считать аналитику отдельно по каждому событию)
[пример](https://github.yandex-team.ru/morda/main/blob/dev/scripts/export_to_smoothie_football_2018.pl#L200)

**event_tag** - с индивидуальным тегом подписки для каждого пуша (если на каждое событие будет отдельная подписка)
[пример](https://github.yandex-team.ru/morda/morda-arch/blob/master/scripts/export_to_smoothie_goldenmask_2018.pl#L143)

Создание с from + till для delayed событий
[пример](https://github.yandex-team.ru/morda/main/blob/dev/madm/scripts/export_madm_push.pm#L136)

**Кастомная иконка события для платформы**
```
event = {
    'name': name_alert,
    'geo' : geo,
    'sup_content_id' : alert.get('content_id', ''),
    'data' : {
        'localization' : {
            'ru' : {
                'push' : {
                    'msg' : alert['text_short']['ru'],
                    'url' : {
                        'yaphone_launcher': 'dialog://?open_fullscreen=true&' + url_base,
                    },
                    'icon': {
                        'yaphone_launcher': 'https://yastatic.net'+
                                            '/weather/i/icons/portal/png/96x96/dark/'+
                                            alert['portal_icon']+'.png',
                    },
                },
            },
        },
    },
    'v'  : 2,
};
```


#### Как устроена база
В базе есть таблицы:

**master_events** - текущие события
**options** - опции
**queue** - очередь на отправку пушей и карточек
**settings** - настройки каналов

Дальше настройки внутри каналов:
**settings_geos** - регионы, куда разрешена отправка по каналам
**settings_platforms** - платформы, куда можно слать пуши (браузер, пп etc)
**settings_targetings** - таргеты для рассылок (версии, топики и тп)
**settings_timelines** - разрешенные интервалы отправки


### Взаимосвязи с другими проектами
#### СУП
https://zador.at.yandex-team.ru/89
[Дока СУПа](https://doc.yandex-team.ru/~search/~sup)
СУП это транспорт, который шлет пуши конечным пользователям.
Приложение подписывается на СУП, передавая туда данные - пуш-токен (от транспортов google или apple), uuid, гео, язык, список установленных приложений и другое.
После подписки приложение сможет получать пуши, отправленные через СУП (с помощью пуш-токена)
Задача СУПа - получить пуш-реквест (запрос на рассылку пушей) и выражение для выбора аудитории. После определения аудитории СУП начинает рассылки на конечные установки приложений.
Смузи отправляет пуш-реквесты в СУП. В пуш-реквесте может быть карточка для пользователя, которая из СУПа передается в BASS.

#### Android ПП
Это поисковое приложение под Android.
В зависимости от версий есть разнообразные возможности.
[страница группы разработки приложения](https://wiki.yandex-team.ru/MobileSearch/app/Android/)
[страница про пуши в приложении](https://wiki.yandex-team.ru/mobilesearch/app/android/push-notifications/howitworks/)
[ссылки, которые может обрабатывать](https://wiki.yandex-team.ru/mobilesearch/app/android/tzdljarazrabotki/morda/links/)

#### Ios ПП
Это поисковое приложение под Ios.
Отличается тем, что пуш отрисовывается системой без участия приложения, из-за этого есть масса ограничений на функцоинальность.
В зависимости от версий есть разнообразные возможности.
[вики разработки приложения](https://wiki.yandex-team.ru/MobileSearch/iosapp/)
[ссылки, которое может открывать приложение](https://wiki.yandex-team.ru/MobileSearch/iosapp/url-handling/)

### Как устроена дедубликация и приоритеты пушей
Мы шлём всем в поисковое приложение, указывая в пуше content_id и content_id_policy.
Погода шлёт всем в погодное приложение, у кого нет Поискового приложения (это условие включено в receivers в виде тега apps) с этим же content_id и content_id_policy.
Если тем не менее пуш отправился пользователю в оба приложения, то у СУПа сработает дедубликация по content_id.
Так как мы с погодой используем одинаковые content_id и content_id_policy, то у СУПа рейт-лимитер понимает, что пользователь уже получал такой пуш и не отправляет его.
Алерты с push_portal шлются нами по описанному выше механизму.
Если у алерта нет push_portal, тогда погода шлёт его всем пользователям Погодного приложения без ограничения по Поисковому приложению.

## Полезные ссылки
### Как начать слать пуши в приложение для смежных сервисов
[инструкция](https://wiki.yandex-team.ru/morda/app/Kak-nachat-slat-pushi-v-prilozhenie/)
