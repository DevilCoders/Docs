# Pandora
## Что это
Pandora - пушка для Яндекс.Танка, написанная на go. Расширяемая, можно писать свои компоненты, из коробки умеет стрелять по HTTP(S) и HTTP/2.
Можно запускать с нее стрельбы из танка, используя [Лунапарк](./lunapark.md).
Основная документация [на вики](https://wiki.yandex-team.ru/Load/Pandora/).

## Стрельба по аппхостовым бэкендам
### Пушка
В аркадии есть вариант Пандоры для стрельбы по аппхостовым бэкендам, расположен [тут](https://a.yandex-team.ru/arc/trunk/arcadia/apphost/tools/pandora_gun/gun).
Для использования достаточно собрать ее с помощью `ya make`, после этого можно ее загрузить в лунапарк (альтернативно загрузить в сэндбокс с помощью `ya upload` и в конфиге в лунапарке указать ссылку для загрузки)

### Патроны
Для стрельбы помимо самой пушки потребуются патроны для нее - данные, которые будут посылаться в бэкенд.
Патроны представляют из себя файл с json объектами, по одному на строку, в которых в особом формате указаны нужные параметры.
Для генерации такого файла рекомендуется использовать специальный инструмент, который тоже есть в аркадии, и лежит [рядом с самой пушкой](https://a.yandex-team.ru/arc/trunk/arcadia/apphost/tools/make_tank_ammo).
Как обычно (в аркадии), собирается с помощью `ya make`. Для работы требует файла с данными для патронов. В файле с патронами на каждой строке должен быть json объект с данными для запроса. Пример с описанием полей (json некорректный из-за наличия комментариев):
```json
{
	// path - путь, который обрабатывает нужный обработчик
	"path": "/get_bulk",
	// answers - полный контекст входного запроса
	// в том числе имеет смысл передавать информацию аппхоста (типа app_host_params), ибо иногда она используется в обработке (для логирования, например)
	// если послать запрос граф с указанием cgi параметра dump_json_requests, то поле "requests" для нужной вершины будет содержать примерно то, что должно быть в "answers" (кроме "decoded_protobuf")
	"answers": [
		// каждый объект - объект в контексте
		{
			// binary - непосредственно данные сообщения
			// может быть в "бинарном" виде (закодированные base64), в частности, можно просто скопировать соответствующую строку из жсон дампа для реального запроса
			// может быть в виде строки с жсоном, тогда генератор патронов сам закодирует в "бинарный" вид
			"binary": "Cht0b3BuZXdzX2dsb2J0b3BfMTg3X3VhX3J1dWsKHHRvcG5ld3NfZ2VvdG9wXzEwMzU4X3VhX3J1dWsKH3RvcG5ld3NfdGh0b3Bfc3BvcnRfMTg3X3VhX3J1dWsKInRvcG5ld3NfdGh0b3BfaW5jaWRlbnRfMTg3X3VhX3J1dWsKIXRvcG5ld3NfdGh0b3BfY3VsdHVyZV8xODdfdWFfcnV1awojdG9wbmV3c190aHRvcF9jb21wdXRlcnNfMTg3X3VhX3J1dWsKInRvcG5ld3NfdGh0b3BfYnVzaW5lc3NfMTg3X3VhX3J1dWsKH3RvcG5ld3NfdGh0b3Bfd29ybGRfMTg3X3VhX3J1dWsKIXRvcG5ld3NfdGh0b3Bfc2NpZW5jZV8xODdfdWFfcnV1awoedG9wbmV3c190aHRvcF9hdXRvXzE4N191YV9ydXVrCiJ0b3BuZXdzX3RodG9wX3BvbGl0aWNzXzE4N191YV9ydXVrCiF0b3BuZXdzX3RodG9wX3NvY2lldHlfMTg3X3VhX3J1dWs=",
			// type - "тип" сообщения, т.е. имя, с которым он добавляется и достается из контекста
			"type": "greenbox_get_bulk_request",
			// __content_type - почти всегда тут protobuf, если есть сомнения, стоит посмотреть жсон дамп реального запроса и взять то, что указано там
			"__content_type": "protobuf",
			// source - вершина, из которой пришел объект; почти никогда не используется, но можно указать, если есть сомнения
			"source": "PRE_GREENBOX_TRANSPARENT"
		}
	]
}
```
Приведенный пример - реальные данные для патрона, который когда-то использовался для обстрела одного из сервисов (greenbox).
Помимо этих полей есть еще ряд менее существенных, посмотреть их можно в [коде](https://a.yandex-team.ru/arc/trunk/arcadia/web/app_host/lib/grpc/json/service_request.cpp).

{% note warning %}

Одна строка - один патрон.
Удобно использовать `jq . -c [файл]` для преобразования развернутого жсона в жсон нужного формата.

{% endnote %}

Генератор патронов запускается `./make_tank_ammo --addr [адрес обстреливаемого хоста] --grpc`. Опционально можно указать путь `--path` (то же, что в жсоне патрона), `--shell [имя патрона]` и `-o [файл, в который сложить патроны]`. Полученные патроны можно конкатенировать с другими патронами (все так же одна строка - один патрон), если при обстреле хочется стрелять разными запросами.

### Как стрелять
Стрелять рекомендуется через интерфейс [лунапарка](./lunapark.md).
Увы, интерфейс конфигурации стрельб не очень хорошо ведет себя с пандорой, поэтому большую часть конфигурации придется делать текстом (в нижней части страницы запуска стрельбы есть текстовые поля с конфигом, туда можно писать).
Пример конфигурации можно взять из одной из успешных стрельб, например, [этой](https://lunapark.yandex-team.ru/2799497/repeat) и подправить под свои нужды:
* В `uploader` указать:
  * Название стрельбы (`job_name: 'Балансировка запросов в read-only инстансы'`)
  * Опционально описание стрельбы (`job_dsc: '123'`)
  * Нужный танк (`meta: {use_tank: morda-tank-sas-1.sas.yp-c.yandex.net, use_tank_port: 8083}`)
  * Тикет (`task: HOME-71794`). Когда-то лунапарк плохо себя вел, если указывался несуществующий тикет (`HOME-0`, например), сейчас, может, починили.
* В `pandora` указать:
  * Ссылку на собранную пушку (`pandora_cmd: 'https://proxy.sandbox.yandex-team.ru/2280756022'`). Опционально можно загрузить файл через гуи.
  * Ссылку на патроны (`resources: [{dst: ./ammo.json, src: 'https://proxy.sandbox.yandex-team.ru/2280727569'}]`). Можно загрузить файл через гуи, найти, где его ссылка появилась в конфиге, и скопипастить ее оттуда. Но, наверное, проще через `ya upload` загрузить.
  * В конфиге пандоры (`config_content`):
    * Подменить адрес хоста (`target: 'portal-greenbox-testing-1.sas.yp-c.yandex.net:20400'`)
    * Задать схему нагрузки (`rps: [{duration: 5m, from: 50, to: 1000, type: line}]`)
    * Задать схему выделения потоков (`startup: [{times: 20, type: once}]`)

Схемы нагрузки есть разные, полный список [здесь](https://a.yandex-team.ru/arc/trunk/arcadia/vendor/github.com/yandex/pandora/core/schedule) (в коде каждой схемы есть структура с параметрами, жсон такой структуры надо указывать в конфиге).
Схема выделения потоков задает, когда сколько запросов пандора может обрабатывать одновременно. Максимальный рпс ограничен временами ответа бэкенда и кол-вом потоков.

### Что дальше?
При успешном запуске стрельбы лунапарк автоматически перенаправит на страницу с статистикой по стрельбе. На этой странице можно остановить активную стрельбу, редактировать название и описание стрельбы, а также создать новую стрельбу с тем же конфигом (который можно изменить перед запуском). Помимо этого можно смотреть другие стрельбы из того же тикета и сравнивать их.