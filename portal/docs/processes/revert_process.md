# Универсальная инструкция как провести откат релиза (nanny)

Главное, что нужно знать про сервисы в няне:
  * Конфигурация сервиса имеет историю, напоминающую SVN. В ней есть снапшоты (что-то похожее на коммиты). Посмотреть их можно на [вкладке History](https://nanny.yandex-team.ru/ui/#/services/catalog/avocado/runtime_attrs_history). Причем у сервиса есть две разные истории - Information, и Runtime. Важнее вторая.
  * Между снапшотами можно смотреть дифф. Для этого можно нажать на id снапшота (как коммиты в гите), дальше выбрать с каким снапшотом сравнить.
  * Снапшоты могут иметь несколько состояний
    * Просто снапшот в истории.
    * Снапшот в состоянии **PREPARED** - физически контейнеры лежат в файловой системе хост-машин. Одновременно количество таких снапшотов может быть только ограниченное количество. Обычно 5. Если вы хотите удалить из сервиса под - нужно, чтобы не было ни одного снапшота в состоянии **PREPARED**/**ACTIVE** на этом поде.
    * Снапшот в состоянии **ACTIVE** - запущенный в данным момент контейнер. Если в инстанс зайти по ssh, то попадаешь в снапшот в состоянии **ACTIVE**.
    * Снапшот с указанием **current**, он же помечается как **HEAD** в интерфейсе реверта. Это "последнее" состояние конфигурации сервиса, от которого будут сохраняться все проделываемые изменения. Если нажать на id снапшота в интерфейсе няни, можно там же нажать `set as current`, таким образом получив соответствующую конфигурацию сервиса.
    * Снапшотам можно сделать **checkout** по аналогии с коммитами в SVN - получается соответствующая конфигурация сервиса, которая при этом не сохранена. Становится доступная кнопка **Save** слева.


Открываем дашборд - тот же, через который релиз выкатывался.

![Выбираем Revert](../images/revert/1.png){: .center}

Выбираем Revert

![смотрим](../images/revert/2.png){: .center}

Пояснение
  * первая строчка - список состояний сервсив с дашборда.
  * Каждое состояние может затрагивать все или часть сервисов
  * В этом примере видно, что релиз в тестинг и в прод - два разных "состояния"
  * Кнопки **To** и **From** позволяют откатиться на предшествующее выбранному состояние или на выбранное конкретно.
    Обычно разницы не много, но иногда это полезно. Главное после выбора посмотреть, что получится.

![Нажимаем и убеждаемся что все правильно](../images/revert/3.png){: .center}

Выбираем откатываемый релиз, нажимаем **From**, чтобы его откатить. Или выбираем последнее известное стабильное состояние и нажимаем на нём To. В примере стрелки указывают на равнозначные варианты выбора. Зачеркнутое состояние - релиз, выложенный в тестинг.
  * Здесь желтым отмечен сервис, на который реверт никак не повлияет
  * **HEAD** - помечен текущий current снапшот. Снапшот с актуальной конфигурацией сервиса. Он не обязательно включен, но любые изменения сервиса делаются от него.
  * Синим - текущий активный (current) снапшот
  * Зеленым (оно же [previous]) - снапшот предыдущий перед текущим активным. На скриншоте таких не видно, потому что серый перекрывает зеленый
  * Серым - снапшот, который будет помечен как current (актуальный) после реверта
  * Полоски слева от снапшотов - показывают их состояние в сервисе - синий == активный, зеленый == prepared. Откат на prepared снапшот будет быстрее, а откат на не-prepared снапшот и вовсе может быть невозможен, если необходимые ресурсы уже удалены. Но это редкий случай.
  * Так же есть кнопка булавки, которая позволяет принудительно пометить снапшоты как current.

После выбора нужного релиза, жмем рядом синюю кнопку **Revert**

![Убеждаемся](../images/revert/4.png){: .center}

Убеждаемся, что откатываются нужные сервисы на нужные снапшоты, жмем **Apply**

![Еще раз убеждаемся](../images/revert/5.png){: .center}

Теперь мы видим куда указывает новый **HEAD**, и какие снапшоты будут отреверчены (подписаны красным)

![Возвращаемся в дашборд и жмем деплой](../images/revert/6.png){: .center}

Возвращаемся в дашборд и жмем деплой как при обычном релизе

![Возвращаемся в дашборд и жмем деплой](../images/revert/7.png){: .center}

Выбираем необходимый рецепт
  * у геохелпера есть специальный рецепт для ускоренного отката - все три локации откатываются одновременно
  * У морды тоже есть рецепт для отката, но он такой же как обычный

![Возвращаемся в дашборд и жмем деплой](../images/revert/8.png){: .center}

Жмем **Deploy**, опять **Deploy** внизу

![Возвращаемся в дашборд и жмем деплой](../images/revert/9.png){: .center}

Катим как обычный релиз, дожидаемся отката
