## Разбор инцидентов
![alt text](https://yastatic.net/s3/abc-front/_/l5kr6h0iKzbpt3seDiyfDP3gzPU.ico "Текст подсказки" =20x20)
 [Телеграмный чат, в который можно обратиться за помощью с разбором](https://t.me/+_7Z45LcvNLFhMGVi)
### SLA
- Дежурный должен завести инцидент сразу после того, как причина инцидента ликвидирована и нет риска рецидива в ближайшем времени. Иначе направляем силы на тушение пожара и предотвращение рецидива.
- Графики и необходимые для разбора инцидента цифры должны быть приложены к тикету в течение 7 дней (через 7 дней 5-секундные интервалы кривулин в Головане агрегируются в 5 минутные, что усложняет подсчет потерь).
- Инцидент должен быть разобран и закрыт в течение 10 <u>рабочих</u> дней с момента заведения.

### В каких случаях заводятся инциенты
Инцидент должен заводиться при любой серьезной поломке, серьезными поломками в том числе являются:
- Показали пользователям тыкву, раскуроченную морду, пятисотки, вообще ничего не показали.
- Поломки блоков на Морде.
- Пользователю показали что-то нехорошее или показали что-то не тогда, когда нужно (и понесли репутационные потери или был высокий риск их понести).
- Поломки рекламы (денежные потери).

### Кто разбирает инцидент
- Если большая часть знаний об инциденте сосредоточена у менеджера, то SPI разбирает менеджер.
- Если это баг и он весом 100+, то SPI заводит дежурный тестировщик и разбирает его. На меньший вес SPI не заводим.
- Если сломана инфра или бекенд, то разбирает дежурный бекенда.
- Если сломан фронт (например, раскорячило верстку), то разбирает дежурный фронта.
- Если инцидент возник из-за релиза, но релиз катил не дежурный, то SPI разбирает тот, кто катил!

### 1. Заведи SPI тикет
SPI тикеты заводятся через [Тикенатор](https://tickenator.z.yandex-team.ru/new-ticket/spi).

#### Поля тикенатора
Для заведения SPI достаточно заполнить обязательные поля (**\***), остальную разметку тикета можно сделать потом, когда будет достаточно данных.

Имя | Описание | Пример значения | Поле в тикете
:--- | :--- | :--- | :---
[Компонента](#product)* | Аварии должны быть привязаны к нашей [_компоненте_](https://warden.z.yandex-team.ru/components/portal) в каталоге дежсмены. Всегда `portal` | `portal` | Поле `Components (Компоненты): portal` и тег `product:PROD-PORTAL`
[Контур](#env)* |  В каком окружении случилась авария. У нас пока только `prod`. | `prod` | Тег `env:prod`
[Начало проявления](#begin_time)* | Время, когда инцидент начал себя проявлять на конечных и/или внутренних пользователях | `2022-04-15T09:57:28.967` | `SRE: Begin Time \| Время начала`
[Время уведомления](#notification_time)* | Время, когда была принята информация об инциденте | `2022-04-15T09:57:28.967` | `SRE: Notification Time \| Время начала`
[Конец проявления](#end_time) | Время, когда поведение сервиса/инфраструктуры пришло в норму и влияния на пользователей внешних/внутренних больше нет | `2022-04-15T09:57:28.967` | `SRE: End Time \| Время окончания`
[Сервис](#service) | Выбери пострадавшую морду ([список здесь](https://warden.z.yandex-team.ru/components/portal/services)), если не удается локализовать до конкретной поверхности или неприменимо, то выбери `all` | `MORDA_DESKTOP` | Тег `service:XXX`
[Датацентр](#dc) | Если проблема наблюдалась во всех ДЦ, то выбери `all`, иначе укажи конкретный ДЦ | `all`, `vla` | Тег `dc:xxx`
[Линия поддержки](#support_line) | Линия, на которой влияние инцидента было купировано, обычно ```service``` [описание](#support_line) | `service` | ```SRE: support_line```
[Кто обнаружил проблему](#incident_reporter) | Кто принес проблему. Если мы сами увидели проблему, то проставь ```service``` [описание](#incident_reporter) | `service` | ```SRO: Incident Reporter```
Заголовок | Краткое описание инцидента. Суть аварии в одном предложении | `Деградация ленты Дзена на десктопе`
Протокол | Всегда `green` | `-` | `SRO: Incident Protocol`
Rollback | Поставить галочку, если откатывали релизы | `-` | Тег `rollback`
-1 датацентр | поставить галочку, если связано с аварией ДЦ / регламентными работами или подготовке к ним | `-` | `SRO: Минус 1 ДЦ \| Minus 1 DC`

В результате создается тикет в очереди SPI. Сразу переведи его в статус `Диагностика` (если в процессе решения проблемы, которой вызван инцидент), или `Сервис восстановлен` (после решения проблемы).

(Флоу статусов в тикете следующий: `Новый` -> `Диагностика` -> `Сервис восстановлен` -> `Закрыт`)

{% note warning %}

Если инцидент вызван поломкой другого сервиса, то в тикете добавляется тег `spi:victim`. Нужно прилинковать SPI виновника и убедиться, что в нем есть тег `spi:umbrella` (добавить, если его нет).

{% endnote %}

### 2. Закрой тикет, если это дубликат
Если это дубликат другого инцидента, то переведи статус в `Диагностика | Analyze` и нажми `Закрыть`.  В появившемся окне в поле `Резолюция` выбери `Дубликат` и укажи дублируемый тикет. Заполни поля `support_line`, `SRE area` и `impact`.

### 3. Заполни разделы в описании тикета
    
**Что во время инцидента видели пользователи**
        
Напиши как авария себя проявила для пользователей или смежного сервиса. Если есть примерное понимание кого затронуло — укажи здесь же.

**Описание**
        
Здесь нужно коротко (в пару предложений) и понятно написать что произошло и причины возникновения.

**Диагностика**

Добавь в этот раздел ключевые ссылки / логи / графики — те, которые помогают понять время и масштаб проблемы. Остальное оставь в комментариях. Длинные ссылки или графики стоит прятать под кат с описанием.

**Хронология событий**
- как обнаружили (кто/где зарепортил проблему или когда отреагировали на мониторинг)
- основные этапы починки
- как и когда уведомили смежников и анонсировали во внутренних координационных чатах
- когда пользователи перестали замечать проявление проблемы / починка полностью закончилась

{% note info "Используй следующий формат" %}

Если хронология укладывается в один день, то формат такой:
```
- 9:10 — выложили бажную задачу такую-то с релизом
- 12:15 — в дежурный чат пожаловались на проблему
- 13:00 — откатили релиз
- 14:50 — собрали и выложили хотфикс
```
Если дней несколько — выделяем их bold'ом и помещаем между списками:
```
**28.06**
- 19:30 — случилось событие
- 21:12 — заметили
**29.06**
- 13:10 — начали чинить
```

{% endnote %}

**Анализ**

Напиши что было хорошо, а что пошло не так.
```
**Хорошо**
- Быстро обнаружили проблему по сработавшему мониторингу
- Быстро откатили
**Плохо**
- Не увидели проблему в тестинге
```

### 4. Заполни SRE поля
* #### `Компонента` { #product }
    Аварии должны быть привязаны к нашей [_компоненте_](https://warden.z.yandex-team.ru/components/portal) в каталоге дежсмены — `PROD-PORTAL`.
    Для этого в тикете должны быть указаны:
    - **компонента** `portal`
    - **тег** `product:PROD-PORTAL`

* #### `Контур` { #env }
    В каком окружении случилась авария. У нас пока только `prod`.

    Указывается **тегом** `env:xxx`.

* #### `Датацентр` { #dc }
    В какой локации случилась авария: `all` или конкретный датацентр.
    
    Проставь **тег** `dc:xxx (vla|sas|man)` или `dc:all`.
    Если ДЦ несколько или неприменимо — ставь `dc:all`.

* #### `SRE: Begin Time | Время начала` { #begin_time }
    Время, когда произошла поломка. Время когда инцидент начал себя проявлять на конечных и/или внутренних пользователях. Например стал заметен на графиках или в логах. Также может быть временем получения жалобы от пользователя или сообщения от команды. Для мониторингов нужно учитывать задержку или порог срабатывания (вычесть из времени срабатывания). Для багов, выкаченных с релизом или проявившимся при переключении фичи/проперти — брать время релиза/переключения (исключение: для однозначно идентифицируемых по логам ошибок — взять время первой ошибки).
* #### `SRE: End Time | Время окончания` { #end_time }
    Время, когда поведение сервиса/инфраструктуры пришло в норму и влияния на пользователей внешних/внутренних больше нет. Включает в себя стабилизацию системы, например нагон отставания или разбор накопившихся очередей до типовых значений.
* #### `SRE: Notification Time | Время уведомления` { #notification_time }
    Время когда была принята информация об инциденте.
* #### `SRE: support_line` { #support_line }
    Линия, на которой влияние инцидента было купировано. То есть проявление инцидента на пользователях (или на приборе, если это внутренне) было устранено. Так же используется при эскалации инцидента. Если дежурный сам со всем справился, то поставь `duty`, если пришлось привлекать команду, то ставь `service`. { #support_line }

    * `marty` - если инцидент ликвидировали дежурная смена или он прошел сам
    * `devops` - если у дежурной смены не было инструкций по локализации инцидента, и для устранения инцидента привлекались девопсы вертикали
    * `noc` - дежурные  NOC
    * `platform` - дежурные Платформы
    * `service` - если и девопсы не смогли самостоятельно разобраться в причинах инцидента и для починки были привлечены ответственные или разрабочики сервиса

* `SRE: SRE area` — высокоуровневое описание локализации проблемы (из-за чего сломалось). Тегов area может быть несколько.

    * `human` — человеческая ошибка, не контролируемая никакой автоматикой или все, что попадает под термин "незнание не освобождает от ответственности".
    * `operations` — инцидент случился при регламентных операциях, учениях.
    * `release` — проблема возникла при релизе компонента.
    * `bug` — ошибка в коде, которая не была замечена ни в тестах, ни при релизе, а проявилась при ином стечении обстоятельств;
    * `service` — проблема в архитектурном устройстве сервиса или взаимодействии его с другими смежными сервисами;
    * `net` — аварии сетевой инфраструктуры;
    * `platform` — аварии платформы; проблемы во взаимодействии сервиса с облачной платформой, например, неправильно посчитанные лимиты; или наведенный эффект соседнего сервиса; или проблемы железа etc;
    * `mds` — аварии mds/s3;
    * `saas` — аварии saas;
    * `apphost` — аварии инфраструктуры apphost;
    * `balancer` — аварии системы балансировки трафика;
    * `monitoring` — некорректно настроенные алерты, подземные стуки;
    * `external` — внешнее событие, например, просадка доли из-за хоккейного матча; новостной повод, приведший к непрогнозируемому росту нагрузки, авария внешней связности провайдеров

* #### `SRO: Incident Reporter` { #incident_reporter }
    Кто принес проблему:
    * `monitoring` — по срабовавшему мониторингу,
    * `marty` — дежурная смена,
    * `service` — команда сервиса заметила проблему,
    * `user` — клиенты сервиса сообщили о проблеме
    * `external` — проблему принесли снаружи, например написали в новостях

* #### `SRE: impact` { #impact }
    * `external` — пострадали внешние пользователи.
    * `internal` — пострадали только внутренние пользователи или инфраструктура.

### 6. Прилинкуй Action Items (AI)

AI - задачи, которые мы делаем для того, чтобы инцидент не повторился.

На все AI должны быть заведены тикеты (в очереди HOME) с тегом `spi:actionitem` и связаны с головным SPI как `Blocker to`.
Чтобы автоматика сама все сделала, просто добавь ссылки на AI-тикеты в раздел `Меры предотвращения` описания SPI-тикета.

Если нет понимания, какими AI можно решить инцидент, то собирается встреча по разбору инцидента с релевантными людьми, предварительно согласовав это со своим руководителем или SRE, иначе поставь тег `no_meeting` (встреча не требуется).

(все заведенные AI закидывает в [планирование](https://wiki.yandex-team.ru/morda/planning/#order) ["комитет девяток" Морды](https://docs.yandex-team.ru/portal/processes/spi_ydt#tekushij-sostav-kluba-devyatochnikov-mordy) согласно своему приоритету)
### 7. Подсчитай потери

{% note info "" %}

В случае поломки рекламы потери считаются в фишках

{% endnote %}

#### 7.1. Подсчитай Vertical Downtime (VDT)

VDT — даунтайм вертикали.

В общем случае VDT считается по формуле:
            
`VDT` = `Duration` × `Вес морды` × `Вес функциональности` × `Доля пострадавших пользователей`
            
`Duration` — длительность инцидиента в секундах.

`Вес морды` — вес поверхности на которой сломалась функциональность. Чтобы определить вес нужно зайти [сюда](https://warden.z.yandex-team.ru/components/portal/services) и выбрать подходящую поверхность. Вес указан в `Weight`. Если поверхностей несколько, то суммируем их веса в формуле.

`Вес функциональности` — вес функциональности. Вес нужной функциональность можно найти в warden [здесь](https://warden.z.yandex-team.ru/components/portal/functionality). Если ничего подходящего в списке нет, то можно обратиться в `Morda Incidents Support` за помощью, а после определения веса занести функциональность Warden, чтобы упростить рассчет коллегам и себе в будущем.

`Доля пострадавших пользователей` — Примеры:
- раскатили релиз на престейбл (1/3 продакшена), откатили из-за ошибок — 0.33
- любой пользователь мог увидеть ошибку — 1
- эксперимент был включен на 5% пользователей — 0.05

Получившийся Downtime впиши в поле `Даунтайм вертикали | Vertical Downtime`.

{% note info "" %}

Если Downtime посчитать не представляется возможным, проставь его равным 0.165

{% endnote %}


{% note info "Пример" %}

40% неответов ручки корзины Маркета на Десктопе, ПП и Таче в течение 20 минут.

`VDT` = `Duration` × `Вес морды (Десктоп+ПП+Тач)` × `Вес функциональности` × `Доля пострадавших` = 1200 ⨯ (0.26 + 0.18 + 0.264) ⨯ 0.01 ⨯ 0.4 = 3.4с

{% endnote %}

#### 7.2. Подсчитай Yandex Downtime (YDT)
YDT считается как `impact_vertical` ⨯ `VDT`.

На момент написания статьи `impact_vertical` = 0.4 (текущий вес можно посмотреть тут — https://warden.z.yandex-team.ru/components/portal в поле `Weight`)

Впиши получившееся значение в поле `Даунтайм Яндекса | Yandex Downtime`.

{% note info "На примере поломки Маркета из предыдущего примера" %}

`YDT` = 0.4 × `VDT` = 0.4 ⨯ 3.4 = 1.36с

{% endnote %}

#### 7.3. Подсчитай потери в деньгах (фишках)
Если поломка связана с рекламой или дистрибьюцией, то потери считаются в фишках.

Урон в фишках может помочь подсчитать juliaorlova@ или релевантный менеджер Морды.

После подсчета занеси рассчет в раздел `Потери` описания тикета.

Фишки, они же `chips`, они же `YND_FIXED` — условная единица денег. На момент написания статьи 1 фишка приравнивалась к 30 рублям (с НДС равным 18%).

https://docs.yandex-team.ru/direct-dev/glossary/glossary#fishki-fishki-chips


{% note info "Инцидент считается разобранным, если:" %}

* инцидент в статусе "Закрыт" с резолюциями "Не воспроизводится", "Дубликат" и "Рецидив". В последних двух случаях должны быть ссылки на SPI дубликат или первое проявление, соответственно.
* инцидент в статусе "Закрыт" с резолюцией "Решен" или в статусе "В разработке" и есть ссылки на AI (связанные тикеты с тегом spi:actionitem), либо это проявление известной проблемы и к инциденту должен прилинкован тикет из очереди SPPROBLEM. Описание флоу очереди SPI.
* инцидент является следствием другого инцидента, в этом случае должен у инцидента должен быть тег spi:victim и связанный тикет с тегом spi:umbrella

{% endnote %}
