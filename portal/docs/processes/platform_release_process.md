# Процесс релизов в Платформе
(на примере Morda Go)

[чаты по теме](../devops/chat_list):
* [Морда (факапочная)](https://t.me/joinchat/BlyRekEwILp56Vu030x2gg) | Координация факапов Морды (дежурным мьютить нельзя)
* [Морда Platform (мониторинг)](https://t.me/+UdBbeXWuF8xjM2Qy) | Сообщения от мониторинга Платформы
* [Покатушки Морды](https://t.me/joinchat/BlyRek7XrnZIJpDaD8C3kQ)
* [Морда Product (мониторинг)](https://t.me/joinchat/BlyRegsiusIHkvRRW8y7Ug) | Сообщения от мониторинга

1. Откройте [дашборд Морды](https://a.yandex-team.ru/projects/home/ci/releases/timeline) в Аркадии.
2. Выберите сервис, который собираетесь катить.
![](https://jing.yandex-team.ru/files/yanykin/platform_release_process__choose_service.png =x600){: .center}
3. Проверьте, что в таймлайне есть все коммиты, которые нужно выкатить. После мёрджа pull request'а в trunk проходит 5-10 минут, чтобы коммит попал в таймлайн. Если его нет, то добавьте вручную.
![](https://jing.yandex-team.ru/files/yanykin/platform_release_process__add_commit.png =x150){: .center}
4. Дополнительно пройдитесь по всем тикетам, которые попадут в релиз и проверьте, что их статус находится в "Release to RC"
   ![](https://jing.yandex-team.ru/files/yanykin/platform_release_process__ticket.png =x600)
5. Нажмите Run release. Коммит, с которого собирается релиз, оставьте без изменений: им будет считаться наиболее поздняя ревизия, которая появилась в таймлайне (автоматически или вручную). В таймлайне появится плашка с новым релизом. Там же можно посмотреть ревизии, которые попали в новый релиз с момента предыдущего.
![](https://jing.yandex-team.ru/files/yanykin/platform_release_process__new_release.png =x600){: .center}
6. По ссылке можно попасть в граф релиза (выполняется слева направо). Основные стадии:
    * Build: сборка бинарника и создание релизного тикета.
    * Testing: выкатка бинарника на тестовый контур с последующим прогоном интеграционных и схема-тестов. На этом этапе **обязательно** призывать авторов коммитов с просьбой проверить их правки на rc.yandex.ru. Как только разработчик/тестировщик проверит тикет, он должен быть переведён в "Testing at RC"
      * Если упали интеграционные тесты (Run integration tests), то зайдите в Sandbox-задачу и проверьте, что именно там упало (тут нужно подробное описание того, что и как смотреть в упавших тестах).
    * Prepare for stable: стадия запускается вручную только после того, как все тикеты будут проверены. На этой стадии:
      - создаётся и активируется снапшот на RCM (тестовый контур в продовом окружении): portal-prestable.yandex.ru. Перед выкаткой в прод необходимо проверить в работоспобности Морды на RCM.
      - на Nanny-сервисах создаётся новый снапшот с новой версией бинарника и переводится в состояние Prepared.
    ![](https://jing.yandex-team.ru/files/yanykin/platform_release_process__prepare_for_stable.png =x400){: .center}
7. Когда пройдут все тесты, переведите статус релизного тикета в "Протестировано".
8. **Обязательно** предупредите дежурных (команда `/onduty`) в чатике Покатушек о том, что собираетесь катить релиз. Это нужно, чтобы не пересекаться с релизами других сервисов, учениями и регламентными работами.
9. Перед включением одного пода во VLA вооружитесь следующими панельками:
    * [Общая панель дежурного Морды](https://yasm.yandex-team.ru/template/panel/morda_lights_dezh/mode=full)
    * [Панелька графа ПП](https://yasm.yandex-team.ru/menu/Portal/Avocado/morda-app/apphost_template_morda_searchapp/)
    * [Панелька графа десктопа/тача](https://yasm.yandex-team.ru/menu/Portal/Avocado/morda-go/apphost_template_morda_v2/)
    * [Панелька подграфа Новостей](https://yasm.yandex-team.ru/menu/Portal/Avocado/morda-app/apphost_template_top_news/)
    * [Панель ошибок Error Booster для Аппхоста](https://nda.ya.ru/t/18cqrds84ThBRn)
    * [Панель ошибок Error Booster для Morda Go](https://nda.ya.ru/t/OZrv1V6S4fny8i)
    * [Панель ошибок Error Booster c клиентскими ошибками Морды в ПП Андроид](https://nda.ya.ru/t/wLlnJuLx4ThDVg)
    * [Панель ошибок Error Booster c клиентскими ошибками Морды в ПП iOS](https://nda.ya.ru/t/oP9K912L4ThEYS)
10. Предупредите в Покатушках о том, что включаете один хост во VLA.
11. Активируйте один под во VLA.

    Панель Error Booster'а для первых подов Morda Go (по одному на web и ПП): https://nda.ya.ru/t/l5DG8DGh4n5JYT
12. Убедившись, что всё в порядке, начните раскатку на весь VLA. Ошибки в конкретной локации можно так же отфильтровать в EB: https://nda.ya.ru/t/8Xns7wTD4n5Jxh
    ![](https://jing.yandex-team.ru/files/yanykin/platform_release_process__activate_vla.png =x600){: .center}
    После полной раскатки подождите 5-10 минут и затем повторите для остальных локаций (Activate SAS/MAN).
13. На панелях графов можно увидеть большое количество ошибок вида Fast Errors – это нормально. Такие ошибки возникают, когда Аппхост не может сделать запрос в один из подов бэкенда, на который выключается релиз, поскольку во время переключения снапшота часть подов становится недоступным. В этом случае присходит перезапрос в другой под.
    ![](https://jing.yandex-team.ru/files/yanykin/platform_release_process__fast_errors.png =x200){: .center}
14. Готово, релиз выкачен

## Если что-то пошло не так {when-something-goes-wrong}
1. Остановите текущую выкладку на графе CI (задания Activate)
2. Если релиз как-то влияет на пользователей, то попросите Марти в Мордячем Мартичате снять трафик Морды с локации, на которой начались проблемы (как правило, это VLA).
3. Остановите релиз в панели СI, выбрав пункт Cancel.
   ![](https://jing.yandex-team.ru/files/yanykin/platform_release_process__cancel.png =x100){: .center}
4. Откатите уже выложенные локации через панель CI, нажав Rollback to последнего успешнего релиза (как правило, предыдушего)
    [Инструкция по откату](revert_process_ci)
   ![](https://jing.yandex-team.ru/files/yanykin/platform_release_process__rollback_to.png =x100){: .center}


## После релиза

Через некоторое время после релиза (и, может, после учений) имеет смысл проверить потребление ресурсов (например, [процессора](https://yasm.yandex-team.ru/arc/signals=quant(portoinst-cpu_limit_usage_perc_hgram,95);hosts=ASEARCH;itype=wfront;ctype=production/?range=21600000&deltas=86400%2C172800&by=nanny)) у выкаченных сервисов и сравнить его с предыдущими днями (с предыдущими рабочими днями для понедельника и вторника), чтобы вовремя заметить серьезные баги в релизе (утечки или просто неоправданно большое потребление ресурсов), а также в предыдущих релизах (если потребление ресурсов постоянно растет, но падает при релизе, даже если оно не триггерит алерты на потребление ресурсов, имеет смысл поразбираться, из-за чего так происходит).