## Скрипт загрузки виджета Эфира на сайты партнеров

### Тестовое окружение

Исходный код скрипта находится в папке `src`

Для тестирования работы скрипта перейти по адресу `http://<адрес dev стенда>/test_htdocs/stream-widget/`

### Логика работы

Код вставки распространяется в формате

```html
<div class="efir-widget" data-id="some-content-id" data-something="..."></div>
<script defer src="http://yastatic.net/..."></script>
```

Минифицированный скрипт необходимо загрузить по адресу:
```
https://yastatic.net/s3/home/stream/widget/loader.min.js
```

Если на странице используется несколько виджетов, инициализация будет произведена в момент загрузки первого скрипта. Дальнейшая попытка выполнить скрипт виджета запустит синхронизацию.

В момент инициализации происходит синхронизация и подписка на события `message` для броузеров, поддерживающих метод `document.addEventListener`, и `onmessage` - для IE.

Синхронизация виджетов подразумевает поиск контейнеров на странице и присвоение им уникальных идентификаторов.

В новые контейнеры будет добавлен `iframe` с указанным в коде скрипта `src`.

В get-параметрах будут переданы dataset-атрибуты контейнера в нотации camelCase. Вместе с dataset-атрибутами будут переданы дополнительно:
 - `wid` - уникальный идентификатор виджета на странице;
 - `l` - hostname и pathname родителя.

В начальный момент времени высота `iframe` будет равна 0.

Страница, загруженная в `iframe`, должна отправить `postMessage` наружу с одним из разрешенных типов сообщения.

### Сообщения

Страница, загруженная в `iframe`, может отправить в окно родителя сообщение, используя метод `window.parent.postMessage`.

При инициализации виджета на странице происходит подписка на такие сообщения.

Сообщения следует отправлять в формате:

```
{
    type: String,
    payload: Object
}
```

#### resize

Тип `resize` заставит обновить высоту `iframe`. Такое сообщение следует посылать, когда содержимое виджета изменилось, чтобы на странице родителя виджет не имел полос прокрутки.

Формат сообщения:

```
{
    type: 'resize',
    payload: {
        wid: String, // Индентификатор виджета
        height: Number // Высота виджета
    }
}
```

### error

Тип `error` выведет сообщение в консоли родителя и скроет контейнер при необходимости.

Формат сообщения:

```
{
    type: 'error',
    payload: {
        wid: String, // Идентификатор виджета
        fatal: Boolean, // Флаг серьезности ошибки, если true - виджет будет скрыт
        <...> // Любая информация, которая будет выведена в консоли родитея
    }
}
```

## Управление скриптом загрузки

Чтобы отменить автоматичесую инициализацию при запуске скрипта, в глобальный объект необходимо положить свойство `defer` со значением `true`.

По-умолчанию скрипт создает инстанс по пути `document.Ya.efirWidget`

Соответственно в `<head>` страницы родителя нужно добавить скрипт вида:

```
if (!document.Ya) {
    document.Ya = {};
}

if (!document.Ya.efirWidget) {
    document.Ya.efirWidget = {};
}

document.Ya.efirWidget.defer = true;
```
