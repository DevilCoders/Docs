## urelease

Набор скриптов для создания релизов поверх trendbox/tkit. Есть возможность независимо релизить несколько проектов,
а также проекты, состоящие из нескольких компонентов. Релизы управляются созданием специально отформатированных тегов.

Фичи:
- определение необходимости пересборки компонента
- возможность деплоя в s3
- возможность деплоя в няню
- создание релизного таска, куда будут прилинкованы все таски из диффа
- отправка сообщения о сборке релиза в телеграм чат
- создание тега с автоинкрементом версии

### Установка

`npm i --save-dev urelease`

### Создание тегов

1. Первый тег для каждого проекта из конфига нужно создать руками `git tag <project>-<version>`
версию можно указать в 2 форматах
* `год-месяц-день-номер`, например `2020-05-15-0`. При инкременте будет использоваться текущая дата и следующий номер. Первый номер каждого нового дня - 0.
* semVer или любой другой формат с разделителями-точками. Инкрементироваться будет последний сегмент.

Рекомендуется использовать формат с датой.

2. Для последующего создания новых релизов следует использовать команду `npx create-release --project <project>`
По-умолчанию после создания тега он автоматически пушится в origin. Чтобы этого не происходил, нужно передать параметр `--nopush`.
Перед созданием тега будет выведено дерево изменений от предыдущего релизного тега.

### Quick start

1. Настроить [tkit](https://github.yandex-team.ru/maps/infra/tree/master/packages/tkit).

В конце этого шага должно получиться так:
- в основной ветке вашего репозитория есть конфиг .trendbox.yml
- в конфиге .trendbox.yml включена обработка тегов
- trendbox.yml настроен на запуск скрипта tkit

2. Положить в корень репозитория конфиг `.urelease.js` с нужными настройками
```js
module.exports = {
    sandbox: {
    /* Группа или пользователь, от которой будет создан релизный таск в сандбоксе.
     * Требуется, если в проекте есть хотя бы один ресурс, который деплоится няней
     */
        owner: '...'
    },
    repo: {
    /* Информация о git репозитории. Только внутренний гитхаб.
     * В этом примере указан репозиторий https://github.yandex-team.ru/morda/main
     */
        owner: 'morda',
        name: 'main'
    },
    /* Компонент - это наименьшая независимо пересобираемая часть проекта.
     * Компоненты именованы, поэтому декларируются как объект */
    components: {
        perl: {
            // Путь, относительно которого будут выполняться команды сборки и деплоя
            root: '.',
            /* Команда, которой компонент будет собран. Здесь можно передать функцию,
             * которая возвращает строку - команду для сборки. Смотри пример далее.
             * При выполнении команды env будет дополнен переменными
             * PROJECT, VERSION и INSTANCE
             */
            command: 'fakeroot debian/rules build binary',
            /* Набор сценариев для деплоя. Сейчас есть только два класса сценариев - s3 и няня.
             * Каждый сценария есть обязательное свойство path - что деплоить.
             * Для сценария деплоя в няню требуется указать свойство resource - сандбокс-тип ресурса.
             * Для сйценария деплоя в s3 требуется указать свойство s3path - место, в которое будут заливаться файлы.
             * Здесь может быть передана функция, возвращающая массив. Смотри пример далее.
             */
            deploy: [
                    {
                        path: 'debian/portal-morda-front/',
                        resource: 'PORTAL_MORDA_FRONT_BETA_TARBALL'
                    },
                    {
                        path: 'debian/tune2-static/',
                        // путь болжен начинаться с бакета. В этом примере бакет - home-static
                        s3path: 'home-static/tune/_'
                    },
                ]
            },
            /* Список файлов, влияющих на компонент.
             * Если в релизе будут изменения в этих файлах,
             * то компонент будет пересобран.
             * Формат записи аналогичен строкам в .gitignore
             */
            files: [
                '!tmpl/**',
                '!package.json',
                '!package-lock.json',
                '!hermione/**'
            ]
        },
        complicatedComponent: {
            root: '.',
            /* В функцию передаётся объект с 3 свойствами:
             * project - в составе какого проекта собирается компонент (компонент может быть частью нескольких проектов)
             * version - собираемая версия
             * instance - собираемый инстанс
             * Подробнее про версию и инстанс делее.
             * Функция должна возвращать строку - команду, которая соберёт компонент.
             */
            command: function ({project, version, instance}) {
                /* Здесь может быть любой синхнонный js код */
                return `QWE=${math.random()} fakeroot debian/rules build binary`;
            },
            deploy: function ({project, version, instance}) {
                const s3root = instance ? 'home-beta' : 'home-static';

                return [
                    {
                        path: 'debian/portal-morda-tmpl/',
                        resource: instance ?
                            'PORTAL_MORDA_TMPL_BETA_TARBALL' :
                            'PORTAL_MORDA_TMPL_TARBALL'
                    },
                    {
                        path: 'debian/yandex-www-static/',
                        s3path: `${s3root}/${version}`
                    },
                    {
                        path: 'debian/yandex-www-static/freeze',
                        s3path: `${s3root}/_`
                    }
                ];
            },
            files: [
                '*.*'
            ]
        },
        /* Проект - это минимальная единица релиза.
         * Релизы привязаны именно к проекту.
         */
        projects: {
            one: {
                /* Список названий компонентов, из которых состоит проект.
                 * Проекты могут иметь общие компоненты.
                 */
                components: ['tmpl', 'complicatedComponent'],
                startrek: {
                    /* В какой стартрек очереди будет создан релизный таск.
                     * В этой очереди должен быть тип release
                     */
                    releaseQUeue: '...',
                    /* Задачи из какой очереди нужно линковать к релизному таску.
                     * Можно указать массив, чтобы линковать задачи из нескольких определённых очередей.
                     * Не обязательное поле.
                     */
                    taskQueue: '...',
                    /* Список статусов, которые нужно игнорировать при
                     * поиске открытого релизного таска.
                     * Подробнее про действия с релизными тасками ниже.
                     */
                    skip: ['postponed', 'deploying']
                },
                /* Список вебхуков, которые будут переданы в сандбокс таск
                 * при деплое в няню.
                 */
                webhooks: [
                    'https://example.com/webhook/handle'
                ]
            }
        }
}
```
3. Получить нужные токены и положить их в env со следующими именами
* **GITHUB_OAUTH_TOKEN** - для получения информации о прошлых релизах
* **SANDBOX_TOKEN** - для деплоя в няню
* **ABC_TOKEN** - для получения списка дежурств
* **STARTREK_TOKEN** - для создания и изменения релизных тасков
* **AWS_ACCESS_KEY_ID** и **AWS_SECRET_ACCESS_KEY** - для деплоя в s3

Токен должен быть получен для того робота, под которым запускается tkit и должен быть положен в [Vault](https://sandbox.yandex-team.ru/admin/vault) под именем `env.<TOKEN_NAME>`, чтобы быть доступным в виде env переменных.
Универсальный токен для сандбокса, abc и стартрека можно получить [по этой ссылке](https://oauth.yandex-team.ru/authorize?client_id=a6248045ec214f88b5c3826edb3507c9&response_type=token).
Мануал по получению токенов для s3 есть [на вики](https://wiki.yandex-team.ru/mds/s3-api/authorization/#upravlenieaccesskeys).
Токен для гитхаба нужно получить [в гитхабных настройках](https://github.yandex-team.ru/settings/tokens) у робота, от которого будет запускаться сборка.

4. Добавить релизный граф
```js
const {createWorkflow} = require('/home/core/mumu/packages/urelease/lib/workflow'),
    // здесь должен быть указан ваш репозиторий в соответствии с инструкцией tkit
    repo = {owner: 'morda', name: 'main'},
    tag = trendbox.getTag();

Promise.resolve()
    .then(async () => {
        /* Парсится тег для получения названия проекта и версии.
         * поддерживается формат `project-YYYY-MM-DD-(число)` и
         * `project-(число-с-точками)`.
         * После определения версии из гитхаба извлекается
         * предыдущий тег.
         */
        const {
            current: {
                project,
                version
            },
            prev: {
                name: prevTag,
                version: prevVersion
            }
        } = await getInfoByTag(tag);

        // Предыдущая версия важна для определения изменений.
        if (!prevTag) {
            throw new Error(`Не найдена предыдущая версия для ${version || project}`);
        }

        /* Список расписаний дежурств, из которых будут выбраны текущие дежурные.
         * Дежурные будут добавлены в релизный таск
         * Расписание должно быть представлено в виде `<service slug>/<schedule alias>`.
         * В этом примере добавляется расписание фронтенда сервиса home
         */
        let schedules = ['home/frontend'];

        const duty = await getDuty(schedules);

        // Способ добавить какого-то человека руками, если abc-дежурства не подходят
        duty.push({
            name: 'Постоянный наблюдатель',
            login: 'somelogin'
        });

        return createWorkflow({
            project,
            version,
            prevVersion,
            ref: tag,
            prevRef: prevTag,
            forceRebuild: process.env.RELEASE_TYPE === 'unstable'
        })
            .withTkitParams({
                // Параметры tkit'а
                repo,
                subscribers: duty.map(({login}) => login),
                stopOnUpdate: false
            })
            /* Если нужно отправлять сообщения в телеграм.
             * в chat нужно передать строку вида 'проект/чат' из [neko](https://u.yandex-team.ru/neko)
             */
            .withTelegram({
                chat: 'home/some-chat'
            })

            /*
             * Создание релизного таск в стартреке.
             * Подробности ниже
             */
            .withReleaseTicket({
                duty
            })

            /*
             * Заливка статики в s3
             */
            .withS3Deploy({})

            /*
             * Деплой собранных ресурсов в няню
             */
            .withNannyDeploy({})

            /*
             * Создание yappy беты с собранными ресурсами.
             * Подробнее про yappy здесь https://wiki.yandex-team.ru/yappy/
             */
            .withYappyDeploy({
                // название шаблона в yappy
                templateName: 'tune'
                // суфикс беты, обычно он зависит от номера пулл-реквеста
                suffix: 'pr-12345',
                /* Массив описания патчей, зависит от шаблона беты
                 * Для ссылки на ресурсы, которые будут получены в текущей сборке, нужно указать тип ресурса.
                 * urelease подставит номер таска в сандбоксе, по которому yappy сможет найти нужные ресурсы.
                 */
                patches: []
                // Время ожидания готовности беты в минутах
                readinessTimeout: 40
            })

            /* Можно добавить в граф опциональные шаги после каждого *Deploy шага */
            .afterThisDeploy(() => {
                return new Map([
                    ['step name', [
                        /* это обычный tkit step */
                        'echo "step command" > index.html',
                        {
                            main: 'index.html'
                        }
                    ]]
                ]
            })

            /* На случай, если нужно только собрать ресурсы, без деплоя куда-либо */
            .justBuildResources()

            // После конфигурации нужно вызвать метод start
            .start()
            // start возвращает промис, который резолвится после выполнения графа tkit
            .then(stats => {

            })
    })
    .catch(e => {
        /* При неожиданных ошибках (например, ошибках в конфигурации),
         * будет реджект промиса
         */
        process.exit(1);
    });
```

5. Если деплой осуществляется няней, рекомердуется настроить [Potato](https://github.yandex-team.ru/potato/potato/tree/master/docs) на перевод статусов связанных с релизом тасков.
Релизные скрипты автоматически добавляют вебхук potato при релизе няней.
Пример конфига, который переводит статусы при деплое в тестинг:
```yaml
handlers:
    # Перевод статуса релизного таска
  - name: issue-status-transition
    params:
      transitions:
        nanny:release:closed:
          condition: >
            (eventPayload.spec.sandboxRelease.releaseType === 'unstable' ||
            eventPayload.spec.sandboxRelease.releaseType === 'testing')
          filter: startrekIssue.data.type.key === 'release'
          to: testing

    # Перевод статуса всех слинкованных как related с релизным тасков
  - name: issue-related-status-transition
    params:
      transitions:
        nanny:release:closed:
          condition: >
            startrekIssue.data.type.key === 'release' &&
            (eventPayload.spec.sandboxRelease.releaseType === 'unstable' ||
            eventPayload.spec.sandboxRelease.releaseType === 'testing')
          to: testingAtRc
```

### Работа с релизными тасками

В релизный таск записывается следующая информация
- сандбокс ресурсы, которые деплоятся няней (с указанием версии ресурса)
- список дежурных с указанем названия расписания
- коммиты, добавленные с предыдущего релиза
- список задач, которые были указаны в коммитах
- **Примечания разработки** из поля "Комментарий разработки" каждой задачи
- **Особенности релиза**, **Что может пойти не так**, **Сделать после релиза**, **Как отключить фичу при сбое** из описания каждой задачи под соответствующими заголовками.

Кроме того, будут прилинкованы как "связана" все задачи из списка, которые имеют указанную в конфиге проекта в поле `startrek.taskQueue` очередь.

Скрипт может вместо создания нового дописать информацию в существующий релизный таск, если выполнены условия:
- существует релизный таск без резолюции
- его статус не из числа указанных в конфиге проекта в поле `startrek.skip`

Если оказалось, что таких релизных тасков несколько - будет выбран последний по дате создания.

### Особенные переменные

В нескольких местах конфига и в команде сборки можно использовать переменные proect, version и instance.

#### project

Название проекта, должно соответствовать одному из проектов в конфиге.
Парсится из тега функцией getInfoByTag.

#### version

Собираемая версия проекта. Предполагается, что номер версии монотоноо возрастает и может содержать не только числа.
Парсится из тега функцией getInfoByTag.

#### instance

Дополнительная переменная для возможности деплои на именованые стенды.
Пример конфига, использующего instance, можно посмотреть [в репозитории морды](https://github.yandex-team.ru/morda/main/blob/dev/ci/deploy-assessor.js)
