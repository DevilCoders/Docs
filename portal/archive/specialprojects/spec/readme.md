###Конструктор спецпроектов


####Make-цели
Папка spec в репозитории спецпроектов.
Сборка всего-всего: make
Cборка страниц в дев-режиме: make build
Cборка страниц в прод-режиме: make prod-build
Сборка админки: make admin

Для машин, на которых установлен глобально grunt (sudo npm install grunt-cli -g, на spec.wdevx.yandex.ru уже есть), вместо make можно в дальнешейм говорить grunt, это сэкономит время на проверку. 


####Развёртывание дев-инстанса
- git clone 
- cd ./spec
- make
- ./start_dev_server.sh


####Входные данные.
./exports/contexts.json - список проектов
./exports/%projectName.json – сами данные для проекта projectName
С этими файлами работает бекэнд админки.


####Основные шаблоны и зависимости
./pages/spec/spec.yate – основной шаблон страниц. Именно этот шаблон накладывается на данные.
./pages/spec/spec.deps.js – зависимости общие для всех проектов. Порядок имеет значение, так что новые зависимости стоит добавлять в середину, а не в начало или конец списка.
./pages/admin/admin.html – статическая обвязка админки. 
./pages/admin/admin.yate – сам шаблон админки

####Сборка
Сборка осуществляется при помощи grunt. Детали реализации – Gruntfile.js
Результат сборки страниц (make build) – директория ./static/. Внутри неё для каждого из проектов отдельная директория, внутри которой лежит вся относящаяся к нему статика – html, css, js, favicon, robots.txt
Результат сборки админки (make admin) - ./admin/. В ней – всё для админки, включая скомпилированный yate-шаблон.


####Как добавить новый тип блоков
1) в папке blocks-desktop создать папку с именем блока. Внутри неё – yate, стили, скрипты. Файлы можно называть как угодно и класть в подпапки. В yate определить функцию, которая, собственно, создаёт вёрстку блока. Имя фукнции должно быть одинаковым с именем блока! При необходимости определить вёрстку формы настроек в админке (editMode).
2) добавить имя блока в список в файле ./blocks-desktop/blockTypes.js
3) добавить обработчик сохранения формы настроек в админке в файле ./blocks-desktop/admin/admin.js
4) если созданный блок использует компоненты из jQueryUI, описать зависимости в build/jqueryui-deps.json (секция blockDeps, формат "имя_блока":["jqui_компонент1", "jqui_компонент2"]).
5) make build-jqui
6) make admin


####jQueryUI и связанное с ней
В проекте эта бибилиотека используется для создания табов + лежит в основе Наноостровов (раскидано по разным компонентам). Как работает сборка jQueryUI:
1) при сборке страниц проектов определяется набор блоков, которые присутствуют на каждой из страниц
2) согласно этому набору составляется список требуемуых jQUI-компонентов
3) если список не изменился, то берётся уже готовая кастомная сборка из папки ./lib/jqui-cache
4) если список изменился, то сборщик пытается скачать с сайта jquery обновлённую сборку и кладёт её в папку ./lib/jqui-cache. После этого обновлённую сборку нужно ручками закоммитить. Если скачать не получилось, будет использована полная сборка jquery (./lib/jqui.full.js)


####favicon
В папку ./favicons необходимо класть как вы думаете что? *барабанная дробь* Правильно, фавиконки проектов. Имя файла == имени проекта. 


####Админка
Админка работает следующим образом: есть статическая обвязка admin.html, которая ajax-ом скачивает с ручки данные проекта и рисует на клиенте согласно yate-шаблону админку. 
в папке ./blocks-desktop/admin/blocks-editmodes/ лежит js для режима редактирования разных блоков


####Локализация
Локализация сделана в следующем виде:
– один проект на разных языках представляет собой фактически скопированный проект из основного языка с переключенной в админке локалью
– из-за того, что это фактически будут независимые проекты, после того, как проект скопирован, синхронизация правок осуществляется вручную
– для текстовых полей, где требуется перевод, можно указать ключ из танкера, и тогда перевод для этого поля подтянется автоматически при переключении локали страницы (эти поля отличаются кпокой L10n)
– для инфоблоков автоматического перевода не осуществляет. Причина – содержимое инфоблока представляет собой выдаваемую wysiwyg кашу из инлайновой вёрстки, стилей и собственно текстов. Для облегчения перевода содержимого инфоблоков в wysiwyg добавлена чудо-кнопка добавления текста из танкера. Есть саджест ключей и текстов переводов. Использованные в данном блоке ключи сохраняются, чтобы при локализации ускорить выбор нужных текстов. 



