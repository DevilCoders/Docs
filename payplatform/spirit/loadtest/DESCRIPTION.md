# Нагрузочный стенд spirit loadtest

Стенд предназначен для проведения нагрузочного тестирования следующих сервисов:
 - `Darkspirit`
 - `Whitespirit`
 - `CheckRenderer`

Стенд преследует следующие цели:
 - Проверяет выбитие и показ чеков данными сервисами
 - Оценивает время выполнения данных операций
 - Оценивает нагрузку на аппаратное обеспечение
 - Определяет, в какие ресурсы упирается сервис
 - Помогает сравнить измеряемые параметры между релизами и оценить регресс

Стенд базируется в `Deploy` и состоит из следующих unit:
 - `checkrenderer` - машина с рендерилкой чеков, объект тестирования
 - `darkspirit` - машина с `darkspirit`, объект тестирования
 - `whitespirit` - машина с `whitespirit`, объект тестирования, в качестве касс используются `MockDevice`
 - `db` - база данных для `darkspirit`, вспомогательный сервис, не являющийся объектом тестирования
 - `loadmock` - Моки внешних сервисов, на текущий момент мокается сервис `MDS S3`, вспомогательный
 сервис, не являющийся объектом тестирования
 - `tank` - свой танк в `Y.Deploy` для удобной отладки, вспомогательный сервис, не
 являющийся объектом тестирования


## Допущения и вспомогательные сервисы
Данный тест при своей работе использует описанные далее допущения и вспомогательные сервисы. В рамках стенда считается,
что нагрузка на данные сервисы, а также изменения, вызываемые допущениями, не является для стенда существенной или
возможной для реализации и не является "узким местом" работы сервиса.
 - `HTTP`/`HTTPS`
 Сервисы стенда взаимодействуют по протоколу `HTTP`, сервисы в `production` взаимодействуют по
 протоколу `HTTPS`. Использование шифрования `HTTPS` вносит замедление, таким образом
 взаимодействие по протоколу на стенде работает быстрее, чем в `production`.
 Ввиду относительно низкого числа `HTTP` запросов в секунду на стенде, допускается, что
 шифрование при использовании `HTTPS` внесет фиксированную для каждого запроса задержку и
 не внесет существенного замедления
 - `DB`
 База данных для хранения чеков `darkspirit`, представляющая из себя отдельный deploy unit с `oracle` и заменяет собой
продовую базу.
 Продовая база имеет существенно больший размер, как следствие запросы к базе будут выполняться
 дольше, чем на тестовом стенде. В рамках стенда база данных не является объектом тестирования, а
 ее наполнение до аналогичного `production` объема данных нецелесообразно ввиду необходимости
 использования большого объема ресурсов
 При работе стенда важно отслеживать, чтобы данный сервис не упирался в верхние границы по ресурсам и не
 являлся узким местом работы стенда
 - `МосkDevice`
 В качестве касс для `whitespirit` стенд использует моки касс в виде класса `MockDevice` с
 фиксированным временем ответа без реальной логики кассы. Тест не оценивает работу
 внешних по отношению к сервису касс, нагрузка на них при работе сервиса подается последовательно,
 а время ответа считается не превышающим константного значения, из-за чего внешние кассы
 заменяются моком реализующим задержку времени на операцию без выполнения реальных операций
 - `LoadMock`
 Для хранения чеков `darkspirit` вместо реального хранилища `S3` используется сервис `LoadMock`.
 Сервис не хранит чеков, а лишь эмулирует хранилище, отдавая шаблонные ответы аналогично реальному
 S3 с константной задержкой. Сервис не является объектом тестирования.
 При работе стенда важно отслеживать, чтобы данный сервис не упирался в верхние границы по ресурсам и не
 являлся узким местом работы стенда
 - `Tank`
 Стрельбы проводятся либо с танка `sandbox`, либо с локального танка. Рекомендуется использовать
 танк `sandbox` ввиду его постоянного обновления, а также наличия нужных для его работы ресурсов.
 Deploy unit `tank` рекомендуется для отладки. При использовании танка в составе стенда
 важно следить за корректным для нагрузки поведением графика `RPS`, а также что сервис
 не упирается в верхние границы по ресурсам, таким образом подает корректную нагрузку

## Проверяемые сценарии

Технически, что делают сценарии, описано тут [тут](https://a.yandex-team.ru/arc/trunk/arcadia/payplatform/spirit/loadtest/tank/README.md)

### Основные сценарии
#### Полная процедура выбития чека
Сценарий проверяет полную процедуру выбития чека, что включает в себя:
 - выбитие чека в сервисе `whitespirit`
 - передача чека сервису `darkspirit`, в рамках которого происходит:
   - дважды обращение к `loadmock`
   - обращение к `db`
 - показ чека на сервисе `checkrenderer` при помощи передачи параметров чека в `URL` ссылке
 , в рамках которого происходит:
   - обращение к `darkspirit`, в рамках которого происходит:
     - обращение к `loadmock`

Является основным сценарием работы сервисов и комплексно задействует все оцениваемые сервисы

В рамках сценария нагрузка линейно увеличивается. Данный сценарий позволяет:
 - определеить, какой сервис является узким местом, замедляющим работу всего комплекса
 - оценить нагрузку `RPS`, при которой стенд перестает справляться
 - оценить, сколько времени отрабатывает запрос к каждому из оцениваемых сервисов
   - `darkspirit`
   - `whitespirit`
   - `checkrenderer`
 - оценить суммарное время сценария

При анализе результата важно учитывать, что запрос к сервису `checrenderer` внутри себя делает запрос
к сервису `darkspirit`.

В рамках сценария важно следить за правильным линейным ростом `RPS` со временем,
а также за тем, что сервисы `loadmock`, `db`, `tank` (при использовании танка
стенда) не достигают предельных аппаратных значений

#### Процедура показа/генерации чека
Сценарий проверяет процедуру генерации и отображения чека пользователю в формате `html`. В
рамках сценария задействован только сервис `checkrenderer`.

В рамках сценария нагрузка линейно увеличивается. Данный сценарий позволяет:
 - оценить нагрузку `RPS`, при которой стенд перестает справляться
 - оценить время генерации и показа чека пользователю
 - ресурсы, в которые упирается работа сервиса

В рамках сценария важно следить за правильным линейным ростом `RPS` со временем, а также за тем,
что сервис `tank` (при использовании танка стенда) не достигает предельных аппаратных значений.

#### Процедура показа/генерации чека в PDF
Сценарий проверяет процедуру генерации и отображения чека пользователю в формате `pdf`. В
рамках сценария задействован только сервис `checkrenderer`.

В рамках сценария нагрузка линейно увеличивается. Данный сценарий позволяет:
 - оценить нагрузку `RPS`, при которой стенд перестает справляться
 - оценить время генерации и показа чека пользователю
 - ресурсы, в которые упирается работа сервиса

В рамках сценария важно следить за правильным линейным ростом `RPS` со временем, а также за тем,
что сервис `tank` (при использовании танка стенда) не достигает предельных аппаратных значений.

### Второстепенные сценарии

#### Darkspirit
Сценарий проверяет изолированное сохранение чека в `darkspirit`, что включает в себя:
 - передача чека сервису `darkspirit`, в рамках которого происходит:
   - дважды обращение к `loadmock`
   - обращение к `db`

В рамках сценария нагрузка линейно увеличивается. Данный сценарий позволяет:
 - оценить нагрузку `RPS`, при которой стенд перестает справляться
 - оценить время сохранения чека пользователю
 - ресурсы, в которые упирается работа сервиса

В рамках сценария важно следить за правильным линейным ростом `RPS` со временем,
а также за тем, что сервисы `loadmock`, `db`, `tank` (при использовании танка
стенда) не достигают предельных аппаратных значений

#### Whitespirit
Сценарий проверяет изолированное выбитие чека чека в `whitespirit`

В рамках сценария нагрузка линейно увеличивается. Данный сценарий позволяет:
 - оценить нагрузку `RPS`, при которой стенд перестает справляться
 - оценить время выбития чека пользователю
 - ресурсы, в которые упирается работа сервиса

При оценивании результата важно учитывать, задержку эмулируемой кассы в 1с.

В рамках сценария важно следить за правильным линейным ростом `RPS` со временем,
а также за тем, что сервис `tank` (при использовании танка
стенда) не достигает предельных аппаратных значений

# Стрельбы

## Стрельбы 202108
Более подробный отчет [тут](https://wiki.yandex-team.ru/users/suveren/shooting-202108/).

### Полная процедура выбития чека
Стрельбы показали разладку при 14 `RPS`. Узким местом является сервис `darkspirit`, который упирается в
ресурсы `CPU`. Потребление ресурсов в пике сервисом `darkspirit` составило 4 `VCPU` (лимит) и 2.3GB `RAM`
(близкое к лимиту). 95 процентили времени ответа перед разладкой составили:
 - Полная процедура: 5.59с
 - сохранение чека в `darkspirit`: 2.42c
 - пробитие чека на `whitespirit`: 1.1с
 - генерация/показ чека на `checkrenderer`: 2.93с

График времени ответа `darkspirit` имеет периодические резкие скачки до 3 секунд с последующим
возвращением назад примерно раз в минуту.

### Процедура показа/генерации чека
Стрельбы показали разладку при 17 `RPS`. Аппаратные ресурсы задействовались не по максимуму, вероятно,
что сервис упирается в число используемых потоков.
Потребление ресурсов в пике составило 1 `VCPU` и менее 1GB `RAM`.
95 процентиль времени ответа перед разладкой составил 340мс

### Процедура показа/генерации чека в PDF
Стрельбы показали разладку при 10 `RPS`. Наблюдаются периодические `HTTP 500` ошибки, растущие
вместе с ростом нагрузки. Аппаратные ресурсы по `VCPU` близки к максимуму, но вероятно,
что сервис упирается в `HTTP 500` ошибки и разладка проиходит из-за них.
Выявленные `HTTP 500` ошибки вероятнее всего связаны с
[багом парсинга тела запроса в node-html-pdf библиотеке](https://github.com/marcbachmann/node-html-pdf/pull/202).
Потребление ресурсов в пике составило 3.6 `VCPU` и 1GB `RAM`.
95 процентиль времени ответа перед разладкой составил 460мс

### Процедура выбития чека в `whitespirit`
Стрельбы показали разладку при 110 `RPS`.
Сервис при этом потреблял 1 `VCPU` и 2.5GB `RAM` (близко к лимиту).
Вероятно сервис упирается в один поток и память
95 процентиль времени ответа перед разладкой составил 1.1с, что говорит о том, что
большую часть времени ответа занимает выбитие чека эмулируемой кассой.

### Процедура сохранения чека в `darkspirit`
Стрельбы показали резкий рост задержки после 22 `RPS`.
Сервис упирался в аппаратные ресурсы, в пике 4 `VCPU` (лимит) и 2.5GB `RAM` (лимит)
График времени ответов имеет пилообразную форму с периодическими резкими скачками до 5с,
постепенным убыванием до 400мс.

