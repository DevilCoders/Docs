# Инструкция по использованию

Данный текст написан по итогам добавления очередного проактивного мониторинга.

Итак, заглянем в apply_solomon_alerts.py, интересует функция, вычисляющая процент аппаратов, которые в ближайшее время
устареют:

```python
def fn_expiring():
    metric = 'max({{project="trust_cashregisters", cluster="greed_prod", service="simplebrother_balance_bo",' \
             'host="*", sensor="ds.fiscal_storage.{0}_dc_{1}.{2}.{3}"}}) by sensor'
```

Далее эта функция возвращает набор реальных проверок для юридических лиц. Что можно увидеть в метрике? Здесь используется
кластер greed_prod - это машины продакшена, где катаются нужные мониторинги большого брата. Теперь сенсоры.
В данном случае алерты ловят сенсоры того вида, что можно найти по
[следующей ссылке](https://solomon.yandex-team.ru/?project=trust_cashregisters&cluster=greed_prod&service=simplebrother_balance_bo&l.host=*&l.sensor=ds.fiscal_storage.nearly_end_service_life_dc_all.*).

Откуда они там берутся и как их добавить, не входит в описание этого проекта, здесь надо смотреть документацию
[большого брата](https://wiki.yandex-team.ru/spirit/developers/Dobavlenie-metrik-v-monitoring-cherez-Simple-Brother/).

Т.е. предполагается, что сенсоры уже есть и на них просто надо навесить набор алертов. Но прежде чем реально
выкатить такой алерт в продакшен, желательно увидеть это в тестовом режиме, а не пугать дежурных. Под тестовым режимом
здесь подразумевается не то, что вместо greed машин продакшена будет использоваться тестинг - алерты будут реагировать
именно на продакшен машины, но сигналить в тестовый канал уведомлений. Поэтому для начала нужно закомментировать в main все генераторы
алертов, кроме нового, который необходимо проверить:

```python
# docs_per_min(),
# whitespirit_errors(),
# receipt_timings(),
# open_shifts(),
# ofd_queues(),
# # documents_in_open_shift(), # max aggregate is not currently supported by Solomon
# old_sw_version(),
# ds_ofd_changed_registrations_count(),
# fn_free_space(),
fn_expiring(),
```

Далее в solomon.py нужно поменять канал:

```python
# instead of this channel ...
# NOTIFICATION_CHANNEL = "cashregisters_juggler"
# ... use this one
NOTIFICATION_CHANNEL = "cashregisters_test"
```

Этот канал можно увидеть по [данной ссылке](https://solomon.yandex-team.ru/admin/projects/trust_cashregisters/channels/cashregisters_test).
Чтобы увидеть сами сообщения, нужно попросить администратора канала добавить разработчика в телеграм чат.

**ВАЖНО**. Почему все проверки, кроме указанной, надо закомментировать? Потому что в противном случае они тоже будут сброшены
в этот тестовый канал, и дежурная смена их потеряет. Так что крайне важно удостовериться, что был выбран нужный канал,
и туда отправится только та проверка, которую необходимо проверить в тестовом режиме.

После этого собрать и запустить проект можно так, находясь в его папке:

```shell script
ya make -ttt
./apply-solomon-alerts --solomon-token SOLOMON_TOKEN
```

Токен для соломона oauth можно получить способом, описанным в [официальной документации Соломона](https://wiki.yandex-team.ru/solomon/api/v2/#oauth).
Возможно, поначалу ответ будет 403. Надо тогда просить админов проекта trust_cashregisters о добавлении разработчика
в список тех, кто имеет право модифицировать алерты. Если все прошло нормально,  то, зайдя в канал, можно увидеть в нем новые алерты
с нужными названиями, посмотреть их значения, убедиться, что все ок. После этого следует раскомментировать остальные проверки,
и вернуть назад продакшен канал.

**ЕЩЕ БОЛЕЕ ВАЖНО**. В коде списка алертов уже что-то закомментировано типа documents_in_open_shift (в примере был поэтому двойной комментарий),
важно не расскомментировать это по ошибке полностью, а то включатся ненужные мониторинги.
