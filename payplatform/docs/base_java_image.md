Базовый docker образ
====================

Образ предназначен для запуска micronaut-based микросервисов. Образ базируется на образе `registry.yandex.net/ubuntu:bionic`.
В состав образа входят следующие элементы:

- `yandex-openjdk17`
- Настроенный `nginx`
- Настроенный `unified-agent`
- Все необходимые сертификаты
- Набор полезных линуксовых утилит

Конфигурация образов приложений
-------------------------------

Запуск приложений осуществляется в базовом образе, поэтому ко всем образам - наследникам предъявляются следующие требования:

- Все `*.jar` файлы приложения должны располагаться в директории `/usr/lib/yandex/{app_name}`
- В директории `/etc/yandex/{app_name}` должны располагаться файлы `jvmargs-%env%`, где `%env%` - имя окружения, в котором будут применяться данные настройки. В файлах можно задать дополнительные параметры `jvm` (например, `-Xmx` или `-Xms`).
- Все конфиги приложения в формате `*.yaml` должны располагаться в директории `/etc/yandex/{app_name}/config`. Все файлы будут добавлены в `runtime classpath` откуда их загрузит сам `micronaut` . Приложение обязательно должно быть сконфигурировано на прослушивание порта `8080` на `localhost`.
- Конфиг `log4j` должен располагаться в директории `/etc/yandex/{app_name}`.

`{app_name}` - имя приложения.

Запуск приложений
-----------------

Для запуска приложения необходимо:

- Определить `environment variable` `APPLICATION_NAME`, содержащую имя приложения. Должно совпадать с `{app_name}` из предыдущей секции. Под данным именем сервис будет доступен в локальном `nginx`.
- Определить `environment variable` `ENVIRONMENT_TYPE`, содержащую имя окружения в котором будет запущено приложение. Набор окружений определяется самим сервисом, а базовый образ только передает в `micronaut` параметром `-Dmicronaut.environments`.
- (опционально) Определить `environment variable` `ENABLE_ASYNC_LOGGER` - включает асинхронное логирование в `log4j`.
- (опционально) Определить `environment variable` `ASYNC_LOGGER_BUFFER_SIZE` - задает размер буфера асинхронного `log4j` логера (`-Dlog4j2.asyncLoggerRingBufferSize`). Имеет смысл использовать только при включенном `ENABLE_ASYNC_LOGGER`. Если не задано, то будет использоваться дефолтное значение, заданное в `log4j`. Также необходимо иметь в виду, что этот параметр значительно влияет на потребление памяти и желательно провести нагрузочное тестирование с целью определения оптимального значения.

Если перед запуском приложения необходимо выполнить дополнительные системные действия, то можно добавить скрипт по пути `/usr/lib/yandex/{app_name}/init.sh`, который будет запущен непосредственно перед стартом приложения.

Entrypoints
-----------

По-умолчанию запускается `entrypoint` приложения `/opt/entrypoint.sh`.
Для запуска `nginx` необходимо использовать `entrypoint` `/opt/nginx_entrypoint.sh`.
Для запуска `unified-agent` необходимо использовать `entrypoint` `/opt/unified_agent_entrypoint.sh`.

Вспомогательные опции
---------------------

Помимо основных опций, базовый образ предоставляет и ряд вспомогательных, которые строго опциональны:

- `WAIT_DEBUGGER` - если выставлена в `true`, то процесс приложения не начнет выполнение пока к нему не подключится отладчик.
- `DBG_ADDRESS` - позволяет задать адрес, на который будет биндиться отладочный интерфейс (по-умолчанию `127.0.0.1`).
- `JMX_RMI_HOSTNAME` - позволяет задать системное свойство `java.rmi.server.hostname` (по-умолчанию `127.0.0.1`).
- `WAIT_UNIFIED_AGENT` - если выставлено в `true`, то процесс приложения не начнет выполнение пока unified-agent не ответит о готовности к работе
- `UNIFIED_AGENT_NGINX_ACCESS_LOG_SOCKET` - задает имя сокета, в который будет перенаправлен `access_log` для записи в `unified-agent`. Путь к сокету определяется как `/tmp/$UNIFIED_AGENT_NGINX_ACCESS_LOG_SOCKET.sock`. При этом `unified-agent` должен быть сконфигурирован на прием сообщений в заданный сокет.

Graceful shutdown для unified-agent
-----------------------------------

Для того чтобы `unified-agent` успел выполнить отправку всех данных при остановке контейнера, необходимо использовать скрипт `/opt/await_unified_agent_stop.sh`. Рекомендуется настроить `stop hook/stop policy` для запуска данного скрипта.

Поддержка Y.Deploy
------------------

Для сервисов, запущенных в `Y.Deploy` объем доступных `RAM` и `CPU` определяется автомагически, т.к. по-умолчанию `java` не способна в `Y.Deploy` окружении определить эти параметры корректно.

Особенности запущенного приложения
----------------------------------

- Наружу приложение смотрит через `nginx` на 80-м порту.
- Для удаленной отладки на `$DBG_ADDRESS` контейнера доступен отладочный порт `11111`.
- Для анализа и профилирования на `localhost` контейнера доступен `jmx` порт `22222`. Например, можно подключиться через `VisualVm` и снимать хипдампы или профилировать приложение.
- При возникновении `OOM` хипдампы сохраняются в `/var/heapdumps`.
- Выставлены необходимые параметры для `log4j`.

Remote debug
------------

Для подключения необходимо пробросить порт `11111` по ssh: `ssh -L 11111:$DBG_ADDRESS:11111 %service host%`.
После этого в `IDEA` необходимо создать `remote` конфигурацию запуска и прописать хост: `$DBG_ADDRESS` и порт: `11111`.

JMX access
----------

Для подключения к `jmx` необходимо пробросить порты `22222` и `22223` по ssh: `ssh -L 22222:127.0.0.1:22222 -L 22223:127.0.0.1:22223 %service host%`.
После этого можно настраивать подключение в выбранной тулзе (проверено на `VisualVM` и `JDK Mission Control`), выставляем хост: `127.0.0.1`, порт: `22222`.

Релиз новой версии
------------------

Сборка и публикация новой версии образа производится при помощи [CI](https://a.yandex-team.ru/ci). Для создания релиза необходимо предварительно замерджить изменения в `trunk`.

Порядок действий:

- Переходим на [вкладку проекта](https://a.yandex-team.ru/ci/prezteam/releases/timeline).
- В списке релизов выбираем `Publish new image`.
- Нажимаем кнопку `Run release`.
- В появившемся диалоге выбираем свой коммит и нажимаем `Run`.
- Ждем успешного окончания джобы, после чего новый образ будет доступен в `docker registry`.
