# Метрика качества Mtinfo
Одной из задач сервиса Mtinfo является прогнозирование времени прибытий транспортного средства (ТС) на остановку. Непосредственно построением прогноза на самом деле занимается отдельный сервис - Mtpredictor, но эта деталь скрыта от глаз клиентов.

Эта метрика призвана оценивать качество отдаваемых прогнозов. В первую очередь оценивается точность прогнозов на остановке, а не качество отображаемой на карте "живой метки".

Корневой тикет: https://st.yandex-team.ru/MTDEV-9

## Суть
Если бы у нас была точная информация о том, как в реальности двигались ТС, мы могли бы сравнить наши прогнозы с реальными прибытиями и вычислить, насколько они точны.\
Такую точную информацию (Ground truth, GT) можно получить, считывая GPS координаты с мобильных устройств пользователей во время поездки. Но получать ground truth каждый день по всем маршрутам, для которых мы строим прогнозы, нет физической (и финансовой) возможности.\
Зато есть возможность извлечь из уже имеющихся у нас данных (сигналов ТС) _достаточно_ точную информацию, чтобы можно было использовать её в качестве замены GT (Pseudo ground truth, PGT).

Для вычисления метрики качества Mtinfo мы научились строить такой PGT и сравнивать с ним наши прогнозы.

## Терминология
**ТС** - транспортное средство (автобус, троллейбус и т.д.)\
**clid** - id поставщика данных (например, `codd_new`, `spb` и т.д.)\
**uuid** - id транспортного средства у конкретного поставщика\
**vid** - пара (clid, uuid)\
**vtype** / **vehicle_type** - тип ТС ("bus", "minibus", "ferry" и т.д.)\
**route** - номер ТС ("28", "37к" и т.д.)

**GT** - [Ground Truth](#gt)\
**PGT** - [Pseudo Ground Truth](#pgt)\
**FC** - [Forecasts](#forecasts), прогнозы Mtpredictor-а\
**gap** - см. [Gap](#gap)

**Траектория движения ТС** - последовательность точек в пространстве и времени, между которыми ТС движется с постоянной скоростью\
**1D траектория** - траектория движения ТС, в которой каждая точка задаётся с помощью id нитки и расстояния от начала нитки\
**2D траектория** - траектория движения ТС, в которой каждая точка задаётся с помощью географической координаты, т.е. пары чисел (lon , lat)

## GT
Ground truth или GT - точные GPS треки с мобильных устройств пользователей, перемещающихся внутри транспортного средства.\
Для сбора GT мы разработали специальное приложение [YaWay](#yaway), которое записывает GPS координаты примерно раз в секунду. Точность GPS сигналов зависит от устройста и внешних факторов, но обычно ошибка не превосходит нескольких метров. Записанный трек после отправки попадает в Startrek в очередь MTGPSTRACKS и может быть выгружен оттуда на YT с помощью [transfer_gt](https://a.yandex-team.ru/arc/trunk/arcadia/maps/masstransit/statistics/info/gt_based_metrics/tools/transfer_gt).\
Собирать GT в разных городах помогали асессоры (Пешеходы). См. https://st.yandex-team.ru/WALKERS-766

## PGT
Pseudo ground truth - восстановленные из наших данных траектории движения ТС.\
Для восстановления детальной информации о движении ТС используются GPS сигналы, которые приходили в mtpredictor.\
Почему восстановить эту информацию можно намного точнее, чем это делает Mtpredictor?
- Во-первых, в предиктор сигналы приходят с задержкой (иногда до 120 секунд), а прогнозы он пытается строить на текущий момент
- Во-вторых, при наличии всего контекста сигналов проще определить, по какой нитке движется ТС, в то время как предиктору приходится "угадывать", куда ТС поедет дальше.

Для построения PGT мы привязываем каждый сигнал к ниткам с помощью [offline_binder](https://a.yandex-team.ru/arc/trunk/arcadia/maps/masstransit/statistics/info/gt_based_metrics/tools/offline_binder), а движение между точками привязки считаем равномерным.\
Правда у такого подхода есть один недостаток - мы не можем восстановить время прибытия на первую и последнюю остановку нитки, если сигнал не привязался ровно в этот конец.

## Forecasts
Пронозы, построенные Mtpredictor-ом.
Логи построенных прогнозов сохраняются на YT (см. [описание](https://wiki.yandex-team.ru/maps/dev/core/masstransit/mtpredictorlogformat/)) и используются в метрике для восстановления предсказанных прибытий на остановки.
Рассматриваются только прогнозируемые времена прибытия на остановки, а не прогнозируемая траектория движения.

В данный момент Mtpredictor никогда не строит прогнозы больше чем на 30 минут вперёд. Это задаётся параметром [`max_arrivals_duration`](https://a.yandex-team.ru/arc/trunk/arcadia/maps/masstransit/info/mtpredictor/bin/yacare.cpp#L89).

## Gap
Очевидно, что прогноз, построенный для остановки, к которой ТС уже подъезжает, будет намного точнее, чем прогноз на остановку, на которую оно прибудет через полчаса. Время от момента построения прогноза до момента прибытия ТС на остановку мы называем _gap_, и оцениваем качество прогнозов отдельно для разных значений gap.

На самом деле для вычисления gap используется не время построения прогноза, а время отправления последнего сигнала среди тех, которые использовались для построения этого прогноза. За счёт этого время на передачу сигнала в mtpredictor и время построения прогноза не влияют на результат.

## Временная ошибка
Вычисляем на первое время следующие ошибки:
- `abs_error` - на сколько секунд прогнозируемое прибытие отличается от настоящего;
- `hurry_error` - на сколько секунд прогнозируемое прибытие опережает настоящее прибытие;
- `late_error` - на сколько секунд прогнозируемое прибытие опаздывает относительно настоящего прибытия.

Т.к. величина ошибки получается разной для разных значений gap, то результатом сравнения FC с PGT, по сути, является зависимость ошибки от gap.\
Для каждого типа ошибки вычисляем среднее и несколько процентилей.

Не для каждого прогноза удаётся найти соответствующее ему реальное прибытие. Например, из-за сложностей при построении PGT, неточности алгоритма сопоставления или из-за того, что ТС действительно не прибыло на остановку (т.н. "призрачные проезды").
Долю таких прогнозов тоже хочется вычислять как минимум потому что она коррелирует с долей призрачных проездов, которую мы хотим минимизировать. Но для тех прогнозов, которые не удалось сопоставить с реальным прибытием, не определено понятие gap (в таком виде, в котором мы его определили, конечно). Поэтому вычисляем только одно значение для каждого clid (точнее, одно среднее и несколько процентилей).

## Как устроено
Каждый день запускается Sandbox-таска [MapsMasstransitMtinfoMetrics](https://a.yandex-team.ru/arc/trunk/arcadia/sandbox/projects/masstransit/MapsMasstransitMtinfoMetrics/__init__.py), последовательно выполняющая несколько этапов для построения PGT, обработки прогнозов и их сравнения. Все вычисления производятся на YT в кластере Hahn.\
Промежуточные таблицы удаляются не сразу, а через несколько дней. Если таска упадёт в процессе, то после рестарта найдёт уже посчитанные таблицы и продолжит работу с нужного этапа.\
Результаты всех окружений ("testing", "production") за все дни сливаются вместе в таблички в [//home/yatransport-prod/production/mtinfo-metrics/results](https://yt.yandex-team.ru/hahn/navigation?path=//home/yatransport-prod/production/mtinfo-metrics/results). В `time_error_statistics` записываются величины ошибок для различных gap, а в `time_error_missing_arrivals` - доля прогнозов, для которых не удалось определить время реального прибытия (это отдельная таблица, т.к. такие числа нельзя сгруппировать по gap - для прогнозов без реальных прибытий gap просто не определён).\
Дальше данные из этих табличек используются в дешборде в Yandex Dash (aka Datalens). См. [результаты](#результаты).

## Результаты
#### PGT-FC
Дешборд с результатами:
[![Картинка для привлечения внимания](https://jing.yandex-team.ru/files/kalabukdima/mtinfo_metrics_dashboard_preview.png)](https://dash.yandex-team.ru/jcvf6l210db4g)

#### GT-PGT
Мы провели оценку качества PGT на основе записанного GT и убедились, что он достаточно близок (до 30 метров) к GT, чтобы использовать его для оценки качества прогнозов. См. https://st.yandex-team.ru/MTDEV-268


## Прочее
### YaWay
![YaWay](https://raw.github.yandex-team.ru/kalabukdima/ya-way/master/app/src/main/res/mipmap-xhdpi/ic_launcher_round.png)

**YaWay** - приложение, разработанное для записи ground truth. Оно умеет записывать GPS координаты раз в секунду даже при выключенном экране. Затем пользователь может посмотреть список записанных треков и отправить выбранный, прикрепив к нему текстовое описание с указанием vehicle_type и route.\
Код приложения лежит здесь: https://github.yandex-team.ru/kalabukdima/ya-way\
Основной тикет: https://st.yandex-team.ru/MTDEV-295, в нём есть другие полезные ссылки.

Для отправки данных в [startrek-proxy](https://a.yandex-team.ru/arc/trunk/arcadia/maps/mobile/server/startrek-proxy) через мобильную прокси используется библиотека `[mapsmobi]/libs/recording`. Для записи событий с GPS координатами в listener этой библиотеки был написан небольшой бандл - `[mapsmobi]/libs/masstransit_recorder`.

### Ссылки по теме
[Корневая вики страница](https://wiki.yandex-team.ru/maps/dev/core/masstransit/metrics/mtinfo-metrics/)\
[Ссылки на планировщики в Sandbox](https://wiki.yandex-team.ru/maps/dev/core/masstransit/sandbox_schedulers/#mapsmasstransitmtinfometrics)
