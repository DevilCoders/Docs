# routing_data

Набор достаточно разрозненных методов для использования [fb-расписаний ОТ](https://a.yandex-team.ru/arc/trunk/arcadia/maps/masstransit/libs/data/) в [Рапторе](https://a.yandex-team.ru/arc/trunk/arcadia/maps/masstransit/libs/raptor) и непосредственно в [ОТ-роутере](https://a.yandex-team.ru/arc/trunk/arcadia/maps/masstransit/router).

<br>

## binding.h

Функция `bindToStops()` находит все остановки ОТ в окрестности заданной точки, а также расстояние пешком до них.

Вначале находятся все (но не более `MAX_STOPS_NUM`) остановки в прямоугольнике радиусом примерно `BINDING_WALK_DISTANCE`.
Если их меньше, чем `MIN_STOPS_NUM`, поиск продолжается в прямоугольнике радиусом `EXTENDED_BINDING_WALK_DISTANCE` пока не наберется `MAX_STOPS_NUM` остановок.

*Note: Основное время работы составляет вычисление пешеходного расстояния до остановок (они заметны даже на общем профиле ОТ-роутера), поэтому важно, чтобы их число не было слишком большим.*

## compound_thread.h

Класс **CompoundThread** представляет собой набор ниток, который интерпретируется Раптором как одна нитка.
Такая группировка на этапе загрузки данных в память делается для электричек - там множество ниток с (почти) совпадающими остановками объединяются в одну.
Остальные нитки представляются в виде **CompoundThread**, состоящего из одной нитки.

## masstransit.h

Мелкие функции-обертки над библиотекой расписаний для использования в роутере.

## stops_components.h

Для оптимизации производительности Раптора данные могут быть разбиты на компоненты. Тогда перебор остановок, ниток и т.п. идет только по актуальной компоненте. Здесь описан класс, с использованием которого на комоненты разбиваются внутренние структуры Раптора.

## transfers.h

Функции для построения набора пересадок: весов перехода между парой остановок.

Данные для построения берутся из двух источников:
  1. из данных с расписаниями (например, пересадки между станциями метро)
  2. из отдельного файла (построенного по пешеходному графу с помощью [build_pedestrian_transfers](https://a.yandex-team.ru/arc/trunk/arcadia/maps/masstransit/tools/data_build/build_pedestrian_transfers))

## types.h

Алиасы для основных типов данных

## weight.h

Определяет классы `Weight` и `Criterion`, используемые в ОТ-роутере.

**Weight** - вес маршрута, включающий в себя
  - время в пути
  - общее пройденное расстояние
  - расстояние, пройденное пешком
  - количество пересадок с одного транспорта на другой.

 Используется внутри ОТ-роутера и возвращается в его ответе.

**Criterion** - класс, задающий правила ранжирования маршрутов, а также правила формирования их весов.

При поиске маршрутов в [Рапторе](https://a.yandex-team.ru/arc/trunk/arcadia/maps/masstransit/libs/raptor) используется несколько критериев, по каждому из которых выбирается N лучших.
Критерии могут быть, например такими:
  1. Самые быстрые маршруты
  2. Маршруты с наименьшим расстоянием пройденным пешком
  3. Маршруты с наименьшим числом пересадок

Также для ранжирования возможны линейные комбинации этих величин.
