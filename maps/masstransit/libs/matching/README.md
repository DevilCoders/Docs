### [Матчер](/arc/trunk/arcadia/maps/masstransit/libs/matching/include/mtr_matcher.h) ОТ сигналов

Оффлайн симулятор онлайн [привязки](/arc/trunk/arcadia/maps/masstransit/libs/matching/examples/match_signals) с добавлением [выбора](/arc/trunk/arcadia/maps/masstransit/libs/matching/include/decider.h) из кандидатов на нитках и соединениях между нитками и использованием [онлайн конфига](/arc/trunk/arcadia/maps/masstransit/libs/matching/configs/online.json).

Оффлайн [привязка](/arc/trunk/arcadia/maps/masstransit/libs/matching/examples/match_signals_offline) с использованием [оффлайн конфига](/arc/trunk/arcadia/maps/masstransit/libs/matching/configs/offline.json).

[geometries.h](/arc/trunk/arcadia/maps/masstransit/libs/matching/include/geometries.h) - инициализация графа ОТ ниток, работа с геометриями ниток, владение сегментами ниток и построение по запросу деревьев сегментов ниток для быстрого поиска при построении проекций сигналов.

[decider.h](/arc/trunk/arcadia/maps/masstransit/libs/matching/include/decider.h) - выбор среди лучших приматченных кандидатов по одному на нитке, кандидаты на соединениях в выборе в текущей реализации не участвуют, логика выбора по возможности повторяет логику выбора старого байндера (матчинг на ту же нитку, при отсутствии кандидатов - матчинг с учетом расписания и приоритетов ниток).

### Особенности ОТ матчера

#### Генерация наборов кандидатов

Рассматриваются только кандитаты на нитках корреткных с точки зрения сигнала - маршрут нитки является допустимым для маршрута и типа ТС, в том числе альтернативных (см. [aliases](/arc/trunk/arcadia/maps/masstransit/info/libs/common/aliases.h), [wiki](https://wiki.yandex-team.ru/sergejjzhgirovskijj/fixfailingbindinggpsbuses/)).

Кандидаты фильтруются по положению на нитке - рассматривается до трёх лучших кандидатов на каждом из трёх различных участков нитки, определяемых этими кандидатами, при этом кандидаты на соединениях не фильтруются.

Для кандидатов вычисляется оценка наиболее подходящего расписания среди периодичных расписаний и разовых отправлений, которую потом можно использовать снаружи. Выбор происходит между попавшими во временное окно около приблизительного времени отправления регулярными расписаниями и несколькими ближайшими разовыми отправлениями.

Каждый кандидат оценивается по расстоянию до сигнала и отклонению направления сигнала от направления нитки.

#### Оценка переходов между кандидатами

#### Оценка времени перехода

Переходам в прошлое или без изменения времени выставляется вероятность нарушения непрерывности с дополнительным множителем (0.1).

#### Оценка расстояния перехода

Движение по нитке в обратном направлении более заданного порога или движение вдоль нитки с превышением предельной скорости считается нарушением непрерывности.

Движение по нитке в обратном направлении в пределах заданного порога считается отсутствием движения, при этом кандидату перезаписывается положение.

#### Влияние конфигурация перехода

Любой переход с участием соединения, кроме движения непосредственно по соединению добавляет множитель вероятности для перехода (0.9).

Некорректным конфигурациям переходов (переходы без наличия соответствующих соединений) выставляется вероятность нарушения непрерывности с дополнительным множителем (0.5).
