# Модель прогнозирования времени

Модель предсказывает время проезда по _одному_ ребру (сегменту) нитки ОТ. Затем, эти значения как есть используются в траекториях для движения меток по карте, а также суммируются на префиксе для определения времени прибытия ТС на остановку.

_В настоящий момент есть планы по созданию т.н. полнотрековой модели, по аналогии с моделью ETA. Такая модель будет предсказывать времена проезда от текущей позиции до каждой из остановок в пределах горизонта. При этом необходимо будет решить проблему с подбором консистентных времен для движения меток между остановками. Подробнее в тикете [MAPSJAMS-3876](https://st.yandex-team.ru/MAPSJAMS-3876)_

{% cut "Иллюстрация" %}

![Иллюстрация](../_content/model_pict.png "Иллюстрация")

{% endcut %}

## Предсказываемое значение (таргет)
Идейно – время проезда одного ребра ОТ, в качестве реализации – `LOG_SPKM` – логарифм обратной скорости (секунд на километр).

## Факторы (фичи)

В текущей реализации все фичи являются _numerical_. Были попытки использовать катфичи, но они не увенчались успехом (см. [MAPSJAMS-3060](https://st.yandex-team.ru/MAPSJAMS-3060)).

### Общие фичи трека
* _THREAD_ – идентификатор нитки
* _ROUTE_ – идентификатор маршрута
* _VEHICLE_TYPE_ – one-hot тип ТС (автобус / троллейбус и пр.)
* _LOCAL_DAY_TYPE_ – тип дня (см. [календарь](datasets.md#Календарь))
* _LOCAL_DAY_HOUR_ – локальный час
* _REGION_ – идентификатор региона из геобазы

### Фичи предсказываемого ребра
* _LENGTH_ – длина ребра, в метрах
* _CURVATIVE_ – кривизна ребра
* _LAT_ – координата
* _LON_ – координата
* _THREAD_OFFSET_ – отступ от начала нитки, в метрах
* _FORECAST_OFFSET_ – отступ от текущего положения, в метрах
* _DISTANCE_FROM_PREV_STOP_ – расстояние от предшествующей остановки, в метрах
* _DISTANCE_TO_NEXT_STOP_ – расстояние до следующей остановки, в метрах
* _STOPS_FROM_FORECAST_ – количество остановок от текущей позиции
* _TYPE_IS_STOP_SEGMENT_ – one-hot типа ребра
* _TYPE_IS_STAGE_SEGMENT_ – one-hot типа ребра
* _TYPE_IS_STOP_POINT_SEGMENT_ – one-hot типа ребра
* _FORECAST_HORIZON_ – горизонт прогнозирования, в секундах
* _STATISTICAL_AVG_ – статистическая средняя скорость, в м/с
* _STATISTICAL_P50_ – статистическая медианная скорость, в м/с
* _STATISTICAL_MIN_ – статистическая минимальная (p05) скорость, в м/с
* _STATISTICAL_MAX_ – статистическая максимальная (p95) скорость, в м/с
* _STATISTICAL_CNT_ – количество учтенных проездов в статистике
* _STATISTICAL_INT_ – ширина статистического интервала, в секундах

фичи в разработке:
* _RG_COVERED_RATIO_ – доля покрытия ребрами автомобильного графа
* _RG_MTLANES_LENGTH_ – длина покрытия выделенными полосами, в метрах
* _RG_TRAFFIC_LIGHTS_COUNT_ – количество светофоров на ребре
* _RG_DEFAULT_SPEED_ – "дефолтная скорость" из автомобильного графа, в м/с
* _RG_SPEED_LIMIT_ – скоростные ограничения, в м/с
* _JAMS_SPEED_ – пробочная скорость, в м/с
* _JAMS_COVERAGE_ – доля покрытия пробками

### Фичи проеханного пути
Делим суффикс проеханной части нитки на части, начиная от текущего положения. Ограничиваем количество частей константой. Длину части можно увеличивать с геометрической прогрессией (например 40м, 60м, 90м ...). Для каждой части считаем фичи:
* _TRAVEL_TIME_ – время проезда, в секундах
* _LENGTH_ – длина, в метрах
* _SPEED_ – скорость, в м/с
* _STOPS_COUNT_ – количество остановок
* _THREAD_OFFSET_LENGTH_ – отступ от начала нитки, в метрах
* _FORECAST_OFFSET_LENGTH_ – отступ от текущего положения, в метрах
* _FORECAST_OFFSET_TIME_ – время до текущего положения, в секундах

### Ссылки:
* [код](https://a.yandex-team.ru/arc/trunk/arcadia/maps/analyzer/libs/masstransit/time_prediction)
