## Генерация патронов для predictor
---
При регрессионных стрельбах в предиктор мы хотим проверять число автобусов, которое выдержит предиктор. Во сколько раз увеличение числа автобусов от текущей нагрузки не уронит предиктор? Данный бинарь генератора патронов сделан таким образом, что может ответить на этот вопрос точным числом (x3, x2.5 и т.п.).

1. Сначала нужно подготовить набор GPS сигналов. Например, [таким](https://yql.yandex-team.ru/Operations/YN3nmr94hmAu_0aBA6Bp__vhaReYkcL1Ie3Ol5UP5l8=) запросом можно получить все GPS сигналы в рамках 1 часа в самый пик нагрузки на предиктор.

2. Далее нужно выбрать часть этих сигналов. Можно сделать фильтрацию по (vehicle_id, route). Нужно учесть число шардов в текущем сервисе (на момент написания этого текста их 3), а также какую часть нагрузки на один хост нужно взять. Пример лежит в [этом](https://yql.yandex-team.ru/Operations/YN3ZfguEI2dKBYYE66gppUGG4xupUo7HkxGmE8RRB3E=) запросе. Там взята 1/3 от всей нагрузки на одну реплику, то есть 1/9 от всех сигналов.

3. Треки в генераторе патронов дублируются через сдвигание вперед. Параметр свдига вперед (`--shift-forward`) передается в секундах. Например, если вы передадите туда 180, то треки будут дублироваться со сдвигом в 3 минуты, т.е. один трек будет сначала сдвинут на 0 минут (т.е. останется как есть), затем сдвинут на 3 минуты вперед, затем на 6 и т.д. Число дублирований определяется параметром `--duplication-factor`, если он равен 1, то треки останутся как есть, если он будет равен, например, 3, то получим набор из исходного трека, из трека, сдвинутого на 3 минуты вперед и трека, сдвинутого на 6 минут вперед.

4. Также нужно определить число сигналов в батче (т.е. сколько сигналов передается по ручке /accept_batch в среднем). Нужно смотреть на статистику в проде, примерными подсчетами RPS на ручки /accept и /accept_batch было получено, что первый больше в 22-26 раз, поэтому можно считать, что в среднем в одном батче 24 сигнала. Такой дефолт поставлен и в бинарнике.

5. Нужно определиться с длительностью стрельбы с равным RPS. Например, если треки сдвигаются на 3 минуты, то нужно повышать нагрузку в 2 раза после 3 минут стрельбы, а RPS в первые 3 минуты считается как число сигналов с receive_time в первые 3 минуты, тогда нужно число сигналов в первые 3 минуты поделить на число сигналов в батче (default 24) и поделить это на 3 минуты (на 180). Это число и будет переменной для стрельбы с изменением нагрузки `step`, назовем его параметром `N`. Пусть на этом пункте мы получили число 33, тогда для стрельб имеем такой конфиг: `line(1, 33, 10s) step(33, 500, 33, 3m)` – плавное быстрое увеличение до 33 RPS, а затем каждые 3 минуты RPS растет на 33. Если стрельба останавливается на числе P, то predictor умирает при увеличении числа автобусов в P/33 раза от таблицы из пункта 2. Пусть мы взяли треть сигналов на один хост, обозначим это параметром `K`, равным 3. Таким образом, максимальное увеличение числа автобусов будет расчитываться по формуле [1] `MAX_X = MAX_RPS / N / K`, а в данном случае MAX_RPS / 33 / 3.

---
#### Пример генерации патронов

1. Взять сигналы за час так: [yql](https://yql.yandex-team.ru/Operations/YN3X4hJKfWlDScIbz8XE18d6NHZXVXIKaFeiKarUSuQ=).
2. Взять треть всей нагрузки на предиктор так: [yql](https://yql.yandex-team.ru/Operations/YN3Y9QuEI2dKBYV_0-AITgGU4j3oH2iBqBhSNt_SlD4=)
3. Подготовить патроны со сдвигом в 3 минуты и дублированием в 15 раз (т.е. получим максимум x5 от числа автобусов).
4. Зааплодить их в sandbox: `ya upload /path/to/ammo`
5. Скопировать вот эту стрельбу: [lunapark](https://lunapark.yandex-team.ru/2782669#tab=test_data&tags=&plot_groups=main&machines=&metrics=&mobile=&slider_start=1625154327&slider_end=1625157037)
6. Поменять в [конфиге](https://a.yandex-team.ru/arc/trunk/arcadia/maps/masstransit/ydbfree/services/predictor/regression/configs/imbalance.yaml) поле `phantom.ammofile` на путь до ваших патронов в сендбоксе.

#### Итерпретация результатов
Смотрим на стрельбу из [списка](https://lunapark.yandex-team.ru/regress/MAPSJAMS?service=predictor).
В формулу [1] подствляем RPS разладки и получаем максимальное кратное увеличение числа автобусов.

**Актулальные патроны: https://proxy.sandbox.yandex-team.ru/2257149287, `N = 33, K = 3`**

_Пример_. Получаем, что на 297 rps CPU иногда прыгает в 100% => предиктор держит x3 (= 297 / 33 / 3) увеличение автобусов, но увеличение в x3.33 уже не держит, т.к. CPU почти всегда равен 100%.
