calc_lights - расчет аналитики по светофорам в городе
===

Скрипт делает расчет аналитики по светофорам в городе.

Запущенный без параметров скрипт делает расчет метрик по дефолтным городам за прошедшую неделю.
Если метрики уже посчитаны, то он ничего считать не будет.

При запуске можно указать файл с конфигом расчета, тогда расчет будет в соответствии с конфигом.

Город задается прямоугольником. В этом прямоугольнике скрипт вычисляет все светофоры,
для каждого светофора определяет направления, с которых можно подъехать к этому светофору,
и направления, куда едут после. Вдоль каждого направления скрипт считает количество проехавших
и медианную скорость.

В конфиге города также задается часовой пояс для корректного определения местного времени,
а также "магический коэффициент" - на какую величину нужно домножать наши потоки,
чтобы кол-ва на витрине были похожи на реальные

Регулярные запуски
==
Еженедельный запуск расчета делается вот этим шедулером:
https://sandbox.yandex-team.ru/scheduler/698187/view

После чего заливка данных на витрину делается вот этим кубиком в Нирване:
https://reactor.yandex-team.ru/reaction?id=10272852&mode=instances

Данные приезжают на вот эту витрину:
https://datalens.yandex.ru/n6lg7kc08dhci-analiz-perekryostkov?state=78dafb16307



Как устроен расчет
==

За каждый день берутся привязанные треки. Из них берутся ребра со светофорами, и объединяются
в "светофорные кластеры". Эти кластеры матчатся с кластерами предыдущего дня и переименовываются так,
чтобы id светофоров были такие же, как в прошлые дни. Новые светофоры добавляются только при расчете за первый
день периода расчета, появление новых светофоров в другие дни игнорируется.

Для светофоров расчитываются направления "до" и "после" светофора ("before" и "after").

Направления считаются на 600 метров до и после светофора. При этом направления "до" - это направления до
первой встречи со светофором кластера. Для каждого "въезда" на светофор выбирается одна - самая популярная цепочка
ребер, и вдоль нее будут считаться скорости. Количества считаются на ребре, содержащем светофор.

Аналогично "после" светофора скрипт пытается эвристически разделить всех едущих на направления и на каждом
направлении выделить цепочку ребер длиной 600 метров, вдоль которой будет считаться скорость. 
Выбор направления "после" устроен сложнее, чем "до", так как здесь нет ребра со светофором,
которое однозначно определяет это направление. Здесь нужно поймать момент, когда потоки,
едущие с разных направлений, уже успели объединиться, но еще не начали разъезжаться по улицам,
пересечения с коротыми не регулируются нашим светофором.

Если это не первый день периода, и все ребра подъездов к светофору и отъездов от него из предыдущего дня
присутсвтуют в текущем дне, то пересчета направлений не будет.

Когда определены направления, по ним для каждого трека определяется направление, с которого он приехал,
скорость, куда он поехал, скорость.

Когда данные за все дни посчитаны, затем происходит объединение данных и расчет метрик за период.

Предыдущая версия описания (местами устаревшая): https://wiki.yandex-team.ru/ViktorMatjuxin/jamsAnalytics/20200820-auto_lights_calc/