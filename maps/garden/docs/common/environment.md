# Окружения в Огороде

В речи, в коде, в документации часто встречаются слова: `stable`, `testing`, `unstable`, `environment`, `contour`, `stage` и другие. Их значения сильно зависят от контекста. В этом документе делается попытка описать и систематизировать возможные контексты.

## Окружения самого Огорода

* `stable` (он же продакшен) Огород включает сервер и шедьюлер в Няне, которые были зарелизены в `stable` через Sedem, и отдельный кластер Монги.
    * В `stable` Огороде варятся данные для продакшена.
    * В `stable` Огороде тестируются огородные модули.
    * В `stable` Огороде пользователи могут разрабатывать новые версии модулей в дев-контурах.

* `testing` Огород включает сервер и шедьюлер в Няне, которые были зарелизены в `testing` через Sedem, и также свой отдельный кластер Монги. Инфраструктурно `testing` Огорода повторяет `stable` Огород и служит для тестирования новых фич Огорода перед релизом в `stable`. `testing` Огород доступен только для команды Огорода.

* `unstable` Огород - это песочницы, которые запускаются на дев-машине. Каждый разработчик Огорода может запустить локально докер-контейнеры с сервером и шедьюлером и использовать отдельную базу данных в коммунальном кластере Монги.

Мотивация:
* песочницы позволяют быстро и удобно проводить эксперименты с кодом Огорода, который ещё не был закоммичен в Аркадию.
* `testing` Огорода позволяет проверять новые фичи в инфраструктуре, максимально похожей на `stable`, чтобы минимизировать вероятность попадания багов в `stable`.

## Окружения (стейджи) огородного модуля

У каждого огородного модуля свой независимый релизный цикл:

* `stable` - версия модуля, код которой достаточно надёжен, чтобы варить данные для продакшена.

* `testing` - версия модуля, готовая к тестированию.

Огородные модули релизятся через Sedem.

{% note info %}

Версия модуля, которая зарелизена в `stable`, может также запускаться в `testing` Огороде и песочницах. См. ниже Runtime окружение.

{% endnote %}

## Контура в Огороде

Контур в Огороде объединяет несколько версий огородных модулей в единый конвейер подготовки данных: данные, сваренные одним модулем попадают на вход другому модулю.

* `stable` контур в `stable` Огороде - самый главный контур, т.к. именно здесь варятся данные для продакшена. В этом контуре работают только `stable` версии модулей.

* `datatesting` контур в `stable` Огороде - здесь тестируются `testing`-версии огородных модулей. Контур `datatesting` почти полностью повторяет контур `stable`.

* дев-контура - любой пользователь может создать свой контур в Огороде и запускать в нём любые версии любых огородных модулей.

## Runtime окружения

Когда таска огородного модуля выполняется, то бывает необходимо знать: варит ли таска данные для продакшена или нет. Для этого при запуске таски выставляется переменная окружения `ENVIRONMENT_NAME`, которая может принимать следующие значения:

* `stable` - это значит, что таска запущена в контуре `stable` в `stable` Огороде, и соответственно относится к `stable`-версии огородного модуля. Такая таска варит данные для продакшена.

* `datatesting` - это значит, что таска запущена в контуре `datatesting` в `stable` Огороде, и соответственно относится к `testing`-версии огородного модуля.

* `unstable` - это значит, что таска запущена в любом другом контуре.

Fun fact: в `testing` Огороде в контуре `testing` работают `stable`-версии огородных модулей, а таски получают `ENVIRONMENT_NAME=unstable`.

Подробнее про окружение на [странице](module-environment.md).

## Окружения других сервисов

В процессе работы Огород взаимодействует с разными сервисами: YT, Sandbox, S3 и другими. Каждый такой сервис имеет свои окружения: `unstable`, `testing`, `stable`.

Любые окружения Огорода (и песочницы, и `testing`, и `stable` Огород) всегда работают только со `stable`-окружениями других сервисов.

Мотивация. В любых сервисах есть баги. Если бы Огород зависел от `testing` YT, то Огород бы ломался каждый раз, когда команда YT выкатывает новую версию с багом в тестинг.

## Окружения потребителей данных

С потребителями данных (роутер, рендерер, геокодер) другая история.

`stable` данные из контура `stable` выкатываются в `stable`-окружение потребителей данных и далее становятся доступны пользователям Яндекса.

Но тестовые данные из контура `datatesting` необходимо где-то проверить, чтобы убедиться, что `testing`-версии огородных модулей сварили данные, которые совместимы с потребителями данных. Для этого у потребителей данных заведены отдельные `datatesting` окружения.

Чтобы случайно не перепутать `stable`-данные и тестовые данные, они доставляются до потребителей через отдельные инсталляции экстатика: `stable` ecstatic и `datatesting` ecstatic.

## Шаги деплоя

Хотя в `stable`-контуре работают `stable`-версии огородных модулей, тем не менее всегда есть риски, что сварятся плохие данные (например, если на вход Огороду придут изначально данные с ошибками).

Чтобы минимизировать риски, данные из контура `stable` деплоятся в несколько шагов:

* `deploy_step=testing` - сначала данные из контура `stable` выкатываются на отдельное окружение потребителя данных (`datavalidation`), где они сравниваются со вчерашними проверенными данными на предмет сильных расхождений.
* `deploy_step=prestable` - данные из контура `stable` выкатываются на отдельное окружение потребителя данных (`dataprestable`), которое обслуживает 5% запросов внешних пользователей.
* `deploy_step=stable` - данные из контура `stable` выкатываются на отдельное окружение потребителя данных (`stable`), которое обслуживает 95%  запросов внешних пользователей.

Поскольку контур `datatesting` устроен почти аналогично контуру `stable`, то данные из контура `datatesting` также проходят через 3 шага деплоя.

Подробнее про деплой данных на [странице](data_deploy.md).
