# Ресурс

Ресурс (`resource`) - сущность, от которой зависит или которую производит [модуль](module.md) в Огороде. Примеры ресурсов - файлы, ecstatic датасеты, таблицы на YT и другие.
Производство ресурсов, используя другие ресурсы, - главная функция Огорода.

Ресурсы могут быть внутренними, производимыми модулями в Огороде, либо внешними. Примеры внешних ресурсов - экспорт Народной карты, экспорт Справочника.

## Идентификаторы

Каждый ресурс имеет имя (`name`), которое определяет позицию ресурса в графе задач. В Огороде могут существовать несколько версий (`version`) ресурса с одним именем.

В процессе регистрации входных и выходных ресурсов модули ссылаются на ресурсы через их имена.
В процессе исполнения графа используется только одна конкретная версия.

## Свойства
Смысловое содержимое ресурсов определяется через их свойства (`properties`). Задаются свойства через произвольный словарь из пар ключ-значение.

### Задание свойств ресурса
Для внешних ресурсов свойства назначаются при их [регистрации](scan_resources.md) в Огороде.

Для внутренних ресурсов свойства устанавливаются через специальный механизм, пропагатор свойств (`property propagator`),
который на основе свойств входных ресурсов создает свойства выходных ресурсов.
Пример типичного пропагатора является `EnsureEqualProperties`, который проверяет наличие одинаковых свойств у
входных ресурсов и копирует эти свойства в создаваемые ресурсы.

### Использование свойств
#### Шаблонизация
Значения строковых свойств, таких как урлы в S3, пути к YT таблице и подобных, удобно определять через другие свойста, используя стандартную функцию `format` в питоне.

Например, при создании ресурса типа `FileResource` шаблон можно указать вторым параметром:
```python
res = FileResource(
    name="important_file",
    filename_template="important_file_{region}_{vendor}_{shipping_date}.json")
```
Предположим у ресурса заданы такие свойста:
```json
{
  "region": "russia",
  "vendor": "yandex",
  "shipping_date": "20160101",
  "other_property" : "something"
}
```
Тогда реальное имя файла будет получаться таким кодом:
```python
"important_file_{region}_{vendor}_{shipping_date}.json".format(
    region="russia", vendor="yandex", shipping_date="20160101", other_property="something")
```

В более общем сценарии шаблонизация зависит от реализации конкретного ресурса и может позволить работать не только со свойствами ресурса (т.е. не только с полем `properties`).

#### Версионирование
Версия ресурса (поле `version`) - это строкое значение, представляющее собой хеш, расчитываемый на основе следующих данных:
* свойств самого ресурса
* версии входных ресурсов

Если у двух ресурсов с одним и тем же именем совпадают версии, то Огород создает только один из ресурсов-дублей.

## Типы ресурсов
Следующие ресурсы поддержаны в ядре Огорода:

* `FileResource` - одиночный файл
* `DirResource` - директория с файлами
* `RemoteDirResource` - директория с файлами на удаленном сервере
* `YtFileResource` - файл на YT
* `YtTableResource` - таблица на YT
* `YtSourcePathResource` - путь до узла в Кипарисе на YT
* `PythonResource` - любое pickleable python значение
* `BuildParamsResource` - ресурс со свойствами билда
* `OptionalResource` - ресурс, который может отсутствовать
* `SandboxResource` - ресурс в Сендбоксе
* `Postgres*` - ресурсы для работы с PostgreSQL (временно не поддерживаются, для использования
  необходимы доработки со стороны команды Огорода)

TODO: описать все вышеуказанные типы ресурсов по-подробнее.

### `OptionalResource`
Опциональный ресурс - это обертка над (базовым) ресурсом другого типа. Используется, когда базовый ресурс может физически отсутствовать.
Пример использования опциональных ресурсов - зависимость от YMapsDF для всех регионов, тогда как при постоении билда не для всех регионов данные могут быть доступны.

При отсутствии базового ресурса в свойствах опционального ресурса записывается ```"is_empty": True``` и ресурс значится пустым.
В коде проверка на пустоту для опционального ресурса `res` делается таким простым способом: ```if res:```.

Если базовый ресурс существует, то обращение к свойствам/методам опционального ресурса проксируется в реализацию базового.

## Жизненный цикл ресурса

Данная страница предназначена преимущественно для разработчиков Огорода и описывает, что происходит с ресурсом на различных этапах его существования.

### Этапы жизни ресурса

Квадратные скобки указывают, где выполняется текущий шаг

1. Создание и коммит:
    * [`scan_resources`] получаем ресурс из внешнего источника. Подробнее на [этой](scan_resources.md) странице.
    * [`fill_graph`] инициализируем ресурс. Инициализация может происходить в любом месте. Во время инициализации необходимо заполнить те атрибуты, которые не зависят от окружения и будут храниться в БД
    * [`module wrapper`] вызываем `load_environment_settings()` на хосте, где будет выполняться таска. Данный метод заполнит недостающие атрибуты для выполнения операций ресурса
    * [`task code`] выполняем операции по созданию данных (например, вызываем `path()` и создаём директорию в случае DirResource)
    * [`module wrapper`] вызываем `logged_commit()` для загрузки своего ресурса в хранилище. В методе выставляется флаг `exists`
    * [`module wrapper`] вызываем `clean()` для очистки временных файлов, папок, закрытия хэндлеров, очистки временных атрибутов объекта и т.д. После этого ресурс будет запиклен и отправлен в БД

2. Загрузка и чтение:
    * [`module wrapper`] вызываем `load_environment_settings()` на хосте, где будет выполняться таска
    * [`module wrapper`] вызываем `ensure_available()`на хосте, где будет выполняться таска
    * [`task code`] выполняем операции с ресурсом в таске
    * [`module wrapper`] вызываем `clean()`

3. Удаление:
    * [`garden`] вызываем `load_environment_settings()` на сервере огорода
    * [`garden`] вызываем `remove()`. После этого работа с объектом ресурса бессмысленна, поскольку код ресурсов не гарантирует целостность после вызова данного метода
