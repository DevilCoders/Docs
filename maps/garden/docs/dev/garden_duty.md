# Диагностика ошибок Огорода

Ссылки на дашборды, по которым можно оценить проблему:
* [Страница сервера Огорода в Седеме][sedem_server]
* [Страница шедьюлера Огорода в Седеме][sedem_scheduler]
* [Дашборд с важными графиками сервера][dashboard]


## Сервер

Предоставляет API, в которое ходят UI Огорода и другие сервисы. Чтобы проверить общую работоспособность сервера, можно открыть [страницу UI][ui].

Логи сервера лежат в директории: `/var/log/yandex/maps/garden/`.

Сервер живёт в 3 ДЦ. Поэтому, чтобы получить свежие логи из всех ДЦ сразу, можно использовать следующие команды.

Сегодняшние логи сервера:
```
sky portorun 'grep INTERNAL /var/log/yandex/maps/garden/server.log' f@maps_core_garden_server_stable
```

Сегодняшние логи NGINX:
```
sky portorun 'grep status=5 /var/log/nginx/access-tskv.log' f@maps_core_garden_server_stable
```

Вчерашние логи (после ротации логи архивируются, и нужно использовать `zgrep`):
```
sky portorun 'zgrep INTERNAL /var/log/yandex/maps/garden/server.log.1.gz' f@maps_core_garden_server_stable
```

Альтернативный способ через Sedem:
```
ya tool sedem p_exec --cmd 'grep INTERNAL /var/log/yandex/maps/garden/server.log' maps_core_garden_server_stable
```

Способы анализа nginx логов по данным в YT описаны на [отдельной странице](nginx_logs.md).


## Шедьюлер

Шедьюлер Огорода живёт в единственном ДЦ в Сасово.

Чтобы проверить общую работоспособность шедьюлера, нужно зайти в [контейнер][nanny_scheduler] по ssh. Если зайти по ssh не удаётся, и в [инфре][infra] написано, что в Сасово авария, то нужно поставить даунтайм.

Вместе с самим шедьюлером в этом же контейнере живут и другие фоновые демоны и тулы Огорода.

Все логи лежат в директории: `/var/log/yandex/maps/garden/`.

Проверить живость демонов можно командой:
```
supervisorctl status
```

Если в коде шедьюлера случился дедлок, то можно распечатать стектрейсы всех потоков в шедьюлере. Для этого:
* Зайти по ssh в контейнер с шедьюлером.
* Выполнить команду:
```
curl -H "Host: core-garden-server.maps.yandex.net" http://localhost/dump_traceback/
```
* Посмотреть стектрейсы в логе `/var/log/yandex/maps/garden/scheduler.log`.

{% note warning "Attention" %}

Если из-за бага в шедьюлере есть риск падения огородных модулей, то на время починки нужно поставить ДТ или замьютить все огородные модули. Это можно сделать через UI Juggler с помощью селектора `tag=maps_core_garden_module`.

{% endnote %}

Некоторые проблемы с шедьюлером можно исправить его перезапуском. При этом нельзя допускать ситуации, чтобы 2 процесса шедьюлера работали одновременно.

Как можно перезапустить шедьюлер:
* Способ 1: Зайти по ssh в контейнер с шедьюлером, найти процесс `/usr/bin/garden-scheduler` и выполнить команду `kill <pid>`. После этого Супервизор автоматически запустит новый процесс.
* Способ 2: В Няне перевести снепшот в состояние `Prepared on hosts`, а потом обратно в `Active`.

{% note warning "Attention" %}

Ни в коем случае нельзя перезапускать шедьюлер с помощью `supervisorctl`, т.к. Супервизор не может корректно остановить исходный процесс шедьюлера, и в итоге окажется запущено 2 процесса шедьюлера одновременно.

{% endnote %}


## Учения и регламентные работы

Огород умеет переживать учения и регламентные работы в любых датацентрах. Но если события происходят в Сасово, то могут шуметь мониторинги из-за недоступности кластера Хан.
В этом случае имеет смысл поставить ДТ в Juggler.

Рекомендованный селектор: [host=maps_core_garden_*](https://juggler.yandex-team.ru/aggregate_checks/?query=host%3Dmaps_core_garden_*)


## Мониторинги

### yt_garden_node_quota, yt_garden_chunk_quota, yt_garden_disk_quota
А также  yt_garden-exp_node_quota, yt_garden-exp_chunk_quota, yt_garden-exp_disk_quota

* stable Огород использует аккаунт [garden](https://yt.yandex-team.ru/hahn/accounts/general?account=garden) в YT
* testing Огород использует аккаунт [garden-exp](https://yt.yandex-team.ru/hahn/accounts/general?account=garden-exp) в YT

Самый дефицитный ресурс - количество нод в Кипарисе.

Больше всего нод потребляют сборки модуля `ymapsdf`. Один билд ~400 нод.
Также много нод уходит на временные таблицы и файлы.

Посмотреть информацию о том, кто потребляет слишком много ресурсов, можно во вкладке detailed usage раздела Accounts в YT:
* для [garden](https://yt.yandex-team.ru/hahn/accounts/usage?account=garden&view=tree)
* для [garden-exp](https://yt.yandex-team.ru/hahn/accounts/usage?account=garden-exp&view=tree)

Что делать дежурному ночью:
* Удалить в контуре [datatesting](https://garden.maps.yandex-team.ru/datatesting/) старые билды, которые потребляют больше всего дифицитного ресурса. Например [9 самых старых билдов `ymapsdf`](https://garden.maps.yandex-team.ru/datatesting/ymapsdf).
* Прервать сборку свежих билдов этого модуля в контуре `datatesting`.
* Посмотреть по [списку запущенных задач](http://core-garden-server.maps.yandex.net/yt_monitor), не варится ли этот модуль в каком-то из дев-контуров. Если варится, то прервать сборку.

Что делать дежурному днём:
* Исследовать Кипарис: в каких папках потребляется больше всего ресурсов.
  * Оптимальное соотношение числа чанков к объёму диска – 1/1ГБ. Излишнее потребление чанков может быть связано с тем, что владелец модуля забыл добавить вызов `merge` с опцией `combine_chunks` после запуска map-reduce операций. При использовании `YtTableResource` эта операция вызывается автоматически внутри sdk.
* Если в каких-то дев-контурах очень много сборок ресурсоёмкого модуля (например `ymapsdf`), то связаться с владельцами контуров и попросить почистить старые данные.
* Если увеличение числа потребляемых ресурсов связано с естественным ростом, то [запросить увеличение квоты в YT](https://yt.yandex-team.ru/docs/description/common/quota_request).

В исследовании также могут помочь дашборды:
* [garden][solomon_garden]
* [garden-exp][solomon_garden-exp]


### operation_fetch_age

Мониторинг основан на сигнале в Головане. Он загорается, если демон `operation_fetcher` перестал обрабатывать свежие операции в YT.

Это может происходить по следующим причинам:
* Кластер Хан не доступен или пятисотит. Что делать: поставить ДТ.
* При очередном релизе шедьюлера Огорода изменился формат аннотаций у YT-операций. Что делать: поправить код тула `operation_fetcher` и выкатить фикс в стейбл.

### task_log_age

Мониторинг основан на сигнале в Головане. Он загорается, если демон `perf_normalizer` не может обработать записи в коллекции `task_log` в Монге.

Возможные причины:
* при очередном релизе шедьюлера Огорода изменился формат записей в коллекции `task_log`. Что делать: поправить код тула `perf_normalizer` и выкатить фикс в стейбл.
* в коллекцию `task_log` по какой-то причине записалась плохая запись. Что делать: удалить плохую запись из Монги и поправить код библиотеки `maps/garden/libs_server/task`, чтобы новые плохие записи не появлялись.

### hanging_builds

Мониторинг загорается, если какой-то билд долго находится в статусе `WAITING` или `SCHEDULING`. Все билды в Огороде шедьюлятся в одном потоке. Один зависший билд может заблокировать всю очередь билдов.

Этот мониторинг может иногда давать ложные срабатывания. Поэтому надо убедиться, что в очереди действительно скопилось много билдов. Это можно увидеть на дашбордах:
* [контур stable](https://garden.maps.yandex-team.ru/contours/stable/details)
* [контур datatesting](https://garden.maps.yandex-team.ru/contours/datatesting/details)

Ложные срабатывания починим в [MAPSGARDEN](https://st.yandex-team.ru/MAPSGARDEN-20211).

Что делать дежурному, если срабатывание не ложное, и очередь билдов зависла:
* ночью порестартить шедьюлер (как это делать, описано выше);
* днём попытаться понять по логам шедьюлера, что произошло.

### dangling_resources

Мониторинг загорается, если Огород долго не может удалить какой-то ресурс. Все такие ресурсы хранятся в Монге в коллекции `dangling_resources`.

В сообщении мониторинга пишется ключ ресурса и текст исключения. Если нужен стектрейс, то его можно посмотреть в Монге.

Популярный сценарий, при котором ресурс может не удалиться:
1. какой-то модуль регулярно варит датасет экстатика;
2. в какой-то момент разработчик модуля решает перестать варить этот датасет;
3. разработчик удаляет этот датасет из конфига экстатика;
4. Огород пытается удалить старый билд этого модуля, но получает ошибку 403 от экстатика.

В этом случае достаточно удалить записи из Монги из коллекции `dangling_resources`. Разработчик модуля сам отвечает за удаление датасета из экстатика.

По этому мониторингу нет звонков: поджигается только WARN.

### module_traits_consistency_stable или module_traits_consistency_datatesting

Мониторинг проверяет консистентность графа модулей: что в пределах одного контура трейты всех модулей ссылаются друг на друга.

Эта ошибка может возникнуть, если какой-то пользователь выкатил новую версию огородного модуля с ошибкой в трейтах.

Что делать дежурному: связаться с нерадивым пользователем, объяснить ему проблему и попросить откатить модуль обратно.

### stat-updater-status_file_age

Мониторинг кроновского тула. Проверяет, что тул `stat-updater` регулярно запускается и не падает.

Тул `stat-updater` создаёт серии таблиц со статистикой в [yt](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/core/garden/stats) по данным из mongo. Эти таблицы используются для построения графиков в Datalens.

Мониторинг может загореться, если YT не доступен. Что делать дежурному: поставить ДТ.

По этому мониторингу нет звонков: поджигается только WARN.

### releases_monitoring-status_file_age

Мониторинг кроновского тула. Проверяет, что тул `releases_monitoring` регулярно запускается и не падает.

Тул `releases_monitoring` создаёт тикеты в Стартреке в очереди `MAPSLSR`.

Мониторинг может загореться, если Стартрек не доступен или пятисотит, либо возникла какая-нибудь внутрення ошибка тула, описание которой будет выдано в сообщении мониторинга.

Что делать дежурному: если ошибка связана с недоступностью startrek или если мониторинг загорелся в нерабочее время – поставить downtime.

По этому мониторингу нет звонков: поджигается только WARN.

### yt_cleanup-status_file_age

Мониторинг кроновского тула. Проверяет, что тул `yt_cleanup` регулярно запускается и не падает.

Тул `yt_cleanup` удаляет старые временные файлы из YT.

Мониторинг может загореться, если кластер Хан не доступен или пятисотит. Что делать дежурному: поставить ДТ.

По этому мониторингу нет звонков: поджигается только WARN.

### pin_builds-status_file_age

Мониторинг кроновского тула. Проверяет, что тул `pin_builds` регулярно запускается и не падает.

Тул `pin_builds` запинивает старые билды модуля `renderer_publication`.

Мониторинг может загореться, если сервер Огорода не доступен или пятисотит. Что делать дежурному: разобраться, почему сервер не доступен.

По этому мониторингу нет звонков: поджигается только WARN.

### default_tcp_check

Мониторинг доступности http-api. Проверяет, что ручка `host/ping` отвечает 200:ОК.

Мониторинг может загореться, если сервер Огорода не доступен или пятисотит.

Что делать дежурному: проверить, что ручка `host/ping` отвечает. Если не отвечает - зайти на хост, убедиться, что
nginx запущен, проверить его логи, а так же проверить логи Огорода.

### supervisord-fatal-programs

Мониторинг супервизора. Проверяет, что супервизору удалось запустить все необходимые сервисы.

Мониторинг может загореться, если супервизор не смог запустить какой-то сервис, или сервис внезапно упал.

Что делать дежурному: зайти на хост, командой `supervisorctl` проверить, что все сервисы запущены.
Если какой-то сервис не запущен, проверить логи.

[sedem_server]: https://proxy.sandbox.yandex-team.ru/last/SEDEM_SERVICE_PAGE/index.html?attrs={%22sedem_service%22:%20%22core-garden-server%22}
[sedem_scheduler]: https://proxy.sandbox.yandex-team.ru/last/SEDEM_SERVICE_PAGE/index.html?attrs={%22sedem_service%22:%20%22core-garden-scheduler%22}
[dashboard]: https://yasm.yandex-team.ru/panel/robot-garden.maps-garden-manager-2/
[ui]: https://garden.maps.yandex-team.ru/stable/ymapsdf
[nanny_server]: https://nanny.yandex-team.ru/ui/#/services/catalog/maps_core_garden_server_stable/
[nanny_scheduler]: https://nanny.yandex-team.ru/ui/#/services/catalog/maps_core_garden_scheduler_stable/
[infra]: https://infra.yandex-team.ru/
[solomon_garden]: https://solomon.yandex-team.ru/?project=yt&service=accounts&dashboard=yt-account-limits-media&account=garden&cluster=hahn&b=31d&e=
[solomon_garden-exp]: https://solomon.yandex-team.ru/?project=yt&service=accounts&dashboard=yt-account-limits-media&account=garden-exp&cluster=hahn&b=31d&e=
