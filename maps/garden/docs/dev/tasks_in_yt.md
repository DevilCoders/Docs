# Выполнение тасок в YT

Таски запускаются в YT в джобах ванилла-операций. Подробнее про ванилла-операции можно почитать [здесь](https://yt.yandex-team.ru/docs/description/mr/vanilla).

В одной ванилла-операции может запуститься до 10 тасок в разных джобах.

Внутри джобы параллельно с модулем запускается тул [yt_module_executor](https://a.yandex-team.ru/arc_vcs/maps/garden/tools/yt_module_executor). Тул следит за работой модуля, пингует Огород, что таска жива, а в конце работы таски выгружает логи в S3.

Иногда может случиться нештатная ситуация, и таска завершит свою работу досрочно. Все причины таких ситуаций можно условно разбить на 2 типа: внутренние и внешние.

## Внутренние причины завершения таски

Таска не может корректно обработать нештатную ситуацию и либо бросает исключение, либо крэшится.

Примеры:

* на вход таске поступили некорректные данные;
* ошибка в коде таски;
* проблемы с доступностью внешнего сервиса (недоступность по сети, пятисотки).

Тул `yt_module_executor` отправляет информацию о завершении таски в Огород и выгружает логи в S3.

С точки зрения YT джоба завершается успешно.

Наблюдаемый результат:
* В UI Огорода на странице билда (Perf) есть информация об ошибке и ссылка на логи в S3.
* В UI YT на странице операции есть одна успешно завершившаяся джоба.

## Внешние причины завершения таски

Джоба с таской абортится внешней силой:

* пользователь нажимает кнопку `Abort` в UI YT;
* YT решает, что джоба потребляет слишком много памяти, и её нужно поабортить;
* YT решает, что хост, на котором запущена джоба, сломан, и джобу нужно переселить на другой хост.

Тул `yt_module_executor` убивается вместе с джобой и не успевает выгрузить логи в S3.

YT автоматически перезапускает джобу на другом хосте. Во избежание нежелательных побочных эффектов тул `yt_module_executor` определяет этот факт и предотвращает запуск таски внутри второй джобы. Вторая джоба сразу завершается.
В логах второй джобы есть запись `409 Client Error: CONFLICT`. Это ожидаемое поведение.

Наблюдаемый результат:
* В UI Огорода на странице билда (Perf) есть информация об ошибке и **нерабочая** ссылка на логи в S3.
* В UI YT на странице операции есть две джобы: одна поаборченная и вторая завершённая. По умолчанию показывается только 2я завершённая. Чтобы увидеть все джобы, нужно выбрать `State: All` в выпадушке.
