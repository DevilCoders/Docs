# Автоматический запуск билдов

В Огород ежедневно поступают новые данные, экспортируемые из Редактора НЯК и других внешних систем. Эти данные должны быть «пропущены» через огородный граф, включающий в себя несколько билдов и доставлены до конечных сервисов с минимальной задержкой.

Новый билд может быть запущен (когда готовы его входные данные) несколькими способами:

1. Вручную через UI.

    Количество разных билдов слишком велико, и необходимость запускать все билды вручную стала бы существенным блокером в процессе непрерывной доставки данных до конечных потребителей. Кроме того, существенную часть билдов приходилось бы запускать ночью, что потребовало бы круглосуточного дежурства релиз-менеджеров.

2. Автоматически по завершению другого билда.

    Огород является событийно ориентированной системой: задачи запускаются автоматически в тот момент, когда готовы их зависимости (входные данные). Данный подход можно распространить на запуск билдов.

    Для этого придуманы автостартеры. Автостартер - это функция в огородном модуле, которая вызывается после завершения билда нужного модуля.

3. Через вызовы API Огорода.

    Огород сейчас официально не поддерживает запуски билдов по расписанию. Можно настроить запуск внешнего скрипта по крону, который будет посылать запросы в API Огорода. Но этот способ не рекомендуется:

    * крон-задачи надо где-то запускать;
    * задача запускается с некоторым интервалом (как правило 10–15 минут), что влияет на время старта билда;
    * авторы разных модулей пишут и поддерживают свои собственные версии кода по REST-общению с сервером Огорода.

    Как следствие, надежность и удобство такого решения оставляет желать лучшего.

    Запуск по расписанию можно сэмулировать с помощью отложенных автостартеров (см. ниже).

## Термины

**Целевой модуль** - огородный модуль, билд которого должен быть запущен автоматически.

**Модуль-триггер** - огородный модуль, завершение билда которого вызывает срабатывание автостартера целевого модуля.

**Билд-триггер** - завершившийся билд модуля-триггера, который вызывает срабатывание автостартера целевого модуля.

**Автостартер** - функция в целевом модуле, которая должна принять решение о запуске билда целевого модуля.

## Механизм работы автостартеров

Разработчик модуля указывает в целевом модуле список модулей-триггеров и функцию-автостартер.

Когда завершается билд модуля-триггера и если нет ограничений на запуск автостартеров (см. ниже), то Огород запускает функцию-автостартер в целевом огородном модуле и передаёт в неё информацию о билде-триггере и билдах других модулей, которые могут понадобиться для запуска билда целевого модуля.

Функция-автостартер должна выбрать один из 3х возможных исходов:

* Ничего не делать - не запускать новый билд;
* Запустить новый билд целевого модуля с указанными сорс-билдами;
* Отложить запуск автостартера на указанное время.

Если запуск был отложен, то автостартер будет вызван повторно в указанное время с тем же самым билдом-триггером.
Но если до указанного времени завершится другой билд-триггер, то отложенный запуск будет отменён, и будет вызван автостартер с новым билдом-триггером.

## Включение/выключение автостартеров

Через UI Огорода можно отключить запуск автостартеров, сняв галку `autostart`.

![](img/ui_autostart.png)

Также Огород проверяет события в специальных календарях ([раз](https://calendar.yandex-team.ru/embed/month?layer_ids=22354), [два](https://calendar.yandex-team.ru/embed/month?layer_ids=248122)), которые создаются для учений или выполнения работ в датацентрах. В этом случае запуск автостартеров `deployment`-модулей приостанавливается и возобновляется примерно через 1 час после завершения события в календаре.

## Мониторинги

При снятии галки `autostart` в UI зажигается мониторинг в Джагглере `service=autostart_disabled`, и в чат разработчиков модуля приходит уведомление.

Возможны 2 варианта:
* Галка снята по ошибке. Уведомление в чате позволяет среагировать и поднять галку обратно.
* Галка снята на время починки бага в коде или исправления ошибки в данных. В этом случае нужно выставить Downtime в Джагглере до ожидаемого момента починки. Если ответственный разработчик забудет поднять галку обратно, то в чат придёт новое уведомление.

## Настройка автостартера в трейтах

В трейтах нужно указать список модулей-триггеров:

```json
"autostarter": {
    "trigger_by": [
        "ymapsdf"
    ]
},
```

Огород передаёт в функцию-автостартер список билдов не вообще всех модулей, а только модулей, которые указаны в трейтах в полях: `sources`, `configs`, `autostarter.trigger_by`.

Иногда необходимо передать в автостартер билды дополнительных модулей, которые не являются ни прямыми сорсами, ни триггерами. Прямо сейчас для этого возможен такой workaround: указать эти дополнительные модули в поле `autostarter.trigger_by`, но в коде автостартера игнорировать их.

Для `reduce` или `deployment`-модулей может быть полезно указать в поле `autostarter.trigger_by` самого себя: тогда модуль будет триггерить сам себя. Это связано с ограничением: в один момент времени может быть запущен только 1 reduce-билд. После его завершения можно запустить новый билд со свежими сорсами.

## Функция-автостартер

При запуске модуля в `run_module` в файле `main.py` нужно передать функцию-автостартер:

```py
run_module(
    "module_name",
    fill_graph,
    handle_build_status=start_build,
)
```

Функция-автостартер должна иметь следующую сигнатуру:

```py
from maps.garden.sdk.module_autostart import module_autostart as autostart


def start_build(trigger_build: autostart.Build, build_manager: autostart.BuildManager):
```

Первый аргумент `trigger_build` содержит описание билда-триггера. Можно узнать его `id`, свойства, сорсы, статус и время завершения.

Второй аргумент `build_manager` позволяет получить информацию о существующих билдах, а также запустить новый билд.

Методы класса `BuildManager`:

* `get_build(build_id: BuildId)` - получить один билд по его `id`.
* `get_builds(module_name: str)` - получить все билды указанного модуля.
* `get_last_completed(module_name: str, region: tp.Optional[str] = None)` - получить последний завершившийся билд указанного модуля.
* `create_build(source_ids: tp.List[BuildId], properties: tp.Optional[tp.Dict[str, tp.Any]])` - запустить новый билд с указанными сорсами и свойствами.
* `delay_until(retry_at: dt.datetime)` - запустить автостартер в указанное время с тем же самым билдом-триггером.

Пример простейшего автостартера для map-модуля:

```py
def start_build(trigger_build: autostart.Build, build_manager: autostart.BuildManager):
    if trigger_build.status != autostart.BuildStatus.COMPLETED:
        return

    build_manager.create_build(source_ids=[trigger_build.full_id])
```

Пример, как сделать паузу в 2 часа между завершением триггера и запуском нового билда:

```py
def start_build(trigger_build: autostart.Build, build_manager: autostart.BuildManager):
    if trigger_build.status != autostart.BuildStatus.COMPLETED:
        return

    start_new_build_at = trigger_build.finished_at + dt.timedelta(hours=2)

    if dt.datetime.now(pytz.utc) < start_new_build_at:
        build_manager.delay_until(start_new_build_at)
        return

    build_manager.create_build(source_ids=[trigger_build.full_id])
```

Пример, как указать шаг деплоя для `deployment`-модуля:

```py
def start_build(trigger_build: autostart.Build, build_manager: autostart.BuildManager):
    if trigger_build.status != autostart.BuildStatus.COMPLETED:
        return

    build_manager.create_build(
        source_ids=[trigger_build.full_id],
        properties={"deploy_step": "prestable"}
    )
```


## Тестирование автостартера в контуре

Протестировать запуск автостартера можно с помощью утилиты [garden](cli.md).
Перед тем, как запускать автостартер, нужно пересобрать модуль и залить его в пользовательский контур.
Как это сделать описано [здесь](experiments.md#start_local_module).

Формат запроса на запуск автостартера:
```bash
garden module autostart -c <contour name> --trigger-build <trigger module name>:<trigger build id> --target-module <target module name>
```

Пример запуска автостартера для пользовательского контура aleksbalashov_exp:
```bash
garden module autostart -c aleksbalashov_exp --trigger-build example_map:3 --target-module example_reduce
```

После запуска команды, она отправляет запрос в сервер Огорода. Если указанные в команде параметры валидны и
у пользователя есть права на запуск целевого модуля, то сервер создаст запрос в Монге на запуск автостартера
и вернет сообщение об успешном выполнении операции.

Если команда успешно отработала, но автостартер не запустился, то проблема может быть непосредственно
в коде автостартера модуля. Планируется добавить логи запуска автостартера в UI Огорода.
Пока это не будет сделано, рекомендуется смотреть лог шедьюлера.


## Тесты для автостартера

Рекомендуется всегда писать юнит-тесты для функции-автостартера.

Существует функция-хелпер `maps.garden.sdk.test_utils.autostart.create_build` для создания тестовых билдов.

Пример теста:

```py
from maps.garden.sdk.test_utils.autostart import create_build


def test_start_build():
    source_build_1 = create_build("source_module")
    source_build_2 = create_build("source_module")

    another_build = create_build(
        "another_module",
        sources=[source_build_1],
        properties={"release_name": "2020.10.11"}
    )

    build_manager = common.BuildManager([
        source_build_1,
        source_build_2,
        another_build,
    ])

    start_build(source_build_2, build_manager)

    assert build_manager.build_to_create.source_ids == [source_build_2.full_id]
```

## Типовые автостартеры

Для большинства сценариев уже существуют типовые автостартеры в библиотеке [maps/garden/sdk/module_autostart](https://a.yandex-team.ru/arc/trunk/arcadia/maps/garden/sdk/module_autostart).

Для `map`-модулей:

* `start_with_last_configs` - запускает модуль с билдом-триггером на входе и самыми последними версиями конфигов.

Для `reduce`-модулей:

* `start_with_last_sources` - запускает модуль с самыми последними версиями сорсов и конфигов. Билд-триггер не учитывается.
* `start_with_many_regions_and_last_configs` - для модулей, у которых в зависимостях `ymapsdf` или другие модули с поддержкой регионов: берёт список регионов из предыдущего билда `reduce`-модуля и для каждого региона выбирает последний сорс-билд. Если сорс-билд фейлится, автостартер откладывает запуск на 1 час, чтобы дать возможность дежурному разобраться с ошибкой.

Для `deployment`-модулей:

* `deploy_instantly` - для самых простых `deployment`-модулей: сразу создаёт новый билд.
* `deploy_to_steps_instantly` - для `deployment`-модулей с поддержкой шагов деплоя: последовательно деплоит данные во все шаги деплоя без задержек.
* `deploy_if_validated_instantly` - запускает деплой, если модуль-валидатор завершился успешно.

Прочие автостартеры:

* `start_validation` - запускает модуль-валидатор.
* `start_if_validated` - запускает целевой модуль, если модуль-валидатор завершился успешно.

## Сценарии

Типовых автостартеров достаточно для большинства сценариев. Но иногда приходится писать кастомный автостартер. Здесь собраны примеры возможных кейсов:

* Если билд-триггер завершился неудачно, то автостартер может попытаться запустить целевой билд с другой версией сорс-билда.

* Все сорс-билды должны иметь одинаковый `shipping_date` (сейчас это не гарантируется: сборка `reduce`-модулей может стартовать с `ymapsdf` с разными `shipping_date`).

* Необходимо запускать целевой билд строго один раз в день (может быть актуально для оффлайн-кэшей).

* Некоторые сорс-билды нужно брать из предыдущей версии целевого билда.

* Запуск целевого билда в дневное время.

* Пауза между завершение билда-триггера и запуском целевого билда.
