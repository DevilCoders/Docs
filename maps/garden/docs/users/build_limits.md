# Контроль количества билдов

При включённом автозапуске количество билдов быстро увеличивается.
Через трейты можно настроить поведение Огорода:
отключить создание новых билдов или включить автоматическое удаление старых билдов.

Лимиты настраиваются через `build_limits` - список объектов, со следующими полями:

* `builds_grouping` - способ группировки билдов (по умолчанию нет группировки)
* `min` - минимальное число билдов в рамках одной группы (по умолчанию 0)
* `max` - максимальное число билдов в рамках одной группы (по умолчанию нет лимита)
* `remove_on_exceed` - регулирует поведение при достижении максимального числа билдов
* `ignore_warnings` - регулирует поведение при удалении билда

Пример:

```
"build_limits": [
    {
        "builds_grouping": ["region"],
        "max": 3,
        "remove_on_exceed": true
    },
    {
        "builds_grouping": ["region", "shipping_date"],
        "max": 1,
        "remove_on_exceed": false
    }
]
```

Билды могут группироваться по свойствам. В примере выше могут существовать не более 3х билдов для каждого региона, и не более 1 билда для каждой пары свойств `region`, `shipping_date`.

Если `builds_grouping` отсутствует, то лимиты `min`, `max` применяются ко всем билдам.

Параметр `min` нужен для защиты от случайного ручного удаления всех билдов.

Параметр `remove_on_exceed` регулирует поведение Огорода при достижении `max` количества билдов.

* Если `remove_on_exceed=false`, то попытки создания нового билда будут блокироваться.
  Максимальное число билдов (в норме) - `max`.
  Число билдов может превысить `max` в случаях:
  * либо трейты были изменены в строну уменьшения `max`
  * либо была гонка при одновременном запуске нескольких новых билдов
* Если `remove_on_exceed=true`, то Огород будет пробовать автоматически удалить старые билды.

По умолчанию значение `remove_on_exceed=false`.

## Автоудаление старых билдов

Попытка удаления старых билдов в контуре происходит при завершении билда в текущем контуре либо при старте нового.
Максимальное число билдов в текущем контуре (в норме) - `max+1`. Типичный сценарий:

* Имеется `max` билдов.
* Завершается новый билд. Число билдов `max+1`.
* Удаляется старый билд. Число билдов снова `max`.
* Удаляются провалившийся билды, которые старше 5 дней.

Если модуль раздаёт данные экстатиком, то на клиентах необходимо зарезервировать место на дисках под `max+1` датасетов.

Число билдов может превысить `max+1`, если Огород не может удалить старый билд.

### Правила удаления билдов

Если от билда зависят другие билды ("потомки"), то это потенциально опасная ситуация.

Иногда между ресурсами разных билдов могут существовать неявные связи:

* билд А создал датасет экстатика, а билд Б его активировал
* билд А создал Postgres-таблицу, а билд Б создал индекс по этой таблице
* билд А создал YT-таблицу, а билд Б создал ссылку на эту таблицу

В других случаях время жизни ресурсов не зависит друг от друга:

* билд А создал YT-таблицу, а билд Б на её основе создал другую таблицу
* билд А создал файл, а билд Б на его основе создал другой файл

`ignore_warnings=false` позволяет заблокировать удаление билда при наличии хотя бы одного потомка.
Билд будет удалён только если от него никто не зависит и он не запинен.

`ignore_warnings=true` позволяет удалить билд при наличии потомков.
Условия, которые блокируют удаление:

* билд запинен
* билд запущен
* потомок запущен в любом контуре
* потомок - это deployment-билд
* потомок был отменён или провалился меньше 1 дня назад

Правило 1 дня нужно, чтобы можно было перезапустить билд-потомок.

Если у текущего билда есть потомок, который был отменён или провалился больше 1 дня назад,
то он будет удалён при удалении текущего билда.

По умолчанию значение `ignore_warnings=true`.

{% note warning %}

Автоматически удаляются только завершившиеся и провалившийся билды в текущем контуре.
Если ваш билд провалившийся, и вы не планируете его перезапускать, то рекомендуется его сразу удалить,
чтобы он не блокировал удаление своих билдов-родителей.
Если же необходимо провести анализ провалившегося билда, то необходимо его запинить, чтоб предотвратить его автоматическое удаление.

{% endnote %}
