# Экспериментальные запуски модулей

При изменении кода модуля его нужно запустить и испытать, желательно на боевых данных, до завершения ревью.

Для этого необходимо запустить эксперимент в Огороде.

Для поддержки экспериментов в Огороде существуют *контуры*.
Контур содержит билды и ресурсы. Контуры отличаются версиями модулей, которые в них работают.

В Огороде есть stable-контур - для модулей, которые были зарелизены в стейбл.
В Огороде есть datatesting-контур - для модулей, которые были зарелизены в тестинг.

Пользователь может создать свой собственный контур для проведения экспериментов и добавить в этот контур модули, собранные локально.
Пользовательский контур - это аналог песочницы. Можно создавать новый контур на каждую задачу, либо переиспользовать один и тот же контур много раз.

Поддерживаемые сценарии:
* запуск локально собранного модуля на входных данных из стабильного контура
* запуск модуля, зарелизенного в тестинг/стейбл, на экспериментальных входных данных
* запуск модуля с изменёнными трейтами
* запуск src-модуля через POST-запрос
* запуск сканирования ресурсов через POST-запрос
* запуск полностью нового модуля

Пока не поддерживаемые сценарии:
* запуск кроновских автостартеров
* запуск обычных автостартеров


## Доступы

Для заливки локально собранного бинарника в пользовательский контур требуется дырка от дев-машины
до Огорода.
Нужно вписать свою дев-машину в [правило в Панчере](https://puncher.yandex-team.ru/?id=5e8c566c9f563a721ff69383).
Так же потребуется [OAuth-токен](auth.md#autentifikaciya-s-pomoshyu-oauth).

## Преднастройки

Для действий над контурами и модулями необходимо консольное приложение `garden`. Инструкции по его установке описаны [тут](cli.md).

## Сценарий: запуск локально собранного модуля на входных данных из стабильного контура {#start_local_module}

Шаг 1: Создать пользовательский контур.

Нажать на выпадушку в правом верхнем углу, ввести уникальное имя и нажать `Add`.

Имя может содержать только цифры, строчные латинские буквы, символы "дефис" (`-`) и/или "подчёркивание" (`_`). К введённому имени автоматически будет приписано имя пользователя. Финальное имя контура будет выглядеть так: `<username>_<name>`.

Выпадушка позволяет переключаться между контурами. По кнопке `i` можно открыть дашборд контура.

![](img/ui_contour_dropdown.png)

Шаг 2: Собрать бинарный модуль с локальными изменениями.

```bash
ya make -r maps/garden/modules/<module_name>/bin
```

Шаг 3: Загрузить локально собранный бинарный модуль в контур.

```bash
garden module upload --path maps/garden/modules/<module_name>/bin/<module_name> --contour <contour_name> --message "<human readable message>"
```

Шаг 4: В UI на странице модуля выбрать локальную версию.

Рядом с версией модуля показывается время, когда версия была загружена в Огород.

![](img/ui_module_version_dropdown.png)

Шаг 5: Запустить билд. На вход билду можно подать билды из стабильного контура.


## Сценарий: запуск src-модуля

src-модули нельзя запустить через UI - только через POST-запрос в API.

Шаги 1-4 аналогичны тому, что написано выше.

Шаг 5: Создать файл `data.json` с телом запроса:

```json
{
    "contour": "<contour_name>",
    "foreign_key": {
        "<stable_key>": "<stable_value>"
    },
    "resources": [
        {
            "name": "<resource_name>",
            "version": {
                "properties": {
                    "<key>": "<value>"
                }
            }
        }
    ]
}
```

Шаг 6: Отправить запрос:

```bash
curl -X POST -H "Authorization: OAuth <OAuth-токен>" -H "Content-Type: application/json" http://core-garden-server.maps.yandex.net/modules/<module_name>/builds/ --data @data.json
```

Так же вместо шагов 5-6 можно реализовать сканирование ресурсов и запустить его вручную, как описано [здесь](scan_resources.md#dopolnitelnye-vozmozhnosti).
