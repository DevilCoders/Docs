# Работа с Геобазой и tzdata

Огородные модули могут использовать Геобазу в своей работе.
Необходимо знать, где лежит Геобаза или как получить к ней доступ.

[Документация](https://doc.yandex-team.ru/lib/libgeobase5/concepts/about.xml)

## В функции `fill_graph`

Вызов функции `fill_graph` огородного модуля происходит в контейнере с шедьюлером Огорода в Няне.

Геобаза там всегда свежая: она обновляется через экстатик.
Её можно найти по пути `/var/lib/yandex/maps/ecstatic/data/yandex-maps-geodata5/geodata5.bin`.

## Во время выполнения задач

Задачи огородных модулей выполняются в ванилла-операциях в изолированных контейнерах на хостах в YT. При этом у них есть доступ на чтение файловой системы за пределами контейнера.

На хостах в YT **может** лежать Геобаза по стандартному пути `/var/cache/geobase/geodata*.bin`, но разработчики YT не дают гарантий её наличия или свежести.

Также, если операция в YT работает с Геобазой на диске, то она может быть объявлена "дятлом", и скорость работы с диском будет сильно ограничена. [Подробнее](https://yt.yandex-team.ru/docs/problems/woodpeckers).

Для решения этой проблемы есть 2 варианта.

### Использовать портослой

Разработчики YT поддерживают ежедневную генерацию свежего Porto-слоя с Геобазой. Слой нужно указывать при запуске операции в YT.

Плюсы:
* Геобаза всегда свежая.
* Геобаза лежит по стандартному пути `/var/cache/geobase/geodata*.bin`.
* Геобаза берётся из кэша в tmpfs.

Но прямо сейчас есть проблема: если на хосте в кэше в tmpfs отсутствует нужный слой, то он будет браться с диска, а значит операция рискует стать "дятлом" ([YTADMINREQ-23978](https://st.yandex-team.ru/YTADMINREQ-23978)). Также тратится время на скачивание слоя, в котором лежит сразу несколько версий Геобазы.

Поэтому при запуске ванилла-операций слой с Геобазой пока не используется.

Разработчики модулей могут на свой страх и риск использовать слой при запуске дочерних MR-операций.

[Подробнее про слои в YT](https://yt.yandex-team.ru/docs/description/mr/porto/layers_in_yt_operation)

[Подробнее про состав слоя с Геобазой](https://yt.yandex-team.ru/docs/description/mr/porto/layers_sandbox_tasks#zadacha-dlya-podgotovki-geobazovogo-delta-sloya)

### Приносить Геобазу самостоятельно

Плюсы:
* Геобаза всегда свежая.
* Геобазу можно скачивать сразу в tmpfs.

Минусы:
* Геобаза будет лежать не по стандартному пути, а в рабочей директории.
* Тратится время на скачивание (~2 минуты).

В Огороде есть вспомогальные функции, которые облегчают скачивание. Они находятся в питонячьем модуле `maps.garden.sdk.yt.geobase`.

Пример:
```python
from maps.garden.sdk.yt import geobase
from maps.garden.sdk.yt import yt_task


class MyTask(yt_task.YtTaskBase):
    def predict_consumption(self, demands, creates):
        return {
            "cpu": ...,
            "ram": ...,
            "tmpfs": True,
        }

    def __call__(self, ...):
        geobase_path = geobase.get_geobase6(self.get_server_settings("hahn"))
```

Рекомендуется сразу выставить `"tmpfs": True` и добавить к `ram` пару гигабайт для Геобазы.

Далее `geobase_path` необходимо передать в библиотеку для работы с Геобазой.

Если Геобаза необходима в дочерних MR-операциях, то можно указать в настройках операции путь к файлу в Кипарисе `//statbox/statbox-dict-last/geodata6.bin`. Тогда машинерия YT скачает файл с Геобазой локальную папку каждой джобы.

Пример:
```cpp
client->Reduce(
    TReduceOperationSpec()
        .ReduceBy({TString("id")})
        .AddInput<TNode>(inputPath)
        .AddOutput<TNode>(outputPath)
        .ReducerSpec(
            TUserJobSpec()
                .AddFile("//statbox/statbox-dict-last/geodata6.bin")
                .MemoryLimit(4_GB)
        ),
    new MyReducer(),
    TOperationOptions()
        .MountSandboxInTmpfs(true)
);
```

## Работа с tzdata

Есть 2 места, откуда можно брать `tzdata`:
* Использовать данные, зашитые в бинарник огородного модуля.
* С файловой системы - для этого нужно скачивать файлы с Сендбокса в рабочую директорию.

Чтобы зашить данные в огородный модуль, нужно
1. Указать `PEERDIR(contrib/libs/cctz/tzdata)`.
2. В задаче указать переменную окружения `GEOBASE_FORCE_CCTZ=1`
```python
os.environ["GEOBASE_FORCE_CCTZ"] = "1"
```

При этом, если `contrib/libs/cctz/tzdata` оказалась в зависимостях транзитивно через другие библиотеки, то вариант с чтением `tzdata` с файловой системы становится невозможным.

Наличие `contrib/libs/cctz/tzdata` в зависимостях можно проверить командой:
```
ya dump relation contrib/libs/cctz/tzdata
```

Если `contrib/libs/cctz/tzdata` в зависимостях отсутствует, то качать `tzdata` можно с помощью вспомогальной функции в Огороде:
```python
tzdata_path = geobase.get_tzdata_zones_bin(environment_settings)
```

Что делать при изменении данных в `tzdata`:
* Если данные зашиты в бинарник модуля, то нужно собрать и зарелизить свежую версию модуля.
* Если данные читаются с файловой системы, то ничего делать не нужно: функция `get_tzdata_zones_bin` всегда качает самые свежие данные.
