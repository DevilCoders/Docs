# Диагностика ошибок огородных модулей

Огород отслеживает состояние огородных модулей и их работу, и в случае возникновения каких-либо проблем поджигает мониторинги в Джагглере.

За огородными модулями следят разные дежурные: по одним мониторингам дежурные разработчики, по другим - дежурные контент-менеджеры, а по выходным - дежурные выходного дня.

Информация ниже предназначена для разных дежурных.

## Общие сведения о модулях

Имя модуля можно найти в сообщении, которое приходит в Телеграм, либо извлечь из имени хоста в Джагглере `maps_garden_<module_name>_<stage>`.

Исходный код модуля лежит в Аркадии в директории `maps/garden/modules/<module_name>`.

Страница в UI Огорода `https://garden.maps.yandex-team.ru/stable/<module_name>`.

У каждого модуля может быть своя инструкция в файле: `maps/garden/modules/<module_name>/README.md`.

Ответственный разработчик модуля указан в файле `maps/garden/modules/<module_name>/module_traits.json` в поле `module_maintainer`.

ABC-сервис модуля указан в файле `maps/garden/modules/<module_name>/sedem_config/__all__.yaml`.

## Описания алертов

### latest_build_status

Этот алерт загорается, если последний билд модуля долго находится в каком-то одном статусе:
* FAILED - билд завершился ошибкой;
* IN PROGRESS - билд работает очень долго и, предположительно, завис;
* COMPLETED - это значит, что модуль давно не запускался.

#### Билд завершился ошибкой

Посмотреть текст ошибки можно, нажав на кнопку `view_log` в UI Огорода. Также дополнительную информацию можно получить со страницы билда (бывший `Perf Analyzer`), нажав на кнопку со спидометром в UI Огорода.
Подробная информация есть в тикете в Стартреке, ссылка на который есть в сообщении в Телеграме.

![](img/build_logs_button.png)

Ошибки делятся на 3 типа:
* Ошибка инфраструктуры или окружения.
* Ошибка в новой версии модуля.
* Ошибка во входных данных.

**Ошибка инфраструктуры или окружения**

Модули работают с разными внешними системами, которые могут иногда ломаться или работать нестабильно: YT, YQL, S3, Sandbox, Ecstatic и другие. У всех этих систем есть свои ответственные дежурные, которые за ними следят.

В Огороде такие ошибки покрыты автоматическими ретраями, и обычно не приводят к поджиганию мониторинга. Но иногда всё же может потребоваться реакция человека.

Как понять, что это ошибка инфраструктуры:
* В сообщении об ошибке встречаются слова `Connection broken`, `Internal Server Error`.
* В сообщении об ошибке нет явных указаний, что ошибка связана с данными.
* Ошибка возника в версии модуля, которая уже давно работает в продакшене.

Что делать дежурному: нажать кнопку рестарта билда.

![](img/build_failed_restart_button.png)

**Ошибка в новой версии модуля**

Бывает, что в стейбл зарелизили модуль с багом, не проверив его в тестинге.
В этом случае может помочь откат на предыдущую версию модуля. Для этого можно использовать [SEDEM](module-lifecycle.md#sedem): команду `sedem release rollback <path> stable`.

Как понять, что версия модуля - новая:
* На странице модуля в UI Огорода есть столбец `Module version` с версией модуля для всех текущих билдов в Огороде.
* По ссылке `Open events log` можно посмотреть более детальный лог действий, и, например, отфильтровать событие `module released`.

Что делать дежурному: позвонить ответственному разработчику и спросить, можно ли откатывать модуль на предыдущую версию.

**Ошибка во входных данных**

Мы стремимся, чтобы ошибки во входных данных приводили к поджиганию отдельного алерта `autotests_failed`. Но бывает, что ошибки в данных приводят к поджиганию алерта `latest_build_status`.

Если дежурный разработчик или ответственный разработчик модуля видит, что ошибка именно в данных из НЯК, то нужно позвонить дежурному контент-менеджеру. Он поправит ошибку и перезапустит экспорт из НЯК.

* Главный дежурный контент-менеджер: [календарь][main_content_duty]
* Запасной дежурный контент-менеджер: [календарь][secondary_content_duty]

##### Распространённые типы ошибок

**Memory limit exceeded** - задаче не хватило заказанного объема памяти, и YT досрочно прервал выполнение задачи.

Порядок действий:
1. Определить причину, по которой не хватило памяти: либо входные данные оказались большего размера, либо была зарелизена новая версия модуля, которая требует больше памяти в процессе работы.
1. Определить место, где не хватило памяти: [в самой задаче](https://st.yandex-team.ru/MAPSGARDENBUILD-11576) или [в дочерней MR-операции](https://st.yandex-team.ru/MAPSGARDENBUILD-1568).
1. Если изменение во входных данных или в коде ожидаемое, то нужно увеличить требуемый объем памяти:
    * если памяти не хватило самой задаче, то поправить метод `predict_consumption` у упавшией задачи;
    * если памяти не хватило дочерней MR-операции, то нужно поправить спеку операции в том месте, где операция запускается.
1. Закоммитить изменение в Аркадию и выкатить в тестинг.
1. Сделать хотфикс в стейбл и перезапустить билд.

**Failed to increase resource usage** - аналогично ошибке **Memory limit exceeded**,
но происходит в результате бага в YT, который выделяет только половину ресурсов, указанных в `predict_consumption`.
Порядок действий аналогичен ошибке **Memory limit exceeded**.

**Row weight is too large** - YQL-запрос не смог записать строку в таблицу из-за того, что строка содержит данные очень большого размера.

YT-таблицы имеют максимальное ограничение на размер одной строки 128МB. Но по умолчанию при записи в таблицу стоит более строгое ограничение.

Пример: [MAPSGARDENBUILD-12063](https://st.yandex-team.ru/MAPSGARDENBUILD-12063)

Порядок действий:
1. Определить причину, по которой YQL-запрос попытался записать большую строку в YT-таблицу.
1. Если данные хорошие, то нужно добавить в запрос прагму `PRAGMA yt.MaxRowWeight = '128M';`.
1. Закоммитить изменение в Аркадию и выкатить в тестинг.
1. Сделать хотфикс в стейбл и перезапустить билд.

**Dataset name=version is not active on all groups after N seconds of waiting**

Таска **ActivateTask** посылает в **ecstatic** команду активировать датасет.
Далее таска в цикле запрашивает у **ecstatic** статус активации. Таска завершается ошибкой, если датасет не удалось активировать за отведённое время (обычно 2 часа).

Таску можно безопасно рестартить, чтобы продлить время ожидания ещё на 2 часа. Но сам по себе рестарт таски не поможет устранить источник проблемы.

Порядок дейсвий:
1. Открыть страничку датасета в интерфейсе **ecstatic** и выбрать необходимую версию датасета. [Пример](http://core-ecstatic-coordinator.maps.yandex.net/pkg/yandex-maps-coverage5-geoid/versions).
  Хосты, на которые деплоится датасет, сгруппированы по веткам (`[stable]`, `[prestable]`, `[testing]`) и по сервисам.
  Хосты, на которых датасет уже активировался, имеют статус `Active`.
2. Найти хосты, рядом с которыми нет слова `Active`, посмотреть к какому сервису они относятся. Пример: `rtc:maps_core_nmaps_mrc_browser_pro_stable`.
3. Найти этот сервис в [каталоге всех сервисов](https://proxy.sandbox.yandex-team.ru/last/SEDEM_SERVICE_TOC/index.html)
4. Написать/позвонить ответственному разработчику с просьбой разобраться в проблеме с их сервисом.

**Could not schedule build MODULE:VERSION with properties 'PROPERTIES': Can't get metas for request N: Request created resource with key KEY and hash HAS1, but it is HASH2 in storage.**

Ошибка возникает, если задача из одного билда перезатёрла в YT таблицу, сваренную задачей из другого билда. Подробнее:

1. Задача в билде `module_name:1` варит таблицу `//home/garden/module_name/my_table_22.07.14-0`
2. Потом запускается задача в билде `module_name:2` и перезаписывает эту же таблицу. Также перезаписывается запись в Монге.
3. Потом пользователь запускает билд другого модуля `module_name:1 -> another_module:1`, и сборка модуля `another_module` падает с вышеописаной ошибкой.

Обычно это связано с ошибкой пропагации свойств в коде модуля. Один из возможных сценариев:

- Задача принимает на вход ресурсы из разных источников данных с разными версиями.
- Шаблон пути зависит от версии только одного источника: `module_name/my_table_{source1_release_name}`
- Если в новом билде версия первого источника не изменилась, а у второго - изменилась, то задача будет запущена и перезапишет старую таблицу.

Есть разные варианты починки:
- В шаблоне пути использовать версию билда `module_name/my_table_{build_release_name}`.
- Либо использовать версии всех источников: `module_name/my_table_{source1_release_name}_{source2_release_name}`.

При дебаге ошибки может понадобиться помощь от разработчиков Огорода.

Запрос для определения имени ресурса по ключу:
```
db.resources.find({"version.key": "KEY"})
```

Запрос для определения списка билдов, которые создавали ресурсы с этим ключом:
```
db.builds.find({"output_resources_keys": "KEY"})
```

#### Билд работает дольше обычного

Возможно билд завис. Причин у этой ситуации может быть 2:
* Ошибка в коде модуля
* Ошибка в шедьюлере Огорода

Ошибки в сервере Огорода ловятся ещё в тестинге, и в продакшене вероятность встретить такую ошибку небольшая.

Что делать дежурному:
* попробовать нажать кнопку рестарта билда и понаблюдать;
* если рестарт не помог, то нужно позвонить ответственному разработчику модуля;

Если разработчик модуля не видит проблем на стороне модуля, то нужно позвонить разработчикам Огорода.
Если ошибка в шедьюлере Огорода, то обычно помогает его перезапуск.

![](img/build_restart_button.png)

#### Давно не было новых билдов

Последний билд отработал несколько дней назад, перешёл в статус `COMPLETED`, и новых билдов не было.

Причин у этой ситуации может быть 3:
* У модуля не настроены (или настроены с ошибкой) автостартеры.
* Не приходят новые данные.
* Ошибка в сервере Огорода.

Ошибки в сервере Огорода ловятся ещё в тестинге, и в продакшене вероятность встретить такую ошибку небольшая.

Если не приходят новые данные, то алерт будет в статусе WARN.

Поэтому если алерт зажёгся в CRIT, то с большой вероятностью что-то не в порядке с настройкой автостартеров.

Что делать дежурному: вручную запустить билд модуля.

Разные типы модулей запускаются по-разному.

В некоторых случаях достаточно нажать на желтую иконку справа.

![](img/start_map_build.png)

В других случаях нужно ввести имя релиза (или взять предложенный вариант), нажать кнопку `Set release name` и накликать список сорс-билдов и дальше кнопку `Create release`. У разных модулей разный список сорсов. Если нет уверенности, то нужно позвонить ответственному разработчику.

![](img/start_reduce_build.png)

### build_limits

Этот алерт означает, что количество билдов превысило лимит.

Если модуль деплоит данные экстатиком, то на хостах может закончиться место на диске.

Что делать дежурному: удалить старые билды на странице модуля в UI, нажав на кнопку с мусорной корзиной.
Запиненные билды удалять не стоит (иконка с замком справа).

![](img/build_removal_button.png)

### autotests_failed

Этот алерт означает, что автотесты нашли ошибки в данных.
Мы стремимся, чтобы сообщения об этих ошибках автоматически отправлялись дежурным контент-менеджерам.
На время переходного периода разбором автотестов могут заниматься также разработчики модуля.

Процедура разбора автотестов отличается от модуля к модулю.

Что делать дежурному контент-менеджеру:
- В сообщении в Телеграме будет ссылка на тикет в Стартреке. В тикете должно быть подробное описание ошибки.
- Проверить файл README.md в папке модуля: если там есть инструкция, то действовать по ней.
- Если не понятно, что делать, то нужно звонить ответственному разработчику модуля.

Если разбором ошибок занялся дежурный разработчик, то он может позвонить дежурному контент-менеджеру:
* Главный дежурный контент-менеджер: [календарь][main_content_duty]
* Запасной дежурный контент-менеджер: [календарь][secondary_content_duty]

## Исправление ошибок

Если сваренные модулем данные привели к проблемам в сервисе-потребителе,
а откат средствами deployment-модуля почему-то неприменим,
данные можно откатить вручную.

### Операции с ecstatic-ом

Для работы с экстатиком потребуется установить пакет `yandex-maps-ecstatic-tool` из репозитория `yandex-musl`
и выставить следующие переменные окружения:

* `ENVIRONMENT_NAME` — окружение, в котором будут проводиться изменения.
    В случае Огорода может принимать значения `unstable`, `datatesting`, `stable`.
* `ECSTATIC_TVM_ID` — идентификатор клиентского приложения для выписывания TVM-тикета.
    Нужно взять из [environment_settings.json](https://arcanum.yandex-team.ru/arc/trunk/arcadia/maps/garden/scheduler/config/).
* `ECSTATIC_TVM_SECRET` — секрет клиентского приложения для выписывания TVM-тикета.
    Нужно взять из [yav](https://yav.yandex-team.ru/?search=maps_garden_).

{% note warning %}

Ручные операции с Экстатиком приведут к расхождению реального положения дел с интерфейсом Огорода.

Используйте описанный способ только при крайней необходимости.

{% endnote %}

Пример активации датасета в ветке `testing` в `stable`-инстансе экстатика:
```bash
ENVIRONMENT_NAME=stable ECSTATIC_TVM_ID=2012620 ECSTATIC_TVM_SECRET=<tvm_secret> ecstatic move yandex-maps-perspoi-design=2021.11.11-9905 +testing
```

[main_content_duty]: https://calendar.yandex-team.ru/embed/week?embed&layer_ids=378839
[secondary_content_duty]: https://calendar.yandex-team.ru/embed/week?embed&layer_ids=378841
