# Настройка Juggler алертов для модуля

Алерты появляются автоматически при создании SEDEM-конфига.

От разработчиков модуля требуется настроить нотификации. Для этого нужно поправить файл `filters.yaml` в директории `sedem_config` модуля в соответствии с [документацией по SEDEM](https://wiki.yandex-team.ru/geo-infra/SEDEM/faq/#alertyinotifikacii). Рекомендуется как минимум указать дев-чат команды для всех алертов.

Пример:

```yaml
alerts:
  - body:
      notifications:
        - type: telegram
          login: [maps-garden-dev-chat]
          status: [WARN, CRIT]
```

Есть также чаты с нотификациями для всех модулей:

- [WARN и CRIT](https://t.me/joinchat/Ci_obxn3X3eOsDf5gOobnA)
- [только CRIT](https://t.me/joinchat/EI5uVEYJdwm_nPlUDVFmiA)

Поведение некоторых алертов можно менять через трейты модуля (см. ниже).

## Описание проверок

### Проверка `check_build_limits`

**Предназначение:** контролировать количество билдов.

Сравнивает количество успешно завершившихся билдов со
значением в секции `build_limits`. Если количество превышено на 1, то
поджигается WARN.

Проверка никогда не поджигается в `CRIT`.

### Проверка `check_latest_build_status`

**Предназначение:** выявлять следующие сценарии:

- билд завис
- модуль давно не запускался
- билд упал (кроме тех, что упали по причине некорректных данных)

Конфигурируется в секции `status_checks`. Проверки выполняются по очереди.
В качестве итогового результата, который будет отправлен в Juggler, берётся
наихудший результат из всех проверок.

Чаще всего массив `status_checks` должен состоять только из одного элемента.
Несколько проверок необходимы, например, если билды модуля регулярны в целом,
но не регулярны для конкретного региона.

В случае, если массив пустой или секция `status_checks` отсутствует,
выполняется проверка по умолчанию. С конфигурацией проверки можно ознакомиться
[тут](https://a.yandex-team.ru/arc/trunk/arcadia/maps/garden/tools/module_monitoring/lib/latest_build_status.py?rev=r7346969#L39).

Каждый элемент массива включает в себя следующие поля:

- _(обязательное)_ `statuses_config` — настройки максимального возраста по
  каждому из статусов. Подробнее про них рассказывается далее.
- _(необязательное)_ `group_by` — массив полей, по которым группируются билды.
  Настройки применяются отдельно к каждой полученной группе. Результат проверки
  вычисляется как наихудший результат группы. Если массив пуст или поле
  отсутствует, то группировка не производится и проверка применяется ко всем
  билдам модуля.

Список поддерживаемых статусов и соответствующих им точек отсчёта возраста:

- `in_progress` — проверяется возраст с момента старта билда
- `completed` и `failed` — с момента окончания билда

Если конфигурация по какому-либо из статусов отсутствует, то для этого статуса
берутся значения по умолчанию. Ознакомиться с ними можно
[тут](https://a.yandex-team.ru/arc/trunk/arcadia/maps/garden/tools/module_monitoring/lib/latest_build_status.py?rev=7346969#L39).

{% note info %}

Значения по умолчанию подобраны "с запасом". Предполагается, что пользователь
будет изменять настройки только для статусов `in_progress` и `completed`,
причем только в меньшую сторону. Если вы чувствуете необходимость
сделать что-то другое — обратитесь к разработчикам Огорода за консультацией.

{% endnote %}

Для каждого статуса задаются параметры:

- `crit_age` — возраст билда, при котором зажигается CRIT
- `warn_age` — возраст билда, при котором зажигается WARN
- `disabled` — флаг отключения проверки

Формат возраста: `[<days>d][<hours>h][<minutes>m][<seconds>s]`.
Например: `30h`, `2d8h5m20s`.

Если какой-то параметр отсутствует или если в него записана пустая строка, то
он приравнивается к нулю, то есть проверка будет поджигать WARN/CRIT **сразу же**.

Параметр `crit_age` имеет приоритет над параметром `warn_age`. Если задать
`warn_age` >= `crit_age`, то проверка будет посылать CRIT по достижении
`crit_age` и продолжит посылать CRIT при достижении `warn_age`.

**Пример 1**:

```json
"status_checks": [
    {
        "group_by": ["region"],
        "statuses_config": {
            "in_progress": {"warn_age": "10h", "crit_age": "16h"},
            "completed": {"warn_age": "14d"}
        }
    }
]
```

Согласно приведённому выше конфигу проверка будет группировать билды по региону
и для каждой группы вычислять статусы следующим образом:

- билд выполняется:
  - OK: менее 10 часов
  - WARN: от 10 часов до 16 часов
  - CRIT: более 16 часов
- билд был успешно завершен:
  - OK: менее 14 дней назад
  - WARN: более 14 дней назад
- билд завершился ошибкой:
  - CRIT: сразу же

**Пример 2**:

```json
"status_checks": [
    {
        "statuses_config": {
            "completed": {"disabled": true}
        }
    }
]
```

Такой конфиг отключает проверки возраста успешно завершившихся билдов. Он
полезен для билдов, которые запускаются редко.

### Проверка `check_autotests_failed`

**Предназначение:** выявлять проблемы с данными.

Является особым случаем проверки `check_latest_build_status`.
Если последний билд находится в статусе FAILED из-за того, что одна из
тасок кинула ошибку `AutotestsFailedError` или `DataValidationWarning`, то
**вместо проверки `check_latest_build_status`** загорается проверка
`check_autotests_failed`.

### Проверка `autostart_disabled`

**Предназначение:** напоминать разработчикам модуля включать автостартеры
обратно после починки модуля.

Если автостартер отключён дольше 2х часов, то проверка поджигается в `WARN`.

Проверка никогда не поджигается в `CRIT`.

### Проверка `stable_version_too_old`

**Предназначение:** напоминать разработчикам докатить модуль из тестинга
в стейбл.

Проверка применяется только в stable-контуре. Загорается, если версия модуля
в stable-контуре отличается от версии модуля в testing-контуре и
если модуль был зарелизен в тестинг больше недели назад.

Проверка никогда не поджигается в `CRIT`.

### Проверка `scan_resources_status`

Проверка поджигается в `CRIT`, если последнее сканирование ресурсов завершилось ошибкой.

### Проверка `autostarter_status`

Проверка поджигается в `CRIT`, если последний вызов автостартера завершился ошибкой.
