# Работа с YT

## Ресурсы

TODO: написать про `YtTableResource`

## Python

Для запуска операций в YT рекомендуется использовать методы класса [YtTaskBase](https://a.yandex-team.ru/arc/trunk/arcadia/maps/garden/plugins/yt2/lib/yt_task.py?rev=6201303#L12) `run_*`.

Эти методы оборачивают стандартные функции из библиотеки `yt.wrapper` (`run_map()` и другие). При этом они добавляют ряд полезных вещей:

* Печатают в лог URL операции.
* После завершения операции читают stderr джобов и подливают в лог ванилла-операции, который доступен по ссылке из Перфа.
* Добавляют метаданные в спеку операции, которые позволяют Огороду собирать статистику по всем операциям, и в будущем добавить в UI Перфа ссылку для быстрого перехода на страничку MR-операции.

## С++

### Инициализация

Если вы вызываете C++ API через обёртку на Cython, то необходимо его проинициализировать в функции `main()` огородного модуля:

```python
from maps.garden.libs import yt

def main():
    yt.initialize(sys.argv)
    run_module("module_name", module_name.fill_graph)
```

Если вы собираетесь только читать/писать таблицы без запуска MR-операций, то вы можете использовать `jobless_initialize` вместо `initialize`.

### Создание клиента

Независимо от способа вызова (Cython или запуск тула)
для создания клиента рекомендуется использовать функцию [CreateClientFromEnv](https://a.yandex-team.ru/arc/trunk/arcadia/mapreduce/yt/interface/client.h?rev=6198766#L545).

```c++
auto client = NYT::CreateClientFromEnv();
```

Все необходимые для инициализации данные Огород прокидывает через переменные окружения:

* `YT_PROXY=hahn`
* `YT_SECURE_VAULT_YT_TOKEN` - токен робота для доступа к таблицам в аккаунтах `garden` и `garden-exp` и для запуска операций в пуле `garden`
* `YT_POOL` - пул, в котором запущена операция (`garden_stable`, `garden_datatesting`, `garden_development`, `garden_offline_cache`)
* `YT_SPEC` - метаданные в спеке операции, которые позволяют Огороду собирать статистику по всем операциям.

{% note warning %}

Сейчас stderr из джобов MR-операций автоматически не собираются, в отличие от запуска через Python.
Будет сделано в [MAPSGARDEN-15968](https://st.yandex-team.ru/MAPSGARDEN-15968)

{% endnote %}

{% note warning %}

Все операции, в том числе и дочерние, запускаются с изоляцией по сети. Если нужны какие-то доступы, кроме стандартных,
их необходимо явно запросить. [Больше инфомации о доступах](puncher.md).

{% endnote %}

## YQL

TODO: написать про YQL
