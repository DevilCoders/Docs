# Усовершенствование сбора, хранения и визуализации статистики по огородным модулям

Огород - ключевое звено в процессе релиза данных на Яндекс.Картах. Процесс занимает много часов и включает запуск ~40тыс тасок каждый день и сотен билдов.

Статистика по огородным модулям позволяет решать следующие задачи:

* находить узкие места в работе тасок и ускорять релизный процесс;
* оптимизировать использование вычислительных ресурсов;
* заказывать новое железо.

В Q3 2022 планируется закрытие сервиса "Статистика" (https://stat.yandex-team.ru/). В связи с этим предлагается:

* перенести старые данные за несколько лет из "Статистики" в YT;
* настроить процесс заливки новых статистических данных сразу в YT;
* создать дашборды для просмотра статистики как огородных модулей так и Огорода в целом.

## Текущее положение дел

В Огороде сейчас есть несколько отчётов в "Статистике" и несколько дашбордов в Datalens, которые на них смотрят.

### Время работы билдов

Отчёт [ExtData/garden/statistics](https://stat.yandex-team.ru/ExtData/garden/statistics?scale=i&region=9&project=1&branch=_in_table_&module=44&build_id=_in_table_&date_min=2021-07-19+09%3A10%3A00&date_max=2021-07-27+09%3A11%3A59)

Заливается в "Статистику" тулом [stat_updater](https://a.yandex-team.ru/arc_vcs/maps/garden/tools/stat_updater/), который запускается по крону в докере с шедьюлером Огорода.

По этому отчёту строится ряд графиков:
* https://datalens.yandex-team.ru/preview/nb1eyaujmiacm-branches?env=production
* https://datalens.yandex-team.ru/preview/editor/garden/builds_in_branch?project=1&branch=2297
* https://datalens.yandex-team.ru/preview/editor/garden/builds?project=1&module=44&region=9

### Операции в YT

* Отчёт [ExtData/garden/garden_yt_pool_usage](https://stat.yandex-team.ru/ExtData/garden/garden_yt_pool_usage) - распределение вычислительных ресурсов между контурами и модулями;
* отчёт [ExtData/garden/yt_alerts](https://stat.yandex-team.ru/ExtData/garden/yt_alerts) - алерты в операциях в YT;
* отчёт [ExtData/garden/resource_consumption](https://stat.yandex-team.ru/ExtData/garden/resource_consumption) - потребление вычислительных ресурсов тасками.

Заливается в "Статистику" тулом [yt_stats_collector](https://a.yandex-team.ru/arc_vcs/maps/garden/tools/yt_stats_collector/), который запускается по расписанию в Сендбоксе.

Тул дублирует данные в папку [//home/maps/core/garden/stats](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/core/garden/stats)

Все графики доступны со страницы дашборда статистики https://dash.yandex-team.ru/rlc80mom129go

### Прочие отчёты

Отчёты рендерера:

* [ExtData/garden/render-stats](https://stat.yandex-team.ru/ExtData/garden/render-stats)
* [ExtData/garden/offline_tile_cache](https://stat.yandex-team.ru/ExtData/garden/offline_tile_cache)
* [ExtData/garden/offline_tile_cache_aggregated](https://stat.yandex-team.ru/ExtData/garden/offline_tile_cache_aggregated)

Заливаются в "Статистику" из тасок в Сендбоксе:

* https://a.yandex-team.ru/arc_vcs/sandbox/projects/garden/OfflineTileCacheToStat/__init__.py
* https://a.yandex-team.ru/arc_vcs/sandbox/projects/garden/RenderModulesToStat/__init__.py

Отчёт по модулю `ymapsdf` [Maps.Wiki/Garden/ymapsdf_row_statistics](https://stat.yandex-team.ru/Maps.Wiki/Garden/ymapsdf_row_statistics). Заливается в "Статистику" из таски в Огороде: https://a.yandex-team.ru/arc_vcs/maps/garden/modules/ymapsdf/lib/ymapsdf_tester/statface_report.py?rev=trunk#L212

В рамках данного документа отчёты рендерера и `ymapsdf` далее рассматриваться не будут.

## Какие данные будем собирать

### Данные о билдах

* имя контура
* имя модуля
* build_id
* время запуска билда (когда пользователь нажал кнопку старта в UI и создалась запись в Монге в `build_actions`);
* время запуска первой таски в билде
* время завершения билда
* время удаления билда (?)
* полная длительность билда: от старта до завершения
* длительность тасок на критическом пути
* финальный статус билда (completed, failed, cancelled)
* количество тасок, успешно отработавших в билде
* количество зафейлившихся тасок
* количество ресурсов, сваренных в билде
* регион в НЯК
* ветка в НЯК
* свойства (?)
* source-билды

### Данные о запусках тасок

* имя контура
* имя модуля
* build_id
* имя таски
* task_id (зависит от хэшей ресурсов - вычисляется)
* task_key (глобально уникальный)
* статус (успешное завершение, исключение из таски, крэш, внешняя причина)
* версия модуля

* время 1: когда готовы все Demands-ресурсы
* время 2: когда был послан в YT запрос на запуск ванилла-операции
* время 3: когда стартовала джоба
* время 4: когда запустился бинарник огородного модуля и началась фаза `ensure_available` у ресурсов.
* время 5: когда стартовала сама таска
* время 6: когда таска звершилась и началась фаза `commit` у ресурсов
* время 7: когда фаза `commit` завершилась и данные отправлены в Огород
* время 8: когда ресурсы были записаны в Монгу Огорода

* время 2 - время 1: процессинг внутри `RequestHandler` и `YtTaskHandler`, вызов `predict_consumption`.
* время 3 - время 2: ожидание, пока освободятся вычислительные ресурсы в YT
* время 4 - время 3: ожидание, пока скачается бинарник модуля в джобу
* время 5 - время 4: `ensure_available` - скачивание FileResource/DirResource из S3 в джобу
* время 6 - время 5: время работы самой таски, пользовательского кода
* время 7 - время 6: `commit` - заливка файлов FileResource/DirResource в S3, сортировка таблиц YtTableResource
* время 8 - время 7: процессинг внутри `YtTaskHandler`.

* заказанное cpu в `predict_consumption`
* заказанная ram в `predict_consumption`
* была ли заказана tmpfs в `predict_consumption`

* сколько реально cpu было использовано во время работы (берётся из статистики в YT)
* сколько реально ram было использовано во время работы (берётся из статистики в YT)
* сколько tmpfs было использовано во время работы (берётся из статистики в YT)

* operation_id
* job_id
* host

### Данные о ресурсах

* имя контура
* имя модуля
* build_id
* имя ресурса
* тип ресурса
* свойства (?)
* хэш
* ключ
* task_key таски, которая создала ресурс
* время от запуска билда до готовности ресурса
* время работы таски, которая создала ресурс
* длительность фазы `ensure_available`
* длительность фазы `commit`
* размер в байтах
* размер в строках (для YT-таблиц)

### Данные об операциях

* имя контура
* имя модуля
* build_id
* operation_id
* тип операции (map/reduce/...)
* кластер (hahn)
* pool (garden/garden_stable/...)
* origin (garden, user, yql)
* время старта
* время завершения

TODO: Рассмотреть возможность связывания операций и тасок:

* MR-операция всегда привязана к какой-то одной таске;
* в ванилла-операции запускаются разные таски в разных джобах.

### Потребление вычислительных ресурсов

https://yt.yandex-team.ru/docs/other/event_logs
https://yt.yandex-team.ru/hahn/scheduling/monitor?pool=garden_stable&tree=physical

Планировщик YT логирует, сколько интегрально потребляют операции вычислительных ресурсов по времени.

* timestamp
* имя контура
* имя модуля
* build_id
* CPU demands/usage/garantee
* Memory demands/usage/garantee
* Demand/usage ratios
* Operation count
* Total disk activity

### Версии модулей

* имя модуля
* номер версии
* размер бинарника в байтах
* время сборки (приблизительно время коммита в транк)
* время релиза в тестинг
* время релиза в стейбл

## Хранение и заливка данных

Таблицы будем хранить в виде `//home/maps/core/garden/stats/<table_name>/YYYY-MM-DD`.

Скрипт будет запускаться по расписанию, брать данные из Монги и перезаписывать таблицы в YT.

Таблица за один день будет перезаписываться полностью, без дозаливок.

## Дашборд для модуля

Для каждого модуля будет свой дашборд (=параметризованный дашборд). Со страницы модуля в UI Огорода на него будет вести ссылка.

Дашборд будет решать задачи:

* Исследование, как действия пользователя (релиз новой версии модуля в тестинг/стейбл) или размер данных повлияли на работу модуля в целом и отдельных тасок.
* Поиск проблемных мест для будущих улучшений и оптимизаций.

### Графики на дашборде

Через селектор можно будет отфильтровать контур: либо `stable`, либо `datatesting`, либо общий пункт на все остальные контуры.

По оси Х - время:

- длительность билда и длительность критического пути билда ([аналог](https://datalens.yandex-team.ru/preview/editor/garden/builds?project=1&module=49&region=2))
- размер модуля в байтах
- интегральное потребление вычислительных ресурсов в YT всеми операциями модуля (cpu/ram/operations/usage/demand/...).
- для выбранной таски - длительности её работы (чистое время, время `ensure_available` и `commit` и т.д.)
- для выбранной таски - потребляемые ресурсы cpu/ram
- для выбранного ресурса - длительность сборки ресурса, размер ресурса

Таблицы с тасками и ресурсами, отсортированные по какому-либо критерию:

- таски, отсортированные по длительности;
- таски, отсортированные по потреблению cpu/ram (без учета дочерних операций);
- таски, отсортированные по потреблению cpu/ram (с учетом дочерних операций);
- таски, отсортированные по `predict_consumption`;
- таски, которые потребляют cpu/ram сильно меньше, чем заказано в `predict_consumption`;
- таски, которые потребляют cpu/ram впритык к `predict_consumption` и рискуют получить ошибку `Memory limit exceeded`.
- cpu-bound таски
- io-bound таски

Алерты операций (vanilla/map/reduce), которые запускались этим модулем, с разбивкой по типам алертов.

## Общий дашборд для разработчиков Огорода

Дашборд будет решать задачи:

* Сравнение модулей между собой по потребляемым вычислительным ресурсам cpu/ram/operations.
* Исследование накладных расходов, которые добавляет Огород к работе модулей.
* Исследование, как ускоряется или замедляется релизный процесс с течением времени.

### Сравнение модулей

Пример, как сейчас сделано в Огороде: https://datalens.yandex-team.ru/rlc80mom129go-mapsgarden?tab=Ap
Пример, как сейчас сделано в YT: https://yt.yandex-team.ru/hahn/scheduling/monitor?pool=garden_stable&tree=physical

Графики: CPU, memory, operation count, Demands/Usage ratios, disk activity.

На каждом графике сравниваются между собой модули.

### Накладные расходы

У каждой таски несколько длительностей (см. выше), которые включают время обработки таски в Огороде.

По оси Х - время:
- накладные расходы для тасок, запущенных в данный момент времени
- количество запущенных тасок в текущий момент времени
- нагрузка (cpu) на шедьюлер Огорода (сейчас этот сигнал есть в Головане, не знаю, есть ли возможность добавить его в Datalens)

### Релизный процесс

Пример, как сделано сейчас: https://datalens.yandex-team.ru/preview/editor/garden/builds_in_branch?project=1&branch=2451

График с селектором по имени ветки НЯК. Для каждой ветки на графике показываются билды, построенные на основе этой ветки.

Отличие нового графика от текущей реализации:

- только билды, основанные на регионе cis1
- билды со статусами completed/failed/cancelled.

Мотивация: `reduce`-модули могут потреблять билды `ymapsdf` с разными `shipping_date`, а следовательно с разными номерами веток НЯК. Это запутывает понимание графика. Регион `cis` - самый главный из всех. Для простоты можно смотреть только на него.
Для нахождения проблем в релизном процессе нужно сделить за билдами, которые сфейлилсь или были отменены.

График с зависимостью: номер ветки НЯК -> суммарная длительность релизного процесса от прихода экспорта НЯК до релиза в стейбл.
