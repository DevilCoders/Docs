# Конвертация OpenStreetMap в ymapsdf

Цель: поддержать работу с данными OpenStreetMap в наших сервисах (роутере, рендерере, геокодере), так чтобы их могли использовать Такси и B2B GEO.

Для ускорения разработки будем по максимуму переиспользовать существующий код. Для этого сначала сконвертируем OpenStreetMap в формат ymapsdf и далее на базе него будем собирать дорожный граф, индекс геокодера и т.д.

Вся подготовка данных разбивается на 3 шага:

* Шаг 1: Сконвертировать данные OpenStreetMap в YT-таблицы.
* Шаг 2: Сконвертировать данные OpenStreetMap из YT-таблиц в формат ymapsdf.
* Шаг 3: Подготовить данные для роутера, рендерера, геокодера.

Из-за юридических ограничений данные OpenStreetMap нельзя смешивать с другими источниками данных, в частности с НЯК и Справочником. Поэтому для обработки OpenStreetMap сделаем отдельную цепочку огородных модулей.

Код конвертации для шага 1 уже [написан](https://a.yandex-team.ru/arc/trunk/arcadia/maps/tools/osm_to_yt). Его осталось только обернуть в огородный модуль `osm_src`.

Почти весь новый код будет написан для шага 2 в новом огородном модуле `ymapsdf_osm` с частичным переиспользованием кода из модуля `ymapsdf`.

На шаге 3 будут созданы новые огородные модули `renderer_*_osm`, `road_graph_*_osm`, `geocoder_*_osm`, которые будут по максимуму использовать существующие таски из других модулей, возможно в чуть урезанном варианте.

Далее в этом документе будут рассматриваться шаги 1 и 2.

## Получение данных

Источники данных:

- https://planet.openstreetmap.org/ - файл `planet.osm`, который содержит весь мир (~60GB).
- https://download.geofabrik.de/ - можно скачать отдельные континенты и страны.
- https://www.openstreetmap.org/export#map=15/55.7321/37.5888 - можно скачаь прозвольную область в формате XML.
- https://daylightmap.org/ - альтернативная неясно как улучшенная версия OSM.

Данные OSM поставляются в форматах [XML](https://wiki.openstreetmap.org/wiki/OSM_XML) и [PBF](https://wiki.openstreetmap.org/wiki/PBF_Format) на основе protobuf. Будем использовать формат PBF, т.к. он более быстрый.

На первом этапе будем скачивать датасеты вручную. Чтобы Огород мог получить доступ к данным, датасет нужно залить в Сендбокс командой `ya upload`. При этом нужно указать свойства ресурса: `shipping_date`, `region` и `vendor=osm`, чтобы потом было проще понимать, что это за данные и откуда они взялись.

Далее для учёта датасетов OSM заведём отдельный тип ресурса в Сендбоксе. Это позволит проще искать все залитые датасеты.

Для запуска сборки в Огороде нужно послать URL датасета в Сендбоксе в POST-запросе на ручку `/modules/osm_src/builds/`.

На следующем этапе сделаем таску в Сендбоксе, которая будет по крону скачивать данные OSM из интернета и заливать в Сендбокс, а в Огороде соответственно - сканер ресурсов, который будет добавлять ссылки на датасеты в Огород.

## Регионы

Пока не ясны бизнес-требования, время сборки полного датасета `planet.osm` и подводные камни, будем собирать OSM по отдельным регионам: по континентам, странам. Список регионов может не совпадать с регионами `ymapsdf`.

В дальнейшем возможны 2 сценария:
- либо мы процессим целиком `planet.osm` в одном билде `osm_src`, в одном билде `ymapsdf_src` и т.д.;
- либо будем процессить отдельные регионы в отдельных билдах и далее склеивать их в модулях `renderer_*_osm`, `road_graph_*_osm`, `geocoder_*_osm`.

## Конвертация OSM в YT-таблицы

Есть тул [osm_to_yt](https://a.yandex-team.ru/arc/trunk/arcadia/maps/tools/osm_to_yt), который парсит OSM в protobuf-формате и заливает в YT-таблицы:

- nodes
- nodes_tags
- ways
- ways_nodes
- ways_tags
- relations
- relations_members
- relations_tags

Для ускорения записи данных в YT используется свой [protobuf-формат](https://a.yandex-team.ru/arc/trunk/arcadia/maps/libs/road_graph_osm_to_ymapsdf/proto/osm.proto). [Документация](https://yt.yandex-team.ru/docs/api/c++/protobuf) про protobuf в YT.

В Огороде будет создан source-модуль `osm_src`, который будет через биндинг вызывать код тула osm_to_yt.

На выходе модуля будет 8 огородных ресурсов с типом `YtTableResource`, которые будут хранить вышеуказанные таблицы.

В Кипарисе таблицы будут храниться по путям: `osm/{shipping_date}_{region}/{table_name}`.

На первом этапе в модуле может быть одна таска, которая вызывает тул osm_to_yt.

Далее нужно рассмотреть возможность заливать каждую отдельную таблицу своей таской.

Для ускорения записи можно использовать [ParallelUnorderedTableWriter](https://a.yandex-team.ru/arc/trunk/arcadia/mapreduce/yt/library/parallel_io/parallel_writer.h).

## Конвертация OSM из YT-таблиц в ymapsdf

В Огороде будет создан модуль `ymapsdf_osm`, который будет принимать на вход билд `osm_src` с данными OSM в виде YT-таблиц и порождать набор YT-таблиц в формате `ymapsdf`.

Выходные таблицы будут лежать по пути `ymapsdf_osm/{shipping_date}_{region}/{table_name}`.

Есть тул [road_graph_osm_to_ymapsdf](https://a.yandex-team.ru/arc/trunk/arcadia/maps/libs/road_graph_osm_to_ymapsdf), который конвертирует OSM в подмножество ymapsdf.

На первом этапе `ymapsdf_osm` будет вызывать тул `road_graph_osm_to_ymapsdf` через биндинг. Далее будут добавлены таски для создания недостающих таблиц `ymapsdf`.

### Схема данных

Сложность разработки модуля `ymapsdf` в том, что он не владеет схемой данных. Схема приезжает снаружи - вместе с экспортом из НЯК. Т.е. при разработке новых тасок в модуле `ymapsdf` нужно поддерживать обратную совместимость: чтобы новые таски могли работать со старой схемой и наоборот.

В новом модуле `ymapsdf_osm` такой проблемы нет. Мы можем зашить схему данных в json-формате прямо в бинарник огородного модуля при его сборке.

Актуальная схема данных лежит [здесь](https://a.yandex-team.ru/arc_vcs/maps/doc/schemas/ymapsdf/garden/json?rev=trunk).

Таблицы-словари (`ft_type`, `source_type` и другие) придётся предварительно сконвертировать из SQL в json.

Для ускорения записи в таблицы мы можем сконвертировать схему `ymapsdf` в формат `protobuf`. [Документация](https://yt.yandex-team.ru/docs/api/c++/protobuf) про protobuf в YT.

### Переиспользование кода

Из модуля `ymapsdf` мы можем переиспользовать таски:
- проверку констрейнтов на выходных таблицах;
- проверку внешних ключей на выходных таблицах;
- группу тасок по сборке геометрии для таблиц `ad_geom`, `bld_geom`, `ft_geom`, `rd_geom`;
- группу тасок по вычислению таблиц `bld_addr`, `ft_addr`;
- группу тасок по вычислению iso-кодов (?);
- группу тасок по вычислению связей `ft_ad` (?);

 TO BE CONTINUED
