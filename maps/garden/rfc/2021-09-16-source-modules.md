# Усовершенствование source-модулей

Текущая документация: https://docs.yandex-team.ru/garden/scan_resources

## Текущее положение дел

Огородные таски принимают на вход ресурсы и производят ресурсы.

Изначальные ресурсы приходят в Огород снаружи. Где-то за пределами Огорода есть генераторы данных, которые создают таблицы в YT, файлы в Сендбоксе или в других системах.

Такие внешние датасеты нужно уметь регистрировать в Огороде и триггерить пайплайн обработки данных в Огороде.

Для этого существуют source-модули:

* source-модуль объявляет начальные ресурсы в графе тасок - ресурсы, которые не создаются ни одной таской;
* source-модуль может иметь таски, а может не иметь;
* билды source-модуля нельзя создать через UI;
* билды source-модуля можно создать либо через POST-запрос в API-Огорода, либо через механизм сканирования ресурсов.

Если генератор данных знает про Огород, он может послать POST-запрос по готовности новой версии датасета, чтобы зарегистрировать её в Огороде.

Если генератор данных не знает про Огород, то Огород может периодически (раз в 15 мин) вызывать в огородном модуле функцию `scan_resources`, которая опрашивает внешние источники данных на предмет появления новых версий.

## Имеющиеся проблемы

Существующие source-модули работают достаточно надёжно в продакшене.

Проблемы связаны с разработкой и тестированием модулей, когда нужно создать новый модуль или модифицировать поведение старого модуля.

### Перезапуск сканирования ресурсов

Существует механизм "внешних ключей" (название заимствовано из реляционных СУБД, но к ним никакого отношения не имеет).
Внешний ключ - это уникальный идентификатор датасета в терминах внешнего хранилища данных. Например, для Сендбокса это resource_id.

Внешние ключи призваны не допустить запуск в Огороде билдов со старыми данными. Работает это так:

* В Монге в коллекции `registered_sources` хранятся все внешние ключи, которые прошли через Огород с начала времён.
* В POST-запросе на запуск билда source-модуля указывается внешний ключ. Билд будет создан, только если такого внешнего ключа ещё нет в Монге.
* Аналогично для сканирования ресурсов: билды создаются только для тех датасетов, внешние ключи которых ещё отсутсвуют в Монге.

Проблемный сценарий:

* пользователь создаёт дев-контур, заливает туда свой модуль и запускает сканирование ресурсов;
* создаются билды, а внешние ключи записываются в Монгу;
* пользователь видит, что билды созданы неправильно (ошибка в имени ресурса, ошибка в свойствах билда и т.д.);
* пользователь исправляет модуль, заливает в дев-контур и запускает повторное сканирование ресурсов;

Ожидание: будут созданы новые исправленные билды.

Реальность: новые билды не создаются.

### Перезапуск тасок

source-модули могут иметь таски, которые принимают на вход начальные ресурсы.

Проблемный сценарий:

* пользователь создаёт дев-контур, заливает туда свой модуль и запускает сканирование ресурсов;
* создаются билды, в билдах запускаются таски;
* пользователь видит, что таски отработали неправильно;
* пользователь исправляет модуль, заливает в дев-контур;

Ожидание: пользователь удаляет билд и запускает его заново с новой версией модуля.

Реальность: пользователь удаляет билд, но кнопки запуска нет.

### suppress_known_source_check

В [документации](https://docs.yandex-team.ru/garden/scan_resources) описан флажок `suppress_known_source_check`, который можно указать при ручном запуске сканирования ресурсов через API.

Этот флажок только добавляет путаницы. Не ясно, в каких кейсах он нужен, а в каких нет.

При использовании этого флажка для вообще всех датасетов создаются новые билды, что может быть нежелательно.

### Неочевидное время жизни билдов

Интуитивно кажется, что каждому внешнему датасету должна соответствовать строчка в UI Огорода на странице билда.

Но сейчас это не так:
* количество строчек в UI контролируется 2 независимыми настройками:
  * сканером ресурсов, который ходит во внешний источник данных с каким-то лимитом;
  * параметром `build_limits` в трейтах модуля;
* некоторые строчки могут отсутствовать, если пользователь удалил билд вручную.

## Предлагаемое решение. Этап 1

### Запуск билдов

Не нужно создавать билды на каждый датасет, найденный при сканировании ресурсов. Нужно создавать билд только на самый последний датасет в порядке сортировки.

Если при сканировании ресурсов найдено 3 свежих датасета, то нужно создать только один билд.

Для модулей с группировкой по регионам нужно создавать по одному билду на каждый регион.

Этот пункт позволит решить проблему с запуском в Огороде старых версий датасетов, и коллекция `registered_sources` в Монге станет не нужна.

Этот пункт порождает проблему сортировки: где должна задаваться сортировка? Какой датасет считать последнем? В каком порядке сканер ресурсов должен посылать датасеты в Огород: от старых к новым или от новых к старым?

Ответ на последний вопрос: в любом порядке. Чтобы упростить написание огородных модулей, разработчик модуля не должен помнить этот порядок, не должен бояться ошибиться с порядком.

Далее есть 2 варианта:
* Сканер ресурсов посылает в Огород список датасетов в любом порядке + в отдельном поле посылает датасет, из которого нужно запустить билд. Для этого сканер ресурсов должен сначала посортировать все датасеты.
* Сканер ресурсов посылает в Огород список датасетов в любом порядке. Далее Огород сам выбирает последний датасет на основе трейтов модуля. Пример: если в трейтах указано `"sort_options": "shipping_date"`, то берётся датасет с максимальным `shipping_date`. и из него строится билд.

Плюсы варианта 1:
* вся логика сосредоточена в сканере ресурсов, в Огороде логика упрощается;

Плюсы варианта 2:
* сканер ресурсов более простой - он посылает только список билдов и ничего лишнего;
* сортировка задаётся явно декларативно в трейтах - её не нужно выискивать в коде;
* сортировка из трейтов используется как для выбора свежайшего датасета, так и для показа билдов в UI.

### Внешние ключи

Как было описано выше, коллекция `registered_sources` становится не нужна.

Но внешние ключи остаются полезными для избежания дубликатов билдов.

В коллекции `builds` у билдов source-модулей нужно хранить внешние ключи, из которых они были собраны.

При попытке запуска нового билда нужно проверить внешний ключ датасета с имеющимися в коллекции `builds`.

### "Виртуальные билды"

Как было написано выше, билды создаются не из всех датасетов, которые прислал сканер ресурсов.

Но в UI хочется видеть полный набор датасетов, который пришёл из последнего запуска сканера ресурсов.

Это можно условно назвать "виртуальный билд", и хранить их в отдельной коллекции.

Когда отрабатывает сканер ресурсов и присылает датасеты в Огород, то список "виртуальных билдов" перестраивается.

"Виртуальные билды" нужно отдавать в ручке `/pages/<module_name>` для показа в UI.

В итоге, страницы source-модулей будут похожи на страницы map-модулей:

* вверху страницы список билдов;
* внизу страницы список виртуальных билдов, из которых ещё не был построен ни один билд.

Как это решает проблемы пользователей:
* разработчик модуля может поменять код сканирования ресурсов, перезапустить его и уведеть в UI изменения - новый список виртуальных билдов;
* разработчик модуля может удалить любой билд и запустить новый билд на новой версии модуля на базе старого виртуального билда.

## Предлагаемое решение. Этап 2 (идея на далекое будущее)

Сейчас, чтобы подключить в Огород новый внешний источник данных, нужно создать отдельный source-модуль.

Проблемы:

* единоразово нужно написать тучу бойлерплейт кода и не ошибиться нигде - 10 файлов и 4 папки;
* регулярно тратить время на поддержку модуля - выкатывать в тестинг и стейбл через Sedem;
* сложно читать код и понимать, что делает модуль, т.к. для этого нужно просматривать глазами 10 файлов.

Интуитивно кажется, что подключение нового внешнего источника данных должно быть простой задачей.

Предлагается отказаться от модулей без тасок, от модулей которые содержат только объявления начальных ресурсов.

Сканеры ресурсов можно подселить в другие модули. Даже несколько сканеров в один модуль.

Пример: модуль `ymapsdf` использует 3 модуля без тасок: `ymapsd_src`, `yellow_zones_bundle`, `flats_bundle`. Все 3 сканера ресурсов можно убрать в один модуль `ymapsdf`.

```python
def scan_ymapsdf_src(environment_settings):
    return ...


def scan_yellow_zones_bundle(environment_settings):
    return ...


def scan_flats_bundle(environment_settings):
    return ...


def main():
    run_module(
        "ymapsdf",
        fill_graph=ymapsdf.fill_graph,
        handle_build_status=map_starters.start_with_last_configs,
        scan_resources={
            "ymapsdf_src": scan_ymapsdf_src,
            "yellow_zones_bundle": scan_yellow_zones_bundle,
            "flats_bundle": scan_flats_bundle,
        }
    )
```

Каждый сканер ресурсов при этом может иметь свою страницу в UI Огорода, на которой выводится список "виртуальных билдов", т.е. датасетов, полученных из этого сканера.
