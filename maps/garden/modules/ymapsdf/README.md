# ymapsdf

## Инструкция для дежурных

Страница в Огороде: https://garden.maps.yandex-team.ru/stable/ymapsdf

### Проверка `latest_build_status`

Проверка `latest_build_status` может загораться по разным причинам.
Разные регионы проверяются по отдельности.

#### Билд долго находится в состоянии COMPLETED

Нужно сравнить значения `Shipment date` разных регионов.

Если они все одинаковые, то возможны 2 варианта:
* сломался или не запускался экспорт из НЯК
* сломался тул `scan-datastorage`.

Если хватает знаний, то можно зайти в https://mpro.maps.yandex.ru/ и проверить наличие свежих экспортов.
Если свежих экспортов нет, то поставить даунтайм до утра.

Если `Shipment date` у разных регионов отличается, то вероятно
один из регионов временно не выгружается из Народной карты. Нужно поставить даунтайм до утра.

#### Билд долго находится в состоянии IN_PROGRESS

Нажать кнопку рестарта у билда и подождать 5-10 минут.
Если билд не завершился за это время, то звонить ответственному.

#### Билд находится в состоянии FAILED

Если в тексте ошибки есть фраза `Memory limit exceeded` или `Row weight is too large`, нужно действовать в соответствии с [общей инструкцией](https://docs.yandex-team.ru/garden/module-duty#rasprostranyonnye-tipy-oshibok).

Иначе: нажать кнопку рестарта у билда и подождать 5-10 минут.
Если билд не завершился за это время, то звонить ответственному.

Более подробная информация по некоторым ошибкам ниже в разделе `ymapsdf_tester`.

### Проверка `autotests_failed`

**В контуре stable дежурство по данному алерту осуществляется abc-сервисом maps-duty-content.
Огородному дежурному ДТ ставить не нужно.**

Все ошибки делятся на 2 типа:
1) Из Народной карты пришла плохая геометрия. В тексте ошибки будет указан id плохого объекта.

**Что делать**: поправить ошибку в НЯК в релизной ветке и перезапустить экспорт, а билд в Огороде удалить.

2) Сильно изменилось число строк в таблицах `ymapsdf` по сравнению с вчерашним `ymapsdf`.

Возможные причины:
- либо было массовое удаление объектов в НЯК, либо массовая заливка новых объектов;
- либо изменилось число POI, которые подливаются из Справочника через `extra_poi_bundle`;
- либо баг в коде.

**Что делать**:
- если какая-то таблица полностью обнулилась - скорее всего баг в коде и нужно звонить [Александру Бобкову](https://staff.yandex-team.ru/alexbobkov);
- если в тексте ошибки указан большой `extra poi diff`, то скорее всего проблема в `extra_poi_bundle` и нужно звонить [дежурным команды качества сервисов](https://abc.yandex-team.ru/services/maps-duty-geo-quality/duty/);
- проверить релизы экспорт-воркера `ya tool sedem release info maps/wikimap/mapspro/services/tasks_export`;
- иначе проблема скорее всего в данных из НЯК.

Если выяснилось, что срабатывание ложное, то нужно в UI Огорода нажать на кнопку `view logs` рядом с билдом, и на открывшейся странице с описанием ошибки нажать на кнопку **Ignore**.

По сложным вопросам можно писать в [чат публикации релизов](https://t.me/joinchat/AAAAAEgBMOVqP7moS2Q-hQ), но быстрый ответ там не гарантирован.

#### Статистика автотестов для разработчиков

Как сбросить статистику автотестов `ymapsdf`:
1) Открыть [папку](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/core/garden/prod/ymapsdf/statistics/rows) в Кипарисе.
2) Пройтись по подпапкам и удалить из всех подпапок файлы `<region>.json`, где `<region>` - имя региона того билда, для которого сработали автотесты.

## `ymapsdf_load`

Загружает данные из Народной карты в YT-таблицы

## `merge_ext`
Подливает новые данные, импортированные на промежуточных этапах `merge_stops`, `merge_yellow_zones`, `merge_ft_experiment` и `merge_flats`
к таблицам: `ft`, `ft_face`, `face`, `face_edge`, `edge`, `entrance_flat_range`, `node`, `ft_nm`, `ft_center`, `ft_source`, `ft_experiment`.

## `merge_yellow_zones`

Импортирует "желтые зоны" из [директории](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/yellow_zones/export_data&). Используются только те зоны, которые по географии попадают в регион билда YMapsDF.

Сохраняет добавочные записи к таблицам: `ft`, `ft_face`, `face`, `face_edge`, `edge`, `node`.

## `merge_stops`

Импортирует остановки общественного транспорта из данных GTFS. Используются только те данные, которые по географии попадают в регион билда YMapsDF.
Сохраняет добавочные записи к таблицам: `ft`, `ft_nm`, `ft_center`, `ft_source`, `node`.

Сопоставляет железнодорожные станции и причалы из данных GTFS с данными из Народной карты.
Связи сохраняются как новые записи к таблице `ft_source`.

## `merge_flats`

Импортирует информацию о квартирах из [директории](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/flats/export_data).
Используются только те квартиры, которые попадают в регион билда YMapsDF.

Добавляет записи к таблицам: `entrance_flat_range`.

## `merge_poi`

Объединяет данные о POI из НЯК со Справочником.

### `merge_ft_experiment`
Запускается только при наличии таблицы с экспериментами в текущей директории [extra_poi_bundle](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/extra_poi_bundle/stable_v2&),
которая импортируется как опциональный ресурс `extra_poi_experiments` в модуле `extra_poi_bundle`.
Если исходной таблицы нет, то `merge_ft_experiment` не производит никаких ресурсов.

Из таблицы ресурса `extra_poi_experiments` данные заливаются в ymapsdf таблицу `ft_experiment`, заменяя идентификатор `id` (пермалинк в Справочнике) на соответствующий `ft_id`.
Для всех точечных объектов вида POI, которые не попали в `extra_poi_experiments`, данные берутся как есть из таблицы `ft`.


### Postprocessing в экспериментах (ft_experiment) и продакшн-таблицах (ft)

Внутри модуля `merge_poi` рядом с логикой `merge_ft_experiment` есть возможность зарегистрировать `POSTPROCESSING` эксперимент - таск,
который видоизменяет таблицу `ft`, делая из нее еще один эксперимент в ft_experiments. Как правило это таск
с yql-преобразованиями.

Если эксперимент признается успешным, то такое преобразование регистрируется как `PRODUCTION` в маппине
[POSTPROCESSING](https://a.yandex-team.ru/arcadia/maps/garden/modules/ymapsdf/lib/merge_poi/custom_transformations.py)
для определенного списка регионов. После этого production-преобразование всегда применяется к таблице `ft`
перед экспортом из `ymapsdf` а также ко всем экспериментам  из `ft_experiment`, если их имена не начинаются с
`postprocessing_` (то есть сами не получены из таких преобразований)

О том, как технически проводить такие эксперименты, написано [тут](https://a.yandex-team.ru/arcadia/maps/garden/modules/ymapsdf/lib/merge_poi/yql/README.md)


### Экспорт НЯК

Приходит в таблицах: `ft`, `ft_nm`, `ft_source`, `ft_center`, `node`.

Каждый POI имеет:
* уникальный идентификатор `ft_id`
* дисплей класс (в таблице `ft`)
* набор имён (в таблице `ft_nm`)
* набор связей с внешними сущностями, в том числе со Справочником (в таблице `ft_source`)
* координаты (в таблицах `ft_center` и `node`)

### Экспорт Справочника

Лежит в [директории](https://yt.yandex-team.ru/hahn/navigation?path=//home/altay/db/export&).

Каждая организация в Справочнике имеет уникальный идентификатор `source_id`, он же "пермалинк".

Модуль `altay` в Огороде обрабатывает сырые данные Справочника и выдаёт 6 таблиц, которые поступают на вход `merge_poi`.

* `altay_companies` - общая информация об организациях Справочника: координаты, иконка, рубрика, закрыта или нет.
* `altay_names` - имена организаций.
* `altay_duplicates` - информация об организациях-дублях `source_id` -> `head_source_id`.
* `altay_references` - привязка `ft_id` -> `source_id`.
* `altay_companies_unknown` - список `ft_id` которые в НЯК ссылаются на организации, удалённые из Справочника.
* `altay_rubrics` - словарь рубрик.

Справочник может посчитать несколько организаций дублями и одну из них назначить головной.
В таблице `altay_duplicates` хранится связь между дублями и головой.

В Справочник приходит экспорт POI из НЯК в обход Огорода. Справочник может связать POI из НЯК (`ft_id`) с организациями (`source_id`). Эта связь хранится в таблице `altay_references`.

Справочник может забраковать некоторые POI из НЯК: посчитать, что они привязаны к удалённым из Справочника организациям. Список таких `ft_id` хранится в таблице `altay_companies_unknown`.

Подготовленные таблицы хранятся в [директории](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/core/garden/prod/altay&)

### extra_poi_bundle

Данные из Справочника не используются для создания новых POI напрямую.
Отдельно от Огорода существует процесс, который выбирает подмножество данных Справочника для добавления в `ymapsdf`.

Этот набор данных называется [extra_poi_bundle](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/extra_poi_bundle/stable_v2&). Каждый день создаются 2 таблицы:
* в таблице `data` содержатся:
  * данные о новых POI для добавления в `ymapsdf`
  * информация для обновления дисплей-классов (display_class) для существющих POI, которая влияет на появление POI на разных масштабах карты.
  * признак, что POI относится к геопродукту.
* в таблице `experiments` содержатся альтернативные дисплей-классы для проведения АБ-экспериментов.

Каждый POI изначально связан со Справочником и имеет идентификатор из Справочника - пермалинк.

Во время работы стадии `merge_poi` эти данные предварительно обрабатываются.

1. Все POI, которые лежат внутри границ региона `ymapsdf`, копируются в таблицу `extra_poi_filtered_by_region`. Остальные отбрасываются.

2. Далее происходит замена пермалинков-дубликатов на головные (по данным таблицы `altay_duplicates`) и определение возможной связи с существующими POI в НЯК (по данным таблицы `altay_references`).
Результат записывается в таблицу `extra_poi_with_altay_heads`.

3. Далее эта таблица режется на несколько отдельных временных таблиц:

    * `extra_poi_update_tmp` - POI, которые уже есть в НЯК. У них нужно обновить дисплей класс.
    * `extra_poi_tmp` - новые POI, которых нет в НЯК. Их нужно добавить в таблицы `ft`/`node`/`ft_center`.
    * `extra_poi_names_tmp` - имена для новых POI. Их нужно добавить в таблицу `ft_nm`.
    * `extra_poi_geoproduct_tmp` - ссылки на организации, на которые заказан геопродукт, вместе с флагами `is_protected` и `is_recently_protected`.

### Категории POI

В таблице `ft` в регионе cis1 ~27 миллинов строк. Только ~5.5 миллионов являются точечными объектами - POI.

К разным категориям POI применяются разные правила объединения со Справочником.

* Защищённые POI - определяются по списку [ft_type_id](https://a.yandex-team.ru/arc_vcs/maps/garden/modules/ymapsdf/lib/merge_poi/data/merge_poi.json).
* Платные парковки - POI с `ft_type_id=2010`.
* Индор POI - есть связь с этажом схемы помещения через поле `p_ft_id`.

Эти категории могут пересекаться. Для удобства можно ввести категорию "особые POI" - это защищённые за вычетом платных парковок и индор POI.

Правила объединения данных в одной таблице:

тип объектов | статус закрытия | пермалинк | координаты | имена | рубрика | иконка | disp_class
:--- | :--- | :--- | :--- | :--- | :--- | :--- | :---
платная парковка | не закрывается      | из НЯК         | из НЯК         | из НЯК         | из НЯК         | из Справочника | из НЯК
индор POI        | закрываются         | из НЯК         | из НЯК         | из Справочника | из НЯК         | из Справочника | из extra_poi
особые POI       | не закрывается      | из Справочника | из НЯК         | из НЯК         | из НЯК         | из Справочника | из extra_poi
все остальные    | закрываются         | из Справочника | из Справочника | из Справочника | из Справочника | из Справочника | из extra_poi

Принадлежность POI к разным категориям вычисляется заранее и записывается во временную таблицу `ft_metadata_tmp`.

### Связь НЯК и Справочника

Первый шаг в объединении данных - установить связь между POI в НЯК и организациями в Справочнике (`ft_id` <-> `source_id`).

Эта связь попадает в Огород из 2х источников:
* из НЯК через таблицу `ft_source`
* из Справочника через таблицу `altay_references`.

Для платных парковок и индор POI пермалинк берётся из НЯК, для остальных - из Справочинка.

Финальная связь записывается во временную таблицу `ft_permalink_tmp`.

### Объединение данных

Зная связь `ft_id` <-> `source_id`, из таблиц `altay_companies`, `altay_names` подтягиваются координаты, имена, рубрики, иконки для POI. Значения записываются в 2 промежуточные таблицы `ft_altay_companies_tmp` и `ft_altay_names_tmp`.

Некоторые организации могут быть помечены надёжно закрытыми в Справочнике. В этом случае они удаляются из всех таблиц: `ft`, `ft_nm`, `ft_source`, `ft_center`, `node`.

#### Таблица `ft`

Значения рубрик и иконок берутся из Справочника согласно таблице выше.

Значения дисплей классов берутся из таблицы `extra_poi_update_tmp` для всех POI, кроме парков и платных парковок.
Для POI, которые были добавлены в НЯК из `extra_poi`, применяется особое правило для дисплей-классов.

К таблице добавлются новые POI из `extra_poi_tmp`.

#### Таблица `ft_nm`

Для каждого POI для каждого языка имя для подписи берётся из Справочника.

К таблице добавлются имена новых POI из `extra_poi_names_tmp`.

#### Таблица `ft_source`

Все старые связи со Справочником удаляются из таблицы. Добавляются финальные связи из таблицы `ft_permalink_tmp`.

Добавляются связи с `extra_poi` и с геопродуктом.

#### Таблица `ft_center`

К таблице добавлются новые POI из `extra_poi_tmp`.

#### Таблица `node`

Значения координат берутся из Справочника согласно таблице выше, кроме координат "проверенных" POI.

"Проверенные" POI - это геопродуктовые POI и соседние с ними, которые вручную размещаются картографами в НЯК.
Они хранятся в [директории](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/core/garden/prod/ymapsdf/statistics/verified_position_poi).

К таблице добавлются новые POI из `extra_poi_tmp`.

#### Таблица `ft_rubric`

Таблица-словарь. Она просто копируется из `altay_rubrics`.

## `geometry_collector`

Преобразует геометрию объектов.

### Этапы

Строится геометрия для каждого объекта из таблиц

* `ad`
* `bld`
* `ft`
* `rd`

На каждом этапе проверяется, что каждому объекту соответствует какая-то геометрия.

### bld_geom

Создаёт полигональную геометрию для зданий.

Потребляет таблицы:

* `bld`
* `bld_face`
* `edge`
* `face_edge`

Создаёт таблицы:

* `bld_geom`

### `ft_geom`

Создаёт полигональную геометрию для объектов из таблицы `ft`.

Создаёт линейное представление для объектов из таблицы `ft`.

Для объектов, у которых есть связь в таблице `face_edge`, строится полигональная геометрия.

Если такой связи нет, то для объектов, у которых есть связь в таблице `ft_edge`, строится линейное представление.

Если и такой связи нет, то в качестве геометрии берётся центр из таблицы `ft_center`.

Потребляет таблицы:

* `edge`
* `face_edge`
* `ft`
* `ft_center`
* `ft_edge`
* `ft_face`
* `node`

Создаёт таблицы:

* `ft_geom`

### `rd_geom`

Создаёт линейную геометрию для объектов из таблицы rd.

Потребляет таблицы:

* `rd`
* `rd_rd_el`
* `rd_el`

Создаёт таблицы:

* `rd_geom`

Геометрия для объектов из таблицы `rd` лежит в таблице `rd_el`, связанная через `rd_rd_el`.

### `ad_geom`

Создаёт полигональную геометрию для объектов из таблицы `ad`.

Потребляет таблицы:

* `ad`
* `ad_center`
* `ad_face`
* `ad_face_patch`
* `edge`
* `face_edge`
* `node`

Создаёт таблицы:

* `ad_geom`

Для объектов из таблицы `ad`, не имеющих `g_ad_id`, создаётся полигональная геометрия как есть и пишется в таблицу `ad_geom_general`.

Если объект имеет `g_ad_id`, значит, он является спорной территорией.

В таблице `ad_face_patch` находится список спорных территорий с их геометрией и с флагом `is_excluded`.

Для них полигональная геометрия строится отдельно и заносится в таблицу `ad_geom_disputed_area`.

Для объекта, на который указывает `g_ad_id`, строится геометрия так:

Берётся геометрия из `ad_geom_general`, из неё удаляется территория из таблицы `ad_geom_disputed_area`, если флаг `is_excluded = false`, иначе территория добавляется к генеральной геометрии.

В общем виде логика со спорными территориями выглядит так:

1. если у объекта нет `g_ad_id`, то это не спорная территория, его геометрия будет в генеральной геометрии
2. если у объекта есть `g_ad_id`, то он использует геометрию из генеральной геометрии от объекта с `ad_id = g_ad_id`

  * 2a. если у объекта есть запись в таблице `ad_face_patch` и `is_excluded = true`, то шейп из той таблицы вычтется из шейпа из генеральной геометрии
  * 2b. если у объекта есть запись в таблице `ad_face_patch` и `is_excluded = false`, то шейп из той таблицы добавится  к шейпу из генеральной геометрии

Пункты 2a и 2b - опциональны, может быть только один из них, или их не быть вовсе.

### Центры объектов

Расчитывает центры для геометрии объектов

Потребляет таблицы:

* `ad_center`
* `ad_geom`
* `bld_center`
* `bld_geom`
* `ft_center`
* `ft_geom`
* `rd_center`
* `rd_geom`

Изменяет таблицы:

* `ad_center`
* `bld_center`
* `ft_center`
* `rd_center`
* `node`

Центры расчитываются для объектов, для которых нет центров, импортированных из НЯКа.

Центры добавляются в таблицу node как новые объекты.

## `parent_finder`

Используя геометрию, собранную в `geometry_collector` определяет значение поля `isocode` для различных объектов. В процессе строится `YtFileResource`, содержащий [coverage5](https://a.yandex-team.ru/arc_vcs/maps/libs/coverage) для `ad` с `level_kind = 1` (страны). В поле `metadata` соответствующего региона записывается `isocode` соответствующей единицы `ad`.

Существенно обновляет следующие таблицы:

### `ad`

Простой случай: вся информация уже присутствует в `ymapsdf` в виде древовидной иерархии объектов (потомки ссылаются на родителей при помощи поля `p_ad_id`).

Никаких геометрических вычислений не выполняется.

### `bld`

Для каждого здания из таблицы `bld` берётся его геометрия из таблицы `bld_geom` (это делается при помощи `reduce`-операции). Для этой геометрии вычисляется центроид (центр масс полигона). Для центроида делается запрос в coverage, результат этого запроса записывается в поле `isocode` выходной таблицы.

У комплексов зданий нет геометрии в таблице `bld_geom`, поэтому они получают исокод `001`.

### `bld_addr`

1. Все здания распределяются по тайловой сетке. Каждое здание может попасть сразу в несколько тайлов.
2. Для каждого тайла берутся все дома в нём и все адресные точки:
  * для каждого адреса берётся ближайшее к нему здание в пределах 6 метров (или несколько зданий, накрывающих адрес);
  * для каждого здания без адреса берутся соседние к нему здания в пределах 3 метров.
3. Привязка адресных точек к зданиям распространяется на соседние здания.

### `ft_ad`

Работа модуля делится на два этапа:

1. С помощью coverage для каждого `ft` по его геометрии находит такой `ad`, в котором он расположен.
   В случае (мульти-)линии/полигона — достаточно, чтобы 90% длины/площади располагалось внутри `ad`.
   Результат работы этого этапа поступает на вход в таску модификации таблицы `ft`

2. Полученные связи `ft_ad` нужно протянуть вверх по иерархии `ad` до определенного `level_kind`.
   В момент написания он равен 4 (населённый пункт).
   В случае, если при протаскивании вверх по иерархии возникают коллизии имён в геокодере
   (например, "река Чёрная" встречается в cis1 более тысячи раз), то необходимо связать `ft` с максимально
   возможным `ad`, при котором эти `ft` находятся в разных `ad`.

   **Примечание**. `ft` аэропортов обрабатываются отдельно (TODO разобраться будущим поколениям,
   почему отличается логика обработки):
   - `level_kind` = 3
   - если `ad` с таким `level_kind` не существует (например, после 4 сразу идёт 2), то необходимо выбрать 2

### `rd_el`

Для каждого элемента делается три запроса в coverage: для начала, конца и геометрической середины (вычисляется в нативных координатах ребра — долготе и широте). В качестве результирующего `isocode` выбирается медиана из трёх значений.

### `rd`

Выбирается наиболее часто встречающийся `isocode` среди соответствующих `rd_el` (соответствие определяется по таблице `rd_rd_el`).

### `addr_range`

Проставляет `isocode` на базе `rd_el`, если он отсутствует. Также удаляет из таблицы те данные, которые ссылаются на несуществующий `rd_el`.

Примечание: таблица используется очень редко. На момент написания этого текста она непустая только в регионе eu1, но и там всего лишь 8900 строк. Однако выпиливать эту таблицу нельзя -- она используется картографами на крайний случай, когда адреса привязать совсем не к чему.

### `ft`

Работа модуля делится на 2 этапа:

1. Для определенных `ft_type_id` проставляет `search_class` в значение 10 (игнорирование при поиске в геокодере).
2. Проставляет `isocode` из аналогичного поля таблицы `ad` по связям в таблице `ft_ad`.

### `addr`

Проставляет `isocode` на базе таблиц в следующем приоритном порядке: `rd`, `ft`, `ad`.

### `ft_addr`
Подливает в исходную таблицу `ft_addr` связи с адресными точками, соответствующие ближайщим зданиям.
Найденные связи добавляются независимо для разных значений `role`:
1. Для `role == 3` записываются все найденные связи для `ft` точек с ft type `URBAN_ENTRANCE`.

2. Для `role == 1` записываются связи для любых ft type, но с разрешением конфликтов при нахождении
множественных связей для одного `ft_id`. При конфликте выбираются адресные точки в таком предпочтительном порядке:
  * найденные здания являются отдельностоящими или частями комплекса зданий
  * расстояние между `ft` и `addr` точками минимально.

## `translation`

Потребляет таблицы:

* `ad`
* `ft`
* `rd`

Изменяет таблицы:

* `ad_nm`
* `ft_nm`
* `rd_nm`

У модуля две функции:

1. Расстановка флагов `is_local` для тех названий, объекты которых не имеют локальных названий, но язык названия является официальным (местным) для страны, в которой находится объект.
2. Выполнение переводов (осуществляется только в том случае, если нет соответствующего перевода):
    1. Русские и украинские названия транслитерировать в латиницу
    2. Локальные нерусские названия транскрибировать на русский (по сути -- та же транслитерация, только наоборот). Выполняется скриптами на perl

## `filter_flats`

Потребляет таблицы:

* `entrance_flat_range`
* `entrance_level_flat_range`
* `ft_addr`

Изменяет таблицы:

* `entrance_flat_range`
* `entrance_level_flat_range`

Модуль фильтрует или изменяет диапазоны квартир в подъездах или этажах, пришедшие из НЯКа и [экспорта](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/flats):

1. Фильтруются подъезды, которые не привязаны к адресам из `ft_addr` (роль `1` или `3`).
2. Подъезд может быть привязан к одному или нескольким адресам. Для каждого адреса нужно независимо разрешить следующие конфликты:
* Неточные диапазоны квартир (рассчитанные или взятые из логов) не должны пересекаться с точными (выставленными вручную), в местах пересечения неточные диапазоны "обрезаются", что может приводить как к удалению неточного диапазона, так и разбиению на несколько неточных.
* Неточные диапазоны не должны пересекаться между собой, для этого используется эвристика, которая отдает при конфликте отдает приоритет более длинному диапазону. Короткие диапазоны в этом случае так же могут стать еще короче или исчезнуть.
3. Для каждого подъезда/этажа берется **пересечение** диапазонов, пришедших из каждого адреса по результатам п.2. Это гарантирует отсутствие конфликтов внутри всех адресов, к которому привязан данный подъезд.
4. Конфликты среди точных диапазонов не решаются, они отдаются как есть с сохранением идентификаторов рейнджей. За качество точных диапазонов ответственны поставщики Народной карты. У неточных диапазонов идентификаторы будут перенумерованы, так как они могут быть не только отфильтрованы/изменены, но и могут появиться новые.
5. Дополнительно если между двумя точными диапазонами в одном и том же подъезде
нет пропусков (например, `[1, 4]` и `[5, 100]`), то они будут склеены в один
диапазон (`[1, 100]`). Это нужно для того, чтоб на картах для пользователей
точные диапазоны показывались как можно более красиво.

## `ymapsdf_tester`

Проверяет экспортируемые ymapsdf таблицы на:

1. [`row_statistics`](https://a.yandex-team.ru/arc_vcs/maps/garden/modules/ymapsdf/lib/ymapsdf_tester/row_statistics.py) — аномальное изменение количества записей по сравнению с предыдущим билдом. Для ft таблиц проверяются изменения количества записей для каждого значения ft_type.
2. [`constraints`](https://a.yandex-team.ru/arc_vcs/maps/garden/modules/ymapsdf/lib/ymapsdf_tester/constraints.py) — соответствие значений в таблицах констрейнтам.
3. [`foreign_keys`](https://a.yandex-team.ru/arc_vcs/maps/garden/modules/ymapsdf/lib/ymapsdf_tester/foreign_keys.py) — Наличие висячих внешних ключей.
4. [`ft_geom_conflicts`](https://a.yandex-team.ru/arc_vcs/maps/garden/modules/ymapsdf/lib/ymapsdf_tester/ft_geom_conflicts.py) — слишком большое количество конфликтов геопродуктовых ft_point-ов с остальными:
    1. В качестве сетки используется таблица ft_point_tiles из [`parent_finder`](#parent_finder), а данные о геопродуктовости берутся из ft_source. Все ft_point-ы дополнительно раскидываются по соседним тайлам, чтобы учесть ситуации, когда точка расположена слишком близко к границе.
    2. Делаем сортировку по координатам тайлов и флагам — является ли этот ft_point индорным или нет; является ли он геопродуктовым или нет. Сортировка по флагам гарантирует нам, что в дальнейшей reduce операции геопродуктвые ft_point-ы придут первыми и, если первый пришедший ft_point не является таковым, то следовательно мы можем пропустить тайл, а также то, что для индор организаций конфликты будут считаться только с другими индор организациями.
    3. Далее делаем reduce по координатам. Внутри каждой операции строится KD-дерево. Для каждого геопродуктового ft_point-а рассматриваются его ближайшие соседи — если сосед слишком близко, то мы помечаем ft_point как законфликтованный.

Данные из [`row_statistics`](https://a.yandex-team.ru/arc_vcs/maps/garden/modules/ymapsdf/lib/ymapsdf_tester/row_statistics.py) и [`ft_geom_conflicts`](https://a.yandex-team.ru/arc_vcs/maps/garden/modules/ymapsdf/lib/ymapsdf_tester/ft_geom_conflicts.py) далее отправляются в [репорт на Статфейсе](https://stat.yandex-team.ru/Maps.Wiki/Garden/ymapsdf_row_statistics?scale=d&_period_distance=30&tablepath_tree=%09cis1%09&_incl_fields=row_count&_incl_fields=geo_product_count&_incl_fields=conflicted_geo_product_count&_incl_fields=conflicted_geo_product_percentage).

На этапе `merge_poi` к данным `ymapsdf` подливаются новые пои из `extra_poi_bundle`.
Некоторые из этих поёв относятся к АБ-экспериментам и не должны показываться на основной подложке.
Поэтому они подливаются с `disp_class=10`.
Чтобы проверка количества поёв в `ymapsdf_tester` не флапала при изменении АБ-экспериментов,
пои с `disp_class=10` исключаются из подсчёта.

### Ошибка проверки констрейнтов CheckTableConstraints или внешних ключей CheckTableForeignKeys

Все констрейнты и внешние ключи для таблиц `ymapsdf` описаны в SQL-скриптах в Аркадии:
* [finalize](https://a.yandex-team.ru/arc_vcs/maps/doc/schemas/ymapsdf/garden/finalize);
* [integrity](https://a.yandex-team.ru/arc_vcs/maps/doc/schemas/ymapsdf/garden/integrity).

Сначала нужно проверить исходные данные из НЯК. Они лежат в alpha-стейдже в YT. В случае проблем в исходных данных нужно писать [Евклиду Никифорову](https://staff.yandex-team.ru/euclid).

Если с данными из НЯК всё хорошо, то нужно проверить таски в модуле `ymapsdf`, которые модифицируют таблицу с ошибкой.
