# indoor_radiomap

## Общее описание модуля

Reduce-модуль, который принимает на вход данные о восстановленных
радиомаяках (точки доступа wifi, ble-маяки, биконы) и таблицы `YMAPSDF` (по всем
регионам). Модуль выгружает из таблиц данные о схемах помещений торговых центров
и строит на их основе радиокарту торговых центров. Радиокарта ТЦ представляет
собой порезанные на тайлы данные о радиомаяках (местоположение, параметры силы
сигнала, принадлежность определенному этажу ТЦ), а также геометрию этажей (где
могут ходить люди и где осуществляется indoor-позиционирование).

## Автостарт модуля

Модуль стартует автоматически по завершении сборки config-модуля
`indoor_radiomap_bundle` с восстановленными маяками. При этом он берет последнюю
версию билдов `YMAPSDF` (для всех регионов) и последнюю версию билда
`indoor_radiomap_bundle`.

## Ресурсы модуля

### ugc_lbs_fuse_coefficient (динамическая таблица)

Динамическая таблица, содержащая информацию об оптимальных параметрах
(коэффициентах фьюзинга с LBS-решением) работы алгоритма позиционирования на
каждом этаже. Таблица используется как временное решение.

Полный путь таблицы в YT: [//home/maps/core/nmaps/dynamic/replica/indoor/ugc/ugc_lbs_fuse_coefficient](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/core/nmaps/dynamic/replica/indoor/ugc/ugc_lbs_fuse_coefficient)

Схема таблицы:

|  Тип    |       Название поля         |   Поле обязательно?
|---------|-----------------------------|-----------------------
| int64   | lbs_fuse_coefficient_id     | true
| utf8    | indoor_plan_id              | true
| utf8    | indoor_level_universal_id   | true
| double  | value                       | true

Колонки таблицы:
 * `lbs_fuse_coefficient_id` --- идентификатор записи в таблице;
 * `indoor_plan_id` --- идентификатор схемы помещений (из народной карты);
 * `indoor_level_universal_id` --- универсальный идентификатор этажа;
 * `value` --- значение параметра в диапазоне от 0.0 (использовать только indoor) до 1.0 (использовать только lbs).

### indoor_radiomap_transmitters (входной ресурс)

Представляет собой JSONL-файл, содержащий построчно информацию о восстановленных
маяках. Пример файла:

```
{"id":"00:00:AB:CD:66:EE","plan_id":"3417153246","level_id":"2","latitude":55.61009303,"longitude":37.71992118,"type":"ble","signal_model_parameter_a":-52.89420622,"signal_model_parameter_b":6.87892286}
{"id":"00:03:0f:75:1d:20","plan_id":"3417153246","level_id":"1","latitude":55.60955583,"longitude":37.72005872,"type":"wifi","signal_model_parameter_a":-30.38607264,"signal_model_parameter_b":11.55321472,"experimental": true}
```

Некоторые маяки могут содержать флаг `experimental`. Это означает, что они
являются экспериментальными и должны присутствовать только в экспериментальной
радиокарте и coverage.

### indoor_levels (промежуточный ресурс)

Таблица, строящаяся из `YMAPSDF`-таблиц `ft`, `ft_geom`, `ft_nm`. Содержит
информацию об этажах ТЦ --- идентификатор ТЦ, идентификатор этажа, геометрия
этажа.

Схема таблицы:

|          Название         |          Тип            |  Пример
|---------------------------|-------------------------|----------------------------------------
| ft_id                     | bigint                  | (ft_id соответствующей записи в ft)
| plan_id                   | bigint                  | (p_ft_id соответствующей записи в ft)
| level_id                  | text[]                  | '1' (универсальный идентификатор этажа)
| geometry                  | geometry(Geometry,4326) | MULTIPOLYGON(((...)))

Колонки таблицы:
 * `ft_id` --- идентификатор этажа в таблице `ft`;
 * `plan_id` --- идентификатор схемы помещений в таблице `ft` (совпадает с полем `p_ft_id` соответствующей записи в таблице `ft`);
 * `level_id` --- универсальный идентификатор этажа (получается из таблицы `ft_nm`, как имя этажа, соответствущее локали `zxx`);
 * `geometry` --- геометрия этажа (полигон или мультиполигон).

### indoor_barriers (промежуточный ресурс)

Таблица, строящаяся из `YMAPSDF`-таблиц `ft`, `ft_geom`. Содержит информацию
о "барьерах" --- зонах внутри ТЦ, где нельзя ходить или где мы не хотим
позиционироваться. К барьерам относятся следующие типы зон:
 * 2402 (`indoor-area-business`);
 * 2403 (`indoor-area-service`);
 * 2404 (`indoor-area-void`);
 * 2406 (`indoor-area-restricted`).

Схема таблицы:

|          Название         |          Тип            |  Пример
|---------------------------|-------------------------|--------------------------------------
| p_ft_id                   | bigint                  | (p_ft_id соответствующей записи в ft)
| geom                      | geometry(Geometry,4326) | POLYGON((...))

Колонки таблицы:
 * `p_ft_id` --- идентификатор этажа, где расположена зона (поле должно совпадать с полем `ft_id` в таблице `indoor_levels`);
 * `geom` --- геометрия зоны (полигон или мультиполигон).

### indoor_radiomap_levels (промежуточный ресурс)

JSONL-файл, содержащий построчно информацию о доступной для
indoor-позиционирования геометрии этажей схем помещений, а также о коэффициенте
фьюзинга LBS решения с indoor (в какой степени доверять LBS-решению).

Геометрия доступной области этажа строится следующим образом:
 1) из геометрии этажа вычитается объединенная геометрия всех барьеров, расположенных на данном этаже;
 2) затем, из полученной области отнимаются "тонкие" участки (которые могут
 возникать из-за близости границы барьеров к границе области).

В некоторых случаях, геометрия этажа может оказаться пустой. В таком случае
позиционирование на данном этаже не производится.

Пример файла:

```
{"plan_id": "3412227316", "level_id": "-1", "geom": "01060000000200000001030000000100000005000000A9FB00A436D542401E8CD82780E44B40F3AB394030D54240ACE4637781E44B40A47213B534D542409775FF5888E44B4059C2DA183BD54240081D740987E44B40A9FB00A436D542401E8CD82780E44B4001030000000100000005000000F46BEBA7FFD44240CD58349D9DE44B402254A9D903D5424040852348A5E44B409B711AA20AD54240C4978922A4E44B406E895C7006D5424080EF366F9CE44B40F46BEBA7FFD44240CD58349D9DE44B40", "fuse_lbs_coef": 0.5}
{"plan_id": "3412227316", "level_id": "-2", "geom": "010700000000000000", "fuse_lbs_coef": 0.9}
{"plan_id": "3412227316", "level_id": "-3", "geom": "0103000000010000000500000024F0879FFFD442409DD497A59DE44B400AF8359204D542408DEE2076A6E44B40FB7953910AD54240B1F84D61A5E44B401572A59E05D54240925A28999CE44B4024F0879FFFD442409DD497A59DE44B40", "fuse_lbs_coef": 0.1}

```

### indoor_radiomap_tiles (выходной ресурс)

TAR-файл, который содержит основную и экспериментальную радиокарты. Архив содержит два файла:
 * `radiomap.mms` --- нарезанные тайлы основной радиокарты;
 * `radiomap_exp.mms` --- нарезанные тайлы экспериментальной радиокарты.

Файл радиокарты (основной или экспериментальной) для каждого непустого тайла
содержит готовый protobuf с радиокартой:
https://arcanum.yandex-team.ru/arcadia/maps/doc/proto/yandex/maps/proto/indoor/indoor_radiomap.proto

Алгоритм формирования тайлов радиокарты реализован в библиотеке `tile_cutter`.
Входными данными для алгоритма являются:
 * JSONL-файл с восстановленными маяками (`indoor_radiomap_transmitters`);
 * JSONL-файл с этажами радиокарты (`indoor_radiomap_levels`).

#### Алгоритм формирования тайлов радиокарты:

1. Для каждого маяка добавляется тайл, накрывающий его (сам маяк добавляется в
тайл).

2. Для каждого этажа, для которого имеются восстановленные маяки, добавляются
тайлы, в совокупности накрывающие этаж. Геометрия этажа пересекается с каждым из
этих тайлов (и добавляется в него).

3. Для некоторых маяков может не найтись соответствующего им этажа в файле
indoor_radiomap_levels. В таком случае на основе маяков
формируется fallback-геометрия. Для каждого маяка строится квадрат "радиуса" 50м
с центром центром в данном маяке. Геометрией этажа объявляется объединение всех
таких квадратов.

### indoor_radiomap_coverage (промежуточный ресурс)

JSON-файл, который содержит описание coverage-полигонов для схемы помещений.

Пример файла:

```
[
    {
        "geom": "01030000000100000005000000F4081F5E58DC424006B25FF6B9CA4B40F4081F5E58DC424024AF8A1463CB4B4053BA384D06DD424024AF8A1463CB4B4053BA384D06DD424006B25FF6B9CA4B40F4081F5E58DC424006B25FF6B9CA4B40",
        "zoom_min": 16,
        "zoom_max": 23
    },
    {
        "geom": "0103000000010000000500000082F3CD290DDC4240BFE7FC1EF9CD4B4082F3CD290DDC42406AE051A71FCE4B4010753BD543DC42406AE051A71FCE4B4010753BD543DC4240BFE7FC1EF9CD4B4082F3CD290DDC4240BFE7FC1EF9CD4B40",
        "zoom_min": 16,
        "zoom_max": 23
    },
    {
        "geom": "010300000001000000050000008DE925A06BCD4240F71C95F128CE4B408DE925A06BCD4240389E7E397BCE4B4045F104A4F8CD4240389E7E397BCE4B4045F104A4F8CD4240F71C95F128CE4B408DE925A06BCD4240F71C95F128CE4B40",
        "zoom_min": 16,
        "zoom_max": 23
    }
]

```

### indoor_radiomap_coverage_data (выходной ресурс)

TAR-файл, содержащий основной и экспериментальный coverage, подготовленные для быстрой
отдачи тайлов. Архив содержит внутри себя 6 файлов:
 * `root.mms` --- корневой тайл основного coverage, сериализованный в формате MMS;
 * `tree.mms` --- дерево основного coverage, сериализованное в формате MMS;
 * `description.json` --- файл с параметрами основного coverage.
 * `root_exp.mms` --- корневой тайл экспериментального coverage, сериализованный в формате MMS;
 * `tree_exp.mms` --- дерево экспериментального coverage, сериализованное в формате MMS;
 * `description_exp.json` --- файл с параметрами экспериментального coverage.

Для построения `indoor_radiomap_coverage_data` используется библиотека cov2mms.
На вход подается JSON-файл с полигонами `indoor_radiomap_coverage`, а также
параметры для построения coverage:
 * **tileSize** --- размер тайлов coverage в градусах (в нашем случае --- это
 константа 360/1024 = 0.3515625, что означает 1024 тайла по экватору и 512 тайлов
 по меридину);

 * **detailedZoomThreshold** --- параметр, определяющий, начиная с какого зума
 полигоны попадают в дерево coverage, а не в корневой тайл (в нашем случае ---
 это 15). Поскольку для всех полигонов задан zoom range 16--23, то все полигоны
 попадают в дерево coverage --- файл `tree.mms`.
