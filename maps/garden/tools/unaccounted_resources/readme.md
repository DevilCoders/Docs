# unaccounted_resources

## Мотивация
Из-за сбоев в работе, программных ошибок или ошибок конфигурации во внешних источниках могут оставаться данные, неучтённые в Огороде.

Данный инструмент был разработан для поиска и удаления таких данных.

## Режимы работы
### Поиск ресурсов из несуществующих контуров
В mongo ищутся записи о ресурсах из несуществующих контуров и просто удаляются.

### Поиск неучтённых данных во внешних источниках
Поддержан обход следующих внешних источников:
* Ecstatic
* S3
* Sandbox
* YT

При этом из-за ограничений API Ecstatic инструмент может искать только неучтённые версии датасетов, которые зарегистрированы в качестве ресурсов в mongo.
Т.е. в монге нет ресурсов с каким-то датасетом принадлежащим Огороду, то инструмент его не найдёт.

## Запуск
Запуск должен производиться изнутри контейнера с scheduler Огорода **в ручном режиме**. Для доступа к внешним источникам будут использованы настройки из server_settings и environment_settings соответствующего контейнера.

### Пример
```
# подключение к тестинг-контейнеру
ssh $(sky list M@maps_core_garden_scheduler_testing)
# подключение к stable-контейнеру
ssh $(sky list M@maps_core_garden_scheduler_stable)

# запуск инструмента для вывода ресурсов из несуществующих контуров:
unaccounted-resources check-nonexistent-contours > report.txt

# запуск инструмента для удаления ресурсов из несуществующих контуров:
unaccounted-resources check-nonexistent-contours --remove

# запуск инструмента для вывода списка неучтённых данных для системных контуров scheduler:
unaccounted-resources check-external-storages > report.txt

# можно указать список конкретных контуров:
unaccounted-resources check-external-storages -c stable -c datatesting > report.txt

# можно указать список конкретных внешних источников:
unaccounted-resources check-external-storages -s yt -s s3 > report.txt

# для запуска удаления нужно запустить команду с добавлением опции --remove
```
**Важно:** перед удалением следует проверить сформированный отчёт вручную, дабы там не удалилось чего-то лишнего.

Из контейнера можно достать отчёт либо при помощи `ya paste report.txt` либо при помощи команды `ya upload`, если для `ya paste` он оказался велик.
