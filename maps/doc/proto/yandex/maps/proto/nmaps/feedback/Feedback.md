## NMAPS Feedback API

* **Фидбэк Народной Карты (НК)** - внутренний сервис без пользовательской нагрузки для приема гипотез об ошибках в картографических данных.

### Описание

Сервис предназначен для создания гипотез в народную карту со стороны сервисов-генераторов гипотез.

Новые запросы на создание гипотез создаются в protobuf-формате:
* Расширяемость, гибкость формата для расширения существующих и добавления новых типов гипотез
* Обратная совместимость, старые версии данных понимаются новым программным компонентом (сервис NMAPS Feedback)
* Прямая совместимость, новые детали данных игнорируются для старого программного компонента, формат ответа клиентам (генераторам гипотез)

### Требования
Каждый запрос должен использовать TVM2 Service Ticket

### Http-заголовки
* `X-Ya-Service-Ticket`
* `X-Ya-Sync-Token` - токен синхронизации, должен быть в ответе сервиса при модифицирующем запросе. С этим токеном можно вновь обратиться к сервису при запросах на чтение для гарантии, что сервис будет оперировать со свежими данными.
* Accept: `application/x-protobuf`(default) or `text/x-protobuf`

### API

#### **<nmaps-feedback-service>/v1/hypothesis/add**

Метод создания гипотезы в Народную Карту (например, обновление геокординат организации в Справочнике)

| HTTP code | Explanation |
|---|---
| 201 Created | Hypothesis created |
| 400 Bad Request | Request parameters or body malformed |
| 401 Unauthorized | No valid service ticket |
| 404 Not Found | Object by company id not found |
| 409 Conflict | Duplicated request id |
| 429 Too Many Requests | Rps quota exceeded |
| 5xx Internal Server Error | Contact developers |

| **Method**   | POST |
|-------------|-|
| **Params**   | |
| `id` | Required, уникальный идентификатор гипотезы со стороны клиента в виде <prefix>:<value> |
| **Description** | Создать гипотезу. При добавлении новой гипотезы получит в ответ 201 Created. При попытке добавить гипотезу еще раз с тем же `id` - 409 Conflict. Если в базе НК не нашлось объекта с permalink, то 404 Not found. |
| **Request Body** | см. [**yandex.maps.proto.nmaps.feedback.api.Hypothesis**][Api] |


##### Поиск и загрузка объекта в НК по permalink
1) Парсится входное сообщение, извлекается company_id (permalink) - голова кластера в Справочнике.
2) Запрос в Геопоиск, извлекаются текущая координата организации, списки всех permalink-ов кластера и nyak-идентификторов (известные Справочнику id-ки объектов в НК).
3) Геометрический запрос в базу НК по координате организации из Справочника в радиусе 10км с фильтрацией по привязке к Справочнику по permalink-у.
4) Если в результате будет найдено несколько объектов, выбирается ближайший относительно координаты организации из Справочника.
5) В случае отсутствия результатов делаем запрос в базу НК по списку nyak id-ков.
6) Если в результате будет найдено несколько объектов, выбирается ближайший относительно координаты организации из Справочника.
7) В случае отсутствия результатов - возвращаем 404 Not Found (возможно, организация удалена в НК, не синхронизирована со Справочником, пустой список nyak id-ов или соответствует другим категориям объектов, ...).
8) Определеяем тип фидбэка (делаем запросы в базу НК). Indoor - если объект напрямую связан с этажом помещения, либо начальная или конечная координаты организации спроецированы в этаж.
9) Запросы в базу НК, загружаем список входов в организации и подъездов, связанных с найденным объектом.


##### Свойства гипотезы
Гипотеза создается в НК со следующими свойствами:
* Тип - гипотеза (а не фидбэк от пользователя)
* Источник - sprav-georef
* Тип фидбэка - Indoor (определение типа при загрузке объекта по permalink-у) или Poi (по умолчанию)
* Для внутреннего использования
* Скрытая гипотеза
* Связанный объект в НК (poi/indoor), найденный по permalink-у


#### **<nmaps-feedback-service>/v1/hypothesis/get**
Метод получения гипотезы по уникальному `id`, сгенерированному на стороне клиента.

| HTTP code | Explanation |
|---|---
| 200 Ok | Valid response |
| 400 Bad Request | Request parameters malformed |
| 404 Not Found | Task not found |
| 401 Unauthorized | No valid service ticket |
| 429 Too Many Requests | Rps quota exceeded |
| 5xx Internal Server Error | Contact developers |

| **Method**   | GET |
| -------------|-|
| **Params**   | |
| `id` | Required, уникальный идентификатор гипотезы со стороны клиента в виде <prefix>:<value> |
| **Description** | Получить исходную гипотезу. В случае успеха возвращает 200 Ok. При попытке получить статус несуществующей гипотезы `id` - 404 Not Found. |
| **Response Body** | см. [**yandex.maps.proto.nmaps.feedback.api.Hypothesis**][Api] |


#### **<nmaps-feedback-service>/v1/hypothesis/result**
Метод получения статуса обработки гипотезы

| HTTP code | Explanation |
|---|---
| 200 Ok | Valid response |
| 202 Accepted | Request in progress |
| 400 Bad Request | Request parameters malformed |
| 404 Not Found | Task not found |
| 401 Unauthorized | No valid service ticket |
| 429 Too Many Requests | Rps quota exceeded |
| 5xx Internal Server Error | Contact developers |

| **Method**   | GET |
| -------------|-|
| **Params**   | |
| `id` | Required, уникальный идентификатор гипотезы со стороны клиента в виде <prefix>:<value> |
| **Description** | Получить статус гипотезы. Возвращает статус и/или дополнительно информацию по организации - 200 Ok. Если гипотеза еще не обработана - 202 Accepted. При попытке получить статус несуществующей гипотезы `id` - 404 Not Found. |
| **Response Body** | см. [**yandex.maps.proto.nmaps.feedback.api.HypothesisResult**][Api] |


### Пользовательские сценарии
#### Основной сценарий
Пользователь присылает фидбэк на организацию, которая есть в Справочнике.<br/>
Перед применением пользовательских данных сервис Справочника делает запрос в http-ручку **<nmaps-feedback-service>/v1/hypothesis/add**<br/>
Присылает уникальный id-к гипотезы, id-к организации в Справочнике (permalink_id), координату и точки входа.<br/>
К гипотезе могут прилагаться медиафайлы с описаниям.<br/>
В сервисе НК формируется гипотеза, которую должны обработать картографы, руководствуясь как данными НК, так и присланными данными: координаты, комментарий, медиа-файлы...<br/>
Дальнейшие действия со стороны Справочника - использование http-ручки **<nmaps-feedback-service>/v1/hypothesis/result** - получение результата по id-ку запроса.<br/>

| **Http-status** | Результат | Описание |
|---|---|---|
| 404 Not Found | - | id-к запроса не найден |
| 202 Accepted | - | id-к запроса валидный, но задание еще не обработано картографами |
| 200 Ok | change_business_result.status.accepted.company | id-к запроса валидный, задание обработано, фидбек валидный. Картограф внес исправления в текущий датасет, либо исправления были внесены ранее. В результате возвращаются уточненные данные по организации, координата для лучшего представления на подложке и все известные в НК точки входа в организацию. |
| 200 Ok | change_business_result.status.rejected | id-к запроса валидный, задание обработано, фидбек невалидный. Картограф считает фидбэк либо недостоверным, либо еще по каким-то причинам нельзя применить в НК. Например, координаты организации и точки входа находятся в совершенно доугом месте. |
| 200 Ok | change_business_result.status.unknown | id-к запроса валидный, задание было успешно обработано (accepted). В момент выполнения запроса возникла непонятная ситуация с данными. Например, в результате отработки accepted-ответа POI была удалена. |


#### Фидбэк из мобильных карт
Пользователь кликает на иконку организации в приложении, далее выбирает пункт **Исправить информацию об организации**

##### Исправить местоположение и входы
Пользователь в приложении редактирует местоположение офиса, количество и расположение входов.<br/>
Есть возможность оставить комментарий и фотографии.<br/>
После отправки фидбэка информация поступает в справочную систему, где сохраняется информация о фидбэке.<br/>
Далее генерируется уникальный номер заявки в НК вида sprav:xxx, затем с помощью **<nmaps-feedback-service>/v1/hypothesis/add** создается гипотеза в НК.<br/>

Входные данные:
* id (sprav:xxx) - уникальный номер заявки
* company_id - текущий permalink_id
* comment - комментарий пользователя
* координата офиса организации
* список входов с координатами
* список url'ов, доступные картографам, по которым можно будет загрузить подтверждаюшие фотографии

Картографы обрабатывают гипотезу, а Справочник трекает статус гипотезы по id-ку заявки с помощью **<nmaps-feedback-service>/v1/hypothesis/result** (см.выше)

Картографам следует принимать гипотезу (Accepted):
  * если изменений не потребуется (изменения уже применены)
  * требуются внести изменения по данным гипотезы частично или полностью
В этом случае в Справочник будет передаваться статус Accepted и обновленная текущая информация о организации (текущее местоположение организации и список входов с координатами).

Картографы не принимают гипотезу (Rejected), если информация недостоверна или противоречит правилам картографирования.
В этом случае Справочнику известен только статус Rejected обработки гипотезы.

#### Удаление организации в процессе обработки гипотезы
В случае если картограф в процессе обработки гипотезы, связанной с объектом POI в НК, удаляет организацию в НК (возможно, при этом создает одну или несколько новых), то история правок не орабатывается.

Если результат обработки гипотезы в НК:
  * Accepted - в Справочник будет передан статус Unknown (из-за отсутствия координат POI).
  * Rejected - в Справочник будет передан статус Rejected (в этом случае никаких координат Справочнику не передается).


[Api]: https://a.yandex-team.ru/arc/trunk/arcadia/maps/doc/proto/yandex/maps/proto/nmaps/feedback/api.proto
