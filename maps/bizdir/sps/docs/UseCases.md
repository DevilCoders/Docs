# Обработка сигналов в СПП

## Входные данные

Дифф/новая организация представляется в виде набора валидируемых атрибутов. Текущий список атрибутов:

* состояние (открыта/закрыта временна/закрыта постоянно)
* название (основное/короткое, несколько языков)
* адрес (несколько языков)
* рубрики (список идентификаторов)
* телефоны
* часы работы
* адреса электронной почты
* ссылки
* координаты/входы
* признаки: булевы, перечисления, диапазоны, числовые (каждый признак – отдельный валидируемый атрибут)

**NB**: координаты и входы обрабатываются особым образом: мы считаем, что ground truth для них живёт на стороне НЯК, поэтому внутри СПП для геореференсных атрибутов нет ни истории, ни значения, которое СПП считает провалидированным
**NB**: признаки сейчас поддержаны на уровне протоколов, но выключены в UI и не экспортируются в Справочник

Предполагается, что каждый атрибут проверяется целиком – например, если в сигнале пришёл новый адрес электронной почты, то результатом работы контент-менеджера будет полностью проверенный список адресов электронной почты. При этом признаки валидируются по-отдельности – каждый признак это свой отдельный валидируемый атрибут.

В сигнале есть опциональный комментарий ко всему сигналу сразу и, возможно, один и более медиафайлов (фотографии, видео, возможно, аудио).
В общем случае, сигнал может состоять только из комментария и/или набора медиафайлов (тогда набор атрибутов будет пустым).

## Обработка сигнала для существующей организации

Для существующей организации в сигнале будет указан её идентификатор в Справочнике (пермалинк).

### Обработка входящего сигнала

* Находим организацию внутри СПП:
  - По пермалинку организации мы ищем организацию среди имеющихся в СПП
  - Если в СПП информации про организацию нет, то копируем нужные атрибуты из экспорта Справочника.
  - Если в СПП информация про организацию есть, то все непровалидированные атрибуты обновляются из экспорта Справочника.
  - Импорт значения из Справочника сохраняется в списке событий для атрибута
* После того, как организация внутри СПП найдена, по сигналу строится гипотеза
  - Гипотеза может агрегировать несколько сигналов про одну организацию (**сейчас не реализовано**)
* Для каждого атрибута сигнала проверяем, совпадает ли он с имеющимся атрибутом организации:
  - Если да, то для атрибута добавляется вердикт `MarkAsDuplicate`.
  - Если нет, то:
    - СПП может принять решение об автоматической валидации атрибута одним и более валидаторами (**сейчас не реализовано**)
    - Для таких атрибутов добавляется вердикт `NeedInfo`
    - Если автоматическая валидация не нужна или невозможна, то для атрибута добавляется событие `VerdictRequired`
* Если есть атрибуты для валидации, то гипотеза переходит к ожиданию [валидации](#валидация-атрибутов)
* Если нет атрибутов для валидации, то гипотеза отдаётся на разбор контент-менеджеру

### Обработка сигнала контент-менеджером

* Для каждого атрибута контент-менеджер должен выбрать один из вердиктов:
  - `Accept`: Атрибут принимается (возможно, после редактирования)
  - `Reject`: Атрибут отбраковывается
  - `MarkAsDuplicate`: (="правки не нужны") выставляется, когда информация из сигнала совпадает с информацией внутри СПП (например, автоматика не справилась)
    - совпадение может быть необязательно точным, например, как дубль может размечаться сигнал об изменении названия `Яндекс.Технологии` на `ООО "Яндекс.Технологии"`
    - в таком случае, автоматика не найдёт совпадения, а контент-менеджер разметит сигнал как дубликат
  - `NeedInfo`: Для атрибута необходима дополнительная информация. В вердикте передаётся один и более валидаторов:
    - `CALL_CENTER` Атрибут нужно провалидировать в колл-центре
        - недоступно, если в организации/гипотезе нет ни одного номера телефона (**сейчас не реализовано**)
    - `TOLOKA` (**сейчас не реализовано**)
        - недоступно, если в организации/гипотезе нет ссылок на сайт организации/страницы в соцсетях
    - `USER` (**сейчас не реализовано**) Для атрибута нужно запросить дополнительную информацию у пользователя
        - недоступно для сигналов не от пользователя
    - `PEDESTRIANS` (**сейчас не реализовано**) Нужно ногами дойти и проверить информацию об организации
        - доступность определяется, видимо, по доступности пешеходов в населённых пунктах
  - Для запроса дополнительной информации доступно написание текстового комментария
* Дополнительно, контент-менеджер может
  - отредактировать атрибут, которого нет в сигнале (например, если на сайте нашёлся номер телефона, которого нет в карточке; по адресу электронной почты удалось понять сайт организации; etc.)
  - запросить необходимую валидацию для этого атрибута
* Фотографии из сигнала не загружаются в Справочник на стороне СПП и используются только для принятия решения контент-менеджером
* После того, как для каждого атрибута выбран вердикт, обработанная гипотеза возвращается СПП
* Если ни для какого атрибута не требуется дополнительная информация, то:
  * Если все атрибуты имеют вердикт `Rejected`
    - _информация об организации внутри СПП_: не меняется
    - _дифф для Справочника_: не формируется
    - _статус сигнала_: `Rejected`
  * Иначе если все атрибуты имеют вердикт `MarkAsDuplicate` или `Rejected`:
    - _информация об организации внутри СПП_: не меняется
    - _дифф для Справочника_: формируется по всем провалидированным атрибутам, которые не совпадают с экспортом Справочника
    - _статус сигнала_: заполняется по результату сигнала в Справочник
  * Иначе если все атрибуты имеют вердикт `Accepted`, `MarkAsDuplicate` или `Rejected`
    - _информация об организации внутри СПП_: обновляется для `Accepted`-атрибутов
      - если при попытке обновить информацию внутри СПП обнаруживается, что какие-то атрибуты поменяли своё значение (**сейчас не реализовано**), то
        - для всех таких атрибутов добавляется сообщение `VerdictRequired` с комментарием о конфликте
        - гипотеза возвращается контент-менеджеру для повторной проверки
    - _дифф для Справочника_: формируется по всем провалидированным атрибутам, которые не совпадают с экспортом Справочника
    - _статус сигнала_: заполняется по результату сигнала в Справочник
* Если для каких-либо вердиктов требуется дополнительная информация, то гипотеза переходит к ожиданию [валидации](#валидация-атрибутов)

### Валидация атрибутов

* Не все валидаторы имеют смысл для всех атрибутов:
  – по телефону неудобно валидировать ссылки
  – толокеры не смогут провалидировать рубрику/признаки
  - решение о доступности валидаторов для атрибута автоматически может приниматься или на стороне СПП, или на стороне валидаторов
* Если для каких-либо вердиктов требуется дополнительная информация, то
  - СПП создаёт задания для соответствующих валидаторов
  - СПП периодически проверяет выполнение этих заданий
  - после того, как все задания выполнены (или для них сработал timeout) СПП обновляет информацию об атрибутах
  - дополнительно проверяются атрибуты с вердиктами `Accepted`/`Rejected`/`MarkAsDuplicate` – в случае, если за время ожидания выполнения заданий изменился атрибут в карточке, то к атрибуту добавляется событие `VerdictRequired` в комментарием о конфликте (**сейчас не реализовано**)
  - обновлённая гипотеза отправляется контент-менеджеру

### Окончание обработки гипотезы

* Цикл "контент-менеджер <=> валидаторы" повторяется до тех пор, пока не останется атрибутов, ожидающих валидации
* источник сигнала периодически проверяет СПП на предмет обработанных сигналов

## Добавление организации

**NB**: добавление организации поддерживается на уровне протоколов, но не реализовано ни на бэкенде, ни на фронтенде

* Основной цикл обработки выглядит аналогично, за исключением того, что контент-менеджер должен проверить организацию на наличие дубликатов в Справочнике (по адресу/координатам/названию).
* Если контент-менеджер принимает решение, что новая организация является дубликатом существующей, то он возвращает в СПП пермалинк дублирующей организации.
* СПП формирует из этого пермалинка и "сигнала добавления" новый "сигнал модификации существующей организации" и отправляет этот сигнал на вход системы.

## Вердикты уровня гипотезы

Кроме вердиктов для отдельных атрибутов есть несколько вердиктов про всю гипотезу целиком:

* `DuplicateVerdict` используется в качестве вердикта для добавления новой организации, если контент-менеджер нашёл дубликат
* `RejectVerdict` позволяет отклонить гипотезу, в которой нет атрибутов (только сообщение и/или медиафайлы)
* `RefuseVerdict` позволяет отказаться обрабатывать гипотезу внутри СПП; в случае такого вердикта источник сигнала должен использовать какой-то другой способ для его обработки

## Диаграмма состояний для гипотезы

У гипотезы целиком есть состояния между которыми она переходит:

![Диаграмма состояний](diagrams/Hypothesis_States.png)
