# Проблемы и решения

## Гонки
Несмотря на то, что наша автоматика работает под семафорами, гонки все равно возможны, да еще и в нескольких местах.

### 1. Гонки при ручных изменениях
Оказалось, что помимо нашей автоматики, конфиги сервиса могут поменяться руками команды сервиса или же автоматикой команды awacs.
При этом нам важно не перетирать эти изменения, они могут оказаться критически важными.

Чтобы решить эту проблему, появился механизм подписей. Он позволяет нашей автоматике убедиться, что никто не трогал конфиги руками и все выкатки осуществляла она.
Посмотрим на [пример подписей](https://nanny.yandex-team.ru/ui/#/awacs/namespaces/list/core-teapot.maps.yandex.net/backends/list/maps_core_teapot_stable_vla/show/):
![](img/labels_example.png)

// todo:

### 2. Данные не успели доехать до awacs, а мы их вытягиваем в аркадию
После коммита в аркадию есть временной лаг перед запуском задачи на заливку конфигов в awacs. За это время может успеть вмешаться `MAPS_BALANCER_PULLER`, который попытаеся вытянуть актуальные данные из awacs, тем самым откатит их.
Поэтому мы не позволяем balancer_puller'у делать коммит в аркадию, в случае, если конфиги были закоммичены в аркадию менее 30 минут назад и скорее всего просто не успели доехать до awacs.


## Ошибочная конфигурация
Возможно, что мы попытаемся закоммитить в аркадию невалидную с точки зрения awacs конфигурацию.
Об ошибки хочется узнавать не при попытке залить конфиги в awacs, а как можно раньше.

Поэтому мы сделали [CI тесты](https://a.yandex-team.ru/arc_vcs/maps/infra/balancer_deployer/tests_py2/config_validation/), в который повторили логику валидации awacs.
