## Схема подключения агента

Для квотирования клиентских запросов на стороне провайдера используется локальный `quotateka-agent`.
Это отдельный сервант, который подключен в общий пайплайн при помощи nginx-плагина.

Таким образом в обработке клиентского запроса добавляется шаг:
- nginx-плагин отправляет подзапрос на ручку `/access` локального `quotateka-agent`.
- рантайм `quotateka-agent` выполняет основную логику: определение квоты, стоимости запроса и рейтлимитирование.
- nginx-плагин, на основе полученного результата, блокирует запрос или пропускает на обработку сервисом провайдера.

Также агент собирает статистику запросов от клиентских tvm и отправляет в Голован.

## Мониторинги и диагностика неполадок

### Выкатка сервиса спотыкается об quotateka-agent
`quotateka-agent` запускается до старта основного серванта и при неполадках инициализации блокирует запуск сервиса.
Вероятные причины - ошибки в конфигурации агента или проблемы с доступностью бэкенда quotateka. 

Подробную диагностику нужно искать в логе агента: 
`/var/log/yandex/maps/quotateka-agent/quotateka-agent.log`

### Горит http-quotateka-agent-access-error (500ки на ручке `quotateka-agent/access`)
Внутренние ошибки в пайплайне агента не приводят к блокировке запросов. 
То есть nginx-плагин, получив 500ку от агента, пропустит запрос на обработку провайдером.

Причиной 500ки, могут быть ошибки в конфигурации провайдера, из-за которых агент не может определить квоту для запроса.

Диагностику нужно искать в логе агента: 
`/var/log/yandex/maps/quotateka-agent/quotateka-agent.log`
А также логах nginx-плагина в `/var/log/nginx/error.log` <br>
Конфигурация провайдера определена в Аркадии в [maps/config/quotateka](https://a.yandex-team.ru/arc/trunk/arcadia/maps/config/quotateka)

### Горит quotateka-agent-inventory-age
Агент продолжительное время не получает обновления конфигурации квот с бэкенда квотатеки.
Если хост не закрыт от траффика и обслуживает клиентские запросы, то агент может применять устаревшие значения квот.

Вероятная причина - проблемы с сетью на отдельных хостах провайдера. <br>
Диагностика в логе агента: 
`/var/log/yandex/maps/quotateka-agent/quotateka-agent.log`

### Горит quotateka-agent-ratelimiter-sync-upstream
Агент продолжительное время не синхронизирует счетчики с сервером рейтлимитера.<br>
Наиболее вероятная причина - сетевые проблемы на отдельных хостах провайдера.
Однако, если такой хост продолжает обслуживать клиентские запросы, то они не будут учтены в потреблении квот.

Диагностика в логе агента: 
`/var/log/yandex/maps/quotateka-agent/quotateka-agent.log`


## Аварийное отключение

Если что-то пошло не так в продакшн, то предусмотрен механизм срочного отключения квотирования на отдельном хосте или на всем кластере.

#### Способ A: отключить nginx-плагин при помощи agent-ctl скрипта

`/usr/lib/yandex/maps/quotateka/agent-ctl.sh disable`

Этот рубильник переопределяет вызовы плагина на пустышки, таким образом полностью вырезает агента из пайплайна обработки запросов.
Для активации новой конфигурации делает `nginx -s reload`, то есть сравнительно бережно перезагружает nginx (не ломает текущие запросы, но в итоге разорвет соединения клиентов)

Когда разобрались в неполадках, не забудьте включить обратно:
`/usr/lib/yandex/maps/quotateka/agent-ctl.sh enable`

{% note info %}

Для отключения на всем кластере, используйте executer.  

**Внимание:** Рекомендуем p_exec по ДЦ, чтобы размазать по времени разрыв клиентских соединений.

{% endnote %}

#### Способ B: остановить серванта `quotateka-agent`

`yacare stop quotateka-agent`

Этот способ не меняет пайплайн обработки - nginx-плагин остается работать, но не блокирует запросы.
При этом будет гореть мониторинг `http-quotateka-agent-access-error`, т.к. подзапросы на ручку `/access` агента будут завершаться 500ками.

Чтобы включить обратно:  
`yacare start ratelimiter-proxy` 
