## Quota points и стоимость ручек 

Стоимость ручек устанавливается по результатам нагрузочных стрельб.

Значение стоимости задается целым числом quota points (`qp`), которые выступают в качестве единиц измерения вычислительной мощности кластера. При определении порции вычислительных ресурсов соответствующей 1 `qp` рекомендуем с самого начала выбрать более мелкий масштаб, чтобы при изменениях стоимости не жертвовать точностью на округлении.

Таким образом, количество `qp` в квоте это гарантия суммарного RPS по разным ручкам с учетом их стоимости. В рамках своей квоты клиенты могут менять профиль нагрузки по ручкам по своему усмотрению.

Для заданного значения квоты в `qp` провайдер может посчитать соответствующее количество аппаратных ресурсов (CPU/Memory/Disk на бэкендах и балансерах)

{% note info %}

В некоторых (экзотических) ситуациях может потребоваться изменение масштаба `qp`.
Например, если изначально масштаб был выбран неудачно.
Или теоретически к этому могут привести изменения размера инстансов на кластере провайдера, после которых непропорционально разъехались показания стрельб по всем ручкам.

Если вам понадобилось такое, то приходите в команду инфры - мы поможем безопасно отмасштабировать все квоты.

{% endnote %}

### Изменение стоимости ручек

Считаем, что на практике изменения стоимости происходят редко. 
Из коробки предлагаем ручную процедуру для перебалансировки квот.

{% note warning %}

Необходимо соблюсти гарантии RPS в рамках выданных квот.
Если этого не сделать, то изменения стоимости могут привести к блокировке клиентского трафика.

{% endnote %}

#### ↓ Уменьшаем стоимость
Ручка стала потреблять меньше ресурсов для обработки запроса (например в результате оптимизации).

Устанавливаем новую стоимость в конфиге провайдера и коммитим.
Изменение безопасное для клиентов - они при том же RPS будут утилизировать меньше квоты и при желании могут отказаться от излишков.

Но нужно иметь в виду, что потенциально клиенты могут начать лить больший RPS на эту ручку. Если разница значительная, то стоит позаботиться чтобы хватило ресурсов на балансерах. 

#### ↑ Увеличиваем стоимость
Ручка стала стабильно потреблять больше ресурсов для обработки запроса.

В общем случае есть риск, что после установки новой стоимости, траффик клиентов перестанет влезать в квоты.
С другой стороны, на кластер провайдера возможно придется докинуть железа, чтобы обеспечить необходимый RPS.

Для безопасного увеличения стоимости предлагаем следующую процедуру:

- Для всех клиентов, кто использует ручку, рассчитываем новые значения квот при соблюдения гарантии RPS (`new_quota = (old_quota/old_cost)*new_cost`) 
  Тут на усмотрение провайдера выбор - сохранить гарантию максимального RPS или актуального, то есть отмасштабировать квоту целиком или только часть, которую клиент фактически использует для данной ручки.

- Добавляем на кластер провайдера железо, чтобы покрыть сумму всех добавленнных `qp`.

- Передаем добавку на баланс каждому клиенту через инструмент в ABC

- В тикетах на передачу квоты анонсируем дедлайн для раскатки изменений, чтобы клиенты успели проаллоцировать новые значения

- После наступления дедлайна прописываем новую стоимость в конфиге провайдера и коммитим
