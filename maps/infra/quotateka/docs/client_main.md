Если ваш проект использует API, предоставляемое сервисами Геоплатформы, то нужно позаботиться о квоте на запросы API. Это позволит провайдеру API обеспечить ваши запросы вычислительными ресурсами.

Нужно иметь в виду, что разные API обслуживаются отдельными провайдерами с собственными квотами.

{% note tip %}

Для заказа квоты нужно обратиться в команду провайдера (контакты можно найти в документации к API).
В заказе перечисляете нужные ручки и указываете RPS.

Для нескольких сервисов имеет смысл формировать общий заказ и в качестве получателя указывать головной ABC. Полученную квоту в дальнейшем можно нарезать и перекладывать как душе угодно.

{% endnote %}

{% note info %}

Квота определена как количество некоторого ресурса.
В квотах на API в качестве отдельного ресурса может выступать подмножество ручек или определенный тип запросов.
У каждого провайдера своя специфика в определении структуры ресурсов (в простом случае все API представлено одним ресурсом).

Для количественного измерения квоты используются условные еденицы `qp` (quota points). 
У ручек API разная стоимость в `qp`, соответствующая вычислительным затратам на обработку запроса.
RPS пересчитывается в `qp` с учетом стоимости ручек.

{% endnote %}

Полученной квотой клиент управляет самостоятельно:
- Распределяет между сервисами ABC
- Передает в аккаунты 
- Привязывает TVM


## Управление квотой в ABC

Во вкладке `Квоты` в ABC находится инструмент централизованного управления квотами в Яндексе.
Документация ABCD: [на wiki](https://wiki.yandex-team.ru/intranet/abc/docs/quotas/)

Он позволяет вести учет квоты и передавать ее между ABC сервисами.
Для логической группировки квот в рамках одного ABC используются фолдеры (по-умолчанию есть только фолдер `default`)

### Роли

Для доступа к управлению квотами ABC-сервиса нужна любая роль из скоупов:
- `Управление продуктом` (`services_management`) 
- `Управление квотами` (`quotas_management`)

### Аккаунты (спуск/подъем квоты)

![mem](img/quota.jpeg "Ну как-то так" =500x490)

Для передачи провайдеру информации о конфигурации квот служат аккаунты.
Чтобы воспользоваться квотой, нужно создать в фолдере аккаунт соответствующего провайдера и "спустить" в него квоту из баланса. И cоответственно, чтобы вернуть квоту в баланс фолдера, ее нужно "поднять" из аккаунта.

Аккаунт может содержать квоты сразу нескольких ресурсов провайдера.

Отдельные аккаунты можно использовать, чтобы изолировать подсистемы или окружения сервиса в отдельные квоты.

## Управление аккаунтами в Quotateka

В интерфейсе ABC вы завели аккаунты и передали в них квоту.
Следующий шаг - настройка аккаунтов для обслуживания вашего траффика на стороне провайдера.

Для настройки аккаунтов используется Quotateka GUI: [quotateka.maps.yandex-team.ru](http://quotateka.maps.yandex-team.ru/)
Ключевые операции здесь: `аллокация квоты` и `привязка к TVM`.

В левой панели расположен список ABC-сервисов.
Автоматически в него попадают только те, в которых у вас есть права на редактирование. Но вручную туда можно добавить любой ABC, в котором есть аккаунты API-провайдеров Гео. 

Для редактирования аккаунтов ABC-сервиса нужна любая роль из скоупов:
- `Управление продуктом` (`services_management`) 
- `Управление квотами` (`quotas_management`)
- `Администрирование` (`administration`)

Для выбранного ABC показывается плоский список аккаунтов.
На дашборде выбранного аккаунта: список привязанных tvm, перечень квот на ресурсы, графики потребления. 

{% cut "Дашборд аккаунта в Quotateka" %}

![gui](img/quotateka_gui.png)

{% endcut %}

### Аллокация квоты

Спущенную в аккаунт квоту необходимо аллоцировать, **именно значение аллоцированной квоты аккаунта провайдер применяет для обслуживания запросов**.

Алоцированная квота прибита гвоздями к аккаунту и забрать ее можно только после явной деаллокации. Таким образом никакие манипуляции с квотами в ABC (или неполадки/даунтаймы ABCD) не могут выдернуть квоту из под вашего траффика. 

{% note warning %}

При деаллокации квоты будьте внимательны!
Проверьте по графикам, что остатков хватит для текущего траффика, иначе провайдер может начать его блокировать.

{% endnote %}


### Привязка TVM

API провайдер опирается на TVM аутентификацию при определении квоты для обслуживания запросов. Клиентский tvm-идентификатор из service-тикета в запросе используется для выбора аккаунта
Таким образом, привязав tvm-идентификатор к аккаунту, вы направляете соответствующий траффик в его квоту.
К аккаунту можно привязать несколько tvm, чтобы их запросы использовали общую квоту.

{% note warning %}

Один и тот же tvm нельзя привязать к разным аккаунтам одного провайдера.
В этом случае вы увидите предостерегающее сообщение.

Будьте внимательны при переносе tvm в другой аккаунт.
Убедитесь что в нем достаточно квоты для трафика.

{% endnote %}

### Графики и мониторинги

На дашборде аккаунта отдельные графики по ресурсам провайдера: утилизация квоты и распределение трафика по tvm и по ручкам провайдера

{% note info %}

Мы планируем автоматику для настройки мониторинга утилизации квоты (stay tuned)

Cейчас можно самостоятельно настроить алерты в Головане. 
Нужные сигналы можно взять с панели с графиками аккаунта.

{% endnote %}
