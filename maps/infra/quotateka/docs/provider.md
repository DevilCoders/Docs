**Провайдер** это сервис Геоплатформы, который предоставляет API для других проектов и сервисов Яндекса.
Квоты на API, это способ распределения вычислительных ресурсов провайдера между клиентами.

Подключившись к Quotateka, провайдер получает готовый пайплайн для управления и контроля квот на API. Также Quotateka обеспечивает интеграцию в централизованный механизм управления квотами через ABCD. 

На команду провайдера ложится только роль в выдаче квот, тут в идеале минимум ручной рутины если заказы будут формироваться для крупных юнитов верхнего уровня иерархии ABC.
У клиентов теперь есть инструменты, чтобы самостоятельно настраивать и распределять полученную квоту между своими сервисами.

{% note info %}

Каждый провайдер (как и клиент) в системе однозначно связан с ABC-сервисом. 
Это соответствует модели ABCD, в которой провайдеры и клиенты идентифицируются ABC-сервисами. 

{% endnote %}

На инстансах сервиса провайдера работает `quotateka-agent`, задача которого - квотирование клиентских запросов. Подробно об агенте [в статье про экспуатацию](agent_troubleshooting.md)


## Конфигурация
Конфигурация провайдера задается в Аркадии в отдельной папке внутри [maps/config/quotateka](http://a.yandex-team.ru/arc/trunk/arcadia/maps/config/quotateka)    
Название папки - это уникальный идентификатор провайдера в системе.
Конфигурация для продашкн и тестового окружений - в отдельных файлах `stable.yaml` и `testing.yaml`.   

{% note info %}

После коммита изменения конфигурации автоматически загружаются на бэкенд.
Затем в течении минуты распространяются по всем агентам на кластере провайдера. 

{% endnote %}

#### Параметры конфигурации

- `abc_slug` - строковый идентификатор сервиса провайдера в ABC.  

- `name` - локализованное имя провайдера, которое клиенты видят в GUI.  

- `resources` - в этой секции перечислены ресурсы, которые предоставляет провайдер.
  Ресурс объединяет набор ручек API с общей квотой.

  {% note tip %}

  Квоты разных ресурсов не конвертируются между собой.
  Поэтому в общем случае не рекомендуем делить API на большое количество ресурсов, фрагментация квот усложнит управление и для клиентов и для самого провайдера.    

  {% endnote %}

  Параметры ресурса:

  - `type` - тип ресурса определяет способ квотирования. 
    На текущий момент поддерживается рейт-лимитирование в интервал времени: `PerSecondLimit`, `PerHourLimit`, `PerDayLimit`

  - `endpoints` - список ручек в составе ресурса
    Для каждой ручки задается `path` и `cost` (стоимость в условных еденицах `qp`)
    Подробнее про стоимость ручек [в специальном разделе](qp_and_endpoint_costs.md)

  - `anonym_limit` - общая квота для запросов без tvm

  - `default_limit` - квота для запросов клиентов без выданной квоты

    {% note warning %}

    В отличии от анонимной, дефолтная квота учитывается отдельно для разных tvm.  

    {% endnote %}

```yaml
# Пример конфигурации провайдера
abc_slug: maps-core-teapot
name:
  en: Teapot
  ru: Чайник
resources:
  general-api:  # короткий текстовый идентификатор ресурса
    type: PerSecondLimit
    endpoints:
      - path: /one
        cost: 100
      - path: /two
        cost: 500
    default_limit: 5000
    anonym_limit: 2500
```

## Квоты провайдера в ABCD 

Quotateka позволяет интегрировать провайдера в ресурсное дерево ABCD.
Это инструмент централизованного управления квотами в Яндексе, живет во вкладке `Квоты` в ABC.
Документация ABCD: [на wiki](https://wiki.yandex-team.ru/intranet/abc/docs/quotas/)

{% note info %}

Для доступа к редактированию необходима роль из скоупов: 
- `Управление продуктом`
- `Управление квотами`

{% endnote %}

### Резерв квоты 

Текущий запас вычислительной мощности провайдера хранится в виде квоты в фолдере `reserve`.
Из этого резерва провайдер выдает квоты клиентам.

{% cut "Пример резерва для провайдера masstransit router" %}

![Резерв](img/reserve.png)

{% endcut %}

{% note info %}

Пополнение резерва сейчас только в ручном режиме.
В том числе учет поставленного железа.

Для этого приходите в [гео-инфру](https://t.me/joinchat/Qqc7jaTA2rFEV9sP).

{% endnote %}

### Выдача квоты клиентам

Клиент запрашивает квоту в терминах RPS на ручки API. (_Процедура подачи заявок остается на усмотрение команды провайдера._)

Провайдер выдает квоту в условных еденицах `qp` из своего резерва.
Значение рачитывается как сумма по запрошенным ручкам `∑(RPS * стоимость)`.

Квота выдается через кнопку `Передать квоту` на вкладке Квоты в ABC провайдера.
В интерфейсе передачи квоты нужно указать: источник - фолдер с резервом провайдера, получатель - дефолтный фолдер в ABC клиента

{% cut "Пример передачи квоты" %}

![Запрос передачи](img/transfer_request.png)

{% endcut %}

Далее клиент сам распоряжается квотой: перераспределеят между сервисами, спускает и аллоцирует в аккаунты, привязывает tvm.

## Графики

[Темплейт в Головане](https://yasm.yandex-team.ru/template/panel/maps_core_quotateka_provider_dashboard/) для дашборда провайдера.  
Нужно только подставить свой `abc=<abc_slug>` в контекст шаблона. 
