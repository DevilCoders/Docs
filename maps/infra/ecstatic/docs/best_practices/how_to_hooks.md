# Как правильно писать хуки (и не только)

## Введение

Хуки - это произвольные исполняемые (`executable`) файлы, которые автоматически запускаются экстатиком на определенные события.

Существует 3 основных типа хуков:
- [`postdl`](#postdl) - запускается сразу после загрузки датасета на хост;
- [`switch`](#switch) - используется для активации данных под распределенным локом;
- [`remove`](#remove) - вызывается при удалении версии с машинки.

Кроме того, есть вспомогательные [`check`-хуки](#check), которые запускаеюся сразу после активации новой версии датасета и проверяют работоспособность сервиса.

Хуки размещаются по следующим путям:
- `/etc/yandex/maps/ecstatic/<dataset-name>(:<dataset-tag>)/*.(postdl|switch|remove)` для `postdl`, `switch` и `remove`;
- `/etc/yandex/maps/ecstatic/checks/*.check` для `check`-хуков.

Файл хука должнен быть исполняемым (`executable`), в т.ч. содержать правильный `shebang-line`, если это скрипт. Хуки исполняются от имени юзера `ecstatic`, и в них можно использовать `sudo` при необходимости.

При успешном завершении хук должен возвращать нулевой код возврата. В случае ненулевого кода возврата хук считается зафейлившимся, а его stdout/-err сохраняются в логе агента: `/var/log/yandex/maps/ecstatic-agent/ecstatic-agent.log`. Максимальное время исполнения хука ограничено 10 минутами, после чего все дерево процессов, порожденных хуком, убивается.

Если указать несколько хуков одного типа для датасета (или несколько `check`-хуков), то они будут вызваны в лексикографическом порядке, и первый фейл хука отменит вызов остальных.

Все основные типы хуков экстатик запускает с единственным аргументом командной строки - версией датасета. В некоторых случаях для `switch`-хуков [версия может быть пустой строкой](#switch).

Помимо версии датасета, передаваемой через аргумент командной строки, экстатик задает для хука следующие переменные окружения:
- `ECSTATIC_VERSIONED_DATA_PATH` - полный путь до этой версии датасета (инвалидируется после вызова `remove`-хука);
- `ECSTATIC_ACTIVATED_DATA_PATH`/`ECSTATIC_DATA_PATH` - симлинка на текущую активную версию датасета (только для `switch`-хуков с непустой версией);
- `ECSTATIC_DATA_VERSION` - версия датасета (аналогично параметру командной строки, может быть пустой для `switch`-хуков);
- `ECSTATIC_DATA_TAG` - тэг датасета, если имеется, иначе пустая строка.

`check`-хуки не привязываются к конкретной версии датасета, поэтому не получают аргументов командной строки и переменных окружения.

## Переключение на новую версию данных

### `postdl`-хуки { #postdl }
`postdl`-хук используется для уведомления сервиса о доступности новой версии датасета. Хук вызывается сразу после того, как датасет скачался на конкретный хост, и никак не учитывает состояние соседних хостов.

{% note warning %}

Экстатик не гарантирует, что порядок загрузки датасетов на хост, а соответственно и вызова `postdl`-хуков для разных версий, соответствует порядку добавления новых версий датасета в систему.

{% endnote %}

Если зафейлить `postdl`-хук, то для данной версии не будет вызван `switch`-хук.

### `switch`-хуки { #switch }
`switch`-хук используется для активации новой версии датасета. При выполнении `switch`-хуков экстатик гарантирует, что:
- кол-во хостов, одновременно выполняющих данный хук, не превышает [`switch in parallel`](../configs#switch-in-parallel);
- хосты начнут выполнять переключение только в тот момент, когда наберется кворум (равный 100% минус [`tolerance`](../configs#tolerance)) хостов, выполнивших `postdl`.

Если кворум не равен 100%, то возможна ситуация, когда весь кластер начал переключение на версию датасета, которая пока не докачалась на данный хост. В этом случае экстатик позовет `switch`-хук с пустой версией датасета. Сервис может как игнорировать такой хук, так и отключаться от балансера (`detach` в терминах yacare-based сервисов). Такое поведение позволяет экстатику гарантировать, что хосты, которые не успели скачать нужную версию и не входят в кворум, не будут вносить хаос в отдаваемые пользователям данные.

После успешного завершения `switch`-хука проверяются [`check`-хуки](#check). И только если `check`-хуки завершились успешно, выкладка продолжается на следующей части кластера.

Если сфейлится больше хостов, чем окно выкладки (`switch in parallel`), то экстатик остановит выкладку, а затем начнет откатывать версию датасета.

### Выбираем между `postdl` и `switch`
{% note tip "TL;DR" %}

`postdl`-хуки для датасетов с большой частотой обновления, которым не важна синхронность версий на кластере

`switch`-хуки для более медленных датасетов, которым необходима координация при переключении, чтобы, например, не уронить весь кластер разом

{% endnote %}

Есть два типа хуков, сообщающих о новой версии датасета: `postdl` и `switch`. Оба вызываются при появлении новой версии датасета на хосте, но в разные моменты времени.
- `postdl`-хуки выполняются независимо, а потому датасеты чаще обновляются;
- `postdl`-хуки никак не координируют свое выполнение, поэтому датасеты на кластере могут быть постоянно рассинхронизированы;
- `switch`-хуки синхронизируют выполнение, поэтому могут выполняться с задержкой;
- `switch`-хуки гарантируют, что датасеты на кластере в конечном итоге будут иметь общую версию.

Другими словами, при выборе хука стоит отталкиваться от требований, которые ваш сервис накладывает на доставку данных.

{% note warning %}

Для рестарта уже запущенного сервиса следует использовать ТОЛЬКО `switch`-хук.
Но можно стартовать сервис из `postdl`-хука, если он не запущен.

{% endnote %}

### Быстрые и медленные датасеты
Рассмотрим такую классификацию: все датасеты можно условно разделить на "быстрые" и "медленные".

Быстрые датасеты имеют относительно небольшой размер и часто обновляются. Типичный пример: данные о пробках на дорогах - обновляются раз в 30 секунд, и имеют размер порядка 10-100 мегабайт.

Медленные датасеты могут иметь произвольно большой размер и обычно обновляются раз в сутки или реже. Типичный пример: автомобильный граф дорог - обновляется раз в сутки и может достигать размера в десятки гигабайт.

Для быстрых датасетов важна скорость обновления, поэтому обычно используют `postdl`-хуки и жертвуют гомогенностью кластера или поддерживают кэш из нескольких последних версий.

Для медленных важна не столько скорость обновления, сколько синхронность переключения для обеспечения гомогенности отображаемых данных. В таком случае обычно данные заранее подгружают на хост, а затем синхронно переключают через `switch`-хук.

{% note warning %}

Обычно переключение медленного датасета связано с даунтаймом хоста на некоторое время. Поэтому переключают не весь кластер, а некоторый процент хостов за раз, и апдейт раскатывается по кластеру волной. Скорость выкатки напрямую зависит от скорости переключения каждого отдельного хоста.

{% endnote %}

## Зачем вообще использовать `сheck`-хуки? { #check }

{% note tip "TL;DR" %}

`check`-хуки позволяют учесть даунтаймы сервиса, вызванные последствиями переключения версии датасета или другими внешними факторами

{% endnote %}

{% note warning %}

Мы рекомендуем использовать `check`-хуки всем сервисам без исключения.

{% endnote %}

Исторически `check`-хуки появились поcледними. Ранее считалось, что обратной связи при выполнении `switch`-хука достаточно для безопасного переключения кластера, и если определенный процент хуков зафейлился, то выкладка останавливалась, чтобы не сложить весь кластер. Но как показывает практика, успешная загрузка датасета не означает, что после этого сервис не начнет пятисотить или падать при попытке обращения к новым данным.

Кроме того, `check`-хуки имеют несколько другой механизм работы: они запускаются сразу после `switch`-хука и пока сервис не пройдет проверку, переключение версии датасета не может считаться успешным. По сути хук выполняет readiness-пробу, например, дергает ручку `/ping`, и если хост способен корректно ответить, то проверка считается успешной.

### Правильная работа ручки `/ping` { #readiness-probe }

Изменение состояния ручки `/ping` обычно служит сигналом для балансеров при наливании траффика, а также учитывается облаком при выкатке софта. Аналогично при интеграции сервиса с ecstatic'ом предлагается использовать ручку `/ping` для мониторинга из `check`-хука. При этом разработчик сервиса должен самостоятельно сформулировать критерии работоспособности сервиса и реализовать необходимые проверки в коде.

В yacare-based сервисах для изменения состояния ручки `/ping` используется директива `YCR_PANIC_IF`, в других случаях вам необходимо самостоятельно запрограммировать ручку `/ping` отвечать ошибкой, если не выполняются необходимые для работы сервиса условия. Иначе существует риск уронить весь кластер при неудачном обновлении датасета.

{% note warning %}

Мы рекомендуем обратить внимание на следующие моменты:
- наличие всех необходимых данных в памяти сервиса (например, датасета, который необходим для работы сервиса и загружается динамически);
- живое соединение до базы данных.

{% endnote %}

### Пример `check`-хука

```bash
#!/usr/bin/env bash
set -eu

curl \
    --fail \
    --connect-timeout 10 \
    --show-error \
    --silent \
    --header "Host: core-teapot.maps.yandex.net" \
    --request GET \
    --write-out "Server responded with HTTP code %{http_code}\n" \
    "http://localhost/ping"
```

## Когда нужен `remove`-хук? { #remove }

{% note tip "TL;DR" %}

`remove`-хуки уведомляют сервис о том, что версия датасета удаляется с диска

{% endnote %}

В большинстве случаев сервисы опираются либо на активную версию датасета (`switch`-хук), либо на последнюю доступную (`postdl`-хук). Но в некоторых случаях возникает необходимость работать сразу с несколькими версиями датасета.

В таком случае, помимо сигнала о новой версии сервису необходимо знать о том, что какая-то из используемых версий датасета более не доступна на диске. Для этого экстатик предоставляет `remove`-хуки.

{% note warning %}

В общем случае, экстатик не гарантирует наличие хотя бы одной версии датасета на хосте, например, при недостаточной скорости генерации датасетов и выставленному `expire` по времени.

{% endnote %}

### Пример использования `remove`-хука

Допустим, ваш сервис на каждый `postdl`-хук читает данные датасета с диска и создает ассоциированную с ними структуру данных в памяти. Кол-во таких структур в памяти будет только расти со временем.

Поэтому логично воспользоваться `remove`-хуком, чтобы удалять ассоциированные с датасетом данные, и настроить `expire` для датасета в конфиге экстатика, чтобы получить более-менее константное кол-во версий датасета в памяти сервиса.

## Рекомендации по написанию хуков (и не только)

{% note tip "TL;DR" %}

1. Использовать `ecstatic client run_with_local_lock` в скрипте запуска сервиса
2. Уметь выбрать актуальную версию датасета при запуске сервиса
3. (Ре-)стартовать сервис только при наличии всех необходимых датасетов
4. Уметь проверять валидность данных без (ре-)старта сервиса
5. При необходимости использовать ретраи в конфиге экстатика

{% endnote %}

При дизайне хуков и скрипта запуска сервиса надо принимать во внимание следующие моменты:
- скрипт запуска сервиса и хуки экстатика конкурируют за доступ к сервису;
- сервис должен уметь выбрать актуальные версии датасетов на старте;
- есть некоторая вероятность, что какой-то хук будет выполнен до того, как выполнился скрипт запуска сервиса;
- при (ре-)старте сервиса нужно отличать ошибки в данных от отсутствия соседнего датасета.

### Как избежать гонки между скриптом запуска сервиса и хуками
Экстатик гарантирует, что в один момент времени выполняется только один хук, т.к. хуки обычно взаимодействуют с процессом сервиса. Однако при старте контейнера обычно используется отдельный скрипт для запуска сервиса, который ничего не знает про исполняемые хуки.

Поэтому мы предоставляем команду `ecstatic client run_with_local_lock`, которая гарантирует, что экстатик не будет пытаться перемещать данные на диске или выполнять хуки, пока команда не завершится.

### Выбор актуальной версии датасета при запуске сервиса
Если ваш сервис использует `switch`-хук для датасета, т.е. опирается на его активную версию, то найти её можно в директории `/var/lib/yandex/maps/ecstatic/data/<dataset-name>`.

Однако здесь нужно учесть, что у датасета может не быть активной версии, а значит симлинки в директории `data`.
В этом случае сервис может:
- дождаться, когда экстатик активирует датасет на хосте, что автоматически вызовет `switch`-хук, который сообщит версию и путь до данных;
- воспользоваться последней успешно активированной версией данных, которую можно найти в директории `/var/lib/yandex/maps/ecstatic/preserved_data/<dataset-name>`.
Функциональность с `preserved_data` необходимо вручную [включить через конфиг агента](../configs#preserved-data) экстатика.

{% note warning %}

Если сервис игнорирует `switch`-хук на пустую версию датасета, то скорее всего, он должен [читать данные из `preserved_data`](../configs#preserved-data) на старте.

{% endnote %}

Если ваш сервис использует `postdl`-хуки для получения последней доступной версии датасета на хосте, то простого способа выбора актуальной версии данного датасета нет.
В таком случае есть 2 варианта:
- если новая версия датасета приезжает достаточно часто, то можно дождаться очередного вызова `postdl`-хука, который сообщит путь до актуальных данных;
- если датасет приезжает редко, то вы можете самостоятельно при вызове `postdl`-хука создавать симлинку из произвольной выбранной директории на актуальную версию датасета.

{% note warning %}

Создавая симлинку на данные в `postdl`-хуке, не забудьте удалить её в `remove`-хуке.

Кроме того, рекомендуется заранее проверять валидность данных, иначе есть риск оставить симлинку на битую версию.

{% endnote %}

### Корректно (пере-)запускаем сервис
Перед тем как (ре-)стартовать сервис, рекомендуется убедиться, что все необходимые датасеты есть на диске.

Если сервис использует только активную (на всем кластере) версию датасета, рекомендуем воспользоваться [bash-функцией `areRequiredDatasetsAvailable`](https://a.yandex-team.ru/arc/trunk/arcadia/maps/infra/baseimage/README.md#%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%B0-%D1%81-%D1%85%D1%83%D0%BA%D0%B0%D0%BC%D0%B8-%D1%8D%D0%BA%D1%81%D1%82%D0%B0%D1%82%D0%B8%D0%BA%D0%B0) в составе базового докер-образа Карт. Функция проверяет наличие в директории `/var/lib/yandex/maps/ecstatic/data/` симлинок на все датасеты, перечисленные в конфиге образа.

Если сервис опирается на последнюю успешно активированную (на конкретном хосте) версию датасета (см. описание `preserved_data` в предыдущем разделе), то стоит использовать [bash-функцию `areRequiredPreservedDatasetsAvailable`](https://a.yandex-team.ru/arc/trunk/arcadia/maps/infra/baseimage/README.md#%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%B0-%D1%81-%D1%85%D1%83%D0%BA%D0%B0%D0%BC%D0%B8-%D1%8D%D0%BA%D1%81%D1%82%D0%B0%D1%82%D0%B8%D0%BA%D0%B0). Её поведение аналогично, за исключением проверяемой директории и списка датасетов в конфиге образа (указываются отдельно).

Не забудьте также проверить наличие и валидность симлинок, которые самостоятельно проставляете из `postdl`-хуков.

### Валидация данных в хуках
Для проверки валидности данных из хука нельзя полагаться на то, что ваш сервис в данный момент работает, или вы можете его поднять при необходимости.

Мы рекомендуем иметь возможность провалидировать данные без необходимости поднимать сервис целиком, например, через отдельную опцию командной строки, которая проверяет конкретный датасет.

Кроме того, рекомендуем завести отдельное [datavalidation-окружение](https://wiki.yandex-team.ru/maps/dev/core/environment/) для валидации до выкладки в стейбл.

### Поднимаем сервис в чистом окружении
На старте контейнера, прежде чем пытаться запустить сервис, нужно проверить, есть ли все необходимые датасеты на диске. Если хотя бы одного датасета нет, то запускать сервис не нужно, его должен поднять очередной хук экстатика.

При написании каждого хука убедитесь, что корректно обрабатываете ситуацию, когда сервис не запущен.

{% note warning %}

Статус `running` для yacare-сервиса не гарантирует, что сервис готов обслуживать запросы. Учтите это при загрузке датасетов через ручку в вашем сервисе.

Мы рекомендуем проверять готовность сервиса через [ручку `/ping`](#readiness-probe), и для надежности прописать [ретраи](../configs#retries) на активацию датасета в конфиге экстатика.

{% endnote %}

## Рецепты

### Сервис использует последние успешно активированные версии
Рассмотрим пример сервиса, который для работы использует последние активированные версии датасетов. В данном сценарии хосты, которые отстают от кворума, продолжает работать с доступной версией датасета. Нужно принять во внимание, что в этом случае возможны длительные периоды рассинхронизации в версии данных на кластере, пока хосты, отставшие от кворума, докачивают активную версию данных.

Для работы в таком режиме сервис должен на старте читать данные из `preserved_data`, а в хуках использовать `areRequiredPreservedDatasetsAvailable`. Не забудьте включить эту функциональность в конфиге агента экстатика.

Данный режим без дополнительных модификаций не подойдет для сервисов, которым важна синхронность версий датасета на кластере (например, для рендеринга тайликов).

Пример скрипта для запуска сервиса на старте контейнера:
```bash
#!/usr/bin/env bash
set -ex

ecstatic client run_with_local_lock -- bash -c '
set -ex

. /usr/lib/yandex/maps/ecstatic-support/switchlib.sh

if areRequiredPreservedDatasetsAvailable; then
    sudo -n yacare start <service> || {
        echo "Failed to start service. Abort"
        exit 1
    }
else
    echo "Some datasets are missing. Service not started"
fi
'
```

Пример `postdl`-хука для валидации данных:
```bash
#!/usr/bin/env bash
set -ex

if [ ! <service-binary> --validate-dataset "$ECSTATIC_VERSIONED_DATA_PATH" ]; then
    echo "Version $ECSTATIC_DATA_VERSION failed validation. Service not restarted"
    exit 1
fi
```

Пример `switch`-хука для активации новой версии:
```bash
#!/usr/bin/env bash
set -ex

. /usr/lib/yandex/maps/ecstatic-support/switchlib.sh

if [ -z "$ECSTATIC_DATA_VERSION" ]; then
    echo "Empty version is provided. Exiting."
    exit 0
fi

if areRequiredPreservedDatasetsAvailable; then
    echo "Activating version $ECSTATIC_DATA_VERSION. Restarting service..."

    sudo -n yacare restart <service> || {
        echo "Failed to restart service"
        exit 0  # check hook should handle it
    }

    echo "Done"
else
    echo "Some datasets are missing. Service not started"
fi
```

### Сервис использует только активные версии
Теперь рассмотрим пример сервиса, который использует только активные версии датасетов. В данном сценарии хосты, отставшие от кворума, должны отключиться от балансера, чтобы не отдавать пользователям устаревшие версии данных. Однако нужно принять во внимание, что для хостов, входящих в кворум, переключение не будет мгновенным, т.к. зависит от настройки [`switch in parallel`](../configs#switch-in-parallel) и времени выполнения `switch`-хука.

Для работы в таком режиме сервис должен на старте читать данные из `data`, а в хуках использовать `areRequiredDatasetsAvailable`. Если при запуске сервиса в директории `data` нет валидной симлинки, то нужно дождаться `switch`-хука c непустой версией, который запустит сервис.

Данный режим подойдет для сервисов, которым важна синхронность версий датасета на кластере (например, для рендеринга тайликов), при условии, что `switch`-хук выполняется не слишком долго, чтобы минимизировать время на переключение версии на всем кластере.

Пример скрипта для запуска сервиса на старте контейнера:
```bash
#!/usr/bin/env bash
set -ex

ecstatic client run_with_local_lock -- bash -c '
set -ex

. /usr/lib/yandex/maps/ecstatic-support/switchlib.sh

if areRequiredDatasetsAvailable; then
    sudo -n yacare start <service> || {
        echo "Failed to start service. Abort"
        exit 1
    }
else
    echo "Some datasets are missing. Service not started"
fi
'
```

Пример `postdl`-хука для валидации данных:
```bash
#!/usr/bin/env bash
set -ex

if [ ! <service-binary> --validate-dataset "$ECSTATIC_VERSIONED_DATA_PATH" ]; then
    echo "Version $ECSTATIC_DATA_VERSION failed validation. Service not restarted"
    exit 1
fi
```

Пример `switch`-хука для активации новой версии:
```bash
#!/usr/bin/env bash
set -ex

. /usr/lib/yandex/maps/ecstatic-support/switchlib.sh

if [ -z "$ECSTATIC_DATA_VERSION" ]; then
    sudo -n yacare detach <service> || {
        echo "Failed to detach service. Stopping..."
        sudo -n yacare stop <service> || :
    }
    echo "Done"
    exit 0
fi

if areRequiredDatasetsAvailable; then
    echo "Activating version $ECSTATIC_DATA_VERSION. Restarting service..."

    sudo -n yacare restart <service> || {
        echo "Failed to restart service"
        exit 1
    }

    echo "Done"
else
    echo "Some datasets are missing. Service not started"
fi
```

### Сервис использует последнюю доступную версию датасета
Иногда датасет обновляется очень часто (чаще, чем раз в 10 минут). В таком случае накладные расходы на синхронизацию переключения версии на кластере становятся критично большими. В этом сценарии, мы рекомендуем отказаться от `switch`-хуков совсем, и использовать `postdl` для обновления версий. Побочным эффектом будет полное отсутствие синхронизации, поэтому в хуках строго не рекомендуется рестартовать сервис, чтобы не положить весь кластер.

Кроме того, если на старте контейнера нужно запустить сервис, не дожидаясь очередного `postdl`-хука, то необходимо самостоятельно позаботиться о сохранении симлинки на актуальную версию датасета.

Также стоит учесть, что порядок запуска `postdl`-хуков не гарантирован, т.е. не стоит полагаться, что `postdl`-хуки вызываются по возрастанию версий датасета.

Данный режим подойдет для сервисов, которым нужна минимальная задержка между загрузкой датасета в экстатик и его началом его использования без гарантий консистентности используемых версий на всем кластере.

Пример скрипта для запуска сервиса на старте контейнера:
```bash
#!/usr/bin/env bash
set -ex

ecstatic client run_with_local_lock -- bash -c '
set -ex

CUSTOM_DATASET_PATH = "/<path>/<to>/<dataset>/<symlink>"

if [ -e "$CUSTOM_DATASET_PATH" ]; then
    sudo -n yacare start <service> || {
        echo "Failed to start service. Abort"
        exit 1
    }
else
    echo "Dataset is missing. Service not started"
fi
'
```

Пример `postdl`-хука для переключения данных:
```bash
#!/usr/bin/env bash
set -ex

CUSTOM_DATASET_PATH="/<path>/<to>/<dataset>/<symlink>"

if [ ! <service-binary> --validate-dataset "$ECSTATIC_VERSIONED_DATA_PATH" ]; then
    echo "Version $ECSTATIC_DATA_VERSION failed validation. Abort"
    exit 1
fi

get_current_version() {
    (readlink -q "$CUSTOM_DATASET_PATH" || echo <default>) | ...  # parse and return current version
}

# It's not guaranteed that postdl is called on the newest version
if [[ "$ECSTATIC_DATA_VERSION" < $(get_current_version) ]]; then
    echo "Version ($ECSTATIC_DATA_VERSION) is older than the existing one ($(get_current_version)). Skipping"
    exit 0
fi

echo "New version $ECSTATIC_DATA_VERSION passed validation. Making symlink..."
ln -fsT "$ECSTATIC_VERSIONED_DATA_PATH" "$CUSTOM_DATASET_PATH"

if (sudo -n yacare status <service> | grep -q "running"); then
    echo "Reloading dataset..."

    curl \
        -vv \
        --fail \
        --connect-timeout 10 \
        --write-out "Server responded with HTTP code %{http_code}\n" \
        -H "Host: <fqdn>" \
        -X POST "http://localhost/<endpoint>" \
    || {
        echo "Failed to reload dataset"
        exit 0
    }
else
    echo "Starting service..."
    sudo -n yacare start <service> || {
        echo "Failed to start"
        exit 1
    }
fi

echo "Done"
```

### Сервис использует все доступные версии
Иногда сервису необходимо уметь отвечать на запросы для всех версий датасета, которые есть в наличии на хосте, а не только для последней.

В таком случае сервис обычно поддерживает кэш для всех версий, добавляет новые в `postdl`-хуке, а удаляет в `remove`-хуке. При этом для запуска сервиса используется директория с симлинками на все валидные версии.

Если на момент старта сервиса директория c валидными версиями пуста, то
- либо сервис должен стартовать и отвечать 500-ку на /ping, пока не наберется необходимое число версий в памяти;
- либо сервис может дождаться ближайшего `postdl`-хука, который должен его стартовать.

В данном примере рассматривается первый вариант.

Скрипт для запуска сервиса на старте контейнера:
```bash
#!/usr/bin/env bash
set -ex

ecstatic client run_with_local_lock -- bash -c '
set -ex

sudo -n yacare start <service> || {
    echo "Failed to start service. Abort"
    exit 1
}
'
```

Пример `postdl`-хука для добавления версии данных:
```bash
#!/usr/bin/env bash
set -ex

DATASETS_DIR="/<path>/<to>/<datasets>/<directory>"

if [ ! <service-binary> --validate-dataset "$ECSTATIC_VERSIONED_DATA_PATH" ]; then
    echo "Version $ECSTATIC_DATA_VERSION failed validation. Abort"
    exit 1
fi

echo "New version $ECSTATIC_DATA_VERSION passed validation. Making symlink..."
ln -fsT "$ECSTATIC_VERSIONED_DATA_PATH" "$DATASETS_DIR/$ECSTATIC_DATA_VERSION"

echo "Adding new version $ECSTATIC_DATA_VERSION..."

curl \
    -vv \
    --fail \
    --connect-timeout 10 \
    --write-out "Server responded with HTTP code %{http_code}\n" \
    -H "Host: <fqdn>" \
    -X POST "http://localhost/<add_version>?version=$ECSTATIC_DATA_VERSION&path=$ECSTATIC_VERSIONED_DATA_PATH" \
|| {
    echo "Failed to add version"
    exit 0
}

echo "Done"
```

Пример `remove`-хука для удаления версии данных:
```bash
#!/usr/bin/env bash
set -ex

DATASETS_DIR="/<path>/<to>/<datasets>/<directory>"

echo "Removing version $ECSTATIC_DATA_VERSION..."

echo "Deleting symlink..."
unlink "$DATASETS_DIR/$ECSTATIC_DATA_VERSION"

curl \
    -vv \
    --fail \
    --connect-timeout 10 \
    --write-out "Server responded with HTTP code %{http_code}\n" \
    -H "Host: <fqdn>" \
    -X POST "http://localhost/<remove_version>?version=$ECSTATIC_DATA_VERSION" \
|| {
    echo "Failed to remove version"
    exit 0
}

echo "Done"
```
