[TOC]

### Что это
Roquefort — это тулза, которая парсит лог в формате tskv, считает разные метрики и отправляет в [Голован](https://yasm.yandex-team.ru) ([Документация](https://doc.yandex-team.ru/~search/~golovan), [Вики](https://wiki.yandex-team.ru/golovan/)).
Собирается в пакет yandex-maps-roquefort и входит в состав [карточного базового образа](https://a.yandex-team.ru/arc/trunk/arcadia/maps/infra/baseimage).

### Аргументы командной строки
Бинарник Roquefort-а лежит в /usr/bin/roquefort.
* ```--log``` путь к файлу с логом, по умолчанию ```/var/log/nginx/access-tskv.log```
* ```--config-dir``` путь к каталогу с конфигами, по умолчанию ```/etc/yandex/maps/roquefort```
* ```--profile``` тип лога, допустимые значения ```nginx-access-tskv```, ```counter```, по умолчанию ```nginx-access-tskv```
* ```--port``` номер порта, на котором Roquefort слушает запросы от Голована и отдаёт метрики, по умолчанию 7033
* ```--list-signals``` вывести список имён собираемых метрик и выйти
* ```--logs-to-stderr``` выводить логи в stderr вместо syslog-а

### Конфиги
Каталог с конфигами может содержать несколько файлов в формате json с именем вида ```{Имя сервиса}.conf```, которые имеют вид:
```
{
    "Имя группы графиков": {
        "Operation": { "field", "value" },
        "Options": { ... }
    }, ...
}
```

```Operation``` — одна из операций сравнения или агрегации.

Операции сравнения содержат словарь, единственным ключом которого является имя поля в tskv-логе, а значением по этому ключу – аргумент операции. Поддерживаются следующие операции:
* ```StartsWith```, ```EndsWith``` – значение в поле начинается/заканчивается с указанной строки
* ```Contains``` – значение в поле содержит указанную строку
* ```Equals``` – значение в поле равно указанной строке
* ```Regex``` – значение в поле удовлетворяет переданному регулярному выражению
* ```LessThan```, ```GreaterThan``` – значение поле <= / >= указанному значению (указывается в конфиге как строка)
* ```MatchUrl``` — то же самое, что ```Equals```, но сравнивает до первого ? и не учитывает последние /

Кроме этого, поддерживаются операции агрегации, аргументом которых является массив других операций:
* ```And``` – истинно, когда все аргументы истинны
* ```Or``` – истинно, когда хотя бы один аргумент истиннен
* ```Not``` – истинно, когда единственный аргумент ложен

```Options``` опционально, её содержание зависит от типа лога.

Сигналы в Головане имеют имя вида: ```roquefort-{Имя сервиса}_{Имя группы графиков}_{Имя графика}_{Суффикс}```.
[Суффикс](https://doc.yandex-team.ru/Search/golovan-quickstart/concepts/signal-aggregation.html) кодирует параметры агрегации в головане.

### access-лог nginx
При обработке access-лога nginx по умолчанию получаются следующие графики:
* rps – общее количество запросов на данную ручку
* ok – число запросов с кодами ответа от 200 до 299
* 3xx — число запросов с кодами ответа от 300 до 399
* 4xx – число запросов с кодами ответа от 400 до 499, кроме 404, 429 и 499
* 404 – число запросов с кодом ответа 404
* 429 – число запросов с кодом ответа 429
* 499 – число запросов с кодом ответа 499
* error – число запросов с кодами ответа от 500 до 599
* upstream_timings, request_timings – тайминги (отдаются в голован как гистограмма)
* bps – размер ответа
* xxx – кастомный код ответа (подробнее ниже)

Кроме того, словарь ```Options``` группы графиков может содержать:
* ```CustomHttp``` — массив дополнительных кодов ответа (числа), по которым надо нарисовать графики для этой группы
* ```Filters``` — словарь дополнительных фильтров для графика. Ключи — имена графиков, значения — операции сравнения или агрегации.
* ```BuiltinMetrics``` - список имен встроенных метрик, позволяет переопределить набор генерируемых по умолчанию графиков. При указании пустого списка стандартные метрики не создаются. 

Кроме того, считаются также графики вида ```roquefort-total_{Имя графика}_{Суффикс}``` – графики по всем запросам на машинку.

#### Пример
Пусть конфиг "my-service.conf" содержит
```
{
    "my-super-handle-name": {
        "StartsWith": {
            "request_url": "/my-super-handle"
        }
        "Options": {
            "CustomHttp": [401, 403],
            "Filters": {
                "4xx": {
                    "Not": [{"Equals": {"status": "401"}}]
                }
            }
        }
    }
}
```
По этому конфигу по умолчанию будут построены графики запросов на ручку /my-super-handle с именами ```roquefort-my-service_my-super-handle_{rps,ok,3xx,404,429,499,error,bps}_ammv```, ```roquefort-my-service_my-super-handle_{upstream,request}_timings_ahhh```. Кроме того, будут построены графики ```roquefort-my-service_my-super-handle_{401,403}_ammv``` соответствующих кодов ответа, а при подсчёте значений сигнала ```roquefort-my-service_my-super-handle_4xx_ammv``` будут игнорироваться запросы с кодом ответа 401.

Фильтрация нескольких статусов
```
"StartsWith": {
    "request_url": "/datasync"
},
"Options": {
    "CustomHttp": [
        409,
        410
    ],
    "Filters": {
        "4xx": {
            "And": [
                {
                    "Not": [
                        {
                            "Equals": {
                                "status": "409"
                            }
                        }
                    ]
                },
                {
                    "Not": [
                        {
                            "Equals": {
                                "status": "410"
                            }
                        }
                    ]
                }
            ]
        }
    }
}
```

Переопределение стандартного набора метрик
```
"StartsWith": {
    "request_url": "/datasync"
},
"Options": {
    "CustomHttp": [409],
    "BuiltinMetrics": ["rps", "upstream_timigs"],
    "Filters": {
        "4xx": {
            "And": [
                {
                    "Not": [
                        {
                            "Equals": {
                                "status": "409"
                            }
                        }
                    ]
                }
            ]
        }
    }
}
```

#### Интеграция с yacare
Roquefort интегрирован с [yacare](https://a.yandex-team.ru/arc/trunk/arcadia/maps/infra/yacare/), благодаря чему конфиг генерится автоматически.
В качестве параметра `{Имя сервиса}` будет имя бинарника (аргумент PROGRAM в ya.make).

В коде серванта можно указывать дополнительные коды ответа, чтобы получить по ним метрики. 
Например, для одной ручки:
```cpp
YCR_RESPOND_TO("testapp:/custom_http_code", YCR_CUSTOM_METRICS(418))
{...}
```
Или для всех ручек сразу:
```cpp
YCR_ADD_DEFAULT_METRICS(451, yacare::Status::ServiceUnavail);
```

Можно указывать больше одного кода ответа за один раз, графики появятся для кодов ответа по отдельности. Также можно указывать код ответа как в виде числа, так и в виде значения [enum-а из yacare](https://a.yandex-team.ru/arc/trunk/arcadia/maps/infra/yacare/include/http_codes.h).

Можно считать отдельные графики по аргументам. Для этого надо написать конструкцию вида:
```cpp
YCR_RESPOND_TO("testapp:/roquefort-args-test",
    YCR_ARGUMENT_METRICS({"arg1", {"value1", "value2"}}, {"arg2", {"value3", "value4", "value5"}}))
{}
```
Будут сгенерированы метрики вида ```roquefort-testapp_/roquefort_args_test/value1@arg1/value3@arg2_ok_ammv, roquefort-testapp_/roquefort_args_test/value1@arg1/value3@arg2_request_timings_ahhh```. 
Совместимо с ```YCR_CUSTOM_METRICS```.

На одной машинке можно размещать несколько yacare-сервисов, в том числе с одинаковыми ручками. Для того, чтобы различать такие ручки, в конфиге nginx, сгенерированном yacare, выставляется переменная ```$service_name```, которая должна попадать в лог. Если по какой-то причине этого не происходит, метрики получаются нулевыми. Если у вас один yacare-сервис и вам не нужна эта логика, то её можно выключить, написав на верхнем уровне вложенности ```YCR_NOT_FILTER_HANDLES_BY_SERVICE()```.

### Кастомный tskv-лог
При передаче ```--profile=counter``` при запуске Roquefort-а, считаться будут строки, удовлетворяющие фильтрам. Словарь ```Options``` может содержать поле ```Suffix```, переопределяющее суффикс сигнала (по умолчанию ```ammv```). Имя графика всегда ```ps```.

### Технические подробности
Roquefort предоставляет [stat-ручку](https://wiki.yandex-team.ru/golovan/stat-handle/) для голована по любому урлу. В itype maps roquefort уже добавлен.

Roquefort также предоставляет несколько сигналов, которые можно использовать для мониторингов или дебага:
* ```roquefort-parsing_time_axxv``` — время парсинга логов, накопленных за 5 секунд (должно быть меньше 5 секунд)
* ```roquefort-line_read_ammv``` — количество прочитанных строк лога в секунду
* ```roquefort-parse_errors_ammv``` — количество строк в секунду, которые не удалось распарсить как tskv
