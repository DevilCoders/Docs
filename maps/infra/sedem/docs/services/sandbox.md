# Управление sandbox-задачами через sedem

## Введение

Sedem поддерживает релизы и умеет настраивать мониторинги для [бинарных сандбокс-задач](https://docs.yandex-team.ru/sandbox/dev/binary-task). Реализован [стандартный релизный цикл](../releases#flow), где каждый стейдж может содержать несколько [шедулеров](https://docs.yandex-team.ru/sandbox/schedulers) и/или [шаблонов задач](https://docs.yandex-team.ru/sandbox/templates).

Релиз сандбокс-задачи определяется конкретной ревизией кода в Аркадии и включает в себя набор значений параметров для каждого шедулера/шаблона, который описывается в коде задачи.

### Бинарные задачи
Седем использует [бинарные сандбокс-задачи](https://docs.yandex-team.ru/sandbox/dev/binary-task), которые можно релизить независимо от транка сандбокса. Они также [поддерживают третий питон](https://docs.yandex-team.ru/sandbox/dev/binary-task#python3) и [могут располагаться в любом месте Аркадии](https://docs.yandex-team.ru/sandbox/dev/binary-task#everywhere).

Кроме того, бинарные задачи используют обычную аркадийную сборку, а значит могут линковаться с произвольным кодом в аркадии, и при необходимости содержать [вкомпиленные бинарники](#binary-resource) на других языках.

### Параметры задач
Cедем берет на себя доставку значений параметров для всех описанных в коде задачи (и перечисленных в конфиге сервиса) шедулеров или шаблонов. Для этого разработчику необходимо [описать значения параметров](#task-spec) в коде задачи. При релизе данной версии кода седем автоматически подставит значения параметров в соответствующий шедулер/шаблон.

### Работа с секретами
Помимо обычных параметров, сандбокс-задачи умеют работать с секретами [из yav](https://docs.yandex-team.ru/sandbox/dev/secret). Седем также поддерживает работу с yav-секретами: достаточно указать в коде задачи идентификаторы секретов вместе со значениями обычных параметров. Тогда при деплое седем выдаст сандбоксу права на чтение секретов при условии, что автор деплоя сам имеет эти права.

{% note alert %}

При работе с шедулерами автор релиза должен позаботиться о том, чтобы робот, от имени которого запускается задача, имел права на чтение всех yav-секретов, используемых в коде. Подробнее об этом ниже.

{% endnote %}

## Создание сандбокс-задач

{% note tip "TL;DR" %}

1. Поместить код задачи в `__init__.py` в директории `task`
2. Отнаследовать класс задачи от `SedemManagedMixin` и заполнить релизную спеку в коде задачи
3. Указать в `task/ya.make` директиву `SANDBOX_PY3_TASK` и тип таски в качестве имени бинарника
4. Положить директорию с sedem-конфигом рядом с директорией `task`
5. Сгенерировать `a.yaml` по sedem-конфигу
6. Закоммитить
7. Делегировать CI права на секрет из `a.yaml`-конфига
8. Дождаться, когда отработает сборка
9. Можно релизить!

{% endnote %}

### Организация директории с кодом задачи
Бинарные задачи не привязаны к директории `sandbox/projects`, поэтому рекомендуется размещать код задачи рядом с кодом сервиса, к которому она имеет отношение. Либо завести выделенную директорию, если задача выполняет какую-то независимую работу.

Пример организации кода в директории с задачей:
```
.
├── lib
│   ├── ...
│   └── ya.make  # PY3_LIBRARY
├── task
│   ├── __init__.py
│   └── ya.make  # SANDBOX_PY3_TASK
├── tests
│   ├── ...
│   └── ya.make  # PY3TEST
├── sedem_config
│   └── __all__.yaml
├── a.yaml
├── README.md
└── ya.make
```

{% note alert %}

Седем накладывает следующие ограничения на структуру директории с задачей:
1. `ya.make` задачи c директивой `SANDBOX_PY3_TASK` должен находиться в директории с именем `task` рядом с директорией `sedem_config`
2. `a.yaml` с конфигурацией [покоммитной сборки](../releases.md#autobuild) должен располагаться рядом с директорией `sedem_config`

{% endnote %}

Пример `ya.make`, описывающего бинарную сандбокс-задачу:
```
SANDBOX_PY3_TASK(EXAMPLE_TASK)

OWNER(...)

PY_SRCS(
    __init__.py
)

PEERDIR(
    ...
    maps/infra/sandbox
    sandbox/sdk2
)

END()
```

{% note alert %}

Седем требует, чтобы имя бинарника с задачей (аргумент директивы `SANDBOX_PY3_TASK`) в точности совпадало с типом задачи, для которой нужно извлекать параметры.
Тип задачи выводится сандбоксом из имени класса: `class ExampleTask` -> `EXAMPLE_TASK`. Подробнее об этом ниже.

{% endnote %}

### Код задачи и значения параметров { #task-spec }
Для того, чтобы релизить задачу с помощью седема, необходимо отнаследовать её от [миксины `SedemManagedMixin`](https://a.yandex-team.ru/arc/trunk/arcadia/maps/infra/sandbox/sedem_mixin.py?rev=r8567974#L10).
Миксина:
- форсит использование [мультислотовых агентов](https://docs.yandex-team.ru/sandbox/agents#slots);
- включает поддержку yav-секретов;
- позволяет задать значения параметров для шедулеров/шаблонов;
- автоматически отправляет juggler-алерт при неуспешном завершении задачи;
- поддерживает отправку произвольных juggler-алертов.

Значения параметров для шедулеров/шаблонов задаются в класс-методе `release_spec` класса `Parameters` в коде задачи - в релизной спеке.

Шедулеры и шаблоны с точки зрения релизной модели являются деплой-юнитами - минимальной единицей деплоя, которая может релизиться независимо. Для того, чтобы задать значения параметров, необходимо создать инстанс деплой-юнита с помощью метода `add_deploy_unit` релизной спеки, указав имя для будущего шедулера/шаблона. Это же имя нужно будет прописать в соответствующей секции конфига седема (об этом ниже).

{% note info %}

Имя деплой-юнита является некоторым аналогом окружения в няне и используется для адресации отдельных шедулеров/шаблонов седемом, каждый из которых получает полное имя по следующей схеме: `MAPS_{subsystem}_{service_name}_{deploy_unit_name}` (`MAPS_CORE_EXAMPLE_TASK_SCHEDULER_STABLE`).

{% endnote %}

Сами значения параметров задаются в виде атрибутов деплой-юнита: имя атрибута соответствует имени параметра, для которого указывается значение. Если для какого-то параметра значение не будет указано, то будет использован дефолт, заданный при объявлении параметра.
Если дефолтное значение у параметра в явном виде не указано, то используется неявный дефолт (пустая строка для строковых параметров, 0 для целочисленных, `None` для сложных типов и т.п.). Детали поведения можно посмотреть [в тестах](https://a.yandex-team.ru/arc/trunk/arcadia/maps/infra/sandbox/tests/release_spec_test.py?rev=r8567974#L37).

```python
from maps.infra.sandbox import SedemManagedMixin, ReleaseSpec
from sandbox import sdk2


class ExampleTask(SedemManagedMixin, sdk2.Task):
    class Parameters(SedemManagedMixin.Parameters):
        secret_parameter = sdk2.parameters.YavSecret('Some secret', required=True)
        custom_parameter = sdk2.parameters.String('Some string', required=True, default='no so custom')

        @classmethod
        def release_spec(cls) -> ReleaseSpec:
            spec = super().release_spec()

            stable_scheduler = spec.add_deploy_unit('scheduler_stable')
            stable_scheduler.secret_parameter = 'sec-01f7krcegs09h8z5m0zbjcj2d3'
            stable_scheduler.custom_parameter = 'some value for scheduler'

            testing_template = spec.add_deploy_unit('template_testing')
            testing_template.secret_parameter = 'sec-01f7partgzbv7c73r3mm2mpgyr'
            testing_template.custom_parameter = 'another value for template'

            return spec
```

Релизная спека задачи извлекается на этапе сборки и будет использована седемом при релизе данной версии кода в выбранный стейдж.

{% note info %}

Посмотреть релизную спеку можно, собрав бинарник с задачей и запустив команду извлечения спеки:
```bash
$ ya make -r ./task
$ Y_PYTHON_ENTRY_POINT=maps.infra.sandbox.inspect:extract_params ./task/EXAMPLE_TASK
```

{% endnote %}

{% note warning %}

Если релизная спека не содержит конфигурацию параметров для какого-либо шедулера/шаблона, указанного в конфиге седема, то при деплое такого релиза седем выдаст предупреждение:
`WARNING: Missing release spec for {deploy unit}: task parameters would not be updated`.

Необходимо добавить пропущенный шедулер/шаблон в релизную спеку и создать новый релиз, чтобы седем смог обновлять значения параметров этого шедулера/шаблона.

{% endnote %}

### Вкомпиливание исполняемых файлов в бинарник задачи { #binary-resource }
Иногда в коде задачи может потребоваться запустить бинарный исполняемый файл, например, написанный на другом языке. В таком случае можно вкомпилить данный бинарник в виде ресурса непосредственно в исполняемый файл с задачей, и запускать его как обычно, предварительно извлекая на диск.

{% note warning %}

В случае python или c++-кода мы рекомендуем воздержаться от вкомпиливания бинарников и линковаться с кодом напрямую (через cython для c++ кода), т.к. вкомпиливание бинарников сильно раздувает бинарник самой задачи.

{% endnote %}

Для того, чтобы вкомпилить бинарник в свою задачу, нужно добавить в `ya.make` с директивой `SANDBOX_PY3_TASK` следующие строчки:
```
BUNDLE(
    maps/infra/sandbox/tests/test_bin NAME binary_tool
)
RESOURCE(binary_tool my_binary)
```

После проделанных манипуляций можно будет извлечь бинарник в коде задачи и запустить, как обычный исполняемый файл:
```python
import subprocess

from maps.infra.sandbox import SedemManagedMixin, get_binary
from sandbox import sdk2


class ExampleTask(SedemManagedMixin, sdk2.Task):
    def on_execute(self) -> None:
        with get_binary('my_binary') as executable:
            subprocess.run([executable])
```

### Отправка мониторингов из кода задачи { #alerting }
Задачи, отнаследованные от `SedemManagedMixin`, поддерживают отправку алертов в [джагглер](https://docs.yandex-team.ru/juggler/). Из коробки такая задача будет автоматически поджигать алерт `task_failure`, если завершится с ошибкой.

{% note warning %}

Алерты отправляются только в том случае, если задача была запущена из шедулера (manual run тоже считается) или шаблона под управлением седема, т.к. для отправки алерта необходимо знать полное имя шедулера или шаблона.

{% endnote %}

Если в процессе исполнения задачи необходимо отправлять кастомные алерты, то можно воспользоваться методом `notify_juggler`:
```python
from maps.infra.sandbox import SedemManagedMixin, JugglerStatus
from sandbox import sdk2


class ExampleTask(SedemManagedMixin, sdk2.Task):
    def on_execute(self) -> None:
        self.notify_juggler(
            status=JugglerStatus.CRIT,
            alert_name='custom_alert',
            alert_description='Something bad happened',
        )
```

Такой алерт можно будет найти в джагглере [в секции сырых событий](https://juggler.yandex-team.ru/raw_events/) по полному имени шедулера/шаблона и имени алерта: `host={deploy_unit_name}&service={alert_name}` (например, `host=maps_core_example_task&service=custom_alert`). Подробнее о том, как получаются полные имена шедулеров и шаблонов, смотрите в разделе про [релизную спеку задачи](#task-spec).

Для того, чтобы получать нотификации о срабатывании алертов, не забудьте прописать имена кастомных алертов и настройки нотификаций в [конфиге седема](#sedem-config).

### Локальная сборка и запуск в сандбоксе
Сборка бинарных задач ничем не отличается от сборки любого аркадийного кода: достаточно собрать `ya.make` с директивой `SANDBOX_PY3_TASK`, чтобы получить бинарник, с которым далее нужно взаимодействовать.

Полученный бинарник позволяет загрузить результат сборки в сандбокс, а затем создать и запустить задачу на его основе. Подробнее о командах можно почитать в [инструкции от разработчиков](https://docs.yandex-team.ru/sandbox/dev/binary-task#cli-mode).

Пример команды, которая загрузит бинарник с задачей на сервера сандбокса и создаст задачу в статусе DRAFT:
```bash
./EXAMPLE_TASK run --enable-taskbox --type EXAMPLE_TASK --create-only
```

{% note alert %}

Наличие флага `--enable-taskbox` обязательно, иначе сервера сандбокса будут искать код задачи в транке в `sandbox/projects`.

{% endnote %}

После завершения загрузки будет выведена ссылка на задачу, по которой можно будет перейти, заполнить необходимые параметры (при локальной сборке значения из кода не извлекаются) и запустить задачу для тестирования.

### Sedem-конфиг

#### Имя sedem-сервиса
У всех седем-сервисов должны быть уникальные имена. В случае сандбокс-задач имя sedem-сервиса станет частью полного имени каждого шедулера/шаблона: `MAPS_{subsystem}_{service_name}_{deploy_unit_name}` (`MAPS_CORE_EXAMPLE_TASK_SCHEDULER_STABLE`).

#### ABC-сервис { #abc-service }
Все седем-сервисы нужно привязывать к ABC, и сандбокс-задачи не исключение. Для этого либо создайте новый abc-сервис, либо возьмите существующий (например, бывает логически оправдано, что няня-сервис и сэндбокс-задача привязаны к общему abc-сервису).

Имя для нового abc-сервиса следует выбирать по аналогии с тем, как это [делается для няня-сервисов](nanny.md#abc-service).

#### Сандбокс-группа и вычислительная квота
Все сандбокс-задачи при выполнении потребляют [некоторую квоту](https://docs.yandex-team.ru/sandbox/quota). Если не вдаваться в детали, то квота влияет на скорость извлечения задач из очереди на исполнение.
Квота закрепляется за [сандбокс-группами](https://docs.yandex-team.ru/sandbox/groups), и при работе задачи потребляемая ею квота аккаунтится на счет группы, указанной в поле `owner`.

Помимо квотирования сандбокс-группы отвечают еще и за разграничение прав - люди из группы могут редактировать задачи и шедулеры, где группа указана владельцем.

Все известные карточные сандбокс-группы собраны [на вики](https://wiki.yandex-team.ru/geo-infra/capacity/Sandbox/#accounts). Вам нужно выбрать группу из этого списка, либо создать новую и договориться с [@khrolenko](https://staff.yandex-team.ru/khrolenko) о выдаче квоты. Если вы затрудняетесь с выбором группы - обратитесь к вашему руководителю.

В выбранную сандбокс-группу должны входить:
- все ответственные за работу будущей задачи - рекомендуем включить сразу всех разработчиков из abc-сервиса, выбранного ранее (например, `maps-sandbox-example/development`; nb. саджест групп не работает, если указывать роль таким образом);
- abc-сервис [`maps-infra` (инфраструктура геосервисов)](https://abc.yandex-team.ru/services/maps-infra);
- abc-сервис [`maps-duty/dutywork` (общекарточный дежурный выходного дня)](https://abc.yandex-team.ru/services/maps-duty);
- все [роботы, от имени которых будут запускаться шедулеры](#scheduler-robot), если таковые имеются.

#### Робот для запуска шедулеров { #scheduler-robot }
Если вы используете сандбокс-задачу в виде шедулера, то вам понадобится роботный пользователь, от имени которого будут производиться регулярные запуски задачи.

Данный робот также должен иметь доступ на чтение всех использующих в задаче секретов, поэтому мы рекомендуем заводить хотя бы одного робота для команды на стаффе, а желательно отдельного робота под каждый скоуп задач.

[Инструкция по созданию роботов](https://wiki.yandex-team.ru/geo-infra/how-to/robots-and-secrets/).

{% note warning %}

Робота нужно [привязать в виде ресурса](https://wiki.yandex-team.ru/intranet/abc/docs/robots/#kakprivjazatrobota) к [ранее выбранному abc-сервису](#abc-service).

Для релиза шедулеров через Sedem также необходимо иметь роль "Управляющий роботами" или "Пользователь роботов" в выбранном abc-сервисе.

Если вы только создали робота и сразу указали целевой abc-сервис в формочке, то робот автоматически привяжется к abc-сервису в виде ресурса, а вам будет выдана роль "Управляющий роботами".

{% endnote %}

#### Заполнение седем-конфига { #sedem-config }
Создайте скелет седем-конфига: `ya tool sedem init {path to "task" directory parent}`. Конфиг нужно размещать непосредственно рядом с директорией `task`.

В нем нас будут интересовать только 3 секции внутри `__all__.yaml`: `main`, `deploy` и `resources`, остальное можно удалить.

Шаблон конфига:
```yaml
main:
    name: example-task  # Service name, must be unique
    subsystem: core  # Optional, "core" by default
    abc_service: {abc service slug}  # Will be deduced from service name if not passed: maps-core-example-task

deploy:
    type: sandbox
    sandbox:
        task_type: {custom task type}  # Will be inferred from service name if not passed: EXAMPLE_TASK
                                       # Should be consistent with task class: class ExampleTask -> EXAMPLE_TASK
        owner: MAPS-EXAMPLE-TASK  # Sandbox group - acl and task quota management

resources:
    stable:
        sandbox_schedulers:
            - name: scheduler_stable  # Full scheduler name will be MAPS_CORE_EXAMPLE_TASK_SCHEDULER_STABLE
              user: robot-maps-example  # Author for scheduled tasks, should have access to yav-secrets
              # Various scheduler settings, not required, see related docs section

    testing:
        sandbox_templates:
            - name: template_testing  # Full template name will be MAPS_CORE_EXAMPLE_TASK_TEMPLATE_TESTING
```

Имена деплой-юнитов, перечисленные в конфиге, должны содержаться в [релизной спеке задачи](#task-spec). В противном случае седем не сможет обновлять их параметры.
При этом разработчик в случае необходимости может выкатить (или откатиться на) релиз, в спеке которого не описан какой-либо из существующих деплой-юнитов.

Кроме того, при использовании шедулеров вам потребуется [робот, от имени которого будет запускаться задача](#scheduler-robot).
Также седем поддерживает различные настройки для шедулеров, такие как периодичность запуска, подробнее об этом [ниже](#scheduler-settings).

{% note warning %}

Если ваша задача отправляет [кастомные алерты в juggler](#alerting), вам нужно вписать их в секцию `alerts`.
[Инструкция по добавлению кастомных алертов](https://wiki.yandex-team.ru/geo-infra/sedem/faq/#ivsjotakikaksdelatalert).

{% endnote %}

{% note info %}

Настройка нотификаций для алертов (встроенных и кастомных) делается [как обычно](../monitorings/duty), только вместо окружений (как это было для няня-сервисов) в поле `staging` нужно писать имена шедулеров/шаблонов.

{% endnote %}

#### Параметры шедулеров в конфиге седема { #scheduler-settings }

Помимо обновления версии кода и параметров задачи седем дополнительно умеет обновлять параметры шедулеров. Для этого нужно указать их в соответствующей секции конфига.

Пример заполненной секции с параметрами шедулера:
```yaml
sandbox_schedulers:
  - name: scheduler_stable
    user: robot-maps-example
    description: Custom description for stable scheduler
    user_tags: [my_shiny_tag]
    schedule:
        start_time: 2020-01-01T12:00:00Z
        repetition_interval: 900  # secs
    kill_timeout: 600  # secs
    priority: SERVICE:HIGH
    notifications:
      - recipients: [geo-infra-notifications]
        task_statuses: [BREAK, FAILURE]
        scheduler_statuses: [FAILURE]
    semaphores:
        acquires: [SEMAPHORE_TO_ACQUIRE]
        release_in_statuses: [BREAK, FINISH, WAIT]
```

Все параметры являются необязательными, кроме `name` и `user`, про которые рассказывалось в [предыдущем разделе](#sedem-config).
Описание остальных параметров:
- `description` - описание шедулера, которое будет отображаться в UI сандбокса (задача наследует описание шедулера);
- `user_tags` - cписок тэгов, которые нужно навесить на шедулер (задача наследует все тэги шедулера);
- `schedule` - расписание запуска шедулера:
    - `start_time` - время (в ISO-формате), от которого отсчитываются запуски задач с учетом цикличности; по умолчанию задача будет запускаться сразу после любого обновления шедулера (в т.ч. при релизах);
    - `repetition_interval` - интервал в секундах между запусками; взаимоисключающая настройка с `repetition_weekly`;
    - `repetition_weekly` - cписок дней недели, по которым нужно запускать задачу в формате `[mon, thu, sun]`; взаимоисключающая настройка с `repetition_interval`;
    - `sequential_run` - флаг, запрещающий запускать следующую задачу до тех пор, пока не завершилась предыдущая, чтобы не допустить параллельную работу; по умолчанию `true`;
    - `fail_on_error` - остановить шедулер и перевести в состояние FAILURE при переходе задачи в статус FAILURE; по умолчанию false;
    - `retry_interval` - при переходе задачи в статус FAILURE запустить новую задачу через заданноe время;
- `kill_timeout` - таймаут выполнения задачи в секундах; по умолчанию 3 часа;
- `priority` - [приоритет](https://docs.yandex-team.ru/sandbox/tasks#priorities), с которым нужно запускать задачу; по умолчанию SERVICE:NORMAL;
- `notifications` - настройки email-нотификаций (другие типы нотификаций не поддерживаются - используйте [juggler-алерты](#alerting)):
    - `recipients` - cписок получателей: адреса конкретных сотрудников (как логины, так и полные адреса с `@yandex-team.ru`), адреса email-рассылок, sandbox-группы;
    - `task_statuses` - список [статусов/групп статусов задачи](https://docs.yandex-team.ru/sandbox/tasks#status), при переходе в которые нужно отправлять email;
    - `scheduler_statuses` - список [статусов шедулера](https://docs.yandex-team.ru/sandbox/schedulers#statuses), при переходе в которые нужно отправлять email;
- `semaphores` - настройки [семафоров](https://docs.yandex-team.ru/sandbox/semaphores), которые задача будет захватывать при запуске:
    - `acquires` - список имен семафоров, которые нужно захватить при исполнении задачи;
    - `release_in_statuses` - cписок статусов задачи, при переходе в которые нужно временно отпустить семафоры; по умолчанию используются все статусы из групп BREAK + FINISH + WAIT.

### Покоммитная сборка { #autobuild }

Последним этапом добавления новой задачи является [настройка покоммитной сборки](../releases#autobuild).

{% note alert %}

Без настроенной покоммитной сборки Sedem не сможет работать с вашей задачей.

{% endnote %}

### Первый релиз

После того, как покоммитная сборка завершится, задача появится в списке [кандидатов на релиз](../releases#release-info).

Далее задачу можно зарелизить [как обычно](../releases#release-start). Все шаблоны и шедулеры, указанные в конфиге, будут созданы в момент деплоя в соответствующий стейдж. Седем выведет в консоли ссылки на них.

## Удаление сандбокс-задач

0. Удалить `a.yaml`, чтобы отключить покоммитную сборку
1. Закоммитить в `filters.yaml` седем-конфига следующий фильтр, чтобы удалить все мониторинги:
  ```yaml
  alerts:
    - filter:
        service_name: '.*'
      body:
        disable: True
  ```
2. Удалить седем-конфиг
3. Удалить все шедулеры и шаблоны, которые были созданы седемом
4. Опционально удалить код
