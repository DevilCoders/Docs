# Управление няня-сервисами через Sedem

## Введение

Sedem умеет создавать новые няня-сервисы и ограниченно модифицировать существующие. В основном это касается прав доступа и [релизов docker-образов](../releases.md).

## Создание няня-сервисов

{% note tip "TL;DR" %}

1. Создать sedem-конфиг для вашего сервиса
2. Дождаться, когда Sedem создаст няня-сервисы
3. Выделить ресурсы для няня-сервисов и активировать их
4. Создать docker-образ вашего сервиса
5. Сгенерировать конфиг для покоммитной сборки
6. Убедиться, что первый коммит с докером-образом успешно собрался
7. Можно релизить!

{% endnote %}

### Sedem-конфиг

#### Имя сервиса { #service-name }

Имя сервиса в конфиге Sedem'а - это уникальный идентификатор, на основе которого будут названы связанные с сервисом сущности, в т.ч. няня-сервисы.

Полное имя собирается Sedem'ом по следующему правилу: `maps-{subsystem}-{service-name}` из соответствующих полей конфига сервиса.
`subsystem` сервиса определяется его принадлежностью к подразделению Геосервисов:
* `core` - [Геоплатформа](https://abc.yandex-team.ru/services/maps-core/)
* `auto` - [Яндекс.Авто/Нави](https://abc.yandex-team.ru/services/maps-auto/)
* `adv` - [Гео-медийная реклама](https://abc.yandex-team.ru/services/advgeo/)
* `b2bgeo` - [Бэкенд B2BGeo](https://abc.yandex-team.ru/services/maps-b2bgeo-backend/)
* `geoapp` - [Бэкенд Геоприложений](https://abc.yandex-team.ru/services/maps-front-geosearch/)

Пример: `maps-core-ecstatic-coordinator`.

#### ABC-сервис { #abc-service }

Все няня-сервисы под управлением Sedem'а нужно привязывать к ABC. [Каталог сервисов ABC](https://wiki.yandex-team.ru/intranet/abc/) управляет ресурсами и доступами вашего сервиса.

Для каждого нового няня-сервиса рекомендуется заводить отдельный abc-сервис c идентификатором (slug), совпадающим с именем сервиса из sedem-конфига, например, `maps-core-example`. В качестве родительского abc-сервиса нужно выбирать [сервис, соответствующий `subsystem`](#service-name), например, `maps-core`.

После создания abc-сервиса рекомендуется добавить себе роли разработчика и системного администратора, т.к. многие доступы выдаются только для этих ролей.

{% note warning %}

Для работы Sedem'а с вашим abc-сервисом добавьте в него робота `robot-maps-sandbox` с ролью "Робот".

Если для сервиса планируется заводить балансер, то также добавьте `nanny-robot` с ролью "Ответственный за L3".

{% endnote %}

#### Заполнение sedem-конфига { #sedem-config }

Выберите директорию, в которой хотите разместить конфигурацию вашего сервиса. В дальнейшем в неё добавится вложенная директория с описанием докер-образа (`docker`) и файл c конфигурацией CI (`a.yaml`).

Пример итоговой структуры директории:
```
service
├── bin
│   ├── ...
│   └── ya.make
├── docker
│   ├── ...
│   └── pkg.json
├── lib
│   ├── ...
│   └── ya.make
├── sedem_config
│   ├── __all__.yaml
│   └── ...
├── tests
│   ├── ...
│   └── ya.make
├── a.yaml
├── README.md
└── ya.make
```

{% note alert %}

Седем накладывает следующие ограничения: директория `docker`, содержащая `pkg.json` и `Dockerfile`, [директория `sedem_config`](#sedem-config) и `a.yaml` с конфигурацией [покоммитной сборки](../releases.md#autobuild) должны лежать на одном уровне в директории сервиса.

{% endnote %}

Создайте скелет конфига: `ya tool sedem init {path to service directory}`. Sedem автоматически сформирует вложенную директорию `sedem_config` с шаблоном sedem-конфига.

В нем нас будут интересовать 2 секции внутри `__all__.yaml`: `main` и `resources`, остальное можно оставить как есть.

Пример заполненного конфига:
```yaml
main:
    name: example-service  # Service name, must be unique
    subsystem: core  # Optional, "core" by default
    abc_service: {abc service slug}  # Will be deduced from service name if not passed: maps-core-example-service

resources:
    stable: {}
    testing: {}
```

В секции `resources` перечисляются [деплой-юниты (окружения)](../releases#glossary), для каждого из которых будет создан соответствующий няня-сервис. Не обязательно указывать сразу все требуемые окружения, их можно будет добавить позже по мере необходимости.

{% note info %}

Подробнее об этих и других секциях конфига смотрите в [разделе про конфиг](../config).

{% endnote %}

### Заказ ресурсов и запуск няня-сервисов

После коммита sedem-конфига для каждого деплой-юнита будет автоматически создан отдельный няня-сервис. Ссылки на них будут доступны на [странице сервиса](https://proxy.sandbox.yandex-team.ru/last/SEDEM_SERVICE_TOC/index.html) вскоре после коммита его конфига.

Далее для всех созданных няня-сервисов нужно самостоятельно выделить мощности (CPU, память, диск), на которых сервис будет развернут.

{% note info %}

Для выделения мощностей под няня-сервисы вам потребуется [запросить квоту в YP](https://wiki.yandex-team.ru/geo-infra/capacity/YP/) на ваш ABC-сервис, либо воспользоваться временной квотой (п. 3).

Временная квота дается на месяц, пока не станет понятно, какого именно размера инстансы нужны вашему сервису. Кроме того, во временной квоты может не хватить, если вы запросите слишком большие по CPU / памяти / диску инстансы.

Если вы не хотите или не можете использовать временную квоту, то для понимания, сколько ресурсов требуется запросить, рекомендуем выполнить первые 6 пунктов из инструкции ниже.

{% endnote %}

1. Зайдите в свежесозданный няня-сервис по ссылке из sandbox-задачи. Перейдите на вкладку "Create pods".

    {% cut "Иллюстрация" %}

    ![Create pods](https://jing.yandex-team.ru/files/vmazaev/2022-02-04_18-41.png =800x)

    {% endcut %}

2. Выберите локацию (aka YP cluster). Все карточные сервисы живут в трех локациях (датацентрах): SAS / MAN / VLA. Можете для начала выбрать любую из трех, в которой хотите развернуть окружение вашего сервиса.

3. Задайте количество инстансов (replicas count) в локации и выберите, откуда брать квоту (Use resource quota from) - ваш abc-сервис, либо временная квота (temporary junk account).

4. Задайте гарантию по CPU (CPU guarantee) и памяти (Memory guarantee). Обратите внимание, чтобы заказать 1 ядро CPU, нужно указать 1000 "миллисекунд в секунду процессорного времени" (2 ядра CPU - 2000 мс/сек и т.д.)

5. Укажите сетевой макрос (Network macro from racktables) в соответствии с именем сервиса: `_MAPS_{SUBSYSTEM}_{SERVICE}_{ENVIRONMENT}_RTC_NETS_` (для stable / prestable / dataprestable используется stable-макрос). Sedem создает все нужные макросы вместе с няня-сервисом, поэтому саджест должен вам подсказать доступные варианты.

6. Настройте дисковые разделы (volume settings):
    - Задайте настройки для корневого дискового раздела:
        - Root volume quota for single snapshot - минимум 1GB, используется под все изменения на диске, происходящие в процессе жизни контейнера (не считая тех, что попадают в рабочую директорию или персистентные разделы)
        - Work dir quota for single snapshot - минимум 1GB, используется для рабочей директории контейнера, куда в том числе пишутся некоторые внутренние логи няни
        - Storage - HDD или SSD, в зависимости от требований к сервису; в целом, можно брать HDD, т.к. критичные к скорости диска активности обычно выносят в соотв. персистентные разделы (например, запись логов)
        - Maximal snapshots count - 5 штук
        - Bandwidth guarantee / limit - ограничения на скорость чтения дискового раздела, для начала можно выставить дефолтные значения по кнопке. Также рекомендуем ознакомиться с [методикой расчета](https://wiki.yandex-team.ru/capacity-planning-team/io-order/#skolkomnezakazatiokvoty)
    - Задайте настройки персистентных дисковых разделов (persistent volumes):
        - Обязательный раздел под логи (`/logs`) нужного размера, типа (`HDD / SSD`) и пропускной способности (см. методику рассчетов выше) в зависимости от ожидаемой нагрузки на сервис
        - Раздел под данные экстатика (`/persistent`) - автомобильный граф / пробки, если используются, рекомендуется `SSD` и соотв. IO-квота, размер зависит от кол-ва и размера используемых датасетов

    {% note info %}

    Суммарная квота на размер диска одного инстанса вычисляется по формуле:
    `(work_dir_space + root_volume_space) * snapshots_count + logs_volume_space + persistent_volume_space`

    {% endnote %}

7. Нажмите "Allocate". Для получения инстансов в других локациях вы можете их скопировать, сменив локацию (YP cluster) и указав требуемое кол-во инстансов (replicas count). Для stable / prestable / dataprestable настоятельно рекомендуется выделять ресурсы во всех трех локациях, а для остальных окружений (кроме unstable) хотя бы в двух. Вы можете сами выбрать, как именно непродакшен окружения вашего сервиса будут раскиданы по локациям - это не принципиально.

    {% cut "Копирование инстансов" %}

    ![Copy pods](https://jing.yandex-team.ru/files/vmazaev/2022-02-04_18-54.png =800x)

    {% endcut %}

8. Перейдите на вкладку "Instances" и проставьте галочки напротив всех созданных инстансов во всех локациях, после чего сохраните полученную конфигурацию.

    {% cut "Добавление инстансов в снапшот" %}

    ![Add instances](https://jing.yandex-team.ru/files/vmazaev/2022-02-04_19-13.png =800x)

    {% endcut %}

9. Вернитесь на главную страницу няня-сервиса. В центре экрана находится список snapshot'ов. Выберите единственный доступный снапшот, нажмите "Change" и выберите "Active" в поле "Set target state".

    {% cut "Запуск няня-сервиса" %}

    ![Service general](https://jing.yandex-team.ru/files/vmazaev/2022-02-04_19-17.png =800x)

    ![Activation](https://jing.yandex-team.ru/files/vmazaev/2022-02-04_19-21.png =800x)

    {% endcut %}

По умолчанию няня-сервисы создаются с временным докер-образом. После запуска няня-сервиса нужно задеплоить туда docker-образ вашего сервиса.

### Создание docker-образа сервиса

Sedem работает с няня-сервисами, развернутыми из docker-образов. В docker-образ собирается все необходимое для работы сервиса. Все образы для Sedem'а строятся на основе [базового образа Геоплатформы](https://a.yandex-team.ru/arc/trunk/arcadia/maps/infra/baseimage/README.md).

Вам необходимо создать директорию `docker` рядом с директорией `sedem_config` и разместить в ней `pkg.json`, ссылающийся на `Dockerfile` рядом. Подробнее о его содержимом и структуре данных файлов смотрите в [документации по базовому образу](https://a.yandex-team.ru/svn/trunk/arcadia/maps/infra/baseimage/README.md#rekomenduemaya-struktura-direktorii-servisa-v-arkadii).

{% note alert %}

Содержимое `pkg.json["meta"]["version"]` должно быть в точности равно `"{revision}"` для корректного назначения версии собранному docker-образу.

{% endnote %}

#### Локальная сборка docker-образа (необязательный шаг)

Проверить, что ваш docker-образ собирается можно следующим образом: `ya package docker/pkg.json --docker --docker-network=host`

{% note info %}

Сборку docker-образа следует осуществлять на linux дев-машинке с установленным docker'ом: `apt-get install docker.io`
Перед первой сборкой нужно добавить пользователя в группу docker: `adduser $USER docker`, и заново залогиниться (перезайти).

{% endnote %}

По умолчанию в качестве версии для собранного докера будет взята версия локального репозитория (svn-ревизия или arc-хэш), это можно изменить с помощью ключа `--custom-version` при сборке.

{% cut "Загрузка локально собранного образа в docker-registry (не рекомендуется)" %}

Для сборки и последующей загрузки образа в docker-registry нужно выполнить следующую команду:
`ya package docker/pkg.json --docker --docker-network=host --docker-repository maps --docker-push`

{% note info %}

Перед первой загрузкой образа нужно:
- Получить [OAuth-токен](https://oauth.yandex-team.ru/authorize?response_type=token&client_id=12225edea41e4add87aaa4c4896431f1)
- Авторизоваться в docker-registry: `docker login -u $USER -p <YOUR_TOKEN> registry.yandex.net`

{% endnote %}

{% endcut %}

### Покоммитная сборка и первый релиз

Перед деплоем докер-образа в няня-сервисы нужно [настроить покоммитную сборку образа](../releases#autobuild) и дождаться, когда она завершится. Для отслеживания статуса можно [воспользоваться командой `release info`](../releases#release-info).

Затем достаточно запустить [команду для создания нового релиза](../releases#release-start), чтобы выкатить образ.

## Управление секретами няня-сервисов  { #secrets }

Sedem умеет прописывать в конфигурацию няня-сервиса секреты из [Cекретницы (yav)](https://yav.yandex-team.ru). Секреты могут доставляться в контейнеры в виде переменных окружения или в виде набора файлов в поддиректорию домашней директории (workdir) сервиса.

{% note alert %}

Sedem перезатирает все секреты, указанные в GUI няни и не представленные в конфиге сервиса.

{% endnote %}

Для задания секретов в sedem-конфиге необходимо добавить отдельный раздел `secrets` (по аналогии с разделами `main` и `deploy`).

Секрет идентифицируется уникальным идентификатором (`secret_id`) и версией (`version`). На выбор доступны 3 варианта доставки секрета:
- в виде директории (`dir`), где будут созданы файлы с именами, соответствующие "ключам" внутри секрета в yav, а их содержимое будет равно "значениям":
    ```
    dir_name
    ├─ key_1  # contains value_1
    └─ key_2  # contains value_2
    ```
- в виде переменной окружения (`env`), куда попадет значение секрета с указанным ключом (`key`);
- специальный вариант, требующий дополнительно указать tvm id (`self_tvm_id`), который положит в фиксированную переменную окружения `TVM_SECRET` значение секрета с указанным ключом (`key`).

Пример описания секретов:
```yaml
secrets:
  testing:
    - secret_id: sec-01dm0pj3xxn4gq19h4ze8zf2j8
      version: ver-01d16mfhm766cxjj7z0hr66gyd
      dir: dir_name  # No slashes, only directory name accepted
    - secret_id: sec-01dm0pj3xxn4gq19h4ze8zf2j8
      version: ver-01d16mfhm766cxjj7z0hr66gyd
      key: some_key
      env: ENV_NAME
    - secret_id: sec-01dm0pj3xxn4gq19h4ze8zf2j8
      version: ver-01d16mfhm766cxjj7z0hr66gyd
      key: the_tvm_secret
      self_tvm_id: 2000000
```

{% note warning %}

Робот `robot-maps-sandbox` должен иметь доступ на чтение указанных секретов.

{% endnote %}

{% note alert %}

После коммита sedem-конфига секреты сразу попадут в няню, но будут применены только при очередном релизе.

{% endnote %}

## Доступы { #permissions }

Sedem выдает доступы на няня-сервисы согласно своей [ролевой модели](../roles).

Маппинг [ролевой модели няни](https://docs.yandex-team.ru/nanny/how-to/create-service#setup-administrators) на роли Sedem'а:
- `Service owners` (ssh as root + assign roles + remove service) - `devops`;
- `Operation managers` (ssh as root + start/stop/deploy) - `duty`;
- `Configuration managers` (ssh as root + edit configuration) - `duty`;
- `Developers` (ssh as nobody) - `developers`.

## Нагрузочное тестирование (стрельбы) { #load-testing }

Нагрузочное тестирование сервисов производится регулярно: по расписанию раз в сутки и после каждого релиза сервиса в тестинг. Стандартной практикой является проведение двух тестов: (1) на разладку (с нарастающим RPS, пока сервис не перестанет справляться с нагрузкой), (2) на тайминги и выявление утечек памяти (постоянной нагрузкой, примерно совпадающей с нагрузкой на инстанс в продакшене). Если в вашем сервисе несколько ручек с сильно отличающимся временем ответов, нужно проводить независимые стрельбы на каждую из ручек.

Данная инструкция ориентирована на типовой сценарий нагрузочного тестирования, когда вашему сервису не требуется генерировать запросы перед каждым тестом и/или каким-либо образом готовить сам сервис (наливать базу данных и т.п.). Если же типовой сценарий вам не подходит, обратитесь к разделу про создание [кастомных стрельб](#custom-load-testing).

{% note tip "TL; DR" %}

+ Подготовьте запросы для тестирования (патроны). [Подробнее](#ammo-preparation)
+ Создайте пробную задачу нагрузочного тестирования `MAPS_GENERIC_LOAD_TESTING_TASK` [по инструкции](#manual-generic-task). Подберите параметры нагрузочных тестов, наиболее соответствующие вашим потребностям.
+ Добавьте в sedem-конфиг вашего сервиса [секцию `load_testing`](#multi-load-test-sedem-config), где перечислите нагрузочные тесты, которые будут прогоняться каждую ночь, а также в качестве [acceptance-тестов](../releases#acceptance) при выкатке нового релиза в testing.

{% endnote %}

### Подготовка запросов (патроны) { #ammo-preparation }

Нужно подготовить запросы для проведения нагрузочного тестирования, взяв, например, логи из продакшена вашего сервиса. Описание формата патронов можно найти в [документации к Yandex.Tank](https://yandextank.readthedocs.io/en/latest/tutorial.html#preparing-requests). Нормальным считается число патронов в 1 миллион запросов (файл с патронами — примерно 100 мегабайт). Если запросов в файле не хватит для полной стрельбы по выбранному профилю, танк самостоятельно «закольцует» ленту.

{% note info %}

Пример команды для извлечения GET-запросов из логов (если запросов не хватает, можно объединить логи за несколько дней):
`cat /var/log/nginx/access-tskv.log | grep vhost=$YOUR_SERVICE_VHOST | grep status=200 | cut -f 8 | sed 's/^request=//g' > ammo.log`

{% endnote %}

{% note info %}

Извлечение патронов из YT возможно с использованием [задачи GENERATE_AMMO_FROM_YT](https://wiki.yandex-team.ru/load/tanks-sandbox/#generateammofromyt). Права на чтение логов в YT можно получить через участников https://abc.yandex-team.ru/services/maps-core-accesslog-readers.

{% endnote %}

Патроны нужно залить в Sandbox, оттуда они будут извлекаться непосредственно при запуске теста. Для этого достаточно выполнить команду `ya upload ammo.log --ttl inf`. В результате выполнения команды получается ссылка вида `https://proxy.sandbox.yandex-team.ru/<resource_id>`. Эта ссылка используется в дальнейшей конфигурации нагрузочного теста.

### Ручной запуск нагрузочного тестирования { #manual-generic-task }

{% note tip %}

Вы можете [воспользоваться запуском «по кнопке»](#manual-load-test-sedem), если нагрузочное тестирование для вашего сервиса уже сконфигурировано в sedem-конфиге.

{% endnote %}

Если вам необходимо протестировать сервис вручную, например, в качестве эксперимента, то вы можете это сделать, создав задачу `MAPS_GENERIC_LOAD_TESTING_TASK` вручную:

1. Создайте задачу `MAPS_GENERIC_LOAD_TESTING_TASK` [из шаблона](https://sandbox.yandex-team.ru/template/MAPS_CORE_GENERIC_LOAD_TESTING_TEMPLATE/view), нажав на кнопку `Create new task`.
2. Заполните обязательные параметры:
   - `nanny_service_name` — имя сервиса в nanny, для которого нужно запустить стрельбы
   - `config` — часть sedem-конфига, соответствующая одному нагрузочному тесту. См. [конфиг одного нагрузочного теста](#single-load-test-config)
3. Также можно заполнить необязательные параметры:
   - `test_name` — имя теста. Известно в Lunapark Regression как `job_name`.
   - `slug` — известно в Lunapark Regression как «компонента».
   - `st_ticket` — тикет теста. Поле используется для загрузки результатов стрельб в Лунапарк.
   - `sla_rps` — если это поле не 0, задача проверит, произошла ли разладка при rps, большем или равном указанному в этом поле порогу, или нет.
4. Запустите задачу. Нагрузочный тест будет проведён через подзадачу Firestarter.

{% cut "Пример заполненных параметров" %}

![Пример заполненных параметров](../img/generic_task_params.png "Пример заполненных параметров")

{% endcut %}


#### Конфигурация одного нагрузочного теста { #single-load-test-config }

```yaml
load_profiles:
 - <профиль нагрузки в формате const(3, 3m) или line(1, 5, 5m) или step(1, 7, 3, 6m)>
 - <профиль нагрузки в формате const(3, 3m) или line(1, 5, 5m) или step(1, 7, 3, 6m)>
 ...
autostop:
 - <критерий остановки нагрузочного теста (подробнее по ссылке ниже)>
 - <критерий остановки нагрузочного теста (подробнее по ссылке ниже)>
 ...
ammo:
   type: <тип патронов (access, phantom, raw, uri, uripost)>
   url: <ссылка на патроны>
instances: <количество одновременных подключений (потоков), отправляющих запросы на мишень. Опциональное поле, дефолт: 1000>
tank_type: <тип танка (sandbox, rtc). Опциональное поле, дефолт: sandbox>

# Чтобы выбрать генератор нагрузки, обратитесь к разделу «Какой генератор нагрузки использовать?»
pandora: # Секция обязательна, если используется генератор нагрузки pandora
   protocol: <протокол (http, https или http2). Опциональное поле, дефолт: http>
phantom: # Секция обязательна, если используется генератор нагрузки phantom
   protocol: <протокол (http или https). Опциональное поле, дефолт: http>
   http_version: <версия http (1.0 или 1.1). Опциональное поле, дефолт: 1.1>
```

[Подробнее про критерии автостопа (остановки нагрузочного теста) в документации Yandex Tank](https://yandextank.readthedocs.io/en/latest/core_and_modules.html?highlight=autostop#basic-criteria-types)

{% cut "Пример заполненных параметров" %}

![Пример заполненных параметров](../img/generic_task_params.png "Пример заполненных параметров")

{% endcut %}


#### Какой генератор нагрузки использовать?

Преимущества генератора нагрузки pandora:

+ Не тратит время перед тестом на генерацию и складывание на диск каждого отдельного запроса нагрузочного теста. Это позволяет сэкономить десятки минут и гигабайты диска.
+ Умеет в http/2.

Преимущества генератора нагрузки phantom:

+ Может давать более стабильную нагрузку в условиях разладки, и следовательно более стабильный RPS разладки.


### Автоматическое нагрузочное тестирование

Есть два вида автоматизации нагрузочного тестирования:

+ Нагрузочные тесты автоматически прогоняются каждую ночь [шедулером](https://sandbox.yandex-team.ru/scheduler/702021/view)
+ Нагрузочные тесты автоматически добавляются к acceptance-тестам `testing`-стейджа релизов. [Подробнее про acceptance-тесты](../releases#acceptance)

Для того, чтобы к ним подключиться, пропишите тесты в sedem-конфиге. Далее описана схема и примеры.

#### Схема секции нагрузочного тестирования в sedem-конфиге { #multi-load-test-sedem-config }

```yaml
load_testing:
    st_ticket: <тикет по умолчанию в StarTrek. Рекомендуем заводить его в очереди сервиса>
    tests:
        <имя нагрузочного теста. Допустимые символы `[A-Za-z-_/ ]`>:
            slug: <компонент. Опционален. По умолчанию равен 'sedem-service-name test_name'. Допустимые символы `[A-Za-z-_/ ]`>
            st_ticket: <тикет теста в StarTrek. Рекомендуем заводить его в очереди сервиса. Опциональное поле>
            sla_rps: <порог разладки RPS. Успешный нагрузочный тест — тот, в котором разладка наступила при rps >= sla_rps_threshold>

            # секция обязательна в обычном случае, то есть если нагрузочный тест проводится посредством задачи `MAPS_GENERIC_LOAD_TESTING_TASK`
            generic_load_config:
                ...  # Конфигурация одного нагрузочного теста (см. одноимённый раздел. Ссылка под этим блоком кода)

            # секция обязательна в нестандартном кейсе, когда нагрузочный тест проводится посредством кастомной задачи
            custom_load_config:
               task_template: <имя шаблона кастомной задачи нагрузочного тестирования>
```

+ [Конфигурация одного нагрузочного теста](#single-load-test-config)

+ Примеры настроенных разделов нагрузочного тестирования sedem-конфигов:
    + [С нагрузочными тестами через `MAPS_GENERIC_LOAD_TESTING_TASK`](https://a.yandex-team.ru/arc/trunk/arcadia/maps/infra/teapot/sedem_config/load_testing.yaml?rev=r9253673)
    + [С нагрузочными тестами через кастомную задачу](https://a.yandex-team.ru/arc/trunk/arcadia/maps/infra/ecstatic/coordinator/sedem_config/__all__.yaml?rev=r9253673#L10)


#### Ручной запуск нагрузочных тестов, описанных в sedem-конфиге сервиса { #manual-load-test-sedem }

Можно запустить один или все из нагрузочных тестов, описанных в sedem-конфиге сервиса, двумя способами.

Способ «по кнопке»:

1. Зайдите на страницу сервиса [SEDEM_SERVICE_PAGE](https://proxy.sandbox.yandex-team.ru/last/SEDEM_SERVICE_TOC/index.html)
2. Если в sedem-конфиге определены нагрузочные тесты, на странице будет таблица, где они перечислены.
3. В таблице нажмите кнопку `Запустить` в строке требуемого нагрузочного теста.

Способ «ручной»:

1. Создайте задачу `MAPS_COMMON_LOAD_TESTING_TASK` [из шаблона](https://sandbox.yandex-team.ru/template/MAPS_CORE_COMMON_LOAD_TESTING_TEMPLATE/view), нажав на кнопку `Create new task`.
2. Заполните параметр `sedem_service_name` — укажите там имя сервиса, у которого в sedem-конфиге описана конфигурация нагрузочных тестов.
3. Если вы хотите запустить один конкретный тест — снимите галочку `all_tests_in_service` и заполните параметр `test_name`.
4. Запустите задачу. Она создаст подзадачи на каждую запускаемую стрельбу.


### Мониторинги SLA нагрузочных тестов { #load-test-sla-monitorings }

Sedem создаёт для load-окружения сервиса событийный мониторинг load_test_sla. Мониторинг находится в состоянии WARN, если последний нагрузочный тест завершился, не удовлетворив SLA. После этого мониторинг будет гореть, пока не пройдёт нагрузочный тест, удовлетворяющий SLA. При отсутствии данных (нагрузочных тестов не проводится или они сломаны) мониторинг перейдёт в состояние OK через двое суток.

Вы можете подписаться на этот мониторинг. Пример подписывания чатов в Telegram и Slack:

```yaml
# sedem_config/filters.yaml
alerts:
  - filter:
      staging: load
      service_name: load_test_sla
    body:
      notifications:
        - type: telegram
          login: [your-chat-name]
          status: [CRIT,WARN]
        - type: slack
          chats:
            - name: your-channel-name
              link: https://yndx-maps-platform-or-another-workspace.slack.com/archives/YOURCHANNELID
          status: [CRIT,WARN]
```

{% note tip "Использование Telegram и Slack" %}

Общая инструкция по подписке на любые мониторинги в Telegram и Slack [здесь](../monitorings/duty#notifications)

{% endnote %}


### Нестандартные сценарии нагрузочного тестирования { #custom-load-testing }

Для нестандартных сценариев нагрузочного тестирования мы рекомендуем воспользоваться нашей базовой задачей [MapsLoadTestingBaseTask](https://a.yandex-team.ru/arc/trunk/arcadia/maps/infra/sandbox/load_testing/base.py), и на её основе реализовать кастомную сандбокс-задачу для проведения нагрузочного тестирования.

В частности, к нестандартным сценариям относятся:
- кастомный способ получения конфигов из Аркадии
- подготовка мишени к нагрузочному тесту
- очистку состояния мишени после нагрузочного теста

Шаги создания и использования кастомной задачи:

1. Для создания сандбокс-задачи [воспользуйтесь инструкцией](sandbox.md).

2. Унаследуйте класс задачи от [MapsLoadTestingBaseTask](https://a.yandex-team.ru/arc/trunk/arcadia/maps/infra/sandbox/load_testing/base.py).

3. Переопределите методы.

    + Методы, которые нужно переопределить:
        + `get_config` — метод, формирующий конфиг нагрузочного теста для Firestarter. На вход ему подаётся множество параметров для подстановки в конфиг Firestarter'а. [Полный список этих параметров в Аркадии](https://nda.ya.ru/t/p91xSgfn4sQQ3z). Чтобы не перечислять их все, можно воспользоваться следующей сигнатурой:

    ```python3
    def get_config(
        self,

        # параметры, которые вы хотите использовать для своих нужд, например:
        test_name,
        slug,

        # остальные параметры, которые можно без изменений передать дальше в jinja-шаблон, как в примере ниже
        **kwargs
    ) -> str:
        ...
    ```

    + Методы, которые переопределять не обязательно:
        + `prepare_target(self, target: str) -> None` — подготовить мишень теста `target`
        + `cleanup(self, target: str) -> None` — очистить мишеть `target` после теста
        + `get_target(self) -> str` — получить fqdn мишени. По умолчанию берётся случайный хост из nanny-сервиса `nanny_service_name`.

4. Сконфигурируйте секцию `load_testing` в sedem-конфиге вашего сервиса.
    + [Схема конфига](#multi-load-test-sedem-config)
    + [Пример настроенного sedem-конфиг с нагрузочными тестами через кастомную задачу](https://a.yandex-team.ru/arc/trunk/arcadia/maps/infra/ecstatic/coordinator/sedem_config/__all__.yaml?rev=r9253673#L10)
