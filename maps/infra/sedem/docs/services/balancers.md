# Управление балансерами через Sedem
На текущем этапе развития Sedem взял на себя большую часть функций по заведению и управлению конфигурацией балансеров.

Под капотом Sedem использует API системы управления балансерами [AWACS](https://wiki.yandex-team.ru/cplb/awacs/), и позволяет до некоторой степени абстрагироваться от происходящего внутри. Однако, мы рекомендуем ознакомиться с [терминологией AWACS](https://wiki.yandex-team.ru/cplb/awacs/terminology/#predmetnajaoblastawacs) перед тем, как продолжить чтение этого раздела.

## Создание балансера { #creation }
Создание балансера во многом автоматизировано. На текущий момент все балансеры в Картах создаются по одинаковому шаблону. В частности, мы используем связку [L3-балансер + L7-балансер](https://wiki.yandex-team.ru/cplb/awacs/tutorial/#kakiebalanceerysushhestvujut) и плоский список бэкендов во всех датацентрах. В такой схеме траффик равномерно распределяется по всем бэкендам во всех локациях.

{% note alert %}

Для создания балансера необходимы живые и работающие бэкенды.

{% endnote %}

{% note tip "TL;DR" %}

1. Добавить балансер в конфиг сервиса
2. Закоммитить конфиги седема
3. Дождаться ревью от робота с конфигами балансера и закоммитить его
4. Прописать dns-запись для нового балансера
5. Выдать сетевые доступы (дырки)
6. (Опционально) заказать сертификат для https и раскатить конфиги с ним
7. Проверить работоспособность балансера

{% endnote %}

### Добавление балансера в конфиг сервиса
Для того, чтобы поднять балансер с нуля, нужно прописать в секции `main` конфига сервиса следующее:
```
balancer:
   <staging>:
       - common: (true|false)
         name: <custom-name>
         fqdn: <custom-fqdn>
         instances_count: <N>
         instance_size: (nano|micro|small|medium)
         datacenters: [<SAS|MAN|VLA>, ...]
         protocol: (http|https|http_and_https)
         traffic_type: <internal|external>
```
Большая часть этих параметров опциональна, и их стоит указывать только, если дефолтные значения не подходят.

{% note info %}

Можно создавать балансеры для разных стейджингов. Более того, можно создавать несколько балансеров на стейджинг, например, один внешний, другой внутренний.

{% endnote %}

* `common` - флаг, который определяет, нужно ли вместо заведения выделенного балансера использовать коммунальный балансер Карт для соотвествующего стейджинга. На текущий момент можно использовать коммунальные балансеры для следующих стейджингов: "unstable", "testing", "datatesting", "datavalidation", "datatestingvalidation".
* `name` - имя балансера, по умолчанию "default". Нужно переопределять, если больше 1 балансера на стейджинг. Используется в мониторингах и на панели в Головане.
* `fqdn` - задает доменное имя балансера и имя неймспейса в AWACS. Указывать необходимо, если у вас больше 1 балансера на стейджинг, в других случаях переопределять не рекомендуется. По умолчанию fqdn будет соответствовать [naming guide](https://proxy.sandbox.yandex-team.ru/last/SEDEM_COMMON_DOCS/naming_guide.html?attrs=%7B%22released%22:%20%22stable%22%7D).
* `instances_count` - обязательный параметр, кол-во инстансов балансера в каждом ДЦ. [Рассчитывается, исходя из ожидаемого rps](#capacity). Не имеет смысла для коммунального балансера.
* `instance_size` - соответствует [пресетам](https://wiki.yandex-team.ru/cplb/awacs/tutorial/presets/) awacs на размер пода. [Рассчитывается, исходя из ожидаемого rps](#capacity). По умолчанию "micro". Не имеет смысла для коммунального балансера.
* `datacenters` - датацентры, в которых нужно развернуть балансер. По умолчанию Sedem берет список датацентров, где развернуты бекенды (в частности, поэтому балансер надо начинать создавать, когда уже развернут бекенд). Не имеет смысла для коммунального балансера.
* `protocol` - протокол работы балансера, по умолчанию "http". Не имеет смысла для коммунального балансера. Создание https-балансера требует [дополнительной донастройки](#enable_https).
* `traffic_type` - сделать балансер [внешним или внутренним](#internal_and_external). Не имеет смысла для коммунального балансера. По умолчанию балансер создается внутренним.

{% note alert %}

Учтите, что на FQDN сервисного балансера со стороны SEDEM накладывается ограничение в 61 символ. Если длина FQDN не укладывается в это ограничение, то нужно явно задать имя, которое будет удовлетворять требованиям. Для коммунального карточного балансера таковые ограничения не действуют.

{% endnote %}

{% note warning %}

Убедитесь, что в abc-группе сервиса хватит YP-квоты на запрошенный конфиг. Рассчитать требуемую квоту можно, исходя из запрошенного кол-ва инстансов и выбранного [пресета](https://wiki.yandex-team.ru/cplb/awacs/tutorial/presets/).

{% endnote %}

{% note info %}

Все указанные в этом разделе параметры нужны только для первичного заведения балансеров, в дальнейшем их наличие ни на что не влияет, т.к. подобные изменения конфигурации балансеров пока не поддерживаются седемом.

{% endnote %}

#### Требования к запасу ресурсов для балансера { #capacity }
Считается, что один воркер балансера (1 воркер == 1 ядро ЦПУ) может обработать до 1k rps в простом случае и 500-800 rps в более сложных.

С учетом особенностей облака (возможность выпадения хостов, деградация всех контейнеров, если на хостовой машине использование > 50%) и запаса для переконфигурация балансеров и пиков нагрузки, необходим по возможности 3-4 кратный запас по CPU и памяти, исходя из того, что одна локация должна держать всю нагрузку.

Пока у вас меньше 6-ти l7-балансеров в одном ДЦ, вам нужно растить мощность кластера за счет увеличения количества инстансов, это защита от выпадения какого-то из хостов. После 6-ти инстансов на ДЦ, можно увеличивать размер пода, но не более 8 ядер на 1 инстанс.

Для продакшен сервиса рекомендуется не менее 3-4 l7-балансеров размера "micro" в одном ДЦ.

#### Внешние и внутренние l3-балансеры { #internal_and_external }
Внешние балансеры - балансеры, которыми пользуются непосредственно внешние пользователи, например, из браузера. Все балансеры, которыми не пользуются внешние пользователи, следует создавать внутренними.

Внутренний балансер в принципе не может использоваться для внешних запросов. Речь не идет про сетевые доступы, их надо заказывать отдельно.

{% note warning %}

Может возникнуть соблазн заводить все балансеры внешними, однако так делать не стоит, т.к. каждый внешний балансер расходует ipv4-адреса, число которых ограниченно.

{% endnote %}

Для внешнего балансера рекомендуется выбирать протокол https, чтобы не оставлять запросы без шифрования. Для внутренних балансеров считается, что запросы осуществляются в относительно безопасной внутренней сети Яндекса, и можно использовать обычный http.

Кроме того, тип балансера влияет на ip-адреса, выдаваемые балансеру при его создании:
- для внутреннего балансера выдается один внутренний ipv6-адрес,
- для внешнего выдается пара адресов - внешний ipv6 + ipv4.

{% note info %}

[Тип балансера можно изменить](#l3_change_traffic_type) после его создания, однако это сложная и потенциально опасная процедура, поэтому выбирайте тип балансера с умом.

{% endnote %}

### Изменение конфигов седема и конфигов балансера { #configs_pipeline }
После изменения секции с настройками балансера в конфиге седема, нужно закоммитить его в Аркадию. В течение нескольких минут в ревью придет отбивка от робота со ссылкой на сандбокс-таску, в которой будет запущен седем для вашего сервиса.

При любом запуске седем выполняет следующие шаги:
- автоматически инициирует создание неймспейса, если найдет в конфиге некоммунальный балансер с fqdn, которого еще нет в аваксе,
- создаст ревью с актуальными конфигами балансера в директории [`maps/config/balancer`](https://a.yandex-team.ru/arc/trunk/arcadia/maps/config/balancer/).

Ссылку на ревью с конфигами балансера можно найти в логах таски. Ревью c конфигами балансера **необходимо зашипать и влить в Аркадию** после успешного прохождения тестов.

{% note warning %}

Если вы не уверены в корректности сгенеренного конфига балансера, то попросите посмотреть ревью опытного коллегу или команду инфраструктуры.

{% endnote %}

{% note info %}

В случае каких-либо вопросов по ревью с конфигами балансера, можете задать свой вопрос в комментарии к ревью.

{% endnote %}

Когда конфиги нового балансера попадут в Аркадию, автоматически запустится их выкладка в авакс по одной локации за раз с интервалом в час. То есть, полная выкладка для стандартного балансера в 3-х датацентрах будет занимать чуть больше 2-х часов с момента коммита его конфигов.

### Настройка dns
Спустя 10-15 минут после того, как в ревью с конфигами попадет в Аркадию, не дожидаясь полной раскатки конфигов, можно прописать dns для нового балансера. Данный пункт актуален только для некоммунальных балансеров.

Чтобы прописать днс, обратитесь в [чат поддержки](../contacts.md) и укажите fqdn вашего балансера и его ip-адрес (адреса, если несколько).

{% note info %}

Ip-адрес (адреса) автоматически выдается балансеру при его создании [в зависимости от типа](#internal_and_external).

Узнать ip-адреса, выданные балансеру, можно в [l3 manager](#l3_manager): они будут перечислены во второй колонке активной конфигурации, и могут дублироваться для разных портов (если вы указали протокол "http_and_https").

{% endnote %}

### Выдача сетевых доступов (дырок)
После настройки днс можно начать выдавать сетевые доступы (дырки), т.к. по умолчанию балансер закрыт ото всех.

{% note info %}

Доступы выдаются в [puncher](https://puncher.yandex-team.ru/), где в качестве источника указываются сетевые макросы сервисов или abc-группы сотрудников, а в качестве назначения fqdn нового балансера и порт 80 (и 443 для https, если нужно).

Если fqdn балансера не предлагается в саджесте, проверьте, что вы не забыли про днс-запись. Возможно, нужно подождать, т.к. днс-записи доезжают до puncher'а не сразу.

{% endnote %}

- Добавьте доступ для abc-группы вашего сервиса, чтобы владельцы сервиса могли выполнять запросы к вашему сервису через балансер
- Добавьте доступы для всех клиентов вашего сервиса от их сетевых макросов `_MAPS_..._RTC_NETS_`

{% note warning %}

Обязательно закажите доступ от сетевых макросов `_JUGGLER_PROD_NETS_` и `_JUGGLERTUN64_` для вашего балансера, чтобы заработали мониторинги живости балансера.

{% endnote %}

- Для внешних балансеров закажите специальный доступ с источником "Любой". Однако нужно быть готовым, что выдача такого доступа согласуется службой безопасности только после аудита сервиса.

### Включение https на балансере { #enable_https }
Для начала вам нужно заказать сертификат для вашего балансера в [AWACS](https://wiki.yandex-team.ru/cplb/awacs/certs/#cert-create). Тип сертификата должен соответствовать [типу балансера](#internal_and_external), выбранному при его создании.

После того как сертификат будет готов, впишите его в секцию балансера конфига седема для вашего сервиса:
```
balancer:
   <staging>:
       - ...
         https_cert: <certificate-id>  # id сертификата (из интерфейса AWACS)
```
Затем закоммитьте конфиг в Аркадию, а потом дождитесь и закоммитьте ревью с обновлением конфигов балансера.

{% note warning %}

Если при заведении балансера был выбран простой `http` протокол (значение по-умолчанию), то потребуется [дополнительная донастройка l3-балансера](#l3_enable_https).

{% endnote %}

### Проверка работоспособности балансера
Далее остается дождаться, когда конфигурация балансера полностью раскатится и прорастут сетевые доступы (это может занимать до 5 часов), тогда балансер начнет отвечать на запросы.

Проверить, что балансер заработал, можно с помощью утилиты `curl`. Проверяйте все протоколы, которые вы указывали при создании балансера: `http`/`https`.

Если по прошествии нужного времени балансер не отвечает по какому-то из протоколов, то соберите диагностику и обратитесь в [чат поддержки](../contacts.md):

1. Проверьте, что балансер видит бэкенды и в целом работает, с помощью утилиты `ping` (`ping6` для [внутренних балансеров с единственным ipv6-адресом](#internal_and_external)):
   ```
   $ ping6 core-teapot.maps.yandex.net -c 3
   PING core-teapot.maps.yandex.net(core-teapot.maps.yandex.net) 56 data bytes
   64 bytes from core-teapot.maps.yandex.net: icmp_seq=1 ttl=60 time=7.82 ms
   64 bytes from core-teapot.maps.yandex.net: icmp_seq=2 ttl=60 time=8.33 ms
   64 bytes from core-teapot.maps.yandex.net: icmp_seq=3 ttl=60 time=8.84 ms

   --- core-teapot.maps.yandex.net ping statistics ---
   3 packets transmitted, 3 received, 0% packet loss, time 2002ms
   rtt min/avg/max/mdev = 7.824/8.334/8.842/0.422 ms
   ```

   {% note info %}

   Если балансер отвечает утилите `ping`, но не отвечает по `http` и по `https`, то, вероятно, проблема в сетевых доступах.

   Убедитесь, что вы пробуете отправить запрос с вашего ноутбука (а не дев-машинки, например) и заказали доступ от abc-группы, в которую вы входите, до fqdn балансера по нужным портам (80-й для `http` и 443-й для `https`).

   {% endnote %}

2. Проверьте, получают ли l3-балансеры ответы на health-чеки:
   - зайдите на страницу с конфигурацией вашего балансера в [l3 manager](#l3_manager),
   - проверьте, что для каждого ip-адреса есть строка с соответствующим портом (80-й для `http` и 443-й для `https`)
   - проверьте, что для каждой пары ip-адрес и порт в колонке "Load balancers" все балансеры помечены зеленым (кроме тех, что содержат "test" в названии).

   {% note info %}

   Если в конфигурации l3 manager отсутствует строка с нужным портом, то, вероятно, вы ошиблись при выборе протокола при заведении балансера и использовали простой `http`.

   Нужно [настроить https на l3-балансере](#l3_enable_https).

   {% endnote %}

   {% note info %}

   Если в конфигурации l3 manager балансеры в колонке "Load balancers" помечены красным, то проблема, вероятнее всего в том, что бэкенд не отвечает на ручку `/ping`.

   Убедитесь, что сервис отвечает кодом 200 на запросы на ручку `/ping`.

   {% endnote %}

## Изменение конфигурации l7-балансера { #update_l7_configs }

Седем поддерживает множество опций для конфигурирования балансера. Актуальный список формируется автоматически и доступен [здесь](https://proxy.sandbox.yandex-team.ru/last/SEDEM_COMMON_DOCS/schema.html) в разделе `main->balancer`.

В отличие от опций, используемых при создании балансера, данные настройки можно менять в процессе жизни балансера, и седем автоматически будет актуализировать конфигурацию в аваксе.

{% note info %}

Процесс изменения конфигурации балансера в целом аналогичен шагу с сохранением конфигов при первичном создании балансера, и описан в [секции о заведении нового балансера](#configs_pipeline).

{% endnote %}

Рассмотрим некоторые типовые сценарии и параметры, которые позволяют настроить подобное поведение.

### Отключить балансер от управления седемом { #automanaged }
Вы можете указать опцию `automanaged: False` в конфиге балансера, если не хотите, чтобы седем управлял конфигурацией балансера в Аркадии. Однако синхронизация между конфигом в Аркадии и аваксом продолжит работать. И кроме того, седем будет управлять мониторингами для данного балансера.

### Настройка таймаутов на время ответа бэкенда
* `backend_timeout` - Время за которое должен ответить бекэнд на обычный запрос. По умолчанию "1000ms".
Не распространяется на проверочные пинги, которые всегда должны укладываться в 1 секунду.
* `recv_timeout` - Допустимое время в течении которого от клиента может не приходить ни байта. По умолчанию "1s"

### Настройки хэдера Host запросов
* `host` - хэдер HOST с которым будут делаться проверочные запросы живости, а так же у всех запросов хэдер HOST будет переписываться на заданный. По умолчанию не задан. В этом случае будет равен `fqdn`
* `host_rewrite` - По умолчанию True. Если выключить, то у запросов не будет переписываться хэдер HOST

### Управление политикой ретраев
* `attempts` - Сколько сделать перезапросов при 5хх или таймауте. По умолчанию 3.

### Хэширование
* `hashing` - дикт, включает хэширование запросов, по умолчанию хэшиования нет.
  - `parameters` - Параметры запроса, по котором будет вычислять хэш.
  - `type` - Тип хэширования, может принимать значения: `rendezvous_hashing` или `hashing`.

### Зеркалирование
* `mirroring` - Дикт параметров для зеркалирования. По умолчанию зеркалирования нет. Должно быть указано одно из полей `fqdn` или `staging`. Дырку до стейджинга или другого балансера нужно заказывать самим.
  - `rate` - доля запросов, которая зеркалируется. Обязателен.
  - `fqdn` - fqdn другого балансера, куда зеркалировать трафик.
  - `staging` - другой стейджинг, куда зеркалировать траффик.

## Изменение топологии балансера { #update_topology }

### Изменение кол-ва и/или размера контейнеров с l7-балансером
TODO

Если необходимо добавить мощностей балансеру, то самым простым способ является увеличение кол-ва инстансов l7-балансера:
- Аллоцируете новые YP-поды во всех локациях (не стоит допускать дисбаланс между локациями по кол-ву, мощностям подов)
- Для каждой локации по очереди (начиная с MAN, если есть возможность, т.к. там меньше траффика), добавляете новые поды в снапшот на вкладке instances и активируете снапшот
- l3-балансер автоматически подхватит новые инстансы через некоторое время и начнет лить на них траффик
- Проверьте по графикам балансера, что траффик приходит на все инстансы l7-балансера

### Изменение датацентров присутствия балансера
TODO

Если ваш балансер существует в нескольких датацентрах, и вы решили удалить одну из локаций L7 вместе с его Няня-сервисом, то нужно быть готовым к тому, что загорится Juggler-проверка `default-balancer-health` для вашего балансера. С точки зрения проверки будет недоступен тот под L7-балансера, который был удален. Чтобы починить проверку, можно сделать коммит (например, с пустым диффом) в `main.yaml`, после чего отработает Sedem и обновит мониторинг.

Это же надо выполнить и в случае, если добавляется новая локация. Пока не отработает Sedem, мониторинг не будет следить за подами Няня-сервиса новой L7-локации, а это грозит невозможностью узнать, что случилось что-то плохое с этой локацией.

### Удаление балансера
[Инструкция по удалению AWACS-балансера](https://wiki.yandex-team.ru/cplb/awacs/tutorial/delete/)

## Изменение конфигурации l3-балансера { #update_l3 }
{% note warning %}

Перед применением любых изменений из данного раздела **рекомендуется проконсультироваться с командой инфраструктуры**

{% endnote %}

### L3 manager  { #l3_manager }
Диагностика и управление l3-балансером производятся в l3 manager. Найти страницу с конфигурацией вашего балансера можно следующим образом:
- откройте [awacs](https://nanny.yandex-team.ru/ui/#/awacs/) и укажите fqdn вашего балансера, выберите найденный неймспейс,
- пролистайте страницу вниз и нажмите "Show L3 Balancers",
- в открывшемся списке l3-балансеров нужно перейти по ссылке в колонке "L3mgr Service Id" в [l3 manager](https://l3.tt.yandex-team.ru/service) (если список пустой, то убедитесь, что [ревью с конфигами балансера](#configs_pipeline) было закоммичено, в него пришла отбивка от седема со ссылкой на сандбокс-таску, и таска завершилась успешно),
- нажмите на активную (обычно последнюю) конфигурацию.

{% note info %}

Если у вас есть права на управление конфигурацией, то вы увидите в правом верхнем углу желтую кнопку "Edit". Если кнопки нет, то вам необходимо получить роль "Системный Администратор" в abc-группе сервиса, которому принадлежит балансер.

{% endnote %}

### Включение https на l3-балансере { #l3_enable_https }
Все манипуляции нужно производить в [l3 manager](#l3_manager).

Необходимо для каждого ip-адреса c 80-м портом в конфигурации добавить аналогичную строку с 443-м портом:
- Нажмите кнопку "Edit"
- Скопируйте строку с 80-м портом кнопкой "Copy"
- Замените порт в секции "VS definition" c 80-го на 443-й
- Разверните секцию "RS check settings", и убедитесь, что "CHECK_TYPE" выставлен в "SSL_GET", а "CONNECT_PORT" в 443
- Сохраните изменения и повторите для всех остальный строк с 80-м портом
- Сохраните всю конфигурацию кнопкой "Save"
- Примените конфигурацию кнопкой "Deploy" и дождитесь, когда она перейдет в ACTIVE

### Изменение типа l3-балансера с внутреннего на внешний { #l3_change_traffic_type }
Приводим примерный порядок действий, и настоятельно рекомендуем проконсультироваться со специалистами:
- Нужно пройти security-аудит для того, чтобы в дальнейшем можно было открыть балансер наружу. Сделайте это заранее, т.к. это требует времени.
- Вероятнее всего, наружу вы будете открывать балансер по https, поэтому закажите сертификат заранее, это тоже требует времени (и пройденного аудита).
- Далее вам нужно будет добавить внешние ipv6 и ipv4 адреса на l3-балансер. На данный момент единственный способ это сделать, обратиться в очередь [`st/BALANCERSUPPORT`](https://clubs.at.yandex-team.ru/infra-cloud/1078).
- Когда вам добавят адреса и конфигурация доедет на балансеры, он начнет отвечать по новым адресам. После этого можно перекидывать днс-запись с внутренних адресов на внешние (внимание, не нужно ковырять никаких новых дырок, т.к. файерволл на балансерах не различает по какому ip-адресу к нему пришли, и старые дырки будут работать и для новых адресов). Перекинуть днс вам помогут в нашем [чате поддержки](../contacts.md).
- Когда убедитесь, что все клиенты успели обновить себе днс, можно удалять внутренний адрес из конфигурации l3 manager и деплоить её.
