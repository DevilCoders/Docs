{% note info %}

Перед изучением этого раздела настоятельно рекомендуется ознакомиться с [алгоритмом слияния конфигов](../config#merge-rules).

{% endnote %}

## Общее описание  { #general }
Мониторинг сервисов разделяется на `количественный` и `событийный`.

Событийный мониторинг реализуется через [Juggler](https://docs.yandex-team.ru/juggler/) - он собирает 'сырые' события от клиентских сервисов, агрегирует их с учетом заданных правил и отправляет уведомления в телеграм\телефон\etc.

Количественные метрики управляются [Golovan aka Yasm](https://wiki.yandex-team.ru/golovan/userdocs/). Сервисы самостоятельно отправляют в Yasm свои метрики (сигналы), отмечая их `тегами`.

{% note info %}

Sedem никак не контролирует отправку сигналов (и событий). Его задача - настроить по найденным сигналам алерты и панели с графиками.

{% endnote %}

Источники алертов в Juggler:
 1. алерты по метрикам из Yasm-а
 2. локальные проверки на хостах, вызываемые локальным агентом Juggler [документация](https://docs.yandex-team.ru/juggler/client/bundles)
 3. активные проверки, вызываемые на серверах Juggler (например, tcp-check) [документация](https://docs.yandex-team.ru/juggler/aggregates/actives)
 4. сырые события от самого сервиса. Например, генерируемые с помощью `YCR_ALERT_IF`.
 5. события и сигналы внешних сервисов: MDB, Sandbox, etc

## Событийные алерты { #alerts }
В секции `alerts` в sedem_config объявляются алерты, которые приходят в Juggler непосредственно от вашего сервиса.
(Не путайте с `filters.alerts` - про фильтры написано ниже)

В терминологии Juggler в `alerts` объявляются [агрегаты](https://docs.yandex-team.ru/juggler/aggregates/basics) над сырыми событиями, которые отправляет ваш сервис.

В данной секции необходимо объявлять только те алерты, для которых сервис пишет сырые события напрямую в Juggler. Например, через `YCR_ALERT_IF`, через [push-механизм](https://docs.yandex-team.ru/juggler/raw_events#push) или из [Sandbox-задач](../services/sandbox.md#alerting). Алерты по метрикам здесь объявлять не нужно - про них речь пойдет ниже, в разделе про `metrics_convertors`.  Для docker-based сервисов (Nanny, Deploy) алерты из используемых [juggler-bundle](https://docs.yandex-team.ru/juggler/client/bundles) объявлять тоже не нужно, Sedem найдет их в директории docker и добавит сам.

{% note tip %}

Если вы сомневаетесь, является ли alert встроенным или нет, рекомендуем сначала закоммитить sedem_config без секции `alerts`, дождаться реконфигурации и на страничке сервиса или в Juggler посмотреть, какие алерты сервис сгенерировал самостоятельно. Если требуемых алертов там нет, то нужно добавить их в `alerts` и закоммитить. 

{% endnote %}

### Где посмотреть алерты сервиса { #alerts-lookup }
В Juggler алерты сервиса можно искать [так](https://juggler.yandex-team.ru/aggregate_checks/?query=host%3Dmaps_core_ecstatic_bivrost_testing&limit=200) - в данном примере показаны алерты окружения `testing` сервиса `maps-core-ecstatic-bivrost`. Имя сервиса в Juggler пишется через подчеркивания.

Также сконфигурированные алерты сервиса отображаются в разделе "Alerts" на страничке сервиса в [каталоге](https://proxy.sandbox.yandex-team.ru/last/SEDEM_SERVICE_TOC/index.html)

Если ничего не появилось, вероятно, сломалась [реконфигурация](../config#apply-changes).

### Способы задания парамеров { #configuring_methods }
Есть два способа задать параметры алерта:
- напрямую в секции `alerts`
- с помощью фильтра по имени алерта и/или окружению сервиса

Прямую конфигурацию рекомендуется использовать только в том случае, когда декларация алерта изначально создается внутри вашего sedem_config и параметры, которые вы хотите задать, не зависят от окружения.

Использовать прямую конфигурацию для алерта, пришедшего из другого конфига (встроенного или зависимого), не рекомендуется по следующим причинам:
 - по записи совершенно не понятно, что это именно настройка, а не заведение алерта с нуля
 - если такого алерта не было, то он создастся, что могло не входить в намерения автора

Не рекомендуется задавать таким методом `notifications`, т.к. заданные напрямую массивы при дальнейшем расширении конфигурации будет неудобно обрабатывать с помощью фильтров.

Таким образом, если алерт был создан автоматически, пришёл из внешнего конфига или требуются разные настройки для стейджингов, используйте [фильтры](#filters).

Для настройки метрик рекомендации аналогичны.

### Параметры алертов { #alert_parameters }

`custom_tag`: список строк - пользовательских тегов для алерта. Тег будет добавлен к алерту в Juggler и в дальнейшем по таким тегам удобно искать свои алерты. Рекомендуем настраивать этот параметр для всех алертов одновременно с помощью фильтра.
Пример поиска алертов по тегу: [masstransit](https://juggler.yandex-team.ru/aggregate_checks/?project=maps&query=tag%3Da_tag_mark_masstransit_module) 

{% note warning %}

Длина тега не должна превышать 128 символов.

{% endnote %}

`notification`: настройка [нотификаций по алерту](#notifications)

`ttl`: срок годности в секундах статуса события. Если за ttl секунд статус не обновлялся, Juggler решит, что транспорт разломался и событие будет расцениваться как `NO DATA` (протухнет). Рекомендуется использовать, если ваш сервис вручную обновляет статус события в Juggler через [push-механизм](https://docs.yandex-team.ru/juggler/raw_events#push). 

Не может быть меньше 60. По умолчанию: `refresh_time * 3`, т.е. 900 секунд. Если `ttl` равен нулю, события не протухают никогда, по техническим причинам **строго не рекомендуется к использованию**.

`nodata_mode`: определяет, как будут обрабатываться устаревшие/не найденные дочерние события. Устаревшим является любое событие, которое было отправлено раньше, чем (текущее_время_сервера - `ttl` секунд). Возможные значения:
 - `force_ok` - считать устаревшие статусы как OK (по умолчанию)
 - `force_crit` - считать эти события критом,
 - `force_warn` - считать их WARN,
 - `skip` - выбрасывать события из агрегации.

`flaps`: настройка "флаподава" - фильтрации кратковременных морганий алертов. Очень рекомендуем прочитать [описание от Juggler](https://docs.yandex-team.ru/juggler/aggregates/flaps).
 - `stable_time`: интервал в секундах, в течение которого статус должен сохраняться неизменным после своего изменения, чтобы Juggler посчитал изменения стабилизировавшимся и изменил статус алерта.
По умолчанию: `600`
 - `critical_time`: интервал в секундах, по истечении которого при циклических изменениях статуса алерт принудительно переключается в состояние `CRIT`.
По умолчанию: `stable_time * 4`.
 
`degrade_crit`: количество хостов агрегата, на которых алерт может находиться в состоянии `CRIT`, чтобы агрегатный алерт не переключился в статус `CRIT`. В качестве значения допускается указывать просто число (это будет обозначать абсолютное количество машин), либо число со знаком '%' (интерпретируется, как относительная доля хостов).
По умолчанию: `34%`
Пример работы для 4 хостов:
- `50%` - нужно 3 хоста в CRIT для переключения агрегатного алерта в CRIT,
- `2` - нужно 3 хоста в CRIT для переключения агрегатного алерта в CRIT.

`degrade_warn`: количество хостов агрегата, на которых алерт может находиться в состоянии `WARN`, чтобы агрегатный алерт не переключился в статус `WARN`.

В качестве значения допускается указывать просто число (это будет обозначать абсолютное количество машин), либо число со знаком '%' (интерпретируется, как относительная доля хостов).
По умолчанию: `0` (отключен)

{% note warning %}

Имейте в виду, что для алертов по метрикам `degrade_crit` и `degrade_warn` неприменимы. Подробнее об этом написано в [разделе про метрики](#metrics_convertors_parameters)

{% endnote %}

`disable`: флаг, который полностью отключает генерацию алерта. `disable: True` равнозначно тому, как если бы алерт вообще не был описан в конфиге. Используется для принудительного отключения алертов из встроенного конфига, либо созданных автоматически.
По умолчанию: `False`

`pronounce`: то, как агрегат будет вам зачитан в случае нотификации по телефону. Нужно использовать кириллицу, латиница будет зачитана с акцентом. Для обозначения пауз можно ставить `-`, для ударения знак `+`. [Документация speechkit](https://cloud.yandex.ru/docs/speechkit/tts/request#body_params). Произношение цифр: `6 123` - шесть тысяч сто двадцать три, `6][123` - шесть сто двадцать три. Проверить, как это будет звучать, можно [тут](https://webasr.voicetech.yandex.net/ttsdemo.html). Есть ограничение в 200 символов и допустимый набор символов `A-zА-яЁё0-9 !.,?;%@+-`

`description`: человеко-читаемое описание алерта. **Строка не длиннее 1024 символов**.


Минимальный конфиг, добавляющий алерт, выглядит так:
```yaml
# alerts.yaml
my-shiny-alert-name: {}
```

{% note warning %}

Помните, что [рекомендуется](#configuring_methods) настраивать environment-specific параметры алертов (и особенно `notifications`) с помощью [фильтров](#filters).

{% endnote %}

Пример сложнее:
```yaml
# alerts.yaml
my-shiny-alert-name:
  custom_tag: [a_tag_mark_myservice_custom_tag]

  ttl: 120
  
  flaps:
    stable_time: 300
    critical_time: 600

  degrade_crit: 10%
  degrade_warn: 5%

  disable: True

  nodata_mode: force_crit

  pronounce: Билд слишком долго находится в статусе ожидания или постановки в очередь.

  description: >-
    Мониторинг загорается, если какой-то билд долго находится в статусе WAITING или SCHEDULING.
    Все билды в Огороде шедулятся в одном потоке. Один зависший билд может заблокировать всю очередь билдов.
    Что делать дежурному: запустить билд модуля example_map, чтобы проверить не ложное ли это срабатывание.
    Если билд висит в статусе WAITING, то убить процесс /usr/bin/garden-scheduler командой kill.
```

## Метрики { #metrics_convertors }
Секция `metrics_convertors` в sedem_config определяет обработку сигналов сервиса в [Yasm](https://wiki.yandex-team.ru/golovan/userdocs/). Каждый metric_convertor принимает на вход один или множество сигналов и по заданной формуле формирует из них "финальную метрику", по которой будет настроен алерт и/или график в web UI. 

Sedem считывает из Yasm список доступных сигналов, которые соответствуют сервису. Далее по сконфигурированным в `metrics_convertors` (с пост-настройкой фильтрами) правилам Sedem пробует сгенерировать "финальные метрики" и настроить по ним алерты и панели с графиками. 

Если в Yasm нашлось недостаточно сигналов для вычисления metrics_convertor-а, то он молча игнорируется. Сигналы могут быть удалены из Yasm по `ttl`, если они не отправлялись регулярно. Проверить, что алерты по метрикам были созданы, можно [так](#alerts-lookup).

### Параметры metrics_convertors { #metrics_convertors_parameters }
`alert`: создает алерт по значению метрики. Синтаксис похож на [событийные алерты](#alerts) за исключением того, что конечное значение агрегируется не по дискретным "raw events", а по временным рядам с источников сигналов внутри заданного окна. Поэтому: 
 - вместо порогов по хостам `degrade_crit` и `degrage_warn` используются пороги по метрике: `crit` и `warn`.
 - дополнительно конфигурируется `aggregation` для вычисления значения метрики в текущем моменте и `trend` - для вычисления значения метрики в прошлом (для трендовых алертов).
 
`aggregation`: настройки агрегации по времени - определяют промежуток времени, на котором рассчитывается текущее значение.
 - `type`: тип агрегации. Может принимать значения: `summ`, `aver`, `max`, `min`
 - `window`: окно агрегации в секундах, от 0 до 3600
 
[Документация Golovan](https://wiki.yandex-team.ru/golovan/userdocs/alerts/api/#valuemodify)

`trend`: настройки [алерта по тренду](https://wiki.yandex-team.ru/golovan/userdocs/alerts/#trendovyealerty)
 - `type`: тип тренда, `up` или `down`
 - `use_absolute`: использовать `crit` и `warn` как абсолютные пороговые значения вместо процентов
 - `interval`: окно в секундах, на котором происходит агрегация значений метрики в прошлом (от 25 до 3600)
 - `aggregation`: настройки агрегации по времени прошлых значений
     - `type`: тип временной агрегации (`quant`, `summ`, `aver`, `max`, `min`)
     - `quant`: квантиль - число от 0 до 100, задается только только для `type == quant`
     - `offset`: сдвиг окна агрегации прошлых значений относительно текущего момента. По умолчанию равен длине окна агрегации текущих значений. n >= 0 and n <= 3600

[документация Golovan](https://wiki.yandex-team.ru/golovan/userdocs/alerts/api/#intervalmodify)

`kwargs`: значения алиасов, используемых при поиске сигналов или настройке метрик (см. описание `func`)

`body`: содержит список вариантов выборки исходных сигналов для вычисления метрики, по которой будут строиться алерты и график. Каждая альтернатива (элемент массива) в том или ином виде содержит формулу для Голована. Альтернативы перебираются последовательно, пока не найдётся такая, для которой будут в наличии все требуемые для вычисления сигналы. Если таковой не найдётся, то метрика не формируется.

  - `signal`: [формула в синтаксисе Голована](https://wiki.yandex-team.ru/golovan/userdocs/signal-functions/), задающая способ вычисления финальной метрики. 

  - `func`: функция финальной метрики, задается массивом, где первый элемент - имя формулы, остальные - ее аргументы: сигналы, константы или подстановки `kwargs`.

Внутри `signal` и `func` могут использоваться алиасы в фигурных скобках, которые подставляются из секции `kwargs`. Таким образом можно переопределять настройки внешних мониторингов. Например, `{timing_limit}` используется для настройки алертов по таймингам балансера:

```yasm
metrics_convertors:
  - filter:
      service_name: default-balancer-timings
      staging: testing
    body:
      kwargs:
        timing_limit: 20
```

При задании имени сигнала внутри `signal` и `func` вместо оригинального имени можно использовать запись вида `M[signal]`, где `signal` - имя исходного сигнала. Если данные сигнала не найдены в Yasm в момент применения sedem_config, такая запись говорит Sedem-у игнорировать данный вариант создание метрики и переходить к следующему.
Также внутри `M[...]` для имени сигнала может быть задан опциональный префикс:
* `matched_signals:` трактует имя сигнала как regexp. Все найденные по нему сигналы будут взяты в качестве результата.
* `subst:` включает для `signal` режим подстановки от [search_template](#metrics_convertors_templates). Если этот префикс не указан, то подстановка шаблона не произойдёт.

Пример `matched_signals` - мониторинг свободного места по всем найденным разделам:
```yaml
metrics_convertors:
  disk_quota:
    alert:
      warn: 75
      crit: 85
      flaps: {'stable_time': 60}
    body:
      - signal: max(M[matched_signals:portoinst-volume_(/(?!cores).*|cwd|root)_usage_perc_txxx])
```
Пример нескольких вариантов `func` - встроенный универсальный мониторинг свободного места на диске для различных вариантов баз в MDB:
```yaml
metrics_convertors:
  '{mdb_cluster_name}-mdb-master-disk-limit':
    type: mdb
    alert:
      warn: 75
      crit: 90
    body:
      - signal: perc(M[push-disk-used_bytes_pgdata_tmmx], M[push-disk-total_bytes_pgdata_tmmx])
      - signal: perc(M[push-disk-used_bytes_/var/lib/mongodb_vmmv], M[push-disk-total_bytes_/var/lib/mongodb_vmmv])
      - signal: perc(M[push-disk-used_bytes_/var/lib/postgresql_vmmv], M[push-disk-total_bytes_/var/lib/postgresql_vmmv])
```

Во встроенном конфиге Sedem определены следующие формулы:
  - `perc(a, b)` - Вычисляет процентное отношение `a` к `b`. В отличие от встроенной функции perc в Головане, не возвращает `n/a` если `a == b == 0`.
  - `perc_min(a, b, m)` - Вычисляет процентное отношение `a` к `b`. `m` задаёт минимальное значение `b`, при котором вычисление имеет смысл: если `b < m`, то функция возвращает `0`. Используется, например, для того, чтобы не поджигать алерт на процент http-4xx при общем низком уровне трафика. 
  - `perc_min_no_check(a, b, low)`: `mul(perc(a, max(1, b)), min(floor(div(b, low)), 1))` - вычисляет процентное отношение `a` к `b`, но если `b` меньше `low`, то результат делится еще и на `b / low` - используется для "смягчения" алертов на сигнал `a` при низком (`low`) уровне трафика `b`
  - `percent_limited(a, b, limit)`: `perc(M[a], max(limit, M[b]))` - вычисляет процентное отношение `a` к `max(limit, b)` - также позволяет не поджигать алерты на долю `a` при `b < limit` 

Параметры-сигналы во встроенных формулах должны быть "чистыми", без записи `M[...]` - она подставляется в самих формулах.

`disable`: полностью отключает генерацию метрики, `disable: True` равнозначно тому, как если бы метрика вообще не была описана в конфиге. Используется для принудительного отключения метрик из встроенного конфига либо созданных автоматически.
По умолчанию: `False`

`type`: тип мониторинга, может принимать значения:
- `service` (по умолчанию)
- `balancer`: алерт по метрикам AWACS. В название метрики можно подставить шаблон `{balancer_name}` и Sedem подставит в него upstream-ы балансеров вашего сервиса.
- `mdb`: алерт по метрикам MDB. Подстановка в названии метрики работает для `{mdb_cluster_name}`
- `s3`: алерт по метрикам S3. Подстановка в названии метрики работает для `{s3_abc_slug}` и `{s3_bucket_name}`
- `mds`: алерт по метрикам MDS. Подстановка в названии метрики работает для `{mds_bucket_name}`

`alternative_name`: задаёт альтернативное имя metric_convertor-а, которое используется для разрешения конфликта имён. Как правило, это нужно только для тех сервисов, где внутри Docker-а работает несколько независимых http-сервантов, и нужно создавать шаблонные алерты по их метрикам.

`search_template`: см [шаблоны](#metrics_convertors_templates)

`graphic`: см [графики](#panels)

Пример:
```yaml
'total-4xx':
  alert:
    #  Warning уровень для величины метрики.
    #  Задаёт уровень Warning для текущей величины. Не может отсутствовать и не может быть больше, чем crit.
    #  Задаётся в виде числа, никаких знаков '%' не допускается (даже если это действительно проценты).
    #  Во встроенном конфиге Sedem'а есть значение по умолчанию (50).
    #  Если warn не нужен, то установите его равным crit.
    warn: 10
  
    #  Critical уровень для величины метрики.
    #  Задаёт уровень Critical для текущей величины. Не может отсутствовать и не может быть меньше, чем warn.
    #  Если вам не нужен crit уровень вообще - поставьте её во что-нибудь большое.
    #  Если же вам и warn не нужен - не заводите проверку вообще.
    #  Задаётся в виде числа, никаких знаков '%' не допускается (даже если это действительно проценты).
    #  Во встроенном конфиге Sedem'а есть значение по умолчанию (75).
    crit: 30
    
    flaps: 
      stable_time: 200
  body:
    - func: [perc_min, roquefort-total_4xx_ammv, roquefort-total_rps_ammv, 10]
```

Трендовый алерт по сигналам балансера:
```yaml
'{balancer_name}-balancer-2xx-trend-up':
  type: balancer
  alert:
    warn: 35
    crit: 50
    flaps:
      stable_time: 0
    trend:
      type: up
      interval: 25
      aggregation:
        type: aver
        offset: 60
    aggregation:
      type: aver
      window: 15
  body:
    - signal: M[balancer_report-report-service_total-outgoing_2xx_summ]
```

### Шаблоны метрик { #metrics_convertors_templates }
Для генерации шаблонных алертов и графиков (например, по каждой http-ручке) в `metrics_convertors` могут содержаться шаблонные правила, они отличаются наличием параметра `search_template`.

`search_template`: задаёт шаблон для поиска и генерации метрик. Указание этого массива превращает описание метрики в шаблон. Sedem будет просматривать все существующие в Головане сигналы на предмет совпадения с заданным шаблоном. При совпадении будет создана новая метрика на основе шаблона. Массив как раз и содержит шаблон:
 - первый элемент массива содержит regexp для сопоставления (они должны быть взяты в скобки)
 - остальные элементы содержат имена, которым будут присвоены найденные в regexp части - по сути, они представляют собой аналог regexp capture groups.

После сопоставления шаблона формируется описание метрики из оригинального определения (текущего шаблона). В текущем шаблоне все имена, заданные в виде `{name}`, заменяются на найденные части из regexp. Такая же замена производится с именем метрики - шаблона. Из исходного значения шаблона метрика не формируется. Замена производится с помощью обязательного префикса `subst:`. Имя исходного сопоставленного сигнала можно передать в формулу как `subst:{SRC}`

Обратите внимание, что шаблонные алерты объединяются два раза, каждый раз с применением фильтров:
- шаблонные правила объединяются на уровне конфига, как и любые другие элементы конфигурации. На этом этапе их, например, можно отключить, внедрив атрибут `disable: True` в тело встроенного шаблонного правила через фильтр.
- после поиска по шаблону и его раскрытия, сгенерированные шаблонные метрики добавляются в конфиг. На этом этапе объединения не происходит, вместо этого возможные копии просто не добавляются, с выдачей предупреждения в логах таски реконфигурации.

Пример из встроенного конфига, который генерирует алерты на все ручки из roquefort:
```yaml
'http-{handle}-{code}':
  alert:
    warn: 5
    crit: 5
    flaps:
      stable_time: 200
  search_template:
    - roquefort-([-.\w]+)_/(.*)_(404|429|4xx|error)_ammv
    - appid
    - handle
    - code
  body:
    - func: [perc_min, "subst:{SRC}", "subst:roquefort-{appid}_/{handle}_rps_ammv", 10]
```

### Графики { #panels }
Sedem генерирует панели с графиками метрик сервиса вида `https://yasm.yandex-team.ru/template/panel/maps-<subsystem>-<service-name>-<staging>-panel-main/`, [например](https://yasm.yandex-team.ru/template/panel/maps-core-meta-stable-panel-main/)

`graphic`: секция содержит информацию о местоположении графика на панели

 - `handle`: вывод метрики в раздел Handles (сразу после встроенных глобальных метрик)
   - `name`: имя окна для значения метрики и таймингов.
   - `metric`: определяет имя Roquefort сигналов:
     * `roquefort-<metric>_<handle-code>_ammv` - для получения RPS значений
     * `roquefort-<metric>_request_timings_ahhh` - для получения таймингов

   - `timings`: времена квантилей (в ms) - задаёт времена на графике таймингов, по которым будут собираться квантили
   
 - `handle_code`: часть шаблонной метрики с `http status`

 - `alert`: (bool) - создать алерт в верхней части панели

- `metric`: добавление метрики на панель **до** раздела Handles.
   - `name`: имя окна на панели. В одном окне может быть выведено несколько графиков, так что этот параметр может дублироваться (все дубликаты попадут в одно окно)
   - `signal_name`: имя сигнала на графике. По умолчанию имя сигнала совпадает с именем окна. Если надо вывести несколько сигналов в одно окно, то можно указать несколько разных `signal_name` для одинаковых `name` - они все попадут в одно окно. Однако нельзя задать несколько полностью совпадающих наборов `(name, signal_name)`
   - `log_scale`: (bool) использовать логарифмический тип шкалы. По умолчанию: False (линейный). На одном окне (с общим `name`) не может быть графиков с разным `log_scale`.
   
- `metric2`: добавление метрики на панель **после** раздела Handles. Поля аналогичны `metric`.

Пример для шаблонной метрики:
```yasm
metrics_convertors:
  'panel-{handle}-{code}':
    graphic:
      handle:
        name: "{handle}"
        metric: "maps_mobile_{handle}"
        timings: [100, 300, 1000, 2000]
      handle_code: "{code}"
    search_template:
      - roquefort-maps_mobile_([-.\w]+)_([2-5]\d\d|\dxx|error|ok)_ammv
      - handle
      - code
    body:
      - signal: M[subst:{SRC}]
```

## Нотификации { #notifications }

Настройка параметров нотификаций (кому и как звонить, списки эскалаций, профили и пр.) задаются в массиве `notifications` записей `alert`.

Про дежурства и настройку нотификаций написано [в этом разделе](../monitorings/duty#notifikacii)

Как отключить нотификации, написано ниже в разделе про фильтры.

## Фильтры { #filters }
Фильтры представляют собой механизм групповой настройки сущностей из `alerts` и `metrics_convertors`. [Описание работы](../config#filters)

Все фильтры должны быть заданы в разделах `filters.alerts` или `filters.metrics_convertors` (в файле `__all__.yaml` или `filters.yaml`).

### Примеры фильтров { #filters_examples }

Применяем порог `crit: 90` ко всем сконфигурированным алертам по метрикам:
```yaml
filters:
  metrics_convertors:
    - body:
        alert:
          crit: 90
```

Применяем `degrade_crit: 90%` для всех событийных alerts в `prestable` сервиса:
```yaml
filters:
  alerts:
    - filter:
        staging: prestable
      body: 
        degrade_crit: 90%
```

Применяем `degrade_crit: 90%` для всех событийных alerts в `prestable` и `stable` сервиса:
```yaml
filters:
  alerts:
    - filter:
        staging: prestable|stable 
      body:
        degrade_crit: 90%
```

Изменение порога `crit` до 90 для конкретной метрики:
```yaml
filters:
  metrics_convertors:
    - filter:
        service_name: cpu_usage
      body:
        crit: 90
```

То же самое, для стейджинга `load`:
```yaml
filters:
  alerts:
    - filter:
        service_name: cpu_usage
        staging: load
      body:
        crit: 90
```

Настройки для всех событийных алертов, кроме `cpu_usage`:
```yaml
filters:
  alerts:
    - filter:
        service_name: (?!cpu_usage$).*
      body:
        flaps:
          stable_time: 100
```

Настройка нотификаций для всех событийных алертов в `stable` и `prestable`:
```yaml
filters:
  alerts:
    - filter:
        staging: prestable|stable
      body:
        notifications:
          - type: service_duty
```

То же самое, но с дополнительно профилем geo_monitoring (для сервисов, [сданных в эксплуатацию](https://wiki.yandex-team.ru/geo-infra/duty/cheklist-sdachi-servisa-v-jekspluataciju/)):
```yaml
filters:
  alerts:
    - filter:
        staging: prestable|stable
      body:
        notifications:
          - type: service_duty
          - type: profile
            name: geo_monitorings
```

Если вы хотите полностью переопределить какую-то ручку.

- если ручка задана в секции alerts или metrics_convertors без `search_template` - описываете у себя в конфиге такую же ручку и переопределяете ей все поля.
- если ручка динамически генерируется из metrics_convertors с `search_template` - фильтром выключаете генерируемую ручку и заводите свою (но с другим именем).

Пример: заменяем ручку `http-layer-404` (создана по шаблону `http-{handle}-{code}`) на свою `myhttp-layer-404`:
```yaml
filters:
  metrics_convertors:
    - filter:
        service_name: 'http-layer-404'
      body:
        disable: True

metrics_convertors:
  myhttp-layer-404:
    alert:
      ....
    body:
      - func: [ .... ]
```

Если вы хотите переопределить или запретить шаблонные алерты, фильтром меняете содержимое шаблона, или выключаете его вообще через `disable: True`.

Пример: отключаем встроенный шаблон `http-{handle}-{code}`:
```yaml
filters:
  metrics_convertors:
    - filter:
        service_name: 'http-{handle}-{code}'
      body:
        disable: True
```

Способы отключить нотификации:
- если вы не хотите иметь вообще никаких алертов, ни в Juggler'е, ни где-либо ещё: отключайте сам алерт через `disable: True` или вообще его не создавайте (если алерт не приехал извне)
- если вы хотите видеть статусы в UI Juggler, но без нотификаций в телефон или мессенджеры: отключайте нотификации через `'$force notifications': []` в алерте или не создавайте их, если вы сами их задавали

Прежде чем отключать нотификации, убедитесь, что есть что отключать - нотификации вы включаете сами. Лучше просто не включать нотификации там, где не надо, чем потом выборочно отключать.

Пример:
```yaml
filters:
  alerts:
    - filter:
        service_name: cpu_usage
      body:
        '$force notifications': []
```

Без `$force` отключение не сработает, этот префикс заставляет пустой массив из фильтра полностью заместить текущее содержимое, а не объединиться с ним.

## Мониторинг внешних систем
Sedem умеет автоматически заводить мониторинги на MDB, MDS и S3

### MDB

Для подключения мониторингов MDB необходимо написать следующее в секции `resources` конфига:

```yaml
stable:
    mdb:
        - type: 'mongodb'
          cluster_id: 'mdbgtnk85h14eoev3r2b'
          name: 'cluster_name'

```

- `type` - тип кластера. Может быть одним из: `mongodb`, `postgres` и `clickhouse`
- `cluster_id` - идентификатор кластера в терминах MDB
- `name` - опциональное поле для произвольного имени кластера. Необходимо использовать при использовании нескольких кластеров

### MDS

Для подключения мониторингов MDS необходимо прописать в секции ```resources``` конфига следующие строки:
```yaml
stable:
    mds:
        - buckets:
            - bucket1
            - bucket2
          environment: production
``` 
В поле ``environment`` необходимо написать `testing` или `production` в зависимости от того, какой environment вы хотите мониторить

В поле `buckets` - список бакетов в выбранном environment-е

### S3

Для подключения мониторинга на S3 нужно написать в секции `resources` следующее:

```yaml
stable:
    s3:
        - buckets:
            - bucket1
            - bucket2
          abc_service: maps_core_service
```

Поле `abc_service` - опциональное, по дефолту берется abc сервиса

Аналогично мониторингам на MDS необходимо указать список бакетов
