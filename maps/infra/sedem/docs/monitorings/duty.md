# Нотификации, дежурства и эскалация

В этой статье описано, как сгенерировать нотификации, включить дежурства, эскалацию и дежурства выходного дня. Для этого настраиваются два ABC-сервиса, создаётся шедулер и добавляются фильтры в sedem_config.

Sedem использует специальным образом настроенные ABC-сервисы, чтобы извлечь всю информацию о пуле дежурных и о списке эскалации. Дежурства генерируются самописным шедулером, который размечает дежурных по двум расписаниям (primary/secondary).

## Терминология

- **Мониторинг** — нештатная ситуация в сервисе, которую поймала автоматика. В результате срабатывания мониторинга высылаются нотификации и совершаются звонки дежурным, а в случае отсутствия реакции дежурных — звонки по списку эскалации.
- **Downtime** — Когда кто-то из дежурных берёт мониторинг в работу, то нажимает на кнопку Downtime, чтобы на время остановить звонки от мониторинга.
- **Дежурные** — люди, ответственные за реагирование на мониторинги и другие нештатные ситуации. Назначаются автоматикой из списка разработчиков в duty-сервисе.
- **Список эскалации** — список людей, которым звонит робот, если мониторинг горит долго, но никто не нажал Downtime. Список эскалации состоит из:
    + руководитель duty-сервиса
    + заместители руководителя duty-сервиса
    + Алексей Хроленко (khrolenko@)
- **Дежурные выходного дня** — отвечают в выходные дни за мониторинги всех сервисов, сданных в эксплуатацию. Генерируются из сервиса [Общекарточные дежурства выходного дня](https://abc.yandex-team.ru/services/maps-duty/)
- **Сдача сервиса в эксплуатацию** — процедура проверки соответствия сервиса [общим требованиям по эксплуатации](https://wiki.yandex-team.ru/maps/dev/core/instrukcija-po-sozdaniju-servisov-v-rtc/#sdatservisvjekspluataciju), после которой ответственность за работу сервиса в выходные и праздничные дни переходит к общекарточным дежурным
- **ABC-сервис программного компонента** — ABC-сервис программного компонента, по которому осуществляется дежурство (например, maps-core-ecstatic-coordinator).
- **Duty-сервис** — отдельный ABC-сервис, в который заносится информация для генерации дежурств и эскалации (например, maps-duty-infra).
- **Шедулер** — Sandbox Scheduler ([типа MAPS_BINARY_TASK с тегом DUTY](https://sandbox.yandex-team.ru/schedulers?task_type=MAPS_BINARY_TASK&tags=DUTY)), который составляет графики primary/secondary дежурств для списка разработчиков в duty-сервисе.
- **Juggler** — система событийного мониторинга, которая умеет принимать события с различных клиентов, агрегировать их по заданным правилам и отправлять результат по телефону, в Telegram (ботом `@JugglerSearchBot`), Slack (ботом `@Juggler`) и что-нибудь ещё.
- **st-monitor** — сервис, умеющий следить за обновлениями Startrek-а, слать сообщения в Telegram и Slack, реагировать на нажатия кнопок.

## Нотификации { #notifications }

### Telegram

Подпишитесь на уведомления в Telegram:

1.  Добавьте в ваш чат ботов `@JugglerSearchBot` и `@GeoMonitoringsBot`. Оба бота обязательны. `@JugglerSearchBot` нужен для двух вещей: регистрации чата (следующий пункт инструкции) и получения мониторингов от `Juggler`-а. `@GeoMonitoringsBot` нужен для получения сообщений со ссылкой на тикет в Стартреке и с кнопками для установки даунтайма из Телеграма.

2.  Зарегистрируйте свой чат в Juggler. Для этого напишите в своём чате сообщение: `/start@JugglerSearchBot your-chat-name`, где `your-chat-name` поменяйте на название вашего чата.

3.  Напишите в своём Телеграм-чате сообщение `/findme@GeoMonitoringsBot`. Пропишите полученное число и название чата в [захардкоженный конфиг st-monitor](https://a.yandex-team.ru/arc/trunk/arcadia/maps/infra/monitoring/st_monitor/lib/config.py#L4). Обратитесь к vmazaev@ или axxeny@ или khrolenko@, чтобы выкатить новый st-monitor.

4.  **Если заводите чат для дежурных, то на этом все (можно вернуться к иструкции по [Настройке дежурств](#nastrojka-duty-servisa)).**
Помимо пайплайна дежурств, в чаты можно направлять любые мониторинги, прописав в `sedem_config/filters.yaml` вот такой фильтр:
    ```yaml
    alerts:
      - filter:
          staging: stable|prestable  # или, например, datatesting, testing и т.д.
        body:
          notifications:
            - type: telegram
              # your-chat-name поменяйте на название вашего чата, которое вы сообщили Juggler ранее.
              login: [your-chat-name]
              status: [CRIT]  # или [CRIT, WARN]
    ```

### Slack

Поддерживаются workspace: Yandex Maps Platform, Yandex Maps, b2b-geo, Yandex.Auto, Yandex All, Yandex Slack Apps. Поддержка других workspace — по запросу.

1.  Добавьте в ваш канал ботов `@Juggler` и `@Maps Monitorings`. Оба бота обязательны. `@Juggler` нужен для двух вещей: (1) чтобы Sedem мог сконфигурировать и Juggler, и бота `@Maps Monitorings` для отправления мониторингов, и (2) для получения мониторингов от `Juggler`-а. `@Maps Monitorings` — бот от Инфраструктуры Карт, он отправляет сообщения со ссылкой на тикет в Стартреке.

2.  **Если заводите чат для дежурных, то на этом все (можно вернуться к иструкции по [Настройке дежурств](#nastrojka-duty-servisa)).** 
Помимо пайплайна дежурств, в чаты можно направлять любые мониторинги, прописав в `sedem_config/filters.yaml` вот такой фильтр:
    ```yaml
    alerts:
      - filter:
          staging: stable|prestable  # или, например, datatesting, testing и т.д.
        body:
          notifications:
            - type: slack
              chats:
                - name: your-channel-name  # имя не используется и не валидируется,
                                           # укажите его для читателей конфига.
                  # Ссылку на канал можно получить, нажав Copy link (((https://nda.ya.ru/t/FTc9ubL83hzCEg скрин))).
                  link: https://yndx-maps-platform-or-another-workspace.slack.com/archives/YOURCHANNELID
              status: [CRIT]  # или [CRIT, WARN]
    ```

## Дежурства

Для управления дежурствами разных команд разработчиков используем отдельные сервисы в ABC, так называемые duty-сервисы. Список duty-сервисов Геоплатформы [находится здесь](https://abc.yandex-team.ru/services/maps-duty/services/).

### Настройка duty-сервиса

1.  Выдайте роль «Разработчик» всем, кто будет участвовать в генерации смен.

2.  Для ролей «Руководитель сервиса» / «Заместитель руководителя сервиса» будет работать эскалация по будним дням.

3.  В разделе «Контакты» укажите:
    - «Очередь в Трекере»: название - [имя компоненты из GEOMONITORINGS](https://st.yandex-team.ru/GEOMONITORINGS/components), ссылка на очередь GEOMONITORINGS (нельзя сослаться на отдельную компоненту)
    - «Телеграм чат»: название, которое сообщили командой `/start@JugglerSearchBot`, ссылка на ваш чат. (Про настройку чатов см раздел [Нотификации](#notifikacii), не забудьте добавить ботов `@JugglerSearchBot` и `@GeoMonitoringsBot`).
    - «Slack чат»: название вашего чата и ссылка на него. (Не забудьте добавить в чат ботов `@Juggler` и `@Maps Monitorings`, см раздел [Нотификации](#notifikacii))

4.  Во вкладке «График дежурств» создайте расписания со слагами `primary` и `secondary` (если есть второй дежурный).
Мы рекомендуем использовать нашу генерилку расписаний вместо встроенной. Поэтому не обращайте внимание на смены, которые появляются при создании - мы их перезатрем.
**NB:** Если по каким-то причинам решили пользоваться встроенной генерилкой ABC, то пункты (6) и (7) можете пропустить.

5.  Выдайте роль «Управляющий дежурствами» всей команде, чтобы разрешить самостоятельно обмениваться сменами в интерфейсе расписаний ABC.

6.  Настройте периодический запуск генерилки расписаний в планировщике в Sandbox. 
Для этого скопируйте [шедулер инфры](https://sandbox.yandex-team.ru/scheduler/12242/view), а вместо `maps-duty-infra` укажите ваш duty-сервис в параметре `abc-duty-service` и в описании. Не забудьте про настройку уведомлений в почту о неполадках планировщика.

7.  Выдайте роль «Управляющий дежурствами» роботу `robot-maps-sandbox`, от его лица работает генерилка.

### Подключить сервис к дежурствам

1.  В разделе «Контакты» основного ABC, к которому привязан ваш сервис, добавьте ссылку на duty-сервис с типом «Календарь дежурства».

2.  Включите `service_duty` нотификации в sedem_config (для алертов заработают чаты, телефонные звонки и эскалация):

  ```yaml
    alerts:
      - filter:
          staging: stable|prestable
        body:
          notifications:
            - type: service_duty
  ```

### Подключить дежурства выходного дня

**После сдачи сервиса в эксплуатацию(!)** добавьте в sedem_config профиль нотификаций `geo-monitorings`:

  ```yaml
    alerts:
      - filter:
          staging: stable|prestable
        body:
          notifications:
            - type: service_duty
            - type: profile
              name: geo_monitorings
  ```
  
  В результате алерты не только попадут в чат geo_monitorings, но и будут названивать общекарточным дежурным по выходным.
