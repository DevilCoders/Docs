## Структура конфига { #config-structure }
Конфиг сервиса задается в yaml-формате и состоит из фиксированного набора секций.
Основные секции:
    - `main`: имя сервиса, его ABC-сервис, а также настройки [балансеров для няня-сервисов](services/balancers.md);
    - `deploy`: выбор типа сервиса и его [релизного цикла](releases.md#deploy-setup);
    - `resources`: перечисление зависимостей сервиса (s3, mdb, mds) и его [деплой-юнитов](releases.md#deploy-config);
    - `dependencies`: зависимости от дочерних Sedem-конфигов, датасетов Ecstatic;
    - `secrets`: [секреты для няня-сервиса](services/nanny#secrets);
Алерты:
    - `alerts`: конфигурация [событийных алертов](monitorings/alerts_metrics.md#alerts);
    - `metrics_convertors`: конфигурация [алертов по метрикам](monitorings/alerts_metrics.md#metrics_convertors);
    - `panels`: настройка панелей с [графиками](monitorings/alerts_metrics.md#panels);
    - `notification_profiles`: кастомные профили [нотификаций](monitorings/duty.md) об алертах;
    - `filters`: [фильтры](monitorings/alerts_metrics.md#filters) для конфигурации алертов и метрик;
Релизы:
    - `deploy_profiles`: настройки [релизного цикла](releases.md#deploy-config);
    - `acceptance`: конфигурация [приемочных тестов](releases.md#acceptance).

В своем конфиге сервис определяет требуемые секции. Каждая секция должна быть расположена в `.yaml` файле с соответствующим именем (например, `main.yaml`), либо в общем `__all__.yaml` в директории `sedem_config` в Аркадии, непосредственно рядом с кодом сервиса.

Пример конфига:
```yaml
main:
  name: renderer-cartograph
  subsystem: core
  abc_service: maps-core-renderer-cartograph

  balancer:
    stable:
      - instances_count: 1
        instance_size: micro
        datacenters: [VLA, SAS]
        protocol: http_and_https
        https_cert: core-renderer-cartograph.maps.yandex.net
        upstreams:
          default:
            backend_timeout: 120s

alerts: {}
metrics_convertors: {}

filters:
  metrics_convertors:
    - filter:
        service_name: default-balancer-timings
      body:
        kwargs:
          timing_limit: 4

  alerts:
    - filter:
        staging: prestable|stable
      body:
        notifications:
          - type: telegram
            login: [maps-cartograph-monitoring]
            status: [OK, WARN, CRIT]

resources:
  testing:
    geo:
      VLA: {}
      MAN: {}
      SAS: {}
  stable:
    geo:
      VLA: {}
      SAS: {}
      MAN: {}
```

## Процесс формирования конфига { #config-init }
При загрузке конфига сервиса Sedem выполняет следующие шаги:
- вычитывает все .yaml файлы из директории `sedem_config` сервиса
- вычисляет пути до конфигов-зависимостей на основе секции `dependencies`
- объединяет конфиг сервиса, его зависимостей и встроенный базовый конфиг на основе [правил слияния](#merge-rules)
- вызывает программные модули, которые могут модифицировать конфиг в зависимости от кода сервиса и внешних данных
- применяет к конфигу набор фильтров-модификаторов, которые определены в секции `filters`

Примером внешних данных, влияющих на конфиг сервиса, могут служить Juggler-манифесты, использующиеся в образе сервиса. Для всех найденных проверок Sedem автоматически добавляет соответствующие разделы в секцию `alerts`.

Фильтры позволяют указывать настройки для конкретных окружений сервиса - например, ослабить алерты для тестинга.

### Правила слияния конфигов { #merge-rules }
Слияние конфигов `original` и `update` производится рекурсивным способом. Из обоих словарей извлекаются ключи, составляется общий набор ключей и производится слияние по каждому ключу по следующей схеме:
1. Если ключ присутствует только в одном словаре, то он и его значение добавляется в результат
2. Иначе смотрим на типы значений `original` и `update`:
    - словарь + словарь: процедура слияния запускается рекурсивно для значений
    - скаляр + скаляр: берётся `update`
    - массив + массив: массивы объединяются
    - иначе - ошибка слияния

Процесс слияния может быть **изменён** ключевым словом перед ключом в `update`-словаре:
 - `$default` - использовать поле из `update`, только если его нет в `original`. Используется во встроенном конфиге для того, чтобы задать дефолтные значения для массивов. Т.к. массивы только сливаются, то без этого префикса вместо дефолтного значения будет всегда присутствующая часть в результирующем массиве.
 - `$force` - игнорировать содержимое `original`. Используется для полного переопределения значения, без слияния.

[Примеры](monitorings/alerts_metrics#filters_examples)

### Фильтры (модификаторы) { #filters }
После слияния конфигов к результату применяются фильтры, определенные в секции `filters`.
Поддерживаются фильтры для секций `alerts` и `metrics_convertors`:
 - фильтры, определенные в секции `filters.metrics_convertors` применяются ко всем словарям внутри `metrics_convertors`
 - фильтры, определенные в секции`filters.alerts` применяются как к элементам секции `alerts`, так и ко вложенным `alerts` внутри элементов `metrics_convertors`

Фильтр представляет собой словарь из двух полей:
 - `filter` - словарь ключ-regexp, элементы которого сравниваются с содержимым исходных словарей. Для применения фильтра всё элементы из `filter` должны сматчиться с исходным конфигом.
 - `body` - тело, сливается с оригинальным конфигом, если `filter` совпал.

{% note info %}

При сравнении строк в фильтре они трактуются как регулярные выражения, причём совпасть должна вся сравниваемая срока. Символы `^` в начале и `$` в конце регулярного выражения трактуются как обычные символы (не как маркеры начала и конца).

{% endnote %}

Также Sedem добавляет в фильтруемый словарь поле `staging` - окружение сервиса при генерации алертов и панелей.

Фильтры применяются в порядке их объявления в конфиге.

[Примеры](monitorings/alerts_metrics#filters_examples)

## Когда sedem применяет настройки к сервисам { #apply-changes }
После коммита в `sedem_config` запускается [Sandbox-задача реконфигурации](https://sandbox.yandex-team.ru/tasks?type=SEDEM_CONFIG_APPLIER), которая применяет все настройки к сервису (не инкрементально!). После завершения задачи автору коммита с обновлением конфига должно прийти письмо. В логах задачи сохраняется вся информация о статусе применения настроек.

При очередном релизе Sandbox-задачи запускается реконфигурация **всех** сервисов, т.к. могут меняться встроенные в Sedem конфиги и шаблоны. За статусом таких групповых реконфигураций следит команда [Инфраструктуры Гео](https://abc.yandex-team.ru/services/maps-infra/).
