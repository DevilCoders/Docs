Библиотека для создания и публикации гипотез из новостного потока
===

![Новостные гипотезы в интерфейсе АРМа](https://jing.yandex-team.ru/files/arbel0s/hypotheses.png)

## Описание
Библиотека реализует следующий пайплайн обработки новостного потока:

1. Из новостного потока вычитываются релевантные нам новости про дорожные события: перекрытия дорог, изменения в работе общественного транспорта, открытие новых дорог.
2. Из текста новости выделяются названия городов, затем они геокодируются, и выбирается наиболее подходящий город.
3. Гипотезы публикуются в АРМ с привязкой к городу. Публикация происходит раз в минуту.

[Шедулер в сэндбоксе](https://sandbox.yandex-team.ru/scheduler/21659/view).

Для выявления новостей про дорожные события в общем потоке новостей нами был подготовлен [обучающий датасет](#подготовка-обучающего-датасета), при помощи которого команда Новостей дообучила свой классификатор. Затем на основе разметки [тестового датасета](#подготовка-тестового-датасета) нами была произведена [оценка качества и подбор порога классификатора](#анализ-результатов) .

## Этапы пайплайна

### Чтение и фильтрация новостей
Новости читаются из динамической упорядоченной таблицы [cache.fresh](https://yt.yandex-team.ru/hahn/navigation?path=//home/news/dynstorage/info-russian/cache.fresh), которая содержит все новости за последние 5 дней. Каждая новость снабжена, среди прочего, результатом работы классификатора – вероятностью быть релевантной нашей задаче. Мы берём все новости, у которых эта вероятность выше заранее определённого порога.

### Геопривязка
Из текстов новостей извлекаются названия городов с помощью библиотеки [address extractor](https://a.yandex-team.ru/arc/trunk/arcadia/FactExtract/address_extractor). Эти названия прогоняются через [геокодер](https://a.yandex-team.ru/arc/trunk/arcadia/extsearch/geo), затем выбирается лучший город по следующим критериям: 

1. Если нашлись города России, то берём только их, иначе, аналогично смотрим Беларусь, Казахстан и Украину. Другие страны не смотрим, чтобы исключить ложные срабатывания (например, во Франции есть город [Казани](https://yandex.ru/maps/152964/upper-corsica/search/Казани/?ll=9.491446%2C42.283811&z=12.77), но в новости скорее упоминалась Казань).
2. Среди городов из первого шага берём наиболее часто встречающийся в тексте. Если таких несколько, берём любой.

### Дедубликация
Входной поток новостей содержит довольно много дубликатов: новостей об одном и том же событии, перепечатываемых разными изданиями. Дедубликация новостей происходит в два этапа:

1. Используем дедубликатор команды Новостей, определяющий уникальность новости на основе всего текста. Данные берутся из [таблицы](https://yt.yandex-team.ru/hahn/navigation?path=//home/news/dynstorage/dupsd/dupsd-metrics-data).
2. Используем собственную дедубликацию на основе сравнения адресов, извлечённых address_extractor'ом, а также ключевых слов, содержащихся в тексте. В качестве ключевых слов выбраны, например, слова "ограничен", "открыт", "закрыт" (полный список можно посмотреть [тут](https://a.yandex-team.ru/arc/trunk/arcadia/maps/geoq/newsfeed_hypotheses/bin/keywords.json)), которые используются для разделения новостей про перекрытие и открытие одной и той же дороги, и тому подобного. Адреса и ключевые слова объединяются в одно множество, для сравниния этих множеств для пары новостей используется метрика [intersection over union](https://en.wikipedia.org/wiki/Jaccard_index). Каждая новость сравнивается со всеми новостями для того же города за последние 5 дней, если для какой-нибудь новости значение метрики превышает заранее заданный порог, то исходная новость признаётся дублем и не публикуется.

### Публикация гипотез
Гипотеза представляет из себя заголовок, текст и url новости, публикуется в АРМ, в центре города, определённого на предыдущем шаге. Если город определить не удалось, гипотеза публикуется в дефолтной точке, в настоящий момент это [ресторан "Страна которой нет"](https://yandex.ru/maps/org/strana_kotoroy_net/1166723766/), находящийся рядом с точкой публикации московских гипотез. Доля гипотез с геопривязкой составляет 80%.

## Подготовка обучающего датасета
Для обучения новостного классификатора необходимо было собрать обучающие выборки с 500-2000 положительными примерами на каждый класс. Силами экспертов разметили 2330 новостей с перекрытием 3. В итоге, получили 739 положительных примера ([табличка на yt](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/users/arbel0s/newsfeed/positive_examples)). Новости брались из предыдущего пайплайна, отфильтрованные [регэкспом](https://st.yandex-team.ru/ARMDEV-272).
Также, при разметке каждой новости приписывали один или несколько классов, по итоговому месту формирования гипотезы: АРМ, НЯК, ОТ.
Распределение новостей по классам (каждая новость может принадлежать нескольким классам, поэтому сумма значений в колонке больше, чем суммарное количество новостей):

|     | Количество | Доля |
|-----|------------|------|
| АРМ | 666        | 0.9  |
| НЯК | 97         | 0.13 |
| ОТ  | 120        | 0.16 |

Из-за недостатка новостей в классах НЯК и ОТ решили обучиться на один таргет, без разбиения на классы ([табличка с классами на yt](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/users/arbel0s/newsfeed/toloka_true_results)).

## Оценка качества
### Подготовка тестового датасета

Из всего новостного потока с 3 по 17 марта был случайно выбран сэмпл размером в 50000 новостей. Из этого сэмпла предыдущим решением (регэкспом) была получена 561 релевантная новость (regexp dataset). Далее, ко всему сэмплу был применён новый классификатор, из результатов которого было взято столько же лучших новостей, сколько получилось в regexp dataset (порог классификатора был равен 0.13). Таким образом был получен model dataset, также состоящий из 561 новости. В пересечении датасетов – 207 новостей. Оба датасета были отправлены на разметку экспертам на предмет релевантности.

### Анализ результатов

Точность [предыдущего решения (регэкспа)](https://st.yandex-team.ru/ARMDEV-272) – 33%
Поскольку весь новостной поток слишком большой (порядка 200000 новостей в сутки), то посчитать полноту (в отличие от точности) для регэкспа и модели не представляется возможным. Однако, мы можем посмотреть на полноту модели //относительно// регэкспа, а именно, посмотрим на график полноты модели на regexp датасете, в зависимости от порога классификатора. Из него можно понять, какой процент релевантных новостей, находимых регэкспом, находит модель, а сколько новостей мы теряем. Например, при пороге 0.5 модель находит примерно 67% релевантных новостей, находимых регэкспом, т. е. примерно треть релевантных новостей теряется (однако находятся и новые, которые не находил регэксп, в данном случае теряется 61 новость а находится новых – 47). Также на графике красными точками отмечена точность модели в зависимости от порога.

![metrics](https://jing.yandex-team.ru/files/arbel0s/1_metrics.png)

На втором графике изображено (в зависимости от порога) количество релевантных новостей, найденное регэкспом, но не найденное моделью (красный), а также найденное моделью, но не найденное регэкспом (синий). При пороге примерно равном 0.43 графики пересекаются, то есть суммарное количество релевантных новостей у модели будет таким же, как у регэкспа, однако точность модели (как видно на первом графике) будет равна 75%, в то время как у регэкспа она составляла 33%.

![lost_and_found](https://jing.yandex-team.ru/files/arbel0s/2_lost_and_found.png)

На третьем графике изображено ожидаемое количество гипотез в день, находимых моделью, в зависимости от порога (приблизительно). Для сравнения, регэксп давал примерно 1500 гипотез в день.

![news_count](https://jing.yandex-team.ru/files/arbel0s/3_news_count.png)
