## Метрики на основе датасета

Здесь описан способ как можно один раз описать метрики и получить их в А/Б экспериментах и в отчете статистики для дашборда.

### Необходимые условия
1. Есть посчитанный датасет на YT
2. Метрику можно посчитать на основе одной строки датасета

### Шаги
1. Разработка метрики в `features.py`, `metrics.py`
2. Проверка работы через отчет (`reports`)
3. Импорт в а/б метрики через `cofe`

#### Разработка метрики в `features.py`, `metrics.py`
В `metrics.py` описывается метрика, которая строится на основе фичей. Пример метрики
```
{
    "name": "Конверсия в дипъюз у POI", # Название метрики
    "type": "ratio", # Тип метрики: count или ratio
    "key": "basemap.{agg}.deep_use.poi.cr", # Техническое название
    "values": [
        "basemap.{agg}.deep_use.poi.count$",  # Первая фича метрики – числитель для ratio метрик
        "basemap.{agg}.card_open.poi.count$"  # Вторая фича метрики – знаменатель для ratio метрик
    ]
}
```

Пример фичи – количество открытий карточек POI над датасетом `basemap`
```
{
    "key": "basemap.{agg}.card_open.poi.count$", # Техническое название
    "calc": lambda rec: 1, # Способ вычисления. Одна строчка в basemap означает открытие карточки POI
    "dim": {"events", "users", "sessions"}, # Типы аггрегаций, каждое значение будет подставлено в `key`. Подробнее ниже
    "agg": max, # Способ аггрециий набора значений метрики в сессии (`dim=sessions`) и у пользователя за день (`dim=users`)
},
```

#### Про аггрегацию
Часто метрики нужно считать как сумму событий, кол-во уникальный сессий и пользователей с событием. Для настройки этого есть поля `dim` и `agg`.
- `dim=events` - считает сумму значений фичи
- `dim=sessions & agg=max` - считает кол-во уникальных сессий, в которых было хотя бы одно событие
- `dim=users & agg=max` - считает кол-во уникальных пользователей, в которых было хотя бы одно событие

`agg` – функция в питоне, которая на вход принимает список значений и возвращает одно значение.

#### Как назвать метрику и фичу
Техническое название метрики или фичи (`key`) мы стараемся составлять следуя правилам:
- ключ начинается с названия датасета
- далее через точку идет уровень аггрегации (`events`, `sessions`, `users`)
- далее название метрики  (`show`, `click`, `card_open`, `deep_use` и др.)
- далее название объекта/сущности над который считается метрик (`poi`, `geoproduct_poi` и др.)
- далее характеристика значения фичи
  - `count` если мы считаем кол-во чего-то, т.е. значение фичи `0` или `1`
  - `sum` если значение фичи вещественное число

Не каждый пункт обязателен, для некоторых метрик достаточно меньше составляющих.

| Неправильно | Правильно |
|:------------- |:-------------:|
| `sessions.{agg}.geoproduct_clicks$` | `sessions.{agg}.clicks.geoproduct_poi.count$` |


2. Проверка работы через отчет (`reports`)
Проверить метрики можно через расчет отчета, стандартного для датасета.
