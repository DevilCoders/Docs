# Датасет маршрутов

| Сервис | Ссылки |
|:------------- |:-------------:|
| Таблицы на YT | [//home/maps/analytics/datasets/routes](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/analytics/datasets/routes)
| Отчеты в Статистике | [Мобильные карт](https://stat.yandex-team.ru/-/CCUYZHD8TC)
| Фичи и метрики | [arcadia/maps/analytics/metrics/routes](https://a.yandex-team.ru/arc/trunk/arcadia/maps/analytics/metrics/routes)
| Датасет в Datalens | https://datalens.yandex-team.ru/datasets/ombf5bxi4amog-osnovnoy-myak


Датасет содержит информацию о построенных маршрутах на [экране маршрутов](https://jing.yandex-team.ru/files/ikolodkin/IMG_7149F62E0257-1.jpeg) в мобильных картах. 
Одна строчка этого датасета - это один успешный ответ с бекенда маршрутизатора (пруф [здесь](https://a.yandex-team.ru/arc/trunk/arcadia/maps/analytics/datasets/routes/mobile-maps/processors.py?rev=r9077165#L326)). При построении маршрута отправляется N асинхронных запросов в несколько бекендов, и на них приходит M ответов, где M≤N. Тогда это действие [построение маршрута пользователем] генерит M строчек в данном датасете. А далее к каждому ответу стараемся подклеить всю важную информацию, относящуюся к этому ответу:
- событие запроса (приклеивается почти всегда)
- действия пользователей после построения маршрута (переключение вкладок, просмотр подробной информации, переход в навигацию и т.д.)
- мета информацию о маршруте: точки маршрута, oid организации (если маршрут построен в оргу), тип маршрута и источник построения и др.
- тестовые бакеты

# FAQ

{% cut "Вопрос: если я построю пешеходный маршрут, потом перейду на транспортный маршрут, после снова перейду на пешеходные маршрут, то у пешеходного маршрута будут 2 строки?" %}

_Ответ:_
Нет, будет 1 строчка, потому что повторного запроса на бек не было. Но информация о переключении между типами маршрутов отобразится в списке сырых событий events, которые подклеятся к ответу маршрутизатора

{% endcut %}

{% cut "Вопрос: Если в табе авто мне предлагается 3 варианта, это будет 3 строчки?" %}

_Ответ:_
Нет, так как все эти варианты приходят в одном ответе. То есть автомобильный бекенд отдает все автомобильные, таксишный - все таксишные и т.д.

{% endcut %}






## Примеры расчетов по датасету

* [Посчитать](https://yql.yandex-team.ru/Operations/YILmOwPTTiVjLezNK3KwYCSN2QVkTGfKYYe_scQ3Uvs=) базовую воронку по каждому типу маршрута
* [Достать](https://yql.yandex-team.ru/Operations/YILnIr94hv4LoJEHD5li1OeVWtWcUisPFen7SEgORmA=) координаты точки А
* [Быстро сверить](https://yql.yandex-team.ru/Operations/YV73qK5ODyiPxJ7gPFKCF25_AvBMAdL0-vEYMo_hUP4=) значение основных метрик между текущей версией датасета и датасета с обновленной логикой (тестирование внесенных правок)
* [Быстро сверить](https://yql.yandex-team.ru/Operations/YV9ECNK3DFLDOGt33d2J5onHJODv68F25BLCAEw6yGA=) значение основных метрик маршрутной воронки между датасетом и сырыми логами ([то же самое](https://yql.yandex-team.ru/Operations/YV9HAJfFt7_woAQMk1U8QWzdv7QMFwgESluUMGi4fzQ=) но еще и по платформам)

## Описание полей

| Поле | Физический смысл |
|:-------------| -------------|
| `user_id` | DeviceID из аппметрики|
| `uuid` | UUID из аппметрики|
| `points` | Список точек маршрута. Параметры точки:  `lat`, `lon`, `is_my_location` – является ли точка месторассположением пользователя, `uri` - id организации, в которую строят маршрут.
| `route_type` | Тип маршрута|
| `is_showed` | Скольк раз был открыт табик маршрута (показан маршрут) автоматически или пользователей|
| `is_clicked` | Сколько раз пользователь  открыл табик |
| `with_navigation` | Сколько раз пользователь нажал в переход к навигации |
| `navigation_timestamp` | Время перехода в режим ведения|
| `navigation_variant` | Вариант маршрута для режима ведения|
| `with_first_km` | Пройден первый километр в ведении по авто-маршруту)|
| `with_last_km` | Остался один километр в ведении по авто-маршруту|
| `with_finish` | Доехал до конца в ведении по авто-маршруту|
| `source` | Каким способом был запрошен маршрут|
| `reqid` | id запроса в маршрутизатор в сессии (1, 2, 3)|
| `route_id` | id запроса в маршрутизатор `DeviceIDSessionIDHash` + `reqid`|
| `route_session_id` | ID маршрутной сессии. Маршрутная сессия – серия событий про маршрут без перерыва в 30 минут, которое начинается с отправки запроса в маршрутизатор (событие route.request-route).|
| `timestamp` | Время запроса|
| `test_buckets` | Список экспериментов|
| `events` | все события с этим `reqid`, отсортированные по `timestamp`. Хранится как `[{name:, value:, timestamp:}]`|
| `is_offline` | Получен ли ответ из офлайн маршрутизатора|
| `puid` | Паспортный id|
| `os` | Операционная система|
| `app_version` | Версия приложения |
| `user_geoid` | Регион пользователя |


## Данные в датасете не бьются с отчетом по датасету/сырыми логами. В чем причины?

{% cut "Расходятся метрики между датасетом и отчетом по датасету" %}

_Возможные причины:_

1. В датасете поля `is_clicked`, `is_showed`, `with_navigation` имеют тип Int64, то есть обозначают количество раз, сколько было совершено это событие. В отчет же метрики по этим полям транслируются в тип Bool, то есть было или не было совершено это событие пользователем. Сделано это потому, что нам важен сам факт совершения этого события для расчета метрик + таким образом мы избавляемся от тех случаев, когда было совершеного много повторных событий за короткое время. Такие повторные события не несут в себе никакой дополнительной информации, и можно их из расчета метрик исключать. 


{% endcut %}

{% cut "Расходятся метрики между сырыми логами и датасетом" %}

_Возможные причины:_

1. Может быть такая же причина, которая указана в первом пункте для раздела выше. 
2. Расхождение в метрике 'количество показанных маршрутов' между датасетом и сырыми логами. Причиной может быть то, что при расчете датасета есть [фильтр](https://a.yandex-team.ru/arc/trunk/arcadia/maps/analytics/datasets/routes/mobile-maps/processors.py?rev=r8176140#L303) только на успешные маршруты, то есть те, где было событие `route.success` после запроса на построение маршрута. Пояснения [тут](https://st.yandex-team.ru/GEOANALYTICS-823#6036106615fac24192909736) и [тут](https://st.yandex-team.ru/GEOANALYTICS-823#6041282958355524aeb15deb)
3. Есть расхождения в метриках по навигации (`routes.start-navigation`). Опять же, из-за фильтра на успешные маршруты мы можем не учитывать часть таких событий (но в разумных пределах). Также еще одна причина - часть таких событий может доезжать в таблички-источники еще некоторое время. У нас такие одиночные события (без предшествующего им `route.request-route` и `route.success`) не будут учитываться в датасете. Подробнее [тут](https://st.yandex-team.ru/GEOANALYTICS-823#6040aa7162c8bf6c69afdfaf)

{% endcut %}

## К кому можно обращаться с вопросами

Вопросы задавать можно в чат поддержки аналитики в [Slack](https://join.slack.com/share/zt-jfgq9obr-8WV8gxokWri3A1wa9TrBjg?cdn_fallback=1) или ikolodin@

