# Генерация сегментов пользователей для Мобильных Карт в админке дискавери

### Что это?
Результат расчета - регулярно обновляемая таблица на YT,
хранящая для каждого DeviceID пользователя список сегментов,
в которые этот пользователь попадает. Таблица работает только для МЯКа

### Зачем это?

Эта таблица служит точкой входа для админки дискавери discovery-admin.tst.c.maps.yandex-team.ru - для раскатки in-app коммуникаций (интроскрин, баннер и т.д.) на определенные сегменты юзеров

### Как устроено?

Сначала генерятся в отдельности каждый из сегментов. Способ генерации может быть произвольным, но результат должен быть строго определенного формата.

Требования в выходной таблице одного сегмента:
1. располагается по пути ```//home/maps/analytics/data/discovery-admin/prod/segments/{segment_name}/segment```, где
    - {segment_name} - имя сегмента (будет фигурировать в интерфейсах админок). Стиль - **snake case** (ex. my_pretty_segment)
    - segment_name - должен начинаться с префикса "navi_", если планируется использовать исключительно для аудитории Навигатора, и "maps_" - если для аудитории МЯКа
    - 'segment' - название таблицы (никакое другое недопустимо)
2. имеет схему ```{Name: DeviceID, Type: string/string?}``` (то есть ровно одна строковая колонка с названием DeviceID)
3. все DeviceID в таблице уникальны

Далее все эти таблицы каждый час объединяются YQL-скриптом, который складывает результат в продовую таблицу ```//home/maps/analytics/data/discovery-admin/prod/devices```
Дальше эта таблица импортируется бекендом админки дискавери - подробности тут: https://st.yandex-team.ru/MAPSHTTPAPI-2580
Важно! Объединяются только те таблицы, для которых есть описание в segments.yaml конфиге. То есть без описания сегмент не поедет в прод.

### Как создать новый сегмент?
Предполагается, что на данный момент у вас уже есть процесс, которым вы генерируете список DeviceID пользователей, подходящих под ваш сегмент._
1. Отправляете PR с описанием нового сегмента (правка конфига segments.yaml), в ревьюеры ставите @itangaev. При добавлении сегмента обязательно:
    - указать название сегмента (ключ в yaml файле является техническим ключом сегмента, поле ru_name - название сегмента в интерфейсе админки;
    - вкратце описать, зачем нужен сегмент;
    - определить круг лиц (включая роботов), которым будет доступно редактировние состава вашего сегмента (вписать их в поле owners). **Внимание!** Содержимое этого сегмента напрямую влияет на то, какие фичи и какие сообщения получат конечные пользователи продукта. Список лиц должен быть узким;
2. Создаёте тикет в GEOANALYTICS (можно сразу на @itangaev), связываете с pr;
3. результате выполнения тикета будет заведена нода в YT, в которую нужно положить таблицу (разово посчитанную или регулярно обновляемую - не важно). Требования к таблице описаны в предыдущем разделе.
