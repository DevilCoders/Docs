# Генерация сегментов пользователей для Мобильных Карт и Навигатора

### Что это?
Результат расчета - регулярно обновляемая таблица на YT,
хранящая для каждого DeviceID пользователя список сегментов,
в которые этоот пользователь попадает. Таблица единая для МЯКа и Навигатора

### Зачем это?

Эта таблица служит единой точкой входа для двух админок приложения:
1. админки экспериментов ab.yandex-team.ru - для выкатки AB экспериментов на определенный список DeviceID пользователей
2. админки дискавери discovery-admin.tst.c.maps.yandex-team.ru - для раскатки in-app коммуникаций (интроскрин, баннер и т.д.) на определенные сегменты юзеров

### Как устроено?

Сначала генерятся в отдельности каждый из сегментов. Способ генерации может быть произвольным, но результат должен быть строго определенного формата.

Требования в выходной таблице одного сегмента:
1. располагается по пути ```//home/maps/analytics/data/ab_segments/prod/segments/{segment_name}/segment```, где
    - {segment_name} - имя сегмента (будет фигурировать в интерфейсах админок). Стиль - **snake case** (ex. my_pretty_segment)
    - segment_name - должен начинаться с префикса "navi_", если планируется использовать исключительно для аудитории Навигатора, и "maps_" - если для аудитории МЯКа
    - 'segment' - название таблицы (никакое другое недопустимо)
2. имеет схему ```{Name: DeviceID, Type: string/string?}``` (то есть ровно одна строковая колонка с названием DeviceID)
3. все DeviceID в таблице уникальны

Далее все эти таблицы каждый час объединяются YQL-скриптом, который складывает результат в продовую таблицу ```//home/maps/analytics/data/ab_segments/prod/devices```
Sandbox-таска забирает эту продовую таблицу 4 раза в день и аплоадит в ecstatic (в бекенд мапкита) . Головной тикет: https://st.yandex-team.ru/MAPSMOBCORE-13939
Мапкит использует эту таблицу при наличии условия **anyDeviceSegments** в экспериментальной выборке (пример: https://ab.yandex-team.ru/testid/529803)
Использование таблицы админкой дискавери ещё обсуждается, головной тикет: https://st.yandex-team.ru/MAPSHTTPAPI-2580

### Как создать новый сегмент?
_Предполагается, что на данный момент у вас уже есть процесс, которым вы генерируете список DeviceID пользователей, подходящих под ваш сегмент._
1. Создаете тикет в GEOANALYTICS (можно сразу на @itangaev), в котором:
    - вкратце описываете, зачем нужен новый сегмент;
    - указываете название сегмента;
    - определяете круг лиц (включая роботов), которым будет доступно редактировние состава вашего сегмента. **Внимание!** Содержимое этого сегмента напрямую влияет на то, какие фичи и какие сообщения получат конечные пользователи продукта. Список лиц должен быть узким;
    - определяете срок жизни сегмента (максимум 1 год; по истечении перевыдаем роли).
2. В результате выполнения тикета будет заведена нода в YT, в которую нужно положить таблицу (разово посчитанную или регулярно обновляемую - не важно). Требования к таблице описаны в предыдущем разделе.
