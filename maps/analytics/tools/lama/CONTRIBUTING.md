# Contributing

## Файловая структура
```shell
bin/            # директория сборки бинаря
    commands/   # обработка аргументов и вызов команд
    lama.py     # входная точка
examples/       # примеры
lib/            # основной код
    commands/   # команды
    providers/  # провайдеры данных
presets/        # пресеты для конфига
schemas/        # схемы
```

## Разработка
Лучше использовать флаг `--debug` для отладки, но можно отлаживаемся в тестовом окружении. Тестовый окружения есть для всех сервисов, кроме juggler. См. [hosts.py](lib/hosts.py). Чтобы включить тестовое окружение:
```shell
$ export LAMA_TESTING=1
```

Чтобы удалить переменную окружения выполните.
```shell
$ unset LAMA_TESTING
```

### Архитектура

1. Работа с командной строкой инкапсулирована в папке [bin](bin), код в [lib](lib) ничего не должен знать про CLI.
2. Код в [bin/commands](bin/commands) должен быть максимально простым. Весь основной код должен лежать в `lib`.
3. В [config.py](lib/config.py) инкапсулирована логика по получению конфига:
  * загрузка файла с файловой системы (продакшен) или из ресурсов (тестинг)
  * применение пресетов (за пределами загрузчика конфига никто не знает про пресеты)
  * также содержит набор костылей для упрощения работы
4. Весь код по работе с внешними сервисами помещается в [провайдеры](lib/providers), т.е. получение/отправка данных происходит только через свои провайдеры.
5. Интерфейс провайдера следующий:
```python
class Provider():
    def get_all(self, ...):
        pass

    def is_<entity>_exists(self, ...):
        pass

    def get_<entity>(self, ...):
        pass

    def create_<entity>(self, ...):
        pass

    def remove_<entity>(self, ...):
        pass
```
6. При выполнении команды `lama sync -f` последовательно выполняется три команды:
  * `validate` — валидация конфига по схеме
  * `diff` — выводит дифф изменений + отмечает какая из секций конфига (reactor, solomon, juggler) изменилась
  * `sync` — принимает на вход флаг `force` и флаги наличия изменений в соответствующих секциях конфига.
    * если указан флаг `force` + есть дифф для секции, то происходит обновление сущностей в этой секции
    * обновление — это удалить сущность, а потом на её месте создать новую

См. также:
  * [Рассказ hevil@ про устройство lama](https://disk.yandex.ru/public/nda/?hash=Mu%2B0P%2Bjhi6k2x7o6ATwCwB4uptu7TlhJFp1PTHCyjYBwiForC%2BB4cHcXAjS2odRCq/J6bpmRyOJonT3VoXnDag%3D%3D)
