# lama
`lama` — это CLI-утилита, позволяющая хранить конфигурацию `Reactor` в репозитории в виде конфига.

Это позволит ревьюить изменения в реакторе перед тем, как применить их на сервере, а также легко откатывать в случае обнаружения ошибки.

Также с помощью конфигов можно настроить алерты в `Solomon` и проверки в `Juggler`.

## Установка

1. [Счекаутить Аркадию](https://doc.yandex-team.ru/arc/setup/arc/install.html)
2. Собрать ```lama```:

```
$ cd ~/arc/arcadia/maps/analytics/tools/lama/bin
$ ya make
```

3. Установить симлинку, чтобы lama была доступна глобально.

```
$ ln -snf ~/arc/arcadia/maps/analytics/tools/lama/bin/lama  /usr/local/bin/lama
```

## Авторизация
Получите токены для внутренних сервисов:
* для [Nirvana](https://oauth.yandex-team.ru/authorize?response_type=token&client_id=637ca17604cb4dfa90b262952c00b1e9) и задайте его в переменной окружения `NIRVANA_TOKEN`
* для [YT](https://docs.yandex-team.ru/yt/quickstart#how-to-get-oauth-token) и задайте его в переменной окружения `YT_TOKEN`
* для [Solomon](https://wiki.yandex-team.ru/solomon/api/v2/#oauth) и задайте его в переменной окружения `SOLOMON_TOKEN`
* для [Juggler](https://docs.yandex-team.ru/juggler/authentication) и задайте его в переменной окружения `JUGGLER_TOKEN`
* для [ABC](https://oauth.yandex-team.ru/authorize?response_type=token&client_id=23db397a10ae4fbcb1a7ab5896dc00f6) и задайте его в переменной окружения `ABC_TOKEN`

```shell
export NIRVANA_TOKEN='<ваш токен>'
export YT_TOKEN='<ваш токен>'
export SOLOMON_TOKEN='<ваш токен>'
export JUGGLER_TOKEN='<ваш токен>'
export ABC_TOKEN='<ваш токен>' (если используете поля owners)
```

## Ограничения
* Reactor
  * только реакции, артефакты и очереди
  * только артефакты определенных типов (см. `ArtifactType` в [json-схеме](schemas/config.yaml))
  * ограниченный набор параметров в реакции (например, нельзя задать входные и выходные параметры блоков, а также нотификации)
  * не поддержан механизм частичной модификации реакции/артефакта/очереди (только пересоздание с нуля с потерей истории запусков)
  * при создании реакции/артефакта/очереди всегда добавляются метрики с дополнительной меткой `path`, содержащей путь до реакции/артефакта (настроить это в конфиге нельзя)
  * можно создавать реакции `nirvana` и `sandbox`
* Solomon
  * только алерты и каналы
  * для алертов поддержан только типа `expression`
* Juggler
  * только чеки и правила нотификации

Эти ограничения можно убрать. Для этого можно [законтрибьютить](CONTRIBUTING.md) ;)

## Конфиг
По умолчанию `lama` ищет конфиг с именем `lama.yaml` в текущей директории. Но можно указать путь до конфига с помощью опции `-c`.

Конфиг имеет следующий вид:
```yaml
owners:
  - name: maps-analytics
    scopes:
    - duty
    - developers
  - name: maps-front
    - duty

config:
  ci: true

reactor:
  reactions:
    - path: <путь до реакции>
      project: 
        <путь до проекта в реакторе>
      ttl_days:
        <время жизни инстансов реакций>
      trigger:
        DEPRECATED
      triggers:
        <описание запуска реакции>
      parameters:
        <квота, ретраи, воркфлоу, ttl...>
      expressions:
        globals:
            <глобальные переменные (код)>
        on_success:
            <обработчик успешного завершения (код)>
        on_fail:
            <обработчик завершения с ошибкой (код)>
      inputs:
        globals:
          <список глобальных переменных для воркфлоу>
  queues:
    - path: <путь до реакции>
      configuration:
        <конфигурация очереди>
      reactions:
        <список реакция очереди>
  artifacts:
    - path: <путь до артефакта>
      type: <тип>

solomon:
  project_id: <проект в соломоне>
  alerts:
    <список алертов>
  channels:
    <список каналов>

juggler:
  checks:
    <список проверок>
  notify_rules:
    <список правил нотификации>
```

В owners указыаются abc сервисы со скоупами, кто ответственный за расчет. Если у вас есть в блоке джаглера у check-ов темлейт стартрека, то все ответственные будут добавлены в наблюдатели.
В configs указываются проект-specific поля, которые ламой никак не обрабатываются
Примеры конфигов можно найти в папке [`examples`](examples) или в проекте [maps-analytics](https://a.yandex-team.ru/search?search=,%5Emaps%2Fanalytics.*lama.yaml,jC,arcadia,,5000&repo=arc).


### Управление статусом реакции через конфиг
При создании реакция переводится в статус `ACTIVE`, т.е. "включается". Если после создания реакции её "выключить" через веб-интерфейс, то она "включится" только при последующем пересоздании.

Чтобы явно контролировать статус реакции рекомендуется указывать поле `status`.
```yaml
- path: path/to/reaction
  status: ACTIVE
```
Чтобы "выключить реакцию достаточно указать:
```yaml
- path: path/to/reaction
  status: INACTIVE
```


### Пресеты
**При добавлении новых пресетов, обязательно добавляйте юнит тесты**

Чтобы уменьшить размер конфигов, можно использовать механизм пресетов.

**Пресет** — это шаблон для части конфига. Дополняет эту часть конфига дополнительными параметрами.

Например, имеем часть конфига
```yaml
- service: my_service
  preset: path/to/preset
  preset_options:
    namespace: my_namespace
```
и пресет
```yaml
host: my_project
namespace: geo.${my_namespace}
refresh_time: 90
ttl: 900
```
в итоге конфиг развернётся в
```yaml
- service: my_service
  host: my_project
  namespace: geo.my_namespace
  refresh_time: 90
  ttl: 900
```
Как видно, для пресета можно добавлять `preset_options`, которые можно как параметры использовать в шаблоне.

Список доступных пресетов и доступные параметры смотрите в [presets/README.md](presets/README.md)

## Команды
Для получения справки о доступных командах и параметрах запустите `lama` без параметров.
```shell
$ lama
```

### validate
Валидирует конфиг по [json схеме](schemas/config.yaml).
```shell
$ lama validate
```

### diff
Показывает разницу между локальным конфигом и конфигурацией на сервере.
```shell
$ lama diff
```

### sync
Применяет локальный конфиг на сервер.

При запуске без параметров будет показан дифф, а синхронизация не произойдет.
```shell
$ lama sync
```

Для того, чтобы локальные изменения применились на сервер, необходимо указать флаг `-f`.
```shell
$ lama sync -f
```

Чтобы локально отлаживать, необходимо указать флаг `--debug`. Тогда пути в конфиге поменяются на `home/${user-login}` и будут использоваться персональные проекты (`lama-${user-login}`) в `juggler` и `solomon`. Также реакция будет создаваться неактивной. 
```shell
$ lama sync --debug
```

Команда `sync` может быть запущена в режиме синхронизации множества конфигов. Для этого необходимо указать флаг `-r`.
```shell
$ lama sync -r -f -d <directory>
```
В результате выполнения команды будут синхронизированы все конфиги из `<directory>`. Если директория не указана, то берется текущая директория.

С помощью этой команды можно сделать автодеплой конфигов из Аркадии. См. [пример](https://reactor.yandex-team.ru/browse/resolve?path=/maps/analytics/tools/lama-sync).

## clean
Приводит состояние сервера в строгое соответствие с содержимым конфигов, удаляя лишнии сущности.

Команда `lama sync` только обновляет сущности, описанные в конфиги. Но если удалить конфиг, то `lama sync` перестаёт "знать" о существовании сущностей, описаннаых в удалённом конфиге.

Команда `lama clean` занимается поиском таких "сироток" и удаляет их с серверов. Принцип действия простой:
1. Собирает список всех конфигов из указанной директории (по аналогии с `lama sync`).
2. Собирает список сущностей в Реакторе, Соломоне и Джаглере.
3. Сравнивает полученные списки между собой.
4. Удаляет с серверов те сущности, которые не описаны конфигами.

При запуске выведет набор сущностей-претендентов на удаление.
```shell
$ lama -v clean -d <directory> --reactor-path <reactor-path> --solomon-project <solomon-project> --juggler-host <juggler-host>
```

Для того, чтобы локальные изменения применились на сервер, необходимо указать флаг `-f`.

### init
Создаёт конфиг по данным из реактора.
```shell
$ lama init <path>
```
В качестве `path` можно указать:
* путь до артефакта (будет создан конфиг с артефактом)
* путь до реакциии (будет создан конфиг с реакцией и артефактами, инстансы которых создаются в `on_success` и `on_fail`)
* путь до очереди (будет создан конфиг с очередью и зависимыми реакциями и артефактами)
* путь до папки (будет создан конфиг со всеми реакциями и артефактами, расположенными в корне этой папки)

### make_sample
Создает семплы для YQL расчета
```shell
$ lama make_sample --date <date>
```

Если входные таблицы зависят от даты, то ее нужно передать в команду. 

Семплы, схема и yql аттрибуты будут сохранены рядом с `query.sql` в `tests/fixtures`, также будет технический конфиг в `tests/config.json`. 
Семплы будут храниться в YT формате, т.е. построчно. Можно будет легко загрузить туда утилитой `yt` или скачав данные в виде json c запуска `YQL`.

**ВАЖНО: В самом yql мы ждем только одну дату и только с названием `$date`**

Чтобы скрипт нашел все входные данные, они должны быть в определенном формате:
1. Весь путь инлайном
  
    `from '//home/maps/analytics/your_path'`
2. Весь путь в переменной 

    `from $input_path`, где 
    
    `$input_path = '//home/maps/analytics/your_path'` или 

    `$input_path = '//home/maps/analytics/your_path' || $date`

3. Весь путь в `range`
    
    `from range('//home/maps/analytics/your_path', $date, $date)`

4. Весь путь в переменной в `range`

    `from range($input_path, $date, $date)`, где `$input_path` как в п.2

Если нужно добавить флаг `debug` делаем это так:

```
$debug = True; -- of False
$statface_table = '//home/maps/analytics/legacy/yql/jsapi/statface'; -- прод имя
$statface_table = if($debug, Re2::Replace('home/maps/analytics')($statface_table, 'home/maps/analytics/tmp'), $statface_table); -- tmp имя
```

### test
Тестирует YQL расчет локально (only `Linux`)
```shell
$ lama test -s
```

**ВАЖНО: Нужно задать переменную окружения `ARCADIA_PATH` с абсолютным путем до Аркадии**

- Поднимает локальные `YQL` и `YT`
- Загружает семплы в локальный `YT`
- Запусает расчет `YQL`
- С флагом `-s` сохраняет выходные таблицы локально
- Без флага `-s` сравнивает таблицы с локально сохраненным результатом

### CI

Есть возможность запускать в CI валидацию, или даже синхронизацию лама конфига, чтобы удостовериться что в продакшн это точно заработает.

1. Нужно выставить переменную `CI`
2. Пробросить логин робота в переменную `CI_ROBOT_LOGIN`, который перетрет поле `workflow_owner` (обязательное поле)
3. Пробросить уникальный ID в переменную `CI_ARK_PR` (например номер `PR`). В домашеней папке робота будут создаваться папки с таким именем.
4. Запустить `lama validate` или `lama sync --debug -f` внутри `CI`

# FAQ

- Если ошибка вида `Can’t find reaction under non-reaction type Namespace`, то скорее всего вы названил реакцию и артефакт одним именем. Должны быть разные имена
- Можно ли зафиксировать используемый workflow_id? `Да, нужно указать instance_id вместо workflow_id`
- Как нужно создавать channels для соломона? Не нужно создавать в каждом файле `lama.yaml` один и тот же `channels` для соломона. Он должен быть создан один раз основным файлом инфраструктуры
