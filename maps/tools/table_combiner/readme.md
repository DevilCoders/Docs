# Table combiner
Inspired by and copypasted from https://a.yandex-team.ru/arc_vcs/market/dynamic_pricing/tools/tables_combining

## Что и как делает
Объединяет таблицы в партиции за определенный период.
1. Смотрит все обновления таблиц в заданных папках (определяется по [revision узлов кипариса](https://yt.yandex-team.ru/docs/description/common/cypress#time_attributes))
2. Ищет все временные отрезки размера `scale` которые затронули изменения из пункта 1.
3. Перестраивает соответствующие таблицы.

Схема итоговой таблицы. Ну тут все очень-очень просто.
* Если у всех исходных таблиц схема одинаковая, то у результата будет в точности она + доп столбец с именем исходной таблицы
* Если схемы таблиц друг другу не противоречат, а просто дополняют друг друга столбцами, то у результата схема будет включать в себя все столюбцы которые встречаются в исходных таблицах.
* Если есть хотя бы одна таблица без схемы, то кидаем ошибку.
* Если встречаются противоречия числовых типов, то кидаем ошибку.
* При любых других противоречиях кидаем ошибку.

Все столбцы в финальных таблицах опциональны.
При слиянии сортировки делаются, если вы этого захотите.

### Формат конфига
Конфиг представляет собой список конфигов для каждой директории

Конфиг для директории это словарь содержащий:
- `source_path: str` - путь к директории на
- `source_table_name_pattern` - формат для перевода имени таблицы в дату. Пример: Для ISO формата времени паттерн - `'%Y-%m-%dT%H%M%S'`
- `cluster: list[str]` - список кластеров на которых нужно запустить объединение таблиц
- `scale: str` - размерность в которую нужно объединять таблицы. Допустимые значения `'daily', 'monthly',
  'yearly'`
- `result_path: str` - путь для объединенных таблиц
- `result_table_ttl: optional[int]` - TTL для результатов (в днях), если нет, то ttl не будет
- `result_table_name_pattern: optional[str]` - формат для перевода имени результирующей таблицы в дату. Пример: Для ISO формата времени паттерн - `'%Y-%m-%dT%H%M%S'`. Если не задан, то формат будет функцией от `scale`.
- `sort_by: optional[list[str]]` – список колонок по которым сортировать итоговую таблицу

Пример:
```
[
    {
        "clusters": [
            "hahn"
        ],
        "source_path": "//home/maps/users/iambackend/tmp/fake_stats",
        "source_table_name_pattern": "%Y-%m-%d",
        "scale": "monthly",
        "result_path": "//home/maps/users/iambackend/tmp/fake_stats_monthly",
        "result_table_ttl": 1080,
        "table_name_field": "datetime",
        "sort_by": [
            "datetime"
        ]
    }
]
```

### Хочу запустить свою, что делать?
Сделать свой [SEDEM шедулер](https://docs.yandex-team.ru/sedem/services/sandbox) по аналогии с [этим](https://a.yandex-team.ru/arc_vcs/maps/geoq/table_combiner). Или делайте не через SEDEM, это просто питоновская либа, можно запускать ее как угодно, хоть кроном на своей машине.
