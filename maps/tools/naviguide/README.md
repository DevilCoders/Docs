Ведение по маршруту
===

Тулза для симуляции ведения по маршруту в навигаторе. В основе лежит библиотека ведения по маршруту [`maps/analyzer/libs/guidance`](/arc/trunk/arcadia/maps/analyzer/libs/guidance).<br>
Содержит тулзы:
  * [`bin/naviguide`](bin/naviguide) — матчер, на вход принимает сигналы в yson-формате, на выход — привязанные позиции и маршрутные статусы в yson-формате. Также может выдавать подробную отладочную информацию в [`easyview`](/arc/trunk/arcadia/maps/tools/easyview)-совместимом формате.
  * [`tools/convert_config`](tools/convert_config) — конвертирует конфиги из naviguide-формата в формат, пригодный для guidance-offline-extractor (тулза в мобильном репозитории для симуляции привязки, устаревшая), или для создания выборки в экспериментах
  * [`tools/debug_context`](tools/debug_context) — фильтрация избыточного отладочного вывода; оставляет подробную информацию о кандидатах только возле отмеченных на таймлайне мест
  * [`tools/draw_uuid_info`](tools/draw_uuid_info) — преобразует сигналы/треки/маршруты пользователя (см. тулзу `extract_uuid_info`) в анимированный [easyview](/arc/trunk/maps/tools/easyview)-формат; т.е. сигналы, сегменты и маршруты показываются в актуальное время. Этот файл можно сконкатенировать с отладочным выводом [`bin/naviguide`](bin/naviguide), чтобы сравнить реальные маршруты и симулированные.
  * [`tools/evaluate_experiment`](tools/evaluate_experiment) — утилита, которая считает разные оффлайн-статистики за день для выбранного эксперимента
  * [`tools/extract_uuid_info`](tools/extract_uuid_info) — вспомогательная утилита для доставания из логов на YT: версии библиотеки, экспериментов и их конфигов; также формирует конфиг для симуляции и может достать такие данные, как сигналы, треки, запросы маршрутов и залогированные блобы
  * [`tools/leptidea_route`](tools/leptidea_route) — лептидейный псевдо-роутер, прокладывает маршрут из точки в точку только по лептидейному графу
  * [`tools/optimize_config`](tools/optimize_config) — оптимизатор параметров конфига клиентской привязки
  * [`tools/match_losts_with_sim_events`](tools/match_losts_with_sim_events) — тулза для анализа событий, происходящих в симуляции "вокруг" продовских ложных сходов
  * [`tools/parse_blobs`](tools/parse_blobs) — конвертирует blob'ы из отчётов в yson; если находит запись с версий — выводит её в stderr.
  * [`tools/simulate`](tools/simulate) — запуск симуляции на одном блобе или на одном репорте в двух режимах

### Быстрый локальный запуск

Для простого запуска на блобе без использования продакшновых маршрутах достаточно:
```bash
$ cat data/MAPKITSIM-4298.pb | ./tools/simulate/bin/simulate -o out --debug
$ cat out/*.ev | ~/arcadia/maps/tools/easyview/bin/easyview
```

Для указания конфига можно передать флаг `--config`.<br>
См. более подробную инструкцию в [`tools/simulate`](tools/simulate).

API
===

* [`lib/include/input.h`](lib/include/input.h) — тип `GuideEvent`, принимаемый основным классом, а также функции чтения события из yson или protobuf blob
* [`lib/include/output.h`](lib/include/output.h) — вывод результата привязки в yson-формате
* [`lib/include/debug.h`](lib/include/debug.h) — отладочный вывод в [`easyview`](/arc/trunk/arcadia/maps/tools/easyview)-совместимом формате
* [`lib/include/naviguide.h`](lib/include/naviguide.h) — основная логика, обработка событий (`GuideEvent`)
* [`lib/include/leptidea_router.h`](lib/include/leptidea_router.h) - псевдо-роутер, прокладывает маршруты из точки в ребро/точку по лептидейному графу. Не учитывает via-точки
* [`lib/include/navirouter.h`](lib/include/navirouter.h) - обёртка над роутером, делает запросы и реальный роутер или псевдо-роутер
* [`lib/include/route_prolonger.h`](lib/include/route_prolonger.h) - прокладывает маршруты, используя эталонные треки и маршруты

Алгоритм построения маршрута в симуляции с использованием продовских треков и маршрутов
===
Класс [`RoutesEtalonsData`](lib/include/route_prolonger.h) заранее хранит `commonEdgesSegments` - список всех сегментов рёбер, которые есть на треке и на "соответствующем" маршруте. Маршрут, соответствующий ребру - это маршрут, активный на момент времени нахождения пользователя на этом ребре.

Когда происходит запрос на построение маршрута, алгоритм начинает перебирать все сегменты из `commonEdgesSegments`, которые моложе, чем момент запроса.<br>
Перебор определяется такими параметрами:
- `RouteRequest` - сам запрос на построение маршрута, содержит точки начала, конца и дополнительные параметры
- `RouteFn` - функция построения маршрута без использования треков и маршрутов
- `CompareRoutesFn` - функция сравнения двух построенных маршрутов
- `StopFn` - функция остановки перебора

На каждой итерации алгоритм строит маршрут: префикс маршрута до `commonEdgeSegment` строится с помощью `RouteFn`, суффикс берётся из продовского маршрута. Затем полученный маршрут сравнивается `CompareRoutesFn` с "лучшим" маршрутом, и если новый маршрут меньше - он становится "лучшим". Лучший маршрут подставляется в `StopFn` и если правило сработало, то перебор останавливается.

Сейчас кастомные параметры такие:
- `RouteFn` - это вызов лептидейного псевдо-роутера, описанного в [`lib/include/leptidea_router.h`](lib/include/leptidea_router.h)
- `CompareRoutesFn` - чем короче длина префикса маршрута, построенного лептидейным роутером, тем лучше
- `StopFn` - правило остановки следует из правила сравнения - если кратчайшее расстояние между точкой запроса и `commonEdgeSegment` больше, чем длина найденного "лучшего" префикса, то можно не перебирать дальше
