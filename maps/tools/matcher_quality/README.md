# Утилиты для тестирования матчеров

## Как считать метрики:
evaluate_matcher_binary -- матчит вашим матчером и считает метрики по эталонам
    Вызывается как-то так:
```
ALZ_API_GRAPH_VERSION=17.11.29-1
./evaluate_matcher_binary/evaluate_matcher_binary -d ./testdata/handmade/ \
-m '/full-path-to-arcadia/maps/analyzer/toolkit/bin/match_signals/match_signals \
--graph-version 17.11.29-1/ \
--matcher-config /maps/analyzer/libs/graphmatching/conf/offline'
```

Для работы нужен бинарник реализующий интерфейс тулкитового match_signals со всеми параметрами к нему и директория с тестовыми данными, с подпапками etalon и signals,  в каждой из которых лежат файлики, по одному файлику на трек, у соответствующих сигналов и эталона должны быть одинаковые имена файлов, в коде они называются тегами.
Выглядит вот так:
```
dir/etalon/{tag}
dir/signals/{tag}
```
evaluate_matcher_binary
    -- создаст третью папку `dir/matched` и соотвествующие файлики в ней.
    -- для каждого тега посчитает статистики и напишет их в dir/matched_stats (в нём удобно грепать примеры ошибок)
    -- усреднит всё и напечатает -- смотреть предлагается на метрику `jaccard` если вы хотите оптимизировать геометрическую точность матчинга и на `perfection` -- если вас интересуют корректные тревелтаймы.

## Откуда брать эталоны:

1) в `testdata/handmade` лежат примеры размеченные руками. Точнее лежат сигналы в папке signals и еще два файлика -- routes, в котором для каждого файлика с сигналами сохранены урлы ведущие на десктопные карты, на которых правильно построен эталонный маршрут. И geometries в котором лежат геометрии этих маршрутов (их лучше хранить, тк не отовсюду можно сходить в продакшен роутера, для хождения нужен актуальный граф из продакшена да и нет гарантий что маршруты будут строиться теже). Для того чтобы появились эталоны надо запустить бинарник etalons_from_geometries c правильной версией графа в `ALZ_API_GRAPH_VERSION`, например:
```
ALZ_API_GRAPH_VERSION=17.11.29-1 ./etalons_from_geometries/etalons_from_geometries -d testdata/handmade/
```
(handmade данные, по понятным причинам, имеют неправильные travel_time и проверяют только геометрию)

Если хочется добавить свой трек, то надо создать новый файлик в `testdata/handmade/signals`, туда скопипастить сигналы в стандратном формате, потом пойти на болльшие карты, построить там эталонный маршрут, скопипастить ссылку из url, вставить её в `testdata/handmade/routes` и запустить `routes_to_geoms` (для работы ему нужен только путь до папки с данными и граф в ALZ_API_GRAPH_VERSION)

2) Есть возможность генерировать эталоны по известным трекам (можно и без них, но так показалось сложно и излишне и я это убрал в итоге). Для этого достаточно таблички с тревелтаймами (из них в итоге будет взята только последовательность рёбер). По этой табличке бинарник etalon_generator сгенерирует сигналы и эталоны похожие на настоящие.
Его непросто запускать руками, по этому я закоммитил скрипт generate_etalon.sh с примером вызова.

## Полезняшки:

draw.py преобразовывает любой файл (сигналы, треки, геометрии) к формату easyview, можно передавать их в пермешку не указывая формат, типо того.
```
cat testdata/generated/*/generated_101 | python scripts/draw.py | easyview
```


Всем скриптам с графом надо ставить ALZ_API_GRAPH_VERSION
