## easyview
Способ быстро и просто рисовать точечки и палочки на карте и открыть её в браузере, она будет шустро работать даже с миллионами обьектов.

Библиотека для вывода в easyview-формате: [`maps/tools/easyview/lib`](lib), [`maps/tools/easyview/pylib`](pylib) (python-версия). См. [`examples`](examples) для примеров использования библиотеки.

### Пример:

```bash
$ echo 23.7042850376 52.0258719646 text | easyview
http://albireo.maps.dev.yandex.net:61347
```

### Формат:
1) csv (по умолчанию разделен пробелами)
```
lon lat [text]     -- так оформляется точка на карте
```

```
lon1 lat1 lon2 lat2 ...... [text] -- так обозначается ломанная или полигон (см. ниже про стили)
```

2) yson<br>
В easyview можно пайпать таблички из  ```yt read-table --format '<format=text>yson'```, при этом все поля будут выведены во всплывающей подсказке<br>
В объектах могут быть поля для задания геометрии и/или стилей. Геометрия может быть задана:
  * `lon`, `lat`, `direction` (optional) — точка, при наличии `direction` рисуется направленным треугольником
  * `start_lon`, `start_lat`, `end_lon`, `end_lat` — сегмент
  * `polyline=[pt1; pt2; pt3; ...]` — полилиния, где точка может быть в одном из двух форматов:
      - `[<lon>; <lat>]` — список
      - `{lon=<lon>;lat=<lat>}` — словарь
  * `polygon=[pt1; pt2; pt3; ...]` — полигон, где точка в форматах, аналогичных указанным выше для полилинии

Про стили см. ниже.

### Стили:
Стили можно задавать глобально через параметры командной строки, либо строками в одном из форматов:

#### CSV:
Стиль точек и полигонов задаётся так:
```
!pointstyle=black:blue:6
```
или, с указанием ширины обводки:
```
!pointstyle=black:blue:6:2
```

Стиль ломаных так:
```
!linestyle=red:2
```

Переключение на полигоны задаётся так:
```
!polygon
```

На ломанные:
```
!polyline
```

По умолчанию создаются ломанные.


#### YSON:

Стили задаются при помощи полей:
  * `_linestyle` — задаёт стиль отрезка, может быть строка вида `color:width`, так и объект с полями (некоторые могут отсутствовать):
    - `color` — цвет линии
    - `width` или `size` — ширина линии
  * `_pointstyle` — задаёт стиль точки, либо строка вида `fill:outline:radius`, либо объект с полями (некоторые могут отсутствовать):
    - `fill` — цвет закраски точки
    - `outline` — цвет границы
    - `radius` или `size` — размер/радиус точки
    - `scalable` — масштабируется ли точка в зависимости от зума. По умолчанию масштабируется, и размер анимированной и обычной точек совпадают. Если указать `%false`, то размер будет в метрах.
    - `width` — ширина обводки точки/полигона
    - `color` — оба цвета
  * `_style` — задаёт стиль только для текущего объекта, соот-но используется только внутри yson, задающего некий объект. Если объект — точка, то формат содержимого используется тот же, что и для `_pointstyle`, аналогично для линии

Стили `_linestyle`, `_pointstyle` могут быть заданы как составная часть объекта (в том числе одновременно могут быть заданы оба), при этом применяется стиль глобально, т.е. меняется и для последующих тоже, а могут быть заданы и в виде отдельного объекта.

Если, например, в объекте, задающем точку, есть одновременно и `_pointstyle`, и `_style`, то сначала применяется стиль `_pointstyle`, обновляющий глобальный стиль, а затем только для текущей точки применяется `_style`.

Примеры:

Задать стили:
```yson
{_pointstyle={fill=black;outline=blue;radius=6.;width=2.}};
{_pointstyle={color=red;size=6}};
{_linestyle={color=red;width=3}};
{_linestyle={color=blue;size=3}};
{_pointstyle={color=red;size=6};_linestyle={color=blue;size=10}};
{_pointstyle="green:green:4";_linestyle="blue:10"};
{lon=55.0;lat=33.0;_style={color=green;size=12};_pointstyle={}};
```
### Цвет:
Цвет можно задать словом (`blue`, `green`, `black` и т.п.), либо в формате `rgba(red,green,blue,alpha)`. Пример отрисовки красного полупрозрачного квадрата:

```yson
{_pointstyle={"fill"="rgba(128,0,0,128)"}}
{polygon=[[0;0];[10;0];[10;10];[0; 10]]}
```

#### Именнованные стили:

Только для YSON. Стили можно именовать и затем ссылаться на них из объектов. Для того чтобы
назвать стиль, в объекте должна быть хоть какая-то из глобальных установок стилей - `_pointstyle`, `_linestyle` на
момент написания и член `_define_class_style` с именем стиля. С этого момента на стиль можно ссылаться
из других объектов.

Чтобы сослаться на стиль, надо в объекте указать поле `_class` с именем нужного стиля. Применение стиля выглядит
следующим образом:
1. Сначала применяется именнованный стиль соответствующего `class`
2. Затем поверх него применяется `_poinstyle` и `_linestyle`
3. Затем применяется `_style`.

Т.е. процесс отличается от объекта без указания класса только тем что в качестве начального
состояния берется не текущий глобальный стиль, а указанный именнованный. Стоит отметить, что как и в исходной ситуации
глобальный стиль будет обновлен до состояния пунктов 1 + 2.

Изменить именнованный стиль нельзя. Попытка определить стиль с таким же именем еще раз приведет к
ошибке, которую, возможно, подавят. Попытка сослаться на стиль которого не существует вернет стиль по умолчанию.

Пример:
```yson
{_define_class_style="AdjustedPositions"; _pointstyle={fill=black;outline=blue;radius=6.;width=2.}; _linestyle={color=red;size=6}};
{lon=55.0;lat=33.0;_class="AdjustedPositions";};
# Переопределим радиус для этой точки
{lon=55.0;lat=33.0;_class="AdjustedPositions";_style={radius=7;};};
```
### Слои/группы

NOTE: Работает только с анимированными объектами.

Слои предназначены для возможности убрать из показа все объекты на каком-то слое.<br>
Для выбора слоёв смотри выпадающий список "Слои" в левом верхнем углу.<br>
Группы - для подсветки всех объектов (и соот-но приглушении остальных) одной группы (для включения нужно нажать кнопку с иконкой глаза в правом нижнем углу). Также можно включить опцию через параметр запроса: `highlight=true`.

Поддерживается только в yson-формате. К объекту нужно добавить `_layout` с полями:
  * `layer` - опциональное имя слоя
  * `groups` - опциональный список групп, к которым принадлежит объект. При наведении на объект подсветятся объекты, у которых есть общие группы с данным
  * `zorder` - опциональный `zIndex` объекта


### Зумы
Зумы для точек задаются так:
```
!zooms=17,18,19
```
На данный момент поддерживаются только статические объекты.

### Анимация:
Для использования анимации все анимированные объекты необходимо задавать через YSON. При этом их отрисовкой будет заниматься JS MAPS API, а все статические объекты независимо от анимированных будут отрисовываться на тайлах. Анимация объекта задаётся в сложном поле `_animation`, в котором задаются условия показа объекта, а также необязательные флаги (по умолчанию `false`):
  * `focus_on_creation` — автоматически перемещаться на карте к объекту при его создании (если включена соответствующая опция в web ui)
  * `balloon_auto_show` — автоматически открывать балун с описанием при создании объекта (если включена соответствующая опция в web ui)

При переходе на web-страницу в качестве параметров запроса можно задать следующие опции:
```
following=true – включить автоматическое перемещение при создании объектов, для которых указана такая возможность
balloon_auto_opening=true – включить автоматическое открытие балуна при создании объектов, для которых указана такая возможность
speed=X – задать скорость по-умолчанию (1x – если не указано)
auto_playing=true – автоматически начать воспроизведение по окончании загрузки страницы
```

#### Простой анимированный объект
Задаётся через время начала и конца показа в поле `_animation`:
  * `since_ts` — timestamp момент начала отображения объекта. При отсутствии — объект показывается с самого начала.
  * `until_ts` — timestamp момент окончания отображения объекта. При отсутствии — объект показывается до конца.

Обязательно наличие хотя бы одного из полей. Вы можете использовать любые положительные (unsigned 64-bit integer) значения timestamp, easyview автоматически определит минимальный и максимальный из них для корректного определения границ воспроизведения.

Пример:
```yson
{"lat"=59.8;"lon"=30.3;"_animation"={"since_ts"=1526282138u;"balloon_auto_show"=%true;"focus_on_creation"=%true;"until_ts"=1526282139u;};};
```

#### Тегированный анимированный объект
Задаётся через тег (строка) и время показа. Объекты с одинаковым тегом и временем показа будут показываться до тех пор, пока на экране не появится новая группа объектов с тем же тегом (т.е. объекты с тем же тегом, но большим временем). Вдобавок можно указывать z-order объектов (чем больше это число, тем приоритетнее объект, т.е. объект с z-order=2 перекрывает объект с z-order=1). Данный способ может быть удобен, если хочется выводить группы объектов, но не известно заранее, когда появится заменающая их новая группа объектов, т.е. время конца показа заранее неизвестно.
  * `tag` — тег объекта
  * `time` — время показа объекта. При отсутствии — с начала.
  * `zorder` — z-order объекта. По умолчанию `0`.

Пример:
```yson
{"lat"=59.8;"lon"=30.3;"_animation"={"tag"=myobjects;"time"=1526282138u;"balloon_auto_show"=%true;"focus_on_creation"=%true;};};
```

Чтобы удалить объекты с определённым тегом, можно указать специальный объект, который не содержит геометрии, а только описание тегированной анимации:
```yson
{"_animation"={"tag"=myobject;"time"=1526282140u;};};
```
В этом случае все текущие объекты с тегом `myobjects` будут удалены во время `1526282140u`.

#### Пометки на шкале времени анимации
На шкале времени можно делать пометки. С их помощью можно отмечать какие-то интересные моменты, чтобы, например, иметь возможность перейти к ним, не просматривая анимацию целиком.

Пометку можно оставить с помощью поля `_timeline_mark` (свойство `color` — опциональное, `tooltip` — тоже):
```yson
{"_timeline_mark"={"time"=1526282140u;color=green;tooltip="route lost"};}
```

#### Движущийся объект
Можно указать, чтобы объект двигался непрерывно (с высокой частотой обновления кадров) вдоль заданной геометрии.
Пример. Движение прогноза для общественного транспорта.

Для этого укажите флаг анимации `move_along=true`:
```yson
{"start_lat"=59.8;"start_lon"=30.3;"end_lat"=59.9;"end_lon"=30.2;"_animation"={"since_ts"=1526282138u;"move_along"=%true;"until_ts"=1526282199u;};};
```

Также работает с тэгированными объектами.
При этом точка будет двигатся вдоль заданной полилинии в течение времени отображения согласно анимации.
Сама полилиния отображена не будет.

Замечание. Если хочется задать стиль двигающейся точки, необходимо прописывать `pointstyle`, а не `linestyle`.

### Help:

```
~/a/m/t/easyview> ./easyview --help

usage: easyview OPTIONS
Tool for rendering geometry on the map

-h, --help                              show this help message and exit
-f<file>, --file=<file>                 file to be rendered, default stdin
-P<port>, --port=<port>                 http port to listen, default is random
--linestyle=<line style>                line style 'color:width'
--pointstyle=<point style>              point style 'fill:outline:radius'
--projection=<projection>               projection: geodetic, mercator
--max-render-scale=<int>                maximum rendering scale
-d<delimiter>, --delimiter=<delimiter>  delimiter for field splitting, default
                                        is any whitespace
--html=<html page path>                 custom html page
--center=<lon lat>                      [lon, lat] for center of the map
--scale=<scale>                         scale in range {0..23}
```
