# Подготовка таблиц с событиями на маршруте на основе логов роутера

На основе логов роутера порождает таблицы двух видов:
- События (`events`) — информация из логов роутера, сгруппированая по целевой точке маршрутов, т.о. одна строка задаёт одну "поездку"
- Логи событий (`events_log`) — события "маршрут начат" (`request_route`), "маршрут окончен" (`route_finish`) с временами; задают границы поездок

## Нарезка на поездки

События группируются по целевой точке и далее нарезаются на поездки:
- если `on_route` (= `nearby_alternatives`) идёт в ту же точку - он относится к текущей поездке
- если `route` идёт в ту же точку и без большого временного перерыва (в бинаре зашито 5 минут) - он тоже относится к текущей поездке

При этом в событиях нет никакой фильтрации и логики, просто сырые логи, и т.о. например там может быть целый час запросов маршрута из дома, пока пользователь никуда ещё не едет.<br>
А вот в логах событий поездка уже обрезается по реальному перемещению, и т.о. задаёт границы реальной поездки.

Поездка считается начавшейся, если следующий запрос были совершён на расстоянии более некоего порога `start_raduis` (по умолчанию 100м) от текущего запроса.

Окончание поездки также определяется с некоторой эвристикой:
- если последний запрос маршрута был в 10 метрах от финиша - поездка закончена
- если запрос был в 100 метрах - поездка закончится через минуту
- иначе - через 3 минуты

В теории это может приводить к тому, что одна поездка завершается уже после того, как начинается следующая. Надо это учитывать при последующей нарезке треков.

Помимо этого в качестве окончания поездки необязательно берётся последний запрос из событий, там также есть некие эвристики, ищущие разрыв.

См. код в [`lib/queries/lib.sql`](lib/queries/lib.sql), функции `get_start_idx` и `get_finish_idx`.

## Процесс работы

Создает одну табличку на день. Для создания таблички за день D использует логи роутера(запросы route, reroute, nearby_alternatives) за день D.

В процессе работы выполняет следующие действия:
- обработка логов с запросами route, reroute, nearby_alternatives([`router_events_mapper`](bin/router_events_mapper))
- фильтрация и обработка для получения событий([`router_events_reducer`](bin/router_events_reducer))

Пути до таблиц с логами задаются через конфиг(см. директорию [`conf`](conf))

### Быстрый онлайн ETA

Быстрый в смысле не ожидающий вычисления дополнительных данных — асессоров.

Строит графики eta-quality на основе полученых событий [Графики](https://datalens.yandex-team.ru/5q70qk3wf8ww2-probki?tab=qbe&state=2452c36a167)
