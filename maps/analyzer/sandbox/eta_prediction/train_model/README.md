Обучение модели предсказания ETA
---

Процесс использует трейн-пул для обучения catboost-модели предсказания ETA.

Логика работы следующая – модели обучаются по всем предложенным пулам. Для каждой модели считается качество. Если качество хуже заданной границы, то модель никуда не загружается, остальные модели при этом не теряются. Если хоть одна модель зафейлилась, то, после загрузки успешных моделей, таска падает, чтобы уведомить таким образом нас о проблеме. Загрузка производится на `YT` и, если указан датасет, в `ecstatic`.

Есть дефолтные модели - `DefaultModel`. Нужны для того, чтобы на роутере выбирать актуальную модель для каждого вида запросов. Роутер грузит такой конфиг с помощью [библиотеки](https://a.yandex-team.ru/arcadia/maps/libs/time_estimator)
1. Если дефолтная модель удаляется, то для начала надо выкатить роутер, потом процесс обучения
2. Если дефолтная модель добавляется, то нужно дождаться появления нового датасета, только потом катить роутер

Выводит в интерфейс Sandbox сводную таблицу с результатами
```text
Succeeded models:
╒═════════╤═════════╤═══════════════════════════════╤════════════════════════════════╕
│ name    │      re │ ecstatic                      │ yt                             │
╞═════════╪═════════╪═══════════════════════════════╪════════════════════════════════╡
│ model_a │ 1.12063 │ model-a-dataset=2020-02-10.00 │ //models/model_a/2020-02-10.00 │
╘═════════╧═════════╧═══════════════════════════════╧════════════════════════════════╛

Failed models:
╒═════════╤═══════════════════════════════════════════╕
│ name    │ error                                     │
╞═════════╪═══════════════════════════════════════════╡
│ model_b │ failed quality check: 1.48250632531 > 1.2 │
╘═════════╧═══════════════════════════════════════════╛
```

В процессе работы выполняет следующие действия:
- мержит таблицы из обучающего пула, подготавливаемого процессом [prepare_training_pools](/arc/trunk/arcadia/maps/analyzer/sandbox/eta_prediction/prepare_training_pools), сортирует результат
- запускает обучение в Нирване (создаст воркфлоу в аккаунте, токен которого был указан)
- считает качество модели на sanity check таблице и сравнивает с пороговым значением
- сохраняет модель на YT и меняет линку на последнюю версию
- сохраняет модель в локальную директорию для последующей загрузки в ecstatic (DEPRECATED)
- сохраняет все модели в локальную директорию для последующей загрузки в ecstatic одним датасетом (если какой-то модели нет совсем, то сработает assert)

Пути и параметры обучения задаются через конфиг(см. директорию [`conf`](conf)).

### Результаты

[Тестинг](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/jams/testing/whole_track_model/models)</br>
[Продакшн](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/jams/production/whole_track_model/models)

### Sanity check

Данные для проверки:
[Тестинг](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/jams/testing/train-model/sanity-check)
[Продакшн](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/jams/production/train-model/sanity-check)
