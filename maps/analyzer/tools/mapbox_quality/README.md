Инструменты работы с пробками mapbox и оценки качества
---

Содержит:
- [C++ библиотеку фукнций](lib)
- [С++ бинарники](bins)
- [Python обертки](py/lib)
- [Инструменты для запуска](py/tools)

## Формат данных
[Описание на сайте mapbox](https://docs.mapbox.com/traffic-data/overview/data/)

### Live-скорости:
Реалтайм-скорости представлены в csv-файлах, сжатых gzip. Файл размещены в структуре директорий, описывающих момент времени (UTC), вида `root/<year>/<month>/<day>/<hour>/<minute>/<quadkey>.csv.gz`, например:
```
root
└── 2020
    └── 2
        ├── 20
        │   ├── 22
        │   │   ├── 12
        │   │   │   └── 1221122.csv.gz
        │   │   ├── 16
        │   │   │   └── 1221122.csv.gz
        │   │   ├── 21
        │   │   │   └── 1221122.csv.gz
        │   │   ├── 26
        │   │   │   └── 1221122.csv.gz
...
```

`quadkey` - описание квадратного bounding-box'a на карте в [формате mapbox](https://labs.mapbox.com/what-the-tile/).

Каждый csv-файл состоит из строк с описанием ребра, содержащих id вершин начала и конца, а также скорость (в км/ч), вида:
```
<source_osm_node_id>,<target_osm_node_id>,<speed_kmph>
...
```

### Typical-скорости:
Типичные скорости представлены в одном csv-файле, состоящим из строк с описанием ребра, содержащих id вершин начала и конца, а также массив типичных скоростей (в км/ч), вида:
```
<source_osm_node_id>,<target_osm_node_id>,<speed_1>,...,<speed_2016>
...
```
Каждое ребро описывается 2016 скоростями – по одной на каждые 5 минут в течение недели. Неделя начинается с воскресенья. Для индексации следует использовать местное время. Например, `7:07` понедельника в Тель-Авиве имеет индекс `24 * 12 + 7 * 12 + 1 + 7200 / (60 * 5) = 397`

### Open street map graph
[Сайт с информацией](https://www.openstreetmap.org/)</br>
Для экспорта предварительно необходимо рассчитать граничные значения lat, lon по quadkey.

## Алгоритм
Входные ребра с реалтаймовыми скоростями мержатся с ребрами с типичными скоростями за релевантный отрезок времени (приоритет у реалтаймовых).
Общий набор ребер, затем, объединяется в компоненты – непрерывные участки дороги без развилок, так качество матчинга заметно улучшается.
Геометрии получившихя компонент матчатся к графу таким образом, чтобы можно было определить соответствие между исходным ребром (и, как следствие, его скоростью) и приматченным участком.
После, исходные скорости, раскидываются по кусочкам ребер приматченных участков.
Затем, кусочки ребер со скоростями объединяются в единые пробки в соответсвии с весами в виде долей.

## Локальный запуск
Используйте [инструмент локального запуска](bins/local), передав в качестве аргументов путь к корню директории с архивированными live-скоростями и путь к файлу с типичными скоростями в формате csv. Также понадобится osm-граф области. Есть опции для локальной отладки с помощью easyview и вывода статистик. На данных за неделю работает очень долго, используйте запуск на кластере MapReduce.

## Запуск на кластере MapReduce
Используйте [инструмент подготовки данных](bins/prepare_data) для конвертации дерева файлов в live-скоростяи в yson-таблицу для загрузки на YT. Затем, используйте полученную таблицу в [build_jams tool](py/tools/build_jams) для распределенной обрабокти и создания таблицы с пробками в целевом формате.
