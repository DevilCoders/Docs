# Анализ пробок и реальных проездов по участкам дорог

Для заданных участков дорог собирает реальные времена проезда по этим участкам и времена, посчитанные по пробкам.<br>
Т.о. позволяет понять картину, которую видел пользователь, находясь в начале некоторого участка.

Запуск:
```bash
cat routes | ./bin/routes_jams --date 2020-02-02 --output //path/to/yt
```

На вход принимает участки дорог (см ниже), а также некоторые параметры:
* `--date` — интересующая дата
* `--output` — путь на YT для сохранения данных (см ниже)

## Входной формат

На вход (файл `routes` в примере запуска) программе передаютая участки дорог, заданные в одном из форматов (можно смешивать), по одному участку на строку:
* `TAG src-lat src-lon dst-lat dst-lon` — координаты начала и конца
* `TAG https://yandex.ru/maps/213/moscow/?ll=37.574305%2C55.735727&mode=routes&rtext=55.735406%2C37.566408~55.739050%2C37.570635&rtt=taxi&ruri=~&z=16` — ссылка из веб-карт (via-точки не поддерживаются)

где `TAG` — любое уникальное название участка

Пример:
```
TEST https://yandex.ru/maps/213/moscow/?ll=37.571703%2C55.737375&mode=routes&rtext=55.739556%2C37.570859~55.736702%2C37.567997&rtt=taxi&ruri=~&z=16.85
KUTUZ https://yandex.ru/maps/213/moscow/?ll=37.548013%2C55.744852&mode=routes&rtext=55.744021%2C37.545868~55.745207%2C37.549490&rtt=auto&ruri=~&z=18.07
VOLOK https://yandex.ru/maps/213/moscow/?ll=37.346022%2C55.818069&mode=routes&rtext=55.818809%2C37.335615~55.818579%2C37.343053&rtt=auto&ruri=~&z=15.65
RECH https://yandex.ru/maps/213/moscow/?ll=37.343708%2C55.818642&mode=routes&rtext=55.822212%2C37.338244~55.818626%2C37.341293&rtt=auto&ruri=~&z=17.59
```

## Выходные данные

1. `merged_stats` - основной результат, пробки и эталонные проезды в каждую временную точку (временная точка - `time` из пробок или момент заезда на участок по эталонам) по каждому маршруту, где:
    * `route_tag` - маршрут
    * `geolength` - длина маршрута в метрах
    * `time` - временная точка
    * `jams_time` - время по пробкам в секундах
    * `jams_speed` - пробочная скорость в м/с
    * `route_jams_time` - время по пробкам на основе только тех, кто ехал по участку, в секундах
    * `route_jams_speed` - пробочная скорость на основе только тех, кто ехал по участку, в м/с
    * `etalon_time` - реальное время в секундах (если есть)
    * `etalon_speed` - реальная скорость в м/с
    * `clid`
1. `jams_stats` - времена по пробкам для каждой временной точки из пробок, колонки:
    * `route_tag` - маршрут
    * `jams_time` - время по пробкам, с
    * `route_jams_time` - время по пробкам только тех, кто ехал по маршруту
1. `stats` - статсы по эталонам (эталонное время проезда, пробочное и прочие колонки из тулкитового подсчёта качества)
1. `jams` - пробки на маршрутных сегментах
1. `route_jams` - пробки, посчитанные только на тех, кто ехал по соответствующему участку (маршруту); в отличие от `jams` имеет доп. колонку `route_tag` с указанием, для какого маршрута строились пробки
1. `travel_times` - пробочных проезды на маршрутных сегментах
1. `route_travel_times` - пробочные проезды только тех, кто ехал по маршруту; добавлена колонка `route_tag` с указанием маршрута
1. `assessors` - асессоры на маршрутах с доп. колонкой `route_tag`; асессоры "исправленные", т.е. `track_start_time` соотвествует времени въезда на маршрут, а также трек покрывает маршрут полностью
1. `routes_segments` - сегменты маршрутов (нужны для фильтрации)
1. `routes` - маршруты (точки начала и конца, геометрии и сегменты в виде списка)
1. `missed_routes` - список маршрутов, для которых не нашлось асессоров (список выводится также предупреждением)

Далее `merged_stats` можно добавить как датасет в [DataLens](https://datalens.yandex-team.ru/), и далее на основе этого можно создать чарт с `time` по оси X и по оси Y либо `jams_time`/`route_jams_time`/`etalon_time`, либо `jams_speed`/`route_jams_speed`/`etalon_speed`. В фильтре обязательно указать `route_tag`, чтобы показать только один участок. Значения лучше усреднять (`avg`), так как на одну временную точку может прийтись несколько эталонов, и по умолчанию они сложатся.

## Описание работы

1. Парсит описания маршрутов и заливает на YT во временную таблицу
1. Прокладывает маршруты с помощью лептидеи и обновляет таблицу с маршрутами, заполняя колонки с геометрией и рёбрами; сохраняет результат в таблицу `routes`
1. Составляет список сегментов с тегом маршрута, `routes_segments`
1. Фильтрует асессоров, пробочные проезды и пробочные проезды по маршрутам, причём асессоры также тегируются маршрутом, к которыму они принадлежат, и обновляются их `track_start_time`; результат сохраняется в `assessors` & `travel_times` & `route_travel_times`
1. Строятся пробки из фильтрованных проездов, `jams`
1. Строятся изолированные пробки (т.е. только на основе пользователей, ехавших целиком по маршруту) из фильтрованных проездов, `route_jams`
1. Считается кач-во прогноза асессоров по пробкам, `stats`
1. Далее по имеющимся пробкам генерируются временные фейковые проезды, где в качестве времени берётся пробка, если она есть, или дефолтная скорость. Эти данные усредняются, и получается пробочное время проезда маршрута за каждую временную точку, имеющуюся в `jams`; результат сохраняется в `jams_stats`
1. Статистики из `stats` & `jams_stats` мержатся в `merged_stats`
