# Расширение анализатора

## <font color='red'>**WARN: Перед любыми действиями с шардами анализатора прочтите всё целиком!** </font>

## Общее описание

Расширение анализатора сводится к 4-м этапам:
1. **Аллокация новых подов** (только при расширении): автоматически влечёт включение в работу новых диспатчеров, схема остальных модулей не меняется.
2. **Расширение UH**: включаются в работу новые UH через обновление конфига диспатчера
3. **Расширение SH**: трёхэтапный процесс:
    1. **Накопление стейта новой схемой SH**: SH начинают накапливать стейт согласно новой схеме шардирования; накопление длится порядка часа
    2. **Переключение на новую схему SH**: в конфигах новая схема становится дефолтной, а старая - запасной; в процессе реализации этого пункта в `ecstatic` начнут заливаться пробки согласно новой схеме. Этот пункт следует делать особенно аккуратно, чтобы достичь консистентных версий датасета на `ecstatic`е.
    3. **Удаление старой схемы SH**: убирается старая схема шардирования, после этого шага пути назад без потери стейта нет.
4. **Деаллокация лишних подов** (только при сужении): автоматически убирает диспатчеры из работы

При этом п.2 не конфликтует с п.3, его можно сделать после, перед, или даже между подшагами.

## Подготовка

### Подготовка докер-образов
Так как процесс подразумевает изменения конфигов, нужно заранее подготовить коммиты и образы на их основе.<br>
**ВАЖНО**: Лучше коммиты накатить хотфиксами поверх актуальной версии, чтобы между ними не попало ничего лишнего из транка.

Готовим три коммита:
- Коммит 1 (п.2 & п.3.1): добавляем новые UH в конфиг диспатчера, добавляем `new_shards` в конфиг UH и добавляем `path_to_hosts_config` в конфиги EH и SH с путем до hosts конфига UH.
- Коммит 2 (п.3.2): свапаем `shards` и `new_shards`, т.е. просто взаимно переименовываем секции в конфиге, т.о. новая схема шардирования становится активной и схемой по умолчанию
- Коммит 3 (п.3.3): оставляем только актуальную схему шардирования в конфиге UH (т.е. удаляем секцию `new_shards`, которая на этом шаге соотвествует старой схеме) и удаляем поле `path_to_hosts_config` из конфигов EH и SH.

**NOTE**: Так как п.2 не конфликтует с п.3, изменение конфига диспатчера _можно_ сделать в коммите 2 (и даже в коммите 3), разница лишь в том, когда именно произойдёт расширение UH. При описанном ниже варианте - сразу при первом коммите.

Хотфиксим все коммиты, ниже будем ссылаться на них Коммит 1/2/3 и Образ 1/2/3 соответственно.

Образ 1 можно безопасно откатить<br>
Образ 2 можно откатить, но делать это нужно аккуратно, так как в процессе меняется кол-во загружаемых частей датасета, см. соответствующую секцию ниже.<br>
Откат Образа 3 чреват частичной или полной потерей стейта и соответственно пробок. Делать можно лишь в крайнем случае.<br>

### Описание особенностей переключения EH&SH и загрузки пробок в ecstatic
Переключение на новую схему происходит не атомарно - по очереди катятся разные ДЦ, т.о. в процессе мы будем иметь состояние, когда один ДЦ уже на новой схеме, а другие два - ещё на старой.
Если ничего не предпринимать, это чревато тем, что загружаться будут пробки согласно обоим форматам (например: `2of10` и `2of20`), а данных по итогу в екстатике будет в два раза больше.
Не факт, что все клиенты адекватно на такое отреагируют (желательно в этом заранее удостовериться на всякий случай).<br>
Чтобы избежать этого, в образ заложена возможность стартовать без загрузки пробок. В этом случае поды не будут загружать пробки, пока мы явно не запустим загрузку пробок на них.
Для управления процессом используется переменная окружения `NO_UPLOAD_JAMS`, которая, будучи выставленной, отключает загрузку пробок.
Для ручного включения/отключения загрузки пробок в ДЦ есть скрипты [`disable_uploading`][disable_uploading] и [`enable_uploading`][enable_uploading].

Идея в том, чтобы выкладывать версию анализатора, которая не загружает пробки в `ecstatic`, а затем вручную сначала отключить загрузку пробок в ДЦ на старой схеме, а затем включать загрузку пробок с ДЦ на новой схеме, подождав между этими действиями достаточное время (30 сек), чтобы версии не смешались.

## Аллокация новых подов (только при расширении)
Стандартным образом добавляем в няне новые поды (открываем сервис в nanny -> View pods -> Actions -> Copy pod -> Allocate). Катим текущий активный снэпшот на новые поды через интерфейс Няни.

## Накопление стейта новой схемой SH (Образ 1)
Катим образ 1, этот шаг полностью безопасный, его можно безопасно откатывать, если что-то пошло не так.
Ждем не меньше часа, чтобы сервис успел накопить новый стейт, который будет соответствовать новой схеме шардов.

## Переключение на новую схему SH (Образ 2)
1. Открываем сервис в nanny -> Instance Spec -> Environment variables configuration -> Добавляем переменную LITERAL с именем `NO_UPLOAD_JAMS`, ставим ему в значение `1` -> Save -> Submit.
2. В интерфейсе няни появляется "новый" образ, в котором изменено лишь значение этой переменной.
3. Катим через sedem Образ 2 (он захватит изменение переменной `NO_UPLOAD_JAMS` и пробки после старта образа загружаться не будут).
4. После полной выкатки на первый ДЦ вызываем скрипт [`disable_uploading`][disable_uploading] для двух других ДЦ.
5. И, подождав не меньше 30 секунд после окончания работы скрипта, вызываем скрипт [`enable_uploading`][enable_uploading] для первого ДЦ.
6. Затем, когда образ выкатится на второе ДЦ, вызываем [`enable_uploading`][enable_uploading] для него, а затем, как выкатится третий ДЦ – и для него.

**NOTES**:
* 30 секунд необходимо подождать, чтобы не совпали версии пробок с новой структурой и старой.
* При наличии stable и prestable окружения считаем, что prestable покрыт одним ДЦ и он будет первым при раскатке, а stable будет покрывать второе и третье ДЦ, если это не так, то алгоритм действий немного усложняется тем, что придется писать другой кастомный рецепт выкладки аналайзера, который ждет подтверждения выкатки на очередное ДЦ, подробнее стоит спросить у команды инфраструктуры.
* Если вы забудете установить в `1` переменную `NO_UPLOAD_JAMS`, то в `ecstatic` будут загружаться смешанные датасеты (например, будут части `1of10` и `1of20`).
* Старый стейт в текущем образе не будет теряться, потому что `new_shard` равны старой структуре шардов, вы можете использовать это при откатах.

**WARN**: Если на этом шаге что-то пошло не так, то откатывать нужно так, чтобы число частей пробок не ломалось.
Контролировать это надо скриптами enable/disable uploading.<br>
Нужно следить за количеством ребер/маневров в памяти сервиса по графикам.
Они **не должны** ресетиться в 0, ничего в этих графиках не должно меняться.
Если они ресетнулись в 0, значит что-то пошло не так и стейт сервиса потерялся.

## Удаление старой схемы SH (Образ 3)
Удаляем переменную `NO_UPLOAD_JAMS` (или стираем у нее значение, оставив поле в няне пустым), сохраняем.
Катим через sedem Образ 3.

## Деаллокация лишних подов (только при сужении)
Для этого надо сначала раскатить уменьшение числа шардов, а затем удалить неиспользуемые поды по обычной инструкции (убираем их из Active в снепшоте, удаляем галочки с них в Instances, удаляем поды окончательно через View Pods -> Actions -> Delete pod).


[disable_uploading]: /arc/trunk/arcadia/maps/analyzer/services/jams_analyzer/scripts/disable_uploading.sh
[enable_uploading]: /arc/trunk/arcadia/maps/analyzer/services/jams_analyzer/scripts/enable_uploading.sh
