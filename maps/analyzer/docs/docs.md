# Яндекс.Пробки

1. [Пробки](#Пробки)
    1. [Посегментная модель](#Посегментная-модель)
    1. [Пробки по манёврам](#Пробки-по-манёврам)
1. [Прогноз ETA](#Прогноз-ETA)

Одной из основных задач является прогноз времени поездки по маршруту. Для этого, а также для отображения на картах, [собираются пробки](#Пробки), а затем используются в [роутере][router] для [прогноза eta поездки](#Прогноз-ETA).

## Пробки

С различных мобильных приложений (Карты, Навигатор, Таксометр) в сервис [анализатора пробок][jams_analyzer] приходят анонимизированные GPS-сигналы, которые затем привязываются (матчатся, см. [libs/graphmatching][graphmatching]) к графу дорожной сети и мы получаем т.н. пробочные проезды — время проезда некоторого сегмента графа на какой-то момент времени, для него известны время въезда, выезда и соот-но суммарное время.<br>
Затем пробки усредняются (см. [libs/time_interpolator][time_interpolator] и [libs/realtime_jams][realtime_jams]) — используется взвешенное среднее + простая, но достаточно полезная фильтрация экстремально долгих проездов, которые, как правило, порождаются стоящими на обочине или на парковке водителями. В результате мы получаем "пробку" — некое усреднённое время проезда сегмента в секундах, известное на какой-то момент времени. Помимо этого в пробке сохраняется информация о том, на каком кол-ве проездов она посчитана.<br>
При малом кол-ве данных пробка прогоняется также через [посегментную модель](#Посегментная-модель), на выходе дающую ту же пробку, но как-то улучшенную.<br>
Затем эти данные раз в 30 секунд складываются в датасет и загружаются в [ecstatic][ecstatic], откуда далее раскладываются по сервисам-потребителям, в частности, на [роутер][router], где происходит [прогноз ETA](#Прогноз-ETA).

### Посегментная модель

CatBoost-овая модель. На вход получает фичи, описывающие сегмент (регион, категория дороги, длина, ограничение скорости и т.п.), пробки за разные интервалы времени (т.е. построенные на проездах за последнюю минуту, за предпослендюю, за проезды в интервале 2-5 минут и т.д.).<br>
Таргетом при обучении является следующий проезд, который прогнозируется на момент времени въезда на сегмент.<br>
Код обучения и применения лежит в [libs/realtime_jams][realtime_jams].

### Пробки по манёврам

Манёвр — цепочка рёбер с ребром, определяющим дальнейшее направление (поворот/съезд). Последнее ребро само в манёвр не входит. Пробки по манёврам, соответственно, — пробки, посчитанные только на пользователях, которые проехали манёвр в соответствующем направлении. Считается, что пользователь проехал манёвр, если он проехал по суффиксу рёбер, входящих в манёвр, и поехал далее в нужном направлении. Помимо расчёта, такие пробки также используются вместо общих при расчёте ETA по маршруту, который проходит через манёвр.

На основе исторических данных [регулярный процесс](/arc/trunk/arcadia/maps/analyzer/sandbox/eta_prediction/prepare_manoeuvres) находит манёвры — цепочки рёбер длиной от 300м — где имеет место расслоение потоков в зависимости от направления последующего движения (прямо/направо/...).

В сервисе для выбранных мест строятся манёвренные пробки ровно тем же алгоритмом, но в расчёт берутся только те пользователи, которые проехали манёвр в нужном направлении. Также здесь появляется дополнительная задержка, так как приходится дожидаться, когда пользователь доедет манёвр до конца (проедет первый сегмент последнего ребра, определяющего направление манёвра).

В роутере же эти пробки используеются вместо обычных — как для раскраски маршрута, так и для передачи в модель — для маршрутов, которые проходят через манёвры.

## Прогноз ETA

Для прогноза eta используется CatBoost-овая модель, называемая полнотрековой (whole track model), так как применяется ко всему маршруту.<br>
В общих чертах она работает так:
1. Весь маршрут делится на 8 примерно равных по длине частей.
1. Для каждой части, а также для всего маршрута целиком, считаются агрегированные на соответствующем участке маршрута фичи, которые можно разбить на категории:
    1. Статические фичи — зависят только от самого маршрута: наличие светофоров, туннелей, общая длина, ограничения скорости и т.п.
    1. Пробочные фичи — суммарное время по пробкам, покрытие пробками
    1. Статистические фичи — минимальное/максимальное и средние кол-ва проездов и скорости, которые обычно бывают в это время (в начале маршрута данные берутся на текущий момент, а в конце маршрута — на момент, когда согласно пробкам пользователь там окажется)
    1. Персонализированные фичи (только для залогинов) — статистическая информация о пользователях, насколько он часто обгоняет/отстаёт, средняя длина поездок.
1. Далее фичи передаются в модель, и она возвращает прогноз ETA.

Стоит заметить, что в онлайне модель применяется к маршрутам, обучаемся же мы на поездках, т.е. при обучении в качестве маршрута берётся геометрия реальной поездки, а не того маршрута, который был предложен. Сделано так потому, что лучше выходит качество. Попытки обучаться прямо на маршрутах пока успехом не увенчались.

Более детальное описание см. в [libs/time_estimator][time_estimator].

[router]: /arc/trunk/arcadia/maps/routing/router
[jams_analyzer]: /arc/trunk/arcadia/maps/analyzer/services/jams_analyzer
[graphmatching]: /arc/trunk/arcadia/maps/analyzer/libs/graphmatching
[time_interpolator]: /arc/trunk/arcadia/maps/analyzer/libs/time_interpolator
[realtime_jams]: /arc/trunk/arcadia/maps/analyzer/libs/realtime_jams
[time_estimator]: /arc/trunk/arcadia/maps/libs/time_estimator
[ecstatic]: https://docs.yandex-team.ru/ecstatic/
