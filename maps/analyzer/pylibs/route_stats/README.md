### Route stats

Библиотека для расчёта eta-metric маршрута по прогнозу, сматченным с реальными треками пользователей или их частями.


Матчинг маршрутов происходит следующим критериям:
- По времени начала трека и маршрута
- Совпадающим `persistent_segments` в маршруте и треке, на основе которых строится `track_geometry` (сматченный трек).
- После находятся последние и первые геоточки маршрута и сматченного трека и проверяется, что они находятся не очень далеко друг от друга.

То есть в итоге, чтобы маршрут был сматчен ему не обязательно совпадать с **целым** треком, ему достаточно лежать на нём (частично или полностью) и иметь совпадающие концы.

Если для одной поездки существует несколько маршрутов, то будут сматченны все (могут быть отброшены на последующих этапах).

![track_and_multiple_routes](./docs/img/track_and_multiple_routes.jpg)

На этой картинке чёрный - трек пользователя, остальные - предсказанные маршруты.
Изначально пользователь едет по зелёному маршруту, но после он решает съехать с него и следовательно новый маршрут генерируется (жёлтый). Аналогичная ситуация происходит с другими маршрутами.
Они все будут сматчены, тк, во-первых, они лежат частично на треке и, во-вторых, концы сматченного трека и маршрута находятся недалеко -> маршруты сматченны.



---

[`operations.py`](operations.py) - расчёт статсов по предсказанным маршрутам и реальным трекам пользователей.<br>
- `calculate_route_stats` рассчитывает статы по маршрутам, матча с реальными проездами пользователей. Неподходящие маршруты будут отброшены, а для сматченных будут добавлены новые поля, отражающие качество предсказания (см. описании функции в коде).
- `RouteStatsParameters` - параметры для рассчёта статов.
- `TimeOrder` - информация о времени, по которому будет произведена сортировка. (для ассессоров - время въезда в сегмент, для маршрутов - время начала поездки/предсказания)

[`schema.py`](schema.py) - схема таблиц, новые и необходимые колонки. <br>
- `route_stats_table` - добавляет новые поля в переданную таблицу.

---
