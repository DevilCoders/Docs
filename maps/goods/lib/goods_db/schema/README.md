# Миграционный флоу

Для миграций базы мы используем [pgmigrate](https://github.com/yandex/pgmigrate).

Миграционные скрипты помещаются в папку `migrations`. При этом целевое состояние базы (на момент последней миграции) поддерживается в файликах `db.sql` и `statistics.sql`. Необходимо следить за тем, чтобы результат применения всех миграций был идентичен результату применениях вышеупомянутых файлов.

## Примеры команд

```bash
pgmigrate -c "$(eval "echo `cat testing.conn`")" info
pgmigrate -c "$(eval "echo `cat stable.conn`")" info
```

## FAQ

Перед работой с `pgmigrate` стоит ознакомиться с [туториалом](https://github.com/yandex/pgmigrate/blob/master/doc/tutorial.md). Возможно, ответ на ваш вопрос есть в нём.

1. **Я хочу сравнить две схемы, как мне быть?**

    Выкачиваем обе схемы с помощью pgdump:
```bash
pg_dump -f schema-1.sql -s <connection-string>
pg_dump -f schema-2.sql -s <connection-string>
```
    Сравниваем глазами с помощью diff:
```bash
clear && diff --color schema-1.sql schema-2.sql
```
2. **Мы выпускаем новый релиз из транка и для него нам надо сделать миграцию базы. Как быть?**

    Создаём файлик(и) миграции. Присваиваем им версии, начиная от `LAST_STABLE_MIGRATION + 1`.
    Применяем их к базе и катим релиз.
3. **В стейбл выкачен релизный бранч. Мы хотим сделать и выкатить хотфикс, включающий в себя изменения в базе. Как быть?**

    В транке создаём новую миграцию с версией `LAST_STABLE_MIGRATION + 1`.
    В релизный бранч черри-пикаем нужные коммиты + коммит, создающий миграцию.
    Применяем миграцию к базе и катим релиз.
4. **В тестинге всё было хорошо, но при выкатке в стейбл/престейбл миграция всё сломала. Как быть?**

    Откатываемся на предыдущую версию, либо поднимаемся из бэкапов, если всё совсем плохо.
    Лишаем проблемную миграцию (и все следующие за ней миграции) присвоенных им номеров.
    Чиним миграцию, чтобы работала как надо.
    Заново присваиваем миграциям номера.
    Выкатываем новый релиз.
5. **В базе старая схема, а мы выкатили версию софта, работающую с новой. Как быть?**

    Софт проверяет, что версия схемы базы не меньше, чем та, на которую он рассчитан.
    Если меньше, то софт не стартует. Мы видим ошибку в няне/мониторингах/логах и исправляем ситуацию.
6. **В базе старая схема, а мы очень-очень хотим выкатить версию софта, работающую с новой. И мы точно-точно уверены, что ничего не поломается. Как быть?**

    Ещё раз удостовериться, что предыдущий пункт не подходит.
    Если действительно есть такая необходимость, то в конфиге затираем требуемую версию базы (в этом случае софт не проверяет её при старте).
6. **В базе новая схема, а мы выкатили версию софта, работающую со старой. Как быть?**

    Либо схемы должны быть обратно совместимыми, либо надо хорошенько подумать, прежде чем выкатывать старый софт.
7. **Мы хотим немного подфиксить базу, но транк каким-то образом разошёлся с текущим состоянием стейбла. Как быть?**

    Создать миграцию с версией `LAST_STABLE_MIGRATION + 1`. Применить её к базе.
    Починить транк, чтобы он работал с новосозданной миграцией.
8. **Я создаю миграцию и хочу её потестить. Как быть?**

    Создайте миграцию с заведомо большой версией, например `V999`. Накатите её на тестинг.
    Если всё ок, откатитесь и присвойте нормальный номер (`LAST_STABLE_MIGRATION + 1`).
    Если не ок, откатитесь и внесите необходимые правки.
    Процесс итерационный)
