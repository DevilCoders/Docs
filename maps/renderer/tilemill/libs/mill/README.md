# Формат рецепта

Рецепт - описание настроек и способа преобразования набора исходных геоданных в тайлсет для tilemill.

Создание тайлсета из таблиц в YT:
```
dataset_type: yt

# Опционально, префикс таблиц в YT
table_prefix: //path/to/tables

# Описание слоев датасета
layers:
- name: layer_name  # Название слоя
  type: point|polyline|polygon  # Тип геометрии слоя

  # Формат хранения геометрии и ее проекция. По умолчанию wkb_3395.
  # Поддерживаются проекции EPSG:4326 (WGS84) и EPSG:3395 (Mercator).
  # Поддерживаются форматы:
  # - Well-known text (WKT)
  # - Well-known binary (WKB)
  # - Координаты точки в проекции WGS84 (lon_lat)
  # Возможные значения параметра: wkb_3395, wkb_4326, wkt_3395, wkt_4326, lon_lat.
  geometry_format: wkb_3395

  # Столбец, в котором хранится геометрия. По умолчанию geom.
  # Для формата lon_lat - массив из двух значений, например:
  # geometry_columns: [lon, lat]
  # geometry_columns: [x, y]
  geometry_column: geom

  # Зум, начиная с которого этот слой будет отдаваться в тайлах.
  # Например, если в датасете 100млн точек и выставлен minzoom=0, то тайл на
  # нулевом зуме будет содержать все эти точки (не делайте так).
  minzoom: 12

  # Опционально, последний зум на котором этот слой будет отдаваться в тайлах.
  maxzoom: 14

  # Путь к таблице (абсолютный или относительно table_prefix).
  table: //path/to/table

  # Опционально, настройки генерализации, см. раздел с описанием ниже.
  union: {}
  simplification: {}

  # Атрибуты, которые будут доступны для использования в Картографе.
  properties: [name, priority, tags, ...]

  # Опционально, имена атрибутов с z-уровнями полилинейной геометрии.
  # Массив из двух значений - имен атрибутов с z-уровнем начала и z-уровнем
  # конца полилинии. По умолчанию значения отсутствуют.
  zlevel: [f_zlev, t_zlev]

# Опционально, bounding box, ограничивающий область карты, в которой будут
# напиливаться тайлы.
# Параметр может быть использован, например, в процессе прототипирования для
# уменьшения размера тайлсета и времени его создания.
# Формат: [min_longitude, min_latitude, max_longitude, max_latitude]
# Также можно использовать два специальных значения "msk" и "spb".
# Примеры:
# bbox: [-180.0, -90.0, 180.0, 90.0]
# bbox: msk
# bbox: spb
bbox: [36.85, 55.30, 38.60, 56.20]

# Опционально, локаль, используемая при генерации тайлов. По умолчанию используется ru_RU.
lang: mul_UA

# Опционально, максимальный зум для которого будут напиливаться тайлы.
# Для зумов больших этого значения при рендеринге будет использоваться оверзум.
# Максимальное значение: 15.
maxzoom: 15
# Либо опционально, полный набор зумов на которых будут напиливаться тайлы.
# Для отсутствующих в списке зумов при рендеринге будет использоваться оверзум
# из тайла с меньшим зумом.
# Сортированный список, начинающийся с 0, последнее значение не больше 15.
zoom_levels: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 15]

# Опционально, подмножество zoom_levels, разбивающее набор зумов тайлового
# индекса на блоки. Для большинства датасетов подойдут дефолтные значения.
# Подробнее см. libs/tile_storage/tile_index.md
block_zoom_levels: [0, 8]

# Опционально, количество бит, используемых для представления координат внутри тайла.
# Для тайлов с оверзумом точность представления может быть увеличена относительно
# этого значения. По умолчанию 8.
tile_bitness: 10

# Опционально. Максимальная аддитивная добавка к tile_bitness тайла, для которого
# используется оверзум. Каждый отсутствующий зум увеличивает tile_bitness на 1,
# при этом суммарная добавка не может быть больше значения данного параметра.
# По умолчанию 3.
tile_bitness_max_increment: 5

# Опционально, формат хранения тайлового индекса. Для большинства датасетов
# подойдут дефолтные значения. Подробнее см. libs/tile_storage/tile_index.md
tile_index_format: plain|sparse
tile_index_compression: none|zlib|zstd_8

# Пути к результирующим тайлсету и схеме (только для локального запуска в cli,
# в sandbox задаче пути выставляются автоматически).
output_tileset_location:
  file: tileset.tml  # либо путь к локальному файлу
  s3: s3://bucket/key  # либо путь к файлу в S3, в AWS формате
output_schema_location:
  file: schema.json
  s3: s3://bucket/key
```

Создание тайлсета из geojson датасета:
```
dataset_type: geojson

# Путь к файлу с датасетом
dataset_location:
  # либо путь к локальному файлу (только для локального запуска из cli)
  file: dataset.json
  # либо путь к файлу в S3, в AWS формате (в бакете должен быть включен анонимный доступ)
  # Например:
  # - загружаем с помощью ya upload датасет в sandbox
  # - из описания sandbox ресурса http://sandbox.yandex-team.ru/resource/2380802395
  #   получаем S3 ссылку: http://s3.mds.yandex.net/sandbox-469/2380802395/rd_parks_outdoor.geojson
  # - пишем сюда s3://sandbox-469/2380802395/rd_parks_outdoor.geojson
  s3: s3://bucket/key

# Параметры, аналогичные рецепту для YT таблиц:
# - lang
# - maxzoom
# - zoom_levels
# - block_zoom_levels
# - tile_bitness
# - tile_bitness_max_increment
# - tile_index_format
# - tile_index_compression
# - output_tileset_location
# - output_schema_location
```

# Настройки генерализации

Для ускорения рендеринга данных на обзорных масштабах и уменьшения размера
передаваемых тайлов tilemill упрощает геометрию исходных геоданных на каждом
зуме так, чтобы ее детальность соответствовала разрешению экрана на этом зуме.
Если есть необходимость увеличить детализацию или наоборот еще больше уменьшить
размер передаваемых тайлов, то параметры генерализации можно дополнительно
настроить.
Настройки генерализации зависят от типа геометрии слоя, указанного в
атрибуте `type` слоя (`point`, `polyline` или `polygon`).

Общие настройки для полилинейной и полигональной геометрии:
```
union:
  # Набор атрибутов, по которым будет объединяться геометрия.
  # По умолчанию отсутствует (геометрии не объединяются). Для адекватного
  # отображения на обзорных масштабах (зумы 0-12) рекомендуется заполнить.
  # Объединение геометрии может быть полезно для:
  # - Уменьшения размера тайлов и увеличения производительности их рендеринга,
  #   например, за счет объединения последовательных участков дорог в одну
  #   полилинию (одна полилиния вместо сотни маленьких полилиний) или
  #   объединения касающихся друг друга полигонов воды (один полигон вместо
  #   нескольких).
  # - Улучшения отображения, например, за счет неразрывности полилиний или
  #   отсутствия стыков на границах касающихся полигонов.
  # - Улучшения фильтрации полилиний/полигонов небольшой длины/площади.
  #   Без какого-либо объединения небольшие геометрии (например, меньше пикселя)
  #   могут быть отфильтрованы с обзорных масштабов.
  # Указанные атрибуты должны быть ключем таблицы (все атрибуты кроме геометрии
  # должны быть одинаковы у всех строк таблицы с этим ключем).
  # Пустой список означает что объединить нужно все строки таблицы.
  # Примеры:
  # group_by: [ft_type_id]
  # group_by: [rd_id]
  # group_by: [fc, rd_type, isocode]
  group_by: [ft_id]

simplification:
  # Опционально, максимальное количество точек для одной геометрии.
  # При превышении указанного значения геометрия будет разбита на несколько.
  # По умолчанию 1000, для большинства датасетов подойдет дефолтное значение.
  max_points: 1000
```

Настройки для полилинейной геометрии:
```
union:
  # Опционально, настройка сохранения ориентации полилиний при их объединении.
  # По умолчанию false, что позволяет разворачивать полилинии в обратную сторону
  # если это помогает склеить несколько полилиний вместе.
  # Выставление true может быть полезно, например, для корректного отображения
  # стрелок направления движения дорог с односторонним движением.
  keep_direction: true
```

Настройки для полигональной геометрии:
```
union:
  # Опционально, максимальное расстояние между полигонами (в метрах), при
  # котором будет происходить их объединение, по умолчанию 0.
  # При указании параметра объединение полигонов будет происходить с помощью
  # операции Buffer: postgis.net/docs/ST_Buffer.html
  buffer_size_meters: 0

  # Опционально, количество отрезков, используемых для аппроксимации четверти
  # круга в операции Buffer при объединении полигонов. Доступно при указании
  # параметра buffer_size.
  # Более подробное описание: postgis.net/docs/ST_Buffer.html
  # По умолчанию 8, для большинства датасетов подойдет дефолтное значение.
  buffer_segments: 8
```


# Примеры

[Примеры](../../../../garden/modules/renderer_denormalization_source_config/data/layers_yt.yaml) слоев из layers_yt.yaml.  
[Примеры](../../sandbox/task) рецептов из sandbox шедулеров.  
[Примеры](tests/data) рецептов из тестов.
