### Описание архитектуры

<img src="https://jing.yandex-team.ru/files/eak1mov/tilemill_serv_tiles.png" alt=""/>

Сервис отдает по ручке `/tiles` vec3 тайлы, доставая их из файлов S3-MDS, хранящихся в специальном формате.  
Аргументу `source_uri` соответствует файл с тайлсетом в S3 (до 100GB), в котором хранятся тайлы и индекс для ускорения доступа к тайлам.  
При запросах файл скачивается не полностью, а частями с помощью http range запросов.  

Структура файла тайлсета описана в [libs/tile_storage](https://a.yandex-team.ru/arc/trunk/arcadia/maps/renderer/tilemill/libs/tile_storage/README.md).
Для отдачи тайла сервис делает запросы в S3 для получения:
- заголовка файла и параметров хранения тайлсета,
- части индекса файла, соответствующей координатам xyz тайла,
- содержимого тайла.

Запросы в S3 кэшируются через 1) LRU кэш в памяти процесса, ограниченный по потреблению памяти, 2) nginx кэш на диске.  
Сервис не поддерживает версионирование тайлсетов, поэтому кэш никак не инвалидируется и сервис может отдавать тайлы на уже отсутствующие в S3 тайлсеты.

Некоторые тайлсеты [могут содержать](https://a.yandex-team.ru/arc/trunk/arcadia/maps/renderer/tilemill/libs/mill/README.md) неполный набор валидных зумов, на отсутствующие в тайлсете зумы сервис будет отвечать 400.

<img src="https://jing.yandex-team.ru/files/eak1mov/tilemill_serv_s3.png" alt=""/>

По ручкам `/meshes` и `/indoor/plans` сервис проксирует отдачу мешей и индор планов из файлов в S3-MDS (без какой-либо обработки).
