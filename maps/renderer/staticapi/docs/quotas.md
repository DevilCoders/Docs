# Квоты

Для каждого ключа API ограничена разрешенная нагрузка (во взвешенных запросах в секунду), при превышении которой API отдает ошибку с кодом 429 Too Many Requests.

Использование квоты можно посмотреть на [панели рейтлимитера](https://yasm.yandex-team.ru/template/panel/maps_core_renderer_staticapi-ratelimiter2-panel).

{% note tip %}

Рекомендуется для тестинга использовать отдельный от прода ключ API, чтобы случайно из-за ошибки в тестинге не превысить продакшен-квоту и не сломать работу приложения у пользователей.

{% endnote %}


## Как рассчитать квоту { #calc }

В рейтлимитере для каждого запроса в API рассчитывается вес, зависящий от размера картинки в пикселях, количества слоев (подложка, пробки и т.д.), применения кастомизации. Вес запроса соответствует вычислительным ресурсам, необходимым для отрисовки карты.

Сначала нужно определиться, какие размеры карты с каким RPS будут запрашиваться. Вы можете дать эти данные [команде сервиса]({{ contacts_url }}), мы рассчитаем для вас квоту.


### Формула расчета веса запроса { #calc_alg }

В сервисе используется следующий код для расчета веса запроса:

{% code '/maps/renderer/staticapi/tools/calc-request-weight/main.py' lang='py' %}

{% note info %}

Формула для расчета веса подбиралась эмпирически на основе стрельб, в будущем мы можем ее изменить.

{% endnote %}


### Пример { #calc_example }

Пример расчета квоты для придуманного сайта.
- На основной странице сайта рисуется маленькая карта ([размер 200x200](https://static-maps.yandex.ru/1.x/?l=map&ll=37.617520,55.755865&size=200,200&pt=37.588144,55.733842,placemark&api_key=66e592f8-5b03-11eb-ae93-0242ac130002&signature=159dGAiOYI8MxqbSMyV2EsEkNqGi2Rk5W5rKaFvZ4Ec=)), аудитория генерирует в пике 20 загрузок страницы в секунду.
- За кликом страница с большой картой с пробками ([размер 600x350, два слоя map,trf](https://static-maps.yandex.ru/1.x/?l=map,trf&ll=37.617520,55.755865&size=600,350&pt=37.588144,55.733842,placemark&api_key=66e592f8-5b03-11eb-ae93-0242ac130002&signature=O0M_p-52n3Cg_ulFPTVl521A8y08J2U5mRyvraKn38I=)), на нее переходит 5% пользователей.
- Половина посетителей второй страницы с ретиной, им показывается вдвое увеличенная карта ([размер 1200x700, два слоя map,trf, scale 2](https://static-maps.yandex.ru/1.x/?l=map,trf&ll=37.617520,55.755865&size=1200,700&scale=2&pt=37.588144,55.733842,placemark&api_key=66e592f8-5b03-11eb-ae93-0242ac130002&signature=JF5xmXo-i7qEK6JCfO5UjOJ1bVInr95gYaGmfzUegDM=)).

Считаем вес запроса и нагрузку на API для каждого размера карты:
| Запрос | RPS | Вес запроса | Нагрузка |
|--------|-----|-------------|----------|
| ...&l=map&size=200,200 | 20 | 3 | 60 |
| ...&l=map,trf&size=600,350&scale=1 | 0.5 = 20 * 5% / 2 | 17 | 9 |
| ...&l=map,trf&size=1200,700&scale=2 | 0.5 = 20 * 5% / 2 | 52 | 26 |

Складываем числа в последнем столбце (60 + 9 + 26 = 95), добавляем запас 20% и получаем квоту 114 (= 95 * 1.2).


## Как изменить квоту { #change }

Обратитесь к [команде сервиса]({{ contacts_url }}), мы поменяем ограничения в конфигах.

Возможно нам потребуется заказать ресурсы в YP и расширить сервис для увеличения вашей квоты.
