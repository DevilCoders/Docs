# Общая информация

Это документация про различные workflow для фидбэка fbapi.

Пути появления фидбэка:
* POST-запрос в [feedback_api](https://a.yandex-team.ru/arc/trunk/arcadia/maps/wikimap/feedback/api/src/yacare)
* регулярный [импорт из Сансары](https://a.yandex-team.ru/arc/trunk/arcadia/maps/wikimap/feedback/api/src/samsara_importer)

В POST-запросы фидбэк отправляют пользователи из форм фидбэка.
Формы для отправки фидбэка есть в БЯК, МЯК, Навигаторе, карточке Организации на Серпе и др.
В Личном Кабинете у пользователя появляются задания, выполняя которые он создаёт фидбэк.

Пути модификации фидбэка:
* PUT-запрос в [feedback_api](https://a.yandex-team.ru/arc/trunk/arcadia/maps/wikimap/feedback/api/src/yacare) (используется только для обновления из НК)
* синхронизация с Сансарой и Справочником

Перераспределение обработки фидбэка в другие сервисы — одна из основных задач сервиса fbapi.
Также есть задача синхронизации статуса обработки фидбэка между внешними сервисами.
Внешние сервисы:
* Народная Карта (aka НК, НЯК или Nmaps)
* Сансара
* Справочник
* Трекер

Синхронизация с Сансарой и Справочником осуществляется со стороны fbapi.
НК сначала импортирует fbapi-фидбэчины. Когда фидбэчины в НК изменяют своё состояние, НК отправляет изменения в PUT-ручку.


# Workflow фидбэка в fbapi

_высокоуровневое описание архитектуры_

## Поля фидбэка в fbapi

<table>
<tr>
    <th>Имя поля в БД
    <th>Что означает
    <th>Комментарии
</tr>
<tr>
    <td>service
    <td>
        Cервис, от которого ожидается обработка фидбэка.<br>
        Или сервис, который последний обрабатывал фидбэк.
</tr>
<tr>
    <td>status
    <td>
        Статус фидбэка.<br>
        <code>new | in_progress | accepted | rejected | need_info | published</code>
</tr>
<tr>
    <td>integration
    <td>
        id связанного объекта во внешнем сервисе.
    <td>
        <li>В integration с НК хранится резолюция, с которой закрыт фидбэк в НК.
        <li>Удаление интеграции означает, что мы больше не будем синхронизироваться с этим объектом.
        <li>Интеграция может оставаться в закрытом фидбэке.
</tr>
<tr>
    <td>service_object_url
    <td>Это legacy. Следует использовать одноимённое поле из интеграции.
</tr>
<tr>
    <td>service_object_id
    <td>Это legacy. Следует использовать одноимённое поле из интеграции.
</tr>
</table>

## Состояния фидбэка

<table>
<tr>
    <th>Название
    <th>Что означает
    <th>Как выглядит такой фидбэк
    <th>Комментарии
</tr>
<tr>
    <td>New
    <td>Ожидает экспорта в НК
    <td>
        <li> status = <code>New</code>
        <li> нет Интеграций (фактически: есть интеграция с НК)
</tr>
<tr>
    <td>NeedInfo-answered
    <td>Ожидает синхронизации с НК
    <td>
        <li> status = <code>New</code>
        <li> есть интеграция с НК
    <td>НК карта отличает это состояние от New по наличию уже импортированного такого фидбэка
</tr>
<tr>
    <td>Accepted
    <td>Обработка успешно закончена
    <td>
        <li> status = <code>Accepted</code>
    <td>
        Сервис, который обрабатывал фидбэк, закончил обрабатывать фидбэк.
</tr>
<tr>
    <td>Rejected
    <td>Обработка закончена c вердиктом Rejected
    <td>
        <li> status = <code>Rejected</code>
    <td>
        Сервис, который обрабатывал фидбэк, закончил обрабатывать фидбэк.
</tr>
<tr>
    <td>Redirected
    <td>Обработка делегирована
    <td>
        <li> status = <code>Rejected</code>
        <li> [было бы удобно для этого случая отдельный статус иметь]
    <td>
        Работы по фидбэку продолжаются (например, в Сансаре или Трекере). <br>
        Но сервис fbapi свою миссию завершил. <br>
        Дальнейшая обработка происходит за пределами зоны ответственности этого сервиса.
</tr>
<tr>
    <td>Published
    <td>Исправления по фидбэку опубликованы
    <td>
        <li> status = <code>Published</code>
    <td>Похож на <b>Accepted</b>, но другой статус.
</tr>
<tr>
    <td>InProgress-Nmaps
    <td>Обрабатывается в НК
    <td>
        <li> status = <code>InProgress</code>
        <li> service = <code>Nmaps</code> (хотя сейчас это не проверяется)
    <td>
        НК сама сообщает сервису fbapi об изменении фидбэка. <br>
        Поэтому этому сервису нет нужды хранить ссылку на фидбэк в НК. <br>
        Но <a href="https://st.yandex-team.ru/NMAPS-12666">хочется</a>. <br>
        <br> При этом может существовать интеграция с Сансара-тикетом. <br>
        Этот тикет - связь с автором фидбэка: способ сообщить или спросить что-то у юзера.
</tr>
<tr>
    <td>InProgress-Sprav
    <td>Обрабатывается в Справочнике
    <td>
        <li> status = <code>InProgress</code>
        <li> service = <code>Sprav</code>
        <li> есть интеграция со Справочником; хранится id для связи с заявкой в Справочнике для синхронизации
    <td>
</tr>
<tr>
    <td>InProgress-Samsara
    <td>Обрабатывается в Сансаре
    <td>
        <li> status = <code>InProgress</code>
        <li> service = <code>Samsara</code>
        <li> есть интеграция с Сансарой; хранится id Сансара-тикета для синхронизации
    <td>
</tr>
<tr>
    <td>NeedInfo
    <td>Получаем информацию от пользователя
    <td>
        <li> status = <code>NeedInfo</code>
        <li> service = <code>Samsara</code>
        <li> есть интеграция с Сансарой
    <td>
        Фидбэк обрабатывается в НК. <br>
        Но сейчас мы создали в Сансаре запрос дополнительной информации у автора фидбэка. <br>
        <br>
        Ждём ответ из Сансары чтобы отправить его в НК и продолжить обрабатывать фидбэк в НК.
</tr>
</table>

## Допустимые операции с фидбэком

_Пока описаны только операции доступные через ручку `PUT /v1/tasks/$`._

<code>[В планах: описать изменение фидбэка при синхронизации с Сансарой и Справочником.]</code>

### Приоритетная роль НК в смене состояний фидбэка

Сервис fbapi должен выполнить любой запрос на изменение фидбэка поступивший от НК.

Примеры:
* запросить NeedInfo для закрытого фидбэка
* перенаправить в Трекер фидбэк, который уже был перенаправлен в Сансару
* переотклонить с другим RejectReason

В реализации предлагается делать это в 2 этапа:
* привести фидбэк к **исходному состоянию** для _запрошенного действия_;
* выполнить _запрошенное действие_

### Таблица операций с фидбэком

<table>
<tr>
    <th>Название операции
    <th>Исходное состояние
    <th>Целевое состояние
    <th>Необходимые сопутствующие действия
    <th>Точка получения этого запроса
    <th>Что может пойти не так
</tr>
<tr>
    <td>Redirect to Tracker
    <td>InProgress-Nmaps
    <td>Redirected
    <td>
        <li> если есть связанный Сансара-тикет, написать туда текстом резолюцию;
        <li> fbapi-task status установить в Rejected
        <li> в интеграцию с НК прописать резолюцию
        <li> создать тикет в Трекере
        <li> прописать интеграцию с Трекером в фидбэк
        <li> слинковать созданный Трекер-тикет со связанным Сансара-тикетом; если нет созданного Сансара-тикета - создать;
        <li> перевести связанный Сансара-тикет в согласованное с заказчиком состояние; надо следить, чтобы из этого состояния не происходил import в fbapi;
        <li> в связанный Сансара-тикет написать комментарий переданный из НК
        <li> удалить интеграцию с Сансарой
        <li> удалить интеграцию с Трекером
    <td>запрос <code>PUT /v1/tasks/$</code>
</tr>
<tr>
    <td>Move to NeedInfo
    <td>InProgress-Nmaps
    <td>NeedInfo
    <td>
        <li> fbapi-task status установить в NeedInfo
        <li> Связанный Сансара-тикет переводится в состояние Open::New и перекладывается в специальную очередь
        <li> Через этот Сансара-тикет автору фидбэка отправляется вопрос.
    <td>запрос <code>PUT /v1/tasks/$</code>
    <td>
        <b>Не получилось связаться с автором (плохая почта):</b>
        <li>Написать об этом в fbapi-фидбэк.
        <li>Перевести fbapi-фидбэк в состояние NeedInfo-answered
</tr>
<tr>
    <td>Reject as ProhibitedByRules
    <td>InProgress-Nmaps
    <td>Rejected
    <td>
        <li> если есть связанный Сансара-тикет, написать туда текстом резолюцию;
        <li> если фидбэк импортирован из Сансары, сменить очередь Сансара-тикета; иначе закрыть Сансара-тикет;
        <li> fbapi-task status установить в Rejected
        <li> в интеграцию с НК прописать резолюцию <code>prohibited-by-rules</code>
        <li> [может остаться интеграция с Сансарой; это нормально?]
        <li> если есть <code>uid</code> и <code>client_context_id</code> не содержит <code>push_notification</code>, запланировать отправку пуша
    <td>запрос <code>PUT /v1/tasks/$</code>
</tr>
<tr>
    <td>Reject as IncorrectData
    <td>InProgress-Nmaps
    <td>Rejected
    <td>
        <li>если есть связанный Сансара-тикет, написать туда текстом о смене статуса
        <li>если есть связанный Сансара-тикет и фидбэк импортирован из Сансары, сменить очередь Сансара-тикету
        <li>если есть связанный Сансара-тикет и фидбэк НЕ импортирован из Сансары, закрыть Сансара-тикет
        <li>записать в интеграцию с НК резолюцию
        <li>сменить status
        <li>сменить service
        <li> если есть <code>uid</code> и <code>client_context_id</code> не содержит <code>push_notification</code>, запланировать отправку пуша
    <td>запрос <code>PUT /v1/tasks/$</code>
</tr>
<tr>
    <td>Redirect to Samsara
    <td>InProgress-Nmaps
    <td>Redirected
    <td>
        <li>если есть связанный Сансара-тикет, переоткрыть его и написать туда сообщение переданное из НК;
        <li>если нет связанного Сансара-тикета, создать новый; записать туда текстом суть сообщения из fbapi-таска;
        <li>создать интеграцию с Сансарой
        <li>fbapi-task status установить в Rejected
        <li>в интеграцию с НК прописать резолюцию <code>redirect-to-support</code>
        <li>[тоже может остаться интеграция с Сансарой]
    <td>запрос <code>PUT /v1/tasks/$</code>
    <td>
        <li> Не получилось связаться с автором по причине плохой почты. Создать Сансара-тикет без почты.
</tr>
<tr>
    <td>Redirect to Sprav (если есть интеграция со Справочником)
    <td>InProgress-Nmaps
    <td>Redirected
    <td>
        <li>если есть связанный Сансара-тикет, написать туда текстом о смене статуса
        <li>если есть связанный Сансара-тикет и фидбэк импортирован из Сансары, сменить очередь Сансара-тикету
        <li>если есть связанный Сансара-тикет и фидбэк НЕ импортирован из Сансары, закрыть Сансара-тикет
        <li>записать в интеграцию с НК резолюцию <code>redirect-to-sprav</code>
        <li>сменить status на Rejected
        <li>сменить service на Sprav
        <li>[надо явно прописать допустимые status-ы и service-ы]
        <li>если есть связанный Сансара-тикет, закрыть его с резолюцией Rejected
        <li>установить service = Sprav и status = InProgress [перезатираем status и service]
        <li>[теряем сообщение переданное из НК]
    <td>запрос <code>PUT /v1/tasks/$</code>
</tr>
<tr>
    <td>Redirect to Sprav (если интеграции со Справочником нет)
    <td>InProgress-Nmaps
    <td>Redirected
    <td>
        <li>если есть связанный Сансара-тикет, написать туда текстом о смене статуса
        <li>если есть связанный Сансара-тикет и фидбэк импортирован из Сансары, сменить очередь Сансара-тикету
        <li>если есть связанный Сансара-тикет и фидбэк НЕ импортирован из Сансары, закрыть Сансара-тикет
        <li>записать в интеграцию с НК резолюцию
        <li>сменить status на Rejected
        <li>сменить service
        <li>[надо явно прописать допустимые status-ы и service-ы]
        <li>если есть связанный Сансара-тикет, закрыть его с резолюцией Rejected
        <li>создать таску в Справочнике с переданным сообщением
        <li>добавить интеграцию с вновь созданной таской Справочника
    <td>запрос <code>PUT /v1/tasks/$</code>
</tr>
<tr>
    <td>Publish
    <td>InProgress-Nmaps
    <td>Published
    <td>
        <li>если есть связанный Сансара-тикет, написать туда текстом о смене статуса
        <li>если есть связанный Сансара-тикет и фидбэк импортирован из Сансары, сменить очередь Сансара-тикету
        <li>если есть связанный Сансара-тикет и фидбэк НЕ импортирован из Сансары, закрыть Сансара-тикет
        <li>записать в интеграцию с НК резолюцию
        <li>сменить status
        <li>сменить service
        <li>если есть <code>uid</code>, запланировать отправку пуша
    <td>запрос <code>PUT /v1/tasks/$</code>
</tr>
<tr>
    <td>Reject
    <td>InProgress-Nmaps
    <td>Rejected
    <td>
        <li>если есть связанный Сансара-тикет, написать туда текстом о смене статуса
        <li>если есть связанный Сансара-тикет и фидбэк импортирован из Сансары, сменить очередь Сансара-тикету
        <li>если есть связанный Сансара-тикет и фидбэк НЕ импортирован из Сансары, закрыть Сансара-тикет
        <li>записать в интеграцию с НК резолюцию
        <li>сменить status
        <li>сменить service
    <td>запрос <code>PUT /v1/tasks/$</code>
</tr>
<tr>
    <td>Open
    <td>*
    <td>InProgress-Nmaps
    <td>
        <li>если есть связанный Сансара-тикет, написать туда текстом о смене статуса
        <li>сменить status
        <li>сменить service
    <td>запрос <code>PUT /v1/tasks/$</code>
</tr>
<tr>
    <td>Accept
    <td>InProgress-Nmaps
    <td>Accepted
    <td>
        <li>сменить status
        <li>сменить service
    <td>запрос <code>PUT /v1/tasks/$</code>
</tr>
</table>
