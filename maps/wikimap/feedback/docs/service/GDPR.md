### Постановка задачи

Нужно научиться удалять данные из сервиса для соблюдения GDPR.

На выходе должно быть две ручки:
* `GET /1/takeout/status/`  - статус данных пользователя: `ready_to_delete|delete_in_progress|empty`
* `POST /1/takeout/delete/` - удаляет данные для пользователя

[Спецификация](https://wiki.yandex-team.ru/users/yakushevsky/takeoutrequirements/)


### Текущее состояние

Сейчас в бд все пользовательские данные лежат в таблице `feedback_task` в столбце `origianl_task` внутри json-а. [Схема](https://a.yandex-team.ru/arc/trunk/arcadia/maps/wikimap/feedback/api/schemas/v1/original-task.json).

Данные бывают следующие:
  - `uid`
  - `email`
  - `uuid`
  - `device_id`
  - `yandexuid`
  - `ip`
  - `user_full_name`

Удалять нужно данные только по `uid`.

### Техническое решение

В бд создаём новую схему `gdpr` и в ней создаём новые таблицы:
* `takeout`
  - `uid`
  - `status`: `new`|`in_progress`|`done`
  - `request_id`
  - `requested_at` - момент запроса на удаление
  - `completed_at` - момент удаления данных
* `hidden_data`
  - `task_id`
  - `uid`
  - `email` - optional
  - `uuid` - optional
  - `device_id` - optional
  - `yandexuid` - opotinal
  - `ip` - optional

##### Сценарий использования
Пользователь c `uid=X` сказал, что его данные нужно удалить.
Делаем следующее:
1. Записываем в `uid=X, status=new, request_id=...` в таблицу `gdpr.status`. `request_id` берём из запроса на удаление
2. По крону запускаем тул:
  - тул берёт из `gdpr.takeout` все запросы без `completed_at`
  - для каждого запроса:
    - если для `uid` из запроса нет информации в `feedback_task`
      - то проставляем `completed_at` = `now()`
    - иначе
      - загружаем батч из `feedback_task` для `uid` из запроса
      - копируем информацию про пользователя из батча в `gdpr.hidden_data`
      - удаляем информацию про пользователя, содержащуюся в батче, из `feedback_task`

В результате для каждой таски можно восстановить авторство по таблице `gdpr.hidden_data`.
По таблице `gdpr.takeout` получим ответ `delete_in_progress` для `GET /1/takeout/status/`, если для заданного `uid` в ней есть запись без `completed_at`. В противном случае проходим по `feedback_task` и ищем там записи с данным uid. Если хоть одна запись есть, то возвращаем `ready_to_delete`, иначе - `empty`.

Для восстановления авторства фидбека добавляем ручку `GET v1/tasks/user_info?task_id=...`, которая по id таски возвращает данные о пользователе.


##### Преимущества
* Никак не меняется реализация существующего интерфейса: не создаём пространства для багов
* Никак не нужно править никого из клиентов


### Подводные камни
* Что делать с фидбеком, который на момент gdpr-запроса в обработке?
* Как надо обработать фидбек, который пользователь отправил после запроса на удаление данных, но до окончания обработки запроса? Он может быть как анонимизирован, так и нет, в зависимости от момента отправки фидбека.
__Ответ__: Юридически у нас есть месяц, на принятие решения об удалении данных, после чего мы должны удалить данные с момента принятия решения. Поэтому непринципиально, с какого именно момента данные будут анонимизированы.

* Пользовательские данные прорастут в Справочник и Сансару, откуда не будут вычищены. При отправке уведомлений из Справочника и Сансары пользователь не будет считаться анонимным, уведомления ему могут прийти после того, как он отправил запрос на удаление данных, и зарос был обработан.
* Справочник может выдать пользовательские данные в каких-то своих сервисах


### Ссылки
* https://st.yandex-team.ru/NMAPS-12252
* Спецификаця новых endpoint-ов: https://wiki.yandex-team.ru/users/yakushevsky/takeoutrequirements/

