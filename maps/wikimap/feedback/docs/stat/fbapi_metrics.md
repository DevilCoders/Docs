# Метрики фидбэка из fbapi

Этот скрипт занимается подсчётом метрик по фидбэку из [fbapi](https://a.yandex-team.ru/arc/trunk/arcadia/maps/wikimap/feedback/api).
Ранее уже был написан [скрипт](https://a.yandex-team.ru/arc/trunk/arcadia/maps/wikimap/stat/nmaps_feedback), вычисляющий отчёт по метрикам фидбэка. Однако дашборд, построенный по этому отчёту, загружается медленно ([тикет](https://st.yandex-team.ru/NMAPS-13897)).
Новый код не создаёт отчёт в Statface, а строит дашборд в DataLens напрямую по таблицам на YT, используя [ClickHouse over YT (CHYT)](https://datalens.yandex-team.ru/docs/solutions/data-from-ch-over-yt). Дополнительно такой переезд мотивирован тем, что Statface закапывается ([пост в Этушке](https://clubs.at.yandex-team.ru/statistics/2431)).

Текущий [дашборд](https://datalens.yandex-team.ru/ywy6v7i0ywjyr-feedback-metrics).

Изменения по сравнению с прошлым отчётом:
- убрано измерение `source_path`, имеющее глубокую вложенность, из-за которого происходила медленно фильтрация в дашборде
- данные для метрик берутся в первую очередь из [дампа базы fbapi](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/core/nmaps/dynamic/replica/fbapi), а остальная необходимая информация приджойнивается из [дампа базы НЯК-а](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/core/nmaps/analytics/feedback/db) и [bebr-логов](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/analytics/logs/cooked-bebr-log)

На дашборде имеются следующие вкладки:
- Обзор: сводка основных метрик фидбэка с возможностью фильтрации
- Сравнение по клиентам: сравнение выбранной метрики по клиентам
- Конверсия форм: сводка метрик, связанных с воронкой форм фидбэка
- Полезность: распределение разобранного фидбэка по установленным резолюциям
- Пользователи: метрики числа пользователей, оставляющих фидбэк через формы
- CSAT: метрика [Customer Satisfaction](https://st.yandex-team.ru/NMAPS-13857)
- Продукты: распределение фидбэка по продуктам и дополнительно разделение на органику и пуши
- Вклад: распределение метрик фидбэка по целевым продуктовым аспектам
- Точки входа (контексты): распределение метрик фидбэка по точкам входа, из которых пользователь открыл форму
- Поток в резолюции: объём потока фидбэка из различных контекстов в резолюцию

На каждой вкладке представлен свой набор фильтров в селекторах.
Основные фильтры:
- регион
- ширина окна в днях (доступные значения: 1, 7, 28)
- ID формы: кто должен обработать заявку (`form_id`)
- ID клиента (`metadata.client_id`)
- тип формы (`form_type`)
- мество вызова формы в UI (`form_context_id`)
- контекст формы, полученный из урла (`form_context.client_context_id`)
- ID формы вопроса (`question_id`)
- ID формы ответа (`answer_id`)
Более подробно про эти поля можно посмотреть в документации ([раз](https://a.yandex-team.ru/arc/trunk/arcadia/maps/wikimap/feedback/api/schemas), [два](https://github.yandex-team.ru/maps/maps/blob/dev/docs/feedback.md)) и [схеме](https://a.yandex-team.ru/arc/trunk/arcadia/maps/wikimap/feedback/api/schemas/v1/task.json).

Основные метрики:
- создано
- обработано
- опубликовано
- принято
- принято с правками
- доля принятых
- доля принятых с правками
- отклонено
- число показов
- число сабмитов
- конверсия форм
- сколько фидбэка закрывается с определённым `reject_reason`-ом
- количество фидбэка в статусе `need_info`
- создателей фидбэка
- создателей разобранного фидбэка
- создателей принятого фидбэка
- создателей фидбэка с правками

## Оранизация результирующих таблиц на YT
Готовые расчёты лежат [тут](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/core/nmaps/analytics/feedback_metrics). Результирующие таблицы организованы следующим образом:
```
//home/maps/core/nmaps/analytics/feedback_metrics/
    meta/
    metrics/
        experiments/
        feedback/
        forms/
        users/
```

* `meta/` хранит мета-таблицы, которые содержат отсортированный набор уникальных значений для каждого измерения. Эти таблицы нужны для того, чтобы не выполнять тяжёлый запрос `select distinct` по всем недельным таблицам на каждое построение дашборда.
* `metrics/feedback/` хранит недельные таблицы c основными метриками фидбэка
* `metrics/forms/` хранит недельные таблицы с метриками по формам
* `metrics/users/` хранит недельные таблицы с метриками по пользователям
* `metrics/experiments/` хранит недельные таблицы c метриками для каждого эксперимента

Необходимость разделения `metrics/` на группы заключалась в том, что метрики в разных группах имеют разные наборы допустимых фильтров.

## Регулярный расчет

* [Nirvana graph](https://nirvana.yandex-team.ru/flow/1b712a11-a97d-498b-9383-c7ee5c416fd9)
* [Reactor](https://reactor.yandex-team.ru/browse?selected=9583259)

## Ручной запуск

После сборки скрипт запускается через `ya nile`. Для расчёта используется `yql`-бэкенд nile, поэтому для запуска необходимы `yt`-токен и `yql`-токен.
Можно использовать свой, а можно запускать вычисления из-под `robot-wikimap`. Токены робота можно найти в [секретнице](https://yav.yandex-team.ru/secret/sec-01cpqs004vh9nxcv6p26zk4k9b/).

Весь код разбит на 2 модуля:
* `calculate_metrics` - непосредственно вычисление метрик и раскладывание их по недельным табличкам.
* `calculate_meta` - вычисление мета-таблиц, хранящих отфильтрованные уникальные значения измерений по недельным таблицам. Фильтрация происходит по регулярному выражению. Дополнительно можно указать значения, которые хочется отфильтровать, через опцию `--blacklist`.
Запускать модули следует в порядке перечисления.

Пример запуска `calculate_metrics`:
```
YT_TOKEN=<robot-wikimap token> ya nile ./calculate_metrics/bin/libcalculate_feedback_metrics.so run -- --from-date 2021-01-01 --to-date 2021-08-31 \
--result-path '//home/maps/core/nmaps/analytics/feedback_metrics/metrics' --use-yql --scale 'daily' --dates 1970-01-01 --proxy 'hahn'
```

Пример запуска `calculate_meta`:
```
YT_TOKEN=<robot-wikimap token> ya nile ./calculate_meta/bin/libcalculate_meta.so run -- --metrics-dir '//home/maps/core/nmaps/analytics/feedback_metrics/metrics/feedback' --meta-dir '//home/maps/core/nmaps/analytics/feedback_metrics/meta' \
--blacklist '{"client_context_id": ["kokoko"], "form_context_id": ["nxtspxrkex"]}' --use-yql --scale 'daily' --dates 1970-01-01 --proxy 'hahn'
```
Опция `--use-yql` включает использование `yql`-бэкенда. С `yql`-бэкендом нужно собирать именно `UDF` таргет, а не бинарь. Значение опций `--scale` и `--dates` не имеет значения. Они указываются лишь потому что использование `statinfra_job` делает их обязательными.

#### Обновление полей

###### Добавление новой формы фидбека
При добавлении новых форм фидбека нужно протащить новые `form_type` на графики во вкладку «Вклад». Для этого надо определить, к какому аспекту относится новая форма. Список форм по аспектам надо отредактировать [здесь](https://datalens.yandex-team.ru/editor/hzd34ir0flnga-common-lib).

###### Добавление новой причины отклонения {#add-reject-reason}

Новую причину надо протащить на вкладку «Полезность».
Инструкция:
1. Добавить новую причину отклонения  в список актуальных [констант](https://a.yandex-team.ru/arc_vcs/maps/wikimap/stat/fbapi_feedback_metrics/calculate_metrics/lib/constants.py?rev=r9414260#L38).
2. Пересчитать все метрики, [инструкция](fbapi_metrics#recalculation). Это приходится делать, т.к. иначе схема табличек в yt обрезается по общему набору колонок во всех табличках – надо прорастить новую колонку во все таблички.
3. Отредактировать каждый из [графиков полезности](https://datalens.yandex-team.ru/ywy6v7i0ywjyr-feedback-metrics?tab=7l8) – общий и для топонимов:
   * нажать на 3 точки в правом верхнем углу графика
   * выбрать источники
   * источник – Datalens BI, перейти в него
   * нажать «Обновить поля», в списке полей увидеть новую причину отклонения
   * нажать «Сохранить»
   * вернуться к графику, через те же 3 точки нажать «Редактировать»
   * добавить новое поле в измерения по оси Y
   * сохранить изменения

### Эксперименты

Для построения метрик по экспериментам требуются дополнительные данные о проведенных и проводимых для НЯК и форм фидбэка экспериментах. Это список экспериментов и список подвыборок этих экспериментов, записанные в таблицах на YT. При рабочем регулярном расчёте эти данные обновляются ежедневно. Для обновления используется скрипт, получающий данные из API AB-экспериментов: [calculate_experiments_meta.py](https://a.yandex-team.ru/arc/trunk/arcadia/maps/wikimap/stat/fbapi_feedback_metrics/calculate_experiments_meta/bin/calculate_experiments_meta.py), его можно использовать для обновления вручную. Для этого необходим AB-токен.

Доп. таблицы:
* [hahn.//home/maps/core/nmaps/analytics/feedback_metrics/meta/experiment_ticket](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/core/nmaps/analytics/feedback_metrics/meta/experiment_ticket)
* [hahn.//home/maps/core/nmaps/analytics/feedback_metrics/meta/test_id](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/core/nmaps/analytics/feedback_metrics/meta/test_id)

## Перерасчёт метрик за определённый период {#recalculation}

Результат расчёта разбивается по неделям (по одной таблице на каждую неделю), поэтому нет необходимости пересчитывать метрики за весь период времени. Вместо этого необходимо лишь вычислить метрики за новый период, указав соответствующие значения для опций `--from-date` и `--to-date`. Значение `--from-date` будет округлено вниз до ближайшего понедельника, а `--to-date` будет округлено вверх до ближайшего воскресенья. Такой интерфейс позволяет не думать о внутренней организации недельных таблиц.

Если хочется пересчитать метрики за длительный промежуток времени, например, с начала 2020 года, то имеет смысл запускать не один расчёт, а несколько непересекающихся по датам. Бывали случаи, когда один расчёт за длительный промежуток времени падал, потому что при подготовке YT операции разделения одной болшой таблицы на множество недельных таблиц, временная таблица успевала удалиться. Одно небольшое замечание: если одновременно запускается несколько расчётов и в `--result-path` передаётся новая пустая директория, то стоит заранее в ней создать поддиректории `feedback`, `forms` и `users`, т.к. в противном случае параллельные расчёты будут конкируровать за эти поддиректории и не смогут одновременно писать. В таком случае весь расчёт падает на последнем этапе разделения на недельные таблицы.

## Ресурсы в DataLens

Все ресурсы DataLens (чарты, селекторы, датасеты и сам дашборд) сложены по пути `nmaps/feedback/fbapi_feedback_metrics`.
Часть чартов сделана в `Wizard`-е, часть в `ChartEditor`-е. Первый способ более простой, однако менее гибкий.

Для некоторых вкладок, сделанных в `Wizard`-е, нужно 2 идентичных датасета. Это нужно из-за ~~особенностей работы~~ багов DataLens. Дело в том, что на некоторых вкладках дашборда помимо общего чарта отдельно присутствуют чарты по фидбэку на топонимы и на организации, в которых фиксирован `form_id`. Связи между полями чарта и селектора можно редактировать. Однако почему-то при добавлении связи между полем селектора и полем одного чарта связь добавляется и для всех остальных чартов, постоенных на том же датасете. Костыль с двумя датасетами решает эту проблему. Ещё один костыль, чтобы всё завелось: поле датасета и поле селектора, указанное в фильтрах чартов, должно называться по-разному. В данном случае поле `form_id` в селекторе переименовано в `form_id2`. Подробно обсуждение этих проблем можно посмотреть в [тикете](https://st.yandex-team.ru/CHARTS-4452).

Для датасета в `DataLens`-е можно редактировать источники: таблицы на `YT`, по которым строится датасет. Для этого переходим во вкладку "источники". Для имеющейся таблицы нажимаем "изменить настройки", где во вкладке "Диапазон" или "SQL" можно указать диапазон таблиц. Сейчас в качестве источника данных ко всем датасетам указана вся соответствующая директория с таблицами по неделям. Важно, чтобы все объединяемые таблицы из диапазона имели одинаковую схему.
