# Фидбэк от курьеров Я.Еды

Скрипт для подготовки таблиц с фидбэком от курьеров Еды.

[Код](https://a.yandex-team.ru/arc/trunk/arcadia/maps/wikimap/stat/eda_couriers_feedback).

# Данные

Входные таблицы:
* [Дамп базы fbapi](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps-nmaps/dynamic/replica/fbapi/feedback_task)
* [Дамп базы НЯК](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps-nmaps/analytics/feedback/db/feedback_latest)
* [Логи заказов Еды](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/statistics/eda_order_delivery_log)

Итоговые таблицы с фидбэком от курьеров лежат [тут](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/core/nmaps/analytics/eda_couriers_feedback).
Формат выходных таблиц:
* `did` — id устройства курьера-автора фидбэка.
* `eda_courier_id` — id курьера.
* `fbapi_url` — ссылка на фидбэк в админке фидбэка.
* `nmaps_url` — ссылка на фидбэк в народной карте.
* `feedback_status` — статус разбора фидбэка.
Возможные статусы: `new`, `in_progress`, `need_info`, `rejected`, `accepted`, `published`. Их описание находится [здесь](https://docs.yandex-team.ru/maps-feedback/service/workflow#sostoyaniya-fidbeka).
* `feedback_utc_created_at` — время создания фидбэка.
* `feedback_utc_updated_at` — время последнего обновления статуса фидбэка (колонка `feedback_status`).
* `is_resolved_with_edits` — был ли принят фидбэк с правками.
`is_resolved_with_edits` == `true` если `feedback_status` == `accepted` или `published`, и по фидбэку были внесены правки.
* `order_id` — id заказа.
* `order_utc_start_point` — время в UTC начала заказа (колонка `utc_start_point_fact_dttm` из логов Еды).
* `order_utc_end_point` — время в UTC конца заказа (колонка `utc_destination_arrival_fact_dttm` из логов Еды).
* `region_id` — id региона, в котором был создан фидбэк.
* `region_name` — текстовое имя региона, соответствующего `region_id`.

Из статуса `accepted` фибэк может переходить только в статус `published`. Статус `published` можно считать терминальным. Однако на практике технически есть возможность перевести фидбэк из этих статусов в другой. Например, при ошибочном разборе. То есть статус фидбэка в колонке `feedback_status` может меняться произвольным образом во всех таблицах, которые участвуют в пересчёте.

# Регулярный расчёт

* [Nirvana graph](https://nirvana.yandex-team.ru/flow/e8873e9b-f876-4050-8a73-57a1ba90c152/3000e1b1-56ca-463b-8e73-1ae2e3f9840d/graph).
* [Reaction](https://reactor.yandex-team.ru/reaction?id=12300874&mode=overview).

В кубик запуска yql-запроса можно передавать следующие параметры:
* `n_days_back` — количество дней, за которые производится пересчёт.
* `result_path` — пути, куда складываются результирующие таблицы.

# Логика расчёта

* Достать регион фидбэка. Регион "округляется" до масштаба города.
* Собрать все данные по фидбэку вместе: джоин данных базы fbapi и НЯКа по id фидбэка из НЯКа.
Из базы НЯК берётся `commit_ids` для понимания наличия правок по фидбэку.
* Склеить пачку дневных логов Еды в отдельную табличку (берётся `n_days_back` дней в прошлое).
* Сгруппировать весь фидбэк по id устройства в колонку со списком yson-фидбэков.
* Сгруппировать все заказы Еды по id устройства в колонку со списком yson-заказов.
* Сджойнить весь фидбэк и все заказы Еды по по id устройства.
* Для кажого id устройства пересечь все заказы и фидбэк по времени: время создания фидбэка `created_at` должно быть заключено между временем начала и конца обслуживания заказа. `created_at` и `updated_at` переводятся в UTC, т.к. время начала и конца заказов хранятся в UTC. При дампе базы fbapi на YT время сохраняется строчкой с суффиксом таймзоны `+03:00`.
* Сделать `FLATTEN BY` на получившемся списке пересечений заказов Еды и фидбэка.
* Разложить всё по дневным табличкам.

Формально задача пересечения фидбэка с заказами по времени представляет из себя задачу проверки покрытия точек (время создания фидбэка) отрезками (интервалы обслуживания заказов Еды). Для этого используется алгоритм сканирующей прямой: сортируются все точки по времени, и далее делается линейный проход с поддержанием множества открытых отрезков. Асимптотика `O((n + m) log (n + m))` (на сортировку), `n` - число фидбэка (точек), `m` - число заказов (отрезков).
