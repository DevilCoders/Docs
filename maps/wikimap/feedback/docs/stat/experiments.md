# Эксперименты

Эксперименты проводятся через ab, [документация](https://doc.yandex-team.ru/analytics/experiments-guide/concepts/about.xml).

### Важные ссылки
* Старая реализация: [описание](https://a.yandex-team.ru/arc/trunk/arcadia/quality/ab_testing/cofe/projects/geo/fbapi)
* Новая реализация:
  * [Код](https://a.yandex-team.ru/arc/trunk/arcadia/quality/ab_testing/cofe/projects/geo/feedback_forms)
  * [Документация](https://wiki.yandex-team.ru/maps/dev/ui/yandexcontentfrontgeodata/kak-zavodit-metriki-v-cofe/)

### Отличия старой и новой реализации
В старой (таска `fbapi`):
* заведены метрики только на 4 из форм фидбэка (address/add, address/edit, route/edit, route/edit/better);
* участие фидбэка в эксперименте определяется косвенным образом (может быть неточным);
* метрики разбора фидбэка доступны только в режиме расчета espresso;
* присутствуют дополнительные метрики просмотра/сабмита форм (доступны также и в режиме fetch: таска `fbapi_forms`).

В новой:
* метрики считаются для [списка из 56 форм](https://a.yandex-team.ru/arc/trunk/arcadia/quality/ab_testing/cofe/projects/geo/feedback_forms/metrics.py?rev=r8824684#L70), актуального на 2021-10-28.
* участие в эксперименте считается каноническим способом, по test-ids, которые передаются в сервис;
* временно отсутствуют метрики просмотра/сабмита форм.

### Режимы расчета

Реализация экспериментов предоставляет два режима расчета метрик:
* fetch: на основе ежедневных предрасчитанных "выжимок" (занимает несколько минут) — подходит не для всех видов метрик;
* espresso: полный цикл расчета на основе исходных логов (зачастую — порядка часа, но может занять и десяток часов).

Автоматика экспериментов производит расчет "выжимок" — ежедневный запуск расчета фичей для одного прошедшего дня. Это позволяет построить отчет по эксперименту (наблюдению) произведя только вычислительно легкую агрегацию данных за нужный период и быстро получить результат.

Природа некоторых метрик такова, что для них не подходит такой процесс напрямую. Либо не подходит принципиально (например, для определения перцентилей), либо нужна дополнительная настройка. Особенность метрик **полезности фидбэка** (количество/доля разобранных, принятых и т. д.) в том, что разбор фидбэка происходит на протяжении определенного времени — например, по SLA, в течении трех дней. Таким образом, в ежедневном расчете "выжимок" для созданных за предыдущий день фидбэчин нет возможности учесть их разбор в следующие дни.

Режим espresso позволяет произвести расчет метрик, используя исходные данные, наиболее актуальные на данный момент. Минусом это режима является скорость расчета — подготовка может занимать часы. По опыту, часто бывает достаточно одного часа для расчета, но в некоторых случаях расчет может считаться и 10 часов.

При модификации и добавлении метрик, чтобы иметь возможность использовать режим fetch в новой версии за даты, предшествующие релизу этих метрик, необходимо заказать ["пересчет данных в прошлое"](https://wiki.yandex-team.ru/serp/experiments/cofe/doc/nile/#kakpereschitatdannyevproshloe). Режим espresso для таких метрик можно успешно использовать и без этого.

### Как подготовить отчет по метрикам форм фидбэка

* Перейти по ссылке в графе "Integral observation" таблицы в тикете эксперимента (EXPERIMENTS-?????). Откроется страница сервиса A/B с настройками расчета.
* Среди проектов в списке выбрать "GEO" (вместо "ABT").
* Для настройки "Даты" выбрать нужный для отчета интервал ("все дни" автоматически подставит день начала и день завершения эксперимента; "полные дни" (предпочтительно) — все дни эксперимента, кроме первого и последнего, когда эксперимент был включен лишь часть дня).
* Для "Режим" (см. выше различие режимов):
  * "espresso" — предпочтительно — использует актуальные данные о разборе фидбэка, но долго работает;
  * "fetch" — применимо в отдельных случаях:
    * не нужны метрики разбора фидбэка (разобрано/принято/отклонено) — в таком режиме учитывают только разбор в день создания фидбэка и не будут корректны в общем случае;
    * процесс расчета метрик не менялся после начала эксперимента (или был произведен ["пересчет"](https://wiki.yandex-team.ru/serp/experiments/cofe/doc/nile/#kakpereschitatdannyevproshloe)).
* "Таски" (см. выше отличие реализаций):
  * `feedback_forms` — новая реализация;
  * `fbapi` — старая реализация (доступна только для режима espresso);
  * `fbapi_forms` — только метрики просмотра/сабмита форм из старой реализации (доступна и в fetch, и в espresso).
* В поле "YT Pool" имеется возможность указать пул расчета, например, "maps-nmaps-mapreduce", если к нему имеется доступ.
* Поставить галочку "Использовать новый интерфейс".
* Нажать "Рассчитать".

В режиме espresso и при отсутствии возможности указать свой "YT pool" можно расчитать отчет не более чем для 14 дней — в этом случае может не получится подготовить отчет за все "полные дни" и нужно будет указать более узкий диапазон дат.

Начтется расчет отчета за выбранные даты.

Подготовка отчета может занять **долгое время, вплоть до 10 часов**.

Фильтрация метрик:

* Кликнуть на три точки (или иконку, в старом интерфейсе) рядом с кнопкой "Набор метрик".
* Выбрать из списка пункты с названием "Fbapi" (для удобства можно ввести "Fbapi" в поле фильтра или нажать "Свернуть все").
