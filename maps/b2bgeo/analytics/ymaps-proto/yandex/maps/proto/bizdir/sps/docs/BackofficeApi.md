## Общее описание пайплайна обработки сигнала

1. Клиент отправляет сигнал в СПП через API приёма сигнала.
2. СПП обрабатывает сигнал (валидация, формирование вердикта контент-менеджером) и принимает решение о необходимости формирования обновления на выход:
  * Если обновление формировать не нужно, то СПП устанавливает статус обработки сигнала.
  * Если необходимо сформировать обновление, то оно отправляется через API приёма обновлений. СПП ожидает принятия/непринятия обновления согласно API. По результату устанавливает статус сигнала.
3. Клиент может забрать готовый статус обработки сигнала.

## Приём сигнала на стороне СПП

### API приёма сигнала

#### Клиент посылает сигнал в СПП

`POST /v1/signal/add?id=<signal_id>`
Body: `yandex.maps.proto.bizdir.sps.Signal`

  201
  Сигнал принят и добавлен в очередь на обработку.

  400
  Ошибка клиента. Такой запрос повторять бесполезно.

  409
  Ошибка клиента. Сигнал с таким `<signal_id>` уже существует.

  500
  Ошибка сервера. Клиенту нужно повторить запрос `POST /v1/signal/add`

#### Клиент проверяет состояние сигнала в СПП

`GET /v1/signal/get?id=<signal_id>`

  500
  Ошибка сервера. Клиенту нужно повторить запрос `GET /v1/signal/get?id=<signal_id>`

  404
  Сигнал не найден. Такого сигнала нет и никогда не существовало.

  202
  Сигнал еще не обработан.

  200
  Результат готов и находится в теле ответа в формате `yandex.maps.proto.bizdir.sps.SignalResult`

### Примерный алгоритм действий клиента

1. Клиент на своей стороне формирует уникальный идентификатор сигнала и делает POST запрос на `/v1/signal/add?id=<signal_id>`
2. Сервер возвращает 201.
3. Клиент делает запрос GET `/v1/signal/get?id=<signal_id>`
4. Клиент обрабатывает ответ:
  * Если сервер вернул 202, то нужно подождать некоторое время и перейти к п.3.
  * Если сервер вернул 404, то сигнал не существует, сдаёмся или переходим к п.1.
  * Если сервер вернул 200, то п.5
5. Клиент забирает результат из тела ответа.

500-ки обрабатываются перезапросом на тот же url, который вернул 500.

### Формат идентификатора сигнала

Идентификатор сигнала формируется источником сигнала и должен иметь следующий вид `sps1://{source-id}?{signal-id}`, где:

* `source-id` – идентификатор системы из которой пришёл сигнал
* `signal-id` – уникальный идентификатор сигнала внутри этой системы

## Приём обновлений на стороне Справочника (== выход СПП)

### API приёма обновления

#### СПП отправляет результирующее обновление

`POST /v1/business_diff/add`
Body: `yandex.maps.proto.bizdir.sps.BusinessDiff`

  201
  Обновление принято и добавлено в очередь на обработку.
  В теле ответа находится сообщение `yandex.maps.proto.bizdir.sps.AddBusinessDiffResponse`

  400
  Ошибка клиента. Такой запрос повторять бесполезно.

  500
  Ошибка сервера. Клиенту нужно повторить запрос `POST /v1/business_diff/add`

#### СПП проверяет статус обновления

`GET /v1/business_diff/get?id=<business_diff_id>`

  500
  Ошибка сервера. Клиенту нужно повторить запрос `GET /v1/business_diff/get?id=<business_diff_id>`

  404
  Обновление не найдено. Такого обновления нет и никогда не существовало.

  202
  Обновление еще не обработано.

  200
  Результат готов и находится в теле ответа в формате `yandex.maps.proto.bizdir.sps.BusinessDiffResult`

### Примерный алгоритм действий СПП при формировании обновления

1. СПП делает POST запрос на `/v1/business_diff/add`
2. Сервер возвращает 201.
3. СПП запоминает пришедший в теле `business_diff_id`.
4. СПП делает запрос GET `/v1/business_diff/get?id=<business_diff_id>`
5. СПП обрабатывает ответ:
  * Если сервер вернул 202, то нужно подождать некоторое время и перейти к п.4.
  * Если сервер вернул 404, то обновление не существует, сдаёмся или переходим к п.1.
  * Если сервер вернул 200, то п.6
6. СПП забирает результат из тела ответа и на его основании обновляет статус связанных с обновлением сигналов.

500-ки обрабатываются перезапросом на тот же url, который вернул 500.

## Известные клиенты

[C++](https://a.yandex-team.ru/arc/trunk/arcadia/maps/wikimap/feedback/api/src/libs/sps_client?rev=r8573509)

