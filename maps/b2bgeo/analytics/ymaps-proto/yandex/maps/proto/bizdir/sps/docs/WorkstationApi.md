## API для АРМ системы приёма правок

### Общее описание взаимодействия контент-менеджера и АРМ

1. Контент-менеджер нажимает кнопку "получить следующую гипотезу".
2. Фронтенд получает очередную гипотезу с помощью запроса на
   **/v1/hypothesis/find** с `UserTicket` контент-менеджера
3. СПП подбирает гипотезу, привязывает её к переданному `UserTicket` и
   возвращает фронтенду
4. Фронтенд показывает гипотезу контент-менеджеру
5. Контент-менеджер выносит вердикт по гипотезе, фронтенд отправляет его
   POST-запросом на **/v1/verdict**. Если для вынесения вердикта
   контент-менеджеру нужно посмотреть подробную историю правок, то это можно
   сделать с помощью запросов на **/v1/hypothesis/find?id=<hypothesis_id>** с
   идентификаторами гипотез из истории.
6. Фронтенд запрашивает новое состояние текущей гипотезы с помощью запроса на
   **/v1/hypothesis/find?id=<hypothesis_id>** и показывает его
   контент-менеджеру.
7. Контент-менеджер переходит к пункту 1.

В случае, когда гипотеза сложная и требует длительных разбирательств,
контент-менеджер может отложить ее разбор на потом (запрос на
**v1/hypothesis/postpone?id=<hypothesis_id>**). Отложенная гипотеза попадет в
конец очереди контент-менеджера.

Контент-менеджер может посмотреть список назначенных на него гипотез (с
поддержкой пагинации) с помощью запроса на **/v1/assigned_hypotheses/find**. В
списке назначенных гипотез присутствует минимальная информация, чтобы различать
гипотезы (название организации). Для получения более подробной информации нужно
использовать запросы на **/v1/hypothesis/find?id=<hypothesis_id>**.

С помощью запроса на **/v1/signal/find?id=<signal_id>** можно получить `id` созданной
гипотезы по id сигнала.

С помощью запроса на **/v1/stats** можно получить статистику по гипотезам.


### Требования к запросу

Во всех запросах должны передаваться TVM `ServiceTicket` и `UserTicket`.

### Заголовки запроса

* `X-Ya-Service-Ticket`
* `X-Ya-User-Ticket`
* Accept: `application/x-protobuf`(по умолчанию) или `text/x-protobuf`

### Коды ответов

| Код ответа                | Комментарий                                   |
| ---                       | ---                                           |
| 200 Ok                    |                                               |
| 400 Bad Request           | Ошибка в запросе                              |
| 401 Unauthorized          | Отсутствуют нужные TVM-тикеты                 |
| 403 Forbidden             | У пользователя нет доступа к нужному объектy  |
| 404 Not Found             | Отсутствует объект с нужным идентификатором   |
| 429 Too Many Requests     | Квота RPS превышена                           |
| 500 Internal Server Error | Повторите запрос / свяжитесь с разработчиками |

### API

#### **/v1/hypothesis/find**

**Method**        | GET                                                                            |
-------------     | -                                                                              |
**Params**        |                                                                                |
`id`              | Optional, идентификатор гипотезы                                               |
**Description**   | Получение следующей гипотезы для контент-менеджера или поиск гипотезы по `id`. |
**Response Body** | `yandex.maps.proto.bizdir.sps.Hypothesis`                                      |

#### **/v1/hypothesis/postpone**

**Method**        | POST                                                                           |
-------------     | -                                                                              |
**Params**        |                                                                                |
`id`              | Required, идентификатор гипотезы                                               |
**Description**   | Отложить рассмотрение гипотезы                                                 |
**Response Body** | Достаточно кода ответа                                                         |

#### **/v1/stats**

**Method**        | GET                                                                            |
-------------     | -                                                                              |
**Params**        | Отсутствуют                                                                    |
**Description**   | Получение статистики по гипотезам.                                             |
**Response Body** | `yandex.maps.proto.bizdir.sps.Statistics`                                      |

#### **/v1/verdict**

**Method**        | POST                                                           |
-------------     | -                                                              |
**Params**        |                                                                |
`hypothesis_id`   | Required, идентификатор гипотезы                               |
**Request Body**  | `yandex.maps.proto.bizdir.sps.Hypothesis`                      |
**Description**   | Отправка контент-менеджером вердикта для обработанной гипотезы |
**Response Body** | Достаточно кода ответа                                         |

#### **/v1/assigned_hypotheses/find**

**Method**        | GET                                                                                                                                                                  |
-------------     | -                                                                                                                                                                    |
**Params**        |                                                                                                                                                                      |
`base_id`         | Optional, позиция в отсортированном по времени списке назначенных гипотез, относительно которой сервер формирует ответ                                               |
`before_limit`    | Optional, количество гипотез, которые нужно вернуть перед гипотезой `base_id`, 0 по умолчанию, не используется без параметра `base_id`                               |
`after_limit`     | Optional, количество гипотез, которые нужно вернуть после гипотезы `base_id`, 0 по умолчанию, если не задавать `base_id`, то сервер вернёт гипотезы из начала списка |
**Description**   | Получение списка гипотез, назначенных контент-менеджеру.                                                                                                             |
**Response Body** | `yandex.maps.proto.bizdir.sps.AssignedHypotheses`                                                                                                                    |

#### **/v1/signal/find**

**Method**        | GET                                                                            |
-------------     | -                                                                              |
**Params**        |                                                                                |
`id`              | Required, идентификатор сигнала                                                |
**Description**   | Поиск гипотезы по `id` сигнала.                                                |
**Response Body** | `yandex.maps.proto.bizdir.sps.SignalInfo`                                      |

### Детальное описание механизма пагинации

Сделана для условно бесконечной ленты.

* `base_id`, Optional, id объекта в ленте, задаёт позицию в отранжированной
  ленте, относительно которой сервер формирует ответ
* `before_limit`, Optional, количество объектов, которые нужно вернуть перед
  объектом `base_id`, не используется без параметра `base_id`
* `after_limit`, Optional, количество объектов, которые нужно вернуть после
  объекта `base_id`, если не задавать `base_id`, то сервер вернёт задания из
  начала отранжированного списка

#### Сценарии

Пусть сервер знает ленту, которая состоит из объектов 100, 99, 98, 97, ..., 5,
4, 3, 2, 1. Будем считать объект 100 наиболее релевантным, а объект 1 -
наименее релевантным.

| Сценарий                                                     | Запрос                                                   | Ответ                                                                      |
| ----------                                                   | --------                                                 | -------                                                                    |
| получить объект по id                                        | `base_id=5` или `base_id=5&after_limit=0&before_limit=0` | 5                                                                          |
| получить 5 самых релевантных объектов                        | `after_limit=5`                                          | 100, 99, 98, 97, 96                                                        |
| получить новые объекты в ленте (проверить, появились ли они) | `base_id=100&before_limit=1`                             | ответ пустой, если новых объектов не появилось; 101, если что-то появилось |
| получить следующую страницу объектов (скролл вниз)           | `base_id=96&after_limit=5`                               | 95, 94, 93, 92, 91                                                         |
| лента закончилась                                            | `base_id=3&after_limit=10`                               | 2, 1                                                                       |
| лента закончилась, ответ пустой                              | `base_id=1&after_limit=10`                               |                                                                            |
| пользователь смотрит на объект 35 и скроллит вверх           | `base_id=35&before_limit=5`                              | 40, 39, 38, 37, 36                                                         |
| запрос внутри ленты                                          | `base_id=35&before_limit=2&after_limit=3`                | 37, 36, 35, 34, 33, 32                                                     |

