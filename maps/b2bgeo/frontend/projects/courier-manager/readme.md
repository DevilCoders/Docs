# Courier Manager Frontend [![OKO health](https://badger.yandex-team.ru/oko/repo/B2BGeo/courier-manager-frontend/health.svg)](https://oko.yandex-team.ru/repo/B2BGeo/courier-manager-frontend)

## Production

[yandex.ru/courier](https://yandex.ru/courier)

### Locales ad tlds

```
.ru - Russian
.com - English
.com.tr - Turkish
.com/courier/es/â€¦ - Spanish
```

## Stable

[yandex.ru/courier/stable](https://yandex.ru/courier/stable)

Any commit to master branch will be deployed to stable

## Testing

[l7test.yandex.ru/courier/](https://l7test.yandex.ru/courier/)

Every pull_request with Head branch name like `"[[:digit:]]+-r[[:digit:]]4-[[:digit:]]2-[[:digit:]]2"` (for example 4545-r2020-03-17)
will be deployed to testing

## Development

### env

- Create .env file.
- Pick env from `.env.example`

### Start server

Run `npm run bootstrap` in root folder if you haven`t done this before.

```
    npm install
    npm run dev

    // for windows
    set NODE_ENV=development
    set SUDO_UID=123
    npm run magic
```

App is available at [https://localhost.msup.yandex.ru:8082/](https://localhost.msup.yandex.ru:8082/)

Any branch with pull_request will be deployed to `test-stand-{branch-name}.b2bgeo-int.yandex.ru/courier`.
And will be undeployed when pull_request will be closed or merged

## Local development

```bash
npm i
npm run magic
```

## Running production build locally

1. Build the container

```bash
npm install
npm run build
docker build \
  --build-arg APP_VERSION=dev \
  -f server/Dockerfile \
  -t server \
  . # <= notice the dot here
```

2. Run the container

```bash
docker run -p 80:80 server
```

The server will be on localhost:80. You will likely need to configure https for it to work

## Functional Autotests

See [readme.md](./e2e-tests/readme.md)

## API Type Defs generation

For synchronization and automatic type defs generation based on Swagger use following npm scripts

- `sync-solver-api`
- `sync-monitoring-api`

Monitoring API requires `API_TOKEN` env variable.

1. Create [OAuth token](https://yandex.ru/routing/doc/delivery/concepts/quickstart/register.html?lang=ru)
2. Ask for super user access

## Generate testcases data

For generating test cases data and test runs we use following API's for test company

- [**TestPalm API**](https://wiki.yandex-team.ru/testpalm/)
- [**TUS API**](https://wiki.yandex-team.ru/tus/)
- **API Token**

In case if you need to generate them locally, you need to prepare your env (or `.env`):

- [`TUS_OAUTH_TOKEN` - Token for creating users](https://oauth.yandex-team.ru/authorize?response_type=token&client_id=9052de6e4cf142039a7ee44ac03e4614)
- [`TESTPALM_OAUTH_TOKEN` - Token for fetching testpalm testcases](https://oauth.yandex-team.ru/authorize?response_type=token&client_id=6d967b191847496a8a7077e2e636142f)
- [`B2BGEO_COURIER_API_TOKEN` - OAuth test user token](https://yav.yandex-team.ru/secret/sec-01ddnqnfh237cr58aggnrknxfm/explore/versions)
- [`B2BGEO_COURIER_API_KEY` - apiKey test user](https://yav.yandex-team.ru/secret/sec-01f6f1hp59b26b6199csg4sz38/explore/versions)
- `TEST_RUN_BRANCH` - Branch that will be used in "non trendbox" environment. e.g 0000-rXX-XX-XXXX

> Test Runs can be found here - https://testpalm.yandex-team.ru/courier/testruns

For extra information

```bash
npm run testruns:generate help
npm run testruns:remove help
```

Generate test runs

```bash
npm run testruns:generate
```

Remove test runs

```bash
npm run testruns:remove
```

## How to add EXCEL validations

1. Update schema if needed - e.g **xlsx/utils/schema**
1. Update type definitions if needed - e.g **xlsx/utils/parsed-sheets**
1. Add validations - e.g **xlsx/utils/postParseChecks/vehicles**
1. Add notification type - e.g **xlsx/utils/notifications/message**
1. Add group type if needed - e.g **xlsx/utils/notifications/groups**
1. Update message config - e.g **xlsx/utils/notifications/config**
1. Add column titles if needed - e.g **importModals/tabs/columnConfigs/vehicles**
1. Add tests - e.g **xlsx/utils/postParseChecks/vehicles.test**

## Mocking API requests in DEV environment

You can intercept API requests with service worker and response with mock data

- `src/mock-service-worker.ts` - Place where you can define your mock request handlers. [**msw
  docs**](https://mswjs.io/)
- `server/mock-service-worker/mockServiceWorker.js` - **AUTOGENERATED** service worker from "msw" library.
