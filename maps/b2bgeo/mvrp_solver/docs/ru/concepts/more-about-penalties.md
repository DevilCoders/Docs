# Информация о штрафах при маршрутизации

В системе существуют следующие виды штрафов.

## За недоставку заказа

Штраф начисляется, когда алгоритм по какой-то причине не может включить данный заказ ни в один из маршрутов. Значение суммируется по всем недоставленным заказам.

| Поле в ответе API | Поля запроса в API, которые влияют на расчет |
|----------------------|----------------------------------------------|
| `total_drop_penalty` | `locations.penalty.drop`\*                   |

\* - У данного поля есть значение по умолчанию.

## За нарушение временного окна заказа

Штраф начисляется за каждую ситуацию, когда курьер прибывает на заказ раньше или позже границ временного окна (если определено, что такие ситуации допустимы, и, соответственно, `location.hard_window` = `false`).

| Поле в ответе API | Поля запроса в API, которые влияют на расчет |
|----------------------|----------------------------------------------|
| `failed_time_window_locations_count_penalty` + `failed_time_window_locations_duration_penalty` | `locations.penalty.out_of_time.fixed`\*<br/>`locations.penalty.out_of_time.minute`\*<br/>`locations.penalty.early.fixed`\*<br/>`locations.penalty.early.minute`\*<br/>`locations.penalty.late.fixed`\*<br/>`locations.penalty.late.minute`\* |

\* - У данного поля есть значение по умолчанию.

При расчете могут быть указаны параметры `locations.penalty.late` и `locations.penalty.early`. В этом случае указанные в этих полях значения будут использоваться вместо значений в поле `locations.penalty.out_of_time`. То есть:

- При раннем прибытии (опоздании) и указанном поле `locations.penalty.early.fixed` (`locations.penalty.late.fixed`), будет начислена указанная сумма. Если поле не указано, проверяется значение в поле `locations.penalty.out_of_time.fixed` и начисляется указанное в нем значение. Если и это поле не указано, начисляется штраф по умолчанию.
- При раннем прибытии (опоздании) и указанном поле `locations.penalty.early.minute` (`locations.penalty.late.minute`), за каждую минуту раннего прибытия будет начислена указанная сумма. Если поле не указано, проверяется значение в поле `locations.penalty.out_of_time.minute` и за каждую минуту опоздания начисляется указанное в нем значение. Если и это поле не указано, начисляется штраф по умолчанию.

Штраф рассчитывается отдельно по количеству нарушений границ временного окна заказа и по длительности таких нарушений:

- `failed_time_window_locations_count_penalty` рассчитывается как сумма штрафов за факт нарушения по всем случаям нарушений.

- `failed_time_window_locations_duration_penalty` рассчитывается как сумма штрафов за длительность нарушений по всем случаям нарушений.

## За нарушение временного окна склада

Штраф начисляется за каждую ситуацию, когда курьер выезжает со склада раньше временного окна работы склада или возвращается на склад позже временного окна работы склада (если определено, что такие ситуации допустимы, и, соответственно, `depot.hard_window` = `false`).

| Поле в ответе API | Поля запроса в API, которые влияют на расчет |
|----------------------|----------------------------------------------|
| `failed_time_window_depot_count_penalty` + `failed_time_window_depot_duration_penalty` | `depot.penalty.out_of_time.fixed`\*<br/>`depot.penalty.out_of_time.minute`\*<br/>`depot.penalty.early.fixed`\*<br/>`depot.penalty.early.minute`\*<br/>`depot.penalty.late.fixed`\*<br/>`depot.penalty.late.minute`\* |

\* - У данного поля есть значение по умолчанию.

При расчете могут быть указаны параметры `depot.penalty.late` и `depot.penalty.early`. В этом случае указанные в этих полях значения будут использоваться вместо значений в поле `depot.penalty.out_of_time`. То есть:

- При раннем прибытии (опоздании) и указанном поле `depot.penalty.early.fixed` (`depot.penalty.late.fixed`), будет начислена указанная сумма. Если поле не указано, проверяется значение в поле `depot.penalty.out_of_time.fixed` и начисляется указанное в нем значение. Если и это поле не указано, начисляется штраф по умолчанию.
- При раннем прибытии (опоздании) и указанном поле `depot.penalty.early.minute` (`depot.penalty.late.minute`), за каждую минуту нарушения временного окна будет начислена указанная сумма. Если поле не указано, проверяется значение в поле `depot.penalty.out_of_time.minute` и за каждую минуту опоздания начисляется указанное в нем значение. Если и это поле не указано, начисляется штраф по умолчанию.

Рассчитывается отдельно по количеству нарушений границ временного окна склада и по длительности таких нарушений:

- `failed_time_window_depot_count_penalty` рассчитывается как сумма штрафов за факт нарушения по всем случаям нарушений.

- `failed_time_window_depot_duration_penalty` рассчитывается как сумма штрафов за длительность нарушений по всем случаям нарушений.

## За нарушение временного окна смены

Штраф начисляется за каждую ситуацию, когда курьер начинает работу раньше временного окна смены или заканчивает работу позже временного окна смены (если определено, что такие ситуации допустимы, и, соответственно, `vehicles.shifts.hard_window` = `false`).

| Поле в ответе API | Поля запроса в API, которые влияют на расчет |
|----------------------|----------------------------------------------|
| `failed_time_window_shifts_count_penalty` + `failed_time_window_shifts_duration_penalty` | `vehicles.shifts.penalty.out_of_time.fixed`\*<br/>`vehicles.shifts.penalty.out_of_time.minute`\*<br/>`vehicles.shifts.penalty.early.fixed`\*<br/>`vehicles.shifts.penalty.early.minute`\*<br/>`vehicles.shifts.penalty.late.fixed`\*<br/>`vehicles.shifts.penalty.late.minute`\* |

\* - У данного поля есть значение по умолчанию.

При расчете могут быть указаны параметры `vehicles.shifts.penalty.late` и `vehicles.shifts.penalty.early`. В этом случае указанные в этих полях значения будут использоваться вместо значений в поле `vehicles.shifts.penalty.out_of_time`. То есть:

- При раннем (позднем) старте смены и указанном поле `vehicles.shifts.penalty.early.fixed` (`depot.penalty.late.fixed`), будет начислена указанная сумма. Если поле не указано, проверяется значение в поле `vehicles.shifts.penalty.out_of_time.fixed` и начисляется указанное в нем значение. Если и это поле не указано, начисляется штраф по умолчанию.
- При раннем (позднем) старте смены и указанном поле `vehicles.shifts.penalty.early.minute` (`vehicles.shifts.penalty.late.minute`), за каждую минуту раннего (позднего) старта смены будет начислена указанная сумма. Если поле не указано, проверяется значение в поле `vehicles.shifts.penalty.out_of_time.minute` и за каждую минуту опоздания начисляется указанное в нем значение. Если и это поле не указано, начисляется штраф по умолчанию.

Рассчитывается отдельно по количеству нарушений границ временного окна смены и по длительности таких нарушений:

- `failed_time_window_shifts_count_penalty` рассчитывается как сумма штрафов за факт нарушения по всем случаям нарушений.

- `failed_time_window_shifts_duration_penalty` рассчитывается как сумма штрафов за длительность нарушений по всем случаям нарушений.

## За неустойчивость маршрута к вероятному изменению временных окон заказов

Штраф применяется при ненулевом значении `options.proximity_factor`.

| Поле в ответе API      | Поля запроса в API, которые влияют на расчет |
|---------------------------|----------------------------------------------|
| `total_proximity_penalty` | `vehicles.cost.hour`, `vehicles.cost.km`     |

Порядок расчета следующий. Для каждого маршрута рассчитываются варианты движения при изменении последовательности точек и моделируется среднее значение продолжительности и километража маршрута. Таким образом имитируется ситуация, когда изменяется временное окно заказа. Смоделированное среднее значение для конкретного транспортного средства умножается сначала на стоимость за час или за км (`vehicles.cost.hour` или `vehicles.cost.km` соответственно), а затем - на коэффициент `proximity_factor`.

## За неравномерность маршрутов относительно друг друга

Штраф начисляется, если для определенных смен курьеров задано значение `vehicles.shifts.balanced_group_id`.

| Поле в ответе API     | Поля запроса в API, которые влияют на расчет                                          |
|--------------------------|---------------------------------------------------------------------------------------|
| `balanced_group_penalty` | `options.balanced_groups.penalty.hour`\*<br/>`options.balanced_groups.penalty.stop`\* |

\* - У данного поля есть значение по умолчанию.

Штраф рассчитывается отдельно по каждой группе балансировки и затем суммируется в итоговой метрике. Отдельно для каждого транспортного средства вычисляется отклонение от среднего значения по количеству остановок и по продолжительности маршрута, причем среднее значение берется по всем транспортным средствам, относящимся к конкретной группе балансировки. Далее суммарный штраф рассчитывается на основе суммы квадратов отклонений от среднего.

{% note %}

При расчете среднего учитываются все транспортные средства, даже те, по которым не были сформированы маршруты.

Например, пусть было задано 3 транспортных средства. Построилось 2 маршрута со следующими характеристиками:

- количество остановок – 10 и 8.

- продолжительность – 5 и 4 часа.

Тогда среднее количество остановок будет рассчитано как (10+8)/3 = 6, а средняя продолжительность маршрута – как (5+4)/3 = 3 часа.

{% endnote %}

## За нарушение максимальной продолжительности смены

Штраф начисляется за каждую ситуацию, когда длина смены курьера превышает значение, определенное для него в поле `vehicles.shifts.max_duration_s`.

| Поле в ответе API | Поля запроса в API, которые влияют на расчет |
|----------------------|----------------------------------------------|
| `overtime_penalty` = `overtime_shifts_count_penalty` + `overtime_duration_penalty` | `vehicles.shifts.penalty.out_of_time.fixed`\*<br/>`vehicles.shifts.penalty.out_of_time.minute`\*<br/>`vehicles.shifts.penalty.late.fixed`\*<br/>`vehicles.shifts.penalty.late.minute`\* |

\* – У данного поля есть значение по умолчанию.


При расчете можно указать параметр `vehicles.shifts.penalty.late`. В этом случае указанное в этом поле значение будет использоваться вместо значения в поле `vehicles.shifts.penalty.out_of_time`. То есть:

- При слишком длинной смене и указанном поле `vehicles.shifts.penalty.late.fixed`, будет начислена указанная сумма. Если поле не указано, проверяется значение в поле `vehicles.shifts.penalty.out_of_time.fixed` и начисляется указанное в нем значение. Если и это поле не указано, начисляется штраф по умолчанию.
- При слишком длинной смене и указанном поле `vehicles.shifts.penalty.late.minute`, за каждую минуту раннего прибытия будет начислена указанная сумма. Если поле не указано, проверяется значение в поле `vehicles.shifts.penalty.out_of_time.minute` и за каждую минуту опоздания начисляется указанное в нем значение. Если и это поле не указано, начисляется штраф по умолчанию.

Штраф рассчитывается отдельно по количеству и по длительности нарушений, при которых продолжительность смены превышена:

- `overtime_shifts_count_penalty` = сумма {`vehicles.shifts.penalty.out_of_time.fixed`  `vehicles.shifts.penalty.late.fixed`} по всем случаям нарушений

- `overtime_duration_penalty` = сумма {<длительность нарушения в минутах> \* `vehicles.shifts.penalty.out_of_time.minute` + `vehicles.shifts.penalty.late.minute`} по всем случаям нарушений

## За нарушение параметров пропускной способности склада

Штраф начисляется за каждый случай нарушения пропускной способности склада, если заданы соответствующие параметры `depot.throughput.kg_per_hour` и `depot.throughput.units_per_hour` и определены значения `locations.depot_duration_s`.

| Поле в ответе API  | Поля запроса в API, которые влияют на расчет                                                                 |
|-----------------------|--------------------------------------------------------------------------------------------------------------|
| `total_depot_penalty` | `depot.penalty.throughput.fixed`\*<br/>`depot.penalty.throughput.kg`\*<br/>`depot.penalty.throughput.unit`\* |

\* – У данного поля есть значение по умолчанию.

Штраф рассчитывается по количеству случаев нарушения (`depot.penalty.throughput.fixed`), за каждый килограмм или каждую грузовую единицу превышения относительно заданного ограничения.

## За формирование маршрутов с количеством стопов меньше или больше заданного ограничения

Штраф начисляется за каждую ситуацию, когда количество остановок в итоговом маршруте меньше значения `vehicles.shifts.minimal_stops` или  больше значения `vehicles.shifts.maximal_stops`, определенных в параметрах смены курьера.

Для `minimal_stops` штраф начисляется за каждую ситуацию, когда количество стопов в итоговом маршруте меньше значения vehicles.shifts.minimal_stops, определенного в параметрах смены курьера.


| Поле в ответе API       | Поля запроса в API, которые влияют на расчет                                               |
|----------------------------|--------------------------------------------------------------------------------------------|
| `total_stop_count_penalty` | `vehicles.shifts.penalty.stop_lack.fixed`<br/>`vehicles.shifts.penalty.stop_lack.per_stop` |



Для maximal_stops штраф начисляется за каждую ситуацию, когда количество стопов в итоговом маршруте больше значения `vehicles.shifts.maximal_stops`, определенного в параметрах смены курьера.


| Поле в ответе API  | Поля запроса в API, которые влияют на расчет                                                  |
|-----------------------|--------------------------------------------------------------------------------------------------|
| `total_stop_count_penalty` |`vehicles.shifts.penalty.stop_excess.fixed`<br/> `vehicles.shifts.penalty. stop_excess.per_stop`|


Штраф рассчитывается следующим образом:

Сумма {`vehicles.shifts.penalty.stop_lack.fixed`} по всем нарушениям + Cумма {<количество остановок, недостающих до параметра `minimal_stops`> \* `vehicles.shifts.penalty.stop_lack.per_stop`} по всем нарушениям + Сумма {<количество остановок свыше параметра `maximal_stops`> \* `vehicles.shifts.penalty.stop_excess.per_stop`} по всем нарушениям.

## За вероятные опоздания

Штраф начисляется за каждый случай вероятного прибытия вне границ временного окна, только если включена опция `minimize_lateness_risk` = `true`.

При расчете времени прибытия на заказ на основе статистики вычисляется не только математическое ожидание длительности прибытия, но и вероятное отклонение от него. Соответственно, когда полученное вероятное отклонение выходит за границу временного окна, то начисляется штраф (равный штрафу за фактическое прибытие вне границ временного окна, умноженному на вероятность возникновения такой ситуации).

| Поле в ответе API     | Поля запроса в API, которые влияют на расчет                                         |
|--------------------------|--------------------------------------------------------------------------------------|
| `total_probable_penalty` | `locations.penalty.out_of_time.fixed`\*<br/>`locations.penalty.out_of_time.minute`\*<br/>`locations.penalty.early.fixed`\*<br/>`locations.penalty.early.minute`\*<br/>`locations.penalty.late.fixed`\*<br/>`locations.penalty.late.minute`\* |

\* – У данного поля есть значение по умолчанию.

Штраф рассчитывается следующим образом:

<вероятность прибытия вне границ временного окна> \* (`locations.penalty.out_of_time.fixed` + `locations.penalty.early.fixed` + `locations.penalty.late.fixed` + <математическое ожидание длительности прибытия вне границ временного окна в минутах> \* `locations.penalty.out_of_time.minute` + <математическое ожидание длительности прибытия вне границ временного окна в минутах> \* `locations.penalty.early.minute` + <математическое ожидание длительности прибытия вне границ временного окна в минутах> \* `locations.penalty.late.minute`)

**Пример**

Пусть задано временное окно заказа с 8:00 до 9:00, и курьер отравляется с предыдущей точки в 7:30. Математическое ожидание длительности его поездки составляет 81 минуту: условно, с вероятностью 0,4 он приедет за 75 минут, с вероятностью 0,4 – за 80 минут, с вероятностью 0,1 – за 90 минут и с вероятностью 0,1 – за 100 минут.

Тогда система спланирует прибытие курьера на заказ в 8:51. Вместе с тем, есть вероятность 0,1, что курьер опоздает на 10 минут (то есть приедет в 9:10, когда его поездка составит 100 минут). Соответственно, за это вероятное опоздание и будет начислен штраф при `minimize_lateness_risk` = `true`.

## За нереалистичное решение

Штраф применяется достаточно редко и рассчитывается в следующих случаях:

*	При использовании опций `vehicles.visited_locations` и `vehicles.planned_route`, когда в маршруте заданы заказы, которые по ограничениям невозможно выполнить в данном маршруте (при планированиибез использования `vehicles.visited_locations` и `vehicles.planned_route` эти заказы попали бы в нераспределенные).
*	При нарушениях ограничений по tag, load_type, нарушений по вместимости при ручных корректировках.


| Поле в ответе API          | Поля запроса в API, которые влияют на расчет |
|-------------------------------|----------------------------------------------|
| `total_unfeasibility_penalty` | `locations.penalty.drop`\*                   |

\* – У данного поля есть значение по умолчанию.

Штраф рассчитывается как сумма {`locations.penalty.drop`} по заказам, которые включены в маршрут, но их невозможно выполнить по каким-то ограничениям.

<p class="p"><a href="feedback.html" class="xref button">Написать в службу поддержки</a></p>
