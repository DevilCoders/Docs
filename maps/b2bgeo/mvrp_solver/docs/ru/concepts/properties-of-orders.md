# Свойства заказов

Заказы в Яндекс.Маршрутизации представляют собой точки, которые должны быть посещены одним или более автомобилем в оптимальном порядке с соблюдением ограничений.

Для определения заказов используется поле запроса `locations`. Принцип «заказ = `location`» применим в большинстве ситуаций доставки со склада. Но в общем случае для сервиса планирования маршрутов `location` — это точка, в которой нужно выполнить определенное действие.

В `locations` будет больше точек, чем ваших заказов, если:

- используется [pickup & delivery](https://yandex.ru/routing/doc/vrp/concepts/properties-of-orders.html#priem-i-dostavka) ([delivery_to_any](https://yandex.ru/routing/doc/vrp/concepts/properties-of-orders.html#dostavka-v-odnu-iz-vozmozhnykh-tochek));

- задаются [старт не со склада](https://yandex.ru/routing/doc/vrp/concepts/properties-of-vehicles.html#start-avtomobilia-ne-so-sklada) или [завершение не на складе](https://yandex.ru/routing/doc/vrp/concepts/properties-of-vehicles.html#vozvrat-na-sklad-v-kontse-rabochego-dnia) (тогда в `locations` добавляются точки старта или окончания);

- ваш заказ по смыслу не равен заказу в Маршрутизаторе, т. е. ваш заказ разделяется или объединяется при загрузке в сервис планирования. Например:

   - заказ слишком большой (превышает вместимость любой из машин);

   - заказ содержит [несовместимые товарные номенклатуры](https://yandex.ru/routing/doc/vrp/concepts/properties-of-orders.html?lang=ru#nesovmestimost-zakazov);

   - заказ представляет собой доставку/cбор в нескольких точках.


## Идентификатор заказа

Обязательным атрибутом заказа является его номер (идентификатор), который задается в поле <code>id</code>.

Допускается использование любого уникального номера заказа из вашей учетной системы.

В дополнение к номеру заказа, вы можете указать другие атрибуты заказов из вашей учетной системы:

- название получателя в поле <code>title</code>.
- описание точки доставки (например, адрес) в поле <code>description</code> .

{% note %}

Обратите внимание, что поля <code>title</code>, <code>description</code> являются информационными и не используются при оптимизации маршрутов.

{% endnote %}


## Координаты заказа
Точку доставки заказа можно указать в системе  [WGS84](https://ru.wikipedia.org/wiki/WGS_84). Координаты должны соответствовать точке парковки или остановки для вручения заказа. Если местоположение заказа в вашей системе задается адресом, необходимо произвести [геокодирование](https://tech.yandex.ru/maps/geocoder/) (преобразование адреса в свободной форме в географические координаты).

{% note %}

Обратите внимание, что координаты `0,0` не будут обработаны корректно, и приведут к ошибке при запросе Маршрутизатора.

{% endnote %}

Для определения координат заказа используется поле `location.point`.


## Временное окно заказа
У всех заказов должно быть указано временное окно — интервал времени, когда автомобиль или курьер должен прибыть на адрес заказа.

Для определения временного окна используется поле `time_window`.

Временное окно определяется в [одном из следующих форматов](properties-of-time-window.md#otnositelnyi-format-vremennykh-okon):

- `07:00:00 - 23:00:00` — временное окно начинается в 7 утра и заканчивается в 23 вечера текущего дня;
- `2019-10-10T07:00:00+03:00/2018-10-10T23:00:00+03:00` — временное окно на конкретную дату и часовой пояс.

В зависимости от типа временного окна, курьер приедет на заказ строго в заданный интервал (**жесткое** окно), или может нарушать окно с дополнительным штрафом (**мягкое** окно). Подробнее данная функциональность описана в главе [Жесткие и мягкие окна](properties-of-time-window.md#zhestkie-i-miagkie-okna)

Для управления жесткими временными окнами используется поле `hard_window`:

- `true` — "жесткое" временное окно.
- `false` — "мягкое" временное окно.

В случае определения **мягкого** временного окна можно дополнительно задать штрафы за его нарушение. Подробнее данная функциональность описана в главе [Штрафы за нарушение временных окон заказов](properties-of-orders.md#shtrafy-za-narushenie-vremennykh-okon-zakazov).

При доставке к определенному времени не рекомендуется указывать окно с одинаковыми верхними и нижними временными границами, особенно если временное окно жесткое.

Например, если у заказа доставка строго к 9:00, то Маршрутизатор обработает значение `9:00:00 - 9:00:00` без ошибок, но на практике водитель будет приезжать на такой заказ заранее. Поэтому рекомендуется указывать временное окно в более реалистичном диапазоне – например `8:30:00 – 9:00:00`. Чем более узкие временные окна будут у заказов, тем (при прочих равных) больше потребуется машин чтобы выполнить эти заказы в заявленные временные окна. Поэтому временное окно должно как можно более правдиво отражать реальную возможность приезда в заданную точку.

{% note %}

Обратите внимание, что сервисное время не учитывается при определении факта попадания во временное окно. Например, если задано окно `10:00 - 16:00`, и сервисное время составляет 30 минут, прибытие на заказ в `15:59` будет считаться своевременным.

{% endnote %}

## Тип заказа

Тип заказа указывается в поле `type`. Возможные значения:

- `delivery` — точка доставки (значение по умолчанию).

- `pickup` — точка получения груза. Только для таких точек доступны поля (одно из двух):

   - [delivery_to](https://yandex.ru/routing/doc/vrp/concepts/properties-of-orders.html#priem-i-dostavka) — уникальная точка с типом `delivery`;

   - [delivery_to_any](https://yandex.ru/routing/doc/vrp/concepts/properties-of-orders.html#dostavka-v-odnu-iz-vozmozhnykh-tochek) — не уникальная точка с типом `drop off`.

- `drop_off` — точка выгрузки в сценарии [delivery_to_any](https://yandex.ru/routing/doc/vrp/concepts/properties-of-orders.html#dostavka-v-odnu-iz-vozmozhnykh-tochek).

- `garage` — точка [старта не со склада](https://yandex.ru/routing/doc/vrp/concepts/properties-of-vehicles.html#start-avtomobilia-ne-so-sklada) или [завершения не на складе](https://yandex.ru/routing/doc/vrp/concepts/properties-of-vehicles.html#vozvrat-na-sklad-v-kontse-rabochego-dnia).


## Несколько временных окон в заказе


При необходимости в Маршрутизаторе можно указать несколько временных окон в поле `time_windows`. В поле указывается массив элементов `time_window`, и заказ будет выполнен в один из них. В поле `used_time_window` ответа API содержится информация об исопльзованном временном окне.

Например, это поле можно использовать в следующих ситуациях:

- Если при доставке есть перерыв в работе точки доставки (например доставить нужно с 9 до 12, либо с 15 до 18).
- Если в многодневном маршруте нужно доставить в указанное время (например, с 9 до 18), но в один из дней доставки.

**Пример**

В примере ниже два заказа с двумя временными окнами. Заказы доставлены в первое временное окно, и в поле ответа `used_time_window` указано используемое временное окно.

[Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/5afb2c77-a757c66f-1bc8ac69-6ce1f12c) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/5afb2c77-a757c66f-1bc8ac69-6ce1f12c) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#5afb2c77-a757c66f-1bc8ac69-6ce1f12c)


## Вес заказа
Для каждого заказа к доставке может быть определен его вес. Определение веса не является обязательным, но рекомендуется во избежании перегрузки автомобилей.

Для определения веса заказа используется поле `shipment_size` (достаточно указать один из атрибутов):

- `shipment_size.weight_kg` — вес в килограммах или объемный вес.
- `shipment_size.volume` — габаритный вес. Задается как произведение измерений: длина, ширина, высота. Если измерения неизвестны, можно задать значение объема в каком-то одном поле, а в других полях указать 1.
- `shipment_size.units` — количество мест (паллет, коробок, кег) .

Более подробно с определением веса вы можете ознакомиться в главе [Вес и объем](properties-of-weight.md).

При указании веса заказов необходимо указать грузоподъемность у автомобилей.

В запросе желательно задавать вес и объем заказа брутто, особенно если информация о весе тары может оказать существенно влияние на результаты маршрутизации. Если этапе планирования информация по весу брутто в явном виде неизвестна, рекомендуется ее вычислять исходя из специфики перевозимых грузов. Например, если средний вес паллеты с грузом 800 кг, вес самой паллеты – 20 кг, в заказе указан вес нетто 500 кг и на момент планирования неизвестно, как груз будет скомплектован на складе – то вес в заказе при передаче в маршрутизацию можно указать так: `500 кг + 20 кг * (500/800)`= `512,5 кг`, количество грузовых единиц – как отношение ожидаемого веса брутто к среднему весу паллеты `512,5/800`, то есть как 0,64 паллеты. Данный вариант является только одним из возможных подходов к такому приблизительному расчету.

{% note %}

Eсли вес, объем или количество юнитов в заказе будет превышать максимальную вместимость транспортного средства, то данный заказ при планировании попадет в нераспределенные – в Маршрутизаторе заказ считается неделимой единицей. При наличии больших заказов в учетной системе рекомендуется разделять их на этапе выгрузке в Маршрутизатор.

{% endnote %}

## Пользовательские единицы измерения

Помимо заданных единиц веса, объема (вычисляемого через габариты) и количества мест, в Маршрутизаторе есть возможность указать пользовательские единицы измерения на заказе и ограничить вместимость по данным единицам измерения в [транспортном средстве](properties-of-vehicles.md#polzovatelskie-edinitsy-izmereniia-vmestimosti).

Такая потребность может возникнуть, если в дополнение к используемым измерениям (вес, объем, количество мест):

*	необходимо задать стоимость заказа и ограничить суммарную стоимость перевозимых курьером заказов, чтобы каждый курьер перевозил товаров на сумму не более N рублей;
*	необходимо ограничить количество заказов, которые перевозит каждый курьер. В таком случае можно указать для каждого заказа пользовательскую единицу измерения = 1 и соответственно на каждом транспортном средстве задать ограничение по этому количеству заказов;
*	необходимо реализовать любую другую логику, связанную с ограничением количества определенных заказов на курьере. Например, если есть VIP клиенты, к которым категорически нельзя опаздывать – можно установить правило, что на каждом курьере будет не более 2-х VIP заказов, чтобы снизить риск невыполнения этих заказов из-за каких-то неожиданных форс-мажоров.

Можно задавать несколько пользовательских единиц измерения и присваивать им любое название. Имя пользовательской единицы измерения на [транспортом средстве](properties-of-vehicles.md#polzovatelskie-edinitsy-izmereniia-vmestimosti) должно совпадать с указаным для заказа.

Пользовательская единица измерения задается параметром `shipment_size.custom`. По умолчанию размер заказа по пользовательской единице измерения равен 0.

**Пример**

В данном примере указаны вес, объем и количество грузовых единиц. Также задана стоимость заказа и ограничение на машине по суммарную стоимости перевозимых заказов с помощью параметров `location.shipment_size.custom` и `vehicle.capacity.custom` соответственно.

Видно, что есть 2 машины, которые везут по 1 заказу, хотя утилизация по весу, объему и количеству мест у них небольшая – это обусловлено тем, что стоимость этих заказов находится близко к установленному на машине ограничению.

[Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/78d9aa35-3c795c00-253124d7-57fe6f6c) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/78d9aa35-3c795c00-253124d7-57fe6f6c) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#78d9aa35-3c795c00-253124d7-57fe6f6c)




## Габариты заказа

При формировании заказа может быть необходимо учитывать не только его вес и объем, но и габариты. Например, в автомобиль с грузовым отсеком 1х1х1 метров нельзя поместить коробку размером 2х0.5х0.5 метров, даже несмотря на то, что по объему она должна помещаться.

В Маршрутизаторе можно использовать параметр `location.shipment_size.volume.type` чтобы задать тип перевозимого груза. Возможные значения:

* bulk - сыпучий. При формировании заказа его габариты не учитываются. Используется по умолчанию;
* rigid - жесткий. При формировании заказа учитываются габариты, но груз может быть повернут любой стороной;
* fixed_bottom - жесткий с фиксированным дном. При формировании заказа груз нельзя переворачивать (фиксированное измерение - height), но можно вращать.

{% note %}

Проверка габаритов заказа выполняется для каждого заказа индивидуально. Несколько заказов, которые помещаются по объему, но не по габаритам, могут быть назначены в один автомобиль. Например, 2 заказа с пропорциями 0,6х0,6х0,6 могут быть помещены в кузов объемом 1х1х1.

{% endnote %}

**Пример 1**

В этом примере автомобиль размером грузового отсека 1х1х1 метров доставляет заказ с размерами 2х0.5х0.5 метров. Поскольку по умолчанию габариты не учитываются, он помещается в автомобиль.

[Пример Excel](https://courier-admin.s3.yandex.net/doc-examples/mvrp-example-volume.xlsx) ⋅ [Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/6a7054f6-6844a540-ce2d4207-4285a925) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/6a7054f6-6844a540-ce2d4207-4285a925) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#6a7054f6-6844a540-ce2d4207-4285a925)


**Пример 2**

В этом примере используются те же данные что и в примере 1, но заказ считается жестким и не помещается в автомобиль. В результате он не доставлен.

[Пример Excel](https://courier-admin.s3.yandex.net/doc-examples/mvrp-example-volume2.xlsx) ⋅ [Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/a75cc5d3-b120a5b8-7a99b331-15759186) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/a75cc5d3-b120a5b8-7a99b331-15759186) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#a75cc5d3-b120a5b8-7a99b331-15759186)




## Ориентация заказа в автомобиле

По умолчанию, заказы для которых в поле `location.shipment_size.volume.type` указано `rigid` или `fixed_bottom` должны размещаться строго паралельно оси автомобиля.  Но в некоторых случаях, такие заказы могут поместиться в тот же автомобиль под углом. Для поддержки такого сценария используется поле `location.shipment_size.volume.align` с возможными значениями `all_axes` и `height`. Возможные ориентации заказа зависят от значения, указанного в поле `location.shipment_size.volume.type` и перечислены ниже:

**Возможные сочетания type и align**

`align` \ `type` | `rigid` | `fixed_bottom`
:---| :---| :---
`all_axes` | Заказ может быть повернут на 90 градусов по любой оси, но всегда ставится строго параллельно осям кузова. | Заказ может быть повернут на 90 градусов, но его дно (сторона, определенная как ширина х  глубина) остается неизменным, то есть находится на дне кузова автомобиля.
`height` | Заказ может быть повернут как угодно, при условии что одна любая сторона остается на дне кузова автомобиля, то есть высота должна быть паралельной высоте грузового отсека. | Заказ может быть повернут как угодно, при условии что его дно (сторона, определенная как ширина х  глубина) остается неизменным, то есть находится на дне кузова автомобиля.

## Сервисное время при доставке заказов

При планировании маршрутов возможно указать сервисное время (время обслуживания) для каждого заказа.

Сервис поддерживает два вида сервисного времени:

- `service_duration_s` — время на вручения заказа получателю.
- `shared_service_duration_s` — время на обмен документами или парковку.

По умолчанию [сервисное время заказа](https://yandex.ru/routing/doc/vrp/concepts/properties-of-orders.html#servisnoe-vremia-pri-dostavke-zakazov) не обязательно должно попадать во временное окно заказа (то есть допустима ситуация, когда водитель приезжает на точку в 17:59, хотя окно заказа до 18:00). Чтобы избежать возникновения таких ситуаций, используйте опцию [options.penalize_late_service](#shtraf-za-obsluzhivanie-vne-vremennogo-okna)

{% note %}

Обратите внимание, что в случае если на адрес доставляется несколько заказов одновременно, время на парковку будет учтено только один раз для первого заказа. Дополнительная информация доступна в разделе [Мультизаказы](properties-of-orders.md#multizakazy).

{% endnote %}

**Пример**
[Пример Excel](https://courier-admin.s3.yandex.net/doc-examples/mvrp-example-order-sd.xlsx) ⋅ [Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/e52ab293-f58d360b-4e8a3210-50685d37) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/e52ab293-f58d360b-4e8a3210-50685d37) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#e52ab293-f58d360b-4e8a3210-50685d37)


## Сервисное время на загрузку заказа на складе

В дополнение к общему сервисному времени на складе в Маршрутизаторе можно указать время загрузки отдельного заказа в автомобиль на складе.
Для определения времени на загрузку заказа испольщуется поле запроса `location.depot_duration_s`.

Если для склада задано общее сервисное время, оно будет прибавлено к общему времени загрузки заказов в каждый автомобиль. Дополнительная информация доступна в разделе [Сервисное время на складе](properties-of-depot.md).

**Пример 1**

В примере определено сервисное время на складе для каждого заказа.

{% note %}

Обратите внимание, что время прибытия на первый заказ соответствует времени проведенному автомобилем или курьером на складе + время на поездку до первого заказа.

{% endnote %}

[Пример Excel](https://courier-admin.s3.yandex.net/doc-examples/mvrp-example-order-sd1.xlsx) ⋅ [Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/eb51f402-656c73c5-cd8a4811-43e17544) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/eb51f402-656c73c5-cd8a4811-43e17544) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#eb51f402-656c73c5-cd8a4811-43e17544)

**Пример 2**

В примере определено сервисное время на складе для каждого заказа как 5 минут и общее сервисное время на складе - как 10 минут - итого машина проведет на загрузке 25 минут.

[Пример Excel](https://courier-admin.s3.yandex.net/doc-examples/mvrp-example-order-sd2.xlsx) ⋅ [Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/3d233d80-68338168-c65bd61f-7d6e5548) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/3d233d80-68338168-c65bd61f-7d6e5548) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#3d233d80-68338168-c65bd61f-7d6e5548)


## Время готовности заказа на складе

По умолчанию при планировании доставки заказов со склада предполагается, что они доступны к отгрузке. Но это не всегда так (например, если заказы готовятся в течение дня). В таких случаях нужно учитывать время готовности заказа. Нередко курьеры совершают несколько рейсов со склада, забирая заказы по мере их доступности (для этой схемы нужно задавать возможность [выполнения курьером нескольких рейсов](https://yandex.ru/routing/doc/vrp/concepts/properties-of-vehicles.html#neskolko-reisov-avtomobilia-v-den)).

Время готовности заказа определяется в поле `depot_ready_time`. Его можно использовать только для заказов с типом `delivery` без связанных `pickup` заказов (т.&nbsp;е. только для доставок со склада).

Дата и время в `depot_ready_time` задаются в таком же формате, как и при определении [временных окон](https://yandex.ru/routing/doc/vrp/concepts/properties-of-time-window.html). Примеры значений:

- `10:15`
- `2020-09-06T13:15:00+03:00`
- `2020-09-06T10:15:00Z`

**Пример**

В примере ниже выполняется доставка 35 заказов, каждый со своим временем готовности (9:00, 10:00, 12:00 или 14:00). В результате рейсы в маршрутах курьеров построены с учетом `depot_ready_time` каждого заказа.

[Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/c9bbb106-3377b774-969d640d-e774db63) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/c9bbb106-3377b774-969d640d-e774db63) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#c9bbb106-3377b774-969d640d-e774db63)

## Прием и доставка

В общем случае, заказы загружаются в автомобиль на складе, и доставляются по адресам получателей.

В случае, если по адресу клиента необходимо осуществить прием заказа, и его дальнейшую доставку на другой адрес (Pickup and Delivery), необходимо определить тип заказа.

Для определения типа заказа используется поле `location.type` со значениями:

- `pickup` — прием заказа по адресу.
- `delivery` — доставка заказ по адресу (по умолчанию).

При определении типа `pickup`, действуют следующие правила:

- если **определено** поле `location.delivery_to`, которое содержит значение `id` другого заказа, то доставка будет выполнена на адрес этого заказа;
- если определено поле `delivery_deadline`, доставка будет выполнена на складк указанному времени. При этом значение `location.delivery_to` указывать не нужно. Подробнее про определение времени доставки заказа на склад описано в разделе [Время доставки заказа на склад](properties-of-orders.md#vremia-dostavki-zakaza-na-sklad).
- если поле `location.delivery_to` **не определено** и транспортного средства, выполняющего заказ выставлено значение `vehicle.return_to_depot` = `true`, доставка будет выполнена на склад в конце маршрута.
- если поле `location.delivery_to` **не определено** и транспортного средства, выполняющего заказ выставлено значение `vehicle.return_to_depot` = `false`, доставка не будет выполнена. Этот сценарий можно использовать, чтобы курьер оставил заказ в автомобиле в конце рабочего дня и выполнил доставку на следующий.

{% note warning "Внимание." %}

 Если заказы типа `pickup` должны всегда возвращаться на склад, и в планировании используются машины, у которых `vehicle.return_to_depot` = `false` и `vehicle.return_to_depot` = `true`, то нужно явно заполнить поле `location.delivery_to`. Иначе заказ может остаться в машине курьера.

{% endnote %}

Также Маршрутизация поддерживает смешанные прием и доставку, когда в запросе  присутствуют как обычные заказы на доставку, так и прием/доставка.

{% note %}

Обратите внимание, что последовательность расположения заказов на сбор и доставку в маршруте определяются только грузоподъемностью автомобиля, и временными окнами заказов.

Между сбором заказа и его доставкой по другому адресу могут быть другие заказы, если это позволяет грузоподъемность автомобиля и такой маршрут окажется более выгодным.

Маршрутизация не поддерживает доставку сразу после сбора, игнорируя другие заказы.

{% endnote %}

{% note %}

Обратите внимание, что в случае наличия нескольких заказов на прием груза (`pickup`) по одному адресу, в редких случаях прием может быть выполнен более чем одним автомобилем или курьером.

Такое разделение может быть оправдано с точки зрения уменьшения общей стоимости доставки.

{% endnote %}

## Время доставки заказа на склад

В некоторых случаях pickup-заказы нужно собрать на складе к определенному времени. Например это актуально для курьерских и логистических компаний, когда этот заказ нужно отправить дальше на другом транспорте (например, отвезти в аэропорт или отправить автомобилем в другой город) - то есть для обеспечения определенных общих сроков доставки может быть необходимо собрать все заказы до определенного времени, иначе их придется отправить уже на следующий день.

Чтобы определить время доставки pickup заказа на склад, используйте опцию `delivery_deadline`. Опция устанавливает мягкие ограничения, т.е. за ее нарушение начисляется штраф `penalty.delivery_deadline.fixed` или `penalty.delivery_deadline.fixed`.
Опция меняет поведение только для заказов с типом `pickup`. Работа с такими заказами описана подробнее в разделе [Прием и доставка](properties-of-orders.md#priem-i-dostavka).

{% note warning "Внимание." %}

По умолчанию курьер выполняет только один рейс в день, и возврат на склад для доставки товара заканчивает рейс. Чтобы один курьер мог возвращаться на склад и продолжать доставку, укажите опцию `max_runs` со значением больше 1. Подробнее про настройку количества рейсов описано в разделе [Несколько рейсов автомобиля в день](properties-of-orders.md#neskolko-reisov-avtomobilia-v-den).
{% endnote %}

**Пример**

В примере ниже один курьер выполняет доставку всех заказов, и возвращается на склад в середине дня чтобы вернуть заказ до указанного `delivery_deadline`.

[Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/1df00498-fd81e842-37d634ca-a05c1c45) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/1df00498-fd81e842-37d634ca-a05c1c45) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#1df00498-fd81e842-37d634ca-a05c1c45)

## Мультизаказы

При планировании маршрутов могут возникать случаи, когда несколько заказов должны быть доставлены по одному адресу, например при доставке нескольких заказов в один многоквартирный дом или в бизнес-центр.

Если заказы имеют пересекающиеся временные окна и расположены по одному адресу, Маршрутизация будет объединять такие заказы, чтобы они были выполнены одним автомобилем как один большой заказ, или несколько мультизаказов в зависимости от выгодности.

{% note %}

Если вы хотите чтобы все заказы, расположенные по одному адресу, были гарантированно объединены в один мультизаказ - воспользуйтесь опцией `options.merge_multiorders = true`.

Включение опции объединения мультизаказов гарантирует, что мультизаказ появится только в одном маршруте, при условии что это позволяет вместимость автомобиля или курьера.

{% endnote %}

При объединении заказов время на вручение документов или паркинг учитывается один раз для группы заказов, если они обслуживаются как мультизаказ.

Каждый заказ позволяет определить сервисное время в виде двух величин:

- `location.shared_service_duration_s`, время на вручение документов или паркинг.
- `location.service_duration_s`, время на вручения заказа.

Для обычных заказов, которые находятся по разным адресам, сервисное время учитывается в маршруте следующим образом:

<img src="https://courier.yandex.ru/vrs-doc/multiorders-11.png" class="text--img" width="620px" />

При объединении заказов в мультизаказ сервисное время на паркинг будет учтено только  один раз:

<img src="https://courier.yandex.ru/vrs-doc/multiorders-21.png" class="text--img" width="620px" />

**Пример**

В примере определены 3 заказа с различным временем вручения, а также активирована опция объединения мультизаказов.

[Пример Excel](https://courier-admin.s3.yandex.net/doc-examples/example-multiorders.xlsx) ⋅ [Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/7b105ca6-bc024f63-ef6577ea-9e3c03df) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/7b105ca6-bc024f63-ef6577ea-9e3c03df) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#7b105ca6-bc024f63-ef6577ea-9e3c03df)


## Доставка в одну из возможных точек

Иногда необходимо доставить заказ по любому из нескольких адресов. Например, когда заказ нужно отвезти в произвольный терминал сторонней логистической компании и включить в маршрут более предпочтительный адрес доставки.

В этой ситуации используется заказ типа `pickup` ([прием](https://yandex.ru/routing/doc/vrp/concepts/properties-of-orders.html#priem-i-dostavka)). В его поле `delivery_to_any` через запятую перечисляются идентификаторы заказов с типом `drop_off`, в любой из которых можно отвезти груз. Они могут повторяться для разных `pickup` заказов. Вес и объем для `drop_off` заказов можно не задавать.

{% note info %}

Значение `delivery_to_any` можно указать только для `pickup` заказов.

Для `drop_off` заказов можно указать [сервисное время](https://yandex.ru/routing/doc/vrp/concepts/properties-of-orders.html#servisnoe-vremia-pri-dostavke-zakazov). Если для `pickup` заказа нужно указать специфичное время отгрузки в `drop_off`, это делается с помощью поля `depot_duration_s` заказа `pickup`.

В результате оптимизации маршрута несколько заказов `pickup` могут быть доставлены в один `drop_off`.

{% endnote %}

**Пример**

В примере ниже 2 `pickup` заказа и 2 `drop_off` заказа. Для каждого `pickup` в поле `delivery_to_any` перечислены оба `drop_off` заказа.

Обратите внимание, что сервисное время `drop_off` заказов составляет 3&nbsp;минуты. При этом на одном из `pickup` заказов значение `depot_duration_s` равно 30&nbsp;минут. Итоговое время выгрузки в `drop_off` составляет 33&nbsp;минуты.

[Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/e0141f22-7de9e83c-88471bd3-9096ff48) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/e0141f22-7de9e83c-88471bd3-9096ff48) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#e0141f22-7de9e83c-88471bd3-9096ff48)


## Штрафы за нарушение временных окон заказов
Данный штраф добавляется к общей стоимости маршрута, если заказ удается запланировать к доставке, но доставка происходит раньше или позже указанного временного окна.

{% note %}

Такое поведение возможно только в случае определения "*мягкого*" временного окна. Если нарушается "*жесткое*" окно, то заказ автоматически помечается как недоставленный и исключается из всех маршрутов.

{% endnote %}

Штраф за несвоевременную доставку позволяет повысить вероятность, что наиболее важные заказы будут доставлены без опозданий в ущерб менее важным.

Для управления своевременностью доставки заказов в Маршрутизаторе могут использоваться следующие объекты:

- `location.penalty.early` — устанавливает штраф за доставку раньше временного окна;
- `location.penalty.late` — устанавливает штраф за доставку позже временного окна;
- `location.penalty.out_of_time` — устанавливает единые штрафы за доставку как раньше, так и позже временного окна.

Если `location.penalty.early` и `location.penalty.late` не заданы, то используются значения из `location.penalty.out_of_time` (то есть `early` и `late` работают как переопределение `out_of_time`).

Каждый объект состоит из двух полей:

- `fixed` — фиксированный штраф за факт несвоевременной доставки;
- `minute` — штраф за каждую минуту несвоевременной доставки.

Если в `location.penalty.early` или `location.penalty.late` задано только одно значение (`fixed` или `minute`), то второе берется из `location.penalty.out_of_time`. Например, может быть задано только `location.penalty.late.fixed`. Тогда при опоздании на заказ в качестве штрафа за каждую минуту будет использоваться `location.penalty.out_of_time.minute`.

{% note %}

Вышеперечисленные поля имеют значения по умолчанию, которые рекомендуется использовать в качестве стартовых значений при определении пользовательских приоритетов доставки заказов.

При сомнениях, свяжитесь с аналитиками Яндекс.Маршрутизации для определения корректных коэффициентов.

{% endnote %}

Пример ниже содержит запрос с разными штрафами за раннюю и позднюю доставку заказов:

[Скачать пример задачи в формате Excel](https://courier-admin.s3.yandex.net/doc-examples/mvrp-example-late-early-delivery.xlsx)

## Штрафы за невыполнение заказа
Для каждого заказа в запросе к Маршрутизатору можно определить штраф за невыполнение заказа. При недостатке автомобилей или курьеров отдельные заказы могут быть исключены из всех маршрутов.

Например, если выполнение заказа, находящегося на большом расстоянии от остальных, приведет к опозданию на остальные заказы в несколько часов, такой заказ может быть исключен из маршрутов как невыполненный.

{% note %}

В ответе Маршрутизатора невыполненные заказы будут помещены в отдельное поле `dropped_locations`.

{% endnote %}

Данный штраф добавляется к общей стоимости маршрута, если заказ не удается запланировать ни на один из заданных автомобилей.

Существует множество причин почему заказ не удалось включить в один из маршрутов, например:

-	вес заказа превышает грузоподъемность любого из заданных автомобилей;
-	суммарный вес заказов превышает общую грузоподъемность автомобилей, так что заказы нельзя развести даже с учетом дополнительных рейсов. Поэтому в любом случае остаются нераспределенные заказы;
-	данный заказ несовместим ни с одним из заданных автомобилей, или грузоподъемность совместимых с определенным набором заказов автомобилей слишком мала, чтобы вместить их все;
-	невозможно доставить заказ в заявленное жесткое временное окно;
-	невозможно развезти заказы с учетом жесткого ограничения на смены водителей;
-	задано жесткое узкое окно склада и параметры возврата на склад у автомобилей – в результате система планирует возврат на склад, при этом не успевая развести заказы
-	неверные координаты заказа, из-за которых он оказывается в географическом удалении от остальных заказов, и система не находит возможности выполнить этот заказ;
-	планирование сложной задачи на режиме low;
-	и другие.


В общем случае, если у одного заказа задан штраф в 50 единиц, а у другого в 5 единиц, заказ со штрафом в 50 единиц будет считаться более важным и с более высокой вероятностью попадет в спланированные маршруты.

Для определения штрафа за недоставку заказа в Маршрутизаторе используется поле `location.penalty.drop`

{% note %}

Обратите внимание на размерность значения по умолчанию для данного поля (по умолчанию 1000000). Для управления приоритетами рекомендуется использовать значение аналогичного или более высокого порядка.

В случае сомнения, свяжитесь с аналитиками Яндекс.Маршрутизации для определения корректных коэффициентов.

{% endnote %}





## Совместимость заказа и автомобилей

При определении заказа в запросе к Маршрутизатору возможно назначить ему список характеристик автомобиля, который должен выполнить данный заказ.

Для определения тегов заказа (требуемых характеристик автомобилей) используется поле `location.required_tags`.

Заказ считается совместимым с автомобилем, если выполняется любое из правил совместимости автомобиля и заказа. Правила совместимости задаются при определении автомобилей.

Подробнее о правилах совместимости смотрите в разделе [Теги автомобиля](properties-of-vehicles.md#tegi-avtomobilia).



## Несовместимость заказов

Если вам необходимо перевозить типы заказов, которые не могут находиться в машине одновременно, Маршрутизатор позволяет определить один или более несовместимых типов. В Маршрутизаторе нет предопределенных типов заказов.

В качестве несовместимых типов могут использоваться:

-	Несовместимые грузы, которые по объективным причинам не могут перевозиться в одной машине в рамках одного рейса.
-	Несовместимость различных грузополучателей между собой. Например: разделение товаров конкурентов по разным машинам, разделение по определенным типам клиентов.
-	Несовместимость географических зон заказов (например, необходимо, чтобы какое-то направление\зона планировалась всегда отдельно, независимо от эффективности).

Для определения типа используется поле location.load_types. При необходимости вы можете указать более одного типа для каждого заказа. Для определения несовместимых заказов используется поле `incompatible_load_types`. В этом поле вы можете указать список несовместимых типов – при планировании заказы разделяются по разным машинам, если в них есть по крайней мере один несовместимый тип.

{% note %}

Несовместимость заказов является жестким ограничением, то есть она не может быть нарушена при автоматической маршрутизации. Например, если в одну точку заданы несколько заказов и при этом они являются несовместимыми - алгоритм спланирует их в разные машины. Использование типов несовместимости заказов может привести к получению неоптимальных маршрутов. Поэтому стоит вводить только действительно значимые ограничения, которые и на практике являются обязательными правилами.

{% endnote %}


**Пример 1**

При перевозке бытовой химии, продуктов питания, и цветов одним парком автомобилей в поле `location.load_types` необходимо указать типы груза `chemicals`, `food`, `flowers` для соответствующих заказов.

Для того чтобы товары бытовой химии никогда не оказались в одной машине с продуктами питания или цветами, но при этом цветы и продукты питания можно перевозить вместе задайте следующие правила несовместимости:

| type       | incompatible_load_types |
|------------|-------------------------|
| chemicals  | food, flowers           |

В данном примере мы задали 3 заказа и каждому их них присвоили один из 3 этих типов. Алгоритм в итоге спланировал 2 маршрута.

[Пример Excel](https://courier-admin.s3.yandex.net/doc-examples/example-load_types.xlsx) ⋅ [Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/5ae98af-d12eb2ef-e0f00f9f-983a9f8c) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/5ae98af-d12eb2ef-e0f00f9f-983a9f8c) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#5ae98af-d12eb2ef-e0f00f9f-983a9f8c)

**Пример 2**

В данном примере указаны 4 заказа, задана несовместимость по грузам и дополнительно указана несовместимость по географическим зонам.

В итоге все заказы несовместимы между собой и алгоритм планирует 4 маршрута несмотря на то, что 2 заказа отправляются в одну точку.

[Пример Excel](https://courier-admin.s3.yandex.net/doc-examples/example-load_types2.xlsx) ⋅ [Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/e80d90d7-a97d2bb7-cf91abd7-c1059764) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/e80d90d7-a97d2bb7-cf91abd7-c1059764) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#e80d90d7-a97d2bb7-cf91abd7-c1059764)

<p class="p"><a href="feedback.html" class="xref button">Написать в службу поддержки</a></p>
