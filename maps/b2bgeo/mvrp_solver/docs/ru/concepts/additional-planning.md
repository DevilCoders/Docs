# Допланирование маршрута

Нередко возникает задача спланировать маршрут, когда часть заказов уже распределена по автомобилям и это распределение необходимо сохранить. Такое может произойти, например, когда требуется сформировать для склада задание на комплектацию, но часть заказов в этот момент еще не известна. Или когда курьеры уже выехали на маршрут, и в процессе их движения поступают заказы типа `pickup`, которые кто-то из курьеров должен будет забрать. В общем случае задача допланирования возникает, когда нет возможности решить задачу маршрутизации полностью в одну итерацию, и ее приходится выполнять по частям, с передачей результатов предыдущей итерации в следующее планирование.

Принципиально ситуации допланирования разделяются на две:

1. Часть заказов уже распределена по маршрутам, и есть нераспределенные заказы на доставку, **но автомобили еще не выехали со склада**.
1. Появились дополнительные заказы (например, заказы типа `pickup`), **но автомобили уже выехали со склада**.

При этом в обоих случаях надо сохранить закрепление уже спланированных заказов и дополнительно распределить новые («незакрепленные») заказы по автомобилям со свободным временем/местом.

## Как это работает

В каждой из ситуаций важно знать, нужно ли фиксировать порядок уже распределенных заказов. Если порядок следует сохранить, то используется свойство `vehicles.visited_locations`, иначе – свойство `vehicles.planned_route`.

### В случае 1 (автомобили еще не выехали)

Чтобы сформировать запрос, необходимо знать:

- уже распределенные заказы для каждого автомобиля;
- новые заказы, поступившие с момента прошлого планирования.

В новом запросе на допланирование для каждого автомобиля в поле `planned_route` (`visited_locations`) указываем идентификаторы (`locations` или `id`) уже распределенных заказов (из предыдущей итерации планирования).

### В случае 2 (автомобили уже выехали)

Чтобы сформировать запрос, необходимо знать:

- уже распределенные заказы для каждого автомобиля;
- местонахождение каждого автомобиля на момент допланирования (это также может быть последний доставленный или следующий по очередности заказ);
- список уже выполненных заказов;
- новые заказы, поступившие с момента прошлого планирования.

В новом запросе на допланирование:

1. Для каждого автомобиля в поле `planned_route` (`visited_locations`) указываем идентификаторы (`locations` или `id`) уже распределенных заказов (из предыдущей итерации планирования), но **не выполненных на момент допланирования**.
1. В список заказов добавляем «фиктивные» заказы, соответствующие точкам текущего местонахождения для каждого автомобиля. Это можно не делать, если точка текущего местонахождения - последний доставленный или следующий по очередности заказ.
1. Для каждого автомобиля в поле `visited_locations` первым элементом указываем идентификатор точки текущего местонахождения и время старта из нее.

  {% note %}
  Для не использованных ранее автомобилей нужно задать корректные параметры выезда: либо сдвинуть время начала смены, либо указать текущее местонахождение на складе в `visited_locations`.
  {% endnote %}

1. Из списка заказов удаляем уже выполненные заказы (с учетом п. 2: если в качестве точки текущего местонахождения используется последний доставленный заказ, то его удалять не нужно).

### Общие особенности

Начальное распределение, после которого требуется выполнить допланирование, необходимо сформировать таким образом, чтобы у автомобилей осталось свободное время/место (иначе дополнительные заказы не поместятся). Для этого можно использовать уменьшенное время смены автомобиля, опцию балансировки `balanced_groups`, ограничения по загрузке (указывать у автомобилей меньшую вместимость).

{% note %}

Все дополнительные ограничения, введенные на первой итерации с целью искусственно загрузить автомобили не полностью, **при допланировании** необходимо снять.

{% endnote %}

Чтобы запретить добавлять заказы в какие-то избранные автомобили, можно воспользоваться функциональностью тегов. Подробнее об этом см. в разделе [Теги автомобиля](https://courier.yandex.ru/vrs-doc#business/section/Svojstva-avtomobilej/Tegi-avtomobilya).

## Базовая задача

В задаче 70 заказов и 9 доступных курьеров, используется опция балансировки `balanced_groups`.

Получаем 5 курьеров в решении.

Результат планирования:

| Курьер   | Количество заказов | Последовательность заказов                                      |
|----------|--------------------|-----------------------------------------------------------------|
| Курьер 1 | 14                 | 45, 31, 58, 24, 52, 54, 39, 47, 19, 30, 43, 28, 29, 49          |
| Курьер 3 | 17                 | 18, 37, 38, 17, 2, 59, 34, 35, 26, 32, 20, 69, 5, 50, 15, 21, 6 |
| Курьер 4 | 14                 | 44, 16, 53, 70, 27, 64, 65, 40, 60, 4, 63, 33, 56, 48           |
| Курьер 6 | 11                 | 46, 11, 1, 10, 8, 41, 14, 12, 13, 22, 9                         |
| Курьер 7 | 14                 | 3, 23, 51, 55, 42, 36, 68, 66, 61, 25, 7, 67, 57, 62            |

[Пример Excel](https://courier-admin.s3.yandex.net/doc-examples/mvrp-example-planned_route_base.xlsx) ⋅ [Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/ee6652-335b23cc-29bb8b3c-eadc2731) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/ee6652-335b23cc-29bb8b3c-eadc2731) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#ee6652-335b23cc-29bb8b3c-eadc2731)

Далее рассмотрим различные способы допланирования относительно базовой задачи.

### Пример 1

Допланирование на складе **с изменением** порядка заказов в маршрутах.

В запросе задаем 110 заказов (из них 40 новых относительно базовой задачи) и 9 доступных курьеров. У 5 курьеров указываем распределение из базовой задачи в `planned_route`. Также используем опцию балансировки `balanced_groups`.

Получаем 7 курьеров в решении.

Результат планирования:

| Курьер   | Количество заказов | Последовательность заказов относительно базовой задачи                                                                                  |
|----------|--------------------|-----------------------------------------------------------------------------------------------------------------------------------------|
| Курьер 1 | 16                 | Добавилось 2 заказа:<br/>45, 31, 58, 24, 52, **87**, 54, 39, **100**, 47, 19, 30, 43, 28, 29, 49                                        |
| Курьер 2 | 14                 | Новый маршрут                                                                                                                           |
| Курьер 3 | 18                 | Добавился 1 заказ:<br/>18, 37, 38, 17, 2, 59, 34, 35, 26, 32, 20, 69, **104**, 5, 50, 15, 21, 6                                         |
| Курьер 4 | 19                 | Добавилось 5 заказов, сильно изменена последовательность:<br/>_27_, _64_, _65_, _40_, **99**, _60_, _4_, _53_, _70_, 44, 16, **102**, 63, 33, **85**, 56, **88**, 48, **84** |
| Курьер 6 | 14                 | Добавилось 3 заказа, изменена последовательность:<br/>46, **80**, 11, **71**, _12_, 10, 8, _1_, **83**, _14_, _41_, 13, 22, 9           |
| Курьер 7 | 16                 | Добавилось 2 заказа, немного изменена последовательность:<br/>3, 23, **79**, 51, _42_, _55_, 36, 68, 66, 61, 25, 7, 67, **108**, 57, 62 |
| Курьер 8 | 13                 | Новый маршрут                                                                                                                           |

{% note %}

Заказы, спланированные в базовой задаче, остались закрепленными за теми же курьерами, но при этом:

- у курьеров из базового решения новые заказы добавились **среди других точек маршрута**;
- у курьеров из базового решения изменилась ранее спланированная последовательность заказов;
- добавилось 2 новых маршрута.

{% endnote %}

[Пример Excel](https://courier-admin.s3.yandex.net/doc-examples/mvrp-example-planned_route1.xlsx) ⋅ [Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/cf7e6770-555a439e-57105d49-2dc93e73) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/cf7e6770-555a439e-57105d49-2dc93e73) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#cf7e6770-555a439e-57105d49-2dc93e73)

### Пример 2

Допланирование на складе **без изменения** порядка заказов в маршрутах.

В запросе задаем 110 заказов (из них 40 новых относительно базовой задачи) и 9 доступных курьеров. У 5 курьеров указываем распределение из базовой задачи в `visited_locations`. Также используем опцию балансировки `balanced_groups`.

Получаем 7 курьеров в решении.

Результат планирования:

| Курьер   | Количество заказов | Последовательность заказов относительно базовой задачи                                             |
|----------|--------------------|----------------------------------------------------------------------------------------------------|
| Курьер 1 | 17                 | Добавилось 3 заказа:<br/>45, 31, 58, 24, 52, 54, 39, 47, 19, 30, 43, 28, 29, 49, **106, 93, 101**  |
| Курьер 3 | 17                 | Маршрут без изменений:<br/>18, 37, 38, 17, 2, 59, 34, 35, 26, 32, 20, 69, 5, 50, 15, 21, 6         |
| Курьер 4 | 18                 | Добавилось 4 заказа:<br/>44, 16, 53, 70, 27, 64, 65, 40, 60, 4, 63, 33, 56, 48, **84, 96, 85, 88** |
| Курьер 6 | 14                 | Добавилось 3 заказа:<br/>46, 11, 1, 10, 8, 41, 14, 12, 13, 22, 9, **80, 71, 79**                   |
| Курьер 7 | 15                 | Добавился 1 заказ:<br/>3, 23, 51, 55, 42, 36, 68, 66, 61, 25, 7, 67, 57, 62, **108**               |
| Курьер 8 | 15                 | Новый маршрут                                                                                      |
| Курьер 9 | 14                 | Новый маршрут                                                                                      |

{% note %}

Заказы, спланированные в базовой задаче, остались закрепленными за теми же курьерами, но при этом:

- у курьеров из базового решения новые заказы добавились **в конец маршрута**;
- добавилось 2 новых маршрута.

{% endnote %}

[Пример Excel](https://courier-admin.s3.yandex.net/doc-examples/mvrp-example-visited_locations.xlsx) ⋅ [Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/c7e01f43-b49d7ac8-7526c777-c43b1545) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/c7e01f43-b49d7ac8-7526c777-c43b1545) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#c7e01f43-b49d7ac8-7526c777-c43b1545)

### Пример 3

Допланирование, когда автомобили/курьеры уже выехали со склада (**без изменения** порядка заказов в маршрутах).

На момент планирования считаем, что доставлено 15 заказов (по 3 заказа на каждого из 5 курьеров из базовой задачи), и удаляем их из задачи допланирования.

Итого в запросе задаем 100 заказов (из них 40 новых заказов, 55 еще не доставленных заказов из базовой задачи, 5 точек старта курьеров) и 9 доступных курьеров. У 5 курьеров указываем распределение из базовой задачи в `visited_locations`. Также используем опцию балансировки `balanced_groups`.

Получаем 8 курьеров в решении (из них 3 новых курьера, которые стартуют со склада).

Результат планирования:

| Курьер   | Количество заказов\* | Последовательность заказов относительно базовой задачи                                                                                 |
|----------|----------------------|----------------------------------------------------------------------------------------------------------------------------------------|
| Курьер 1 | 12                   | Добавлен 1 заказ:<br/>_45, 31, 58 (выполненные заказы),_ 1001 (точка старта), 24, 52, 54, 39, 47, 19, 30, 43, 28, 29, 49, **101**      |
| Курьер 2 | 10                   | Новый маршрут                                                                                                                          |
| Курьер 3 | 14                   | Маршрут без изменений:<br/>_18, 37, 38 (выполненные заказы),_ 1003 (точка старта), 17, 2, 59, 34, 35, 26, 32, 20, 69, 5, 50, 15, 21, 6 |
| Курьер 4 | 13                   | Добавлено 2 заказа:<br/>_44, 16, 53 (выполненные заказы),_ 1004 (точка старта), 70, 27, 64, 65, 40, 60, 4, 63, 33, 56, 48, **84, 88**  |
| Курьер 6 | 11                   | Добавлено 3 заказа:<br/>_46, 11, 1 (выполненные заказы),_ 1006 (точка старта), 10, 8, 41, 14, 12, 13, 22, 9, **80, 71, 79**            |
| Курьер 7 | 12                   | Добавлен 1 заказ:<br/>_3, 23, 51 (выполненные заказы),_ 1007 (точка старта), 55, 42, 36, 68, 66, 61, 25, 7, 67, 57, 62, **108**        |
| Курьер 8 | 11                   | Новый маршрут                                                                                                                          |
| Курьер 9 | 12                   | Новый маршрут                                                                                                                          |

\* – не считая выполненных и точку старта.

{% note %}

В данном решении все курьеры стартуют с 11:00, а новые заказы добавляются в конец маршрута.

{% endnote %}

[Пример Excel](https://courier-admin.s3.yandex.net/doc-examples/mvrp-example-visited_locations2.xlsx) ⋅ [Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/6435873e-cf57c514-36bd86b9-c4e6f300) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/6435873e-cf57c514-36bd86b9-c4e6f300) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#6435873e-cf57c514-36bd86b9-c4e6f300)


<p class="p"><a href="feedback.html" class="xref button">Написать в службу поддержки</a></p>
