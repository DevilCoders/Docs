# Минимизация риска опозданий

При решении задачи маршрутизации одним из приоритетов является получение маршрутов, обеспечивающих качественный сервис для конечного клиента — гарантированное прибытие курьера в заявленный временной интервал. Это особенно актуально для клиентов с большим количеством заказов и узкими временными окнами — как правило, с такой задачей сталкиваются интернет-магазины, службы доставки или поставщики розничных сетей).

Яндекс Маршрутизация позволяет строить маршруты с жестким попаданием во временное окно заказа (см. раздел [Временное окно заказа](properties-of-orders.md)). Тем не менее, нередко возникает потребность получать более пессимистичные маршруты, при фактическом выполнении которых у курьера есть дополнительный запас времени на случай неплановых задержек на предыдущем заказе, неожиданных пробок, и прочих непредвиденных ситуаций.

Для получения таких маршрутов используйте опцию `options.minimize_lateness_risk` = `true`.


### Как это работает

При построении маршрутов Яндекс Маршрутизация использует прогноз по времени движения между точками дорожного графа (подробнее в статье [Сколько бизнес теряет на пробках и что с этим делать](https://yandex.ru/routing/articles/02-traffic-jams)). При этом учитывается не только прогноз, но и вероятное отклонение от прогнозного значения. Параметр `minimize_lateness_risk` отвечает за учет вероятного отклонения в получаемом решении.

Например, у заказа окно с 8:00 до 9:00, курьер отравляется с предыдущей точки в 7:30 и математическое ожидание длительности его поездки составляет 81 минуту (условно, с вероятностью 0,4 он приедет за 75 минут, с вероятностью 0,4 – за 80 минут, с вероятностью 0,1 – за 90 минут и с вероятностью 0,1 – за 100 минут), то есть система спланирует его прибытие в 8:51.

Однако, у данной поездки есть вероятность 0,1 что курьер опоздает на 10 минут, то есть прибудет в 9:10.

Если вероятное отклонение оказывается за границей временного окна, то оно учитывается в конечном решении в качестве вероятного штрафа за опоздание на данный заказ и для расчета данного штрафа соответственно используются значения `locations.penalty.out_of_time.fixed` и `locations.penalty.out_of_time.minute`.

Дополнительная информация доступна в разделе [Штрафы за опоздание на заказ](properties-of-orders.md).

Если параметр `minimize_lateness_risk` указан, то эти параметры учитываются даже когда временное окно заказа жесткое и опция `location.hard_window` = `true`.

{% note %}

Использование опции `minimize_lateness_risk` как правило ухудшает остальные метрики решения. У улучшения клиентского сервиса всегда есть обратная сторона - необходимо использовать больше ресурсов или маршруты становятся менее оптимальными по пробегу или общему времени, поэтому эту опцию рекомендуется использовать только при соответствующих требованиях.

{% endnote %}

На примерах ниже продемонстрировано, как меняется решение при использовании данной опции:

**Пример 1**

Есть 3 заказа с достаточно узкими и жесткими окнами. Опция `minimize_lateness_risk` = `false`. Алгоритм планирует 1 маршрут с прибытием в точку 3 в 10:59, при окне до 11:00.

[Пример Excel](https://courier-admin.s3.yandex.net/doc-examples/mvrp-example-miinmize_lateness1.xlsx) ⋅ [Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/71b6824b-3c81522b-ad22756c-3cebfe0b) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/71b6824b-3c81522b-ad22756c-3cebfe0b) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#71b6824b-3c81522b-ad22756c-3cebfe0b)

**Пример 2**

Пример №1, но с опцией `minimize_lateness_risk` = `true`.

Алгоритм планирует также 1 маршрут, но последовательность объезда точек 2 и 3 становится другой. Маршрут стал менее оптимальным по пробегу и времени движения относительно примера №1, но теперь у курьера появился дополнительный запас времени до окончания временного окна заказа — маршрут стал менее рискованным с точки зрения возможного опоздания к клиенту.

[Пример Excel](https://courier-admin.s3.yandex.net/doc-examples/mvrp-example-miinmize_lateness2.xlsx) ⋅ [Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/add34c08-56c46c8f-624cce2c-35749300) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/add34c08-56c46c8f-624cce2c-35749300) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#add34c08-56c46c8f-624cce2c-35749300)


**Пример 3**

Пример №2, но сильно снижаем значения `locations.penalty.out_of_time.fixed` и `locations.penalty.out_of_time.minute` относительно значений по умолчанию.

Алгоритм планирует такой же маршрут, как и в примере №1. В этом случае у алгоритма был выбор: менее оптимальный маршрут, но при этом менее рискованный с точки зрения вероятного опоздания или более оптимальный, но и более рискованный. Поскольку стоимость штрафа за опоздание очень мала, система выбрала вариант с более оптимальным маршрутом.

[Пример Excel](https://courier-admin.s3.yandex.net/doc-examples/mvrp-example-miinmize_lateness3.xlsx) ⋅ [Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/2026c97b-88574e95-da251263-5038a623) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/2026c97b-88574e95-da251263-5038a623) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#2026c97b-88574e95-da251263-5038a623)

**Пример 4**

Пример №2, но сильно завышаем значения `locations.penalty.out_of_time.fixed` и `locations.penalty.out_of_time.minute` относительно значений по умолчанию.

Алгоритм планирует 2 маршрута, разбивая заказы на 2 машины – сумма штрафа за вероятные опоздания превысила стоимость использования еще одной машины.


[Пример Excel](https://courier-admin.s3.yandex.net/doc-examples/mvrp-example-miinmize_lateness4.xlsx) ⋅ [Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/1d54a452-aed43d2d-cf779bc3-b5f0a338) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/1d54a452-aed43d2d-cf779bc3-b5f0a338) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#1d54a452-aed43d2d-cf779bc3-b5f0a338)


<p class="p"><a href="feedback.html" class="xref button">Написать в службу поддержки</a></p>
