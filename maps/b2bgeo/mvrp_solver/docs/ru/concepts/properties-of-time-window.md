# Свойства временных окон

При формулировании задачи маршрутизации часто нужно ограничить временное окно доставки заказа, время работы склада, или время смены водителя.

Для ограничения времени в Маршрутизаторе используется поле `time_window` ("временное окно"), представляющее из себя текстовое описание диапазона времени.

Временные окна могут быть заданы в абсолютном и относительных форматах, подробно рассмотренных ниже.


## Относительный формат временных окон

Этот формат временных окон не содержит абсолютной даты, и определяется как пара значений времени, например `07:00:00 - 23:00:00` для временного окна, которое начинается в 7 утра, и заканчивается в 23 вечера текущего дня.

Для окон, начинающихся или заканчивающихся на следующий день (или любой день в будущем) дополнительно ко времени указывается количество дней относительно текущего времени (или даты, заданной в поле `options.date`). Например,  `07:00:00 - 1.03:00:00` для окна которое начинается в 7 утра текущего дня и заканчивается в 3 ночи следующего дня. Или `1.07:00:00 – 1.15:00:00` для окна которое начинается в 7 утра следующего дня и заканчивается в 15 часов следующего дня – число перед временем окна определяет сутки, к которым относится данное временное окно. 0 считается за текущие сутки. При этом сдвиг необходимо указывать и перед нижней и перед верхней границей временного интервала.

Верхняя граница временного окна всегда должна быть больше или равна нижней границе. Окно `07:00:00` - `03:00:00` приведет к ошибке. Особенно часто такая ошибка возникает при указании окон, переходящих на следующие сутки или для окон, которые заканчиваются в полночь – так, окно `10:00:00` - `00:00:00` будет воспринято с ошибкой, необходимо указать `10:00:00` - `1.00:00:00`.

Форматы временных окон без даты будут интерпретированы сервисом относительно текущей даты и часового пояса GMT+3 (Москва), либо относительно даты, заданной в поле `options.date` и часового пояса, заданного в поле `options.time_zone`.

{% note %}

Окно `00:00:00` – `23:59:59` означает круглосуточное окно только в первые сутки. Это актуально для временного окна склада – если в планировании участвует, например, 2 дня (текущий и следующий день), то для круглосуточной работы склада на период планирования необходимо указать `00:00:00` – `1.23:59:59`.

{% endnote %}


**Пример**

В примере ниже определен часовой пояс для запроса (московское время), а также временные окна склада и заказов без указания даты. Маршрут строится на дату 20 Января 2019 года (или на текущую дату если не указано поле `options.date`).

[Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/472d65e2-3f445fad-1059bbf3-e032ecb1) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/472d65e2-3f445fad-1059bbf3-e032ecb1) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#472d65e2-3f445fad-1059bbf3-e032ecb1)

## Абсолютный формат временных окон

Этот формат содержит полную дату и время начала и окончания временного окна в формате ISO-8601, например `2019-10-10T07:00:00+03:00/2018-01-10T18:00:00+03:00` для окна, которое начинается в 7 утра по Московскому времени, и заканчивается в 18 часов также по Московскому времени.

{% note %}

Обратите внимание, при использовании абсолютного формата времени можно указать несколько временных зон. Это может быть полезно для определения временных окон при доставке на границе временных зон.

{% endnote %}

{% note %}

Обратите внимание, что при использовании абсолютного формата временных окон необходимо заполнить поле `options.date`. Поле `options.time_zone` при этом определяет временную зону, которая будет использоваться для временных окон заказов в ответе Маршрутизатора.

{% endnote %}

**Пример**

В примере ниже временные окна склада, заказов и смен указаны с датой и временной зоной в формате ISO8601. Маршрут строится на дату 21 Января 2019 года, указанную в каждом временном окне.

[Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/bf7a9ba3-67cc7871-a7ad07da-2c372054) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/bf7a9ba3-67cc7871-a7ad07da-2c372054) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#bf7a9ba3-67cc7871-a7ad07da-2c372054)

## Жесткие и мягкие окна

Временное окно это ограничение, которое необходимо выполнить при построении маршрута. Например, для временного окна заказа, выполнение ограничения означает доставку в указанном диапазоне времени.

Допустимо определение "*жестких*" и "*мягких*" временных окон.

"*Жесткое*" окно — это ограничение которое необходимо выполнить без нарушений. Если при построении маршрута такое ограничение нарушается, заказ полностью исключается из маршрута и попадает в поле `dropped_locations` в ответе Маршрутизатора.

"*Мягкое*" окно — это ограничение которое допустимо нарушить со штрафом, пропорциональным времени опоздания. Если при построении маршрута такое ограничение нарушается, заказ не исключается из маршрута, но доставка будет осуществлена позже или раньше.

Для управления жесткими временными окнами используется поле `hard_window`:

- `true`, временное окно будет "*жестким*".
- `false`, временное окно будет "*мягким*".

На практике "*мягкие*" окна позволяют:

- сбалансировать ранние прибытия или опоздания между несколькими заказами, если заданное количество автомобилей не позволяет доставить все заказы точно в срок;
- прибыть на склад раньше или опоздать при возвращении, если необходимо доставить все заказы в течение дня;
- превысить время смены водителя, если ранний выезд или опоздание необходимы и допустимы бизнес-процессами.

При определении "*мягких*" окон используются штрафы\*:

- за нарушение временного окна:
  - `penalty.out_of_time.fixed` — штраф за факт нарушения временного окна.
  - `penalty.out_of_time.minute` — штраф за минуту нарушения временного окна.
- за ранее прибытие:
  - `penalty.early.fixed` — штраф за факт раннего прибытия.
  - `penalty.early.minute` — штраф за минуту раннего прибытия.
- за опоздание:
  - `penalty.late.fixed` — штраф за факт опоздания.
  - `penalty.late.minute` — штраф за минуту опоздания.

\* — Добавляются к стоимости маршрута при наличии нарушения (`fixed`) или за каждую минуту нарушения (`minute`). Раннее прибытие и опоздание — частные случаи нарушения.

Если ваш бизнес-процесс не допускает нарушений временных окон, мы рекомендуем следующее:

- при начальной формулировке задачи маршрутизации использовать "*жесткие*" окна,
- при последующей работе использовать "*мягкие*" окна с настраиваемым значением штрафов за нарушение временного окна (например, опоздание или раннее прибытие на 1-5 минут могут быть допустимы).


## Где определяются временные окна

Маршрутизатор позволяет определять временные окна для следующих сущностей:

- Заказы (`locations`) — допустимое время прибытия на заказ.
- Склад (`depot`) — время работы склада.
- Смена водителя (`vehicles[].shift`) — допустимый диапазон времени смены.


<p class="p"><a href="feedback.html" class="xref button">Написать в службу поддержки</a></p>
