# Работа c 1С-обработкой для сервиса Яндекс.Маршрутизация

Поддерживаемые версии 1С:

* Управление торговлей 11.\* и отраслевые на их основе;
* ERP и отраслевые на их основе;
* Бухгалтерия предприятия версий 3.\* и отраслевые на их основе;
* Комплексная автоматизация версий 2.\*.

В зависимости от конфигурации данные выбираются из соответствующих документов:

* Заказ клиента (УТ, КА);
* Заказ покупателя (УНФ, УПП);
* Реализация товаров и услуг (БУХ).

Перед началом работы, скачайте файл внешней обработки.

<a href="https://courier.yandex.ru/vrs-doc/Yandex.Routing_10.11.2020.zip" class="xref button">Скачать</a>

Архив содержит 3 файла:

*	Модуль интеграции;
*	Обработку для работы с запросами на маршрутизацию (автоматический запрос статусов);
*	Обработку для начального заполнения справочников.

Данная реализация является типовой и может потребовать доработок в зависимости от конфигурации клиента и принятых процессов.

Модуль представляет собой обработку, находящуюся в подсистеме Яндекс.Маршрутизация. В зависимости от конфигурации и ее версии внешний вид диалога открытия файла может отличаться от представленного на изображении.

<img class="step--img" src="https://courier.yandex.ru/vrs-doc/1c-uf-guide-1.png"  width="700px" />

## Шаг 1: Запуск модуля

1.	Для установки расширения нужно запустить 1С в режиме конфигуратора и открыть список расширений. Для этого нужно запустить пункт меню **Конфигурация** и выбрать там подпункт **Расширения конфигурации**.

    <img class="step--img" src="https://courier.yandex.ru/vrs-doc/1c-uf-guide-2.png" width="700px" />

2.	Откроется список, в котором нужно добавить новое расширение с помощью кнопки **Добавить**. Все параметры нового расширения нужно оставить заполненными по умолчанию и нажать **ОК**.

    <img class="step--img" src="https://courier.yandex.ru/vrs-doc/1c-uf-guide-3.png" width="550px" />


3.	После добавления нового расширения конфигурации нужно выделить его в списке, и в пункте меню **Конфигурация** – **Загрузить конфигурацию из файла** выбрать файл расширения на диске компьютера.

    <img class="step--img" src="https://courier.yandex.ru/vrs-doc/1c-uf-guide-4.png" width="700px" />

4.	При появлении диалогового окна с информацией о загрузке конфигурации нажать **ОК**.

    <img class="step--img" src="https://courier.yandex.ru/vrs-doc/1c-uf-guide-5.png" width="600px" />

5.	После окончания загрузки расширения нужно обновить конфигурацию базы данных, нажав **Да** и подтвердить список изменений в следующем окне.

    <img class="step--img" src="https://courier.yandex.ru/vrs-doc/1c-uf-guide-6.png" width="400px" />


6.	После этого расширение будет загружено в конфигурацию. В режиме предприятия на Панели разделов появится новый пункт Яндекс.Маршрутизация.

    <img class="step--img" src="https://courier.yandex.ru/vrs-doc/1c-uf-guide-7.png" width="700px" />

7.	Автоматическая обработка происходит с помощью обработки **ЯМ_АвтоматическиеОбработки**, которую необходимо добавить в учетную систему 1С, если есть необходимость в автоматическом обновлении статусов запросов.

    Обработка с заданной периодичностью запрашивает у сервиса обновление статусов для запросов на маршрутизацию в статусах, отличных от **Завершен** и **Ошибка**. Сделать это можно открыв справочник **Дополнительные отчеты и обработки**, нажав на его форме кнопку **Добавить из файла** и выбрав файл обработки на диске:

    <img class="step--img" src="https://courier.yandex.ru/vrs-doc/1c-uf-guide-8.png" width="700px" />

8.	Для добавленной обработки можно будет настроить расписание запуска, выбрав его в строке таблицы на форме.

    <img class="step--img" src="https://courier.yandex.ru/vrs-doc/1c-uf-guide-9.png" width="700px" />

9.	Окно настройки расписания является типовым и дает возможность гибко настроить интервалы запуска обработки в зависимости от особенностей использования сервиса.

    <img class="step--img" src="https://courier.yandex.ru/vrs-doc/1c-uf-guide-10.png" width="700px" />


## Шаг 2: Заполнение настроек по умолчанию
Для заполнения настроек по умолчанию воспользуйтесь автоматической обработкой **Начальное заполнение справочников**.
Эту обработку можно открыть через меню **Файл** > **Открыть** и далее нажать на кнопку **Заполнить справочники по умолчанию**.

<img class="step--img" src="https://courier.yandex.ru/vrs-doc/1c-uf-guide-11.png" width="400px" />

Данная обработка заполняет справочники:

*	Настройки штрафов для алгоритма
*	Группы балансировки
*	Общие настройки

## Шаг 3: Заполнение справочников и настроек

Для формирования запроса в сервис Яндекс.Маршрутизация требуется ввести необходимые настройки модуля и заполнить справочники Склады и Машины.



1.	Справочник **Общие настройки** содержит [основные настройки](1c-settings.md) работы модуля, такие как ключ API, адреса подключения. Открыть форму настроек можно из общего меню, пункт Общие настройки.

    <img class="step--img" src="https://courier.yandex.ru/vrs-doc/1c-uf-guide-12.png" />

2. Значения основных настроек заполняются значениями по умолчанию после шага 2. Если по какой-то причине настройки не заполнились, выберите пункт меню **Заполнить настройки из файла** и загрузите файл с настройками.

    <a href="https://courier.yandex.ru/vrs-doc/ЯМ_Общие%20настройки.dni" class="xref button">Скачать</a>

3.	Значения основных настроек заполняются значениями по умолчанию после шага 2. Здесь необходимо заполнить ключи для работы с сервисами Яндекс.Маршрутизации и при необходимости скорректировать общие настройки.
Для работы с сервисом планирования необходимо заполнить:

  *	ID Компании в Яндекс.Маршрутизация;
  *	КлючAPI для ЯндексМаршрутизация;
  * Для работы с сервисом мониторинга необходимо дополнительно заполнить **Токен для Яндекс.МониторингТокен**.  Получение токена описано в разделе [Получение OAuth-токена](https://yandex.ru/routing/doc/delivery/concepts/quickstart/register.html).;
  * Для работы с [сервисом геокодирования](https://tech.yandex.ru/maps/geocoder/) необходимо дополнительно заполнить **КлючAPI для Яндекс.Геокодирование**.




4.	Справочник **Склады отгрузки** должен иметь один непомеченный на удаление элемент с заполненными параметрами.
Пример заполнения показан на изображении ниже:

    <img class="step--img" src="https://courier.yandex.ru/vrs-doc/1c-uf-guide-13.png" width="600px" />



5.	Справочник **Машины** должен иметь хотя бы один непомеченный на удаление элемент с заполненными параметрами. Пример заполнения показан на изображении ниже:

    <img class="step--img" src="https://courier.yandex.ru/vrs-doc/1c-uf-guide-14.png" width="600px" />



## Шаг 4: Загрузка заказов
1.	Для начала работы необходимо зайти в Рабочее место логиста. Для отбора данных по документам (заказам) необходимо выбрать Склад и выбрать период, за который необходимо собрать данные по документам.

    <img class="step--img" src="https://courier.yandex.ru/vrs-doc/1c-uf-guide-15.png" width="700px" />

2.	После выбора периода необходимо нажать на кнопку **Заполнить список**. Данные по документам (зависит от конфигурации) за выбранный пользователем период заполнят таблицу модуля.  Данная таблица доступна для редактирования на форме модуля после завершения проверки и редактирования собранных данных.

3.	Координаты для заказов можно заполнить в списке вручную. Если необходимо геокодировать адреса  - то нужно нажать на кнопку Геокодировать (для этого требуется в настройках указать API-ключ сервиса [Яндекс.Геокодирования](https://tech.yandex.ru/maps/commercial/doc/concepts/jsapi-geocoder-docpage/#jsapi-geocoder)).

    <img class="step--img" src="https://courier.yandex.ru/vrs-doc/1c-uf-guide-16.png" width="700px" />

    Для целей тестирования в настройках есть параметр – **Заполнять координаты случайными значениями**, если установить его в **Да**, то координаты будут заполняться случайными значениями в зависимости от координат склада - это позволит протестировать модуль без использования ключа геокодирования.

## Шаг 5: Отправка запроса на планирование

1.	Для отправки запроса на планирование в сервисе Яндекс.Маршрутизация необходимо нажать на кнопку **Отправить запрос**. Результат отправки будет отображен в окне сообщений.

    <img class="step--img" src="https://courier.yandex.ru/vrs-doc/1c-uf-guide-17.png" />

2.	Для просмотра результатов необходимо перейти на вкладку **Результат планирования** – на форме есть фильтр по id задачи планирования. По умолчанию отображается последний оправленный запрос. Для получения результатов необходимо нажать на кнопку обновления рядом с полем ID планирования.

    <img class="step--img" src="https://courier.yandex.ru/vrs-doc/1c-uf-guide-18.png" />



## Шаг 6: Просмотр результатов и отправка данных в мониторинг

1.	Результаты отображаются в виде 2-х блоков – сверху отображается список спланированных рейсов и ниже распределение заказов по рейсам. Из формы можно перейти в интерфейс Яндекс. Маршрутизации (по нажатию кнопку Перейти в интерфейс Яндекс.Маршрутизации).

    <img class="step--img" src="https://courier.yandex.ru/vrs-doc/1c-uf-guide-19.png" />

2.	Для отправки данных в сервис мониторинга – необходимо нажать на кнопку **Отправить в мониторинг**.
3.	По нажатию на кнопку **Получить отчет о доставке** в нижней форме обновятся значения полей Статус доставки и Фактическое время (данные будут получены из сервиса мониторинга, если эти заказы уже будут фактически доставлены).

<p class="p"><a href="feedback.html" class="xref button">Написать в службу поддержки</a></p>
