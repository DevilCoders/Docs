# Опция равномерной загрузки

Часто основным приоритетом при планировании маршрутов является получение относительно равномерного распределения заказов по автомобилям или курьерам.

Для этого в Маршрутизаторе есть опция равномерной загрузки (балансировки) `balanced_groups`. Балансировка может осуществляться по времени маршрута, по количеству остановок на маршруте или по обоим критериям одновременно.

## Как это работает

Группа балансировки является свойством смены автомобиля – идентификатор такой группы задается в поле `vehicles.shifts.balanced_group_id`. Опция равномерной загрузки работает для каждой группы независимо.

Параметры балансировки задаются в поле `options.balanced_groups`. К ним относятся:

- идентификатор группы (он же используется в поле `vehicles.shifts.balanced_group_id`);
- размер штрафов за отклонение от среднего времени маршрута и количества остановок – `options.balanced_groups.penalty.hour` и `options.balanced_groups.penalty.stop` соответственно.

  {% note %}
  У атрибутов `options.balanced_groups.penalty.hour` и `options.balanced_groups.penalty.stop` есть значения по умолчанию.
  {% endnote %}

### Особенности

Желательно балансировать автомобили, которые изначально находятся в равных условиях. Это может касаться различных параметров задачи: продолжительности и времени смены автомобилей, плотности заказов на определенную группу автомобилей, грузоподъемности, тегов и т.п. Для автомобилей с разными условиями рекомендуется задавать разные группы балансировки. Например:

1. Автомобили имеют разную продолжительность смены работы: у части автомобилей она равна 8 часов, у другой – 6. Такие автомобили необходимо балансировать отдельно, потому что время маршрута у них изначально будет различаться, и объективно они будут выполнять разное количество заказов.
1. Курьеры выходят в утреннюю и вечернюю смену (одинаковой продолжительности) и маршрутизируются в рамках одного запроса. Допустим, что количество заказов утром и вечером неравномерно. Тогда балансировать утренних и вечерних курьеров необходимо либо отдельно, либо только по времени маршрута, потому что среднее количество заказов (и, соответственно, остановок на маршруте) у курьера утром и вечером, вероятно, будет различаться.
1. Используются одинаковые автомобили, но есть много заказов в городе и мало заказов в области на разных направлениях. Такую задачу можно балансировать только по времени маршрута, потому что, скорее всего, у автомобилей, которые поедут на дальнее расстояние, получится выполнить меньше заказов.
1. Используются автомобили разной грузоподъемности. Обычно они выполняют разное количество заказов, поэтому необходимо либо задавать разные группы балансировки на разную грузоподъемность, либо балансировать автомобили только по времени маршрута (второй вариант предпочтительнее).

{% note %}

Использование балансировки, как правило, приводит к получению менее оптимальных маршрутов по общим метрикам решения (по итоговому показателю «Пробег»/«Время маршрута»), а иногда и по количеству задействованных автомобилей. При увеличении штрафов за несбалансированность формируется более равномерное решение, которое достигается в ущерб оптимальности маршрутов.

{% endnote %}

Опция равномерной загрузки балансирует маршруты в рамках одного конкретного запуска планирования. Если стоит задача выровнять загрузку на ресурсы в течение продолжительного периода времени (например, в течение месяца), то ее следует реализовывать вне Маршрутизатора, через отдельный процесс. В этом процессе курьеры назначаются на маршруты с учетом накопленного значения, относительно которого выполняется балансировка. Например, пусть у курьеров накапливается суммарное время отработки. После планирования маршрутов в данный день курьеру, который имеет минимальное накопленное значение (суммарное время отработки), назначается самый продолжительный маршрут, и наоборот. Таким образом, выравнивание будет происходить не в рамках конкретного дня, а в течение некоторого периода, и при этом в данный конкретный день маршруты могут быть оптимальны, пусть даже и неравномерны.

**Пример 1**

В задаче 52 заказа и 3 курьера. Решаем задачу без балансировки.

Результат планирования:

| Курьер    | Количество остановок на маршруте | Пробег, км | Время маршрута |
|-----------|----------------------------------|------------|----------------|
| Курьер 1  | 19                               | 50         | 10:49          |
| Курьер 2  | 17                               | 47,4       | 09:50          |
| Курьер 3  | 16                               | 35,8       | 09:04          |
| **Итого** | **52**                           | **133,1**  | **29:43**      |

[Пример Excel](https://courier-admin.s3.yandex.net/doc-examples/mvrp-example-balanced_groups1.xlsx) ⋅ [Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/f8104987-98abd9b7-85ba65f9-cdacfbc8) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/f8104987-98abd9b7-85ba65f9-cdacfbc8) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#f8104987-98abd9b7-85ba65f9-cdacfbc8)

**Пример 2**

Решаем ту же задачу, что и в примере №1, но со следующими дополнениями:

- включаем опцию балансировки;
- задаем одну группу балансировки;
- используем размер штрафов за несбалансированность маршрутов по умолчанию.

Результат планирования:

| Курьер    | Количество остановок на маршруте | Пробег, км | Время маршрута |
|-----------|----------------------------------|------------|----------------|
| Курьер 1  | 17                               | 54,1       | 09:56          |
| Курьер 2  | 17                               | 41,9       | 09:48          |
| Курьер 3  | 18                               | 48,7       | 10:05          |
| **Итого** | **52**                           | **144,7**  | **29:49**      |

{% note %}

Маршруты стали более равномерными относительно показателя «Количество остановок на маршруте»/«Время маршрута», но общие метрики решения (итоговый показатель «Пробег»/«Время маршрута») ухудшились относительно примера №1.

{% endnote %}

[Пример Excel](https://courier-admin.s3.yandex.net/doc-examples/mvrp-example-balanced_groups2.xlsx) ⋅ [Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/310cebd-b1d819bb-7dc6f7af-293fd377) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/310cebd-b1d819bb-7dc6f7af-293fd377) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#310cebd-b1d819bb-7dc6f7af-293fd377)

**Пример 3**

Решаем ту же задачу, что и в примере №1, но со следующими дополнениями:

- включаем опцию балансировки;
- балансируем маршруты только по времени маршрута;
- повышаем размер штрафов за несбалансированность маршрутов относительно значения по умолчанию.

Результат планирования:

| Курьер    | Количество остановок на маршруте | Пробег, км | Время маршрута |
|-----------|----------------------------------|------------|----------------|
| Курьер 1  | 17                               | 47,5       | 10:09          |
| Курьер 2  | 18                               | 50         | 10:09          |
| Курьер 3  | 17                               | 52,5       | 10:09          |
| **Итого** | **52**                           | **150**    | **30:27**      |

{% note %}

Теперь курьеры работают одинаковое количество времени, но общие метрики решения ухудшились еще больше. Это связано с тем, что алгоритм с повышенными штрафами за несбалансированность пытается найти решение, которое будет не столько оптимально, сколько сбалансировано.

{% endnote %}

[Пример Excel](https://courier-admin.s3.yandex.net/doc-examples/mvrp-example-balanced_groups3.xlsx) ⋅ [Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/725b0ff3-7b78f2e7-eacb2a8e-3d8afe1e) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/725b0ff3-7b78f2e7-eacb2a8e-3d8afe1e) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#725b0ff3-7b78f2e7-eacb2a8e-3d8afe1e)


<p class="p"><a href="feedback.html" class="xref button">Написать в службу поддержки</a></p>
