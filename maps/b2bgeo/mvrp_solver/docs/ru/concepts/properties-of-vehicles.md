# Свойства транспортных средств

Доставка заказов в Яндекс.Маршрутизации может выполняться как обычными автомобилями, так и курьерами, передвигающимися пешком или на общественном транспорте. Автомобиль и курьер имеют общий набор свойств.

Для определения автомобиля или курьера используется поле запроса `vehicles`.


## Идентификатор автомобиля

Обязательным атрибутом автомобиля является уникальный числовой идентификатор, который задается в поле `id`. Идентификатор должен быть уникальным в пределах одного запроса к сервису.

Дополнительно, вы можете указать строковый идентификатор автомобиля из вашей учетной системы в поле `ref`.

## Вместимость автомобиля или курьера
Маршрутизатор поддерживает определение вместимости автомобиля, для определения максимального веса или количества груза, которое автомобиль/курьер может перевезти за один маршрут.

Для определения вместимости автомобиля или курьера используется поле `capacity` (достаточно указать одно из значений):

- `capacity.weight_kg` — вес в килограммах или объемный вес.
- `capacity.volume` — объем. Задается как произведение длины, ширины и высоты. Если измерения неизвестны, можно задать значение объема в одном поле, а в других полях указать 1.
- `capacity.units` — количество мест (паллет, коробок, кег).

Более подробно с определением веса вы можете ознакомиться в главе [Вес и объем](properties-of-weight.md).

{% note %}

Обратите внимание, если вес заказов задан в килограммах или как объемный вес, вместимость автомобиля должна быть задана в таких же единицах. Аналогично, если вес заказов задан в виде количества мест, определение вместимости автомобиля должно содержать максимальное количество мест в каждом автомобиле.

{% endnote %}

Дополнительно, возможно определение максимальной загрузки автомобиля в процентах от заданной грузоподъемности. Для этого используется поле запроса `limits`:

- `limits.volume_perc` — процентное значение от заданного в `capacity.volume`;
- `limits.weight_perc` — процентное значение от заданного в `capacity.weight_kg`;
- `limits.unit_perc` — процентное значение от заданного в `capacity.units`;

Чтобы указать возможность перегруза относительно заданного значения, укажите значение больше 100. Чтобы оставить запас грузоподъемность, например под возможные неточности в оценке габаритов заказа, укажите значение меньше 100. Например, значение 110 позволяет 10% перегруза, а значение 90 - максимальную загрузку в 90% от указанной грузоподъемности.

Вместимость автомобиля (с учетом `limits`) - жесткое ограничение, которое не будет нарушено. При этом при расчете загруженности автомобиля учитываются заказы на прием и доставку. Подробнее в разделе [Прием и доставка](properties-of-orders.md).

{% note %}

Через вместимость автомобиля можно косвенно управлять количеством заказов, которые должны в него попасть. Например, если указать объем каждого заказа в 1 юнит (независимо от реальных размеров заказа), а вместимость автомобиля – 10 юнитов, то при планировании в каждый автомобиль попадет не более 10 заказов.

{% endnote %}

**Пример**

Дано два автомобиля грузоподъемностью 1.5 тонн (Автомобиль 1) и 3 тонны (Автомобиль 2), а также три заказа для доставки весом 1 тонна, 1.2 тонны и 1.4 тонны

{% note %}

При оптимизации маршрутов, заказ весом 1 тонну будет размещен в Автомобиль 1, и два заказа весом 1.2 и 1.4 тонны в Автомобиль 2.

{% endnote %}

[Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/f8cc2d06-f547a712-4e6779f3-ed4d4358) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/f8cc2d06-f547a712-4e6779f3-ed4d4358) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#f8cc2d06-f547a712-4e6779f3-ed4d4358)


## Пользовательские единицы измерения вместимости

Вместимость транспортного средства по [пользовательской единице измерения](properties-of-orders.md#polzovatelskie-edinitsy-izmereniia). По умолчанию вместимость по пользовательской единице измерения не ограничена. Задается в параметре `vehicle.capacity.custom`.

Можно задавать несколько пользовательских единиц измерения и с любыми названиями. Главное, чтобы пользовательская единица измерения на заказе называлась аналогично [указанной в заказе](properties-of-orders.md#polzovatelskie-edinitsy-izmereniia).


**Пример**

В данном примере указаны вес, объем и количество грузовых единиц. Также задана стоимость заказа и ограничение на машине по суммарную стоимости перевозимых заказов с помощью параметров `location.shipment_size.custom` и `vehicle.capacity.custom` соответственно.

Видно, что есть 2 машины, которые везут по 1 заказу, хотя утилизация по весу, объему и количеству мест у них небольшая – это обусловлено тем, что стоимость этих заказов находится близко к установленному на машине ограничению.

[Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/78d9aa35-3c795c00-253124d7-57fe6f6c) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/78d9aa35-3c795c00-253124d7-57fe6f6c) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#78d9aa35-3c795c00-253124d7-57fe6f6c)


## Старт автомобиля не со склада
По умолчанию, автомобили и курьеры стартуют со склада, но иногда нужно начинать маршрут из другой точки (например, из дома или с места парковки). Как правило эта задача подходит для планирования маршрутов торговых представителей, сервисных инженеров и прочих специалистов которые не развозят товары, а оказывают услуги.

Это требование можно реализовать с помощью свойства `vehicle.start_at`. В этом случае курьер или автомобиль начнет маршрут из указанной точки с типом `garage`, а не со склада.

## Старт с одного из нескольких складов

Если используется функциональность [доставки с одного из нескольких складов](https://yandex.ru/routing/doc/vrp/concepts/properties-of-depot.html#dostavka-s-odnogo-iz-neskolkikh-skladov), для каждой машины в поле `depot_id` можно указать склад, с которого она будет стартовать. По умолчанию машины выезжают с первого склада из списка `depots`.

## Посещение склада перед началом рабочего дня

При начале рабочего дня не со склада курьерам может понадобиться посетить склад, чтобы получить там заказы. Для этого используйте свойство `vehicle.visit_depot_at_start`. Если указано `true`, то перед началом выполнения заказов курьер или транспортное средство обязаны посетить склад. В противном случае они могут сразу начать выполнять заказы.

**Пример**

В примере ниже доставку выполняют три автомобиля:

- Один выполняет доставку как обычно.
- Второй доставляет заказы без визита на склад и заканчивает маршрут без посещения склада.
- Третий начинает маршрут не со склада, но обязан посетить его  до начала выполнения заказов.

[Пример Excel](https://courier-admin.s3.yandex.net/doc-examples/example-garage-start.xlsx) ⋅ [Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/3589e9a3-df9f49ae-484bf88b-95d8ae22) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/3589e9a3-df9f49ae-484bf88b-95d8ae22) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#3589e9a3-df9f49ae-484bf88b-95d8ae22)






## Возврат на склад в конце рабочего дня
По умолчанию, автомобиль или курьер начинает и завершает маршрут на складе.

Если автомобиль не должен возвращаться на склад после выполнения всех заказов, используйте опцию `vehicle.return_to_depot = false`.

### Возврат на произвольную точку в конце маршрута

Если в вашем сценарии работы необходимо учитывать удаленность последнего заказа от места парковки курьера или, например, домашнего адреса, вы можете это учесть следующим образом:

- Создайте точку с типом `garage` (поле `locations[].type`). Эта точка будет использоваться только для окончания маршрутов.

- Для курьера, которому необходимо вернуться в конце работы "домой" или "на парковку", укажите идентификатор этой точки в поле `vehicle.finish_at`.

При решении задачи все автомобили или курьеры, у которых указано свойство `finish_at` вернутся на указанную точку. Если включена опция возврата на склад (`vehicle.return_to_depot = true`), то в маршруте сначала будет посещен склад, а затем проложен путь до места парковки.

**Пример**

В примере ниже используется два автомобиля с разной грузоподъемностью и четыре заказа с различным весом. Оба автомобиля участвуют в доставке из-за весовых ограничений. Автомобиль 2 не должен возвращаться на склад после доставки последнего заказа.

{% note %}

Обратите внимание, что в ответе Маршрутизатора автомобиль 2 завершает маршрут на последнем заказе.

{% endnote %}

[Пример Excel](https://courier-admin.s3.yandex.net/doc-examples/example-garage-finish.xlsx) ⋅ [Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/e9f73cbf-e48a5a6f-51e1658d-44946119) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/e9f73cbf-e48a5a6f-51e1658d-44946119) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#e9f73cbf-e48a5a6f-51e1658d-44946119)


## Несколько рейсов автомобиля в день
По умолчанию, автомобиль или курьер начинает и завершает маршрут на складе, то есть выполняет ровно один маршрут в течение рабочего дня (смены).

Если автомобиль может возвращаться на склад в любое время рабочей смены для дозагрузки дополнительных заказов, используйте опцию `vehicle.max_runs` — максимальное количество рейсов. Значение `max_runs` не может быть меньше количества смен автомобиля. Если оно меньше, то будет использоваться количество смен.

{% note %}

Смены которые не используются, но определены в запросе, учитываются и считаются за 1 рейс.

{% endnote %}

**Пример**

В примере ниже используется один автомобиль с ограниченной вместимостью в 2 тонны и три заказа с весом в 0.8 тонн. Автомобилю разрешено два рейса, то есть автомобиль может вернуться на склад после выполнения двух заказов для загрузки и доставки еще одного заказа.

[Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/1b6d35f9-abf3c24b-f3f31e7f-f7c0821e) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/1b6d35f9-abf3c24b-f3f31e7f-f7c0821e) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#1b6d35f9-abf3c24b-f3f31e7f-f7c0821e)


## Смены работы автомобиля или курьера

Для автомобиля можно определить одну или несколько смен работы. Для определения смен используется поле `vehicle.shifts`.

Смена представляет собой диапазон времени, в который разрешена работа автомобиля. Время смены включает в себя время нахождения на складе при загрузке, а также время в движении и сервисное время на заказах.

Также можно ограничить [максимальную продолжительность смены](properties-of-vehicles.md#maksimalnaia-prodolzhitelnost-smeny).

Смены являются опциональными - если смены не определены явно, каждый автомобиль работает ровно одну смену с временным окном, совпадающим с [временным окном склада](properties-of-depot.md).


Для использования одной или более смен в Excel необходимо определить следующие поля:

- `shifts.0.time_window` — [временное окно](properties-of-time-window.md), соответствующее времени работы автомобиля.
- `shifts.0.hard_window` — [флаг жесткого временного окна](properties-of-time-window.md#zhestkie-i-miagkie-okna).
- `shifts.0.service_duration_s` — время между сменами (в секундах). Например, время на замену водителя, обмен документами и тд.  

В случае определения **мягкого** временного окна можно дополнительно задать штрафы:

- за нарушение временного окна:
  - `shifts.0.penalty.out_of_time.fixed` — штраф за факт нарушения временного окна смены.
  - `shifts.0.penalty.out_of_time.minute` — штраф за минуту нарушения временного окна смены.
- за ранний выезд:
  - `shifts.0.penalty.early.fixed` — штраф за факт начала работы раньше временного окна смены.
  - `shifts.0.penalty.early.minute` — штраф за минуту начала работы раньше временного окна смены.
- за опоздание:
  - `shifts.0.penalty.late.fixed` — штраф за факт завершения работы позже временного окна смены.
  - `shifts.0.penalty.late.minute` — штраф за минуту завершения работы позже временного окна смены.

{% note %}

Обратите внимание, что для определения нескольких смен необходимо несколько полей в Excel с увеличиваюшимся числовым индексом.

Например `shifts.0.time_window` относится к первой смене, а `shifts.1.time_window` - к второй смене.

{% endnote %}

**Пример**

В запросе к Маршрутизатору задан один автомобиль с тремя сменами (утренняя, дневная, вечерняя), а также три заказа, из которых один имеет время доставки утром, и два вечером.

{% note %}

Обратите внимание, что в ответе Маршрутизатора будут использованы только утренняя и вечерняя смена, так как на дневную смену нет ни одного заказа на доставку.

{% endnote %}

[Пример Excel](https://courier-admin.s3.yandex.net/doc-examples/example-vehicle-shifts.xlsx) ⋅ [Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/5167e27-10164864-7999bac5-1a48e8a1) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/5167e27-10164864-7999bac5-1a48e8a1) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#5167e27-10164864-7999bac5-1a48e8a1)

## Ограничение количества остановок в смене

При планировании маршрута можно указать минимальное и максимальное количество остановок в маршруте. Это может быть полезно, например, чтобы ограничить максимальную нагрузку на автомобиль в день, или наоборот, обязательно вывести автомобиль на маршрут с каким-то количеством остановок.

В Маршрутизаторе для этого используются параметры смены `minimal_stops` и `maximal_stops`. Для каждого автомобиля можно задать свое количество остановок.

Ограничение не является строгим и может быть нарушено. При нарушении ограничения по минимальному количеству остановок начисляется штраф, указанный в полях смены `penalty.stop_lack.fixed` (за факт остановок меньше минимального количества) и `penalty.stop_lack.per_stop` (за каждую остановку меньше минимального количества)

Соответственно при нарушении ограничения по максимальному количеству остановок начисляется штраф, указанные в полях смены в полях смены `penalty.stop_excess.fixed` (за факт остановок больше максимального количества) и `penalty.stop_excess.per_stop` (за каждую остановку больше максимального количества).


Как правило, использование ограничений на количество остановок приводит к ухудшению метрик решения, поскольку решение смещается в сторону выполнения ограничений в ущерб оптимальности маршрута.  

**Пример 1**

В примере маршрут строится для 3 автомобилей, выполняющих доставку по 15 точкам. Поскольку на маршруте не указано никаких ограничений, маршрут строится обычным образом.

[Пример Excel](https://courier-admin.s3.yandex.net/doc-examples/example-vehicle-max_stops1.xlsx) ⋅ [Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/11838b12-e031f2fa-580da0a2-c972bf41) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/11838b12-e031f2fa-580da0a2-c972bf41) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#11838b12-e031f2fa-580da0a2-c972bf41)

**Пример 2**

В примере указаны те же условия что и в примере 1, но указано ограничение на 4 минимальных остановки для каждого автомобиля. В маршруты изменились так, чтобы каждый автомобиль посетил хотя бы 4 точки доставки.

[Пример Excel](https://courier-admin.s3.yandex.net/doc-examples/example-vehicle-max_stops2.xlsx) ⋅ [Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/b047dde9-68385061-f63d36a1-d4fee317) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/b047dde9-68385061-f63d36a1-d4fee317) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#b047dde9-68385061-f63d36a1-d4fee317)

**Пример 3**

В примере указаны те же условия что и в примере 1, но указано ограничение на 5 максимальных остановок для каждого автомобиля. В результате заказы распределены равномерно между всеми автомобилями, даже несмотря на то, что несколько заказов расположены рядом и могли бы быть выполнены одним автомобилем.

[Пример Excel](https://courier-admin.s3.yandex.net/doc-examples/example-vehicle-max_stops3.xlsx) ⋅ [Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/350b1d5e-3f98f16c-5fecb6db-463afe14) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/350b1d5e-3f98f16c-5fecb6db-463afe14) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#350b1d5e-3f98f16c-5fecb6db-463afe14)

## Максимальная продолжительность смены

Иногда возникает необходимость продлить период работы курьера. При этом все еще нужно ограничивать максимальную длину смены, но и установить период, в который желательно попасть. Например, есть определенное окно, в которое курьеры выполняют доставки длиной в 14 часов (например, с 8 до 22 часов), но каждый курьер не должен работать больше 8 часов.   

Яндекс Маршрутизация позволяет планировать смены с жесткими временными окнами и желательной длиной смены. При этом длина смены водителя не влияет на время начала работы, только на то время которое он потратит на выполнение заказов. При таком планировании нагрузка, не укладывающаяся в желательную смену одного водителя будет распределена на других, или на того же водителя, но со штрафами за превышение длины смены.

При построении маршрутов Яндекс Маршрутизация строит маршрут как обычно, но все заказы, которые невозможно выполнить за `max_duration_s` добавляются в маршрут со штрафом, указанным в поле `shift.penalty.late` если оно указано, или `shift.penalty.out_of_time` в противном случае. Если расчетная стоимость заказа с учетом штрафов выше чем стоимость выполнения заказа другим курьером, заказ будет передан другому курьеру.

Например, жесткая длина смены (значение `shift.time_window`) - с 8 до 20. По умолчанию маршрут будет построет так, чтобы использовать минимальное количество курьеров, работающих 12 часов. Если указать `max_duration_s = 28800` то нагрузка будет распределена между курьерами, и каждый из них будет работать примерно 8 часов (длина смены задается в секундах).

При этом некоторые курьеры все еще могут работать больше 8 часов, потому что выгоднее оплатить лишнее время работы чем доставить заказ другим курьером.

## Максимальный пробег за смену

В некоторых случаях пробег машины нужно ограничить. Например:

- В планировании участвуют наемные машины и тариф за их использование подразумевает лимит по пробегу.

- На дальние точки должны ехать определенные машины. Тогда прочим машинам можно ограничить пробег.

Параметр `shifts.max_mileage_km` определяет максимальный пробег машины за смену. Учитывается весь пробег, включая:

- движение от склада или точки старта до первой точки из списка заказов;

- возврат на склад или точку завершения маршрута от последней точки из списка заказов.

Ограничение мягкое: алгоритм может его нарушить. Штрафы задаются в полях:

 - `shifts.penalty.max_mileage.fixed` — штраф за факт превышения максимального пробега (по умолчанию 1000);

 - `shifts.penalty.max_mileage.km` — штраф за каждый километр превышения максимального пробега (по умолчанию 100).

Если для вас важен максимальный пробег за рейс, а машина может выполнить несколько рейсов за смену, нужно сделать несколько одинаковых смен (см. **Пример 2**).

Если курьер передвигается [общественным транспортом](https://yandex.ru/routing/doc/vrp/concepts/properties-of-vehicles.html#rezhim-marshrutizatsii), в пробеге возвращается только пешая часть маршрута.

**Пример 1**

Ограничение пробега каждого курьера — 50 км. За нарушение задан большой штраф. В результате плановый пробег на любом маршруте не превышает 50 км.

[Пример Excel](https://courier-admin.s3.yandex.net/doc-examples/max_mileage_1.xlsx) ⋅ [Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/784ff152-ea3e57d5-29fb53e-8120fc6f) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/784ff152-ea3e57d5-29fb53e-8120fc6f) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#784ff152-ea3e57d5-29fb53e-8120fc6f)

**Пример 2**

Есть один курьер, и каждый его рейс должен быть ограничен 50 км. Для этого у курьера задано несколько смен с одинаковыми временными окнами и ограничениями по пробегу. В результате сформировано 3 рейса, каждый протяженностью менее 50 км.

[Пример Excel](https://courier-admin.s3.yandex.net/doc-examples/max-mileage_2.xlsx) ⋅ [Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/a848d3b0-66967ad9-ec771154-b05238c9) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/a848d3b0-66967ad9-ec771154-b05238c9) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#a848d3b0-66967ad9-ec771154-b05238c9)




## Стоимость автомобиля или курьера

Для каждого автомобиля в запросе к Маршрутизатору можно задать различные компоненты стоимости использования. Для определения стоимости автомобиля или курьера используется опциональное поле запроса `vehicle.cost`.

Маршрутизатор позволяет определить следующие основные компоненты стоимости:

- `cost.fixed` — фиксированная стоимость использования автомобиля.
- `cost.hour` — cтоимость за час работы.
- `cost.km` — cтоимость за километр пробега.
- `cost.location` — стоимость посещения одного заказа.
- `cost.run` — стоимость выполнения одного рейса.

В данном случае используется стоимость, по которой алгоритм выбирает оптимальный вариант маршрутизации. Это не тариф, который начисляется в реальности за использование автомобиля, а скорее настройки алгоритма.

{% note %}

Обратите внимание, что компоненты стоимости автомобиля уже заданы по умолчанию. Для определения собственных значений свяжитесь с вашим менеджером в Яндекс.Маршрутизации.

{% endnote %}

## Теги автомобиля

При определении автомобиля или курьера в запросе к Маршрутизатору можно назначить ему правила совместимости (или теги) с заказами.

Правила совместимости могут потребоваться при наличии у автомобиля специального оборудования, которое необходимо для выполнения того или иного заказа - например изотермического фургона для перевозки продуктов питания.

Правила совместимости автомобилий и заказов (теги автомобиля) задаются в следующих полях:

- Поле `vehicle.tags` - свойства автомобиля, которые **частично могут** совпадать со свойствами, требуемыми заказом.
- Поле `vehicle.excluded_tags` - свойства автомобиля, которые **не должны** совпадать со свойствами, требуемыми заказом.

Для [определения тегов заказов](properties-of-orders.md) за используется поле запроса `location.required_tags`.

{% note %}

Обратите внимание, что теги заказов определяют требуемые заказом характеристики автомобиля, тогда как теги автомобилей определяют фактические правила совместимости того или иного автомобиля с различными заказами.

{% endnote %}

Определение тегов автомобиля возможно как в виде строк, так и в виде регулярных выражений. Регулярные выражения - это способ описать более сложную логику и правила совместимости между автомобилями и заказами.

В Яндекс.Маршрутизации используется синтаксис регулярных выражений [POSIX Extended](https://ru.wikibooks.org/wiki/%D0%A0%D0%B5%D0%B3%D1%83%D0%BB%D1%8F%D1%80%D0%BD%D1%8B%D0%B5_%D0%B2%D1%8B%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F#%D0%A2%D1%80%D0%B0%D0%B4%D0%B8%D1%86%D0%B8%D0%BE%D0%BD%D0%BD%D1%8B%D0%B5_%D1%80%D0%B5%D0%B3%D1%83%D0%BB%D1%8F%D1%80%D0%BD%D1%8B%D0%B5_%D0%B2%D1%8B%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F_%D0%B2_Unix). Для тестирования регулярных выражений можно воспользоваться сервисом [Regex101](https://regex101.com).

Рассмотрим как можно применять теги на реальных примерах.

**Пример 1**

Рассмотрим сценарий, в котором транспортная компания доставляет продукты питания и напитки мелким оптом.
Некоторые из продуктов питания необходимо доставлять строго в изотермических грузовиках.
При этом, все напитки и часть товаров из группы продуктов питания может быть доставлена без холодильников.
В дополнение, часть из клиентов может принять груз только если автомобили оборудованы гидробортом.

Для определения таких ограничений заказов укажем в поле `location.required_tags` следующие теги:

- `TAIL_LIFT` - для заказов которые могут быть разгружены только если автомобиль оборудован гидробортом.
- `ISOTHERMAL_TRUCK` - для заказов, содержащих товары, которые требуют перевозки с соблюдением температуры.
- `NORMAL_TRUCK` - для заказов, не имеющих товаров со специальными условиями перевозки.

Для определения возможностей автомобилей, используем следующие теги в поле `vehicle.tags`:

- `TAIL_LIFT` - для автомобилей, оснащенных гидробортом.
- `ISOTHERMAL_TRUCK` - для автомобилей, оснащенных изотермическим фургоном.
- `NORMAL_TRUCK` - для обычных автомобилей без изотермического фургона.

{% note %}

Обратите внимание, что автомобиль при этом может иметь как один так и несколько тегов, или не иметь их вообще,
в зависимости от его реальной конфигурации. Это же правило касается и тегов заказов.

{% endnote %}

**Пример 2**

Рассмотрим сценарий, в котором доставка осуществляется строго по зонам внутри города. При этом существует
правило, по которому некоторые машины могут выполнять маршруты только внутри определенных зон.

Для реализации такого сценария, укажем в поле `location.required_tags` соответствие заказов внутри города зонам.
Определим 50 зон для разных географических районов с именами тэгов `ZONE_1` ... `ZONE_50`, и назначим их заказам.

Далее, возникает необходимость указать, в каких зонах может работать тот или иной автомобиль.

Например Автомобилю 1 может быть разрешена работа в зонах 20-30 и 30-39, но запрещена работа во всех остальных зонах:

- поле `vehicle.tags` должен иметь значение `ZONE_((2|3)[0-9])$`.
- поле `vehicle.excluded_tags` должно иметь значение `ZONE_([0-9]|[1][0-9]|[4-9][0-9])$`.

**Пример 3**

Рассмотрим сценарий, в котором в некоторых заказах есть ограничение по высоте кузова для автомобиля.

Например, есть заказы, у которых ограничение по высоте кузова составляет 2 метра, 2,3 метра и 2,5 метра. В таком случае у них должны быть соответствующие теги: Max_200, Max_230, Max_250.

На машинах теги необходимо проставлять более сложным образом, поскольку машина высотой до 2 метров может доставить любые заказы, а машина высотой 2,8 метра – далеко не все заказы. То есть, если использовать только tags, то при высоте машины:

- до 2 метров в поле vehicle.tags будут все значения Max_200, Max_230, Max_250;
- от 2 до 2,3 метра в поле vehicle.tags будут значения Max_230, Max_250;
- от 2,3 до 2,5 в поле vehicle.tags будет значение Max_250;
- более 2,5 метров – поле vehicle.tags будет пустым.

## Опциональные теги

Иногда при планировании нужно учитывать, какие ТС желательно использовать (или не использовать) для определенных заказов. Например, в некотором районе доставлять заказы может быть эффективнее с водителем, который хорошо знаком с этой частью города.

Для таких необязательных требований предназначены опциональные теги, которые перечисляются в поле `location.optional_tags`. Допускается нарушение заданных предпочтений, если их нельзя удовлетворить (например, из-за ограничений по весу или времени доставки). Этим опциональные теги отличаются от [требуемых характеристик ТС](https://yandex.ru/routing/doc/vrp/concepts/properties-of-orders.html?lang=ru#sovmestimost-zakaza-i-avtomobilei).

Приоритет предпочтений регулируется с помощью веса тега `location.optional_tags.value`. Его значение может быть как положительным, так и отрицательным. При планировании опциональный тег сравнивается с [тегами машины](https://yandex.ru/routing/doc/vrp/concepts/properties-of-vehicles.html#tegi-avtomobilia), на которой выполняется заказ. Если тег из `location.optional_tags` совпал с тегом ТС в списке:

- `vehicle.tags`, то `value` вычитается из стоимости маршрута;

- `vehicle.excluded_tags`, то `value` прибавляется к стоимости маршрута.

Значение, которое опциональные теги добавляют к стоимости маршрута, возвращается в поле `result.routes.metrics.total_optional_tags_cost` (может быть отрицательным).

**Пример 1**

Дано 10 заказов: для семи точек задан опциональный тег `yug`, для трех — `sever`. Вес каждого тега равен `100`. Доставку выполняют два водителя: у одного в поле `vehicle.tags` указано `sever`, у второго — `yug`.

В результате основная часть заказов запланирована с учетом заданных предпочтений. Однако два из семи «южных» заказов переданы водителю с тегом `sever`: в машину с характеристикой `yug` они не поместились.

В метрике маршрутов `total_optional_tags_cost` возвращаются значения `-300` и `-500`. Это означает, что благодаря учтенным пожеланиям стоимость маршрутов сократилась на 300 и 500 единиц соответственно.

[Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/9a8bbc3f-b236841c-602890a2-c60c8a58) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/9a8bbc3f-b236841c-602890a2-c60c8a58) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#9a8bbc3f-b236841c-602890a2-c60c8a58)

**Пример 2**

Дано 10 заказов: для шести из них задан опциональный тег `vip`. Его вес на разных точках варьируется от `100` до `350`.

У одного из ТС тег `vip` определен в поле `vehicle.excluded_tags`. Таким образом указано, что этому водителю лучше не поручать заказы с тегом `vip`.

В итоге требование в большинстве случаев нарушено не было: пять из шести vip-заказов доставляет водитель без ограничения по тегу `vip`.

Но один vip-заказ был запланирован на машину с тегом `vip` в `excluded_tags` — из-за ограничения по вместимости. В поле `total_optional_tags_cost` этого маршрута возвращается значение `100`: использование «нежелательного» ТС увеличило стоимость на 100 единиц. Предпочтение было нарушено для заказа c наименьшим весом `location.optional_tags.value`.

[Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/46913b47-342d0189-3fa2d93f-433a2913) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/46913b47-342d0189-3fa2d93f-433a2913) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#46913b47-342d0189-3fa2d93f-433a2913)



## Режим маршрутизации

При построении маршрутов, по умолчанию предполагается что курьер использует для доставки легковой автомобиль (грузоподъемность меньше 2.5 тонн). Доставку грузов пешком, на грузовом автомобиле или с помощью общественного транспорта можно отразить с помощью параметра `vehicle.routing_mode`. Если все курьеры выполняют доставку одним способом, можно использовать [опцию маршрутизации](routing-mode.md) `options.routing_mode`.

Возможные значения:

* `driving` - режим по умолчанию, маршрутизация для автомобилей с грузоподъемностью меньше 2.5 тонн;
* `truck` - маршрутизация для автомобилей с грузоподъемностью от 2.5 тонн. При планировании в этом режиме учитывается [грузовой каркас](https://www.mos.ru/dt/function/gruzovaia-logistika/gruzovoi-karkas/) для Москвы;
* `walking` - маршрут с пешеходным профилем. В маршруте используются только на дороги, по которым может ходить пешеход;
* `transit` - маршрут с использованием общественного транспорта и перемещением пешком от остановки до точки доставки.


**Пример 1**

В примере ниже используется режим маршрутизации `transit` для всех курьеров. В результате курьеры выполняют доставку на общественном транспорте и заказы распределены оптимально для них.

[Пример Excel](https://courier-admin.s3.yandex.net/doc-examples/example-routing_mode1.xlsx) ⋅ [Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/821db8c8-61eaec13-22c23cc0-7e7fc3ba) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/821db8c8-61eaec13-22c23cc0-7e7fc3ba) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#821db8c8-61eaec13-22c23cc0-7e7fc3ba)

{% note %}

В построенных маршрутах пробег указан только для расстояний, которые курьер ходит пешком. Расстояния, покрытые в общественном транспорте, учитываются для оптимизации, но не указываются в метриках.

{% endnote %}

**Пример 2**

В примере ниже используется режим маршрутизации `transit` для одного курьера, и `driving` для другого курьера. Заказы распределены между курьерами так, чтобы автомобиль выполнял доставку в точки, более удаленные от остановок общественного транспорта или друг от друга.

[Пример Excel](https://courier-admin.s3.yandex.net/doc-examples/example-routing_mode2.xlsx) ⋅ [Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/378591de-513421d5-180c6c05-d97e970d) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/378591de-513421d5-180c6c05-d97e970d) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#378591de-513421d5-180c6c05-d97e970d)

## Режим работы курьера

По умолчанию при построении маршрута не планируется остановок кроме необходимых для доставки грузов. Однако часто курьеры не работают без остановок - им нужно останавливаться на обеденный перерыв, который необходимо учитывать при построении маршрутов. Также, на дальних рейсах есть требования соблюдения режима труда и отдыха, когда водитель обязан останавливаться после определенного времени движения.

Режим работы курьера в Маршрутизаторе можно задать с помощью опции `rest_schedule.breaks`. В этой опции задается массив перерывов, которые обязан взять курьер. В поле `rest_duration_s` указывается длина отдыха, а в поле `work_time_range_till_rest` - длительность работы курьера до отдыха.

{% note %}

Остановки указываются последовательно. Если маршрут закончен до наступления остановки (например, маршрут выполнен за 3 часа, а остановка запланирована через 4), то все невыполненные остановки сбрасываются.

{% endnote %}

В некоторых случаях Маршрутизатор может планировать маршруты с нарушением окна отдыха. Чтобы начислять штрафы за эти нарушения, используйте поля `penalty.late` и `penalty.early`. Если штраф выше, чем полученная от нарушения окна экономия, то маршрут будет запланирован без нарушений.

**Пример 1**

В этом примере построен маршрут с перерывом на обед через 4-5 часов работы. В результате Маршрутизатор планирует остановку на обед для выполняющего доставку курьера.

[Пример Excel](https://yandex.ru/courier/s3/doc-examples/mvrp-example-breaks1.xlsx) ⋅ [Запрос API](https://courier.yandex.ru/vrs/api/v1/log/request/53ec7b27-edc80c82-98eff54f-1bd0adb8) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/53ec7b27-edc80c82-98eff54f-1bd0adb8) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#53ec7b27-edc80c82-98eff54f-1bd0adb8)

**Пример 2**

В этом примере построен маршрут между Москвой и Санкт-Петербургом, с первым перерывом через четыре - четыре с половиной часа и затем перерывами каждые два часа. Маршрутизатор выделил два перерыва.

[Пример Excel](https://yandex.ru/courier/s3/doc-examples/mvrp-example-breaks2.xlsx) ⋅ [Запрос API](https://courier.yandex.ru/vrs/api/v1/log/request/f5b7dbe2-c9810576-2cd8415d-911203b2) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/f5b7dbe2-c9810576-2cd8415d-911203b2) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#f5b7dbe2-c9810576-2cd8415d-911203b2)


## Запланированный маршрут

Заранее запланированные заказы можно назначить транспортному средству. При этом запланированный маршрут сохраняется. Чаще всего это используется для [допланирования](https://yandex.ru/routing/doc/vrp/concepts/additional-planning.html), но может потребоваться и в других ситуациях, когда заказ обязательно должен быть привязан к данному транспортному средству.

Для указания ранее спланированных в данное транспортное средство заказов используется опция `vehicle.planned_route`.
Опция обладает следующими свойствами:

-	Все заказы, указанные в `vehicle.planned_route`, при планировании не могут попасть нераспределенные, даже если будут нарушены жесткие ограничения – вместимость машины или временные окна, у которых `hard_window` = `true`;
-	Последовательность заказов, определенная в `planned_route`, не фиксируется, то есть при повторном планировании, заказы могут перестроиться в новой последовательности.

Для каждого заказа, определенного `planned_route`, обязательно указывать принадлежность к смене машины (даже если у машины 1 смена).

**Пример 1**

У каждого из 2-х курьеров в `planned_route` были определены заказы, в итоге они так и попали на каждого из курьеров.

[Пример Excel](https://courier-admin.s3.yandex.net/doc-examples/planned_route_пример_1.xlsx) ⋅ [Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/6aa1d440-bff2d49-b86afbee-1900f44f) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/6aa1d440-bff2d49-b86afbee-1900f44f) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#6aa1d440-bff2d49-b86afbee-1900f44f)

**Пример 2**

В данном примере участвует 1 машина, на которую привязаны заказы через `planned_route`. Суммарный вес заказов превышает вместимость машины, но такой маршрут все равно планируется (поскольку заказы, определенные в этой опции, не могут попасть в нераспределенные), при этом статус задачи будет `UNFEASIBLE`.

[Пример Excel](https://courier-admin.s3.yandex.net/doc-examples/planned_route_пример 2.xlsx) ⋅ [Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/bbdfd67f-24b1190e-3e0a9aed-9b9ded7b) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/bbdfd67f-24b1190e-3e0a9aed-9b9ded7b) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#bbdfd67f-24b1190e-3e0a9aed-9b9ded7b)

## Корректировка времени движения автомобиля

Для расчета скорости автомобиля при построении маршрута используются данные Яндекс карт о пробках и указанная в запросе скорость. Однако часто полуается так, что грузовики движутся по пробками медленнее, а некоторые водители водят более агрессивно и приезжают раньше расчетных значений.

Чтобы компенсировать такие отклонения, в Маршрутизаторе есть опция `travel_time_multiplier`, в которой можно указать дробное значение. При значении 1 расчет будет произведен для автомобиля с ожидаемой средней скоростью. При меньших значениях (например, 0.8), расчет будет для более быстрых автомобилей, при больших (например, 1.2) - для более медленных.

{% note %}
Параметр `travel_time_multiplier` влияет только на скорость движения автомобиля. Время обслуживания на точке доставки остается прежним.
{% endnote %}

**Пример 1**

В примере ниже запрос на маршрутизацию отправлен без корректировки времени движения. В результате автомобиль выполняет доставку за 3 часа 52 минуты, из которых 3 часа 12 минут уходит на перемещение между точками.

[Пример Excel](https://courier-admin.s3.yandex.net/doc-examples/example-travel_time_mult1.xlsx) ⋅ [Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/a89ffe9d-beddcb8b-328f16a7-a7cabec2) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/a89ffe9d-beddcb8b-328f16a7-a7cabec2) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#a89ffe9d-beddcb8b-328f16a7-a7cabec2)

**Пример 2**

В примере ниже на маршрутизацию отправлен тот же запрос, что и в примере 1, но со значением параметра `travel_time_multiplier` в 0.5. В построенном маршруте курьер выполняет достаку за 2 и 15 минут часа, и тратит 1 час и 35 минут на перемещение между точками. При этом 40 минут, потраченные на парковку и передачу товара, остаются неизменными.

[Пример Excel](https://courier-admin.s3.yandex.net/doc-examples/example-travel_time_mult2.xlsx) ⋅ [Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/aa5373a0-de560632-4944c2a9-ef4d9caa) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/aa5373a0-de560632-4944c2a9-ef4d9caa) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#aa5373a0-de560632-4944c2a9-ef4d9caa)

**Пример 3**

В примере ниже на маршрутизацию отправлен тот же запрос, что и в примере 1, но со значением параметра `travel_time_multiplier` в 2. В построенном маршруте курьер выполняет достаку за 7 часов и 1 минуту, из которых 6 часов и 21 минута уходит на перемещение между точками. На перемещение уходит больше чем в 2 раза больше времени чем в маршруте в первом примере, потому что часть построенного маршрута на час пик и автомобиль не может использовать максимальную скорость. На парковку и передачу товара все еще уходит 40 минут.

[Пример Excel](https://courier-admin.s3.yandex.net/doc-examples/example-travel_time_mult3.xlsx) ⋅ [Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/c79090eb-d3ced747-1e1cdd36-fbd5cda) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/c79090eb-d3ced747-1e1cdd36-fbd5cda) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#c79090eb-d3ced747-1e1cdd36-fbd5cda)

## Корректировка времени обслуживания

Курьеру при доставке заказа нужно потратить время, чтобы его передать. В это время включается парковка, подъем на лифте, передача доставки и оформление бумаг. В Маршрутизаторе это обеспечивается полями `service_duration` и `shared_service_duration` у заказов. Однако, некоторые курьеры передают товар быстрее чем другие. Например:

* При одновременном планировании для автомобилей и курьеров на общественном транспорте, курьеры которые передвигаются общественным транспортом не тратят время на парковку. В результате им нужно меньше времени на обслуживание.
* У курьеров может быть разный уровень квалификации. Опытные курьеры обычно тратят меньше времени на передачу заказа.

Чтобы компенсировать разницу между временем работы курьеров, в Маршрутизаторе есть опции `service_duration_multiplier` и
`shared_service_duration_multiplier`, влияющие на длину обслуживания конкретным курьером. При значении 1 время обсуживания будет совпадать с указанным в поле `service_duration` или `shared_service_duration`, при значениях меньше 1 время обслуживания будет меньше, а при значениях больше 1 - больше.

{% note %}
Параметры `service_duration_multiplier` и `shared_service_duration_multiplier` влияют только на время обслуживания. Время перемещения между точками остается прежним.
{% endnote %}

**Пример 1**

В примере ниже запрос на маршрутизацию отправлен без корректировки времени обслуживания.

[Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/b6fea347-a57c020a-9ba2b6f5-32954962) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/b6fea347-a57c020a-9ba2b6f5-32954962) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#b6fea347-a57c020a-9ba2b6f5-32954962)

**Пример 2**

В примере ниже на маршрутизацию отправлен тот же запрос, что и в примере 1, но со значением параметра `service_duration_multiplier` в 0.5. Обслуживание заказов в расчете занимает вполовину меньше времени по сравнению с примером 1.

[Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/7436f808-232dcbd9-2ca64117-864b3834) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/7436f808-232dcbd9-2ca64117-864b3834) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#7436f808-232dcbd9-2ca64117-864b3834)

**Пример 3**

В примере ниже на маршрутизацию отправлен тот же запрос, что и в примере 1, но со значением параметра `service_duration_multiplier` в 2. Обслуживание занимает вдвое больше времени по сравнению с примером 1.

[Запрос API (JSON)](https://courier.yandex.ru/vrs/api/v1/log/request/6d8c9c1f-b899be6e-55cbba0d-2f1b03c7) ⋅ [Ответ API](https://courier.yandex.ru/vrs/api/v1/result/6d8c9c1f-b899be6e-55cbba0d-2f1b03c7) ⋅ [Открыть на карте](https://courier.yandex.ru/mvrp-map#6d8c9c1f-b899be6e-55cbba0d-2f1b03c7)



<p class="p"><a href="feedback.html" class="xref button">Написать в службу поддержки</a></p>
