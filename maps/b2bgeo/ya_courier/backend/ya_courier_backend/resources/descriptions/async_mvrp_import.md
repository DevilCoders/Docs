# Async MVRP import

https://st.yandex-team.ru/BBGEO-13426

# Принятые решения

1. Пока не трогаем check-import-task:
    * с этой ручкой пока что нет проблем с таймингами согласно данным клиентов или графикам: https://yasm.yandex-team.ru/chart/signals=%7Bquant(unistat-times-mvrpcheckimporttaskresource_dhhh,99),quant(unistat-times-mvrptaskimportresource_dhhh,99)%7D;hosts=ASEARCH;itype=maps;ctype=prestable,stable;prj=maps-b2bgeo-courier/?from=1646748660000&to=1647353460000
    * она по своей сути является более простой ручкой, которая не требует такого количества действий от бэкенда
    * в будущем её можно перевезти на async подход независимо
2. Не используем подход sync/async API изначально, но оставляем для этого возможность (когда API возвращает 202 или 200 в зависимости от сложности изначальной задачи):
    * импорт - это ручная операция, вряд ли мы сильно нагрузим async-задачами наш сервер
    * лучше иметь что-то рабочее быстрее
    * оставляем возможность, то есть в спецификации напишем, что ручка может вернуть 202, чтобы потом можно было это поменять, когда возникнет такая необходимость.
3. Не сразу трогаем import-routes:
    * import-routes отличается от `mvrp_task` в основном тем, что поддерживает `route_numbers`, заданные в excel
    * пока что import-routes выдерживает текущую нагрузку, но я бы потом подумал на тему того, чтобы передавать в тело запроса `vrs-import` как раз такие `route_numbers`, а в остальном продолжал работать бы через `vrs-import`
    * это скорее костыль, поэтому хочется полностью на фронт его перенести (именно посылка задача в солвер с `solver_time_limit=0`)
4. Назвал это `vrs-import`:
    * не mvrp, потому что мы и svrp умеем, а вместе это всё называется vrs
    * в будущем сделал бы `check-import-routes` по пути `GET /api/v1/companies/<company_id>/vrs-import/conflicts`
5. Разделил все флаги/режимы на 2 настройки - режим решения конфликтов для маршрутов и режим решения конфликтов для заказов
    * это ближе к тому как показывает информацию фронт
    * это позволяет более структурировано смотреть на API
    * это ближе к тому, как мы выдаем конфликты в check-import-routes (хоть мы и не называли раньше это "конфликтом")
6. Импортированные маршруты будут отдаваться в отдельной ручке если они действительно нужны:
    * это позволит в будущем туда добавить `page/per_page`
    * это разделяет поллинг от получения результата, что правильно с точки зрения разделения ответственности


# Use-cases

Описана текущая работа, новый вариант отличается только тем, что спиннер будет крутиться на асинхронном вызове, а не на синхронном.

1. Импорт решения из планирования: https://yandex.ru/courier/companies/6/depots/all/mvrp/1873ed34-750e6c7f-2a31d5e0-3b5151be (Кнопка "Экспортировать"):
    * Фронт создает новую задачу с новым uuid и `solver_time_limit: 0`, которая учитывает все изменения, сделанные вручную логистом
    * Посылает эту задачу в check-import-task
    * В результате check-import-task, получаются некоторые конфликты, которые пользователь может исправить выбором опций импорта
    * Можно выбрать как исправить конфликты по маршрутам (работают `add-all`, `replace-all`, `replace-not-started`)
    * Можно выбрать как исправить конфликты по заказам (работает только `rename_existing_orders`)
    * Можно выбрать начальный статус заказов
    * Появляется окошко со спиннером и происходит импорт через `mvrp_task`
2. Импорт маршрутов из excel:
    * Фронт переводит excel в задачу для солвера
    * Посылает эту задачу в check-import-task
    * В результате check-import-task, получаются некоторые конфликты, которые пользователь может исправить выбором опций импорта
    * Можно выбрать как исправить конфликты по маршрутам (работают `replace-all`, `replace-not-started`)
    * Можно выбрать как исправить конфликты по заказам (работают `update-orders`, `rename_existing_orders`)
    * Фронт посылает эту задачу в `import-routes`
    * Мы выфилтровываем доп. параметры из задачи, которыe позволяют задавать номера маршрутов.
    * Мы сами проставляем `solver_time_limit: 0` в `import-routes` при посылке задачи в солвер


# API
### POST /api/v1/companies/<company_id>/vrs-import

#### Формат запроса

**Параметры запроса**
| название | тип | текущее название аналога | описание |
|---|---|---|---|
| `task_id` | uuid | `task_id` | UUID задачи из солвера |
| `original_task_id` | uuid | | (смотри BBGEO-13577)  UUID изначальной задачи |
| `order_status` | enum | `initial-status` | начальный статус заказа:<br>- `new`<br>- `confirmed` |
| `route_conflict_mode` | enum | `import-mode/keep-routes` | как решать конфликты по маршрутам:<br>- `no_conflict` - взрываемся при конфликте, сейчас такого нет, по умолчанию умеем переименовывать <br>- `replace_all` - аналог `keep-routes=False, import-mode=by-keep-routes` или `import-mode=replace_all`<br>- `replace_not_started` - аналог `import-mode=replace-not-started` <br>- `rename_new` - аналог `add-all` или `keep-routes=None, import-mode=by-keep-routes` |
| `order_conflict_mode` | enum | `update-orders/rename_existing_orders` | как решать конфликты по заказам:<br>- `no_conflict` - взрываемся при конфликте, аналог `add-all`<br>- `rename_new` - аналог `rename_existing_orders`<br>- `move_existing` - аналог `update-orders=true` |

#### Формат ответа

**Ответ**
| название поля | тип | описание |
|---|---|---|
| `id` | string | идентификатор импорта в системе |
| `status` | enum | статус импорта:<br>- `running`<br>- `completed`<br>- `error`<br>- `internal_error` |
| `message` | string | описание состояния импорта |

**Пример**
HTTP 202
```
{
    "id": "8e75af95-0265-4ebe-ac61-de311688d66e",
    "status": "running",
    "message": "Task is running"
}
```

#### Коды ответа

| код ответа | |
|---|---|
| 200 | Задача импорта сразу может быть завершена, возвращается result |
| 202 | Задача импорта создана |
| 400 | Невалидные параметры запроса |
| 401 | Невалидный OAuth-token |
| 403 | Запрос запрещен для текущего пользователя |
| 422 | Задача не может быть импортирована |
| 500 | Внутренняя ошибка |


### GET /api/v1/companies/<company_id>/vrs-import/<import_id>

#### Формат ответа

**Ответ**
| название поля | тип | описание |
|---|---|---|
| `id` | string | идентификатор импорта в системе |
| `status` | enum | статус импорта:<br>- `running`<br>- `completed`<br>- `error`<br>- `internal_error` |
| `message` | string | описание состояния импорта |

**Пример**
HTTP 200
```
{
    "id": "8e75af95-0265-4ebe-ac61-de311688d66e",
    "status": "completed",
    "message": "Task is completed"
}
```

#### Коды ответа

| код ответа | |
|---|---|
| 200 | Успешно получен статус |
| 400 | Невалидные параметры запроса |
| 401 | Невалидный OAuth-token |
| 403 | Запрос запрещен для текущего пользователя |
| 404 | Задачи импорта не существует |
| 500 | Внутренняя ошибка |

### GET /api/v1/companies/<company_id>/vrs-import/<import_id>/result

#### Формат ответа

**Ответ**
| название поля | тип | описание |
|---|---|---|
| `routes` | array | |
| `routes[].id` | string | id импортированного маршрута |


**Пример**
HTTP 200
```
{
    "routes": [ { "id": "1" } ]
}
```

#### Коды ответа

| код ответа | |
|---|---|
| 200 | Успешно получен результат |
| 400 | Невалидные параметры запроса |
| 401 | Невалидный OAuth-token |
| 403 | Запрос запрещен для текущего пользователя |
| 404 | Результата пока/совсем нет |
| 500 | Внутренняя ошибка |
