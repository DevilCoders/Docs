# Синхронизация со Стартреком
## Описание
Воркер создаёт тикеты в Стартреке для каждой задачи обхода помещений, синхронизирует статус и исполнителя, а также создаёт головные тикеты для каждой схемы помещения, которые являются родительскими к тикетам на обход. Запуск производится по крону каждые 5 минут, начиная с 1 минуты часа (12:01, 12:06 etc.) с расчётом на то, что перед этим отработает task-activator-cron-job, который переводит задания из статуса pending в available.


## Отображаемая информация
### Головной тикет
* Название тикета: `<Город>: <Название ТЦ>`. Город берётся из протобуфа адреса, название ТЦ - из поля `ugc.task_name.value`
* Описание:
    * Адрес - из обратного геокодирования по координатам (ugc.task.geom)
    * Ссылка на nmaps по координатам (`ugc.task.geom`)
    * Ссылка на nmaps по id объекта (`ugc.task.indoor_plan_id`)
* Теги:
    * `nmaps:<object_id>`
    * `head`

### Обычный тикет
* Название тикета: `<Город>: <Название ТЦ>`
* Описание:
    * Адрес
    * Ссылка на nmaps по координатам
    * Ссылка на nmaps по id объекта
* Дата начала: дата, когда задание будет доступно (`ugc.task.done_at` и `ugc.task.interval`, см. radiomap-capturer-admin/task-activator-cron-job)
* Теги:
    * `nmaps:<object_id>`
    * `id:<task_id>`
* OEBS: длительность операции (`ugc.task.distance`)
* Арбитраж: ID заказа (`ugc.task.task_id`)
* Статус: `ugc.task.status`
    * `pending` - Открыт
    * `available` - Будем делать
    * `acquired` - В работе
    * `done` - Решён
    * `cancelled` - Закрыт/Не будет исправлено


## База данных
### `ugc.startrek_epics`
Соответствие между `object_id` схемой помещения и её головным тикетом в Стартреке
| **Column** | **Type** | **Description** |
| ---------- | -------- | --------------- |
| `indoor_plan_id` | text | id схемы помещений как объекта nmaps |
| `startrek_ticket` | text | Ключ головного тикета в Стартреке |

### `ugc.startrek_tickets`
Соответствие между задачей обхода помещения и тикетом в Стартреке и его состоянием
| **Column** | **Type** | **Description** |
| ---------- | -------- | --------------- |
| `task_id` | bigint | id задачи на обход |
| `startrek_ticket` | text | Ключ тикета в Стартреке |
| `status` | ugc.task_status | Статус задачи, обработанный воркером и установленный в тикете |
| `start_date` | timestamp | Дата начала, выставленная в тикете воркером |


## Процесс
Синхронизация проходит в три этапа:
1. Создаются новые тикеты, которых нет в базе.
2. Синхронизируется статус при нахождении несоответствия между фактическим состоянием задачи и хранимым состоянием тикета.
3. Вычисляется и выставляется дата начала для задач, где это возможно и ещё не сделано.

### Создание новых тикетов
Воркер собирает информацию обо всех необработанных задачах, т.е. тех, которых нет в таблице `ugc.startrek_tickets`. Для каждой задачи создаётся головной тикет, если необходимо, а затем создаётся тикет на обход в соответствии с описанной выше схемой отображаемой информации.

### Синхронизация статуса и исполнителя
Воркер ищет задачи с расхождениями между фактическим состоянием (`ugc.task.status` и `ugc.assignment.assigned_to`) и сохранённым состоянием тикета (`ugc.startrek_tickets.status` и `ugc.startrek_tickets.assignee` соответственно). При наличии расхождения производится коррекция тикета и скорректированное состояние сохраняется в таблицу `ugc.startrek_tickets`).

### Обновление даты начала
Сначала воркер для каждой схемы помещений ищет последнюю завершённую задачу (с максимальным `done_at`). Далее проходит по всем задачам со статусом `pending` и невыставленной `start_date` и вычисляет для них `start_date` как сумму `done_at` для текущей схемы помещений и `interval` этой задачи. После выставления даты в тикет воркер записывает вычисленную `start_date` в `ugc.startrek_tickets`.
