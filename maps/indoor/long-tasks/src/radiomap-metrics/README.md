# Расчёт метрик качества радиокарт

Воркер indoor-radiomap-metrics запускается раз в сутки перед восстановлением позиций маяков и рассчитывает:
- Качество радиокарт на основе данных из тестовых обходов
- Оптимальный вес, с которым в `LBS`-решение добавляется в `indoor-posioning`-решение
- Агрегированные метрики качества по каждому объекту с учётом оптимального провайдера на каждом этаже

Ядром воркера является библиотека [radiomap-metrics](https://a.yandex-team.ru/arc/trunk/arcadia/maps/indoor/libs/radiomap_metrics), сам воркер представляет собой обвязку вокруг библиотеки и БД, которая подбирает нужные тестовые обходы, запускает расчёты и сохраняет результаты в базу.

Аналогичной функциональностью обладают запускаемые вручную тулзы:
- [radiomap-metrics-tool](https://a.yandex-team.ru/arc/trunk/arcadia/maps/indoor/tools/radiomap-metrics-tool)
- [optimal-lbs-fuse-coefficient-tool](https://a.yandex-team.ru/arc/trunk/arcadia/maps/maps/indoor/tools/optimal-lbs-fuse-coefficient-tool)
Только в отличие от воркера тулзы отображают результаты работы на экране, не сохраняя их в базу.

Воркер выбирает для расчётов обходы из таблицы ugc.task, удовлетворяющие условиям:
- Задание успешно завершено
- Задание является тестовым
- У задания не выставлен флаг `skip_evaluation`
- По этому заданию ранее не запускались расчёты качества радиокарт

Одно задание является обходом по одному плану помещения. На плане как правило несколько этажей, для каждого этажа запускается в общей сложности 9 расчётов, по одному на каждую возможную пару `тип устройства` (android, android-old, ios) x `провайдер` (indoor, lbs, fused01, fused05, fused09).

## Метрики точности позиционирования

 Результат каждого расчёта записывается отдельной записью в таблицу `ugc.radiomap_metrics`:
- `radiomap_metrics_id` — инкрементальный ключ
- `assignment_done_at` — время завершения обхода
- `indoor_plan_id` — id плана в Народной карте
- `assignment_id` — id ассайнмента со статусом `completed` в рамках данного обхода, вспомогательное поле
- `device_type` — тип эмулируемого устройства, используемого для позиционирования
- `provider` — тип провайдера позиционирования
- `indoor_level_universal_id` — id этажа
- `error_0_9m` — доля площади этажа в процентах, на которой ошибка позиционирования составляет менее 10 метров
- `error_10_19m` — доля площади этажа в процентах, на которой ошибка позиционирования составляет от 10 до 20 метров
- `error_20_49m` — доля площади этажа в процентах, на которой ошибка позиционирования составляет от 20 до 50 метров
- `error_50_99m` — доля площади этажа в процентах, на которой ошибка позиционирования составляет от 50 до 100 метров
- `error_100m` — доля площади этажа в процентах, на которой ошибка позиционирования составляет более 100 метров
- `no_solution_area_percent` — доля площади этажа в процентах, на которой провайдер не смог произвести позиционирование
- `uncovered_ground_truth` — доля площади этажа в процентах, на которой отсутствует ground truth
- `duration` — продолжительность обхода этажа в секундах
- `time_to_first_fix` — среднее время до первого успешного позиционирования от начала работы провайдера в секундах
- `level_hit_time` — время в секундах, в течение которого этаж был определён верно
- `level_miss_time` — время в секундах, в течение которого этаж был определён неверно
- `level_switch_count` — количетво переключений этажа
- `no_solution_time` - время в секундах, в течение которого провайдер не смог произвести позиционирование
- `percentile_50` — 50-й процентиль ошибки позиционирования
- `percentile_75` — 75-й процентиль ошибки позиционирования
- `percentile_90` — 90-й процентиль ошибки позиционирования
- `percentile_95` — 95-й процентиль ошибки позиционирования

Аналогично, агрегированные метрики записываются в похожую таблицу `ugc.aggregated_radiomap_metrics`.

## Оптимальный `lbs-fuse` коэффициент

На основании каждого обхода индора для каждого его уровня определяется оптимальный коэффициент, с которым в `indoor-positioning` подмешивается `lbs`-решение.

Для каждого этажа каждого индора коэффициент определяется отдельно и вносится в табличку `ugc.optimal_lbs_fuse_coefficient`:
- `id` - инкрементальный ключ
- `indoor_plan_id` - идентификатор индор-плана
- `indoor_level_universal_id` - универсальный идентификатор уровня в индоре
- `assignment_id` - идентификатор ассайнмента, для которого был посчитан коэффициент
- `value` - значение оптимального коэффициента
- `added_at` - дата внесения коэффициента в базу

Актуальным для уровня в индоре считается коэффициент, рассчитанный для последнего (максимального) `assignment_id`. Актуальные `lbs-fuse`-коэффициенты заносятся в табличку `ugc.lbs_fuse_coefficient`:
- `lbs_fuse_coefficient_id` - инкрементальный айдишник коэффициента
- `indoor_plan_id` - идентификатор индор-плана
- `indoor_level_universal_id` - универсальный идентификатор уровня в индоре
- `value` - значение актуального коэффициента
