# Менеджмент заданий для обходов ТЦ

## Общая информация

Для каждого ТЦ, где предполагается наличие indoor позиционирования, требуется
уметь создавать задания для обхода, проверять как идет процесс выполнения заданий
и иметь возможность посмотреть на уже восстановленные маяки.

## Сервис indoor-radiomap-capturer-admin:

### Список endpoint'ов для общения фронтенда с сервисом:

Все HTTP-запросы должны в обязательном порядке содержать следующие заголовки
для аутентификации:
 * X-Ya-Service-Ticket;
 * X-Ya-User-Ticket.

В случае успешного запроса сервис возвращает 200 OK. В случае ошибки сервис
возвращает код, отличный от 200. При этом тело ответа содержит сообщение об
ошибке в формате `Content-Type: text/plain`.

### Запрос на создание новых заданий для данного ТЦ

```
POST /indoor/tasks/generate?indoor_plan_id=123&name=Афимолл&ll=37.719065,55.609357[&intervals=2,1,3,4]
Content-Type: application/x-protobuf
X-Ya-Service-Ticket: ...
X-Ya-User-Ticket: ...
```

Параметры:
 * `indoor_plan_id` - идентификатор ТЦ;
 * `name` - название ТЦ;
 * `ll` - широта,долгота точки, соответствующей ТЦ;
 * `intervals` - опциональный временной интервал **в сутках** между временем активации заданий.

В результате выполнения запроса будут созданы `size(intervals)` новых заданий для
обходов ТЦ с заданной геометрией маршрутов. Все созданные задания попадают в
очередь 'pending' --- заданий, ожидающих активации. Активация `i`-го ожидающего
задания наступает по прошествии `intervals[i]` суток с момента завершения
предыдущего задания для данного ТЦ. В случае, если предыдущих заданий для ТЦ нет
либо они завершены раньше, чем `intervals[i]` суток назад, задание активируется
сразу же.

**Замечание.** Перед некоторыми интервалами в поле `intervals` может стоять символ `t` или `T`.
В этом случае, соответствующее задание не будет использоваться в процедуре восстановления маяков,
но будет использоваться для оценки качества восстановления маяков для данного `indoor_plan_id`.
Например: `intervals=1,1,1,T1,1,1`. В данном случае 4-ое задание для восстановления маяков использоваться не будет.

В заголовках запроса вернется `X-Ya-Sync-Token`. Его необходимо использовать в запросе не получение статистики.

Соответственно, для запроса, приведенного выше, будет создано 4 новых задания с
интервалами активации 2, 1, 3, 4 дней соответственно.

**Замечание.** Если параметр `intervals` не указан, то это эквивалентно
заданию `intervals=0`. В результате будет создано одно задание, которое будет
активировано сразу, как только будет завершено предыдущее задание.

Тип запроса: `Content-Type: application/x-protobuf`

Формат тела запроса: `yandex.maps.proto.common2.geo_object.GeoObject`

Пример тела запроса:
```
geo_object {
    metadata {
        [yandex.maps.proto.mrc.indoor.TASK_PATH_METADATA] {
            indoor_level_id: "1"
        }
    }
    description: "1 этаж, правое крыло"
    geometry {
        polyline {
            lons {
                first: 37347200
                deltas: -215
            }
            lats {
                first: 55691395
                deltas: 1710
            }
        }
    }
}
geo_object {
    metadata {
        [yandex.maps.proto.mrc.indoor.TASK_PATH_METADATA] {
            indoor_level_id: "2"
        }
    }
    description: "2 этаж, правое крыло"
    geometry {
        polyline {
            lons {
                first: 37347200
                deltas: -215
            }
            lats {
                first: 55691395
                deltas: 1710
            }
        }
    }
}
```

### Запрос на отмену всех не взятых в работу заданий для данного ТЦ

```
POST /indoor/tasks/abandon?indoor_plan_id=123
X-Ya-Service-Ticket: ...
X-Ya-User-Ticket: ...
```

Параметры:
 * `indoor_plan_id` - идентификатор ТЦ.

В результате выполнения запроса будут отменены все задания со статусом
`new`, `pending`, относящиеся к данному ТЦ.

### Запрос на получение информации о ходе выполнения заданий для данного ТЦ

```
GET /indoor/tasks/statistics?indoor_plan_id=123[&from_time=123456789&to_time=123459999]
X-Ya-Service-Ticket: ...
X-Ya-User-Ticket: ...
X-Ya-Sync-Token: вернется при запросe `generate`
```

Параметры:
 * `indoor_plan_id` - идентификатор ТЦ;
 * `from_time`, `to_time` - опциональный временной интервал (unix timestamps), за который требуется статистика.

В результате возвращается статистика о ходе выполнения заданий для данного ТЦ,
которая включает:
 * количество новых заданий (в рамках соответствующего временного интервала);
 * количество заданий, взятых в работу;
 * количество выполненных заданий;
 * количество заданий, ожидающих активации (pending);
 * дату последней генерации заданий.

В случае, если указан временной интервал, в статистике учитываются лишь те
задания, время создания которых попадает в данный интервал. В противном случае,
учитываются все задания из БД.

Тип ответа: `Content-Type: application/x-protobuf`

Формат ответа: `yandex.maps.proto.mrc.indoor.TasksStatistics`

Пример ответа:

```
available_tasks_count: 10
acquired_tasks_count: 8
done_tasks_count: 100
pending_tasks_count: 3
last_generate_timestamp: 123456789
```

### Запрос на получение набора восстановленных маяков для данного ТЦ

```
GET /indoor/transmitters/list?x=12&y=15&z=17&indoor_plan_id=123[&indoor_level_id=1][&timestamp=123456789]
X-Ya-Service-Ticket: ...
X-Ya-User-Ticket: ...
```

Параметры:
 * `x, y, z` - координаты тайла для которого запрашивается список восстановленных маяков (минимальный зум 12)
 * `indoor_plan_id` - идентификатор ТЦ;
 * `indoor_level_id` - универсальный идентификатор этажа, для которого запрашивается список восстановленных маяков (опциональный);
 * `timestamp` - опциональная метка времени (unix timestamp), соответствующая времени восстановления маяков.

В результате возвращется список маяков, восстановленных для данного ТЦ.

Если указан идентификатор этажа, то возвращаются маяки, соответствующие данному
этажу ТЦ. В противном случае --- возвращаются все маяки для данного ТЦ.

Если указана метка времени, то возвращается версия радиокарты ТЦ, непосредственно
предшествующая данной метке времени. В противном случае --- возвращается самая
свежая версия радиокарты ТЦ.

Тип ответа: `Content-Type: application/x-protobuf`

Формат ответа: `yandex.maps.proto.mrc.indoor.Transmitters`.

Пример ответа:
```
transmitters {
    id: AA:BB:CC:DD:EE:FF
    indoor_plan_id: 1234554321
    indoor_level_id: 2
    position {
        point {
            lon: 37.719976
            lat: 55.609766
        }
    }
    signal_model_parameters {
        A: 10
        B: -20
    }
    type: 3
}
```
Список таблиц, учавствующих в работе описан тут:
https://arcanum.yandex-team.ru/arc/trunk/arcadia/maps/indoor/radiomap-capturer

## Процедура task-activator-cron-job:
Запускается каждые 5 минут и находит список заданий, которые необходимо активировать
Алогоритм посика:
* Находит все `indoor_plan_id` зданий, для которых нет доступных задач или взятых в работу (статусы `available` и `accuired`)
* Для этих `indoor_plan_id`-ов находит самый старый `pending` и самый свежий `done` таск
* * Если `done` тасков нет - активируем самое старое `pending` задание для данного `indoor_plan_id`
* * Если `done` тасков - проверяет прошел ли необходимый временной интервал для `pending` таска. (Если да, то активирует его)
