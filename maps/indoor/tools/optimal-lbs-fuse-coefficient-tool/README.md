# optimal-lbs-fuse-coefficient-tool

Утилита предназначена для определения оптимальных `lbs-fuse`-коэффициентов по результатам обходов индор-планов.

Утилита не записывает в базу, а только выводит на экран посчитанные значения.

## Общее описание

* По индорам в рамках ассайментов совершаются обходы.

* Ожидается, что обход делается по всем действующим этажам индора.

* По результатам обходов считаются [Метрики качества индор-позиционирования](https://a.yandex-team.ru/arc_vcs/maps/indoor/tools/radiomap-metrics-tool/README.md?rev=713694dd327e3e49ed7731fa316f9b7e92f9c2f4).

* На основе метрик можно определить оптимальное значение `lbs-fuse`-коэффициента для каждого этажа индоров.

* Это делается в рамках [radiomap-metrics](https://a.yandex-team.ru/arc_vcs/maps/indoor/long-tasks/src/radiomap-metrics?rev=713694dd327e3e49ed7731fa316f9b7e92f9c2f4)-воркера

* История вычисленных воркеров значений сохраняется в табличке `ugc.optimal_lbs_fuse_coefficient`.

* Последние новые значения `lbs-fuse`-коэффициентов записываются воркером в табличку `ugc.lbs_fuse_coefficient`.

## Алгоритм определения оптимального `lbs-fuse`-коэффициента

Оптимальный `lbs-fuse`-коэффициент для уровней индора считается для каждого ассайнмента `assignment_id`.

1. Сначала для указанного индор-уровня `indoor_plan_id` из `ugc.radiomap_metrics` загружаются процентили для `N` ассайнментов начиная с `assignment_id` и меньше. Если для индора `N` ассайнментов ещё не накопилось, загружаются все имеющиеся.
1. Для каждого `indoor_level_universal_id` и каждого `provider` процентили агрегируются с использованием линейно взвешенного скользящего среднего. Вес последнего ассайнмента (с наибольшим `assignment_id`) берётся максимальным, для предыдущих асайнментов вес уменьшается. В результате получаем процентили для каждого `provider` для каждого уровня индора.
1. Далее по усреднённым процентилям определяется оптимальный `provider`. Для каждого процентиля с меньших процентов к большим определяется `provider`, ошибка которого наименьшая. Если для некоторого процента процентиль посчитать не получилось ни для одного провайдера, оптимальный `provider` для этого процента остаётся не определённым. Если для индор-уровня не удалось определить оптимальный `provider`, уровень в таблички не попадает.

## Параметры запуска

1. `--config` - Путь до
   [конфига](https://arcanum.yandex-team.ru/arc_vcs/maps/indoor/libs/config/cfg/i-config.development.xml?rev=r8178838)
1.  `--log-level` - уровень логирования
1.  `--assignment-id` - номер ассаймента, для которого есть посчитанные метрики в таблице `ugc.radiomap_metrics`
1.  `--latest-assignment-count` - количество ассайментов для индора, аггрегированные метрики которых будут использоваться для определения оптимального `lbs-fuse`-коэффициента

## Пример запуска

```
./optimal-lbs-fuse-coefficient-tool --config ../..//libs/config/cfg/i-config.production.xml --assignment-id 1703
```

## Пример вывода результатов:

```
Optimal fuse coefficients for indoor_plan_id '3749447850' calculated over 4 latest assignments
	indoor_level_universal_id: '2'	optimalKFuse: 0.1
	indoor_level_universal_id: '1'	optimalKFuse: 0
	indoor_level_universal_id: '0'	optimalKFuse: 0.5
```
