# Toloka tool

This CLI provides some tools to automatically manage toloka tasks. Whole pipeline looks like:

1. [Create access-key](https://wiki.yandex-team.ru/mds/s3-api/authorization/#sozdanieaccesskey) with role=admin and put it into [configuration file](https://boto3.amazonaws.com/v1/documentation/api/latest/guide/quickstart.html#configuration)
2. We have two buckets: `maps-core-streetview-poi-toloka-1` and `maps-core-streetview-poi-toloka-sandbox`. The first one is for production toloka and opened for external access, the second one is for golden set markup.
3. Put [toloka token](https://wiki.yandex-team.ru/assessment/toloka/requestersguide/#6) into `env TOLOKA_TOKEN`
4. Run `./toloka-tool --mds-bucket=[BUCKET] clear-bucket` (optional). Be careful, mds bucket with panorama images will be lost.
5. Create or sample golden set for stage 1.
    * If you don't have golden set, you need to create a markup task (in the same way as ordinary task creation).
    * If you already have golden set, you need to sample some data from it ([in yql for example](https://yql.yandex-team.ru/Operations/XjKqO1PzVB3sYb1O9AouZOxD4vjCw96FRrF-SKEWBBk=)).
6. Run `first-task create`. Use panoramas table generated by `preview-creator`, set
   `--production-toloka`, `--gs-table` -- see params section below,
   set `--users-quality=1` for best quality, set `--public-url-format`.

   example:
   ```bash
   env TOLOKA_TOKEN=`cat ~/.toloka/token` YT_PROXY='hahn' ./toloka_tool \
   --mds-bucket=maps-core-streetview-poi-toloka-1 \
   first-task create \
   --production-toloka \
   --data-table='//home/maps/poi/streetview_poi/msk_novokuznetskaya_external_markup/panoramas/panoramas' \
   --users-quality=1 \
   --gs-table='//home/maps/poi/streetview_poi/msk_novokuznetskaya_external_markup/first_task/golden_results' \
   --public-url-format
   ```
7. Receive money on toloka account, open pool in web-interface (press play button), wait for task completion
8. If you want to have all results (golden and non-golden) in one table, merge golden and non golden inputs into one table.
9. Run `first-task process-results`. Get your pool-id from url in web-interface. If you want to filter bad users add `--filter-bad-solutions`

   example:
   ```bash
   env TOLOKA_TOKEN=`cat ~/.toloka/token` YT_PROXY='hahn' \
   ./toloka_tool first-task process-results \
   --production-toloka \
   --filter-bad-solutions \
   --pool-id 10844472 \
   --input-table //home/maps/poi/streetview_poi/msk_novokuznetskaya_external_markup/first_task/merged_input \
   --output-table //home/maps/poi/streetview_poi/msk_novokuznetskaya_external_markup/first_task/results
   ```
10. Run `second-task prepare-input-data` to transform input to the appropriate format

    example:
    ```bash
    env TOLOKA_TOKEN=`cat ~/.toloka/token` YT_PROXY='hahn' \
    ./toloka_tool second-task prepare-input-data \
    --input-table //home/maps/poi/streetview_poi/msk_novokuznetskaya_external_markup/first_task/results \
    --output-table //home/maps/poi/streetview_poi/msk_novokuznetskaya_external_markup/second_task/input_prepared
    ```
11. Repeat steps 5-9 for `second-task`
12. Repeat steps 10, 5-7 for `third-task`. Expect to see toloka message "quality
    control not configured", ignore this message and start the pool
    nevertheless.
13. Run `third-task assess-results` to validate tolokers work. After running this cmd watch wait for 100% in toloka. Repeat until all tasks are accepted.
    
    example:
    ```bash
    env TOLOKA_TOKEN=`cat ~/.toloka/token` YT_PROXY='hahn' \
    ./toloka_tool third-task assess-results \
    --gs-table //home/maps/poi/streetview_poi/msk_novokuznetskaya_external_markup/third_task/golden_results \
    --pool-id 10989598 \
    --production-toloka \
    --iou-threshold 0.4 \
    --empty-tasks-threshold 3
    ```
14. Repeat steps 8-9 for `third-task`


### Params

* CLI has description for each non trivial command params. Read `--help`.
* As for input / output tables formats you can check `table\_schemas.py` in case of uncertainty.
