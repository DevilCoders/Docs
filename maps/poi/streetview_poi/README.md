Библиотека для определения видимости вывесок организаций на зданиях
===

## Информация для потребителей

| Key | Value |
| --- | --- |
| Мейнтейнеры | [Maps.GeoQuality](https://staff.yandex-team.ru/departments/yandex_content_geodev_3808/) |
| Шедулеры в Sandbox | [Генерация пермалинков](https://sandbox.yandex-team.ru/scheduler/696249/view) <br> [Stable разметка](https://sandbox.yandex-team.ru/scheduler/697796/view) <br> [Testing разметка](https://sandbox.yandex-team.ru/scheduler/697454/view) <br> [Stable гипотезы](https://sandbox.yandex-team.ru/scheduler/698035/view) <br> [Testing гипотезы](https://sandbox.yandex-team.ru/scheduler/697869/view)|
| ABC сервис | [Streetview POI](https://abc.yandex-team.ru/services/maps-core-streetview-poi/) |
| Таблицы на YT | [Результаты разметки](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/streetview_poi/stable/) |
| Бакеты в MDS | [Бакеты](https://yc.yandex-team.ru/folders/fooosv90rvr73gkvh25i/storage) |
| YASM-алерт на квоту в MDS | [Алерт](https://yasm.yandex-team.ru/alert/maps-geoq-streetview-poi-mds-quota) |
| Робот | [robot-geoq-toloka](https://staff.yandex-team.ru/robot-geoq-toloka) - [пароль](https://yav.yandex-team.ru/secret/sec-01dv5k8t6yxzff9kv0tmvnkj39/explore/versions) |
| Заказчик в Толоке | `geoq-toloka@yandex.ru` - [пароль](https://yav.yandex-team.ru/secret/sec-01dv5k8t6yxzff9kv0tmvnkj39/explore/versions) |
| Пользователи в Толоке | `geoq-toloka-1@yandex.ru`, `geoq-toloka-2@yandex.ru` - [пароль](https://yav.yandex-team.ru/secret/sec-01dv5k8t6yxzff9kv0tmvnkj39/explore/versions) |

### Результаты разметки

Полный результат каждого запуска пайплайна хранится в отдельной подпапке [тут](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/streetview_poi/stable). Имя подпапки - время запуска пайплайна, например `2021-07-22_162809`.  
Выжимку из результов разметки можно найти в подпапке [results](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/streetview_poi/stable/results). Для каждого запуска это одна таблица, в которой можно найти
результаты разметки для каждого исходного пермалинка.
Поля таблицы:
 - `permalink` - пермалинк организации.
 - `bld_id` - идентификатор здания из [ymapsdf](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/core/garden/stable/ymapsdf/latest).
   Если это поле `NULL`, это значит, что организация была отфильтрована на
   стадии `bld_orgs_creator` (не нашлось здания, неизвестно имя организации и т.п.)
 - `lat` и `lon` - координаты центра здания.
 - `pano_id` - идентификатор панорамы из таблицы [streetview](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/streetview/release/stable/description).
   Если это поле `NULL`, это значит что подходящей панорамы в этот запуск найдено не было.
   Панорама подходит если она находится рядом с домом, у нее достаточно свежий
   возраст и для этого дома и организации она еще не была обработана.
 - `pano_timestamp` - таймстамп того, когда была сделана панорама
 - `bearing` - азимут направления обзора на панораме
 - `has_signs` - есть ли вывески при этом азимуте на этой панораме согласно толокерам
 - `users_chosen` - сколько толокеров выбрало, что при этом азимуте на этой панораме есть данная организация.
 - `users_total` - у скольких толокеров была возможность отметить, что при этом азимуте на этой панораме есть данная организация
 - `polygons` - полигоны вывески, выделенные на изображении. Если это поле `NULL`, это значит что толокер не выделил никакую вывеску.

## Описание

Данная библиотека представляет собой инструмент для подготовки данных, в которых
содержится информация, является ли какая-то организация видимой с улицы. Для
этого мы проверяем, есть ли на здании вывески с различимым названием/логотипом
данной организации. Это знание может быть полезно при проставлении диспкласса
(характеристики, показывающей важность организации) в разных приложениях: БЯК,
МЯК, Навигатор и т.д.

Задача поставлена в рамках [тикета](https://st.yandex-team.ru/GEOQ-167)

Для решения данной задачи используется многоэтапный процесс подготовки данных и
разметка разного рода датасетов с использованием **Толоки** (подробнее см.
[здесь](https://wiki.yandex-team.ru/assessment/toloka/)). Таким образом,
пайплайн подготовки данных использует результаты работы внешних исполнителей.
Внутренние источники данных подробно описаны ниже.

Для уменьшения стоимости выполнения задания в Толоке, подготовка данных включает
в себя несколько этапов.

## Этап 1. Отбор панорам, на которых есть вывески

Панорамы представляют собой фотографии зданий с различных ракурсов. На данном
этапе целью является фильтр всех панорам для того, чтобы исключить панорамы, на
которых точно нет никаких различимых вывесок (такие панорамы не представляют
ценности на последующих этапах).

На этом и последующих этапах все промежуточные данные в виде YT-таблиц находятся
в [данной директории](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/streetview_poi)

### Подготовка датасета

Пример операций, требуемых для создания датасета (все шаги и источники данных
будут подробно описаны ниже):

- `./bld_orgs_creator --ymapsdf-folder //home/maps/core/garden/stable/ymapsdf/20200123_420102_1421_168605915/cis1 --output-table //home/maps/poi/streetview_poi/bld_orgs --bounding-box 55.744743 55.755083 37.577427 37.588787`
- `./pano_id_generation --input-table //home/maps/poi/streetview_poi/bld_orgs --output-table //home/maps/poi/streetview_poi/bld_pano_ids --pano-start-date 2020.01.30.23.59`
- `./prepare_streetview_pics --pano-index-dir ~/yandex-maps-streetview-description --width 1000 --height 1000 --input-table //home/maps/poi/streetview_poi/bld_pano_ids --output-table //home/maps/poi/streetview_poi/panoramas --threads 4`

Пример итоговой таблицы находится
[здесь](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/streetview_poi/msk_actualized/panoramas/panoramas_msk).

Ниже представлено подробное описание каждого из этих шагов.

#### Здания и организации

[Здесь](https://a.yandex-team.ru/arc/trunk/arcadia/maps/poi/streetview_poi/bld_orgs_creator) находится бинарник для формирования таблицы со зданиями (и организациями в этих зданиях), которые находятся в определенном регионе (Москва, пределы ТТК и т.д.). Для этого используются следующие источники данных:
- [ymapsdf](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/core/garden/stable/ymapsdf/latest/cis1) с идентификатором и геометрией каждого здания. На момент написания инструкции рабочая версия ymapsdf располагалась по [следующему пути](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/core/garden/stable/ymapsdf/20200123_420102_1421_168605915) (см. пример выше). Таблицы с геометрией из основной директории (latest) могут быть какое-то время невалидными из-за рефакторинга в Огороде.
- [extra_poi_bundle](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/extra_poi_bundle/stable) с теми организациями, которые могут появиться на подложке
- [static_poi_table](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/static_poi/stable/latest) c диспклассом и основной рубрикой для каждой организации (метаинформация)
- [orginfo](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/data/orginfo) с полной информацией о каждой организации, в данном случае для получения ближайшего города

Территория, на которой находятся интересующие нас организации, может быть задана одним из следующих аргументов командной строки:
- `city_id` - идентификатор города, к которому каждая организация могла быть приматчена. Если организация находится не в городе, она не войдет датасет (поведение не эквивалентно матчингу к ближайшему городу).
- `region_id` - идентификатор региона в Геобазе. Обычно представляет собой небольшой населенный пункт или район в крупном городе.
- `bounding_box` - прямоугольник, задающий ограничение по широте-долготе. Задается 4 числами: lat_min, lat_max, lon_min, lon_max (не именованные).

Выходная таблица содержит следующие поля (приведены основные, не все):
- `bld_id` - идентификатор здания в ymapsdf
- `organizations` - список организаций, каждая из которых представляет собой json с метаинформацией
- `shape` - геометрия здания в wkb-формате и т.д.

#### Матчинг панорам и зданий

[Здесь](https://a.yandex-team.ru/arc/trunk/arcadia/maps/poi/streetview_poi/pano_id_generation)
лежит бинарник для матчинга идентификатора панорамы и здания, на которое эта панорама может указывать. Информация о панорамах (идентификатор, географические координаты, азимут и т.д.) берется [отсюда](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/streetview/release/stable). Здания берутся в качестве результата работы предыдущего скрипта. Панорамы, которые расположены слишком далеко от зданий, фильтруются. Также используются только панорамы, расположенные на достаточном расстоянии друг от друга.

Выходная таблица включает в себя все поля предыдущей таблицы (bld_orgs), а также следующие поля:
- `bearing` - азимут направления обзора
- `pano_id` - идентификатор панорамы, у одной и той же панорамы, но с разным азимутом, идентификаторы одинаковые
- `toloka_id` - идентификатор панорамы, который будет использован в Толоке (по сути конкатенация `pano_id`, целого `bearing` и `bld_id`)

#### Получение изображений

[Здесь](https://a.yandex-team.ru/arc/trunk/arcadia/maps/poi/streetview_poi/preview_creator)
находится бинарник для загрузки изображений и метаинформации о них.

Полная информация о панорамах находится в ecstatic
[датасете](http://ecstatic.maps.yandex.net/pkg/yandex-maps-streetview-description/versions).
Путь до этого датасета мы указываем в cmd-параметре `pano-index-dir`. Данный
датасет нужен для того, чтобы определить ключ в mds, по которому расположено
изображение панорамы, а также метаинформацию (например, горизонтальный и
вертикальный углы панорамы). Далее для каждой панорамы мы ходим в mds, пытаемся
загрузить изображение, после чего отдаем изображение и метаинформацию в сжатом
виде.
__N.B.: используйте ту версию датасета, на момент которой делали предыдущую стадию__ (Т.е. самую последнюю версию)

Выходная таблица имеет тот же формат, что и входная таблица, плюс колонка
`preview`, в которой содержится вся извлеченная информация о панораме.

### Использование в Толоке

Полученный датасет содержит панорамы всех зданий в требуемом регионе и список
возможных организаций, которые могут иметь вывеску на этих панорамах. На данном
шаге мы лишь просим указать, есть ли хоть какая-то вывеска на данном изображении
панорамы. Ниже приведен краткий перечень действий, требуемых при работе с
Толокой. Полный список команд можно найти на странице [тулы](https://a.yandex-team.ru/arc/trunk/arcadia/maps/poi/streetview_poi/toloka_tool) Толоки.

#### Получение ключей

Для работы с функционалом Толоки понадобятся два ключа: для Толоки и MDS (хранилище с изображениями).
- [Здесь](https://wiki.yandex-team.ru/mds/s3-api/authorization/#sozdanieaccesskey) описано получение MDS-ключа. Используйте продакшн-окружение (S3-MDS), сервис
[Streetview POI](https://abc.yandex-team.ru/services/maps-core-streetview-poi) (его id) и роль admin.
- Установите [AWS CLI](https://aws.amazon.com/ru/cli) и добавьте полученный ключ в конфигурационный файл (более подробно см. [здесь](https://boto3.amazonaws.com/v1/documentation/api/latest/guide/quickstart.html#configuration)). При добавлении ключей __не__ используйте кавычки.
- Получите [токен Толоки](https://wiki.yandex-team.ru/assessment/toloka/requestersguide/#6) и положите его, например, в `~/.toloka/token`.

#### Запуск задания и получение результатов

Выполните шаги 5-9 из инструкции для toloka_tool.

Общие советы по использованию Толоки на этом этапе и далее:
- Используйте `--help` для CLI утилиты toloka_tool. Параметров не так много, а некоторые могут серьезно улучшить качество (например, `--filter-bad-solutions`).
- Голденсет является узким местом каждого этапа. Он нужен для проверки адекватности пользователей Толоки с помощью уже размеченных данных.
Данные можно разметить с помощью отдельного задания в Толоке, а можно воспользоваться готовыми данными, размеченными в пределах Москвы. В шаге 5 toloka_tool приведен пример YQL-запроса.

**Hint**: при выборе размера голденсета (limit в YQL-запросе) общей рекомендацией является примерно 10 % от размера данных,
которые нужно будет разметить (округление в большую сторону).

После разметки пользователями Толоки таблица с результатами выглядит [так](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/streetview_poi/msk_actualized/first_task/msk_all_results).
Поля данной таблицы:
- `toloka_id` - идентификатор в Толоке
- `has_signs` - есть ли на фотографии **хоть какие-то** вывески
- `from_golden` - входит ли фотография в goldenset (размечалась разработчиками вручную)

## Этап 2. Отбор организаций, которые различимы на вывесках.

На данном этапе отбираются конкретные организации, которые видны на панорамах. Пользователю предлагаются изображения, которые на 1 этапе были помечены как "имеющие вывески",
а также список организаций, которые находятся в здании на панораме. Если организаций очень много (как в различных ТЦ), список разбивается на более мелкие. __Важно__: данный этап
является самым дорогостоящим и трудоемким, поэтому аккуратно планируйте бюджет.

#### Запуск задания и получение результатов

Выполните шаги 10-11 из инструкции для toloka_tool.
Главное отличие от 1 этапа заключается в том, что перед созданием голденсета и задания требуется сделать предобработку данных (шаг 10).

Пример выходной таблицы выглядит [так](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/streetview_poi/msk_actualized/second_task/msk_all_results).
Поля таблицы из 1 этапа переносятся, добавляется поле `gt_orgs`, в котором для каждой организации, которая считается выбранной, указано число пользователей, которые ее отметили. Пример:

```json
{
    "149287480451": {
        "users_chosen": 4,
        "users_total": 5
    },
    "154223839604": {
        "users_chosen": 5,
        "users_total": 5
    }
}
```

Эта таблица уже может быть использована для различных задач, где требуется лишь факт видимости организаций,
но для определения того, насколько заметна организация, нужно еще одно задание.

## Этап 3. Выделение участков с вывесками.

На данном этапе пользователи Толоки получают изображение с панорамой и организацию, вывеску (или логотип) которой требуется выделить на изображении.
Область выделения представляет собой четырехугольник, который обведен по границе вывески. На данном этапе не вычисляются геометрические характеристики вывесок,
а только определеяется их расположение на изображениях панорам.

#### Запуск задания и получение результатов

Выполните шаги 12-14 из инструкции для toloka_tool.
Особенность данного задания состоит в том, что нет проверки результатов "на лету". Реализована так называемая "отложенная приемка",
при которой решение о том, принимать задание (страницу) или нет, осуществляется уже после завершения. Поэтому, возможно, потребуется осуществить проверку несколько раз,
при этом отклоненные задачи снова будут даны пользователям для разметки. Повторять требуется пока не увидим 100% на странице с заданием.

Пример выходной таблицы выглядит [так](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/streetview_poi/msk_actualized/third_task/msk_all_results).
Два ключевых поля, которые добавляются к имеющимся, это:
- `single_org_id` - идентификатор организации, вывески которой размечаются на панораме
- `gt_polygons` - область выделения, ограничивающая вывеску на изображении. Пример:
```json
[
    {
        "data": [
            {
                "x": 0.88579,
                "y": 0.50647
            },
            {
                "x": 0.94366,
                "y": 0.50719
            },
            {
                "x": 0.94437,
                "y": 0.54576
            },
            {
                "x": 0.88651,
                "y": 0.54576
            }
        ],
        "type": "polygon"
    }
]
```

Определение геометрических характеристик вывесок уже не требует привлечения пользователей Толоки и осуществляется ответственными разработчиками.

## Обработка результатов

После того, как были выполнены все задания в Толоке, требуется систематизировать полученные результаты. Для этого нужно выполнить следующие действия.

### Вычисление площадей вывесок

В таблицах по итогам третьего задания содержатся панорамы и разметка вывесок. Зная местоположение панорам, их азимут обзора и геометрию
зданий, к которым они обращены, можно оценить реальную площадь и геопозицию отмеченных полигонов. [Здесь](https://a.yandex-team.ru/arc/trunk/arcadia/maps/poi/streetview_poi/sign_hypotheses/sign_area) находится бинарник для этого. Пример операции:

`./sign_area -t //home/maps/poi/streetview_poi/msk_actualized/third_task/msk_all_results -o //home/maps/users/olegvp/sign_area_table`

Аргументы командной строки:
- `-t` - таблица с результатами третьего задания Толоки
- `-o` - выходная таблица
- `-p` - таблица с описанием всех панорам, по умолчанию находится [здесь](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/streetview/release/stable/description)
- `-b` - таблица с геометрией зданий, по умолчанию находится [здесь](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/core/garden/stable/ymapsdf/latest/cis1/bld_geom)

В полученной таблице наибольший интерес представляет поле `area_sum`, в котором записана сумма площадей всех вывесок конкретной организации на данной панораме.

Пример выходной таблицы выглядит [так](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/users/olegvp/sign_area_table).

### Формирование таблицы видимости

Для каждой отдельно взятой организации сгруппируем полученные результаты из второго задания и таблицы с площадями. В итоге появится знание, была ли видна организация
пользователям хотя бы на какой-то панораме, а также появится некоторая медианная оценка площади вывески на основе результатов из множества панорам. Директория с бинарником
находится [здесь](https://a.yandex-team.ru/arc/trunk/arcadia/maps/poi/streetview_poi/org_visibility). Пример операции:

`./org_visibility --visible-orgs-table //home/maps/poi/streetview_poi/msk_actualized/second_task/msk_all_results --sign-area-table //home/maps/users/olegvp/sign_area_table --output-table //home/maps/poi/data/org_visibility`

Аргументы командной строки:
- `-visible-orgs-table` - таблица с результатами второго задания Толоки
- `--sign-area-table` - таблица с площадями вывесок, полученная на предыдущем этапе
- `--output-table` - выходная таблица
- `--replace` - заменить выходную таблицу, если она уже существует. Если данный флаг отсутствует, а таблица существует, то она будет обновлена - произойдет конкатенация таблиц, при этом 
для записей, которые являются общими, приоритетными будут данные из новой таблицы. Это позволяет постоянно добавлять свежие данные в общую таблицу видимости
- `--history-dir` - YT-директория, в которую требуется сохранить текущую версию таблицы до ее обновления
- `--ttl-days` - время жизни таблицы в истории.

Пример выходной таблицы выглядит [так](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/data/org_visibility).

Ниже перечислены все поля таблицы видимости:
- `bld_id` - идентификатор здания в ymapsdf
- `oid` - пермалинк организации в Справочнике
- `name` - имя организации на русском языке (для визуального удобства)
- `is_visible` - видна ли вывеска организации хотя бы на одной из панорам
- `sign_size` - класс размера вывески по ее площади. Возможные значения: `Small`, `Medium`, `Large`. Если организация не является видимой или в ходе вычисления площади произошла
какая-то ошибка, то значение поля - `None`.

**Важно**: в таблице содержатся только те организации, которые предлагались для оценки пользователям Толоки. Если организация изначально не попала в датасет или отсеялась
на первом этапе, в таблице ее не будет.
