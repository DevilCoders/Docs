## Конвеер построения динамических POI с возможностью персонализации

## Общая информация

Проект предназначен для построения датасета динамических POI. Данный датасет
должен перестраиваться значительно чаще, чем обычные персональные POI (примерно
каждые 15 минут), отсюда и слово "динамические" в названии. Датасет строится не
с нуля, а из других сгенерированных таблиц - источников. Пайплайн объединяет
информацию из всех источников, проставляет различные атрибута показа,
запаковывает датасет во flatbuffers, и после этого доставляет файлы датасета на
сервера рендерера. Показ динамических POI делается при помощи рендерера
персональных POI и на том же слое в мапките.

### Информация для пользователей
| Key | Value |
| --- | --- |
| Мейнтейнеры | [Maps.GeoQuality](https://staff.yandex-team.ru/departments/yandex_content_geodev_3808/) |
| Шедулеры в Sandbox| [Рассчёт динамических POI, production](https://sandbox.yandex-team.ru/scheduler/43522/view) <br/> [Рассчёт динамических POI, testing](https://sandbox.yandex-team.ru/scheduler/43843/view) <br/> [Обновление dummy source](https://sandbox.yandex-team.ru/scheduler/43538/view) <br/> [Обновление dummy source с common POI](https://sandbox.yandex-team.ru/scheduler/43905/view)|
| Исходники | [Arcadia](https://a.yandex-team.ru/arc/trunk/arcadia/maps/poi/personalized_poi/builder/dynamic_poi) <br/> [Таска рассчёта](https://a.yandex-team.ru/arc/trunk/arcadia/sandbox/projects/maps/MapsUploadDynamicPoiToEcstatic/__init__.py) <br/> [Таска dummy source](https://a.yandex-team.ru/arc/trunk/arcadia/sandbox/projects/maps/MapsUpdateDynamicPoiDummySource/__init__.py)|
| Папка на YT | [dynamic_poi](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/personalized_poi/dynamic_poi) |

### Схемы таблиц на YT

#### Таблица источника данных
Пайплайн динамических POI предполагает, что источник предоставляет данные в виде
[схематизированной](https://a.yandex-team.ru/arc/trunk/arcadia/maps/poi/personalized_poi/builder/dynamic_poi/lib/constants/schema.py#L2) статической YT таблицей со следующими колонками:
 - `passport_uid` - сортированная колонка, паспортный идентификатор пользователя, которому будем показывать
 организацию. Значение `NULL` означает, что организацию надо показывать всем
 пользователям.
 - `experiment_tag` - сортированная колонка, тэг эксперимента. Значение по умолчанию - пустая строка
 (`''`), такое значение надо ставить если эксперименты не нужны.
 - `permalink` - сортированная колонка, идентификатор организации из справочника, которая будет
 показываться пользователю.
 - `subscript` - словарь (локаль, подпись). Что будет написано у пользователя
 под организацией, например: `{'EN': 'Haircut at 6p.m.', 'RU': 'Стрижка в 18:00'}`.

Ожидается, что `passport_uid` + `experiment_tag` + `permalink` уникальны для одного
источника (то есть в одном эксперименте одному пользователю больше одного раза
организацию не показываем).

Пример подходящей таблицы: [//home/maps/poi/personalized_poi/dynamic_poi/source/dummy/latest](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/personalized_poi/dynamic_poi/source/dummy/latest).

#### Таблица пользователей с динамическими организациями
[Схематизированная](https://a.yandex-team.ru/arc/trunk/arcadia/maps/poi/personalized_poi/builder/dynamic_poi/lib/constants/schema.py#L32)
YT таблица, которая получается в результате объединения всех источников данных.
Колонки таблицы:
 - `experiment_tag` - сортированная колонка, тэг эксперимента, получается конкатенацией имени источника
 данных и тэга эксперимента источника данных.
 - `passport_uid`, `permalink` - аналогично таблице источника данных, сортированные колонки.
 - `subscript` - аналогично таблице источника данных.
 - `min_zoom` - минимальный зум, на котором начнет показываться организация.
 - `priority` - приоритет POI, который будет отдаваться рендерером на
 клиент как `priority`. Может быть `NULL`, в этом случае priority отдаваться
 рендерером не будет.

 Пример подходящих таблиц: [//home/maps/poi/personalized_poi/dynamic_poi/ecstatic_history](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/personalized_poi/dynamic_poi/ecstatic_history).

### Эксперименты
У каждого источника есть поле `experiment_tag`. Все записи с одним и тем же
тэгом являются одним экспериментом, то есть для добавления эксперимента надо
просто в таблицу источника добавить дополнительный набор записей, но с другим
тэгом. Пустая строчка в поле - это отсутствие эксперимента. После этого для
каждого эксперимента формируются наборы динамических POI по правилам:
1. Если POI из того же источника, что и эксперимент - то он добавляется, только
если он попадет в этот эксперимент (тэг такой же, как и у эксперимента)
2. Если POI из другого источника, то он добавляется только если это основной POI
(тэг эксперимента пустой).
3. Все основные POI (с тэгом `''`) объединяются без изменений в один основной
датасет. У этого датасета будет тэг `'tile_pois'`.

То есть для каждого эксперимента в каждом источнике мы добавляем обычные POI из
других источников. Например, у нас есть источник 1 с записями
`[(1, '', 2, ...), (1, 'exp', 3, ...)]` и источник 2 с записями
`[(10, '', 20, ...), (10, 'exp', 30, ...)]`. В итоговом датасете будут записи
```python
[(1, 'tile_pois', 2, ...),
 (10, 'tile_pois', 20, ...),
 (1, 'source_1_exp', 3, ...),
 (10, 'source_1_exp', 20, ...),
 (1, 'source_2_exp', 2, ...),
 (10, 'source_2_exp', 30, ...)]
```

### Разрешение конфликтов между источниками
Если в итоге оказалось несколько записей с одинаковой тройкой
`(passport_uid, exp_tag, permalink)`, то выбирается та, которая пришла из источника с
более высоким приоритетом. Приоритет источников настраивается в конфиге.

### Конфиг источников
Конфиг источников лежит в файле `lib/constants/sources_configs.py`.
Для изменения конфига надо поменять файл и пересобрать бинарник.

Для каждого источника можно указать параметры:
 - `source_priority` - приоритет источника при объединении различных источников
 (см. параграф 'Разрешение конфликтов между источниками' выше)
 - `min_zoom` - минимальный зум, на котором начнут показываться организации из
 этого источника.
 - `priority` - приоритет, который будет посылаться на клиент для персональных
 динамических организаций из этого источника.
 - `common_priority` - приоритет, который будет посылаться на клиент для общих
 динамических организаций из этого источника.
 - `growth_limit` - если размер таблицы источника увеличится больше чем на это
 значение, то сработает алерт.
 - `shrinkage_limit` - если размер таблицы источника уменьшится больше чем на
 это значение, то сработает алерт.
 - `update_time_limit` - если таблица источника не обновлялась дольше, чем это
 время, то сработает алерт.

Если ключа или целиком названия источника в конфиге нет, то будет использоваться
значение по умолчанию из `lib/constants/default_config.py`.

### Dummy источник
Для удобства разработки и тестирования есть [dummy источник](https://sandbox.yandex-team.ru/scheduler/43538/view).
Этот источник раз в ~10 минут генерирует для заданного набора пользователей
подписи для популярных организаций в Хамовниках. На этой подписи есть `passport_uid` юзера,
permalink организации и метка со временем генерации.


### Тестирование динамических POI через TestApp

**Сейчас тестирование возможно только с использованием iOS устройств.**

1. Убедитесь, что тестовый контур источника подключен к тестовому шедулеру
   расчёта динамических POI. Ссылку на шедулер можно получить на странице
   [/maps/poi/personalized_poi/builder/dynamic_poi](https://a.yandex-team.ru/arc/trunk/arcadia/maps/poi/personalized_poi/builder/dynamic_poi).
   В шедулере вас интересует параметр "Sources names with paths". Пожалуйста, не
   меняйте шедулер самостоятельно, если требуется подключить новую таблицу,
   свяжитесь с кем-нибудь из 
   [Группы качества сервисов](https://staff.yandex-team.ru/departments/yandex_content_geodev_3808/).
2. Скачайте и установите TestApp для **iOS** из ветки
   [trunk_testing](https://beta.m.soft.yandex.ru/description?app=ymapstestapp&platform_shortcut=iphoneos&autodetect=1&branch=trunk_testing).
3. В Experiments добавьте через "+" эксперимент со следующими параметрами
   **Service ID**: `MAPS_RENDERER`, **Parameter name**:
   `experimental_datatesting`, **Parameter value**: `1`.
4. В Experiments добавьте через "+" эксперимент со следующими параметрами
   **Service ID**: `MAPKIT`, **Parameter name**:
   `personalized_poi_in_mapkit_162.2`, **Parameter value**: `on`.
5. Если необходимо отсмотреть данные под экспериментом, например,
   `booking_yang`, то в Experiments нужно добавить через "+" эксперимент с
   параметрами  **Service ID**: `MAPS_RENDERER`, **Parameter name**:
   `experimental_dyn_dataset`, **Parameter value**: `geosmb_booking_yang`.
   Обратите внимание, что к тегу эксперимента добавилось  в качестве префикса
   название источника. Название источника задаётся в шедулере.
6. Перед выходом из Experiments надо руками перевести переключатель
   **datatesting** в положение выключено.
7. Зайти в **Personalized POI**.
8. Нажать **Auth**, залогинится под пользователем, для которого требуется
   посмотреть динамические POI.
9. Перевести переключатель **Ppoi** в положение включено.
10. Для выбранного пользователя должны начать отображаться его персональные и
    динамические POI.
