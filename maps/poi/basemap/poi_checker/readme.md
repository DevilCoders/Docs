Библиотека для определения причин непопадания POI на подложку
===

## Общая информация

При формировании подложки основными источниками данных для POI являются 
[Народная карта](https://n.maps.yandex.ru) и 
[Справочник](https://altay.yandex-team.ru/). Объекты из этих источников 
(для простоты будем далее называть их организациями) проходят ряд пайплайнов, 
в ходе которых они могут быть изменены или отфильтрованы. В результате далеко 
не все из них будут отображаться в приложениях Геосервисов (мобильные Я.Карты, 
десктопные Я.Карты, Я.Навигатор и т.д.). Данная утилита позволяет определить, 
на каком этапе и по какой причине организация была отфильтрована.

На данный момент утилита является частью 
[пайплайна](https://a.yandex-team.ru/arc/trunk/arcadia/maps/poi/personalized_poi/builder) 
подготовки данных для персональных POI, в ходе которого сперва формируется 
[таблица](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/data/orginfo) 
с информацией об открытых оффлайн-организациях Справочника, а после этого все 
они проходят через данную утилиту для определения причин, почему организации нет 
в **текущей** версии подложки.

### Информация для потребителей

| Key | Value |
|---|---|
| Ответственные разработчики | Олег Пономарев [(@olegvp)](https://staff.yandex-team.ru/olegvp) |
| Вопросы и пожелания | Дмитрий Корнев [(@tswr)](https://staff.yandex-team.ru/tswr) <br/> Олег Пономарев [(@olegvp)](https://staff.yandex-team.ru/olegvp) |
| Исходники | [Arcadia](https://a.yandex-team.ru/arc/trunk/arcadia/maps/poi/basemap/poi_checker) <br/> [Sandbox](https://a.yandex-team.ru/arc/trunk/arcadia/sandbox/projects/maps/poi/BasemapPoiChecker) |
| Шедулеры в Sandbox | [Подготовка персональных POI](https://sandbox.yandex-team.ru/scheduler/9930/view) |
| Экспорт в YT | [org_basemap_reasons](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/data/org_basemap_reasons) |

## Технические детали

### Как формируется подложка

Основной системой публикации геоданных для подложки является 
[Огород](https://docs.yandex-team.ru/garden/). Выходные данные содержат 
информацию в масштабах планеты. Однако система позволяет публиковать данные 
независимо для каждого региона планеты. В терминах Огорода регион - совокупность 
некоторых государств. К примеру, в `cis1` входят Россия, Украина, Белоруссия и 
др., в `cis2` - Казахстан, Узбекистан и т.д. Так как публикацию в регионах можно 
осуществлять независимо друг от друга, данные подложки могут быть сформированы 
из разных версий источников данных (к примеру, `cis1` использует свежии версии 
источников, а `cis2` - вчерашние). Утилита умеет определять, какая версия того 
или иного источника использовалась для конкретного объекта в текущей версии 
подложки.

Чтобы получить список релизов какого-либо модуля Огорода (для разных регионов) 
и их источники, можно воспользоваться ручкой 
`http://core-garden-server.maps.yandex.net/modules/<module_name>/builds/?contour=stable`

Далее приведены этапы публикации для фиксированного релиза.

### Этапы публикации POI

#### Сбор данных об организациях Народной Карты и Справочника

Информация об организациях НК и Справочника собирается, аггрегируется и 
экспортируется рядом сервисов. Слияние результатов происходит в модуле 
[ymapsdf](https://a.yandex-team.ru/arc/trunk/arcadia/maps/garden/modules/ymapsdf). 
Экспорт его данных на YT лежит в 
[//home/maps/core/garden/prod/ymapsdf](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/core/garden/prod/ymapsdf). 

Данные из Народной Карты экспортируются сервисом 
[wiki-tasks-export](https://a.yandex-team.ru/arc/trunk/arcadia/maps/wikimap/mapspro/services/tasks_export). 
Данные в YT лежат в директории `alpha` соответствующего экспорта `ymapsdf`.

Данные из Справочника обрабатываются следующими пайплайнами:
- Модуль Огорода [altay](https://a.yandex-team.ru/arc/trunk/arcadia/maps/garden/modules/altay) 
собирает информацию об организациях (открытые, закрытые, дубликаты, поставщики) 
и складывает их в 
[//home/maps/core/garden/prod/altay](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/core/garden/prod/altay).
- Пайплайн [static_poi](https://a.yandex-team.ru/arc/trunk/arcadia/maps/poi/static_poi) 
формирует ресурс 
[extra_poi_bundle](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/extra_poi_bundle/stable_v2), 
содержащий организации Справочника, которые мы хотим видеть на подложке, а также 
[таблицы](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/static_poi/stable), 
содержащие причины, по которым организация может не попасть в `extra_poi_bundle`.

На выходе получаются все организации НК и Справочника, которые мы хотим видеть 
на подложке, и имеющие ссылки друг на друга.

#### Денормализация

На данном этапе происходит ряд преобразований ymapsdf-объектов. Это последний 
этап, на котором данные собираются независимо для каждого региона и 
[экспортируются](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/core/garden/prod/renderer_denormalization) 
на YT. На этом этапе типичной причиной отсева организации является невозможность 
ее отображения в качестве POI (аэропорты, вокзалы и т.д.) - для таких объектов 
существуют отдельные слои.

#### Подготовка данных для рендерера

На данном этапе происходит упаковка всех данных предыдущих этапов в один дамп, 
который позже используется для компиляции карты в рендерере. Также происходит 
слияние со style-данными из [Картографа](https://cartograph.maps.yandex-team.ru/). 
Здесь множество POI отсеивается из-за фильтраций по стилям, зуму, local_rank, 
конфликтов иконок или подписей и т.д.

TODO: добавить более подробное описание механизмов фильтрации.

### Как пользоваться

#### Ресурсы

В пайплайне используется nile-over-yql, который формирует YQL-операции с 
использованием специальным образом скомпилированного python-кода - yql udf. 
Поэтому утилита содержит два собираемых ресурса:
- [poi_checker](https://sandbox.yandex-team.ru/resources?type=BASEMAP_POI_CHECKER_BINARY) - 
основной исполняемый бинарник.
- [libpoi_checker-yql_udf.so](https://sandbox.yandex-team.ru/resources?type=BASEMAP_POI_CHECKER_YQL_UDF) - 
собранный из либы yql_udf ресурс, путь до которого добавляется в специальную 
переменную окружения `NILE_YQL_PYTHON_UDF_PATH`, после чего этот ресурс 
используется на YQL-бэкенде.

#### Пример запуска

```sh
cd ~/arcadia/maps/poi/basemap/poi_checker
ya make -r
NILE_YQL_PYTHON_UDF_PATH=./yql_udf/libpoi_checker-yql_udf.so  ./bin/poi_checker --permalinks-table //home/maps/poi/data/orginfo --output-table //home/maps/poi/data/org_basemap_reasons
```

Аргументы командной строки:
- `--permalinks-table` - входная YT-таблица, содержащая колонку `permalink`, 
в которой находятся идентификаторы организаций в терминах Справочника.
- `--pool` - YT-пул, в котором запускаются map-reduce операции.
- `--output-table` - выходная таблица. Формат выходных данных см. ниже.

#### Выходные данные

Итоговая таблица содержит следующие поля:
- `permalink` - пермалинк организации в Справочнике.
- `reasons` - список идентификаторов причин, из-за которых организация не попала 
на подложку. Причин может быть несколько, если все они на этапе отсева являются 
эквивалентными по приоритету. Список причин и их описание (строковый 
идентификатор, человекочитаемое объяснение и т.д.) можно найти в 
[reasons.py](https://a.yandex-team.ru/arc/trunk/arcadia/maps/poi/basemap/poi_checker/lib/reasons.py).
- `description` - человекочитаемое описание причин отсева.
