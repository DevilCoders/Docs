Библиотека для отправки пользователям уведомлений об организациях
===

**Важно**: на данный момент подготовка данных для пушей приостановлена. Текущая 
версия переписана на Python3 без запуска на реальных данных. Для корректного 
использования библиотеки необходимы тестовые запуски и возможное устранение ошибок.

## Общая информация

Данный проект используется для решения задачи актуализации статуса организаций 
в Справочнике. Для этого для каждой организации, чье состояние требуется 
актуализировать (например, это невозможно сделать путем обзвона из колл-центров) 
подбираются пользователи Я.Карт или Я.Навигатора, которые с большой вероятностью 
с этой организацией знакомы и располагают актуальными сведениями о ней. Для 
отобранных пользователей осуществляется рассылка push-уведомлений с просьбой 
предоставить в форме фидбека актуальную информацию об организации.

Считается, что пользователь располагает информацией об организации, если недавно 
он какое-то время находился недалеко от нее. При этом больший приоритет имеют 
пользователи, которые в целом достаточно активно взаимодействуют с данной 
организацией (например, она содержится у них в качестве персонального POI).

### Информация для потребителей

| Key | Value |
|---|---|
| Ответственные разработчики | Олег Пономарев [(olegvp@)](https://staff.yandex-team.ru/olegvp) |
| Вопросы и пожелания | Дмитрий Корнев [(tswr@)](https://staff.yandex-team.ru/tswr) <br/> Олег Пономарев [(olegvp@)](https://staff.yandex-team.ru/olegvp) <br/> Сергей Брагин [(arbel0s@)](https://staff.yandex-team.ru/arbel0s) |
| Исходники | [Arcadia](https://a.yandex-team.ru/arc/trunk/arcadia/maps/poi/notification) <br/> [Sandbox](https://a.yandex-team.ru/arc/trunk/arcadia/sandbox/projects/maps/org_status_pushes) |
| Шедулеры в Sandbox | [Подготовка данных](https://sandbox.yandex-team.ru/scheduler/24427/view) <br/> [Заливка заданий в личный кабинет и отправка пушей через СУП](https://sandbox.yandex-team.ru/scheduler/698198/view) <br/>  [Регулярная аналитика](https://sandbox.yandex-team.ru/scheduler/25238/view) |
| Экспорт в YT | [geoplatform_org_status](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/notification/geoplatform_org_status) |
| Робот проекта [geoplatform](https://a.yandex-team.ru/arc/trunk/arcadia/sup/push/src/main/resources/config/geoplatform.json) | [Иван Любопытный](https://staff.yandex-team.ru/robot-geodata-survey) ([пароль](https://yav.yandex-team.ru/secret/sec-01f1q50zbgxn1z4d3yyakbqrkj/)) |

## Технические детали

Процесс подготовки и отправки данных включает в себя несколько этапов, которые 
описаны ниже. Для каждого такого этапа подготовлен отдельный исполняемый ресурс, 
после чего происходит их последовательный запуск с помощью Sandbox-задач. 
Так как это регулярный процесс, то для каждой Sandbox-задачи выделен отдельный 
шедулер (см. информацию для потребителей). Для подготовки и отправки эти задачи 
разные, список ресурсов для каждой задачи можно увидеть на странице 
соответствующего шедулера.

Ниже приведено описание каждого этапа, а также рассмотрены вспомогательные 
задачи, которые осуществляют подготовку нужных данных в рамках отдельных процессов.

### Извлечение позиций пользователей

**NB**: здесь и далее под пользователем понимается субъект, который залогирован 
в каком-либо приложении Яндекса и имеет уникальный passport_id (`puid`). 
Однако на следующих этапах должен еще соблюдаться ряд условий (см. ниже).

Данный этап не является частью процесса подготовки данных, он выполняется в 
рамках отдельного процесса, описание которого можно найти в 
[maps/poi/metrika](https://a.yandex-team.ru/arc/trunk/arcadia/maps/poi/metrika). 
На этом этапе происходит выгрузка геопозиций авторизованных пользователей за 
соответствующий день. Это сделано для ускорения текущего пайплайна, так как 
работа с позициями пользователей в 
[АппМетрике](https://wiki.yandex-team.ru/yandexmobile/appmetrica/data) является 
очень тяжелым процессом.

Таблицы с позициями пользователей находятся в 
[user_positions](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/data/metrika/user_positions).

### Подбор организаций для актуализации

Основное назначение пайплайна - актуализация организаций, статус которых нельзя
уточнить через звонки из колл-центров. Такими организациями могут быть сетевые 
организации, организации у которых не указаны контактные данные и т.д. Однако 
нас интересуют не все рубрики: просить актуализировать остановки, площадки, 
достопримечательности и т.д. не совсем корректно. Также предусмотрен фильтр 
организаций по некоторым стоп-словам в названии организации - например, 
просьба актуализировать Яндекс и все что с ним связано вызывает у пользователей 
вопросы.

После актуализации организации в одной из предыдущих рассылок, заново уточнять 
ее статус не требуется, как и подбирать пользователей для нее (число организаций 
у пользователя ограничено). Поэтому мы на протяжении какого-то времени такие 
организации актуализировать не предлагаем.

Бинарник для подготовки данных находится в 
[prepare_organizations](https://a.yandex-team.ru/arc/trunk/arcadia/maps/poi/notification/bin/prepare_organizations).

#### Процесс запуска

Пример запуска через cmd:

`./prepare_organizations --actualized-organization-cooldown-days 60 
--output-table //home/maps/poi/data/org_status_permalinks_filtered`

Аргументы командной строки:
- `--actualized-organization-cooldown-days` - число дней, на протяжении 
которых ранее актуализированная организация не включается в список организаций 
для текущей рассылки.
- `--output-table` - выходная таблица. Содержит список пермалинков организаций 
Справочника.

#### Используемые источники данных

- [Company](//home/sprav/assay/common/company_pretty_format) - 
таблица организаций Справочника в удобном формате (предназначалась для аналитиков, 
теперь используется во множестве продакшн-процессов).
- [Фидбеки](//home/sprav/altay/prod/snapshot/feedback.feedback) - 
таблица с пользовательскими фидбеками на организации Справочника.
- [Черный список Справочника](//home/sprav/altay/prod/snapshot/black_list_record) - 
объекты (организации, рубрики, сети, возможные действия), которые находятся в 
черном списке Справочника.

### Подбор пользователей и релевантных организаций

На данном этапе происходит подбор пользователей, которые взаимодействовали с 
данными организациями. Число организаций, предлагаемых каждому пользователю, 
регулируется, при этом организации отранжированы так, что сперва предлагаются 
наиболее релевантные. На каком-либо устройстве пользователя должны быть 
установлены Я.Карты **или** Я.Навигатор, так как push-уведомления могут 
приходить только в эти приложения. Для каждого пользователя выбирается ровно 
одно устройство с подходящим приложением (связка device_id + uuid) - то, 
которое субъект использует активнее всего и на которое можно отправлять 
push-уведомления.

Использование именно такого подхода (работа с авторизованными пользователями и 
отправка на самое используемое устройство-приложение) обусловлено следующими 
причинами:
- Пропускная способность СУПа (платформы для отправки уведомлений) ограничена 
(см. ниже). Во избежание крайне длительного процесса рассылки следует избегать 
огромного (десятки/сотни миллионов) числа устройств, на которые осуществляется 
рассылка.
- Отправка одних и тех же уведомлений на все устройства одного и того же 
пользователя имеет отталкивающий эффект.

Бинарник для подготовки данных находится в 
[prepare_org_status_pushes](https://a.yandex-team.ru/arc/trunk/arcadia/maps/poi/notification/bin/prepare_org_status_pushes).

#### Процесс запуска

Пример запуска через cmd:

`./prepare_org_status_pushes 
--permalink-table //home/maps/users/olegvp/permalink_table 
--output-dir //home/maps/poi/data/org_status_pushes`

Аргументы командной строки:
- `--permalink-table` - таблица с пермалинками организаций Справочника, статус 
которых требуется актуализировать.
- `--days` (по умолчанию 7) - протяженность периода, в котором проверяется, 
находился ли пользователь рядом с организацией.
- `--max-user-org-distance-meters` (по умолчанию 100) - максимальное расстояние 
пользователя от организации для простановки статуса "находился рядом".
- `--max-user-orgs-count` (по умолчанию 10) - максимальное число организаций, 
содержащихся в push-уведомлении пользователю.
- `--output-dir` - директория с выходными данными. Содержит ряд промежуточных 
таблиц и основную `pushes`.

#### Используемые источники данных

- [Metrika](https://yt.yandex-team.ru/hahn/navigation?path=//home/logfeller/logs/metrika-mobile-log/1d&) - 
ежедневные таблицы АппМетрики, содержащие все события на устройствах пользователей.
- [Orginfo](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/data/orginfo&) - 
таблица с информацией о действующих организациях Справочника.
- [Zooms](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/personalized_poi/group/zooms&) - 
таблица с персональными POI пользователей и их релевантностью.

#### Выходная таблица

Итоговая таблица содержит следующие поля:
- `puid` - идентификатор пользователя.
- `organizations` - список организаций, содержащихся в push-уведомлении.
- `application` - приложение, в котором доставляется пуш 
(пример: `ru.yandex.yandexmaps`).
- `device_id` - идентификатор устройства пользователя.
- `platform` - операционная система на устройстве пользователя 
(пример: `android`).
- `uuid` - идентификатор установки приложения на пользовательское устройство.

### Обработка датасета

На данном этапе происходит добавление разного рода метаинформации и подготовка 
только тех данных, которые требуются для отправки через 
[СУП](https://doc.yandex-team.ru/sup-overview/). Чтобы избежать повторной 
отправки push-уведомления с одной и той же организацией для конкретного 
пользователя, используется фильтрация пушей по кулдауну. Кулдауны бывают трех 
видов:
-  По пользователю (puid/uuid). Отправка пушей через СУП (см. следующую секцию) 
может осуществляться как в конкретное приложение, так и на все приложения одного 
пользователя. Фильтрация поддерживает оба типа отправки в периоды ранее. После 
того как пользователь открыл пуш на любом из устройств, на протяжении заданного 
числа дней никакие другие пуши этого типа не будут приходить пользователю.
-  По пользователю-организации (puid/uuid + permalink) - более мягкий 
вариант, при котором пользователю не задается вопрос о статусе организации, 
которая уже была в одном из недавних открытых пушей. При этом в 
[логах](https://yt.yandex-team.ru/hahn/navigation?path=//home/search-functionality/sup/push_stats) 
СУПа должна быть информация об открытии в приложении того пуша, в 
котором содержалась данная организация.
-  По клику пользователя на кнопку "Не интересно" - если пользователь нажал 
соответствующую кнопку в пуше, то на протяжении заданного числа дней ему не 
будут приходить пуши этого типа. Пользователи фильтруются по uuid, то есть 
при смене устройства информация сохранится.

Бинарник для обработки датасета с пушами находится в 
[process_pushes](https://a.yandex-team.ru/arc/trunk/arcadia/maps/poi/notification/bin/process_pushes).

#### Процесс запуска:

`./process_pushes --input-dir 
//home/maps/poi/notification/geoplatform_org_status/2020-08-13T14:28:59.418662Z 
--user-organization-cooldown-days 30 
--pushes-export-dir //home/maps/poi/notification/geoplatform_org_status 
--experiments exp_1 50.0 exp_2 87 exp_3 1.4`

Аргументы командной строки:
- `--input-dir` - YT-директория с датасетом.
- `--user-cooldown-days` - количество дней, на протяжении которых одному и тому 
же пользователю не могут отправляться пуш-уведомления данного типа (в случае 
доставки ранее).
- `--user-organization-cooldown-days` - количество дней, на протяжении которых 
пользователю не предлагется актуализировать информацию об организации, которая 
уже была в одном из недавно доставленных пушей.
- `--pushes-export-dir` - YT-директория с историей экспорта пушей.
- `--experiments` - список экспериментов в формате `name percent` (имя 
эксперимента и процент устройств, на которые он раскатывается).


#### Выходные таблицы

Итоговая таблица содержит следующие поля:
- `device_id` - идентификатор устройства пользователя.
- `uuid` - идентификатор установки приложения на пользовательское устройство.
- `puid` - идентификатор пользователя.
- `application` - приложение, в котором доставляется пуш 
(пример: `ru.yandex.yandexmaps`).
- `organizations` - список организаций, содержащихся в push-уведомлении.
- `experiments` - список экспериментов, в которые попадает данный пользователь.

Также создаётся транспонированная таблица со следующими полями:
- `oid` - идентификатор организации.
- `uids` - список идентификаторов пользователей, которым будет создано задание на эту организацию.
Эта таблица используется для заливки заданий в личный кабинет.


### Отправка push-уведомлений через СУП

Отправка push-уведомлений состоит из двух частей:
- Упаковка данных в формат, требуемый для СУПа. Для каждого пользователя 
формируется URL, который в качестве параметров содержит идентификаторы 
устройства и приложения, а также список органиазаций. Также формируется текст 
уведомления на естественном языке и добавляется разного рода метаинформация, 
требуемая для СУПа (TTL уведомления и т.д.). В итоге все уведомления 
сохраняются в YT-таблицу, из которой уже и происходит отправка подготовленных 
данных.
- Отправка готовой таблицы через СУП.

В контексте данного пайплайна упаковка относится к стадии подготовки данных и 
осуществляется соответствующей Sandbox-таской. Отправка таблицы осуществляется 
другой задачей, которая специально для этого создана и имеет свое фиксированное 
расписание. До начала отправки ищется самый свежий экспорт, в котором данные 
были подготовлены (в нужном для СУПа формате), но еще не были отправлены. Если 
такого экспорта нет, и при этом конкретный экспорт для отправки также не указан 
вручную, задача упадет с сооответствующим сообщением о том, что отправлять нечего.

Для отправки требуется SUP-токен, который можно получить (а заодно и ознакомиться 
с СУП) на [главной странице](https://sup-frontend.yandex-team.ru) СУПа. Рассылка 
push-уведомлений происходит батчами. Так как СУП имеет ограниченную пропускную 
способность, обусловленную физической инфраструктурой и числом роботов, 
"разгребающих" пуши, максимальным рекомендованным темпом рассылки является 
отправка батчей размером 200 тысяч уведомлений с 5-минутным интервалом (это 
настроено по умолчанию).

Существует возможность выбора режима отправки пользователю (параметр `--receiver`, 
см. ниже) - слать пуши на одно конкретное приложение (основное для пользователя) 
или на все устройства, на которых пользователь залогинен. При втором режиме пуши 
на разлогиненные устройства приходить не будут.

Бинарник для отправки push-уведомлений находится в 
[send_pushes](https://a.yandex-team.ru/arc/trunk/arcadia/maps/poi/notification/bin/send_pushes).

#### Пример запуска:

`./send_pushes --input-tables 
//home/maps/poi/notification/geoplatform_org_status/2020-08-13T14:28:59.418662Z/pushes_processed 
--data-table 
//home/maps/poi/notification/geoplatform_org_status/2020-08-13T14:28:59.418662Z/pushes_data 
--sup-logs-table 
//home/maps/poi/notification/geoplatform_org_status/2020-08-13T14:28:59.418662Z/sup_logs`

Аргументы командной строки:
- `--input-tables` - список YT-таблиц с данными пользователей и списком 
организаций.
- `--data-table` - таблица с данными в формате, который требуется для отправки 
через СУП.
- `--force-push` - форсированная отправка пушей без учета таких параметров, 
как требуемый период после отправки последнего пуша тому же пользователю.
- `--pack-only` - только упаковать данные в нужный для СУПа формат, при этом 
отправка через СУП не осуществляется.
- `--send-only` - только отправить данные через СУП (они должны быть 
предварительно упакованы в нужный формат).
- `--receiver` - получатель. Поддерживаются два режима: `puid` - отправка на все 
устройства, на которых пользователь залогинен; `uuid` - отправка на одно из 
устройств пользователя.
- `--push-type` - тип пуша в СУП. Пуши для актуализации статусов организаций 
имеют тип `geoplatform_org_status`.
- `--target` - место где пользователю предлагается проактуализировать организацию. 
Поддерживается два режима: `feedback_form` - форма фидбека в приложении и 
`ugc_account` - лента заданий в личном кабинете.
- `--texts-seed` - числовой параметр, регулирующий заголовок и текст пуша.
- `--sup-logs-table` - таблица с логами СУПа (идентификаторы батчей и статус 
их отправки).

### Заливка заданий в личный кабинет

Сформированные задания на актуализацию статусов организаций заливаются в
[личный кабинет](https://yandex.ru/maps/profile/ugc/assignments) пользователя в Картах. Личный 
кабинет доступен только авторизованным пользователям. Перед созданием задания с помощью ручки 
[status](https://a.yandex-team.ru/arc/trunk/arcadia/maps/doc/proto/yandex/maps/proto/ugc_account/Backoffice.md#v1assignmentsstatus) 
бэкофиса ЛК проверяется наличие у пользователя задания на эту организацию (активного, либо уже 
решённого), чтобы избежать дублирования заданий у пользователя.

#### Пример запуска:
`./create_ugc_account_tasks --input-table 
//home/maps/poi/notification/geoplatform_org_status/2020-08-13T14:28:59.418662Z/pushes_processed_transposed`

Аргументы командной строки:
- `--input-table` - YT-таблица со списком uid'ов для каждой организации (транспонированная выходная 
таблица со стадии `process_pushes`).
- `--task-type` - тип задания. Задания на актуализацию статусов организаций имеют тип `org_status`.
- `--env` - окружение ЛК, в котором будут созданы задания, `testing` или `stable`.
- `--log` - уровень логирования.
- `--n-jobs` - количество параллельно запускаемых процессов заливки. Посмотреть создаваемую нагрузку 
на бэкофис ЛК во время заливки заданий можно на следующий панелях: 
[тестинг](https://yasm.yandex-team.ru/template/panel/maps-core-ugc-backoffice-testing-panel-main/), 
[стейбл](https://yasm.yandex-team.ru/template/panel/maps-core-ugc-backoffice-stable-panel-main/). 
На бэкофисе настроен рейтлимитер, лимиты можно посмотреть 
[тут](https://a.yandex-team.ru/arc/trunk/arcadia/maps/config/ratelimiter/maps_core_ugc_backoffice) 
(сервис `maps_core_feedback_geodata_surveys`), лучше сильно в них не упираться.

#### Пуши с приземлением на личный кабинет

При переходе в личный кабинет по ссылке из push-уведомления нам необходимо пробросить авторизацию 
из приложения (принявшего пуш) в браузер (открывающий ссылку из пуша). Для этого мы используем 
схемы [open_url](https://wiki.yandex-team.ru/maps/mobile/url-schemes/#drugoe) в МЯКе и 
[show_web_view](https://wiki.yandex-team.ru/users/vralex/navigator-intents/#otkrytiewebview) в Нави. 
В обоих случаях ЛК открывается внутри приложения (в CustomTab или в WebView). За проброс авторизации 
отвечает метод
[requestCookieAuthURLWithAccount](https://wiki.yandex-team.ru/yandexmobile/accountmanager/help/ios/lastapi/#yalcookieexchangerobmenxtokenanaavtorizacionnyekuki), 
поддержанный внутри обеих схем.

Итоговый url формируется следующим образом:

`{schema}https://yandex.ru/{target}/profile/ugc/assignments/?context=ugc.org_status.push_notifications&client_id={client_id}&assignment_id=os:{oid}&{additional_params}`

со следующими параметрами (в зависимости от приложения):
| Приложение | client_id | schema | target | additional_params |
|---|---|---|---|---|
| МЯК | `ru.yandex.traffic` (ios) <br> `ru.yandex.yandexmaps` (android) | `yandexmaps://open_url?url=` | `web-maps` | |
| Нави | `ru.yandex.mobile.navigator` (ios) <br> `ru.yandex.yandexnavi` (android)  | `yandexnavi://show_web_view?link=` | `maps` | `authenticate=use_auth` |

url внутри схемы кодируется методом `urlencode` (дополнительные параметры не кодируются, см. пример 
из документации по 
[show_web_view](https://wiki.yandex-team.ru/users/vralex/navigator-intents/#otkrytiewebview)).


### Регулярная аналитика

Для отслеживания результатов ежедневно осуществляется выгрузка статистики. 
Бинарник для расчета статистики находится в 
[calculate_statistics](https://a.yandex-team.ru/arc/trunk/arcadia/maps/poi/notification/bin/calculate_statistics).

Помимо данной регулярной аналитики, также есть статистика по отправленным, 
доставленным и открытым пушам в отчетах СУПа на statface: 
[MobileMaps](https://stat.yandex-team.ru/Yandex/Sup/mobmaps/push_delivery) и 
[Навигатор](https://stat.yandex-team.ru/Yandex/Sup/navi/push_delivery). 
Пуши для актуализации организаций имеют тип `geoplatform_org_status`.

#### Процесс запуска

Пример запуска через cmd:

`./calculate_statistics --statistics_table 
//home/maps/poi/notification/statistics/geoplatform_org_status --days 60`

Аргументы командной строки:
- `--pushes-export-dir` - YT-директория с экспортом пушей
- `--days` (по умолчанию 60) - протяженность периода расчета статистики при 
отсутствии данных за прошедшее время.
- `--statistics_table` - выходная YT-таблица. Может уже существовать, в этом 
случае происходит добавление новых данных.

#### Выходная таблица

Регулярная таблица находится в 
[//home/maps/poi/notification/statistics/geoplatform_org_status](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/notification/statistics/geoplatform_org_status).

Итоговая таблица содержит следующие поля:
- `fielddate` - дата, за которую посчитана статистика.
- `n_pushes` - число пушей в рассылке. Ненулевое в те дни, в которые
производились регулярные рассылки.
- `n_orgs` - число организаций, которые требовалось актуализировать в день 
рассылки. Сохранять начали не сразу.
- `orgs_in_pushes` - число организаций, которые содержались в пушах текущей 
рассылки.
- `pushes_sent` - число пушей, отправленных через СУП в этот день.
- `pushes_delivered` - число пушей, доставленных на устройства. По аналогии с 
полями далее, значительное их число наблюдается не только в день рассылки, так 
как пуши нередко приходят с задержкой.
- `pushes_opened` - число пушей, открытых пользователями.
- `n_feedbacks` - число полезных фидбеков, которые оставили пользователи..
- `n_actualized_orgs` - число уникальных организаций, актуализированных в 
текущий день.
- `total_actualized_orgs` - общее число уникальных актуализированных организаций 
до текущего дня включительно.

**TODO**: добавить описание после отгрузки текущей таблицы в statface.
