Библиотека для отбора и ранжирования POI на основе организаций Справочника
===

## Общая информация

Данная библиотека представляет собой пайплайн, который решает три основные задачи:
1. Обогащение подложки Я.Карт дополнительными организациями Справочника. 
Исторически за это отвечал модуль
[enricher](https://wiki.yandex-team.ru/geo/quality/documentation/enricher).
2. Ранжирование организаций по важности (характеристика display_class). Это 
позволяет отображать организации на подложке, помещая их на те зумы, которые 
соответствуют их статусу и популярности у пользователей.
3. Вычисление агрегированной полезной информации об организациях Справочника - 
принадлежность зданиям, верифицированность координат и т.д.

Пункты 1 и 2 решаются в рамках подготовки ресурса 
[extra_poi_bundle](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/extra_poi_bundle), 
потребителем которого является [Огород](https://garden.maps.yandex-team.ru). 
В Огороде и происходит прорастание POI на подложку. В extra_poi_bundle входят 
только те организации, которые мы хотим видеть на подложке.

Пункт 3 нужен для ряда потребителей, которые используют информацию об 
организациях, например 
[StreetViewPOI](https://a.yandex-team.ru/arc/trunk/arcadia/maps/poi/streetview_poi).
Информация для всех организаций сохраняется в таблице 
[static_poi](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/static_poi).

Также предусмотрена (см. ниже) возможность A/B тестирования, которая позволяет 
готовить различные варианты датасетов и оценивать их влияние на подложку.

### Информация для потребителей

| Key | Value |
|---|---|
| Ответственные разработчики | Олег Пономарев [(@olegvp)](https://staff.yandex-team.ru/olegvp) |
| Вопросы и пожелания | Дмитрий Корнев [(@tswr)](https://staff.yandex-team.ru/tswr) <br/> Олег Пономарев [(@olegvp)](https://staff.yandex-team.ru/olegvp) |
| ABC | [Static POI](https://abc.yandex-team.ru/services/maps-core-static-poi/) |
| Исходники | [Arcadia](https://a.yandex-team.ru/arc/trunk/arcadia/maps/poi/static_poi) <br/> [Sandbox](https://a.yandex-team.ru/arc/trunk/arcadia/sandbox/projects/maps/BuildStaticPoi) |
| Шедулеры в Sandbox | [Stable](https://sandbox.yandex-team.ru/scheduler/16793/view) <br/>  [Testing](https://sandbox.yandex-team.ru/scheduler/16769/view) |
| Экспорт в YT | [extra_poi_bundle](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/extra_poi_bundle&) <br/>  [static_poi](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/static_poi&) |


## Технические детали

### Используемые данные

Основным источником информации об организациях является таблица 
[company](https://yt.yandex-team.ru/hahn/navigation?path=//home/sprav/altay/prod/geosearch_snapshot_freshed/company) 
экспорта Справочника (эта таблица аналогична этой
[company](https://yt.yandex-team.ru/hahn/navigation?path=//home/altay/db/export/current-state/snapshot/company),
но обновляется раз в несколько минут). Для более быстрой работы используется 
"сжатая" ее версия - таблица 
[orginfo](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/data/orginfo). 
**Важно**: работа происходит только с теми организациями, которые имеют статус 
в Справочнике "Публиковать" или "Временно закрыт", а также не являются 
онлайн-организациями.

Ресурсы, требуемые для расчета:
- [Таблица](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/personalized_poi/group/features_schematized) 
с пользовательскими кликами и посещениями.
- [Геокуб](https://yt.yandex-team.ru/hahn/navigation?path=//home/geosearch-prod/geocube/1d) 
с информацией о всех кликах и показах.
- [Экспорт Огорода](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/core/garden/stable/ymapsdf/latest) 
с информацией о зданиях (местоположение и геометрия) и организациях, координаты 
которых верифицированы вручную или автоматически.
- [Таблица](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/data/org_visibility) 
видимости организаций.
- [Таблица](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/data/manual_publications) 
с организациями, подготовленными для публикациями вручную.

### Бинарники

[build_static_poi](https://sandbox.yandex-team.ru/resources?type=BUILD_STATIC_POI_EXECUTABLE) 
- основной исполняемый ресурс. Реализует полный пайплайн подготовки данных 
(в рамках одного эксперимента или без экспериментов вообще). Пример операции:

`./build_static_poi --organization-user-features-table //home/maps/poi/personalized_poi/group/features_schematized --organizations-info-table //home/maps/poi/data/orginfo --output-table //home/maps/poi/static_poi/testing/latest --history-dir //home/maps/poi/static_poi/testing/history --extra-poi-bundle-folder //home/maps/poi/extra_poi_bundle/testing_v2 --iso-codes RU,UA,BY,KZ,UZ,TR --experiment visibility`

[experiments_handler](https://sandbox.yandex-team.ru/resources?type=EXPERIMENTS_HANDLER_EXECUTABLE) 
- ресурс для работы с результатами экспериментов. Подразумевается, что в ходе 
sandbox-таски ресурсы build_static_poi с различными экспериментами запускаются 
параллельно. Ресурс нужен для объединения результатов в одну таблицу 
(см. соотв. раздел), а также работы с временными директориями, символическими 
ссылками и т.д. Пример операции:

`./experiments_handler merge --extra-poi-bundle-folder //home/maps/poi/extra_poi_bundle/testing_v2/2020-03-03T14:48:38.094345Z`

### Скорость попадания изменений на подложку

#### Публикация и изменение организации
Все основные данные организации (название, категории и т.п.) попадают в таблицу 
`orginfo` раз в сутки ночью. После этого с утра варится `extra_poi_bundle`, 
потом варится `ymapsdf` и потом денормализация рендерера ближе к вечеру. На 
следующий день публикуется карта. В итоге, если организация была 
изменена/опубликована в день N, то изменения на карте можно ожидать в день N + 2.

#### Распубликация организации
Для ускорения распубликации сделан дополнительный механизм - в конце варки 
`extra_poi_bundle` еще раз проверяется таблица
[company](//home/sprav/altay/prod/geosearch_snapshot_freshed/company). Это 
происходит в районе 12 часов по Москве, поэтому если организация была 
распубликована в день N с утра, то ее распубликацию можно ожидать уже в день 
N + 1. Такие организации имеют специальную причину в таблице `static_poi` 
- `FreshNotPublished`. 


### Выходные данные

#### extra_poi_bundle

[extra_poi_bundle](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/extra_poi_bundle) - 
бандл с POI, которые удовлетворяют основным фильтрам, и метаинформацией. 
Представляет собой директорию на YT с названием в виде даты начала запуска в 
формате UTC (см. 
[пример](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/extra_poi_bundle/stable_v2/2020-03-26T09:01:11.332495Z)
). Внутри директории содержатся следующие данные:

- `data` - требуемая таблица с POI.
- `experiments` - таблица с диспклассами для каждой организации в рамках 
соответствующего эксперимента.
- `private_info` - директория, в которой для каждого эксперимента (отсутствие 
эксперимента соответствует директории `main`) содержатся промежуточные таблицы. 
Для внутреннего пользования.

В таблице `data` для каждой организации приведены следующие поля:

- `id` - пермалинк организации в Справочнике.
- `dispClass, dispClassTweak` - целая и вещественная часть disp_class. 
Варьируется от 2 до 10, где 2 - самый важный приоритет (как правило, 
организация становится видна на 13-14 зумах), 10 - самый низкий приоритет 
(не показывать на карте).
- `dispClassNavi, dispClassTweakNavi` - аналогично, но для подложки в Навигаторе.
- `ftTypeId` - идентификатор рубрики в НЯК.
- `ftTypeName` - имя рубрики в НЯК.
- `isGeoProduct` - является ли организация геопродуктовой (то есть приоритетной).
- `isProtectedGeoProduct` - является ли организация защищенной геопродуктовой 
(для которой предоставляются дополнительные гарантии по координатам и отсутсвию 
конфликтов с другими организациями).
- `isRecentlyProtectedGeoProduct` - стала ли эта организация геопродуктовой 
давно (иначе говоря, присутствует ли эта организация в выгрузках 10-дневной 
давности [GEOQ-406](https://st.yandex-team.ru/GEOQ-406)).
- `mainRubricId` - идентификатор главной рубрики, используемый в Справочнике.
- `name` - имя Организации в Справочнике, но более "причесанное".
- `point` - координаты организации (широта, долгота).
- `tags` - дополнительные строковые тэги (флаги).

#### static_poi

[static_poi](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/static_poi) - 
таблицы с метанформацией об организациях. Каждая таблица является 
символической ссылкой на соответствующую таблицу из extra_poi_bundle. Наиболее 
[актуальная](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/static_poi/stable/latest) 
таблица является ссылкой на таблицу 
`<extra_poi_bundle_latest>/private_info/main/static_poi`. Эти таблицы содержат 
  множество полей и очень удобны для исследования причин, почему организация 
  проросла или не проросла на подложку:

- `oid` - пермалинк организации в Справочнике.
- `base_disp_class` - диспкласс организации, рассчитанный на основе ее рубрики, 
используется при отсутствии информации о посещениях и кликах.
- `buildings` - здания из 
[YMapsDF](https://doc.yandex-team.ru/ymaps/ymapsdf/ymapsdf-ref/concepts/bld.html), 
в полигоны которых попадает географическая точка организации.
- `disp_class` - диспкласс организации, рассчитанный по кликам и посещениям.
- `disp_class_navi` - диспкласс, используемый в Навигаторе.
- `entrances` - входы-выходы организации в Справочнике.
- `ft_type_id` - идентификатор соответствующей рубрики в НЯК.
- `ft_type_name` - имя соответствующей рубрики в НЯК.
- `is_auto_point` - определены ли координаты организации автоматически.
- `is_closed_for_visitors` - организация работает, но закрыта для посетителей.
- `is_geo_product` - является ли организация геопродуктовой. Как правило, 
организации, сотрудничащие на платной основе, должны быть видны на карте, 
поэтому они имеют некоторый приоритет.
- `is_manual_publishing` - публиковать ли организацию вручную (с заданными 
параметрами), независимо от данных в Справочнике и прохождения некритичных 
фильтров.
- `is_protected_geo_product` - является ли организация защищенной 
геопродуктовой, для которой осуществляется контроль за ее координатами и 
обеспечивается отсутствие конфликтов с другими организациями подложки.
- `is_recently_protected_geo_product` - стала ли эта организация геопродуктовой 
давно (иначе говоря, присутствует ли эта организация в выгрузках 10-дневной 
давности [GEOQ-406](https://st.yandex-team.ru/GEOQ-406)).
- `is_yandex_gas_station` - является ли организация Яндекс.Заправкой (имеет ли 
приоритет в Навигаторе).
- `iso_code` - код страны, в которой находится организация.
- `lat, lon` - широта и долгота организации.
- `main_rubric` - основная рубрика организации.
- `manual_publishing_name` - имя организации при добавлении вручную. Задается 
пользователем, опционально.
- `name` - основное имя организации в Справочнике.
- `poi_name` - "причесанное" имя организации для подписи на подложке.
- `position_verified` - координаты организации вручную верифицированы в НЯК.
- `reasons_org_is_not_valid` - **важнейшее** поле, в котором содержатся 
возможные причины, почему организация может не попасть в extra_poi_bundle. 
Описание причин см. ниже.
- `references` - ссылки организации на соответствующие организации в НЯК.
- `rubrics` - список рубрик организации в Справочнике.
- `score` - хар-ка, на основе которой считается диспкласс, зависит от посещений 
и кликов. Отображение score -> disp_class индивидуально для каждого города.
- `short_name` - короткое имя организации в Справочнике.
- `tags` - дополнительные строковые тэги (флаги).
- `type` - тип организации, определенный по итогам прохождения фильтров (см. ниже).

#### Типы организаций для попадания на подложку

Организации Справочника имеют разное качество данных, и в зависимости от него 
мы принимаем решение, хотим или не хотим добавлять их в extra_poi_bundle, а 
также с каким диспклассом (он определяет зум на подложке, на котором 
организация будет отображаться). 
Можно выделить следующие типы организаций:

- `good` - организация проходит требуемые фильтры. Для приоритетных организаций 
(например, геопродукт) список фильтров небольшой, но они обязательны (наличие 
рубрики, координат и т.д.), для организаций, которых нет в НЯК, список фильтров 
шире. У организаций типа `good` нет ограничений по добавлению на общие зумы, 
увеличение популярности приведет к "подъему" организации на подложке.
- `extra` - эти организации, хоть и проходят обязательные фильтры, при этом не 
проходят доп. фильтры, в результате чего мы считаем организации "подозрительными" 
и не хотим показывать их на общих зумах. Однако они приемлемы на детальных зумах 
если также проходят ряд фильтров на имя, рубрику и т.д. Наличие этих организаций 
сильно увеличивает полноту подложки на 19 зуме и детальнее.
- `bad` - не хотим видеть организацию на подложке и не отдаем ее в 
extra_poi_bundle. Организация может не проходить как обязательные фильтры, так и 
фильтры, необходимые для попадания хотя бы на детальные зумы.

#### Приоритетные организации

Разные организации проходят через разный список фильтров. Есть фильтры, 
обязательные для **всех** организаций (см. ниже), но большая часть фильтров 
применяется только для неприоритетных организаций, качество данных которых 
нужно проверять. Приоритетными организациями являются те организации, которые с 
высокой вероятностью должны быть на подложке. К ним применяются только 
обязательные фильтры. Организации, которые являются приоритетными:

- Геопродукт
- Яндекс.Заправки
- Организации, отсмотренные и публикующиеся вручную 
(`is_manual_publishing = True`)
- Организации, которые уже есть в Народной Карте

#### Список причин непопадания на подложку

Наличие хотя бы одной из следующих причин достаточно для непопадания в 
extra_poi_bundle **любой** организации:

- `Foreign` - организация находится в стране, с которой пайплайн не работает.
- `InvalidCoordinates` - отсутствует широта или долгота.
- `NoMainRubric` - у организации отсутствует главная рубрика.
- `NoMatchingFtType` - соответствующая рубрика организации отсутствует в 
Народной Карте.
- `NoRubrics` - у организации вообще не проставлены рубрики.
- `NotPublished` - организация распубликована в Справочнике.
- `FreshNotPublished` - организация недавно распубликовалась в Справочнике, 
информация еще не появилась в `orginfo`.

Следующие причины действительны только для неприоритетных организаций. Наличие 
хотя бы одной причины достаточно для того, чтобы организация не получила тип 
`good`. Исключение составляют страны с упрощенной фильтрацией, в зависимости от 
страны рассматриваются кастомные комбинации этих причин.

- `BadFtRubric` - соответствующая рубрика организации в Народной карте 
находится в черном списке. Список рубрик можно найти 
[здесь](https://a.yandex-team.ru/arc/trunk/arcadia/maps/poi/static_poi/poi.py?rev=r8417265#L35).
- `BannedByName` - название организации содержит запрещенные слова или фразы. 
Примеры стоп-слов можно найти 
[здесь](https://a.yandex-team.ru/arc/trunk/arcadia/maps/poi/pylibs/util/names.py?rev=r8417265#L22).
- `BannedBySpravRubric` - рубрика организации в черном списке. 
Список рубрик можно найти 
[здесь](https://a.yandex-team.ru/arc/trunk/arcadia/maps/poi/static_poi/poi.py?rev=r8417265#L21).
- `DuplicateByName` - у организации имя совпадает с именем более важной 
организации в здании.
- `NameContainsFIO` - имя организации содержит ФИО человека.
- `NoEntrance` - у организации нет данных о входах.
- `NoManualCoordinate` - координаты организации определены автоматически.
- `NonPrettyName` - у организации отсутствует название на языке, родном для 
страны, где находится организация, либо имя непригодно для подписи на подложке - 
слишком длинное, много слов, содержит неотображаемые символы и т.д.
- `OutsideTheBuilding` - организация находится дальше чем в 1 метре от здания.

При наличии причин выше организация в лучшем случае может получить лишь тип 
`extra` (показывается только на детальных зумах). Это произойдет в случае 
отсутствия других причин. Если же у организации есть хотя бы одна из следующих 
причин, организация не попадет в extra_poi_bundle (получит тип `bad`).

- `ExtraOrgBannedBySpravRubric` - рубрика организации в черном списке. Список 
рубрик отличается от списка для причины `BannedBySpravRubric`, так как для 
организаций на детальных зумах набор запрещенных рубрик иной. Полный список 
можно найти 
[здесь](https://a.yandex-team.ru/arc/trunk/arcadia/maps/poi/pylibs/util/prioritization.py?rev=r8417265#L22).
- `ExtraOrgNonPrettyName` - неподходящее имя организации для присутствия на 
подложке.
- `ExtraOrgOutsideTheBuilding` - организация из `cis1` находится вне зданий и 
при этом имеет неподходящую для этого рубрику.
- `SuspiciousSource` - организация пришла в Справочник из подозрительного 
источника (например, [Foursquare](https://developer.foursquare.com)).

#### Совместимость

На самом деле, extra_poi_bundle (то есть таблица `data`) формируется напрямую из 
static_poi с использоваем одного единственного маппера, код которого можно найти 
[здесь](https://a.yandex-team.ru/arc/trunk/arcadia/maps/poi/static_poi/bundle.py?rev=6484806#L4). 
В нем рассматриваются возможные причины непопадания на подложку и является ли 
организация приоритетной. Приоритетной может быть не только геопродуктовая 
организация или Я.Заправка, но и организация, которая уже есть в НЯК (в этом 
случае она не прогоняется через часть фильтров).

### Добавление и удаление эксперимента

Для упрощения A/B тестирования и изучения влияния различных вариантов 
ранжирования на подложку предусмотрена возможность добавления экспериментов. 
Чтобы реализовать поведение, специфичное для эксперимента, в общем случае 
требуется сделать следующие вещи:

1. Выбрать имя для эксперимента и добавить сооветствующую константу 
[сюда](https://a.yandex-team.ru/arc/trunk/arcadia/maps/poi/static_poi/constants/experiments.py). 
Желательно добавить описание и тикет с соответствующей задачей.
2. Сделать логические правки в нужных местах кода.
3. Добавить эксперимент в поле `experiments` на странице Шедулера (ссылку см. 
в информации для потребителей). Если запускать бинарник `build_static_poi` 
вручную, то достаточно просто добавить cmd-параметр `--experiment <name>`.

Если эксперимент было решено применить, то следует удалить его из списка 
констант, из списка экспериментов в Шедулере, а также сделать требуемые правки 
в логике кода.

### Геопродукт

#### Потоки данных

Источником информации о том, что организация является геопродуктовой, служит таблица
[//home/geoadv/export/production/priority_company_permanent_id](https://yt.yandex-team.ru/hahn/navigation?offsetValue=122908&path=//home/geoadv/export/production/priority_company_permanent_id).
В рамках регулярного расчёта
[personalized_poi](https://a.yandex-team.ru/arc/trunk/arcadia/maps/poi/personalized_poi) 
создаётся таблица 
[//home/maps/poi/data/orginfo](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/data/orginfo),
в которой сохраняется слепок открытых `publish` и временно закрытых
`temporarily_closed` организаций не дубликатов из справочника и проставляются
признаки `is_geo_product` и `is_protected_geo_product`. Далее для организаций из
orginfo в рамках описываемого здесь расчёта static_poi производится вычисление
`display_class` и создаётся выгрузка
[extra_poi_bundle](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/extra_poi_bundle/stable_v2),
которая используется в качестве источника данных в
[ymapsdf](https://a.yandex-team.ru/arc/trunk/arcadia/maps/garden/modules/extra_poi_bundle).
Итоговая подложка формируется по данным из ymapsdf.

#### Известные причины отсутствия геопродуктовой организации на подложке

* Организация 
  [не является "валидной"](https://a.yandex-team.ru/arc/trunk/arcadia/maps/poi/personalized_poi/builder/lib/extract_info_mappers.py?rev=7520922#L324).
  К подобным организациям относятся
    * online организации,
    * организации, для которых отключен экспорт в справочнике,
    * организации со 
      [статусом публикации](https://wiki.yandex-team.ru/sprav/altay/statuses-of-publication/)
      отличным от `publish` (публиковать), например, `closed`,
      `temporarily_closed`, `geo_spam`,
    * организации с типом отличным от `ordinal` (обычные компании), например,
      `chain`, `advert`.
* Данные об организации неполны:
    * отсутствуют широта и/или долгота,
    * отсутствует основная рубрика либо список рубрик пуст.
* Организация относится к стране, для которой не производится расчёт static_poi.
  Список стран настраивается на странице Шедулера (ссылку см. в информации для 
  потребителей).
* В [Народной карте](http://n.maps.yandex.ru) организация имеет Label priority
  выставленный в `ignore`, что соответствует `display_class = 10`. Такое значение
  выставляется по-умолчанию для следующих категорий организаций:
    * государственные организации, запрещенные к публикации: военкоматы,
      государственные службы безопасности, исправительные учреждения,
    * оптовая торговля: овощи и фрукты оптом, рыба и морепродукты оптом, одежда
      оптом, стройматериалы оптом и т.п.,
    * временные организации, которые отображаются в рамках спецпроектов:
      ёлочный базар,
    * организации без офиса/трудно подтверждаемые: интернет-магазины, такси,
      жилье-посуточно.
* Организация конфликтует с другим более приоритетным объектом подложки, 
  например, другой организацией с меньшим `display_class`, станцией метро, 
  адресной табличкой, подписью улицы. Для защищенного геопродукта эта проблема
  решается в рамках проекта
  [static_poi2nmaps](https://a.yandex-team.ru/arc/trunk/arcadia/maps/poi/static_poi2nmaps).
  Однако этот процесс не покрывает следующие краевые случаи:
    * у организации нет адреса, 
    * адрес организации не соответсвует реальному местоположению,
    * организация находится вне дома, 
    * организация конфликтует с другим объектом вне дома.

#### Расчёт display_class для геопродуктовой орагизации

Геопродуктовые организации разбиты по рубрикам на три класса:
* [Серые](https://a.yandex-team.ru/arc_vcs/maps/poi/pylibs/util/prioritization.py?rev=52322a4a782f6eefc20d60afd4b654a0c89ad14d#L3)
  включают в себя тату-салоны, ночные клубы, казино, сауны, банкоматы, пункты выдачи и т.п.,
* [Чёрные](https://a.yandex-team.ru/arc/trunk/arcadia/maps/poi/pylibs/util/prioritization.py?rev=r7615814#L21)
  включают массажные салоны, ломбарды, игровые клубы, букмейкерские конторы,
  секс-шопы, эзотерику и т.п.,
* Белые - все остальные.

Отдельно еще определён класс 
[непопулярных геопродуктовых организаций](https://a.yandex-team.ru/arc/trunk/arcadia/maps/poi/pylibs/util/prioritization.py?rev=r7615814#L42),
куда вошли рубрики с низкой конверсией из показа в клик: ювелирные магазины,
бижутерия, банки, банкоматы, социальные службы и т.д.

Для геопродуктовых организаций сначала осуществляется стандартный расчёт
`display_class` по дипкликам и посещениям, в случае чёрного геопродукта полученное
значение ранжирующей формулы домножается на 0.8, за счёт чего эти организации
пессимизируются. Затем к полученному значению `display_class` применяются
следующие преобразования:
* если `display_class` рассчитать не получилось, либо он больше 7, то он 
  объявляется равным 7, иначе из предыдущего значения вычитается 0.1,
* если геопродукт белый, то из его `display_class` вычитается 1,
* если геопродукт серый, чёрный либо непопулярный и его `display_class` меньше 5,
  то он объявляется равным 5,
* если геопродукт получил значение `display_class` меньше 3.5, то оно 
  объявляется равным 3.5.
* полученный `display_class`
  [расщепляется](https://a.yandex-team.ru/arc/trunk/arcadia/maps/poi/static_poi/bundle.py?rev=7614623#L19)
  на целую `dispClass` и дробную `dispClassTweak` части.

Настройками дизайна обеспечивается, что зум, начиная с которого возможен показ,
равен `dispClass + 11`. Таким образом для геопродукта, прошедшего фильтры,
возможны показы на следующих зумах:
* белый: 15-21,
* серый, чёрный, непопулярный: 16-21.

####  A/B эксперименты с геопродуктом

Запущенных экспериментов на данный момент нет.

### Добавление организаций вручную

В случае отсутствия организации в Народной карте, можно добиться того, чтобы она 
оказалась в extra_poi_bundle, избежав при этом большинства фильтров (по аналогии 
с геопродуктом). От организации требуется только статус "публиковать" в 
Справочнике и валидные координаты. Для этого требуется добавить пермалинк 
организации и опционально имя в YT-таблицу
[//home/maps/poi/data/manual_publications](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/data/manual_publications). 
Таблица имеет следующий формат:

- `permalink` - пермалинк организации в Справочнике.
- `name` - имя (опционально). При наличии будет иметь приоритет над именем из 
Справочника. Представляет собой словарь локаль - текст.

Эта таблица получается ручным объединением и сортировкой таблиц из
[//home/maps/poi/data/manual_publications_sources](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/poi/data/manual_publications_sources).

По аналогии с геопродуктом в случае отсутствия рубрики будет проставлена дефолтная, 
а целочисленный `display_class` не будет больше 8 для возможности публикации на 
подложке.
