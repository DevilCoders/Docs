MRR
=
### Общее определение
**MRR** (mean reciprocal rank, среднеобратный ранг) - в общем случае, 
статистическая оценка откликов процесса на запросы, упорядоченных по вероятности и правильности.

# Ранги организаций

## Как считается ранг организации

Ранги считаются в бинаре 
[poi_ranks](/arc_vcs/maps/poi/statistics/poi_ranks).

Для каждой организации берется ее окрестность фиксированного размера. 
Организации сортируются по `display_class` и `disp_class_tweak` по возрастанию. 
Порядковый номер организации в этом списке и будет ее рангом.

### Связь рангов с подложкой

Отдельно считается ранги на основе `display_class` + `display_class_tweak` из `ymapsdf` (Народная Карта) и `static_poi` (Справочник), 
что позволяет в дальнейшем сравнивать ранжирования.
В текущей реализации на подложку попадают организации с минимальными `display_class` + `display_class_tweak` среди `ymapsdf` и `static_poi`.

### Пример расчета ранга

Допустим размер окрестности равен 10 метрам.

Пусть два poi располагаются на расстоянии 5 метров друг от друга. 
У первого poi `display_class` = 7, `display_class_tweak` = 0.0, у второго `display_class` = 8, `display_class_tweak` = 0.0. 
В данном случае первому poi будет присвоен ранг 1, а второму poi ранг 2.

### Связь display_class, display_class_tweak и зума

Формула связывающая минимальный зум, на котором poi может отобразиться на картах, 
и `display_class`: `zmin = disp_class + 11`, если `display_class <= 8`.
Если `display_class = 9` и `display_class_tweak <= 0`, то `zmin` = 20. 
Если `display_class = 9` и `display_class_tweak > 0`, то `zmin` = 21.

Если между poi есть конфликты (два poi расположены слишком близко к друг другу и их нельзя отобразить на текущем зуме одновременно), 
то `zmin` может быть больше указанных выше значений. 
Конфликты разрешаются с использованием `display_class` и `display_class_tweak`: 
сначала отдается предпочтение poi с наименьшим `display_class`, 
а если конфликтуют два poi с одинаковым `display_class`, 
то сравнивается `display_class_tweak`.


### Обоснование примера

Для данных poi верна формула `zmin = disp_class + 11`.
Получется, первый poi покажется на 18 зуме, а второй - только на 19. 
Поскольку первый poi показался на более высоком зуме, его ранг выше.

# MRR в случае poi

В случае poi запрос — это желание пользователя найти определенную организацию. 
Считается, что организация искомая, если пользователь на нее кликнул (учитываются только `deep_click`-и). 
Отклик — отображение poi на картах на подложку на том или ином зуме. 

Ранг организации считается на основе порядкового номера `display_class` + `display_class_tweak`
в некоторой круглой окрестности ее poi фиксированного радиуса. 
Величина `display_class` + `display_class_tweak` используется при разрешении конфликтов между poi 
и напрямую влияет на минимальный зум, 
на котором poi организации отобразится на картах. 
Чем меньше `display_class` + `display_class_tweak`, тем больший приоритет у poi при разрешении конфликтов 
и тем раньше (на более маленьких зумах) он отобразится.

Соответственно, ранг показывает, 
как скоро пользователь увидит poi в процессе просмотра карты, 
начиная с обзорных масштабов, относительно других poi в этой окрестности.
Чем меньше минимальный зум, на котором отображается poi, 
тем меньше его ранг и больше его обратный ранг. 

Информация о кликах и рангах берется из 
[датасета подложки](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/analytics/datasets/basemap). 
Датасет формируется при помощи 
[workflow в nirvana](https://nirvana.yandex-team.ru/flow/de5de133-dc8b-4bd5-9ba2-434aeebb4138/c7c73f7c-2390-4b6b-b28e-25010957c0cd/graph). 
[Папка](https://a.yandex-team.ru/arc/trunk/arcadia/maps/analytics/datasets/basemap) датасета подложки в аркадии.

Итоговое MRR получается из среднего обратных рангов организаций, 
по которым были `deep_click`-и. 
Если организацию искали несколько пользователей, 
то при вычислении среднего ее обратный ранг входит в сумму также несколько раз.

Другими словами, MRR показывает, насколько хорошо мы ранжируем организации на подложке 
с точки зрения `deep_click`-ов пользователей.

MRR по определению находится в диапазоне от 0 до 1. 
Чем ближе MRR к 1, тем лучше ранжирование.

## Пример расчета MRR
### Хорошее ранжирование
Рассмотрим расчет метрики на небольшом датасете, 
который мог бы возникнуть при хорошем ранжировании.
```
{"ymapsdf_poi_rank":1, "permalink":1, "session_id":1, "user_id":1}
{"ymapsdf_poi_rank":1, "permalink":2, "session_id":2, "user_id":2}
{"ymapsdf_poi_rank":1, "permalink":3, "session_id":3, "user_id":3}
```
3 пользователя искали 3 разных организации. 
Допустим, poi в окрестности искомых poi имели те же `display_class` + `disp_class_tweak`, что и в `ymapsdf`, 
то есть были проранжированы в соответсвии с `ymapsdf`. 

Тогда в этом случае, когда пользователи смотрели на карту, 
искомые poi были выше остальных, 
то есть пользователям не нужно было дополнительно увеличивать зум карты, чтобы найти желаемый poi. 

MRR = (1/1 + 1/1 + 1/1)/3 = 1

### Плохое ранжирование
Рассмотрим расчет метрики на небольшом датасете, 
который мог бы возникнуть при плохом ранжировании.
```
{"ymapsdf_poi_rank":10, "permalink":1, "session_id":1, "user_id":1}
{"ymapsdf_poi_rank":10, "permalink":2, "session_id":2, "user_id":2}
{"ymapsdf_poi_rank":10, "permalink":3, "session_id":3, "user_id":3}
```
3 пользователя искали 3 разных организации. 
Допустим, poi в окрестности искомых poi имели те же `display_class` + `disp_class_tweak`, что и в `ymapsdf`, 
то есть были проранжированы в соответсвии с `ymapsdf`. 

Тогда в этом случае, когда пользователи смотрели на карту, 
искомые poi были ниже других 9 poi 
и пользователям приходилось увеличивать зум карты, чтобы найти нужную организацию.

MRR = (1/10 + 1/10 + 1/10)/3 = 0.1

## Метрика

На данный момент реализовано несколько метрик MRR 
(они отличаются способом вычисления ранга и наличием/отсутствием фильтра).
Описание способа вычисления метрики находится в 
[analytics/metrics](/arc_vcs/maps/analytics/metrics/basemap/metrics.py).
