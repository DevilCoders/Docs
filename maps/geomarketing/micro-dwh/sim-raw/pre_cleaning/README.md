# Pre-cleaning - предварительная очистка

В этой дирректории находятся находятся скрипты,
которые создают таблицы из объёмных логов, которые
невозможно обработать обычным запросом. Как правило
для создания таблицы используется цикл, который батчами
забирает таблицы.
В цикле не получится сделать WITH TRUNCATE, так как, в таком случчае,
каждый батч будет перезаписывать предыдущий. По этой причине, таблицы
формируются двумя скриптами - первый очищает, второй загружает в неё данные.
В связи с этим, в Nirvana создаётся два соответствующих, последовательных кубика.

### Названия файлов
* Основной скрипт для создания таблицы называется так же, как и сама таблица,
например: ***sendr_delivery_log.yql*** создаёт таблицу ***sendr_delivery_log***.
* Скрипт для очистки таблицы должен иметь название, аналогичное основному скрипту
для создания таблицы, но с приставкой ***clear_***. Например, для очистки таблицы
***sendr_delivery_log*** будет использован скрипт ***clear_sendr_delivery_log.yql***.

Важно, что кубики в Nirvana должны находиться в тех же слоях и называться
точно так же, как и файлы скриптов, а следовательно и таблицы.
Это позволит легче находить ошибки и понимать зависимости между таблицами.

### Принцип работы очистки
Так как, в YQL нет явного DELETE FROM table, для очистки таблицы
используется запрос тех же данных, что и в основном запросе, но без цикла
с обязательным использованием ***LIMIT 0*** и ***WITH TRUNCATE***.
Это действие позволяет создать правильную схему таблицы, но оставить её пустой.

### Основной скрипт
Как правило, основной скрипт будет содержать цикл.
Для цикла необходимо подготовить список, по которому будет
совершён проход. Пример работы цикла по батчам дат, можно посмотреть
в файле ***sendr_delivery_log.yql***.

### Что можно сделать?
Для ускорения работы скриптов, можно сделать не перезаггрузку таблиц,
а дозагрузку для тех дат/id, которые появились с момента последнего обновления.
В этом случае, следует выключить скрипт очистки. Важно, что нужно всегда иметь возможность
полной перезагрузки, в случае изменения условий в запросах.
