# [GMA-1453](https://st.yandex-team.ru/GMA-1453) Индекс настроений smb 2022 таблица для рассылки и дэшборд


### Периодичность сбора:
Только рабочие дни


### Результаты:
* [Таблица для рассылок](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/marketing/smb/micro-dwh/mailing/GMA-1453/latest) - каждый
день 2000 уникальных email, которым ещё рассылка не проводилась.
* [История](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/marketing/smb/micro-dwh/mailing/GMA-1453/history) - все
email, которым отправляли рассылку, используем для фильтра email-ов.
* [Граф в Nirvana](https://nirvana.yandex-team.ru/browse?selected=11577044) -
работает каждый день, в субботу и воскресенье записывает пустую таблицу.


**Поля таблицы:**
* ***rubric_name*** - название рубрики, используются названия из
требуемых рубрик (т.е. у организации могут быть и другие);
* ***permalink*** - id организации;
* ***org_id*** - id организации или сети в приортете на id сети;
* ***company_name*** - название организации;
* ***email*** - email пользователя (по существующей приоритезации от
owner-а и наличия email + согласие на новостную рассылку);
* ***email_sha256*** - хэш email-а;
* ***is_chain*** - признак сети, True если сеть;
* ***company_city*** - город организации;
* ***is_active_campaign*** - наличие активной РК в Яндекс Бизнес
на предыдущий день (на текущий нет информации);
* ***last_campaign_package_type*** - тип последней РК в Яндекс Бизнес,
если есть активная, то указан тип активной РК, которая была запущена последней;
* ***update_date*** - дата обновления таблицы;
* ***update_date_sha256*** - хэш дата обновления таблицы;


### Логика сбора данных:
1. В папке с историей создаётся пустая таблица с необходимой схемой,
этот шаг важен для самого первого запуска.
2. В папку с историей, в таблицу, названием которой
является текущая дата, записывается 2000 уникальных email-ов.
    * Оставляем только РФ и email у которых присутствует "@";
    * Исключаем тех, кто уже был в рассылки, проверяя исторические таблицы;
    * Исключаем тех, у кого нет согласия на новостную рассылку;
    * Забираем 2000 случайных уникальных email-ов;
    * В выходные дни записываем пустую таблицу.
3. В таблицу latest, которая используется для рассылки, загружается последняя
из всех исторических таблиц.
