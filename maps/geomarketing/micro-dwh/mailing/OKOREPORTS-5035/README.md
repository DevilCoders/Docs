# [OKOREPORTS-5035](https://st.yandex-team.ru/OKOREPORTS-5035) Рассылка **Almost Done**


### Описание:
Рассылка **Almost Done** отправляется пользователям, которые посещали
страницы с информацией/возможностью_создания РК в Яндекс Бизнес. В письме
содержится информация о стоимость РК в месяц в разрезе тарифов.
Письма отправляются каждый день.

**Основные критерии:**
- Посещали страницы "https://yandex.ru/business/priority/%" или
"https://yandex.ru/business/boost/%" за последние 2 дня от текущего.
- В данных Метрики указан паспортный ID и из ссылки можно достать валидный permalink.
- У организации или её бизнес-снапшотов не было создано новых РК за последние 90 дней.
- Организации в статусе "Опубликован" или "Временно закрыт".
- Организации только из России.
- Сетевые организации исключены.
- Организация ни разу не откручивалась.
- Пользователь не имел откруток (т.е. ни одна организация, с которой он связан не откручивалась).
- Если пользователь является балансовым клиентом, то у него ни разу не было откруток.
- Возможность арбитража для организации определяется по рубрикам из таблицы [bad_rubrics_for_arbitrate](https://yt.yandex-team.ru/hahn/navigation?path=//home/geoadv/geoproduct/intermediate/arbitrage/bad_rubrics_for_arbitrate).
- Удалось определить стоимость РК;
- Email пользователя должен содержать "@", email берётся по условию - если есть в Справочнике,
то из Справочника, если нет, то ищем в логах Бизнеса.
- Email в рассылке уникален, выбирается случайнная организация, если их несколько.
- Письмо отправляется не чаще, чем 1 раз в 90 дней.


### Основные ссылки:
* [YT](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/marketing/smb/micro-dwh/mailing/OKOREPORTS-5035) - хранение данных;
* [Nirvana](https://nirvana.yandex-team.ru/browse?selected=12240201) - workflow обработки данных и отправки писем;
* [Рассылятор](https://sender.yandex-team.ru/yandex.spravochnik/campaign/764981/overview) - информация о рассылке.


### Переменные в шаблоне письма:
* **val1** - название организации (наличие опционально);
* **val2** - стоимость РК в месяц при оплате за 90 дней;
* **val3** - стоимость РК в месяц при оплате за 180 дней;
* **val4** - стоимость РК в месяц при оплате за 360 дней;
* **val5** - дата сбора данных о ценах (равна дате отправки).


### Периодичность сбора:
Каждый день в [основном пайплайне](https://nirvana.yandex-team.ru/flow/744f9c71-e96b-4c90-b40d-db16d4fc34ac/e1eb6925-0ab8-46a7-b21c-f0f60e47e184/graph/FlowchartBlockProcess/code/regular_mailing).


### Результаты:
Так как, рассылка отправляется из Nirvana, то для самой отправки используются
только необходимые данные. Вся информация логируется в таблицу **[log](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/marketing/smb/micro-dwh/mailing/OKOREPORTS-5035/log)**.
Все остальные таблицы являются вспомогательными, ежедневно обновляются и хранят данные
только за дату последнего успешного выполнения процесса.

Поля таблицы **[log](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/marketing/smb/micro-dwh/mailing/OKOREPORTS-5035/log)**:
* **add_date** - дата попадания в лог;
* **add_ts** - дата и время попадания в лог;
* **update_date** - дата обновления лога;
* **update_date_sha256** - хеш даты обновления лога;
* **yandex_puid** - паспортный ID пользователя;
* **object_role** - роль пользователя в организации;
* **is_notify_tycoon_news** - согласие на рыссылку;
* **email** - email пользователя;
* **email_sha256** - хеш email-а пользователя;
* **permalink** - идентификатор организации;
* **main_rubric_name** - основная рубрика организации;
* **company_name** - название организации;
* **company_on_business** - ссылка на РК организации (для удобства проверки);
* **company_on_maps** - ссылка на карточку организации (для удобства проверки);
* **geo_id** - geo id адреса организации;
* **with_arbitration** - тип возможных РК для организации;
* **price_type** - тип РК, для которого рассчитаны цены;
* **price_90** - стоимость РК в месяц, при оплате за 90 дней;
* **price_180** - стоимость РК в месяц, при оплате за 180 дней;
* **price_360** - стоимость РК в месяц, при оплате за 360 дней;
* **sendr_status** - статус отправки письма (до отправки, у всех *ready_to_sent*)
* **status_update_ts** - дата и время обновления статуса отправки;


### Порядок сбора данных (указаны названия файлов):
* **tmp** - подготовка данных для сегодняшней отправки, выполнение большей части условий;
* **get_prices** - определение стоимости РК для организации (используется API geoadv);
* **log** - записываем данные в лог, присваиваем статус рассылки *ready_to_sent* для сегодняшнего батча;
* **update_log_exclude_emails** - для сегодняшнего батча исключаем email-ы, у которых за последние
90 дней есть статус отправки 'OK';
* **clearing_log** - очищаем лог от возможных дубликатов (могут возникнуть при перезагрузке
скрипта несколько раз в течение одного дня);
* **sample:**
  * **_with_arbitration** - формируем семпл данных для отправки по организациям с арбитражем;
  * **_without_arbitration** - формируем семпл данных для отправки по организациям без арбитража.
* **sender_query:**
  * **_with_arbitration** - запрос данных для отправки сообщений организациям с арбитражем;
  * **_without_arbitration** - запрос данных для отправки сообщений организациям без арбитража.
* **sender_vals** - набор переменных для отправки писем;
* **sender_vals_copy** - набор переменных для отправки копий писем на один email;
* **get_sender_result** - набор переменных, которые забираем после отправки писем (основное - *status* отправки);
* **update_log_sender_statuses** - обновляем статусы отправки в логе.
