# [GMA-1293](https://st.yandex-team.ru/GMA-1293) Подготовить таблицы для письма "Статистика РК"

## Описание
Каждый день, в 9 утра запускается [процесс](https://nirvana.yandex-team.ru/browse?selected=11341791)
сбора статистики для рассылки. Его продолжительность около 2-х часов (бывает до 4-5 часов). Для текущего дня, забираем все РК, которые 2 дня назад непрерывно
отработали первые 30 дней после старта или после 30-дневного перерыва. Затем проверяются
различные исключения и собирается статистика + обновляются таблицы для рассылки.

Выделены 2 сегмента РК:
* **Приоритетное размещение:** "Приоритетное размещение", "Брендированное приоритетное размещение". Располагается в папке **[priority_placement](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/marketing/smb/email-sender-tables/GMA_1293_ac_statistics/priority_placement)**.
* **Рекламная подписка для оффлайн организаций:** "Рекламная подписка для оффлайн организаций", "Рекламная подписка для сетей". Располагается в папке **[offline_orgs](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/marketing/smb/email-sender-tables/GMA_1293_ac_statistics/offline_orgs)**.

Каждый день, эти таблицы обновляются, а в одноимённые таблицы в папке ***logs*** записывается история таких РК.

***Результирующие таблицы содержат следующие поля:***
* **add_date** - дата попадания в лог (должно быть датой отправки);
* **add_ts** - дата и время попадания в лог (тех. поле);
* **create_date** - дата создания таблицы для отпраки;
* **create_date_sha256** - хеш даты создания таблицы для отправки;
* **campaign_id** - id РК;
* **balance_client_id** - id балансового клиента;
* **permalink** - id организиации в Справочнике;
* **company_name** - название организации;
* **mailing_type** - тип сегмента для рассылки;
* **start_period** - начало периода сбора данных (30 дней до старта РК);
* **start_campaign** - старт РК;
* **end_period** - конец периода сбора данных (30 дней после старта РК);
* **clicks_before** - клики за 30 дней до старта РК;
* **clicks_after** - клики за 30 дней действия РК;
* **clicks_change_perc** - изменения кол-ва кликов за период действия РК относительно предыдущего периода в процентах;
* **gdu_before** - GDU за 30 дней до старта РК;
* **gdu_after** - GDU за 30 дней действия РК;
* **gdu_change_perc** - изменения кол-ва GDU за период действия РК относительно предыдущего периода в процентах;
* **first_metric_type** - тип первого показателя;
* **first_metric_before** - первый показатель за 30 дней до старта РК;
* **first_metric_after** - первый показатель за 30 дней действия РК;
* **first_metric_change_perc** - изменения первого показателя за период действия РК относительно предыдущего периода в процентах;
* **second_metric_type** - тип второго показателя;
* **second_metric_before** - второй показатель за 30 дней до старта РК;
* **second_metric_after** - второй показатель за 30 дней действия РК;
* **second_metric_change_perc** - изменения второго показателя за период действия РК относительно предыдущего периода в процентах;
* **object_role** - роль пользователя в объекте (owner, delegate);
* **object_type** - тип объекта (company, chain);
* **email** - email пользователя;
* **email_sha25** - хеш email-а пользователя.

Столбцы *first_metric_type* и *second_metric_type* формируются следующим образом:
1. Собираем показатели:
   * Построено маршрутов, обозначение "routes"
   * Переходы по кнопке действия, обозначение "action_clicks"
   * Звонки, обозначение "calls"
2. Сортируем их в порядке убывания количества;
3. Первый по количеству записываем в first_metric, второй в second_metric.

*Важно, что в финальных таблицах
**[priority_placement](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/marketing/smb/email-sender-tables/GMA_1293_ac_statistics/priority_placement)**
и **[offline_orgs](https://yt.yandex-team.ru/hahn/navigation?path=//home/maps/marketing/smb/email-sender-tables/GMA_1293_ac_statistics/offline_orgs)**
нельзя суммировать показатели, так как РК не уникальна, количество дубликатов зависит от количества email-ов организаций,
ктоторые откручивались в этой РК.*

## Проблемы
* Не совсем понятно, из чего складываются GDU. По таблицам со статистикой
[кампаний](https://yt.yandex-team.ru/hahn/navigation?path=//home/geoadv/geoproduct/statistics/campaign_stat)
и [пермалинков](https://yt.yandex-team.ru/hahn/navigation?path=//home/geoadv/geoproduct/statistics/permalink_stat)
не смог понять, какие показатели сложить, чтобы получилось GDU. Возможно стоит пересмотреть список показателей,
которые показываем в *first_metric* и *second_metric*.
* Сбор данных происходит на второй день после окончания 30-дневного периода, т.е. на 32 от старта РК. Это связано с тем,
что таблицы со статистикой
[кампаний](https://yt.yandex-team.ru/hahn/navigation?path=//home/geoadv/geoproduct/statistics/campaign_stat)
и [пермалинков](https://yt.yandex-team.ru/hahn/navigation?path=//home/geoadv/geoproduct/statistics/permalink_stat)
обновляются в разное время, могут как утром, так и поздно вечером.
* Надо проверить случаи, когда открутки по РК были, но статитстики за эти дни не было вовсе.

## Файлы и таблицы
Названия и места хранения YQL-файлов повторяют названия и структуру хранения таблиц.
Исключением являются файлы, в названиях которых есть приставка к *_excluded_campaigns.yql*.
В них происходит процесс добавления записей о исключённых РК.
Все таблицы, кроме логов каждый день перезаписываются, логи дописываются.
В случае, если в один день пайплайн будет перезапущен, предусмотрен шаг очистки от дубликатов.

## Пайплайн
1. **last_campaign_session** - определяем даты старта РК или даты старта РК после 30-дневных перерывов.
2. **tmp/excluded_campaigns** - создаём таблицу с РК, которые подлежат исключению.
3. **tmp/target_campaigns_and_permalinks** – оставляем только нужные РК, находим для них permalink-и.
4. Сбор статистики:
   1. **tmp/pre_active_statistics_after** - собираем статистику по РК, за 30-дневный период активности
      (сбор основан на [статистике РК](https://yt.yandex-team.ru/hahn/navigation?path=//home/geoadv/geoproduct/statistics/campaign_stat)
   но встречались случаи, когда открутки были, но статистики в этой таблице не было).
   2. **tmp/pre_not_active_statistics_before_and_after** - сбор статистики по permalink-ам за все 60 дней
      (30 дней до старта РК и 30 дней действия РК).
5. **tmp/add_excluded_campaigns** - дополняем таблицу с исключениями.
6. **tmp/pre_all_stat** - подготавливаем общую статистику за 60 дней. В этом шаге, предусмотрены ситуации, если
в РК будет изменяться кол-во permalink-ов, для них в период действия РК, когда permalink в ней не участвовал,
будет браться статистика permalink-а в его неактивные периоды. (Сейчас такие ситуации исключаем)
7. **tmp/final_excluded_campaigns** - дополняем таблицу с ичключениями.
8. **tmp/result_statistic** - готовим таблицу для удобного расчёта результатов.
9. **tmp/result** - общая таблица для результатов.
10. **tmp/result_excluded_campaigns** - дополняем таблицу с исключениями.
11. Формируем логи данных (параллельно):
    - **logs/campaigns_for_send** -> **logs/clearing_campaigns_for_send** - данные о РК, для которых возможна отправка.
    - **logs/offline_orgs** -> **logs/clearing_offline_orgs** - данные об РК, которые подходят для отправки Оффлайн организации.
    - **logs/priority_placement** -> **logs/clearing_priority_placement** - данные об РК, которые подходят для отправки Приоритетное размещение.
12. Формируем таблицы для отправки, обновляются каждый день (параллельно):
    - **offline_orgs** - отправка Оффлайн организациям.
    - **priority_placement** - отправка Приритетному размещению.
