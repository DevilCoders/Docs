# Дешёвый трекинг [OKOREPORTS-5166](https://st.yandex-team.ru/OKOREPORTS-5166)

### Основные ссылки
- [Arcadia](https://a.yandex-team.ru/arcadia/maps/geomarketing/datasets/cheap-monitoring) - репозиторий с кодом;
- [Nirvana](https://nirvana.yandex-team.ru/browse?selected=10084342) - старые и **[новые](https://nirvana.yandex-team.ru/browse?selected=12518294)** процесы;
- [DataLens](https://datalens.yandex-team.ru/nddewxc0ho88g-regulyarnyy-fidbek-klientov) - дашборд с результатами опросов;
- [WIKI](https://wiki.yandex-team.ru/gruppa-analitiki-smb-i-geo/cheap-tracking/) - описание проекта, актуальность может отставать.

### Описание
Проект "Дешёвый трекинг" является инструментом для регулярного сбора обратной
связи о продукте Яндекс Бизнес.
По данным из нескольких систем формируются сегменты пользователей. По
этим сегментам производится рассылка писем с опросами. Инструментом для
проведения опросов является [Взгляд](https://surveys.yandex.ru/quicksurvey/list).
Результаты опросов добавляются к собранным сегментам, а затем формируются данные
для дашборда.

### Структура
*! Описана новая структура, в которую следует добавлять все новые сегменты и
в рамках рефакторинга перенести старые. Всё, что находится вне описания, является старой версией.
В Nirvana, скрипты новой структуры находятся
в папке [cheap-monitoring 2.0](https://nirvana.yandex-team.ru/browse?selected=12518289). Там
можно посмореть последоватьельность выполнения. Описание структуры совпадает с последовательностью
выполнения. Подробные README по каждой части находятся в соответствующих директориях.*

**1 Подготовительный этап**

1.1 **segments** - определение всех сегментов и их основных атрибутов. Версионирование
изменения атрибутов. По своей сути, является таблицей-конфигом, где у каждого
сегмента есть свой id. Далее по всему проекту, присвоение атрибутов производится с
помощью этой таблицы по id сегмента.

1.2 **add_cond** - сбор дополнительных параметров для формирования сегментов.
Например определение email-ов, у которых ранее были открутки. Данные из этих
таблиц могут участвовать в формировании одного или нескольких сегментов. Важно,
что для любого сегмента они будут одинаковы.

**2 Формирование сегментов** - директории назваются по названию системы, которая
является источником данных. В каждой директории должен быть файл raw_segments.yql
который создаёт одноимённую таблицу в YT, которая содержит все сегменты по данному
источнику.

2.1 **space** - построение сегментов на основании данных из CRM Space.

2.2 ...

**3 sending** - объединение всех сегментов в одну таблиу, отправка писем
по сегментам, логирование отправки и бэкап лога.
На этом этапе, для каждого сегмента создаётся два файла:
* segment_{id}_query.yql - запрос, который забирает данные по сегменту.
* segment_{id}_vals.groovy - описывает набор переменных, которые надо передать
в кубик для отправки писем.

***Важно, в segment_{id}_vals.groovy в `result.val1` всегда должно быть
`it.email_sha256`, аналогично в шаблоне письма в Рассыляторе, переменная `val1`
должна подставляться в ссылку на опрос. Это необходимо для матчинга ответов с
данными сегментов.***

**4 pythia** - сбор ответов пользователей и матчинг их с данными сегментов.

**5 other_processes** - дополнительные процессы. Внутри директории, под каждый
отдельный процесс заводится новая, в которой хранятся скрипты. Например:
*whatsapp_segment_2* - отправка опросов в whatsapp.

*! По мере проведения рефакторинга, количество шагов будет изменяться.*


### Правила
1. Названия директорий в Arcadia должны быть одинаковы с директориями в YT
и названиями директорий или workflow в Nirvana.
2. Названия файлов в Arcadia одноменны таблицам, которые они создают. В случае,
если скрипт модифицирует таблицу, то в названии файла использовать название таблицы
и короткое слово/фразу, которая характеризует дейтсвие. Например: `log.yql`
создаёт таблицу *log*, а `log_deduplication.yql` исключает дубликаты в таблице
*log*.
3. Один файл - это одна таблица. В исключительных случаях допустимо создание промежуточных
таблиц в рамках одного файла, но только если они необходимы для формирования целевой.
4. В каждой директории в Arcadia должен быть файл README.md с описанием того,
что и как происходит в рамках процессов, которые находятся в директории.
5. В YQL-запросах, используется следующая, обязательная, структура:
- В начале скрипта указывается краткое описание, далее YT директория
и название таблицы:
  ```
  /*
  Объединяем все сегдняшние сегменты в одну таблицу
  и исключаем возможные дубликаты по email-ам
  */


  $table_path = '//home/maps/marketing/smb/cheap-monitoring/sending/';
  $table_name = 'all_segments';
  $result_path = $table_path || $table_name;
  ```
  - Финальную CTE называть $result и делать потом делать INSERT:
   ```
   $result = (
       SELECT
           ...
   );


   INSERT INTO
       $result_path
   WITH TRUNCATE (
       SELECT * FROM $result
   );
  ```
6. Хорошо, когда подзапросы максимально вынесены в CTE, ко всем полям указаны алиасы
таблиц. Если CTE получается очень много, то стоит вынести часть из них в отдельный файл
и собрать ещё одну таблицу.
7. У каждого сегмента должен быть собственный id, который указывается в `/segments/current.yql`
именно по id сегмента происходит получение его основных атрибутов, т.е. slug, название, тип...
отдельно не указываются, а всегда собираются из таблицы.


### Как добавить новый сегмент:
1. Добавить описание сегмента в `/segments/current.yql` аналогично существующим сегментам.
2. Проверить, есть ли в `add_cond` подходящие дополниетельные данные для формирвоания
нового сегмента. Если нет, то добавить.
3. Проверить, существует ли уже директория с названием источника, для формирования нового
сегмента.
    * Если существует, то внести изменения в текущие файлы. При необходимости добавить новые.
    * Если не существует, то создать новую директорию, названием которой будет являться название источника.
    * Важно, что в результатах работы всех скриптов директории должен быть файл `raw_segments.yql`,
   который содержит все сегменты из этого источника.
4. В файле `sending/all_segments.yql` добавить UNION-ом новые данне, если сегменты были из нового источника.
5. В директории `sending` добавить два файла: `segment_{id}_query.yql`, `segment_{id}_vals.groovy`.
6. В [Nirvana](https://nirvana.yandex-team.ru/flow/1f3fb151-f356-4ea9-8283-5e6aab863636/abd58e9e-3333-47c8-94c2-3811054d9bec/graph)
скопировать ту часть, которая отвечает за рассылку по каждому сегменту и в кубиках прописать
пути до новых скриптов. ***Важно! для кубика с названием APPEND провести дополнительную свзяь
от предыдущего аналогичного из другого сегмента.***
