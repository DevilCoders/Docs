# Отправка опросов по сегментам

По каждому сегменту существует свой slug опроса во Взгляде и кампания в Рассыляторе.
Для отправки email-ов из Nirvan-ы, в Рассыляторе заводятся транзакционные рассылки.
Важно, что в шаблоне письма есть часть ссылки на опрос, в который необходимо добавить
хеш email-а. В шаблоне необходимо называть ***переменную для хеша email-а val1***, с таким
же названием он должен быть описан в конфиге на отправку. Хеш email-а необходимо
передавать в ссылку, так как это наиболее простой и точный способ матчинга ответов
с данными об отправке.

### [Nirvana](https://nirvana.yandex-team.ru/flow/1f3fb151-f356-4ea9-8283-5e6aab863636/abd58e9e-3333-47c8-94c2-3811054d9bec/graph)

### Структура
1. **all_segments** - все сегменты собираются в одну таблицу.
Схемы таблиц для всех источников приводятся к единой схеме. Всем email-ам
присваивается статус 'ready_to_send'.
2. Данные для отправки email-ов собираются в двух файлах:
   * {segment_id}_query.yql - запрос, который забиарет необходимые переменные для отправки
     (*segment_id*, *email*, *email_sha256*)
   * {segment_id}_vals.groovy - описание переменных для отправки сообщений через API:
3. В Nirvana отправка по каждому сегменту производится в отдельной выделенной области.
Эту область следует копировать и изменять пути до файлов для отправки новому сегменту.
В самой верхней области, в конце области перезаписывается таблица с логированием отправки,
а в последующих дописывается. Поэтому важно соблюдать последовательность по добавлению
данных в лог с помощью дополнительных связей.
4. **backups/sender_segments_log** - сохраняет вчерашнюю таблицу с логом отправки.
5. **sender_segments_log** - дополняет лог данных, обновляет статусы отправок. Важно,
что в логе хранится вся информация о сегменте, актуальная на дату его сбора - восстановить
её очень сложно. Все манипуляции с логом производить в копии таблицы.


### Полезные поля лога и его бэкапа
* **_create_dt** - дата формирования сегмента, в случае успешной отправки будет равна дате отправки.
* **create_ts** - дата и время формирования сегмента.
* **send_status_dt** - дата получения статуса отправки.
* **send_status_ts** - дата и время получения статуса отправки.
* **_backup_actual_date** - дата, на которую актуален бэкап.
* **_backup_dt** - дата обновления бэкапа.
* **_backup_ts** - дата и время обновления бэкапа.
* Остальные поля относятся к характеристикам лида/задачи/пользователя и их состав
может меняться.
