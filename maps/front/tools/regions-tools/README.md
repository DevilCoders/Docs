# regions-tools
Инструменты для обработки данных границ стран и их регионов (модуль 'Регионы' для javascript API яндекс карт).

## Требования к входным данным
Входные данные должны быть в формате `geojson`.

#### Именование файлов
`ПОЛИТИКА_ТИП.geojson`, где тип - countries или regions.
Пример: `RU_regions.geojson` - политика: RU, файл содержит очертания границ регионов для доступных стран.

#### Специальные случаи для полигонов
Данные для некоторых полигонов требуют специальной обработки перед выгрузкой. Для примера можно привести следующий случай: полигон города Москвы следует вырезать из полигона Московской области. Далее идет перечен таких спеицальных случаев:
* Ненецкий АО создает дырку в Архангельской области
* Ямало-Ненецкий АО создает дырку в Тюменской области
* Республика Адыгея создает дырку в Краснодарском крае
* город Москва создает дырку в Московской области
* город Санкт-Петербург создает дырку в Ленинградской области
* город Байконур создает дырку в Карагандинской области
* город Астана создает дырку в Акмолинской области
* город Минск создает дырку в Минской области
* город Киев создаед дырку в Киевской области

#### Антарктида
Антарктида должна входить в файл с границами стран.


## Инструкция
1. Положите исходные файлы в директорию `in` (https://github.yandex-team.ru/maps-legacy/regions-tools/tree/master/in)
2. Выполните команду `make all` для того чтобы обработать все файлы, или:
    * Для того чтобы обработать данные для стран запустите команду `node bin/ProcessCountries.js`
    * Для того чтобы обработать данные для регионов запустите команду `node bin/ProcessRegions.js`
    * Для того чтобы обработать данные для Антарктиды запустите команды `node bin/ProcessAntarctic.js`
3. Заберите данные из директории `out`


## Обновление данных на сервере
Следуйте [инструкции](https://a.yandex-team.ru/arc_vcs/maps/front/services/regions-service/CONTRIBUTING.md#updating-data) со страницы сервера сервиса "Регионы".


## Именование файлов
Параметр 'политика' описывает к какой стране относить границы спорных территорий.

#### Страны
ПОЛИТИКА_001_язык_качество.json
К примеру: `RU_001_ua_3.json` - Политика: RU, язык: ua, качество 3.

#### Регионы
ПОЛИТИКА_СТРАНА_язык_качество.json
К примеру: `RU_UA_ru_2.json` - Политика: RU, страна: UA, язык: ru, качество: 2.


## Конфигурация
Конфигурация содержится в файле `config.json`. Далее содержится описание для каждого поля конфигурации.

#### mapshaperPath
Путь к утилите `mapshaper`, которая используется для симплификации границ и генерации topojson.

#### regionsQuality
Уровни качества для симплификации границ регионов.

#### countriesQuality
Уровни качества для симплификации границ стран.

#### antarcticQuality
Уровни качества для Антарктиды.

#### availableRegions
Описывает страны для которых доступны границы регионов.

#### availableLanguages
Описывает языки для которых доступна локализация метаданных.

#### availablePolitics
Описывает доступные привязки спорных территорий.

#### politicsForCountries
Описывает политики для которых возможна генерация полигонов стран.

#### politicsToRegions
Описывает какие регионы для стран генерировать для конкретной политики


## Тестовый стенд
Тестовый стенд находится в папке `test-stand`. В него можно загрузить данные в формате `geojson`, `topojson`, `regions-json`.

## Как это работает
Каждый файл проходит несколько этапов. Обычно это:
1. Исправление ошибок топологии и симплификация границ под различные уровни качества
2. Подключение метаданных для различных языков
3. Конвертация в формат regions-json (см. секцию 'Выходной формат данных')
4. Отображение статистики

Далее процессы через которые проходят файлы описаны более детально.

#### Страны
1. Конвертация метаданных в json
2. Отсеивание Антарктиды
3. Исправление ошибок в топологии
4. Склейка полигонов которые были разрезаны 180 меридианом
5. Симплификация для каждого уровня качества
6. Присоединение метаданных для каждого языка
7. Конвертация в `regions-json`
8. Сбор статистики с файлов для каждого уровня качества для локали en

#### Регионы
1. Конвертация метаданных в json
1. Фильтрация нужных стран (см. секцию 'конфигурация', поле 'availableRegions')
2. Исправление ошибок в топологии
3. Склейка полигонов которые были разрезаны 180 меридианом
4. Симплификация. Важно что границы симплифицируются все сразу. Благодаря этому если регионы подключить все вместе их границы будут совпадать
5. Разбитие стран по отдельным файлам
6. Присоединение метаданных для каждого языка
7. Конвертация в `regions-json`
8. Сбор статистики с файлов для каждого уровня качества и каждой страны для локали en


## Доступные команды для обработки данных

#### make all
Обработать границы для стран, регионов и Антарктиды.

#### make clean
Очистить временную директорию `tmp` и директорию с выходными файлами `out`.

#### node bin/ProcessCountries.js
Аргументы:
* politics - список политик разделенных запятой (пример: RU,UN)

Обработать границы для стран.

#### node bin/ProcessRegions.js
Аргументы:
* politics - список политик разделенных запятой (пример: RU,UN)

Обработать границы для стран.

#### node bin/ProcessAntarctic
Обработать границы для Антарктиды.

#### bin/CountVertices.js
Аргументы:
* inFilePath - входной файл

Считает точки с geojson файле и сообщает об их количестве в стандартном потоке.


## Выходной формат (regions-json)
Выходной формат схож с `topojson`. Основная идея: хранить смежные границы полигонов как один путь (линию).
Для каждого полигона хранится информация из каких путей он состоит. Полигоны восстанавливаются при расшифровке
формата на клиенте.

Выходной файл представляет собой json на верхнем уровне которого находятся 3 поля:
* regions
* ways
* paths

В ключе regions содержится метаинформация для каждого региона. Ключами этого объекта являются идентификаторы коды ISO 3166.

Ключ ways содержит в себе координаты каждого пути. Координаты сжаты определенным образом и закодированы в формат base64 (см. `external-lib/binaryCode.js`). Нулевой путь всегда пустой по причинам описанным в параграфе ниже.

Ключ paths описывает связь путей и полигонов. Данные в этом поле представляются в виде массива массивов. Внутри массива на верхнем уровне содержится массив, который содержит в себе массив целых чисел. Каждое число отсылает к идентификатору пути в ключе ways. Если число отрицательное то путь надо представлять в перевернутом виде, о чем знает модуль регионов. Поскольку нуль не имеет отрицательного числа нумерация путей начинается с единицы а нулевой путь всегда пуст.


## Метаданные
Метаданные содержатся в папке `data`, в файле `metadata.csv` (разделитель |). Для того чтобы связать данные из входного файла с метаданными сущностям из входного файла присваивается ISO 3166 код (для этого используется словарь `data/iso3166.csv`). Если не получается найти ISO код для сущности команда присвоения метаданных сообщит об ошибке и данная сущность будет игнорироваться (полигон не попадет в выходные данные). Все csv файлы содержат заголовок на первой строчке.
