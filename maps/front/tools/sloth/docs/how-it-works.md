<h1>How it works</h1>

- [Общая схема работы](#общая-схема-работы)
- [Описание рантайма](#описание-рантайма)
  - [create-version-and-book](#create-version-and-book)
  - [launch-assessors](#launch-assessors)
  - [cancel-booking](#cancel-booking)
- [Обработка ошибок и перезапуск](#обработка-ошибок-и-перезапуск)
  - [Параллельность](#параллельность)
  - [Ошибки](#ошибки)
  - [Перезапуск](#перезапуск)
- [Настройка трекера](#настройка-трекера)
  - [Локальные поля](#локальные-поля)
  - [Тип задачи и воркфлоу](#тип-задачи-и-воркфлоу)
  - [Подтверждение запуска](#подтверждение-запуска)

## Общая схема работы

![./pics/assessors-schema.svg](./pics/assessors-schema.svg)

Весь процесс построен на триггерах трекера и одном кубике в нирване.

Триггеры можно посмотреть в [пользовательской документации](https://www.notion.so/4c6474f0a5534108935610b12676d9dc).

**Основных триггера три**

1. [create-version-and-book: при переходе задачи в статус "Запланирован"](#create-version-and-book)
2. [launch-assessors: при переходе задачи в статус "Подтвержден"](#launch-assessors)
3. [cancel-booking: при переходе задачи в статус "Отменен", закрытии задачи мимо статуса "Готов к выкладке" и переоткрытии](#cancel-booking)

Эти триггеры создают новый инстанс артефакта в соответствующей папке в [/maps/front/maps/assessors/example](https://reactor.yandex-team.ru/browse?selected=8417970). В качестве значения отправляется ключ задачи.

Каждая из реакций берет [конфиг проектов](https://reactor.yandex-team.ru/browse/resolve?path=%2Fmaps%2Ffront%2Fmaps%2Fassessors%2Fexample%2Fconfig) и ключ задачи и передает их на вход переменными окружения в [воркфлоу](https://nirvana.yandex-team.ru/flow/431b64f6-03e7-4084-abb4-735afa624e0d/c57b49fe-5e30-4dfb-a61d-1e5c7be55e1d/graph). Рантайм кубика живет в репозитории [maps/assessors-by-button](https://github.yandex-team.ru/maps/assessors-by-button). Конфиг, соответственно, хранится в виде инстанса артефакта в реакторе. [Формат: JSON-as-string](https://www.notion.so/4c6474f0a5534108935610b12676d9dc).

Кубик использует [собранный бинарник](https://github.yandex-team.ru/maps/assessors-by-button), что позволяет добиться высокой стабильности и скорости работы.

## Описание рантайма

### create-version-and-book

Запускается при переходе задачи в статус "Запланирован", создает бронь и версию в Testpalm.

Шаги:

1. Если в тикете уже существуют версия, бронь или хитман-процесс, они отменяются
2. После этого на основании компонентов тикета забираются тест-раны из тестпалма и собирается версия с ними
3. Под собранную версию создаем бронь на ближайшее время с возможностью запуска раньше срока
4. Публикуем в тикет комментарий с временем запуска, оставшейся квотой (пока отдает странные цифры) и графиком свободной квоты
5. Сохраняем состояние в локальные поля: ссылки на версию в тестпалме и бронь в бронировщике
6. Призываем ответственного QA-инженера (из поля Тестирование -> QA-инженер) для подтверждения или отмены бронирования

### launch-assessors

Запускается при переходе задачи в статус "Подтвержден". Передает задания асессорам.

Шаги:

1. Забираем предыдущее состояние из тикета.
2. Запускаем хитман-процесс с параметрами:
    - номер бронирования
    - родительский тикет
    - очередь, в которой асессоры будут заводить баги
    - версия в testpalm
    - вебхук для отправки статусов выполнения хитман-процесса

Хитман-процесс запускает граф в нирване, который собирает и раздает задачи асессорам в Янг. Он также отправляет статусы выполнения в [вебхук Подрика](https://github.yandex-team.ru/maps/podrick-int/tree/master/server/projects/startrek-manager#обновление-статуса-выполнения-процесса-запуска-асессоров), чтобы тот унес их в комментарии тикета (без вебхука статус выполнения приходит ответственным на почту).

### cancel-booking

Запускается при переходе задачи в статус "Отменено", при преждевременном закрытии задачи и переоткрытии.

Шаги:

1. Отменяем бронь, если она есть
2. Архивируем версию в testpalm, если она есть
3. Останавливаем процесс в хитмане, если он есть

## Обработка ошибок и перезапуск

Триггеры настроены таким образом, что невозможно их запустить без обязательных параметров (окружения, компоненты, проект, исполнитель).

### Параллельность

Для ограничения параллельного запуска нескольких триггеров одновременно в рамках одного тикета используется лок через поле "Статус согласования". Переход, который вызывает триггер, также устанавливает в это поле значение "Выполняется". Триггеры сработают только в том случае, если это поле пусто или равно строке "Готов".

Если перевести статус в процессе выполнения другого триггера, новый триггер не сработает и робот в комментарии предложит дождаться окончания выполнения предыдущего задания и перезапустить триггер.

### Ошибки

В случае возникновения ошибки во время выполнения кубика в нирване в поле "Статус согласования" записывается статус "Ошибка". Также в комментарии приходит информация об ошибке (ошибки по умолчанию разделяются по статусам HTTP-ответов).

Чтобы запустить следующий триггер или перезапустить текущий, если "Статус согласования" равен строке "Ошибка" нужно предварительно очистить это поле вручную (т.е. сознательно, после исправления ошибок, если это необходимо).

### Перезапуск

Если нужно изменить значения компонентов, окружения или проекта в тикете, его нужно переоткрыть и пройти флоу заново. Потому, что это влияет на саму версию в тестпалме, а все остальные сущности привязаны к ней. Если нужно просто перезапустить выполнение предыдущего триггера, в каждом статусе для этого есть кнопка "Перезапустить"

Перезапуск триггеров основан на переходе статуса в "самого себя", например из статуса "Запланирован" в статус "Запланирован". В таком случае обновляется только поле "Статус изменен", на которое смотрят триггеры.

## Настройка трекера

### Локальные поля

Для обеспечения функциональности используются [локальные поля](https://doc.yandex-team.ru/tracker/external/local-fields.html).

Их можно легко создать для своей очереди и вероятность того, что они уже задействованы в каких-либо процессах очереди очень низкая. Таким образом это решение не должно ничего сломать.

Это очень свежая фича трекера, поэтому с ней еще остаются некоторые недоработки (которые некритично влияют на функциональность): [https://st.yandex-team.ru/TOOLSUP-86145](https://st.yandex-team.ru/TOOLSUP-86145). Решение этого тикета позволит отказаться от отдельного триггера, требующего установить поле "Проект".

### Тип задачи и воркфлоу

Для процесса по умолчанию используется тип задачи "Тестирование" и [кастомный воркфлоу](https://st.yandex-team.ru/admin/queue/ASESSORSMAPSAPI/workflows/W11270). Кастомизация типа задачи или воркфлоу пока не поддержана, будем допиливать по необходимости. По большому счету ничего не мешает использовать другие (уже существующие статусы), просто это слегка усложнит конфиг и настройку.

### Подтверждение запуска

Подтверждение запуска асессоров реализовано в воркфлоу. Переходы в статус "Подтвержден" и "Отменен" ограничены списком пользователей, которые могут это сделать:

![./pics/check_privileges.png](./pics/check_privileges.png)