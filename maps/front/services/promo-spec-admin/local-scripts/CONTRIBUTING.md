# Миграции
Для хранения и извлечения данных используем api Мойры (https://github.yandex-team.ru/maps/moira-int).  
Мы ожидаем что из Мойры приходят записи с валидной структурой.  
Если меняется структура данных, то нужно выполнить миграцию данных.
Все файлы для выполнения миграций находятся в директории local-scripts.

## Краткое описание процесса миграции
Локально запускаем отдельный процесс node, который шлет запросы в Мойру.  
Что-бы Мойра принимала запросы с локальной машины, нужно передавать в заголовке x-ya-service-ticket tvm-тикет.  
Для получения tvm-тикета нужно локально запустить tvm-демон.

## tvm-демон

### Проверяем секреты.
Для запуска tvm-демона, нужно создать файл с секретами /local-script/.tvm.json.  
Он добавлен в .gitignore, в git не добавляем!

#### Для получения к тестовой Мойре
Можно скопировать файла /.tvm.json из корня проекта.

#### Для подключение к продакшин Мойре
Нужно подставить другие секреты.  
1. secret
Переходим по адресу https://abc.yandex-team.ru/services/maps-front-promo-spec-admin/resources/  
Выбираем tvm-production-moira  
Открывшемся попапе выбираем значение client_secret.

2. self_tvm_id
В том-же попапе выбираем значение ID.

3. dst_id для moira
Переходим по адресу https://abc.yandex-team.ru/services/maps-front-moira-int/resources/  
Выбираем tvm production  
В открывшемся попапе выбираем ID.  
  
Секреты для прод-окружения в git не добавляем!!!

### Запускаем tvm-демон
Запускаем tvm-демон с помощью утилиты tvmtool-bin.  
Короткая команда для запуска: make tvm

## Скрипты миграции
Скрипты миграции находятся в директории /local-scripts/migrations  
Пример скрипта находится в файле 00-template.ts  
Результат выполнения можно выводить в файл /local-scripts/ouptput.json, он в добавлен в .gitignore.

### Выполняем скрпт для тестовой Мойры
tvm-демон должен быть запущен с тестовыми секретами.  
Из директории local-scripts вызываем  
NODE_ENV=development node_modules/.bin/ts-node migrations/777-the-best-script.ts 

### Выполняем скрпт для продакшн Мойры
tvm-демон должен быть запущен с продакшин секретами.  
Из директории local-scripts вызываем  
NODE_ENV=production node_modules/.bin/ts-node migrations/777-the-best-script.ts  
