# Как добавить шедулер для нового клиента

1. Загрузить картинки для сториз в любое хранилище, доступное **из внешнего интернета**.
2. Создать `json`-файл в правильном формате с информацией про сториз
3. Выложить файл в хранилище и отдать ссылку на него [разработчикам бекенда историй в Картах](https://abc.yandex-team.ru/services/maps-front-stories-int)

## Готовим файл с данными

`JSON`-файл хранит массив объектов, один объект — одна стори. Формат стори:

```typescript
type ImportedStory = {
    id: string;
    permalink: string;
    screens: string[];
    buttons?: {
        title: string;
        url: string;
    }[];
};
```

**Важно. Обратите внимание:**

-   поле `id` — это уникальный `id` истории в терминах **вашего проекта**. Нужен для того, чтобы редактировать историю или удалять её при повторных загрузках.
-   поле `permalink` — это `oid` организации в терминах Яндекс.Справочника. Взять можно из урла Яндекс.Карт, например, `https://yandex.ru/maps/org/143877542887`
-   массив `screens` принимает урлы картинок, доступные **из внешнего интернета**. Если у вас нет хранилища для картинок, используйте Яндекс.Облако. Как это сделать, читайте инструкцию ниже.

```json
[
    {
        "id": "story-1",
        "permalink": "143877542887",
        "screens": [
            "https://partner-eda-pictures.s3.yandex.net/1.jpeg",
            "https://partner-eda-pictures.s3.yandex.net/2.jpeg",
            "https://partner-eda-pictures.s3.yandex.net/3.jpeg"
        ],
        "buttons": [
            {
                "title": "Текст для кнопки на первом слайде",
                "url": "URL кнопки"
            }
        ]
    },
    {
        "id": "story-2",
        "permalink": "1093632278",
        "screens": ["https://partner-eda-pictures.s3.yandex.net/4.jpeg"]
    }
]
```

## Создаем хранилище картинок в Яндекс.Облаке

У вашего проекта должен быть ABC-сервис. Если он есть, у вашего сервиса в Яндекс.Облаке уже есть неймспейс. Создайте
там хранилище для картинок и настройте к нему внешний доступ:

1. Открыть https://yc.yandex-team.ru/
2. В списке abc-сервисов найти свой проект, перейти в неймспейс своего проекта.
3. В `"Консоли управления"` выбрать `"Object Storage"`
4. Нажать кнопку `"Создать бакет"` и заполнить форму:
    - в имени бакета не должно быть точек
    - в поле `"Доступ на чтение объектов"` выберите **"публичный"**. Это разрешит доступ без авторизации **из
      внутренней сети** (и это не опечатка).
    - в поле `"Макс.размер"` выберите `10` ([по умолчанию](https://wiki.yandex-team.ru/mds/s3-api/authorization/#registracijaservisa-klienta) столько выдают любому abc-сервису)

**Возникла ошибка?**
Убедитесь, что в вашем abc-сервисе вам [выданы роли](https://wiki.yandex-team.ru/mds/s3-api/authorization/#s3-roles)
`S3-owner` и `S3-admin`. Запросите и подождите, прорастает не сразу.

**Успешно создали бакет?**
Несмотря на настройку "публичный", ваш бакет ещё не открыт во внешний инетрнет. Используйте [инструкцию](https://wiki.yandex-team.ru/mds/s3-api/faq/#external-access-noauth):

1. Запросите в [IDM](https://idm.yandex-team.ru) роль на публикацию этого бакета во внешний мир:
    - `S3-MDS / <ваш ABC сервис> / Service bucket role / <bucket_name> / Public Bucket Manager`.
    - Если бакет создали только что, подождите минут 10-15, пока роли для него прорастут в IDM
    - Подождите, пока безопасники и ответственные за бакет апрувнут роль.
2. Получите [OAuth-токен для запросов в s3-idm.mds.yandex.ru](https://oauth.yandex-team.ru/authorize?response_type=token&client_id=6797456f343042aabba07f49b478c49b)
3. Дёните curl'ом ручку в `s3-idm.mds.yandex.net`:
    ```bash
    S3_BUCKET_NAME='<my-public-bucket-without-dots>'
    curl \
      --request PATCH \
      --header 'Authorization: OAuth <my-oauth-token>' \
      --data '{"open_public": true}' \
      "https://s3-idm.mds.yandex.net/management/bucket/${S3_BUCKET_NAME}/open"
    ```

Бакет откроется наружу в течение 5 минут.

## Загружаем картинки в Яндекс.Облако

1. Открываем созданный бакет и загружаем картинки через UI.
2. Получается список объектов

## Получаем публичные ссылки на картинки

1. Открываем бакет, видим список загруженных картинок
2. По клику на картинку открывается информация об этом объекте, а вверху страницы кнопка "Получить ссылку".

Это ссылка на картинку, доступная только **из внутренней сети**. Внешнюю ссылку придется построить вручную по формуле `https://$bucket_name.s3.yandex.net/$filename`

Например:

-   внутренняя: https://s3.mds.yandex.net/partner-eda/1.jpeg
-   внешняя: https://partner-eda.s3.yandex.net/1.jpeg

Указываем в `JSON`-файле именно **внешние** урлы к картинкам.
