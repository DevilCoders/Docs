# Моки

## Введение

Предположим, мы хотим протестировать в Картах карточку организации. Мы пишем тест, в котором открывается карточка организации:

```ts
it('Карточка организации.', function () {
    return this.browser.openPage('/org/company-seoname/123123123');
});
```

Когда мы запустим этот тест, node-сервер сделает запрос по адресу

```
http://addrs.yandex.ru:17140/yandsearch/?type=biz&id=123123123&...
```

и наш тест получит в своем интерфейсы реальные данные.

К сожалению, рельные данные часто меняются, и в такой ситуации тесты будут быстро протухать. Чтобы этого избежать, мы используем фабрики моков.

## Схема

Обычно данные добираются до клиента следующим образом:

```
Клиент -[запрос]-> node-сервер -[запрос]-> |
                                           v
                             ручка бэкенда |
                                           v
  Клиент <-[ответ]- node-сервер <-[ответ]- |
```

При использовании фабрики моков запрос в реальный бекенд подменяется на запрос в хранилище моков:

```
Клиент -[запрос]-> node-сервер -[запрос]-> |
                                           v
                           хранилище моков |
                                           v
  Клиент <-[ответ]- node-сервер <-[ответ]- |
```

Если в хранилище мока ещё нет, тогда запрашиваются реальные данные в реальном бекенде и сохраняются в виде мока в хранилище:

```
Клиент -[запрос]-> node-сервер -[запрос]-> хранилище моков -[запрос]-> |
                                                                       v
                                                         ручка бэкенда |
                                                                       v
   Клиент <-[ответ]- node-сервер <-[ответ]- хранилище моков <-[ответ]- |
```

-   **Фабрика моков** — программный код, который запускается в node-сервере БЯК, чтобы в "хранилище моков" появился мок.
-   **Мок** — слепок данных из реального бекенда для конкретного запроса. В формате `json`, `protobuf` и др.
-   **Хранилище моков** — s3 хранилище (`s3://s3.mds.yandex.net`). Моки сохраняются в бакете `maps-mocks`.

## Как запрашивать моки

Добавить в урле запроса query-параметр `mocks`. В этом случае будут работать фабрики моков для тех бэкендов, в которых написан соответствующий код.

_Во всех запросах из автотестов query-параметр `mocks` включен по умолчанию._

## Фабрика моков делает следующее:

-   Формирует `id мока` из постоянных параметров запроса к клиенту. Например, для поиска `type` и `id` - постоянные параметры и не меняются в зависимости от времени и сессии запроса, `ctx` - непостоянный параметр, меняется каждый раз.
-   Проверяет в хранилище моков, есть ли там сохраненный ранее мок с таким `id`.
    -   если мок найден — возвращает данные из него клиенту.
    -   если не найден — идёт в ручку бэкенда, записывает ответ в хранилище моков и возвращает его клиенту.

## Как перезаписать мок

Никак.

Но если мок протух, а замоканную организацию (подборку, маршрут и т.д.) менять не хочется, то можно добавить в урл параметр `mocks[version]=1`, при следующем запросе сформируется новый `id` мока для хранилища, и будет сохранен мок с новыми данными. Если параметр `mocks[version]` уже есть в урле, то необходимо поднять версию до следующей: `mocks[version]=2`, `mocks[version]=3` и т.д.

```js
// ?ll=35,55&z=10&mocks[version]=1
await this.browser.openPage('?ll=35,55&z=10', {mockVersion: '1'});
```

Если протух клиентский мок (который запрашивается ajax-запросом из клиенсткой части БЯК), нужно эту версию подклеить к урлу клиентского запроса в клиентском коде.

```js
function addMockVersion(url: string, config: Config): string {
    return url + (config.mocks?.version ? `&mocks%5Bversion%5D=${config.mocks.version}` : '');
}
```

## Как добавить новые моки

Про это читайте в [CONTRIBUTING.md](./CONTRIBUTING.md).
