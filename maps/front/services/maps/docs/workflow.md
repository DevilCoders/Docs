# Рабочий процесс

## Регламент

1. Мы используем классическую trunk-based разработку.
2. В trunk изменения попадают только через вливание веток.
3. Все фичи делаются в отдельных ветках и затем вливаются в trunk.
4. Помните, что все коммиты из trunk обязательно попадают в следующий релиз!
5. Баги по выкатываемым фичам правим в фиче-ветке.
6. Не комитим в релизную ветку новые фичи, только баги по релизу.

## Процесс работы над задачей

### Разработка

Когда задача берется в разработку, она переносится в очередь [MAPSUI](https://st.yandex-team.ru/MAPSUI), в случае если она находилась в других очередях, и переводится в статус "В работе".

Для задачи создается отдельная ветка в репозитории. Название полностью должно быть в нижнем регистре для корректной работы стендов.
Например, для MAPSUI-1234:

```
1234-feature-description
```

Все ключевые договоренности, которые были достигнуты во время работы над задачей с другими командами, стоит фиксировать в трекере, для того чтобы облегчить работу QA-инженерам и разработчикам, которые не принимали непосредственное участие в решении задачи.

#### Решение проблем при сборке

Обновить npm-пакеты, переводы, tvm-ключи:

```
make deps
```

Полностью переустановить пакеты (обычно достаточно `npm i`):

```
rm -rf ./node_modules/; npm cache clean -f; npm i
```

Обновить переводы:

```
make i18n
```

### Ревью кода

Перед вливанием ветки в trunk обязательно прохождение ревью. Перед созданием ревью необходимо отрибейзить ветку с задачей на trunk:

```
arc checkout trunk
arc pull

arc checkout branch_name
arc rebase trunk
```

либо так (из ветки):

```
arc pull --rebase origin trunk
```

Для всех геосервисов разработан [набор рекомендаций](https://wiki.yandex-team.ru/maps/dev/ui/workflow/review/#codereview) для проведения кодревью.

Кодревью в БЯК создаются pull request'ами в [arcanum](https://a.yandex-team.ru/).

В качестве ревьюверов стоит позвать участников вашего v-team (среди них обязательно должен быть технический лидер). Если ваша задача содержит большое количество изменений, внедрение новых библиотек или применяются какие-то нетривиальные технические решения - в ревью необходимо добавить одного из ментейнеров проекта (yaroger@, sigorilla@).

После создания PR в [Sandbox](https://trendbox-ui.s3.mds.yandex.net/latest/index.html?text=repository:ghe:maps/maps#/) создаются задачи, которые поднимут стенд из вашей ветки (ссылка будет добавлена в описание PR), прогонят все линтеры и тесты.

Если какие-то из проверок сломались из-за внесенных в проект измененний, необходимо их починить.
Также необходимо актуализировать автотесты в проекте. Подробнее читайте [специальную инструкцию](../tests/README.md).

### Тестирование

Когда ревью пройдено, для ветки выполняется rebase на текущий trunk (для того чтобы всплыли ошибки интеграции разрабатываемой фичи с фичами из trunk).

Если автоматические проверки пройдены успешно, необходимо тикет перевести в статус "Ready For Test" в интерфейсе трекера, и ответственный QA-инженер начнёт её проверять на стенде, поднятый из вашей ветки.

В случаях, когда тестирование можно не проводить, в Стартрек-тикете выставляется:
`Тестирование -> Test Scope -> Нет`. Тестировщики игнорируют такой тикет, и сразу можно мержить.

После окончания тестирования QA-инженер переводит задачу в стартреке в статус "Ready For Merge".
Важно, чтобы итоговый коммит был назван по полному названию задачи из стартрека, без переносов, например:

```
MAPSUI-9876: Перенести фидбек в боковую панель
```

Все коммиты схлопываются в один c помощью интерфейса или команды `arc rebase`. Также для этого можно использовать команду `arc merge --squash`.

Когда ветка содержащая решения уже влита в trunk, задача автоматически переводится в статус "Committed", а ветка удаляется.

## Создание нового релиза

Перед созданием нового релиза необходимо убедиться в нескольких вещах:

1. автотесты в trunk пройдены успешно (нет известных ошибок, которые препятствуют релизу);
2. новый релиз содержит хотя бы одну задачу, которая влияет на работу приложения.

Для создания нового релиза необходимо выполнить следующую команду:

```
make minor
```

После чего запускается сборка пакета с новым релизом в Sandbox и его выкладка в тестинг.

### Внесение правок в релиз

Если с помощью автоматических проверок или при ручном просмотре были найдены критические проблемы, их необходимо исправить в ветке rc. После этого пересобирается тестинг с помощью команды:

```
make patch
```

Как и в случае сборки нового релиза, после создания тега запускается сборка пакета в Sandbox и его выкладка.

В случае, если проблема найдена в определенной задаче и ее починка требует больше получаса, коммит/коммиты необходимо отревертить (`git revert {hash}`).

## Выкатка в production

Перед выкаткой релиза необходимо убедиться, что автотесты пройдены успешно и в стрельбах не нарушен SLA (проверки HERMIONE и FIRE должны быть успешно пройдены).

Когда новый релиз протестирован, необходимо выполнить команду:

```
make release-production TAG=vX.Y.Z
```

После чего будет выкачен продакшен и все таски в стартреке автоматически переведутся в статус "Closed".

Если на данном этапе вы заметили что-то плохое (сервис перестал быть доступен, зажглись мониторинги, ...), необходимо [откатить релиз](#откат-релиза).

Во время релиза и в течении получаса после необходимо следить за состоянием сервиса на [Dashboards](../README.md#dashboards).

Когда релиз успешно выкачен, ветку rc необходимо смержить через интерфейс в trunk.

## Откат релиза

1. Перейти во вкладку [History](https://deploy.yandex-team.ru/stage/maps-front-maps_production/history).
2. Выбрать предыдущий релиз по номеру тега.
3. Нажать **Apply** > **Apply as is**.
4. В открывшемся сравнении нажать **Deploy**.
