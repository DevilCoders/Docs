# Сторис в Яндекс Картах

-   [Пользовательские и редакторские](#пользовательские-и-редакторские)
-   [Плеер сторис](#плеер-сторис)
-   [Редактор сторис](#редактор-сторис)
-   [Как сделать запрос в Справочник от имени пользователя](#как-сделать-запрос-в-Справочник-от-имени-пользователя)
-   [Как писать автотесты на сторис](#как-писать-автотесты-на-сторис)
    -   [Сахарные функции](#сахарные-функции)
    -   [Параметры урла в тестах](#параметры-урла-в-тестах)
    -   [Специальная организация для тестирования](#специальная-организация-для-тестирования)
    -   [Картинки в моках](#картинки-в-моках)
-   [Permalink и bizId](#permalink-и-bizid)

У нас не оригинальные инстаграм-сторис, а их разновидность — хайлайты.
В чём разница?

-   Оригинальные сторис призваны показывать моменты из жизни "Здесь и сейчас", поэтому в инстаграм-ленте они отображаются в течение 24 часов, а потом исчезают.
-   Хайлайты же призваны показывать в ленте важную информацию и значимые события, поэтому не удаляются из ленты автоматически.

В Яндекс.Картах мы показываем сторис именно в режиме хайлайтов. С их помощью пользователи структурируют и визуализируют важную информацию об услугах своих организаций, и этим делают информацию доступнее.

`Хайлайты` произносить и писать трудно, поэтому просто `сторис`.

## Пользовательские и редакторские

Сторис в Картах бывают двух видов — пользовательские и редакторские. Первые создаются пользователями Карт (владельцами организаций), вторые — контент-менеджерами Яндекса. Внешне они одинаковы. Разница в том, где они отображаются в интерфейсе Карт, откуда в Карты приходят и где их можно редактировать.

**Пользовательские**

-   Отображаются:
    -   в узкой карточке организации
    -   в широкой карточке организации
    -   в попапе "как пройти" под пином организации на карте
-   Приходят из бекофиса [`stories-int`](https://abc.yandex-team.ru/services/maps-adv-stories-int)
-   Владелец организации редактирует их прямо в интерфейсе Яндекс.Карт

**Редакторские**

-   Отображаются на странице [`/actual`](https://yandex.ru/maps/actual)
-   Приходят из бекофиса [`discovery-int`](https://abc.yandex-team.ru/services/maps-front-discovery-int/)
-   Контент-менеджер редактирует их в `discovery-int`

## Плеер сторис

Код плеера: `src/stories/stories-player`

Любой незалогиненный пользователь Яндекс.Карт может просматривать сторисы в любых организациях или на странице [`/actual`](https://yandex.ru/maps/actual).

## Редактор сторис

Код редактора: `src/stories/stories-editor`

Предназначен для редактирования _пользовательских_ сторис. Доступ к редактору открывается только владельцу организации, который, конечно, должен быть залогинен.

Редактор — набор нескольких редакторов, которые открываются в зависимости от того, что пользователь хочет изменить в одной сторе:

-   редактор слайдов
-   редактор общей информации
-   редактор кнопки-действия
-   редактор обложки
-   редактор для выбора организаций

Перед тем, как выполнить запрос на создание/редактирование сторис, мы на сервере проверяем:

1. Действительно ли пользователь владелец этой организации.
2. Какими организациями ещё он владеет.

## Как сделать запрос в Справочник от имени пользователя

Запрос в АПИ Справочника всегда подписывается пользовательским TVM-тикетом,
чтобы Справочник идентифицировал пользователя. Есть способ, как сделать запрос в Справочник "как бы от имени
пользователя".

Запрос в ручку `v1/companies`:

```shell
curl -X GET 'https://sprav-api.yandex.net/v1/companies?filter:uid=<UID>&limit=10' -H 'Authorization: OAuth <ТОКЕН>'
```

Запрос в ручку `v1/companies/search`:

```shell
curl -X POST  -H 'content-type: application/json' -H 'authorization: OAuth <ТОКЕН>'
'http://sprav-api.yandex.net/v1/companies/search?offset=670&limit=10' --data '{"filter":{"service":"maps",
"user_access_level":"owned","uids":["<UID>"]}}'
```

`<UID>` — Паспортный `uid` настоящего владельца организаций
`<ТОКЕН>` — OAuth-токен суперпользователя в Справочнике (см. ниже).

**Как получить роль суперпользователя в Справочнике**

[Запросить роль суперпользователя](<https://idm.yandex-team.ru/#rf-role=7848BV7v#tycoon/superuser(fields:()),rf-expanded=7848BV7v,rf=1>)

1. Указываем получателем себя
2. В поле "Паспортный логин" выбираем логин `yndx-*`. Если такого логина нет, он создастся автоматически.
3. В обоснование пишем следующее:

> Интерфейс Яндекс.Карт делает запрос в ЛК, чтобы получать список организаций, которыми владеет конкретный
> пользователь. В некоторых случаях интерфейс Яндекс.Карт падает с ошибками, которые мы не можем понять и починить.
> Нужно уметь делать запросы под суперпользователем, чтобы увидеть ответ от ЛК "как бы его глазами".

**Как получить OAuth-токен**

1. Залогиниться на yandex.ru логином `yndx-*` (который использовали при получении роли суперпользователя)
2. Перейти по [ссылке](https://oauth.yandex.ru/authorize?response_type=token&client_id=cc2f3bc1eadc407bbbe817c1c6c7919d)
3. Скопировать строку из браузера вместо `<ТОКЕН>`

**Как узнать паспортный `uid` владельца организаций**

1. Залогиниться _суперпользователем_ во внешнем Паспорте.
2. Открыть [Админку Справочника](https://yandex.ru/sprav/admin/)
3. В разделе "Поиск пользователя" ввест логин владельца организаций.
4. Покажут `uid`

**Где делать запросы**

-   В продовом окружении [maps-trunk](https://deploy.yandex-team.ru/stages/maps-front-stands_maps-trunk). Заходим по
    ssh на инстанс и там дергаем курловые запросы в продовый Справочник.
-   На локальном разработческом стенде тоже возможно, только нужно [запросить дырку](https://puncher.yandex-team.ru/tasks?
    id=623af84b1cd3834b979b99f2) от разработческих машин до продакшена Справочника. Её выдают по требованию, но ненадолго.

## Как писать автотесты на сторис

**Боль 1**

Тесты на замоканных продакшн-данных трудно поддерживать: если нужно добавить или изменить тест, мы вынуждены обновлять моки, и нам может прийти из продакшена совершенно другой набор сторис, потому что владельцы бизнесов активно меняют свои сторис. Приходят новые моки, почти все тесты на сторис падают, поэтому приходится их каждый раз переписывать, указывать новые id, новые урлы к слайдам...

**Боль 2**

Когда падает тест на deploy-стенде, воспроизвести локально его невозможно, потому что deploy-стенд живёт в продашкн окружении (а значит сторисы приходят из продакшн-базы `stories-int`), а на локальном компьютере разработчика используется тестовое окружение (а значит сторисы приходят из тестовой базы `stories-int`). Продовая и тестовая базы `stories-int` между собой не синхронизируются: когда владелец орги создаёт в Картах новую сторю, она создаётся в продакшн `stories-int`, но не создаётся в тестовой. Тесты, упавшие на продовом стенде, невозможно воспроизвести локально...

**Решение**

Пишем автотесты только на фейковых моках:

1. Их никто не меняет без нашего ведома
2. Они одинаковы в продовом и тестовом окружении

Код замоканных сторис: `src/stories/mocks/stories-mocks.ts`

### Сахарные функции

В тестах используем утилитарные функции, которые умеют работать с замоканными данными и открывать плеер/редактор на нужной сторе или нужном слайде, перетаскивают драгабельные элементы редакторов и т.д:

-   `openStoriesPlayer`
-   `openStoriesEditor`
-   `openStoryInfoEditor`
-   `openStoryScreenEditor`
-   `openButtonEditor`
-   `openStoryCreateEditor`
-   `openOrgWithStory`
-   `dragStoriesOrSlides`
-   `getBusinessesCheckbox`

Код утилиты: `src/stories/utils/stories-utils.autotest.ts`

### Параметры урла в тестах

-   `debug=owner` — имитируется владелец организации (работает только из внутренних сетей Яндекса)
-   `debug=login` — имитируется залогиненный пользователь
-   `mocks[backends][storiesInd]=1` — включается загрузка замоканных сторис
-   `mocks[backends][spravApi][businesses]=many_businesses` — используются замоканные данные о списке организаций, которыми владеет пользователь

### Специальная организация для тестирования

В сторис-моках и в сахарных функциях зашиты `permalink` и `bizId` организации, которую создали специально для тестов на сторис. Это онлайн-организация, через поиск не находится.

-   Владелец: [Даша Михайлова](https://staff.yandex-team.ru/physteshka)
-   Совладелец: `geo.auto.test.stories@yandex.ru` (см. `tests/common/users.ts`)

**Продакшн**

-   БЯК: https://yandex.ru/maps/?mode=poi&poi[uri]=ymapsbm1%3A%2F%2Forg%3Foid%3D192922821914&z=7
-   Спраочник: https://yandex.ru/sprav/6522595
-   Алтай: https://altay.yandex-team.ru/cards/192922821914

**Тестинг**

-   БЯК: https://l7test.yandex.ru/maps/?mode=poi&poi[uri]=ymapsbm1%3A%2F%2Forg%3Foid%3D192922821914&z=7
-   Справочник: https://l7test.yandex.ru/sprav/8714576
-   Алтай: https://altay.test.yandex-team.ru/cards/<YET_UNKHOWN_PERMALINK>

**Важно:**

-   Права на оргу никому не выдаются.
-   Увидеть оргу в Справочнике или в Алтае можно только залогинившись тестовым юзером.
-   В этой организации нет смысла создавать сторис и новости — в тестах они не будут использоваться.

### Картинки в моках

Картинки заливаются в бункер

Нода: https://bunker.yandex-team.ru/maps-www/files/stories-partner/autotests

В идеале нужно их заливать в аватарницу в бакет `maps`, чтобы создавались изображения разных размеров (как это происходит при настоящем создании сторис). Не делаем, потому что пришлось бы заливать картинки и в тестовую автарницу и в продовую, и снова уперлись бы в "Боль №2".

## Permalink и bizId

`permalink` — это id организации в геопоиске. Несмотря на название, у одной организации может быть несколько пермалинков. Например, организация переезжает на другой физический адрес, и тогда в Справочнике возникают дубли пермалинков.

`bizId` — абстракция над пермалинками одной организации. Если пермалинков может быть несколько, то `bizId` всегда постоянный.

За создание и получение `bizId` отвечает специальный бекофис [`bvm-int`](https://abc.yandex-team.ru/services/maps-adv-bvm-int)

`BVM - (B)izId (V)ending (M)achine`

Узнать, как из одного сделать другое (`bizId <--> permalink`), можно в бекофисе `stories-int`

-   тестинг: https://stories-int.tst.c.maps.yandex.net/admin/
-   продакшн: https://stories-int.c.maps.yandex.net/admin/
