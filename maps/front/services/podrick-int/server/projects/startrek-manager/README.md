# Робот для работы с кондуктором и стартреком

## Что это и для чего нужно
Робот - nodejs приложение, которое умеет менять статусы тикетов в стартреке после выкладки пакетов в кондукторе.

### Доступы
Приложение обращается к стартреку и кондуктору от имени виртуального зомби-пользователя [Подрик Пейн](https://staff.yandex-team.ru/zomb-podrick) через [OAuth](https://wiki.yandex-team.ru/intranet/dev/oauth/).

Доступ для зомбика в стартреке выдается для конкретных очередей. Доступ выдан ко всем [карточным очередям](https://wiki.yandex-team.ru/maps/dev/ui/bugtracker/#proekty), если нужен доступ к какой-то дополнительной очереди, то дайте доступ пользователю [zomb-podrick](https://staff.yandex-team.ru/zomb-podrick) во [вкладке доступы](https://st.yandex-team.ru/admin/queue/gryadka/permissions). Либо попросите об этом ответственных очереди.

## Что умеет робот
- Переводить задачи в тестирование;
- Устанавливать коммит статус;
- Закрывать задачи после выкладки релиза.

### Как подключить
Робот подключется через вебхук, который вызывается из кондуктора, когда пакет поменял свой статус. [Инструкция](https://doc.yandex-team.ru/Debian/conductor-guide/task/packages_webhooks_new.xml) как добавить вебхук для пакета в кондукторе.

#### Коммит тасков
При коммите в заданную ветку вебхук переведет таск, который указан в commit message, в статус ```Commited```.

Для подключения вебхука в гитхабе, нужно перейти в ```настройки``` репозитория, далее ```вебхуки и сервисы```, добавить вебхук с параметрами:
- Payload URL: ```https://podrick.c.maps.yandex-team.ru/startrek-manager/?transition=commit```;
- Content type: ```application/json```;
- Event to trigger: ```Let me select individual events```, далее выбрать ```push```.

Commit message для таска должен иметь вид: ```MAPSUI-1688: Не зумимся к топониму при выборе из саджеста```.

Пол умолчанию учитываются ветки: ```master```, ```dev```, ```rc``` или ```hotfix```.
Можно указать другую ветку или набор, передав параметр ```gitbranch```, например: ```https://podrick.c.maps.yandex-team.ru/startrek-manager/?transition=commit&gitbranch=dev|rc``` (будет учитывать только ветку ```dev``` или ```rc```). В качестве разделителя используется вертикальная черта - ```|```.

#### Перевод в тестирование
При добавлении вебхука в кондукторе выбрать ветку ```testing```, в качестве урла указать ```https://podrick.c.maps.yandex-team.ru/startrek-manager/?transition=testing```.

Важно, чтобы в комментарии к таску на выкладку были указаны таски, которые нужно перевести в тестинг. Подробнее об этом смотреть в [детальном описании](#Перевод-в-тестирование-1).

#### Закрытие тасков
После выкладки в production релиза робот может закрыть таски с резолюцией ```Решено```.

При добавлении вебхука в кондукторе выбрать ветку ```stable```, в качестве урла указать ```https://podrick.c.maps.yandex-team.ru/startrek-manager/?transition=close```.
Робот как и для тестинга переведет только задачи, которые были указаны в комментарии для пакета.

Если требуется после выкладки пакета перевести все задачи по релизу, которые есть в определенной очереди, то можно указать параметр ```queue``` c названием очереди. Например: ```https://podrick.c.maps.yandex-team.ru/startrek-manager/?transition=close&queue=QUEUENAME``` (где вместе ```QUEUENAME``` указать название очереди в стартреке).

В этом случае, робот проигнориует список тасок в комментарии пакета и переведет все задачи, найденные для указанной очереди и имеющие статус ```Протестированно```, в статус ```Закрыто```.

### Детальное описание

#### Перевод в commited
Робот вызывается по url'y ``` https://podrick.c.maps.yandex-team.ru/startrek-manager/?transition=commit```.
Робот, по данному урлу вызывается через ```POST``` и ожидает несколько параметров в формате json. Данные параметры передаются от гитхаба:
- ```ref``` - имя ветки, куда происходит коммит.
- ```commits``` - массив объектов с информацией о коммитах. В каждом элементе массива используется ```.message```, содержащий commit message коммита.

#### Перевод в тестирование
Робот вызывается по url'y ``` https://podrick.c.maps.yandex-team.ru/startrek-manager/?transition=testing```.

Робот, вызываемый по данному урлу, ожидает еще несколько get-параметров. Данные параметры передаются от кондуктора:
```comment``` - содержит комментрий к выкатываемому пакету. Именно из данного параметра робот возьмет список тасок, которые нужно перевести в тестинг. Таски ищутся по маске ```* QUEUE-123```, где название каждого таска начинается с новой строки. Например:
```
* MAPSUI-1688: Не зумимся к топониму при выборе из саджеста
* MAPSUI-1689: Позволяем добавлять закрытые организации
* MAPS-1693: Не валидировать короткую форму
* ORGPAGE-151: Саджест на помещается на экране
```

Робот сформирует список из четырех указанных тасок и выполнит их перевод в тестинг. Важно обратить внимание, что робот переведет в тестинг таски только из тех очередей, до которых у него есть доступ.

#### Закрытие задач
Робот может закрыть задачи с резолюцией ```Решено``` при выкладке задач в стейбл. Вызывается по url'y ```https://podrick.c.maps.yandex-team.ru/startrek-manager/?transition=close```

Ожидаемые get-параметры:

- ```queue``` - Определяет очередь в которой будут изменяться тикеты. Если параметр не передан, то список тикетов будет ожидаться в параметре ```comment```. Необязательный. Указывается самостоятельно.
- ```comment``` - Содержит список тасок, которые должны быть изменены. Параметр передается кондуктором. Игнорируется если передан ```queue```. Самостоятельно указывать не требуется.

#### Обновление статуса выполнения процесса запуска асессоров
Адрес ручки: ``` https://podrick.c.maps.yandex-team.ru/startrek-manager/webhooks/update-assessors-status/:issueKey```.

Специфичный вебхук для обработки статусов выполнения хитман-процесса, которым запускают асессоров. Контекст: https://st.yandex-team.ru/ASSESSORTEST-6379

Формат:
```json
{
    "action": "start || end",
    "process_info": {
        // ...
        "job_status": "STARTED || FINISHED || NOT_FINISHED",
    },
    // optional
    "errors": [
        {
            "hint": "string",
            "priority": "blocker",
            "text": "string",
            "type": "string"
        },
        // ...
    ]
}
```