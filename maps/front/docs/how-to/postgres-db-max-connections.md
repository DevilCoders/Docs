## Как посчитать конфиг `db.maxConnections`

`db.maxConnections` - это максимальное допустимое количество соединений с одного инстанса приложения до одного хоста базы данных.

Этот конфиг передается в настройки пула клиента [node-postgres](https://www.npmjs.com/package/pg) как параметр [PoolConfig.max](https://node-postgres.com/api/pool), который по умолчанию равен 10.

Увеличение этого параметра, позволит делать вашему сервису больше параллельных запросов в БД, вместо того что-бы копить их в очереди пула соединений клиента `node-postgres`.

Если же сильно завыстить этот параметр, то при высокой нагрузке на сервис, ограничение на количество открытых соединенний к серверу БД может быть превышено и новые запросы пудут падать с ошибкой соединения.

Поэтому, хотелось бы максимально увеличить этот параметр, не рискуя при этом привысить ограничение на количество соединенний к БД.

Если мы знаем чему равны следующие значения:

* `dbHostMaxConnections` - максимальное допустимое количество соединений до одного хоста БД
* `appInstancesCount` - количество запущеных реплик приложения

то `db.maxConnections` можно будет посчитать по формуле `dbHostMaxConnections / appInstancesCount` округленное вниз.

### Как посчитать `appInstancesCount`

Если вы используете [Y.Deploy](https://deploy.yandex-team.ru/docs/), то `appInstancesCount` - это количество подов в стейдже. Его можно вычислить из конфига стейджа деплоя как: `(количество ДЦ) x (количество реплик в ДЦ)`.

Например, если в стейдже используется `multi_cluster_replica_set` с двумя кластерами SAS и VLA, и в каждом кластере по 2 реплики, то `appInstancesCount` будет равно `2 x 2 = 4`.

### Как посчитать `dbHostMaxConnections`

В [Managed Service for PostgresSQL](https://docs.yandex-team.ru/cloud/managed-postgresql/) (a.k.a. PGaaS) есть два параметра ограничивающих количество одновременных подключений к хосту БД: [Max connections](https://docs.yandex-team.ru/cloud/managed-postgresql/concepts/settings-list#setting-max-connections) и [Conn limit](https://docs.yandex-team.ru/cloud/managed-postgresql/concepts/settings-list#setting-conn-limit).

`Max connections` определяется на уровне кластера. Максимальное значение и значение по умолчанию зависят от выбранного класса хостов и задаются формулой: `200 × <количество vCPU на одном хосте>`. Например, для класса хостов `s3.micro` количество vCPU равно 2, а значит `Max connections` будет равно 400.

`Conn limit` определяется на уровне пользователя БД. По умолчанию оно равно 50, поэтому в настройках пользователя его следует увеличить. Если в кластере используется только один пользователь БД, то этот параметр можно увеличить до `<Max connections> - 15`, т.к. PGaaS резервирует 15 служебных подключений на каждом хосте. Если же в кластере используется более одного пользователя БД, то при увеличении этого параметра стоит учитывать, что суммарный `Conn limit` для всех пользователей не должен превышать `<Max connections> - 15`.

![](https://jing.yandex-team.ru/files/yesenarman/2022-07-28_14-14.png)

*Рис. 1. Пример редактирования параметра Conn limit*

Так как приложение подключется к БД под определенным пользователем, то `Conn limit` этого пользователя можно и использовать в качестве значения `dbHostMaxConnections`.

### Пример

Например, есть PG кластер с классом хостов `s3.small` (4 vCPU, 16GB RAM), есть только один пользователь БД, а сам сервис запущен в Y.Deploy на 6 подах (по 3 реплики в 2-х ДЦ). 

* `Max connections` для кластера будет равен `200 x 4 = 800`.
* `Conn limit` пользователя будет равен `800 - 15 = 785`.
* `db.maxConnections` будет равен `785 / 6 = 130`.

Главное, не забыть увеличить `Conn limit` пользователя в настройках PGaaS, т.к. иначе приложение упрется в дефолтный лимит 50 соединений и начнет получать ошибки соединения.

Для удобства, можно воспользоваться следующим скриптом:

```js
dbHostCpuAmount = 4;
appInstancesCount = 2 * 3;
dbHostMaxConnections = 200 * dbHostCpuAmount - 15;
console.log('Conn limit:', dbHostMaxConnections);
console.log('db.maxConnections:', Math.floor(dbHostMaxConnections / appInstancesCount));
```
