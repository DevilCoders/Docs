# Релиз

## Необходимые токены
- `SPRAV_ROBOT_TOKEN` с токеном для работы Стартрека. Токен получен для робота https://staff.yandex-team.ru/robot-altay-reporter (https://wiki.yandex-team.ru/gela-d/tokens/). Также нужно получить доступ к нему через IDM - https://nda.ya.ru/3UWXbm.
 - `SPRAV_ROBOT_ABC_OAUTH_TOKEN` взять [тут](https://nda.ya.ru/t/0pkMkGxX4vkRKc).

## Шаги релиза
1. Обновить ветку `trunk` до свежей версии.
2. Из ветки `trunk` выполнить команду `npm run create-release`, она делает следующее:
  - создает релизную ветку
  - подтягивает и коммитит новые переводы
  - увеличивает версию приложения и делает коммит с changelog
  - ставит тег
  - пушит релизную ветку и тег
  - создает релизный тикет
3. По тегу Трендбокс собирает docker-образ и пушит его. Все сборки образов можно посмотреть [тут](https://sandbox.yandex-team.ru/tasks/?children=true&desc_re=%5C%5Btycoon%5C%5D%20%D0%9E%D0%B1%D0%BD%D0%BE%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5%20%D1%82%D0%B5%D1%81%D1%82%D0%B8%D0%BD%D0%B3%D0%B0%20%D0%B8%20%D0%BF%D1%80%D0%B5%D1%81%D1%82%D0%B5%D0%B9%D0%B1%D0%BB%D0%B0%20%D0%BF%D1%80%D0%B8%20%D1%80%D0%B5%D0%BB%D0%B8%D0%B7%D0%B5&owner=TYCOON-FRONTEND&limit=100&offset=200&created=7_days). Примерное время от момента пуша тега до его раскатки на стенд - 40 минут. Проверяем, что в тестинг выкатилась нужная версия.
4. После того, как релиз выехал на тестинг, идем в релизную таску и ставим статус ReadyForTest. Пишем тестировщику (или проверяем сами) что релиз готов.
5. После того, как релиз протестирован, надо обновить тег в продовом окружении [тут](https://deploy.yandex-team.ru/stages/tycoon-www-production). Перед этим обязательно пишем в чатик [TYCOON-oncall](https://t.me/joinchat/CykkxU7LfPMCq1WpJHvubg), что фронт выкатывает релиз в прод.
6. Как релиз выехал в прод, ближайшие полчаса-час, мониторим ошибки, внимательно смотрим на [алерты](https://yasm.yandex-team.ru/alert/tycoon-server-errors) и [графики приложения](https://yasm.yandex-team.ru/template/panel/New-Porto-Container/deploy_unit=frontend;geo=man%7Cvla%7Csas;itype=deploy;stage=tycoon-www-production/).
7. Если что-то сломалось сразу откатываем тег в Y.Deploy и отписываемся в чате.
8. Если все хорошо, запускаем команду `npm run merge-release` для создания пулл-реквеста с изменениями из релизной ветки после чего мержим его в `trunk`.
9. Запускаем команду `npm run close-release` для закрытия связанных c релизом тикетов, обращаем внимание на тикеты не из очереди `TYCOON` (если таковые будут) - их автоматика не закроет.
10. Проверяем, что у релизного тикета проставился статус "Закрыто".

### Шаги хотфикса
1. Выполняем `npm run checkout-release-branch`
2. Вносим изменения, коммитим.
4. Выполняем `npm run create-patch`
5. По тегу Трендбокс собирает docker-образ и пушит его. Все сборки образов можно посмотреть [тут](https://sandbox.yandex-team.ru/tasks/?children=true&desc_re=%5C%5Btycoon%5C%5D%20%D0%9E%D0%B1%D0%BD%D0%BE%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5%20%D1%82%D0%B5%D1%81%D1%82%D0%B8%D0%BD%D0%B3%D0%B0%20%D0%B8%20%D0%BF%D1%80%D0%B5%D1%81%D1%82%D0%B5%D0%B9%D0%B1%D0%BB%D0%B0%20%D0%BF%D1%80%D0%B8%20%D1%80%D0%B5%D0%BB%D0%B8%D0%B7%D0%B5&owner=TYCOON-FRONTEND&limit=100&offset=200&created=7_days). Примерное время от момента пуша тега до его раскатки на стенд - 40 минут. Проверяем, что в тестинг выкатилась нужная версия.
6. Проверяем что хотфикс работает, затем надо обновить тег в продовом окружении [тут](https://deploy.yandex-team.ru/stages/tycoon-www-production). Перед этим обязательно пишем в чатик [TYCOON-oncall](https://t.me/joinchat/CykkxU7LfPMCq1WpJHvubg), что фронт выкатывает релиз в прод.
7. Как хотфикс выехал в прод, ближайшие полчаса-час, мониторим ошибки, внимательно смотрим на алерты.
8. Если что-то сломалось сразу откатываем тег в Y.Deploy.
9. Если все хорошо, запускаем команду `npm run merge-release` для создания пулл-реквеста с изменениями из релизной ветки после чего мержим его в `trunk`.
10. Проставляем у релизного тикета статус "Закрыто" с резолюцией "Решен" (он переоткрылся при создании пулл-реквеста на предыдущем шаге).
