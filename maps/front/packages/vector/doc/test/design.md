# Тестирование дизайна подложки

### Общий воркфлоу проекта
<details>
  <summary>Подробнее</summary>
    
1. Дизайнеры заводят таск на тестирование новой версии дизайна/эксперимента в очереди [MAPSDESIGN](https://st.yandex-team.ru/MAPSDESIGN/).
2. В таске отмечены, какие изменения подложки ожидаемы, более подробно изменения релиза можно посмотреть в выборке по **версии релиза** проставляемой в задаче. [Пример тестовой задачи](https://st.yandex-team.ru/MAPSDESIGN-4559).
3. Тестировщик запускает прогон автотестов командой make test-map-design(по дефолту).
4. Все найденные проблемы обозначаются комментариями, в которых необходимо описать обнаруженную ошибку/некоррект, приложить ссылку на спан карты (ссылку из блока meta-info-->maps), при необходимости отразить сопутствующие признаки, например zoom, а также приложить скрин/скринкаст прода и тестинга с помеченными различиями.
5. Если были изменения интерактивных объектов (пример: появились суперпои, МЦД) обязательно:
    - проверить кликабельность объектов и на БЯК и в АПИ 2.1;
    - проверить переходы между зумами – иконки не должны мигать.
6. После фиксов дизайна по согласованию с отвественными лицами осуществить повторный прогон автотестов(если фиксы незначительны командой make test-map-design-regress).
7. Запустить автотесты на карте с ночным режимом.
8. Запустить автотесты на карте со слоем гибрид, если изменения касались гибридного/спутникового отображения данных, или это прямо указано в таске.
---

Имеется почтовая рассылка на сборки дизайн-релизов с обозначением номера сборки и номера релиза. Чтобы получать сообщения, необходимо подписаться на рассылку и информация будет приходить вам на почту, при этом в сообщениях по номеру релиза можно понять выкатился новый релиз в тестинг или это правки и сборки старого релиза.
[Ссылка на рассылку](https://ml.yandex-team.ru/lists/mapsrenderer-designtesting/)
</details>

### Запуск автотестов
Сравнивается подложка из прода с новым дизайном
- В Сэндбоксе [Sandbox Design Vector](https://sandbox.yandex-team.ru/scheduler/17518/view)
- Локально:
    ```
    cd tests/func
    make install
    ```
    ```
    make test-map-design
    ```

### Процесс тестирования и интерпретации результатов отчета
<details>
  <summary>Подробнее</summary>

**1.** После выполнения команды тестового прогона консоль будет передавать список с зелеными галками, это первый проход автотестов по версии прода. После эталонного прогона в окне консоли начнется второй  -  тестовый проход, который идет по стенду с собранным дизайн - релизом. В списке тестов появятся красные галки.

![Скрин прогона](./images/sc_01.png)
  Через некоторое время, когда тесты перестанут сыпаться в консоли вы увидите сообщение о том, где находится файл с отчетом о тестировании. 

![Консоль с сообщением об окончании тестирования](./images/sc_02.png)

---

**2.** По окончанию тестирования, открываем файл index.html. Сверху имеются количественные метрики прогона. Под ними фильтры показа тестов, по умолчанию выдаются тесты прошедшие с ошибкой. Суть тестовых прогонов в автотестах - это сравнение продового эталона с тестовым стендом, на котором отразились изменения, внесенные дизайнерами при формировании релиза. Важно понимать, что данные находящиеся на серверах и собственно формирующие карту имеют тенденцию изменяться, поскольку карта в реальности также меняется. Например вчера на карте дома не было и был серый фон участка, дом достроили, данные обработаны на сервере, и вот на карте дом с номером и другой окраской. Такие изменения будут видны при подкрашивании в **diff** скриншотах рельефов местности, побережий рек и иных объектов. При этом, если количество подкрашенных участков в файле **diff** большое, стоит уточнить про это у ответственных лиц. Иногда изменения релиза напрямую могут быть связаны с подкрашиваем участков (например дорог) и тогда к файлам **diff** с некорректной прокраской стоит отнестись более внимательней.
![Отчет с результатом тестирования](./images/sc_03.png)
В отчете в каждом тесте помеченным **failed** и находящемся в выборке вы видите три скриншота. Слева-направо: **Expected - Прод**, **Actual - Наш релиз/результат на тестинг стенде**, **Diff - результат сравнения Expected и Actual**. 
При этом все несовпадения прода и тестинг стенда в блоке **Diff** подсвечены розовым, что явно показывает в чем разница и почему собственно данный тест выделен в блок **failed**.

---

**3.** Задача состоит в максимально верном и тщательном анализе отчета, выявлении действительно некорректного отображения элементов или например их отсутствие, как таковых, там где они должны быть. Иногда это прямо очевидно и наглядно будет заметно в отчете.
    <details>
      <summary>Примеры</summary>
           *Из-за увеличения меток достопримечательности, последние вытеснили подпись города со спана карты*
           ![Скрин_01](./images/sc_04.jpg)
           *Пропала иконка выхода со станции МЦД*
           ![Скрин_02](./images/sc_05.png)
           *Подпись города сместилась*
           ![Скрин_03](./images/sc_06_1.png)
    </details>

---

**4.** Однако множество изменений возможно заметить лишь в динамике и работе с картой. Иногда ошибки в размерах и внешнем виде объектов лучше разбирать не на скриншоте, а непосредственно в БЯК, кроме того, существуют обязательные сценарии проверки релиза в БЯК, а именно, например, если в релизе были изменения интерактивных(кликабельных) объектов (пример: появились суперпои, МЦД, какие-то новые элементы), в таком случае необходимо пройти по ссылке теста, и проверить кликабельность объектов и на БЯК и в АПИ 2.1, а также проверить переходы между зумами – объекты(ПОИ, СуперПОИ, метки) не должны мигать, не должно быть странных эффектов. Для таких проверок, делаем клик во вкладку **Meta-info** текущего теста в отчете.
![Скрин_04](./images/sc_06.png)
Во вкладке Meta-info лежит необходимая нам информация, а также нужные нам ссылки. Так чаще всего нам будет необходимая ссылка из блока maps, она ведет на тестовый стенд БЯК, при клике в эту ссылку откроется спан карты со скриншота, и вы сможете убедится в наличии diff, посмотреть и проверить его в динамике, либо же выявить иные изменения на карте, которые могут возникнуть во взаимодействии, например при призуме/отзуме, драгах карты, перемещениях спана за счет запросов и другие возможные сценарии. Также в Meta-info есть координаты центра карты, текущее значение zoom(это может понадобится если вы хотите тут же сравнить результат с продом и открыть карты с такими же параметрами).
![Скрин_05](./images/sc_07.png)

---

**5.** Независимо от внесенных дизайнерами изменений, отразится они могут совершенно на любых объектах на карте и совершенно неожиданно повлиять на элементы на карте. Об этом следует помнить и проходить по ссылкам в тестах, чтобы смотреть изменения в динамике на картах, а не на скриншотах.

**6.** Провести тестирование дизайн-тестинга подложки в слоях пробок и парковок, перейдя по [ссылке](https://l7test.yandex.ru/maps-prod/213/moscow/?host_config%5Bhosts%5D%5BmapjTiles%5D=https%3A%2F%2Fcore-renderer-designtesting.maps.n.yandex.ru%2Ftiles%3Fl%3Dmapj%26%25c&host_config%5Bhosts%5D%5BmapTiles%5D=https%3A%2F%2Fcore-renderer-designtesting.maps.n.yandex.ru%2Ftiles%3Fl%3Dmap%26%25c&host_config%5Bhosts%5D%5BskljTiles%5D=https%3A%2F%2Fcore-renderer-designtesting.maps.n.yandex.ru%2Ftiles%3Fl%3Dsklj%26%25c&host_config%5Bhosts%5D%5BsklTiles%5D=https%3A%2F%2Fcore-renderer-designtesting.maps.n.yandex.ru%2Ftiles%3Fl%3Dskl%26%25c&host_config%5Bhosts%5D%5BvectorGlyphs%5D=https%3A%2F%2Fcore-renderer-designtesting.maps.n.yandex.ru%2Fvmap2%2Fglyphs%3Flang%3D%7B%7Blang%7D%7D%26font_id%3D%7B%7BfontId%7D%7D%26range%3D%7B%7Brange%7D%7D&host_config%5Bhosts%5D%5BvectorImages%5D=https%3A%2F%2Fcore-renderer-designtesting.maps.n.yandex.ru%2Fvmap2%2Ficons%3Fid%3D%7B%7Bid%7D%7D%26scale%3D%7B%7Bscale%7D%7D&host_config%5Bhosts%5D%5BvectorMapTiles%5D=https%3A%2F%2Fcore-renderer-designtesting.maps.n.yandex.ru%2Fvmap2%2F&host_config%5Bhosts%5D%5BvectorMeshes%5D=https%3A%2F%2Fcore-renderer-designtesting.maps.n.yandex.ru%2Fvmap2%2Fmeshes%3Fid%3D%7B%7Bid%7D%7D&host_config%5Bhosts%5D%5BvectorTiles%5D=https%3A%2F%2Fcore-renderer-designtesting.maps.n.yandex.ru%2Fvmap2%2Ftiles%3Flang%3D%7B%7Blang%7D%7D%26x%3D%7B%7Bx%7D%7D%26y%3D%7B%7By%7D%7D%26z%3D%7B%7Bz%7D%7D%26zmin%3D%7B%7Bzmin%7D%7D%26zmax%3D%7B%7Bzmax%7D%7D&l=carparks&ll=37.614932%2C55.752967&renderer_experimental_carparks_design=testing&renderer_experimental_trf_cartograph_design=1&renderer_experimental_trf_design=testing&z=15).

Автотесты прогоняются в Google Chrome - это также надо учитывать, так как в Хроме - векторное отображение, работают схемы индора, для целей тестирования необходимо брать ссылку из блока maps, копировать ее и открывать в браузере не поддерживающем векторное отображение, в настоящее время, например Safari, IE.
</details>

### Виды тестовых прогонов
*работает только в АПИ >= 2.1.76*

| Команда | Описание |
| --- |--- 
|`make test-map-design NIGHT=1` | Запуск автотестов в ночной режиме|
|`make test-map-design HYBRID=1` | Запуск автотестов в слое гибрид|
|`make test-map-design DESIGN_EXP=experimental_design=abcd` | Подставить `experimental_design={{id экспа}}` в `DESIGN_EXP`|
|`make test-map-design-regress` | Запуск короткого набора автотестов для прогона фиксов релиза|

### Переменные окружения, которые могут пригодиться
| Переменная | Описание |
| --- |--- 
|`API_VERSION_ACTUAL` | Переопределение версии АПИ в тестинге|
|`VECTOR_INDEX` | Ссылка на вектор с нужной версией|

```
make test-map-design API_VERSION_ACTUAL=2.1.76 VECTOR_INDEX=https://yastatic.net/s3/mapsapi-v3/vector/5.1.0/out/vector.min.js 
```

### Как найти отчет Sandbox
1. После прогона тестов перейти по ссылке в письме ([скрин](./images/sandbox_01.png))
2. Открыть ресурсы репорта ([скрин](./images/sandbox_02.png))
3. Открыть index.html ([скрин](./images/sandbox_03.png))

### Добавление новых кейсов/сетов
Добавить в список [cases.js](../test-design/cases.js)

Формат:
```
{
    <set name>: [
        {name: <case name>, center: <map center>, zmin: <zoom from>, zmax: <zoom to>}
    ]
}
```
### Глоссарий возможных багов
<details>
    <summary>Подробнее</summary>

| Описание | Скриншот |
| --- |--- 
|`Замыленность иконки ПОИ - иконка теряет четкость. Специфичный баг, поскольку на отдаленных значениях зума не заметен. Что характерно может быть обнаружен на одной рубрике, например: стадионы, парки, аптеки, больницы. Выявлять на стенде на больших значениях зума и спанах с достаточным для сравнения количеством ПОИ.` | ![Скрин_06](./images/bug_01.png)|
|`Исчезновение подписей топонимов. В примере с z=8 пропали подписи регионов. При комментировании обязательно указывать значение zoom.`|![Скрин_07](./images/bug_02.png)|
|`Исчезновение подписей топонимов. В примере пропали подписи районов на z=11-12. При комментировании обязательно указывать значение zoom.`|![Скрин_08](./images/bug_03.png)|
|`Исчезновение подписей улиц. Исчезновение подписей любых топонимов(улиц, районов, городов, сел, водных объектов) с определенного значения zoom может быть багом. При комментировании обязательно указывать значение zoom.`|![Скрин_10](./images/bug_04.png)|
|`Несовпадение подписи и метки ПОИ/СуперПОИ. Подпись цветная, метка - нет.`|![Скрин_11](./images/bug_05.png)|
|`Несовпадение подписи и метки ПОИ/СуперПОИ. Метка цветная, а подпись не соответствует цвету метки.`|![Скрин_11](./images/bug_06.png)|
</details>