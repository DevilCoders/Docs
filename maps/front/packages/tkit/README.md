# TKit

Инструмент, который позволяет описать сборку в виде графа команд, для запуска внутри [Trendbox CI](https://github.yandex-team.ru/search-interfaces/trendbox-ci) или внутри кубика [run_command](https://a.yandex-team.ru/arc/trunk/arcadia/ci/registry/common/misc#run_command) в [Arcadia CI](https://docs.yandex-team.ru/ci/).

Для каждой команды (шага сборки) автоматически будет создан отдельный лог (sandbox ресурс), а также проставлены github/арканум статусы (начало выполнения шага, окончание, ошибка).

## Quick Start:

Перед началом использования внимательно изучите документацию [Trendbox CI](https://github.yandex-team.ru/search-interfaces/trendbox-ci) или [Arcadia CI](https://docs.yandex-team.ru/ci/)!

### Настройка авторизации GitHub API

Шаг можно пропустить, просто не будут проставляться статусы в GitHub.

Для работы GitHub API требуется:

1. В web интерфейсе GitHub войти под пользователем, от имени которого будет выполняться скрипт. Обычно это робот. И создать токен авторизации [по инструкции](https://help.github.com/en/articles/creating-a-personal-access-token-for-the-command-line). В списке permissions необходимо выбрать `repo:status`. Полученный токен называется `env.GITHUB_OAUTH_TOKEN`.

2. Если пользователь робот, его нужно добавить в список Collaborators репозитория [по инструкции](https://help.github.com/en/articles/adding-outside-collaborators-to-repositories-in-your-organization), чтобы дать доступ к репозиторию.

3. Чтобы передать токен `env.GITHUB_OAUTH_TOKEN` в sandbox / trendbox, необходимо добавить его в [секреты для вашего пользователя sandbox](https://sandbox.yandex-team.ru/admin/vault), положив в специальную переменную `env.GITHUB_OAUTH_TOKEN`. От имени пользователя авторизуемого по этому токену будут выставляться статусы комитов в GitHub.

### Настройка trendbox для запуска tkit

Необходимо поместить в файл `.trendbox.yml` команды, делегирующие управление пакету `tkit`:
```yaml

...

# Не фиксируйте патчевую версию пакета, поскольку API Trendbox может меняться
# эти исправления будут вноситься патчевыми версиями.
# Опция --no-package-lock используется, чтобы предотвратить установку других зависимостей из package.json.
# Опция --no-save используется, чтобы пакет не был добавлен package.json.
install: npm install @yandex-int/tkit@0.72.x --no-package-lock --no-save

script: node ./ci.js

...
```

### Основной скрипт tkit

Конфигурация сборки tkit описывается в виде графа сборки `graphConfig`, описывающего порядок выполнения шагов, и списка шагов `steps`.

Имена шагов в `graphConfig` и `steps` должы полностью совпадать.

Граф `graphConfig` устроен следующим образом:

1. Каждый шаг может иметь список шагов, от которых он зависит. Выполнение такого шага начнется только тогда, когда все зависимые окончили свою работу.

2. Шаги без зависимостей будут запущены сразу.

3. Информация о выполнении каждого шага дописывается в комит в виде статуса через GitHub API. Если у вас 5 шагов, то у вас должно быть 5 статусов в GitHub. Если статусы не появились, значит не работает авторизация в GitHub. Если появились не все статусы, значит шаги с отсутствующими статусами не запускались. Имеется ввиду последний комит в текущей ветке git.

В файл `ci.js`, представленном ниже, шаги BUILD и TEST будут запущены параллельно, но только после выполнения шага DEPS.

Команда `graph.run()` запускает дочерние процессы средствами `nodejs` и перенаправляет логирование работы shell команды каждого шага в отдельный лог файл `tkit-resources/<имя шага>/log`.

Файл `ci.js` имеет вид:

```js
const {Graph, trendbox, ci} = require('@yandex-int/tkit');

const graph = new Graph({
    // Имя владельца и репозитория. Для работы в аркадии ничего передавать не нужно
    repo: {owner: 'owner', name: 'repo'},
    // Максимальное время сборки, после чего она будет остановлена (по-умолчанию, ограничений нет).
    lifetime: 30 * 60 * 1000,
    // Останавливать текущую сборку, если появился новый коммит в ветке (по-умолчанию, `false`).
    stopOnUpdate: false,
    // Реджект промиса при неуспешности хотя бы одного из шагов, кроме continueOnFailure шагов (по-умолчанию, `false`).
    failOnStepFailure: false,
    // Не отображать гитгабе положительные статусы шагов, отмеченных промежуточными. При неуспешном завершении статус будет проставлен (по-умолчанию, `false`).
    hideIntermediate: false,
    /* Включить селективное выполнение шагов (по-умолчанию, `false`). Позволяет
     * 1. Пропускать шаги, для которых нет изменений
     * 2. Передавать в команду шага список изменённых файлов.
     * Для пулл-реквеста - все измененные в пулл-реквесте файлы, для коммита - изменённые в последнем коммите файлы.
     */
    selective: false,
    /* В какую систему добавлять проверки в пулл-реквесте в аркадии. Помогает сгруппировать проверки по проектам и избежать коллизии названий от нескольких разных tkit'ов.
     * Если установить значение `true`, то будет использовано значение projectPath; любое другое значение будет использовано без изменений.
     * (по-умолчанию значение параметра `projectPath` для arc ci и `tkit` для остальных случаев)
    */
    checksSystem: 'tkit',
    /* Путь до проекта (по-умолчанию, '' для трендбокса, `context.config_info.dir` для arc ci).
     * Будет использован в названии системы статус чеков (с настройкой checksSystem) и в качестве корня для путей в списке изменённых файлов (с настройкой selective)
     */
    projectPath: '',
    // Директории для ресурсов относительно корня проекта. (по-умолчанию, '../tkit-resources')
    resourcesDir: '../tkit-resources'
});

// Граф, описывающий порядок выполнения шагов.
const graphConfig = {
    DEPS: null,
    BUILD: ['DEPS'],
    TEST: ['DEPS']
};

// Набор шагов сборки проекта в виде shell команд.
const steps = {
    DEPS: ['npm install', {retry: true}],
    BUILD: 'npm run build',
    TEST: 'npm run test'
};

graph.run(graphConfig, steps).catch((err) => {
    console.error(err);
    process.exit(1);
});
```

Команда `graph.earlySkip()` проставляет статус "пропущено" во всех шагах, которые имеют фильтр по файлам `files`, а остальные шаги не выполняет. Это может быть полезно, чтобы пропустить обязательные шаги перед созданием стенда. Команда принимает те же аргументы, что и команда `run`:

```js
graph.earlySkip(graphConfig, steps).catch((err) => {
    console.error(err);
    process.exit(1);
});
```

#### Описание настроек шага в массиве steps

Если шаг представлен в виде массива, то второй элемент массива содержит настройки шага в виде JS объекта:

- `retry` - в случае ошибки в результате выполнения шага, он будет запущен повторно через 10 секунд;
- `continueOnFailure` - продолжать выполнять вложенные шаги, в случае ошибки в текущем;
- `descriptionCommand` - shell-скрипт, вывод которого содержит короткое описание текущего шага (оно будет выведено в статус-чеке на github). Этот скрипт будет запущен после выполнения шага.
- `report` - путь к папке или файлу, в которой содержится отчет о выполнении текущего шага (из этого пути будет создан отдельный ресурс, ссылка на который будет прикреплена к статусу);
- `reportParams` - параметры для отчета в виде [метаданных ресурса](https://wiki.yandex-team.ru/sandbox/cookbook/#kaksozdatzaregistrirovatnovyjjresursizpodprocessazadachi);
    - {String} `description` – описание ресурса
    - {String} `path` – путь до файла или папки ресурса
    - {String} `type` – тип создаваемого ресурса
    - {String} `arch` – архитектура ресурса, по умолчанию будет назначена архитектура текущего хоста
    - {Object} `attributes` – атрибуты ресурса
- `main` - если вы используете опцию `report` и передаете туда папку, вы дополнительно можете указать основной файл в этой папке (ссылка тогда будет сгенерирована на него).
- `intermediate` - признак того, что этот шаг промежуточный. Такой шаг будет выполнен только если от него зависит другой шаг. Позитивные статусы этого шага могут быть скрыты (настройка hideIntermediate).
- `files` - список масок файлов, от которых зависит шаг. Шаг будет пропущен, если включено селективное выполнение и среди измененных файлов нет попадающих под маску. Изменённые файлы будут представлениы относительными путями от `projectPath` либо от корня репозитория.
- `partialRun` - признак того, что в команду шага можно передать список файлов. Строка `%s` в команде будет заменена списком изменённых файлов, попадающих под маски `files`. Если список файлов большой (>100КБ), то команда будет выполнена несколько раз с разным набором файлов. Для работы этой опции требуется включить селективное выполнение.

**Важно:** на данный момент API Trendbox еще не стабилизировано, во избежания поломок вместо переменных окружения (`TRENDBOX_BRANCH`, `TRENDBOX_GITHUB_EVENT_TYPE`, ...) используйте обертки, предоставляемые модулем `trendbox` из текущего пакета, как это сделано в примере выше. При выполнении скрипта в arc ci используйте модуль `arcCi`.

Либо используйте обёртки из универсального модуля `ci` из текущего пакета
(он подставит `trendbox` или `arcCi` в зависимости от окружения).

### Подключение к шагу сборки HTML отчета

Следует обратить внимание, что при подключении HTML отчетов есть важная особенность. Можно указать имя файла используя только опцию report, например:
```
report: 'reports/test/index.html'
```
Однако, в этом случае ответ не будет открываться как HTML при клике по ссылке статуса в GitHub. Чтобы отчет открывался правильно, нужно использовать опцию main:

```js
const steps = {
    test: [
        'yarn jest --config trendbox/jest.config.js',
        { report: 'reports/test', main: 'index.html' },
    ],
};
```

## Дополнительные уведомления

По окончанию сборки будет сгенерирован специальный отчет с результатами работы, который по умолчанию будет отправлен только на внутреннюю почту автора pull request. Дополнительных подписчиков можно указать в поле `subscribers`:

```js
    const graph = new Graph({rootPath, repo, subscribers: []});
```

Важно: в поле `subscribers` указываем только логины подписчиков (без `@yandex-team.ru`).

Так же в заголовке `X-Build-Status` письма будет указан статус сборки (`success` или `failed`).

## How to

1. Если упал шаг с кастомным отчетом, как получить лог выполнения?

Лог выполнения сохраняется вместе с кастомным отчетом, получить его можно заменив в ссылке часть пути `/resource/...` на `/log`.

2. Как прикрепить свою собственную ссылку на статус?

Если передать в поле `report` url, то он и будет подставлен в качестве ссылки для данного статуса.

## Версионирование

При любом изменение логики работы `TKit` инкрементируются минорная или мажорная версия пакета.
Патчевая версия пакета выпускается исключительно при изменении API Trendbox, поэтому все клиенты должны подключать себе последний актуальный патч, чтобы избежать поломок связанных с изменением API Trendbox.
