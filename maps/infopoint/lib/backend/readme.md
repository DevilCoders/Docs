# Backend

Клиент для работы Mongo.
Имеет возможность работать с БД с помощью двух middleware компонентов.
- Command (`Deprecated`)
- Query

## Command (DEPRECATED)
Middleware который исторически использовался для работы с mongo.
У него есть несколько недостатков:

- Настройка запросов ведется через параметры/флажки в конструкторе.
- Плохая читаемость в месте вызова
- Сложно понять, как будет вести себя комбинация нескольких команд.
- Отсутствует возможность выполнять легкие кастомные запросы.
- Предикаты для фильтра комбинируются где-то по принципу "логического И", а где-то "логического ИЛИ", что добавляет сложности

Недавно был добавлен новый middleware для работы с mongo, `Query`. Его можно найти [здесь](https://arcanum.yandex-team.ru/arc/trunk/arcadia/maps/infopoint/lib/backend/query).

**НЕОБХОДИМО ОТКАЗАТЬСЯ** от использования ~~**Command**~~ в пользу **`Query`**!

## Query

Прослойка над mongocxx драйвером, не имеющая недостатков ~~**Command**~~. В Query есть несколько компонентов.
- View
- Filter
- Update
    - Set
    - Unset
    - Inc
    - Push
- ArrayFilter

### View

Имеет ряд функций:
- Название коллекции над которой будет выполняться запрос
- Проекции.
- Парсер объекта бизнес логики из raw-ответа монги

Пример:

```cpp

Infopoint extractPoint(bsoncxx::document::view v)
{
    //...
}


// Работаем с коллекцией points
// Необходимо скрыть внутренние массивы points/comments/votes, чтобы уменьшить сетевой трафик
// Парсер extractPoint вернет объект Infopoint, собраный из сырого ответа mongo
View<Infopoint> viewOfInfopoint()
{
    return {
        .collectionName = "points",
        .projection = buildProjection(
            hide("comments"),
            hide("points"),
            hide("votes")),
        .transform = extractPoint,
    };
}
```

### Filter

Для фильтрации в запросах к mongo, нужно сформировать фильтр из набора предикат. Все предикаты будут объеденены по принципу "логического И".

### Update

Для обновления состояния документов в коллекции используется Update.
На данный момент поддерживаются следующие update-операции:
- Set
- Unset
- Inc
- Push

Поведение соответствует документации mongo

### ArrayFilter

Ряд операций обновления поддерживает механизм array_filters, позволяющий фильтровать элементы массива, для последующего их изменения.
Поведение соответствует документации mongo
