### К кому обращаться
Разработчики maps-core-jams-infopoints, смотри в [основной документации](https://a.yandex-team.ru/arc/trunk/arcadia/maps/infopoint/readme.md)<br>
[Разработчики чистого веба](https://abc.yandex-team.ru/services/cleanweb/?scope=development), в первую очередь [Дмитрий Васильев](https://staff.yandex-team.ru/vdf)<br>
Работа с толокерами (количество, стоимость и тому подобное) - [Татьяна Цымбалова](https://staff.yandex-team.ru/tsymbalava)

### Графики
#### Наши графики
Realtime-графики есть на панелях Sedem из [основной документации](https://a.yandex-team.ru/arc/trunk/arcadia/maps/infopoint/readme.md).

Например, [поток модерации в реальном времени в stable](https://yasm.yandex-team.ru/panel/twisterok._U04h7D/)

[Ежедневная статистика](https://datalens.yandex-team.ru/fhvet3qetlhy7-infopoint-offline-statistics)

#### Графики команды ЧВ
| Название проекта | Что размечает | Регион |
|-|-|-|
| common_toloka | нарушения | мир без Турции |
| custom_map_talks_toloka | про дорожную ситуацию | мир без Турции |
| common_tur_toloka | нарушения | Турция |
| custom_map_talks_tur_toloka_new | про дорожную ситуацию | Турция |

[График размера очереди в Толоке](https://solomon.yandex-team.ru/?project=safesearch&cluster=cleanweb&service=cleanweb_toloka&l.sensor=toloka_queue_size&graph=auto&aggr=max&l.toloka=*&downsamplingAggr=max&l.client=map_talks&l.host=cluster&l.app=toloka_sender&b=2d&e=)

[Число доступных Толокеров по проектам](https://solomon.yandex-team.ru/?project=safesearch&cluster=cleanweb&service=cleanweb_toloka&l.client=map_talks&l.toloka=*&l.sensor=active_workers&l.host=cluster&graph=auto&b=1w&e=)

[График rpm запросов модерации от сервиса infopoints в ЧВ](https://solomon.yandex-team.ru/?project=safesearch&cluster=cleanweb&service=cleanweb_router&host=cluster&sensor=received&graph=auto&l.client=map_talks&interpolate=none&aggr=sum&downsamplingAggr=sum&l.app=router&b=1d&e=)

[Ежедневная статистика ЧВ (Толока, автоматика, стоимость)](https://datalens.yandex-team.ru/nhk23pjgnftul-clean-web-dashboard?tab=MOyb)

### Как работает чистый веб (ЧВ)
1) Мы отправляем HTTP запрос с json'ом, который может в общем случае содержать любые поля, для нашего сценария что-то вроде `{"text": "road event description", "regions": [1, 2, 100]}`.
2) Получаем ответ, в котором либо сразу получаем вердикт, либо признак того, что запрос отправлен в толоку. @vdf говорит о времени получения ответа в пределах 200мс. Интерпретация вердиктов происходит самим сервисом. Возможные их варианты обговариваются отдельно с командой ЧВ.
3) Если в ответе от ЧВ была получена ошибка {"clean-web": "timeout"} или пустой набор вердиктов, то по окончании модерации ЧВ придет к нам сам и дернет ручку, передав в теле вердикты, включающие специальный вердикт `clean_web_moderation_end`, обозначающий окончание модерации. Непустой набор вердиктов без вердикта `clean_web_moderation_end` - нештатная ситуация, можно трактовать на свое усмотрение. ЧВ ретраит этот ответ несколько раз в случае недоступности нашего сервиса. Для идентификации исходного запроса в ответе передается ключ, указанный в исходном запросе.
4) Ответ может быть получен сразу в пределах 200 мс, если автоматика найдет запрещенный текст (мат, спам) в сообщении, либо такой текст лежит в кэше толоки.

### Общая схема работы с ЧВ
Для всех новых ДС и комметов infopoints ходит в ЧВ и просит у него вердикты для текстов описания ДС/комментов. ЧВ отдает для описаний/комментов только вердикты, задающие характеристики самого текста (мат, спам, авария, ремонт и прочее), но не вердикт касательно того, стоит ли банить это описание/коммент. Предполагается, что решение показывать или не показывать ДС/коммент принимается на стороне infopoint'а в момент получения списка вердиктов на основе заданных в infopoints правил. Вердикты могут хранится в бд для аналитики, а также на случай необходимости удалить в будущем ранее разрешенные комменты; например, если через год будет принят закон о запрете оскарбления неграмотных, то проверить на наличие такого оскорбления нужно будет только ранее поставленные комменты с вердиктом insult.

### Правила модерации для Толоки
[Common контур нарушений](https://a.yandex-team.ru/arcadia/yweb/antispam/clean_web/toloka/toloka_projects/common_toloka/instruction.html)

[Custom контур правила про дорогу](https://a.yandex-team.ru/arcadia/maps/infopoint/moderation/rules.md)

### Более подробная схема работы с ЧВ
1) Создается очередь задач, каждая задача которого отправляет на модерацию ДС/коммент.
2) Каждые ДС и коммент имеют поля:
  * `status` - статус модерации;
  * `started` - время начала модерации;
  * `next_retry` - время следующей попытки модерации ДС/коммента;
  * `verdicts` - набор вердиктов.
```
  moderation: {
    status: 'approved',
    started: 11:00:00 01.01.2020,
    next_retry: 12:00:00 01.01.2020,
    verdicts: ['nonroad', 'accident']
  }
```
Набор допустимых статусов модерации: `pending`, `approved`, `disapproved`. О назначении разных статусов модерации см. ниже;
3) При добавлении ДС/коммента они получают статус модерации `pending`, пустой набор вердиктов и время следующего обновления равным `now + RETRY_INTERVAL`. После того как ДС/коммент записаны в базу, в очередь задач добавляется задача на модерацию этого ДС/коммента (не блокирующим добавлением). `RETRY_INTREVAL` - интервал, через который нужно попробовать заново добавить событие на модерацию в очередь задач, если она переполнена сейчас. Событие не отправляется на модерацию сразу в потоке-обработчике запроса, потому что:
  * для пользователя не важен статус модерации его ДС/коммента на момент получения ответа;
  * уменьшается время ответа;
  * меньше кода: один и тот же task pool отправляет на модерацию ДС/комменты как непосредственно после их добавления, так и те, что обрабатываются фоновым корректирующим потоком (см. ниже);
  * можно увеличить время ожидания ответа от ЧВ.
4) Пример таски для ДС:<br>
```
pointUuid: XXX-XXX
text: "some point description text"
regionIds: [1, 2, 3]
```
Пример таски для коммента:<br>
```
commentId: { pointUuid: XXX-XXX, commentIdx: 2 }
text: "some comment text"
region_ids: [1, 2, 3]
```
5) Таск пул берет задание на модерацию из очереди и отправляет http запрос с текстом на модерацию в ЧВ, где возможен один из 4х сценариев:
  * ЧВ недоступен - завершаем таску;
  * ЧВ ответил сразу с вердиктами из кэша толоки, либо выставленными автоматикой, тогда применяем эти вердикты, модерация на этом заканчивается;
  * ЧВ ответил с ошибкой `{"clean_web": "timeout"}` или пустым набором вердиктов - событие скорее всего отправлено в толоку, ждем, пока ЧВ придет к нам сам с набором вердиктов, выставляем `next_retry` в `now + MAX_PENDING_DURATION`, `MAX_PENDING_DURATION` - максимально допустимое время, в течение которого ДС/коммент может иметь статус `pending`, в основном диктуется временем обработки запроса модерации толокой (порядка нескольких минут);
  * ЧВ ответил с неизвестной ошибкой, например, `{"clean_web": "server_error"}` - завершаем таску.
6) Если на каком-то из этапов обработки таски произошла ошибка (ЧВ недоступен, сервис упал, бд недоступна), гарантируется, что примерно через `MAX_PENDING_DURATION + CHECK_INTERVAL` или `RETRY_INTERVAL + CHECK_INTERVAL` фоновым корректирующим потоком будет предпринята попытка заново отмодерировать этот ДС/коммент (что такое корректирующий поток и `CHECK_INTERVAL` см. ниже).
7) Автоматика может отдавать вердикты только из группы вердиктов, которые мы однозначно считаем плохими, то есть про которые мы уверены, что они не должны показываться пользователю (реклама, контактные данные, спам). Другими словами, критично, чтобы мы получали в одном ответе от ЧВ набор вердиктов достаточный для принятия решения о показе ДС/коммента пользователю. Например, если мы получим вердикт `text_auto_light_threat` (предположим, разрешенный), а через 2 минуты вердикт `text_toloka_insult` (предположим, запрещенный), то 2 минуты событие будет светиться в слое, для избегания подобных ситуаций `["text_auto_light_threat", "text_toloka_insult"]` должны быть получены в одном ответе от ЧВ.
8) После того, как ЧВ пришел к нам с новыми вердиктами (этого можно ожидать в любой момент с момента первичной записи ДС/коммента в бд, даже если текущий инстанс не отправлял ДС/коммент на модерацию, это мог сделать другой инстанс при очень специфичных условиях), то применяем эти вердикты.
9) Так как возможны падения нашего сервиса, недоступность ЧВ (например, ошибка сети), некоторые ДС/комменты могут подвиснуть в статусе модерации `pending`. Чтобы такие события в конечном итоге прошли модерацию, раз в `CHECK_INTERVAL` проверяющий фоновый поток достает из бд все у которых просрочен статус `pending` (`next_retry <= now`) и добавляет их в очередь задач (не блокирующим добавлением - если очередь переполнена, то текущая итерация проверки прерывается до следующего `CHECK_INTERVAL`):
```
id == POINT_ID && moderation.status == 'pending' && moderation.next_retry <= now
  ==>
  $set moderation.next_retry = now + RETRY_INTERVAL
  $inc version
```
Обновлять `next_retry` нужно, чтобы другие инстансы infopoint'а не пробовали параллельно отмодерировать это же событие.
10) Некоторые ДС получают статус модерации `approved` и пустой список вердиктов сразу после добавления. Такие события автоматически разрешается экспортировать кому угодно и они не проходят модерацию. Пример таких ДС:
  * ДС от партнеров, модераторов, экспертов;
  * ДС с пустым description'ом
  * ДС с description'ом с описанием полос для определенных типов событий ("левый ряд, правый ряд" для аварии/ремонта), потому что эти description'ы зашиты в код клиентов (для некоторых типов событий пользователю доступен быстрый выбор полос при добавлении ДС), таких событий примерно треть от общего числа и они стандартные, нет необходимости их модерировать.
11) Зачем инкрементировать версию точки ($inc version)? Чтобы другие методы не перезаписали точку после того, как мы проставили модерацию. Так как в infopoints пока не поддерживаются транзакции, то используется следующая схема контроля транзакций: (1. считывается точка последней версии Х) -> (2. в коде над ней выполняются манипуляции) -> (3. точка перезаписывается обратно в бд с инкрементом версии только если версия точки в бд == Х). Если не инкрементировать версию при модерации, то другой поток, например, при голосовании, не увидит изменения версии точки на этапе 3 и может перезаписать туда свою версию точки без модерации.<br>
Пример без инкремента версии (случайно стираем статус модерации):
```
Thread 1: read point A (version = X)     modify point A (apply vote)     write point A,
                                                                         moderation state overwritten :-(

Thread 2:                                atomically moderate and write
                                         point A without inc(version)
```
 Пример с инкрементом версии (получаем ошибку при голосовании, но статус модерации не теряется):
```
Thread 1: read point A (version = X)     modify point A (apply vote)     write point A, ERROR:
                                                                         version is not X, point was modified

Thread 2:                                atomically moderate and write
                                         point A and inc(version)
```
При переходе на транзакции в infopoints пропадут и ошибки голосования.
12) В infopoints через параметр конфига можно включить заглушку чистого веба (fake_clean_web). Это нужно для стрельб, чтобы не ходить в ЧВ, но и не выключать окончательно работу с потоками и модерацией для более достоверных результатов стрельбы.

### Как применяются вердикты
* Если мы считаем вердикты допустимыми (т.е. текст удовлетворяет условиям использования сервиса), то делаем findAndUpdate для этого ДС/коммента, при этом может поменяться тип события:
```
id == POINT_ID
  ==>
  $set moderation.status = 'approved'
  $set moderation.verdicts = VERDICTS
  $set tags = NEW_TAGS
  $inc version
```
* Если мы считаем вердикты НЕ допустимыми (оскорбления, спам, проч.), то удаляем этот ДС/коммент.
#### Правила конвертации вердиктов в статус модерации и тип события
[... смотри здесь](https://a.yandex-team.ru/arc/trunk/arcadia/maps/infopoint/moderation/verdicts_conversion.md)

### Если ЧВ недоступен
Примерная скорость отправки событий на модерацию равна (число worker'ов) / (длительность обращения к ЧВ)rps. Если число worker'ов == 4, а длительность обращения к ЧВ примерно 200мс, то получаем в районе 20rps на модерацию при нормальном режиме работы (на каждый инстанс infopoints), это примерно 10ти кратный запас для наших нагрузок. Если ЧВ недоступен, то рпс исходящих запросов падает до 4 (время попытки неуспешного подключения примерно равно 1с). Как только частота появления событий в базе, требующих модерации (речь не только про новые события, но и события с протухшим статусом `pending`), превысит частоту отправки запросов на модерацию (непример, из-за недоступности ЧВ), очередь начнет заполняться. При переполнении очереди задач, потоки, обрабатывающие пользовательские запросы, не будут блокироваться, потому что используют не блокирующее добавление. Каждая неуспешная попытка модерации - это 1 запись в бд в корректирующем потоке, поэтому не рекомендуется делать число worker'ов большим, чтобы не спамить лишний раз базу данных (можно сделать отдельный ratelimiter для этого, но пока для простоты можно просто ограничиться числом worker'ов). На время недоступности ЧВ ДС/комменты остаются неотмодерированными. После восстановления нормальной работы ЧВ очередь начнет рассасываться.

### Формат исходящего запроса
```
POST https://router-prod.clean-web.yandex.net/v2/
Content-Type: application/json
{
  "jsonrpc": "2.0",
  "method": "process",
  "params": {
    "service": "maps-core-jams-infopoints",
    "type": "text",
    "key": "KEY",
    "body": {
      "text": "my new point description",
      "environment": "ENVIRONMENT",
      "regions": [ REGIONS_IDS... ]
    }
  },
  "id": 1
}
```
`KEY` для точки - uuid точки, а для коммента - связка uuid точки и id комментария, например: `a580d6b8-aa63-11ea-bb37-0242ac130002/7`.<br>
`ENVIROMENT` - окружение infopoint'а, откуда отправляется запрос, допустипые значения `stable`/`testing` (см. [staging](#staging).<br>
`REGION_IDS` - список id регионов местоположения точки (для разных стран могут быть разные инструкции, как минимум Турция/Россия, маршрутизация в нужную толоку выполняется на стороне ЧВ).<br>
Заголовки запроса:
```
X-Ya-Service-Ticket: TVM_TICKET
Content-Type: application/json
```


### Формат ответа
Если ЧВ не смог ответить сразу, то ответ на исходный запрос:
```
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "errors": {"clean-web": "timeout"}
  }
}
```
, либо
```
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "verdicts": []
  }
}
```
Если ЧВ смог ответить сразу, то в ответе сразу приходят вердикты:
```
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "verdicts": [
      {
        "name": "text_toloka_obscene",
        "subsource": "tmu",
        "value": true,
        "entity": "text",
        "source": "some-source",
        "key": "KEY"
      },
      {
        "name": "road_accident",
        "subsource": "tmu",
        "value": true,
        "entity": "text",
        "source": "some-source",
        "key": "KEY"
      },
      {
        "name": "clean_web_moderation_end",
        "subsource": "tmu",
        "value": true,
        "entity": "text",
        "source": "some-source",
        "key": "KEY"
      }
    ]
  }
}
```
Причем в ответе должен присутствовать хотя бы 1 вердикт, чтобы можно было извлечь key. Чистым вебом гарантируется наличие вердикта `clean_web_moderation_end`, этот вердикт не записывается нами в базу данных.

Если ЧВ не смог обработать запрос сразу, то вердикты доставляются infopoint'у через определенное время в теле запроса `POST /v2/apply_moderation_verdicts`.

Поле `subsource` - игнорируется. Вердикты с `value = false` тоже игнорируются (и по умолчанию вообще не присылаются в ответе).

Почему не через url параметры: @vdf `не, у нас на единый формат отправлятора уже довольно много завязано`


### Межсервисная авторизация
Межсервисная авторизация выполняется через TVM. TVM ID сервиса maps-core-jams-infopoints:
```
testing: 2012230
stable: 2012214
```
Ручка `POST /v2/apply_moderation_verdicts` доступна только для TVM сервиса чистого веба, а в testing'е также для анонимного пользователя с очень маленьким лимитом rps для отладки (чтобы можно было дергать ручку с dev-машины, например). Ограничение на уровне ручки вводится через ratelimiter.


### Staging'и
infopoints testing и stable оба ходят в stable ЧВ - это нужно учитывать, чтобы через testing случайно не перегрузить толоку задачами, потому что страдать начнет и stable (читай, не стреляй в testing).<br>
infopoints load в ЧВ не ходит (см. выше).<br>
ЧВ отдает нам вердикты на ручку `/v2/apply_moderation_verdicts` хосту в зависимости от параметра `environment` исходного запроса:<br>
* `"environment": "stable"` - на fqdn `infopoints.maps.yandex.net`
* `"environment": "testing"` - на fqdn `infopoints.tst.maps.yandex.ru`


### Логгирование
Помимо стандартного логгирования в лог сервиса, также выполняется логгирование модерации в events\_logger [MAPSROADEVENTS-53](https://st.yandex-team.ru/MAPSROADEVENTS-53). В лог добавляются события типа `point_moderated` и `comment_moderated`. В поле `value` логируется новый статус модерации, новые вердикты, набор тэгов точки до и после модерации (тэги логгируются только для `point_moderated`, в `comment_moderated` поля `tags_before`/`tags_after` отсутствуют), например:<br>
```
{
    "status": "approved",
    "verdicts": ["request", "police"],
    "tags_before": ["other"],
    "tags_after": ["police", "speed_control"]
}
```

### Мониторинги
Онлайн yasm сигналы [MAPSROADEVENTS-2](https://st.yandex-team.ru/MAPSROADEVENTS-2): число событий на модерации, общее число отмодерированных событий, число показанных пользовательских событий, число показанных событий от партнеров и другие. Отправка сигналов выполняется стандартными средствами yacare. По этим же сигналам настраиваются juggler мониторинги. Графики рисуются на главной панели infopoints, генерируемой sedem'ом (см. основной readme).<br>
Офлайн графики [MAPSROADEVENTS-56](https://st.yandex-team.ru/MAPSROADEVENTS-56): по данным из event\_logger'a в офлайн режиме уже можно получать более подробную статистику по типам события, распределению времени модерации, проценту автомодерации и любую другую. Данные в таблице event_logger'а обнавляются раз в час (см. [основную документацию infopoints](https://a.yandex-team.ru/arc/trunk/arcadia/maps/infopoint/readme.md)).

### Полезные ссылки
- [Регулярки ЧВ для текстов с полосами](https://a.yandex-team.ru/arc/trunk/arcadia/yweb/antispam/tmu/rules/src/for_map_talks_lanes.r2)
