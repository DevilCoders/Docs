Здесь находится набор тулов предназначенных для исправления ошибок рельефа.
Общая идея состоит в том что если у нас есть сегментированная маска дорог на исходном рельефе и соответствующая идеальная маска дорог (gps треки или ymapsdf данные), то сравнивая их между собой мы можем найти и исправить неточности в рельефе в данной области. Конкретно нам нужно выполнить следующие шаги:

- Получить маску дорог в данной области на начальном рельефе
- Получить эталонную маску дорог в этой области
- Найти глобальный сдвиг для нашей маски
- Использовать на них тул для коррекции рельефа чтобы получить скорректированный рельеф
- Оценить полученный результат

## Получить маску дорог в данной области на начальном рельефе

Сначала нам нужно получить изображение в данной области объеденяя PAN и MUL маски, для этого служит тул fuse_cli. Пример использования:
`./fuse_cli -i http://s3.mds.yandex.net/maps-sat-cog-testing/20173364 -o ~/data/fused.tif`

Затем нужно распознать дороги на данном изображении, для этого служит тул detect_roads. Пример использования:
`LD_LIBRARY_PATH=~/cuda_libs/lib64/:~/cuda_libs/lib64/stubs/ ./detect_roads_cli -i ~/data/fused.tif -o ~/data/roads.tif`

## Получить эталонную маску дорог в этой области

Можно использовать два различных источника истинной маски: gps треки и векторные данные ymapsdf. Для получения маски из gps треков есть тул load_gps_cli. Пример использования:
`./load_gps_cli -i ~/data/roads.tif -o ~/data/gps.tif`

Чтобы получить маску из векторных данных их нужно сначала скачать:
`./load_ymapsdf_cli -i ~/data/roads.tif -o ~/data/ymapsdf.geojson`
А затем составить из них маску:
`./render_ymapsdf_cli -i ~/data/roads.tif -y ~/data/ymapsdf.geojson -o ~/data/ymapsdf.tif`

Так же можно совместить gps и ymapsdf данные:
`./render_ymapsdf_cli -i ~/data/gps.tif -y ~/data/ymapsdf.geojson -o ~/data/ymapsdf_gps.tif --overlay`

## Найти глобальный сдвиг для нашей маски

Снимок так же сдвинут на некоторый константный сдвиг который не зависит от рельефа, его можно найти спроецировав дороги на начальный рельеф и подобрав сдвиг таким образом чтобы полученная маска лучшим образом наложилась на эталонную, это можно сделать тулом calculate_global_shift_cli:
`./calculate_global_shift_cli -i ~/data/roads.tif -g ~/data/gps.tif -o ~/data/global_shift.txt -t ~/data/shifted_roads.tif`
Далее чтобы учитывать этот глобальный сдвиг его можно либо подавать через специальную опцию файлом global_shift.txt или просто использовать далее уже сдвинутый снимок shifted_roads.tif.

## Использовать на них тул для коррекции рельефа чтобы получить скорректированный рельеф

Первый тул для получения коррекций - adaptive_blur_cli. Используя этот тут мы проходим по точкам рельефа рядом с дорогами, применяем гауссовый блюр к рельефу в этой точке с различными sigma и проверяем увеличивает ли это кросс-корреляцию между нашими масками в окрестности этой точки, лучший вариант оставляем в итоговом рельефе:
`./adaptive_blur_cli -i ~/data/shifted_roads.tif -o ~/data/blured_dem.tif -g ~/data/gps.tif --sigma -1`

Второй тул - calculate_corrections_cli. Используя этот тул мы так же проходим по точкам рельефа рядом с дорогами только теперь мы рассматриваем некоторое окно вокруг этих точек и ищем лучший сдвиг который переведёт нашу маску в эталонную, затем используя RPC преобразование мы ищем коррекцию рельефа которая лучше всего приближает этот сдвиг:
`./calculate_corrections_cli -i ~/data/shifted_roads.tif -o ~/data/corrected_dem.tif --shifts ~/data/local_shifts.geojson`

## Оценить полученный результат

Чтобы получить маску спроецированную на новый рельеф можно использовать тул warp_cli:
`./warp_cli -i ~/data/shifted_roads.tif -o ~/data/blured_roads.tif -d ~/data/blured_dem.tif`

Затем можно вычислить метрики сегментации используя evaluate_segmentation_cli:
`./evaluate_segmentation_cli -i ~/data/blured_roads.tif -r ~/data/gps.tif -o ~/data/segmentation_metrics.json`

Если мы работаем с тайлом для которого есть истинный рельеф, то можно сравнить его и результат коррекции:
`./calculate_corrections_cli -i ~/data/blured_dem.tif -o ~/data/blured_metrics.tif`

Так же для тула calculate_corrections_cli можно оценить найденные локальные сдвиги:
`./evaluate_shifts_cli -s ~/data/local_shifts.geojson -i ~/data/shifted_roads.tif -g ~/data/gps.tif -o ~/data/shifts_err.tif`
