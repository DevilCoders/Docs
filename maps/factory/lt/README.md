# factory-process-dg

Инструмент обрабатывает спутниковый снимок (продукт) формата L2, поставляемый нам
компанией [Digital Globe](https://www.digitalglobe.com). Результатом обработки является трёхканальное
8-битное [орторектифицированное](https://www.satimagingcorp.com/services/orthorectification/) изображение в
натуральных цветах.

## Описание структуры продукта L2:

Растровые изображения в продукте имеют формат TIF + TIL (пачка tif-файлов, плюс текстовый файл с описанием
того, как их склеивать). Такой формат можно обрабатывать GDAL-ом. В нашём случае — это
радиометрически-скорректированное изображение в проекции UTM (данные о проекции можно вытащить при
помощи `gdalinfo`). Формально в файле используется 16-битный формат пикселя, но по факту из них используются
только 11 бит (максимальное значение одного канала — 2047).

В продукт входят следующие директории:

* Директория `*_MUL` — 16-битное четырёхканальное (RGBN) растровое изображение. Номинальное разрешение — 2
  метра на пиксель.
* Директория `*_PAN` — 16-битное одноканальное (P) растровое изображение. Номинальное разрешение — 0.5 метра
  на пиксель.
* В обеих директориях выше есть файл `.RPB` — этот файл содержит коэффициенты полином, описывающие траекторию
  полета спутника. Его умеет принимать gdal на этапе орторектификации.
* Директория `GIS_FILES` — тут несколько шейпов, нас интересует файл `*_P2AS_*_PIXEL_SHAPE.shp` — это маска
  для выкидывания NODATA-значений.
* Директория `md5` — md5-файлы для каждого файла продукта. Возможно, их нет в исходном формате поставки и их
  добавил Сканэкс.
* Какие-то файлы с метаданными повторяющие друг друга, разложенные в разных места, формат XML, (посмотрел
  мельком, на процесс обработки они не влияют, но могут пригодиться для формирования
  метаданных `MosaicSource`).

Наиболее полную спецификацию формата поставки можно
найти [здесь](https://dg-cms-uploads-production.s3.amazonaws.com/uploads/document/file/106/ISD_External.pdf).

## Процесс обработки:

Процесс обработки продукта состоит из трёх этапов:

1. Паншарпенинг
2. Орторектификация
3. Приведение к натуральным цветам

В данный момент не реализован алгоритм вычисления границ растрового изображения после орторектификации.

### Паншарпенинг

Паншарпенинг — это формирование одного цветного изображения высокого разрешения из пары: цветного изображения
низкого разрешения и чёрно-белого изображения высокого разрешения.

В данный момент реализован через GDAL. Мы пишем на диск файл
в [специальном формате VRT](https://www.gdal.org/gdal_vrttut.html#gdal_vrttut_pansharpen), после чего
натравливаем на этот файл утилиту `gdal_translate`. В этот же самый момент изменяется порядок и набор цветов
растрового изображения: выходное изображение имеет схему RGB.

Внутри GDAL реализован алгоритм Брови (Brovey), который, судя по всему, изменяет значение Hue для пикселя. В
результате изображение после обработки имеет не те цвета, что были до
обработки. [Здесь](http://gis-lab.info/qa/qgis-pansharp-otb.html) описывается другой алгоритм.

### Орторектификация

Орторектификация выполняется при помощи запуска утилиты `gdalwarp`:

1. На вход принимается изображение после паншарпенинга,
2. рядом с ним подкладывается `.RPB`-файл одноканального изображения,
3. вычисляется его bounding box в географических координатах,
4. вычисляются покрывающие его тайлы датасета с рельефом,
5. при помощи утилиты `gdalbuildvrt` строится виртуальный датасет с рельефом,
6. собственно, запускается `gdalwarp`.

Существуют альтернативные инструменты для орторектификации:

1.
[Orfeo Toolbox](https://www.orfeo-toolbox.org/CookBook/Applications/app_OrthoRectification.html)

Не удалось заставить работать орторектификацию. Выходное изображение пиксель в пиксель совпадало со входным.


2.
[ossim](https://trac.osgeo.org/ossim/wiki/orthorectification)

Требуется [хитрая конфигурация](https://trac.osgeo.org/ossim/wiki/ossimElevationSetup) для того, чтобы
орторектификация заработала.

Результат подобен выходным данным gdal, однако время работы получается существенно меньше.

3.
[gdal_ortho](https://github.com/DigitalGlobe/gdal_ortho)

Официальный инструмент DigitalGlobe для орторектификации. Суть его заключается в скачивании тайлов рельефа с
s3 и запуску `gdalwarp`.

Команда запуска аналогична той, что используется нами в коде.
4.
[Кейс ортокоррекции снимка OrbView-3](http://wiki.gis-lab.info/w/Ортокоррекция_данных_OrbView-3_с_помощью_GDAL)

Рассматривается ортокоррекция средствами `gdalwarp`, `wxGIS` (основанном на `gdal`) и `ENVI EX`; утверждается,
что полученные результаты _идентичны_.

Дополнительно рассматривается случай коррекции геоида `WGS84` -> `EGM96` (возможно, имеется в виду `EGM84`
-> `EGM96`). В используемом нами варианте коррекция геоида в данный момент отсутствует.

### Приведение к натуральным цветам

Приведение осуществляется при
помощи [эквализации гистограммы](https://en.wikipedia.org/wiki/Histogram_equalization):

1. Для каждого канала вычисляется его гистограмма,
2. вычисляются её минимум и максимум,
3. они дополнительно сужаются так, чтобы отсечь небольшой процент гистограммы (точное значение нужно уточнять
   в коде),
4. вычисленные значения для каждого канала скармливаются в утилиту `gdal_translate`.

