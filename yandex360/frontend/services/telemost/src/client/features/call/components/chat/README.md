## Чаты в телемосте

####Входные данные
Проект https://st.yandex-team.ru/CHEMODAN-75295

ТЗ https://wiki.yandex-team.ru/telemost/product/chaty-v-telemoste/

####Структура виджета и его логика в коде телемоста
Основная часть компонента находится тут `services/telemost/src/client/features/call/components/chat`
Параметры для чата находятся в сторе в поле `conference.chat`

Основной компонент чата, `<ChatWidget />` рендерится в корневом контейнере приложения.
Условие показа чатов регулируется бекендом [@yak-dmitriy](https://staff.yandex-team.ru/yak-dmitriy) 
через присылание в стейте флага `chat_allowed`.

Создается виджет в корневом методе `initChatWidget`, который вызывает компонент чата при рендеринге и проверке наличия
`chatId` (идентификатора чата). Создается экземпляр класса `window.Ya.ChatWidget`. Там же настраиваются основные 
параметры чата (`iframeUrlParams.flags`) и пр

Саги `services/telemost/src/client/features/call/chat-sagas.ts`

####Особенности виджета, которые надо учитывать в разработке
- виджет надо рендерить уже в фоне, еще до его открытия по кнопке в тулбаре. Нужно оперировать методами `showChat` и 
  `setVisibility`. `setVisibility` + флаг `visibilityMode` (который по умолчанию `visible_and_focused`) управляют
  правильным фокусированием в виджете для адекватного "прочитывания" непрочитанных.
`showChat` помогает виджету правильно настроиться и принимать нужные события и открывает виджет правильно, 
  согласно логики от мессенджера. Это рекомендованный способ открытия виджета от разработчиков мессенджера.
  Интересно, что эти методы в доке указаны только для [виджета яндекса](https://a.yandex-team.ru/arc/trunk/arcadia/frontend/services/messenger.widget/docs/widget_ya.md).
  Но и для легковесного облегченного виджета, который мы используем, эти методы так же использовать можно.
  Рекомендации использовать именно облегченный виджет, в котором надо все самим допиливать - это часть рекомендаций по
  интеграции виджета мессенджера в телемост.
- у виджета есть событие `ready`, по которому мы понимаем можно ли показывать виджет. 
  Оно триггерится только один раз, когда создается чат и первый раз открывается виджет.
- для виджета можно настроить свой способ обработки авторизации для анонимных пользователей, захотевших
зайти в чат под своим логином. Для этого надо было бы передать во флаги чата `authType: own` и ловить событие 
  `authRequest` и самим обрабатывать по клику на кнопку "Присоединиться". Мы остались на стандартном способе, но
  возможности никто не отменял.
- в тестовом окружении мы залогинены аккаунтом из тестового паспорта. В проде/престейбле продным. Если мы меняем 
авторизацию, то куки меняются. Виджету это не нравится - куки продные сразу перебиваются. И мы видим в консоли много
ошибок типа `auth cookie failed`. Если виджет был при этом видим - увидим в нем текст "Не удалось загрузить виджет, 
  попробуйте еще раз". Это нормально.
- виджет надо сначала создавать без переданного `chatId`, но с `unreadCounterChatId`.
Потом виджет показывается через метод `showChat` с созданным chatId. Это нужно для того, чтобы
  не словился баг мессенджера с неправильным определением области для метода `setVisibility`.
- остальные тонкости в `services/telemost/src/client/features/call/components/chat/helpers.ts`

- управление добавлением юзеров в чат делается на клиентской стороне. И потому надо следить чтобы при изменениях в 
приложении юзер смог снова оказаться в чате.
  В настоящий момент добавление юзера в чат мы делаем:
    - при открытии конфы и уже есть чат
    - во время конфы кто-то создал чат
    - после реконнекта
                         
- следить за соответствием окружения виджета и ручек cloud-api. Бек телемоста на тестинг окружении ходит в тестинг
мессенджера, престейл окружение - в альфу мессенджера, прод - в прод мессенджера

####Окружения мессенджера
  тест `api.messenger.test.yandex.ru`, `config=testing`

  престейбл `api.messenger.alpha.yandex.ru`, `config=development`

  прод `api.messenger.yandex.ru`, `config=production`

####Как применить тестовую сборку (пул-реквест) от мессенджера и отлаживать на dev-е
Допустим мессенджер сделал таску и сказал пул
https://st.yandex-team.ru/MSSNGRFRONT-7345
и пул https://a.yandex-team.ru/review/1688927/details
1) В `iframeUrl` указать `https://renderer-chat-pull-1688927.hamster.yandex.ru/chat`
2) В script.src откуда будет грузиться виджет меняем ссылку на `https://messenger-test.s3.mds.yandex.net/widget/pull-1688927/widget_light.js`
3) В csp политиках в блоке `'script-src'` и `connect-src` можно указать `hamster.yandex.ru` для тестинга
4) Не забыть указать правильный конфиг (раздел ниже)
                      
Ссылки из пунктов 1-2 взяты после перехода по сссылке с [пулом](https://a.yandex-team.ru/review/1688927/details) [КАРТИНКА](https://jing.yandex-team.ru/files/ekhurtina/2021-04-06%2018-22-01%20MSSNGRFRONT-7345%3A%20%D0%A0%D0%B5%D0%B0%D0%BB%D0%B8%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D1%8C%20%D0%B2%D0%BE%D0%B7%D0%BC%D0%BE%D0%B6%D0%BD%D0%BE%D1%81%D1%82%D1%8C%20%D1%83%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D1%8F%D1%82%D1%8C%20%D0%BF%D0%B0%D1%80%D0%B0%D0%BC%D0%B5%D1%82%D1%80%D0%BE%D0%BC%20%D0%B2%D0%B8%D0%B4%D0%B8%D0%BC%D0%BE%D1%81%D1%82%D0%B8%20%D0%BC%D0%B5%D1%81%D1%81%D0%B5%D0%BD%D0%B4%D0%B6%D0%B5%D1%80%D0%B0%20%D1%85%D0%BE%D1%81%D1%82%D0%BE%D0%BC%20-%20Review%2016.png)

####Как завести чат в dev окружении
В основном методе создания виджета указать

```
iframeUrlParams: {
    config: 'testing',
    // for debug only
    debug: '*'
}
```
debug=* если хотим чтобы сыпались события от мессенджера в консоль (они сыпятся в файл виджета
debug.js).

Если не указан тестовый конфиг, мессенджер будет ломиться в продный паспорт, юзер не сможет добавиться в чат и все будет
грустно - виджет будет пустой или по клику не откроется совсем.
Так же в csp политиках в блоке `'script-src'` можно указать `hamster.yandex.ru` для тестинга (в основном FF ругался на отсутствие этого хоста)

####Кому сообщать о проблемах, куда бежать (чаты, вики)
https://wiki.yandex-team.ru/messengerfront/duty/chats/

####Как находить ошибки виджета и репортить о них команде мессенджера
Если на тестовом окружении, то можно еще при дебаге в виджете указать `debug=*` (предыдущий раздел). И потом лог кидать
разработчикам.

У мессенджера есть также бустер https://error.yandex-team.ru/projects/messenger/errors

Пример запроса
https://error.yandex-team.ru/projects/messenger/items?filter=page%20==%20telemost&from=2021-04-03%2020:00:00

####Как залипать в экспериментах мессенджера
Спросить пул от мессенджера, на который надо залипнуть и на странице яндекса в жучке [залипнуть](https://jing.yandex-team.ru/files/ekhurtina/uhura_2021-04-06T17%3A40%3A51.974798.jpg)

####Основная документация по виджету
- https://a.yandex-team.ru/arc/trunk/arcadia/frontend/services/messenger.widget/docs/widget_light.md

- Песочница для экспериментов с параметрами виджета
https://messenger-test.s3.mds.yandex.net/widget/dev/index.html?build_script=widget_ya
  При изменении параметров в консоли печатается конфиг
                      
- Флаги https://a.yandex-team.ru/arc/trunk/arcadia/frontend/services/messenger/docs/flags.md

- TS типы виджета для вдохновения https://a.yandex-team.ru/arc_vcs/frontend/services/messenger.widget/src/@types/chat-widget.d.ts?rev=r7947151


Вообще мессенджер обещал нормальную доку по интеграции и виджету, но пока собираем по крупицам.

`Happy chating`
