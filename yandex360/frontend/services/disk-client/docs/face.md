## Авторизация

На эту страницу приходим, если пользователь не авторизован. По дефолту, всегда выполняется сценарий `auth.jsx`. Если пользователь авторизован, то управление передается в сценарий `index.jsx` (не редирект!).

Если пользователь не авторизован, то показывается промо-страница авторизации с видео.

### «Домик»
![](https://yadi.sk/i/HI7huehbUrfZn_XXL.jpg)

Простой попап авторизации может показываться над страницей авторизации, если перешли по специальному урлу `/auth/`, либо над веб-клиентом, если во время работы приложения слетела авторизация. Здесь речь пойдет только о первом варианте: попап над страницей авторизации.

### Предупреждение о заведении нового пользователя

Если пользователь кликнул на кнопку «Завести Диск» и у него есть L-кука (т.е. у него уже есть аккаунт в Яндексе), то показываем попап-предупреждение.

![](https://yadi.sk/i/wv7nVi76UqNLd_XXL.jpg)

Логика (проверка куки) и открытие этого попапа (через АПИ наноблоков) будет на клиенте.

## Принятие приглашение в общую папку (/folder)

Страница принятия приглашение в папку:

![](https://yadi.sk/i/vxJBOpfjUqTTF_XXL.jpg)

Cценарий:

  * если пришли вообще без хеша
    * покажем страницу ошибки
  * прогоняем через паспортные редиректы
  * получаем информацию про приглашение (ручка `share_invite_info`)
  * проверяем авторизацию
    * если нет
        * сохраним хэш в куку `dfh` (чтобы вспомнить про инвайт, на случай если пользователь прекратить текущую сессию и авторизуется в другом месте портала)
        * показываем страницу авторизации с попапом про приглашение (`folder.de.yate`)
    * если есть
        * проверяем принял ли он уже приглашение
            * если да
                * сразу делаем редирект в эту папку
            * если нет
                * если пользователь новенький, сначала инициализируем его
                * пытаемся принять приглашение в папку
                  * если не удалось (например, нет такого инвайта)
                    * покажем страницу ошибки
                  * если все хорошо
                    * делаем редирект в новую папку

## Принятие приглашения в Диск (/invite)

Страница принятия приглашения в Диск для неавторизованного пользователя:

![](https://yadi.sk/i/J3PIt3x9UqrFG_XXL.jpg)

Сценарий:

  * если нет хеша
    * покажем ошибку сразу
  * проверяем авторизацию
      * если нет
          * сохраним хэш в куку `dih` (чтобы вспомнить про инвайт, на случай если пользователь прекратить текущую сессию и авторизуется в другом месте портала)
          * получаем информацию про юзера, который выслал приглашение (ручка ???)
          * показываем страницу авторизации с попапом про приглашение (`invite.de.yate`)
      * если да
          * активируем инвайт (ручка `invite_activate`)
            * если все хорошо
              * отправляем в index.jsx
            * если ошибка
              * если инвайт уже активирован
                * отправляем в index.jsx и пишем информацию о том, что нужно показать сообщение об ошибки (попап над веб-клиентом)
              * если инвайт не найдет или другая ошибка
                * показываем страницу ошибки

## Сохранения файла на Диск (/copy)

Страница сохранения файла на Диск для неавторизованного пользователя:

![](https://yadi.sk/i/FH6fjqiIUqsyV_XXL.jpg)

Сценарий:

  * прогоняем через паспортные редиректы
  * если нет хеша покажем ошибку
  * получаем данные о ресурсе по хешу (ручка `public_info`)
    * если нет данных покажем ошибку
  * проверяем авторизацию
    * если нет
        * показываем страницу авторизации с попапом про сохранение файла (`copy.de.yate`)
    * если да
        * если пользователь новенький, сначала инициализируем его
        * пробуем скопировать в папку Загрузки
            * есть ли в параметрах запроса path
                * копируем файл по id (path). Если есть параметр в запросе `name`, его нужно дополнительно пробросить (ручка `async_copy_default`)
            * есть ли в параметрах запроса hash,
                * проверяем тип ресурса
                    * если это файл, запускаем синхронное копирование (ручка `public_copy`)
                      * если не получилось покажем ошибку
                    * если это папка, запускаем асинхронное копирование (ручка `async_public_copy`)
        * редиректим в папку загрузки
