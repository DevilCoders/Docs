# Changelog

## https://st.yandex-team.ru/DARIA-63490
- добавлена возможность указания параметров у фичи
- добавлен метод `Daria.getFeatureParams(featureName)`, который возвращает параметры фичи

===

См также [эксперименты](docs/experiments.md).

# Фичи
Фичей мы называем какое-то интерфейсное решение, которое может быть включено или выключено.
К примеру, новые аттачи - см таск https://st.yandex-team.ru/DARIA-57592

Предполагается, что фича может быть доступна части пользователей, а значит у нас есть версия интерфейса с фичей и без.
В примере с аттачами у нас была версия интерфейса с новыми аттачами и версия со старыми.

## Фичи vs эксперименты
В: Зачем что-то ещё, если у нас есть уже эксперименты?

О:
  1. Логика вычисления включенности фичи может быть сложной. К примеру, бывают случаи, когда для
  2 и более экспериментов включается одна и та же фича (пример: пользователю нужно показать новые аттачи
  если у него стоит один из экспериментов - `34527` или `34529`).
  2. Иногда во время разработки не известно, какой будет номер эксперимента, но уже, к примеру, можно верстать.
  В этом случае удобно везде в коде начать использовать какой-то идентификатор, а уже номер эксперимента прикрутить,
  когда он будет создан.

В: Когда достаточно эксперимента и не нужно заводить фичу?

О:
  - если наличие фичи определяется проверкой одного эксперимента
  - **И** если не требуются стили для вашего эксперимента

В этом случае достаточно проверки включенности эксперимента.
Кроме того, для каждой включенной фичи добавляется класс на элемент `HTML` страницы. Кажется, не стоит раздувать HTML,
когда можно этого избежать.

## Архитектура
Как это работает:
- приходит первый запрос к почте - `u2709/index.jsx`
  - после вычисления включенных экспериментов мы вычисляем включенные фичи (метод `getFeatures()`) и складываем
их в клиентский конфиг
  - в методе `getHTMLClass()` для каждой включенной фичи добавляется класс вида `feature-<featureName>`.
  Все эти классы затем добавляются на `HTML` ноду в момент шаблонизации начального HTML.
- на клиенте
  - в yate коде
    - `has-feature(featureName)` - функция проверки фичи
    - `has-feature-value(featureName, yesValue, noValue)` - функция хэлпер, которая возвращает одно из значений
    в зависимости от того, есть у пользователя эксперимент или нет
  - в `lib/models/Features` есть функция `hasFeature(featureName)`
  - в стилях
    - в `mail-globals.styl` в объекте `$experiments` описываются активные фичи в формате ключ - параметры
      - ключ - название фичи (тот же самый `featureName`)
      - параметры
        - `selector` - CSS селектор (это класс, который ожидается на `HTML` ноде). Данный селектор дописывается
          ко всем CSS правилам пока эксперимент активен. Когда эксперимент завершился и нужно всегда применять CSS
          правила фичи - используется параметр `always-apply: true` (см ниже) - в этом случае селектор больше не
          дописывается (класса на `HTML` тоже больше не должно быть, это разруливается в `u2709/index.jsx` автоматически
          во время шаблонизации).
        - (опционально) `always-apply: true` "всегда применять стили". Параметр указывается,
          когда эксперимент завершился и стили фичи должна всегда присутствовать.
    - в самих стилях используется набор функций:
      - `has-feature` - проверка наличия включенной фичи
      - `no-feature` - проверка отсутствия фичи
      - `has-feature-at-root` - проверка наличия включенной фичи на уровне рутовой ноды
      - `no-feature-at-root` - проверка отсутствия фичи на уровне рутовой ноды
