# Релиз Большой Почты

## Сборка и выкатка пакета

Сборка в [New CI](https://a.yandex-team.ru/projects/mail_frontend/ci/releases/timeline?dir=yandex360%2Ffrontend&id=liza_release).

1. Выбрать коммит, от которого собираем релиз. В бургере нажать `Create a new branch`
2. Перейти в созданную ветку в левом меню.
3. Нажать `Run release`.
4. В созданный тикет добавить наблюдателем дежурного тестировщика.
5. Когда пакет соберется, он пришлет в тикет отбивку и создаст связи со всеми тикетами, вошедшими в релиз. Надо убедиться, что туда не попали тикеты из прошлого релиза, которые были добавлены в него, как хотфиксы (черри-пикнуты). Если они есть - отвязать
6. Сходить в личку к дежурному тестировщику и уведомить, что стенд собрался
7. Можно дополнительно проверить, что все задачи в статусе `Dev` из очереди `DARIA` попали в пакет и если нет, то выяснить, почему так произошло.
8. Опционально можно вручную проверить, какие тикеты должны попасть в релиз, посмотрев по гиту список мерж-коммитов между релизами. Например так:
    ```bash
    arc log --oneline releases/psfront/liza/v61...releases/psfront/liza/v60 ./
    ```
9. Также стоит каким-то образом узнать, не требуется ли для каких-то задач в релизе выкатка web-api, и позаботиться об этом, если да.
10. После получения ОК от тестировани, нажать ▶️ в релизном флоу, чтобы запустилась выкатка в тестовые/qa окружения.
11. Дождаться завершения выкатки престейблов и попробовать на них зайти, чтобы убедиться, что все в порядке.
12. После престейблов катится корп. После его выкатки следует последить за [графиками](https://wiki.yandex-team.ru/users/avanes/dashbordy/) корпа, чтобы убедиться, что все в порядке, и зайти в корповую Почту для проведения небольшого sanity-теста.
13. После того, как вы убедились, что с корпом все в порядке, можно выкатывать прод. После его выкатки опять же следим за [графиками](https://wiki.yandex-team.ru/users/avanes/dashbordy/).
14. Если с продом все хорошо, то следует обновить сообщение о выкатке, чтобы показать, что она состоялась. Сообщение можно обновлять и по ходу процесса на каждый этап, а можно один раз после всей выкатки
15. Когда пакет уже в проде, в New CI нажать ▶️ на кубике `Commit version`, чтобы версия попала в транк. Также можно отписаться об окончании выкатки в релизный тикет, чтобы тестирование получило отбивку.


## Если в пакете нашли баг
1. Если баг удалось починить, то после того, как фикс будет протестирован, его нужно черри-пикнуть в релиз. В идеале фикс сначала мержится в trunk, а потом мерж-коммит пикается в релиз. Но если коммит один, то можно пикнуть и его. Пик делается в интерфейсе New CI, нужно перейти в релизную ветку и нажать `Cherry pick`, выбрать коммит. После этого можно запустить в ветке новый релиз.
2. Если починить не удалось, то либо создается пулл на отрыв, который потом черри-пикается в релиз по схеме выше. Либо, в условиях особой спешки и если автор бага поклялся починить его в самое ближайшее время, можно сделать реверт только в релизе. Но в этом случае следует проследить за тем, чтобы dev исправили до следующего релиза.


## Если релиз нужно откатить
Вы внимательно следили за графиками и вам кажется, что новый релиз вызвал слишком высокий фон ошибок, либо вам сообщили о каких-то проблемах из-за него коллеги, то возможно, что вы примете решение откатить релиз. Если это так, то вам нужно:
1. Зайти в deploy-окружения [mail_liza_production](https://yd.yandex-team.ru/stages/mail_liza_production) и [mail_liza_corp](https://yd.yandex-team.ru/stages/mail_liza_corp).
2. Перейти на вкладку `History`. ![](https://jing.yandex-team.ru/files/korkota/2022-02-01T13%3A53%3A10Z.png)
2. Выбрать из списка предыдущий корректный релиз и задеплоить его через кнопку `Apply`. Кнопка появляется только по ховеру. ![](https://jing.yandex-team.ru/files/korkota/2022-02-01T13%3A55%3A47Z.png)


## Хотфикс
Если в прод выехала версия 60.1.0 и нужно сделать хотфикс, то:
1. Заходим в New CI в релизную ветку v60, черрипикаем нужные коммиты, запускаем новый релиз.
2. Если нужно выкатить по ускоренной схеме (сборка -> прод), выбрать в выпадашке `universal_hotfix_flow`.
3. Далее по инструкциям выше.

## Про версионирование

Запуск каждого нового релиза апает мажор. Перезапуск в существующей ветке апает минор.
