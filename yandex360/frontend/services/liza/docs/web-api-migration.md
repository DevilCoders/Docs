# Разработка с web-api и mail-internal-api-lib

**Рекомендуется перейти по указанным ссылкам, почитать доки и заглянуть на вики проектов, прежде чем идти дальше:**
 - [web-api](https://github.yandex-team.ru/Daria/web-api)
 - [mail-internal-api](https://github.yandex-team.ru/Daria/mail-internal-api-lib)

## Миграция

Практически все ручки из `liza/server` перешли в проект `web-api`, под версию `liza1`, те что остались в Лизе - используют данные о вёрстке, либо в будущем перестанут существовать.

Практически все модели, сервисы и конфиги сервисов перенесены в `mail-internal-api-lib`, оставлен сервис `cryprox` - он использует данные вёрстки, а так же оставлены модели для индексной страницы и ручки `print`.

Так же в `mail-internal-api-lib` перенесены:

- Доменные конфиги
- Некоторые вспомогательные хелперы
- Миддлвары
- Кастомные компоненты `duffman.Core`


## Разработка

Для того чтобы разрабатываться в деве, используя общую актуальную версию `web-api`:

```sh
npm start
```

Если нужно разрабатывать `web-api`, достаточно запустить в папке `server`

```sh
npm start web-api
```

Эта команда запустит `nodemon` в папке `server` и в папке `web-api`, и будет выводить `output` обоих процессов в консоль.

### Версионирование, конфиг используемых вёрсткой ручек

Ручки, вынесенные в `web-api`, версионируются. В Лизе присутствует специальный конфиг, благодаря которому вёрстка определяет в какую версию той или иной ручки нужно ходить.

**Расположение конфига**: `liza/server/server-configs/web-api-config`.

**Редактирование конфига**:

Изменение урлов ручек нужно производить в файле `liza/server/server-configs/web-api-config/config/web-api.yaml`, после чего необходимо запустить в папке `server` команду

```
make web_api_configs
```

Запуск команды необходим для генерации `json` представления конфига ручек, этот `json` импортируется в итоговый класс конфига. Сгенерированный `json` так же нужно закоммитить.

`ВАЖНО!!!`: Команда не запускается автоматически при сборке. Каждый раз, когда меняется `web-api.yaml`, нужно вручную запускать команду, генерирующую `json`, а сам `json` коммитить. Это сделано для того, чтобы не было неожиданных последствий, когда изменил `web-api.yaml`, забыл запустить команду генерации `json` - на деве всё работает, а на проде нет, так как автоматически запустилась генерация `json`.

На сервере конфиг ручек доступен как `сore.config.api`. На клиенте этот конфиг располагается в `Daria.api`.

### Внесение изменений

Большинство изменений, касающихся кода фронтенд-сервера, теперь будут происходить в `web-api` и `mail-internal-api-lib` и должны предварительно обсуждаться и согласовываться, например на стендапах.


Изменения, которые делаются в репозиториях `web-api` или `mail-internal-api-lib` практически всегда будут выкатываться в прод без тестирования (за счёт версионирования ручек и, в будущем, моделей). **Поэтому, очень важно покрывать тестами любую новую функциональность в этих репозиториях на 100%.**

**Внесение изменений в ручки web-api**:

- Если изменение большое и/или может ломать вёрстку, то нужно заводить новую версию ручки и делать изменения в этой новой версии.
- Если изменения совсем не значительные и не ломают ничего на вёрстке, то допустимо делать фиксы в рамках существующей версии

Подобная схема позволит выкатывать новые версии ручек с большими изменениями без тестирования в прод (выкатывать быстрее), при этом новая версия не будет использоваться в вёрстке пока не поменяется конфиг на вёрстке. Таким образом, можно свободно посмотреть как ведёт себя новая версия ручки в проде и, убедившись, что она работает, подключать её через конфиг ручек в вёрстке, когда нужно.

**Внесение изменений в модели mail-internal-api-lib**:

До тех пор, пока нет версионирования моделей, изменения моделей могут происходить по такой схеме:

- Если изменение большое и/или может ломать вёрстку, то нужно заводить новую модель и делать изменения в ней.
- Если изменения совсем не значительные и не ломают ничего на вёрстке, то допустимо делать фиксы в рамках существующей модели

**Создание ручек**:

- Если ручка не использует данные вёрстки, то скорее всего она должна располагаться в `web-api` иначе её нужно положить в Лизу.

**Создание моделей и сервисов**:

- Если модель или сервис нужны только в ручках, которые располагаются в Лизе, то стоит положить модель или сервис в Лизу
- Если модель или сервис нужны в `web-api`, стоит сразу создавать нужную сущность в `mail-internal-api-lib`
