# Почтовая мультиавторизация

Почтовая мультиавторизация — механизм, позволяющий одному человеку работать под разными
паспортными учётными записями в разных вкладках одного браузера одновременно.

Простейший пример — параллельное использование личной и рабочей учётной записи.
Традиционно, когда в одной вкладке браузера меняют паспортную учётку, в остальных происходит
что повезёт: страница ломается, начинает делать запросы от имени новой учётки (Трекер),
меняет учётку без перезагрузки страницы и объявления войны (Музыка).
Почтовая реализация мультиавторизации позволяет избавиться от этих проблем.

## Что позволяет нам делать так?

Паспортная кука `sessionid` хранит всех залогиненных в данном браузере пользователей,
а также признак, какой из них используется по умолчанию (активен).
Стандартный механизм переключения пользователей — редирект на специальную страницу в Паспорте,
при запросе которой пользователю перезапишут куку, выставив в ней новую дефолтную учётку;
остальные учётки при этом из неё не пропадают и от имени их по-прежнему можно
делать запросы и выписывать на них TVM-ные user ticket-ы.

## Как это делается?

Технически реализация состоит из нескольких пунктов:
- в браузере:
  - фиксация параметра `uid` в URL страницы, чтобы при входе на сервис определять текущего
    активного пользователя (если параметра нет, его стоит дописать, взяв текущего активного);
  - хранение `uid` текущего активного пользователя в памяти браузера и отправка его во
    всех запросах к API;
- на сервере:
  - проверка куки с параметром `multisession` в значении `yes`;
  - передача текущего `uid` со всеми запросами по всему стеку. TVM user ticket
    выписывается на все учётки из куки, и в нём так же, как и в куке, указывается дефолтный юзер,
    нужно, чтобы бекенды умели брать не дефолтного, а переданного отдельным параметром;
  
## Минусы

- такой подход усложняет взаимодействие между вкладками браузера (если в нём есть потребность, скажем,
  для синхронизации данных приложения);
- встраивание не поддерживающих данный механизм сервисов при помощи iframe требует реализации
  на их стороне этого механизма.
- ссылки на другие сервисы Яндекса, не поддерживающие данный механизм, могут открывать
  интерфейс смежного сервиса из-под другой учётки. Например,
  пользователю пришло письмо о появлении на Я.Музыке нового исполнителя,
  но перейдя по ссылке из письма он может открыть Музыку от имени учётки,
  отличной от получившей письмо.
