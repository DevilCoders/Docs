# Клиентское логирование в Календаре

Есть несколько способов, которым мы логируем клиентские события:
- Метрика (список счётчиков [в корневом README](../../../README.md))
- RUM ([desktop](https://stat.yandex-team.ru/Dashboard/User/3y3k0/MailSpeed?tab=1000j&state=6FvaVCiC6MLl#calendar:calendar.desktop),
[touch](https://stat.yandex-team.ru/Dashboard/User/3y3k0/MailSpeed?tab=1000j&state=6FvaVCiC6MLl#calendar:calendar.touch),
[realtime](https://rum.yandex-team.ru/projects/maya/projectDashboard))
- [Error-Booster](https://error.yandex-team.ru/projects/maya/projectDashboard)
- [CSP](https://csp.yandex-team.ru/projects/maya/projectDashboard)
- `/monitoring`
- `duffman-client-log`

## duffman-client-log

Клиентские события для аналитики.

Логируем через фичу `logging` и её [LoggingApi](../../../client/features/logging/LoggingApi.js).
Чтобы начать отправлять события, нужно сделать соответсвующие событию сагу и метод в LoggingApi, вызывать
можно как через экшн, так и завязавшишь на экшн другой фичи.

Существует несколько фиксированных параметров, которые отправляются в лог, остальные будут записаны в `params`.

Доступные фиксированные параметры:
- `actionName` — всегда обязательный параметр, идентификатор логируемого действия (например, `create-event`)
- `eventId` — логировать предполается по большей части действия, так или иначе связанные с событиями, нужно отправлять, если применимо
- `instanceStartTs` — требуется отправлять при действиях с одним повтором события из серии, параметр нужен для однозначной идентификации события, с которым происходит логируемое действие

LoggingApi добавляет при отправке несколько служебных полей:
- `eexp` — список включенных у пользователя экспериментов
- `clientVer` — текущая версия кода клиента
- `isTouch` — тач/десктоп (тач включает в том числе и интеграцию с мобильной почтой)
- `platform` — платформа приложения (`browser`/`ios`/`android`)

На сервере события логирования принимает ручка `/journal`. Помимо фиксированных клиентских параметров,
сервер дописывает ещё `uid` пользователя и `client` (на момент написания этой доки имеющий единственное значение — `MAYA`).

События пишутся в отдельный файл лога — `/var/log/duffman/duffman-client.tskv`.ак и прочие логи,
Как и прочие логи, этот ротируется и поставляется в YT.

## monitoring
Сюда складываются все события об ошибках.
Существует несколько типов ошибок (поле `type`), список может изменяться с течением времени:
- `request` - ошибка сети (5xx сетевой код, флапы сети любого типа у браузера, невозможность распарсить ответ как json)
- `handle`- ошибка похода в ручку. Отличие от предыдущего пункта - сюда дополнительно попадут невалидные с точки зрения нашей реализации json-rpc ответы; в прочих случаях - отправится вместе с `request` после ретраев, в случае, если они были 
- `saga` - ошибка бизнес-логики. Сюда попадают примерно все ошибки ручек, и дополнительно ошибки выполнения клиентского кода, отвечающего за бизнес-логику, а также "валидные" ошибки (скажем, `busy-overlap` или банальное 404 на событие) от бекенда/фронтбека в некоторых случаях 
- `render` - ошибка рендера, означает показ "грустной рожицы" вместо контента
- `bootstrap` - ошибка на этапе инициализации приложения, когда вместо Календаря сплеш-скрин с надписью "пожалуйста, рефрешнись", обычно вызвано статикой
- `uncaught` и `promise` - обычно некритичные, но, в любом случае, никак не обработанные ошибки выполнения клиентского кода, могут вести к непредсказуемым последствиям
- `metrika` - ошибка отправки метрики

### Примеры

Мы не смогли получить событие при открытии страницы события (500 от бекенда):
1. Запрос `req_id_1` завершился неудачно, логируем `type=request&reqid=req_id_1`, ретраим;
2. Запрос `req_id_2` завершился неудачно, логируем `type=request&reqid=req_id_2`, не ретраим больше;
3. Поход в ручку не удался, логируем `type=handle&reqid=req_id_2&name=get-event`;
4. Не удалось выполнить получение данных с точки зрения бизнес-логики, логируем `type=saga&name=events__getEvent`;
5. Не смогли отрендерить страницу события из-за отсутствия данных, рисуем грустную рожицу и логируем `type=render`.

Мы не смогли получить событие при открытии страницы события (404):
1. Поход в ручку не удался, логируем `type=handle&reqid=req_id_1&name=event-not-found&status=404&code=CALENDAR_ERROR`;
2. Не смогли отрендерить страницу события из-за отсутствия данных, рисуем "Событие не найдено".
