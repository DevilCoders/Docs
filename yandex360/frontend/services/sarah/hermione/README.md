### Гермиона и локальный запуск тестов.

[Hermione](https://github.com/gemini-testing/hermione) - утилита интеграционного тестирования веб страниц с помощью WebdriverIO v4 и Mocha.

 
_Основной конфиг_ - services/sarah/.hermione.conf.js

_Снапшоты, константы_ services/sarah/hermione

_Тесты_ services/sarah/client/tests/hermione

Если добавляется новый функционал или поменялась логика, надо бы написать тесты.
Иногда после сборки пул-реквеста тесты падают и надо понять в чем дело.
И проще всего позапускать локально и на своем пул-реквесте. После нахождения проблемы нужно переснять скриншоты и закомитить их.

_Процесс_

После написания теста важно проконсультироваться с тестировщиком и учесть нужные тест-кейсы. Также им нужно вставить в тест нужный id
из testpalm. Они либо сами его добавят в пр с тестами, либо попросят об этом разработчика. Не забывать об этом.

#### Как запускать локально упавший пул-реквест
1 способ

`npm run hermione`

прогонит в фоне и выбросит в терминал результат.

2 способ

`npm run hermione gui`

запустит, открыв браузер http://localhost:8000/

Этот способ предпочтителен для обновления скриншотов. `--update-refs` использовать не рекомендуется.

3 способ

`npm run hermione`

с запущенным локально selenium - чтобы интерактивно видеть, по каким шагам идем и где падаем. Selenium сам все прогоняет.

4 способ

`npm run hermione -f https://proxy.sandbox.yandex-team.ru/1617638720/index.html`

принудительно (передана опция `-f`) запустить отчет, выдаваемый после прогона автотестов на 
нужный пул-реквест (ссылка берется из джобы в sandbox) 

##### Основные проблемы при локальном запуске

`✘ Error: Prepare screenshot failed with error type 'NOTFOUND' and error message: Could not find element with css selector specified in setCaptureElements: .page`
Не нашел основной селектор, проверить реальное наличие класса на необходимой странице.

Проблемы с авторизацией, передается undefined и пр:

Вместо авторизации через сервис tus https://wiki.yandex-team.ru/tus/ можно указать напрямую авторизацию через логин и пароль.
При локальном запуске до авторизации через tus видимо нет доступов.

```
  hermione.auth.login({
    desktop: {
      login: '***',
      password: '***'
    },
    phone: {
      login: '***',
      password: '***'
    }
  });
```         
Credentials юзера, на котором гоняются тесты, можно найти тут https://wiki.yandex-team.ru/users/turbokuzmich/sarah-test-users/

Можно в целом и на своем юзере проверять если он по параметрам идентичен автотестовому.

Если нужно позапускать на упавшем пул реквесте чтобы поменять скриншоты:
Нужно запустить обязательно на дефолтном указанном в конфиге селениуме, иначе локальный селениум сделает не совсем правильные
скриншоты (не того размера и тесты при сборке пула будут падать).

Для тестирования админки также есть «регрессионные» пользователи (https://wiki.yandex-team.ru/pochta/testirovanie/adminka-b2b/polzovateli-regressa/#tablicapolzovatelejj). Они используются асессорами в регрессе. Их использование в автотестах категорически запрещается.


**Как настроить локальный запуск автотестов для лучшей отладки**
Иногда удобно сразу посмотреть что происходит в браузере  при прогоне тестов. Для этого понадобится selenium.

Настройка:
1) поставить selenium-standalone глобально и сделать
`selenium-standalone install`
Запуск `selenium-standalone start`
2) поставить chromedriver и java
   - `brew install java` и он попросит сделать симлинк - сделать его (чтобы java искалась в проекте)
   - `npm install chromedriver` - можно наверно тоже глобально

В конфиге .hermione.conf.js указать
`gridUrl: 'http://127.0.0.1:4444/wd/hub'`
Для тестирования также пригождается указывать `baseUrl` отличные от продных, примеры

`baseUrl: 'https://pr-4413.sarah-qa.dsp.yandex.ru'`
`baseUrl: 'https://ekhurtina1-green-trunk-mono.sarah-dev.mail.yandex.ru'`
