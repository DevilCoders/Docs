# Сборка проекта

### Слой с конфигами (settings)
Sarah живёт на едином почтовом образе, поверх которого разворачивается слой `settings` со специфичной частью файловой системы.

Слой `settings` собирается и публикуется с локальной машинки командой `make ci-settings-publish`.

### Слой с приложением (front-app)
Для сборки пакета используется [Trendbox CI](https://github.yandex-team.ru/search-interfaces/trendbox-ci).
Сборка не происходит локально из-за потребности в секретах для выкладки артефактов сборки в различные окружения.
Артефактов сборки 2:
- **Sandbox-ресурс** с архивом файлов Duffman-приложения, подкладываемых в docker-контейнер, содержит серверный код и информацию о статике;
- **Статические файлы** сборки, раскладываются на `s3`, проксируются для выдачи клиентам через `yastatic.net`, лежат в бакете `sarah`.

Информация о том, какие статические файлы использоватьь для данной конкретной версии выкаченного
на любое из окружений (тестинг/престейбл/прод) хранится в генерируемом в процессе сборки статики
файле `webpack-assets.json` и доставляется в контейнер вместе с sandbox-ресурсом.

## Сборка статики

Дев-сборка:
```shell script
npm run build:dev
```
Прод-сборка:
```shell script
npm run build:prod
```

Также при сборке статики можно анализировать получившиеся бандлы, для этого нужно при сборке указать флаг `USE_BUNDLE_ANALYZER=1`:
раскомментировать в [конфиге webpack](../../webpack.config.js) строку
```shell script
USE_BUNDLE_ANALYZER=1 npm run start

# или
USE_BUNDLE_ANALYZER=1 npm run build:dev

# или
USE_BUNDLE_ANALYZER=1 npm run build:prod
```

## Сборка пакета

Для запуска процесса сборки нужно запушить в репозиторий тег, после чего github запустит при помощи
вебхуков саму джобу в trendbox (конфиг джоб можно посмотреть в корне репозитория, в файле `.trendbox.yml`).

Для упрощения процедуры запуска есть команда `npm run package`. Параметры запуска:

`-v` — Конкретная версия для пакета (публикация выполняется с флагом `--force`).
`-t` — Номер релизного тикета. Если не добавить номер тикета, инкрименируется минорная версия, иначе — патч. Номер тикета записывается в комментарий к тегу и коммиту.
`-f` — Публикация с флагом `--force`.

Все дополнительные параметры необходимо указывать через двойное тире (`--`).

**Примеры**:

Публикация минорной версии:
```shell script
npm run package
```
Публикация патч версии с релизным тикетом:
```shell script
npm run package -- -t "SARAH-123"
```
Публикация конкретной версии:
```shell script
npm run package -- -v "v1.0.0"
```
Публикация конкретной версии с релизным тикетом:
```shell script
npm run package -- -v "v1.0.0" -t "SARAH-123"
```

### Как создать и выкатить релиз

1) Прочитать основные положения о процессах, именовании версий, обязанностях дежурного, создании релиза тут
https://wiki.yandex-team.ru/disk/frontend/

[Создать релизную таску](https://st.yandex-team.ru/createTicket?queue=CHEMODAN&_form=46912)

2) Отвести релизную ветку от dev и собрать пакет с помощью [npm run package](#сборка-пакета)
3) Поставить пакет на [Prestable окружение](https://deploy.yandex-team.ru/stages/sarah_prestable)

   [Подробнее о деплое со скриншотами](deploy.md)

4) Если появились баги в релизе - чиним от дева, потом черипикаем в релизную ветку
5) Перед выкаткой написать в чат `disk-roll` и получить аппрув
6) Выкатить релиз на прод
7) Полученный апрувленный пул с релизом после выкатки мержится в dev

_Если хотфикс_: необходимо ответвиться от последнего продного тега релиза.
Это для того, чтобы в релиз хотфикса не попали уже замерженные задачи из дева.
