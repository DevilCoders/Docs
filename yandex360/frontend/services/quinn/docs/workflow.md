## Green trunk

Все пакеты и сервисы в монорепозитории разрабатываются по методологии "зеленого транка". Фикс багов и разработка фичей делается в отдельных ветках, которые отводятся от основной ветки `dev`. Эти изменения попадают в основную ветку через pull request, в которых запускаются все имеющиеся виды проверок и тестов. Так же на PR автоматически разворачивается стенд `pr-< pr_number >.verstka-qa.mail.yandex.ru/`, где проводится ручное тестирование. Таким образом, каждый коммит в основной ветке `dev` считается стабильным, то есть не содержащим (заметных) багов.

Из основной ветки с некоторой периодичностью собираются и выкатыювается релизы, куда могут попадать задачи из любых витимов (см. [release branch](./workflow.md#git-flow)).

## PR

Все PR делаем в ветку `dev`. На ветке висят обязательные проверки: тесты клиента, сервера, ревью, номер задачи.

### Номер задачи

В заголовке PR автоматически проставляется номер тикета, но для небольших изменений без задач можно указывать префикс TRIVIAL, REFACTOR или HOTFIX (например, «HOTFIX: Ололо»).

Можно указывать несколько номеров через запятую.

## Ревью(шница)

Проект подключен к [ревьюшнице](https://github.yandex-team.ru/devexp/devexp#Поддерживаемые-команды).

tldr: в комментариях к PR пиши `/start`.

## Merge Queue

Для мерджа проект подключен к [MQ](https://github.yandex-team.ru/search-interfaces/microservices/blob/master/services/merge-queue/README.md).

tldr: в комментариях к PR пиши `/merge`.

## Статусы

| Статус     | Описание |
| ---      | ---       |
| **Open** | |
| **In progress** | ставит разработчик, когда взял задачу в работу. |
| **In review** | ставит робот ревьюшницы, когда код и тесты написаны и разработчик стартовал ревью в пулл-реквесте, задача передается на ревью. |
| **Review Completed** | ставит робот, когда ревью пройдено успешно. |
| **Ready for Test** | ставит разработчик, задача готова к тестированию, в тикете есть ссылка на стенд. |
| **Testing** | ставит тестировщик, когда приступил к тестированию. |
| **Tested** | ставит тестировщик, задача протестирована. |
| **Dev** | ставит робот, после команды  `/merge` в пулл-реквесте, задача встала в очередь на вливание в стабильную ветку  `dev`. |
| **RC** | ставит робот, когда задача попала в релиз. |
| **Сlosed** | ставит робот после того, как релиз выехал в продакшн. |

## Git Flow

**Feature branch**: отводится от `dev` и после всех фиксов ребейзится на `dev` и мержится (этим занимается merge queue).

**Release branch**: называется `rc-quinn-1.11`, отводится от `dev`, ставится тег, запускается [сборка](./package.md).

При обнаружении багов в релизе:
1. Заводим задачу, чиним, открываем PR на `dev` по обычному feature-процессу (CI — ревью — MQ).
2. Переносим коммиты с фиксом в релизную ветку через `git cherry-pick QUINN-1111` либо сразу при открытии PR (для микро-фиксов, экономит ~2 часа), либо после мержа в `dev` (если фикс большой и вы сомневаетесь).
3. Пересобираем с увеличением патч-версии `npm run package 1.2.1`.

Релизный тег остаётся в гите навечно — так у нас всегда есть тот самый код, из которого собран релиз.

Когда релиз протестирован:
1. [Выкатываем его](https://platform.yandex-team.ru/projects/mail/webmail)
3. [Следим за ошибками](https://error.yandex-team.ru/projects/quinn/discovery)
4. Что-то взорвалось — переходим к хотфиксу.

Релизную ветку после выкатки мерджим в `dev` через pull-request.

**Hotfix branch**: делаем на базе релизной ветки (через ПР или коммитить прямо туда), пересобираем с увеличением патч-версии (`10.0.3 -> 10.0.4`), тестируем, катим. После успеха мержим коммиты с фиксом в dev по обычному процессу. Мы так, конечно, никогда не делали — если возникнут проблемы или будут идеи получше, предлагайте.
