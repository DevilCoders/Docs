# Конфиги для TVM

## TL;DR
Обновить конфиг из секретов:
```sh
/etc/tvmtool/update.sh
```

Просто перегенерить конфиг и перезапустить сервис:
```sh
sudo service yandex-passport-tvmtool restart
```

## Что тут?
Конфиг `tvmtool.conf` строится из файлов `parts/dist.*.json` и `parts/private.*.json`.

Файлы `parts/dist.{name}.json` создаются из шаблонов в папке `yav-deploy/templates/{name}/`
и секретов из секретницы.

Файлы `parts/private.*.json` можно использовать для дополнения и/или переопределения конфига.

Пример **parts/private.web-api.json**
```json
{
  "web-api": {
    "dsts": {
      "new-backend": { "dst_id": 100500 },
      "meta": { "dst_id": 13 }
    }
  }
}
```
Добавляет новый бекенд `new-backend` и переопределяет `dst_id` бекенда `meta`.

После внесений изменений в `parts/private.*.json` файлы надо перезапустить сервис (см. выше).

Как и в QLOUD сервис определяет переменные окружения `QLOUD_TVM_*`. Если у вас их нет, попробуйте перелогиниться.

## Про шаблоны
Шаблоны разбиты (примерно) по сервисам
  * `calendar` — календарь;
  * `disk` — Диск, публичные ссылки, просмотрщик, заметки, редактор;
  * `mailfront` — почта (тач, лиза, веб-апи и т.п.);
  * `telemost` — телемост;
  * `tuning` — ПочтаПро (aka почта 360, покупки и т.п.).

У каждого сервиса есть свои секреты в секретницы.
Формат секретов
  * ключ `tvm2-{name}`,
  * значение `{id}:{secret}`.

Для секрета с ключём `tvm2-{name}` в секции `{section}` будет искаться шаблон `templates/{section}/{name}.json.j2`.
Если такого нет, то ключ пропускается. Ключи не соответсвующие шаблону игнорируются.
На значения не соответствующих шаблону может случится упячка.

Например для `tvm2-web-api=123:password` в секции `mailfront` будет использован
шаблон `templates/mailfront/web-api.json.j2`.

Все секреты можно найти в Секретнице по тегу [ps-front-tvm](https://yav.yandex-team.ru/?tags=ps-front-tvm).

### Применение изменений
При изменении шаблонов необходимо выполнить `make tvm` из директории `yandex360/tools/qyp`
