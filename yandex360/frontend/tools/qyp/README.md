# dev-playbooks
Ansible playbook для переезда разработки фронтенда почты в QYP.

## Инструкция
:warning: Читаем внимательно, инструкция изменилась.

Завести новую машинку в QYP: https://qyp.yandex-team.ru/create-vm

Обязательные параметры:
  * VM name: набор букв-цифр :bangbang: **без дефисов** :bangbang:;
  * Network Macro: `_MAILFRONTDEVNETS_`;
  * Quotas type: **Personal**;
  * *Минимальные рекомендуемые* ресурсы:
    * CPU guarantee: **4** (можно больше если есть квота);
    * CPU limit: **32**;
    * RAM: **16** (можно больше если есть квота);
  * Disk:
    * Type: **SSD**;
    * Size: **100** (можно больше если есть квота);
    * OS Image: ставим галку **Use custom resource URL** и вписываем в поле `rbtorrent:6119c40185c8b1ffb96734d475a9e26e19790565`
    (ресурс [2582136096](https://sandbox.yandex-team.ru/resource/2582136096));
    * Image Type: **raw**;
  * Disk badwidth: кликаем **Set default values**;
  * Internet Access: **NAT64**;
  * Permissions: рекомендую в Users добавить `lynn` и/или ещё кого-нибудь
    к кому вы будете бежать за помощью в случае проблем.

Жмём кнопку **Create** в правом верхнем углу.

После запуска создания машинки понадобится некоторое время до её полной конфигурации.
Несмотря на то, что статус у машинки будет гореть "Running", она еще может продолжать подниматься.

> :information_source: Если у вас уже была qyp-машинка, вы ее удалили и решили создать ей на замену другую с таким же именем, то не забудьте зайти в `~/.ssh/known_hosts` и удалить строку с именем вашей машины

---

:bulb: Адрес новой машинки написан на странице открывшейся после создания в поле **FQDN**. Он выглядит как `<name>.<dc>.yp-c.yandex.net`, например `myhost.sas.yp-c.yandex.net`.

Когда машинка поднимется нужно зайти на неё по ssh и убедится что все машинка окончательно сконфигурировалась.

1. заходим на машинку
   ```sh
   ssh <myhost>.sas.yp-c.yandex.net
   ```
2. проверяем что работает sudo на новой машинке
   ```sh
   sudo -l
   ```
Если любой из этих пунктов спрашивает пароль, то ждём дальше.

Если всё хорошо, то **там же** выполняем следующие команды:

1. Получаем токен, если еще не работали с арком
   ```sh
   arc token store
   ```

   И монтируем аркадию
   ```sh
   echo "user_allow_other" | sudo tee -a /etc/fuse.conf
   arc mount --allow-other
   ```

2. Переходим в папку
   ```sh
   cd ~/arcadia/yandex360/frontend/tools/qyp
   ```

3. Выбираем какую группу сервисов будем разрабатывать (у вас должны быть доступы к секретам этих сервисов)
   и запускаем плейбук.

   Возможные варианты (можно выбрать несколько):
     * `Calendar` — календарь;
     * `Disk` — диск, просмотрщик документов и т.п.;
     * `Mailfront` — почта (liza, quinn, web-api, sarah, …);
     * `Telemost`— телемост;
     * `Tuning` — ПочтаПро (aka Почта360/покупки).

   например «буду разрабатывать календарь»:
   ```sh
   make Calendar
   ```
   или «буду разрабатывать телемост и покупки»:
   ```sh
   make Telemost Tuning
   ```

после этого **нужно перезагрузить** машинку:
```sh
sudo reboot
```

:tada: Настройка завершена.

> :information_source: Если вам нужно начать разрабатывать сервисы которые вы изначально не выбирали
> (например, вы начинали разработку только с телемоста, а теперь понадобилось разрабатывать и диск),
> то можно повторить последних шаг.
> ```sh
> make Disk # подставьте нужную группу
> ```

## Обновления
Для обновления всего плейбука можно запустить команду `make` без параметров.
Она заново проиграет весь плейбук для сервиса (сервисов) выбранного на этапе настройки.

Некоторые роли можно обновлять отдельно, без перезапуска всего плейбука.
Это роли `resources`, `chromium`, `git`, `nginx`, `tvm` и `xscript`.
Обновляются они командой `make ROLE [ROLE...]`, например `make resources` или `make tvm nginx`.

## Обновления с предыдущих версий базового образа
Выполнить команду `make upgrade`. Она доставит пакеты и изменения которые вошли в новый базовый образ.

## Глобальный TVM
На машинку ставится пакет `yandex-passport-tvmtool` и запускается глобальный демон.
Из коробки должен работать для liza, web-api и homer. Если надо что-то поменять
или добавить действуйте по [инструкции](roles/tvm/files/tvmtool).

## :whale: Docker
На машинку можно поставить докер командой `make docker`.
Она поставит пакет `docker.io` и `docker-compose`, добавит пользователя в группу `docker` и настроит ip6table
что был контейнеры могли выходить в сеть.
Чтобы докер заработал без `sudo`, нужно перелогиниться.

## FAQ
[переехал](./FAQ.md)
