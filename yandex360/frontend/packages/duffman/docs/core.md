# Ядро

[[src](../lib/core/index.js)]

**Ядро** (core) - это объект, время жизни которого ограничено сессией запроса клиента к серверу. Другими словами это контекст сессии.

---
### `auth`
Контейнер для работы с объектом авторизации.

[[src](../lib/core/auth.js)]

Авторизацию внутри моделей и сервисов всегда нужно получать через `core.auth.get()`.

Запись авторизации происходит в момент входа в роутер через `core.auth.set(auth)`.
Откуда берётся объект `auth` duffman никак не определяет. Единственное требование, наличие поля `uid`.

---
### `ckey`
Отвечает за валидацию и обновление [CSRF токена](https://wiki.yandex-team.ru/security/for/web-developers/csrf/#csrf-token).

[[src](../lib/core/ckey.js)]

Токен должен быть передан в теле запроса как параметр `_ckey`.

Основные методы
- `isValid` - проверяет токен. Если вызывается впервые для сессии, то сначала парсит токен.
- `renew` - генерирует новый токен.

Сам токен хранится в поле `core.ckey.ckey`.

Стандартный алгоритм разбора и генерации токена может не подойти для работы в других сервисах.

---
### `got(url, options)`
Основной метод для низкоуровнегого обращения к бекэндам. Стоит использовать только внутри [сервисов](./service.md).

[[src](../lib/core/got.js)]

По сути это обёрка на [got](https://www.npmjs.com/package/got).
Умеет делать перезапросы при таймауте к серверу или если сервер недоступен.

Логирует результат выполнения http-запроса. Дополнительные параметры для логирования получает из [core.httpCommonArgs](#httpcommonargsoptions).

В качестве опций принимает следующие параметры:
- `json` — default: **false** — ожидаем ответ от бекенда в виде JSON
- `query`, `body`, `headers` — параметры запроса
- `allowEmpty` — default: **false** — разрешать пустой ответ от сервера
- `allowError` — default: **false** — разрешать содержание в ответе от сервера поля `error`
- `allowPlain` — default: **false** — не пытаться парсить ответ от сервера
- `getRaw` — default: **false** — не обрабатывать ответ от `got`
- `getHeaders` — default: **false** — получить в качестве ответа только заголовки ответа
- `retryOnTimeout` — default: **0** — количество перезапросов, если сервер не отвечает по таймауту. После каждого перезапроса таймаут увеличивается вдвое. Будьте внимательны — при большом количестве перезапросов эта логика начнет конфликтовать с глобальным таймаутом обработки сессии, который равен 30 секундам.
- `retryOnUnavailable` — default: **1** — количество перезапросов, если сервер недоступен
- `timeout` — таймаут запроса к серверу
- `dontParseError` — default: **false** — не логировать ошибку парсинга ответа
- `dontHttpError` — default: **false** — может принимать значения `true, false, Number[]`. Не логировать HTTP ответы пришедшие с плохим кодом. Можно указать какие именно коды не нужно логировать.
- `logQueryParams` — default: `query` — что из `query` логировать в http лог
- `retryPolicy` — default: **null** — включить бюджет ретраев для хоста (`retryPolicy: { statsPeriod: 10, budget: 0.2 }` — считаем за последние **10** секунд, сколько было ретраев, и если их доля становится больше **20%**, перестаем ретраить)

.
- `retryDelay` — default: **0** — максимальная задержка между ретраями.
- прочие параметры `got`…

---
### `request(models)`
Основной метод для высокоуровнегого обращения к бекэндам. Можно использовать в [моделях](./model.md), для запроса других моделей.

[[src](../lib/core/request.js)]

В первую очередь запрашивает модели помеченные как синхронные (изменяющие данные). Имеет ограничение на количество запросов инициированных клиентом. Не позволяет клиенту запросить больше 15 моделей за одну сессию. Это не ограничивает запросы инициированные сервером.

Кеширует результат ответа по ключу, что позволяет безболезненно запрашивать одну и ту же модель в рамках одной сессии, не боясь что мы сделаем двойной поход на бекэнд.

Поддерживает несколько сигнатур вызова:
- `core.request(String name, Object params)` - возвращает результат запроса модели
- `core.request({name: String name, params: Object params})` - возвращает результат запроса модели
- `core.request([{name: String name, params: Object params}, ...])` - возвращает массив с запрошенными моделями.

---
### `service(name)`
Обертка над кешем определенных в ядре сервисов, которая кидает осмысленное исключение для несуществующего сервиса.

Возвращает функцию повторяющую по сигнатуре сервис, но без первого параметра `core`.

---
### `getServiceOptions(serviceName)`
Возвращает функцию котоая по имени метода возвращает объект с дефолтными опциями для этого метода.

---
### `console[method](reason, data)`
[[src](../lib/core/console.js)]

Общий способ логирования всего происходящего внутри сессии. Является потомком [AbstractLogger](./abstract-logger.md).
Для определения дополнительных параметров, которые нужно залогировать вызывает [core.logCommonArgs](#logcommonargsoptions).

---
### `timing`
Используется для профилирования сессии.

[[src](../lib/core/timing.js)]

##### timing.start(name)
Создает объект тайминга, записывает в него начальное время, возвращает [TimeInterval](#timingtimeinterval).

##### timing.stop([name])
Записывает в указанный тайминг конечное время, возвращает [TimeInterval](#timingtimeinterval).
Если имя не указано, останавливает все запущенные тайминги, не возвращает ничего.

##### timing.TimeInterval
Временной интервал с методами `start`, `stop` и кучей вспомогательных методов для преобразования этого интервала.

---
### `hideParamInLog(params, model, parameter, [placeholder])`
Скрывает или заменяет на `placeholder` указанный `parameter` в логировании параметров модели и всех параметров сессии.

---
### `logCommonArgs(options)`
Используется внутри `core.console` для определения дополнительных параметров логирования.
Необходимо переопределить этот метод после создания контекста в роутере.

---
### `httpCommonArgs(options)`
Используется внутри `core.got` для определения дополнительных параметров http запроса.
Необходимо переопределить этот метод после создания контекста в роутере.


## Свойства

### `req`, `res`
Соответствующие объекты из `express`.

`req` является `protected` свойством, все данные которые нужны из `req` должны быть доступны
напрямую из `core`. Например, `core.ip`, `core.cookies` и т.п.

---
### `ip`, `hostname`, `requestId`, `cookies`
Значения соответствующих полей объекта `req`.

---
### `headers`
Отфильтрованный список заголовков из `req.headers`.

---
### `models`, `services`
Модели и сервисы, которые используются в данном приложении.

---
### `config`
Дополнительные настройки приложения.
В `config.services` можно задавать переопределения настроек сервисов (`url`, `tvm` и т.п.)

### Статические свойства `models`, `services`, `config`
В 99.99% случаев набор моделей и сервисов не зависит от запроса. В таком случае их можно задать
как статические свойства класса.
```typescript
const models = { ... };
const services = { ... };
const config = {
    services: { ... },
    custom: { ... }
}

class MyCore extends Core {
    static models = models;
    static services = services;
    static config = config;
}
```
