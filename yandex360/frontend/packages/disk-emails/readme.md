# Шаблоны писем для MPFS

Используются MPFS для отправки писем пользователям Я.Диска.

## Preview

[Список всех писем на всех языках](https://github.yandex-team.ru/pages/UFO/disk-emails/)

Послать себе письмо можно с помощью Safari и Mail.app.
Для этого надо
-  открыть любую страницу из списка;
-  нажать `command+a`, затем `command+c`;
-  создать в Mail.app новое пустое письмо;
-  поставив курсор в тело письма, нажать `command+v`
-  нажать «Отправить» ;)

Если картинки не нужны, то можно просто нажать `command+i`,
будет сформировано письмо без включения в него картинок.

## Тестирование

#### Сервис для проверки отображения в разных почтовых приложениях
Для тестирования писем в разных почтовых приложениях можно отослать письмо
в специальный сервис [Email on Acid](https://www.emailonacid.com).
Для этого надо отправить рассылку
на адрес [yaperformancem.runme@previews.emailonacid.com](mailto:yaperformancem.runme@previews.emailonacid.com)
и зайти на [emailonacid.com](https://www.emailonacid.com/login)
под пользователем yaperformancem / u1Vth283YK.
В сервисе показывается как письмо будет выглядеть на разных платформах и в разных почтовых клиентах.

#### Тестирование готовых собранных пакетов писем
Согласно [инструкции тестирования](https://wiki.yandex-team.ru/Testirovanie/FuncTesting/Communication/Disk/testirovanie-pisem/)

## Работа с шаблонами

### Архитектура

Все шаблоны лежат в каталоге `templates/`.

`base/` — каталог с базовыми шаблонами для html и plaintext -писем, внутри:
-   файл `base` содержит переменные общие для всех писем, **не локализуется**;
-   `base-plain` — основной шаблон plaintext-писем;
-   `base-html` — основной шаблон html-писем.

Все остальные каталоги — это письма, их названия — имена писем.

Каждое письмо состоит из файлов:
-   `subject` содержит строку с темой письма;
-   `from` — строка с именем отправителя;
-   `plain` — шаблон plaintext-письма;
-   `html` — шаблон html-письма;
-   `social` — шаблон сообщения для социальных сетей (опциональный).

### Локализация
Локализуются только файлы с именами `base-*`, `subject`, `from`, `plain`, `html` и `social`.

Имена переменных начинаются с `&i18n_` и заканчиваются на `;`,
т.е. переменная `Emails_Footer_text` в Танкере в **шаблоне** будет иметь вид:

    &i18n_Emails_Footer_text;

### Сборка
Чтобы локализовать шаблоны, в корне репозитория надо выполнить

    npm i
    make

или

    make fast

(во втором случае `make` запускается с параметром `-j 32`)

В результате рядом с файлами шаблонов будут созданы локализованные шаблоны с именами вида:

    <tpl_name>.<ln>

### Компиляция html-страниц
Чтобы посмотреть как будет выглядеть html-письмо, выполните команду

    make pages

В результате рядом с файлами `html.<ln>` будут созданы страницы `html.<ln>.html`,
использующие переменные (рыбу) из `tools/page-vars.inc.mk`:

```make
define PAGE_VARS
hash='iAmDebugHashDoNotTouchMe!'
username='Иван Фёдорович'
login='ifed'
freespace='256 МБ'
usedspace='5.8 ГБ'
filename='0_16a_aa92057c_L.gif'
filesize='226 КБ'
fileurl='http://clck.ru/0zZft'
static='/pages/UFO/disk-emails/images/'
limitlower10=true
currentYear=2018
endef
```
`make pages` пересобирает только те страницы, шаблоны которых были изменены.

Но если всё равно хочется пересобрать часть шаблонов, выполните `make pages` с параметром TPL

    make pages TPL="welcome referral/offer"

В кавычках через пробел перечисляются каталоги шаблонов.

### Проверка длины шаблонов
При отправке писем почтовый сервер может обрезать строки в письмах до 1000 символов, это может приводить к ошибкам в верстке.
Для проверки, что в скомпилированных шаблонах нет таких строк, выполните
```
node tools/findLongLinesInFiles.js
```

## Порядок релизов

### Нумерация

Номер версии пакета состоит из 3-х цифр `XXX.YYY.ZZZ`:
-   XXX — новый дизайн
-   YYY — добавление/изменение шаблонов писем
-   ZZZ — обновление локализаций

Также можно собирать релизы с `-NNN` в конце версии (`XXX.YYY.ZZZ-NNN`),
в этом случае картинки будут браться из версии `XXX.YYY.ZZZ`, но шаблоны обновятся.

### Выкатка

**Перед релизом все изменения в репозитории должны быть закоммичены.**

В корне репозитория `disk-emails` надо выполнить комнаду

    dch -i

Внести список изменений, поменять версию, если номер по порядку не подходит.
Закоммитить изменения `debian/changelog`.

Потом выполнить

    make deb

а затем

    debrelease

После этого можно ставить таски на выкатку статики на yastatic.net
и шаблонов на машинку с MPFS.

Статика выкатывается через [Кондуктор](http://c.yandex-team.ru/tickets/new?ticket[packages][0]=verstka-disk-emails-static&ticket[branch]=stable):
ветка **stable**, пакет **verstka-disk-emails-static**.

Шаблоны (пакет **verstka_disk-emails**) можно раскатить,
изменив версию зависимости в пакете MPFS, или вручную (через тестировщиков).


### Выкатка в production

Когда пакет писем будет протестирован, надо:
- убедиться что статика (`verstka-disk-emails-static` в кондукторе) выкачена в `stable`
- апнуть в [yandex-disk-docker-images](https://github.yandex-team.ru/yadisk-admin/yandex-disk-docker-images) для `disk-mworker` и `disk-pworker` версию пакета `verstka-disk-emails` до нужной: ([link](https://github.yandex-team.ru/yadisk-admin/yandex-disk-docker-images/search?utf8=✓&q=verstka-disk-emails))
- через кондуктор раскатить пакет `verstka-disk-emails` в `stable`. На самом деле это не является обязательным для раскатки писем, но у админов стоит мониторинг что версия писем в MPFS совпадает с версией в `stable` в кондукторе


## ToDo

1.  Рассмотреть возможность локализации средствами Jinja2.
2.  Отказаться от отдельного пакета статики в пользу аттачей.

## Прочее

[Страница с чеклистом](http://www.campaignmonitor.com/css/) css-свойств поддерживаемых в современных почтовых клиентах.

Про счётчики:
-   [Установка счётчиков](https://doc.yandex-team.ru/Stat/ManagerGuide/tasks/HowToInstallCounter.xml)
-   [Clickdaemon](http://wiki.yandex-team.ru/Clickdaemon)
