Архитектура расчета 1.0
=======================

В такой архитектуре мы жили с самого начала (2013), когда все только
начиналось и надо было "быстро и сразу", да и сами расчеты были сильно
проще.

Начиная с 2018 года начали переписывать на python (см. [arch-py](arch-py.md) )

Запуск расчета
--------------

В метабазе необходимо выполнить следующий plsql-блок:

```sql
begin
    bo.pk_comm.calc()
end;
```

В результате будут обновлены следующие MV, на основе которых строится
большиство расчетов:

- BO.MV_COMM_2013_BASE_SRC
- BO.MV_OPT_2015_INVOICES
- BO.MV_OEBS_RECEIPTS
- BO.V_OPT_2015_ACTS

Далее, последовательно, запускаются расчета по шкалам (в скобках указан
код, который используется для данной шкалы в расчете):

- базовые (`base`)
- профы (`prof`)
- справочник (`sprav`)
- спецпроекты (`spec`)
- авто.ру (`autoru`)
- нерезиденты (`nerez`)
- имхо (`imho`)
- аудио (`audio`)
- недвижимость (`estate`)
- офд (`ofd`)
- беларусь (`belarus`)
- частные сделки (`pd`)
- казахстан (`kazakh`)

Список шкал можно посмотреть в БД:

```sql
select id, code, value
  from bo.t_enums_tree
 where parent_id = 3000
 order by id;
```


Используемые представления
--------------------------

Вся логика расчета находится в oracle представлениях (views). При
выполнении метода `pk_comm.calc` выбираются данные из представлений
вида:

`bo.v_opt_<символьный-код-шкалы>_src`

То есть, например, для базовых будет использовано представление:

`bo.v_opt_base_src`


Используемые таблицы
--------------------

Чтобы зафиксировать результат, премии складываются в таблица, так же
имеющие код шкалы в своём названии:

`bo.t_comm_<код-шкалы>_src`

То есть, весь расчет выглядит, условно, для каждой шкалы следующим
образом:

```sql
insert
  into bo.t_comm_<код-шкалы>_src(список-колонок)
select (список-колонок)
  from bo.v_opt_<код-шкалы>_src;
```

Передача в OEBS
---------------

В OEBS данные отдаются из отдельных представлений, так как:

- надо показывать только последний расчет за период
- не показывать строчки с 0-ыми премиями

