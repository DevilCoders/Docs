## Архитектура расчета 3.0

Новый подход к расчёту. Основные цели:

- предоставление возможности писать свои расчеты для премий заказчикам
- использование YT/YQL как более маштабируемого средства


### Основные изменения

- SQS очередь & celery более не используются
- добавляются новые компоненты:
    - YT, как хранилище
    - YQL, как язык описание расчетов над данными в YT
    - Bunker, как средство конфигурирования

Основные структуры в БД пока остаются без изменений.

### Задачи

Исходная задача:
  - https://st.yandex-team.ru/BALANCE-30353
  
Пробный расчет:
  - https://st.yandex-team.ru/BALANCE-30759

### Как всё устроено

В [bunker](bunker.yandex-team.ru) добавили проект для расчета премий:
  - https://bunker.yandex-team.ru/agency-rewards
    
В корне лежат 2 или более ноды:

  - `/schemas` - мето, где описаны схемы для валидации вводимой информации
  - `/dev`, `/test`, `/prod` - конфигурация конкретного окружения
  
В поднодах `/(dev|test|prod)/calc/*` располагаются описания расчетов.

### Что такое бункер?

https://wiki.yandex-team.ru/verstka/tools/bunker/

Это система управления конфигами. Важные для нас концепции:

- все изменения сохраняются
- есть понятие "публикации". Только после "публикации" конфиг используется в расчете
- есть интеграция с IDM. То есть, можно дать доступ к подузлу для конкретного человека

#### Схемы

Нужны для валидации вводимой информации, а так же для того, чтобы бункер смог
сгенерировать UI для ввод информации.

Пример описания расчета:

- https://bunker.yandex-team.ru/agency-rewards/schemas/reward_calc?view=raw

#### Расчет

Пример в "сыром" виде:

- https://bunker.yandex-team.ru/agency-rewards/dev/calc/direct/prof_direct_by_domains?view=raw

Тот же расчет в "человеческом" виде:

- https://bunker.yandex-team.ru/agency-rewards/dev/calc/direct/prof_direct_by_domains

#### Иерархия папок

##### Регрессия

В `/dev` есть директория `/dev/regression`. Она сделана для целей регрессионного тестирования.

#### Расчеты

Все расчеты должны быть в узлах `/<env>/calc/<что-угодно>/<описание-расчет>`.
Подузел `<что-угодно>` добавлен для группировки. Чтобы можно было выдать человеку
права на этот узел, и он может создавать там сколько угодно своих расчетов.

В расчете учитывается последняя опубликованная версия.

### Формат описания расчета

Описание схемы:

- https://bunker.yandex-team.ru/agency-rewards/schemas/reward_calc?view=raw

Пример:

- https://bunker.yandex-team.ru/agency-rewards/dev/calc/direct/prof_direct_by_domains?view=raw

Технические особенности:

- все действия, описанные в расчете, выполняются только на одном YT-кластере,
  который указан в описании расчета
- в расчете может использоваться понятие `переменная`. Это строка, описанная в
  блоке `env` расчета, имеющая имя и значение. Её можно использовать в тексте
  запроса в виде `{имя-переменной}`.
- пред-определенные переменные:
    - `env`: тип среды. Значения: `dev|test|prod`
    - `calc_name`: имя узла (без полного пути), в котором описан расчет
    - `calc_dt`: рассчитываемый период в формате `YYYYMM`
    - `calc_dt_long`: рассчитываемый период в формате `YYYY-MM-DD`
    - `calc_prev_dt`: период, предшествующий расчитываемому периоду, в формате `YYYYMM`
    - `current_year_start_dt`: начало текущего отчетного периода. Зависит от календаря,
      указанного в расчете. Конвертируется в UTC тайм зону. Формат: `2019-02-28T21:00:00Z`

##### Пример:
Расчет полугодовой премии. Рассчет ведется по фин. календарю.
То есть, периоды рассчета будут:
- 2020-03 -- 2020-08, запускаться будет в 2020-09 
`calc_dt` = "202003" и `end_dt` = "202008"
- 2020-09 -- 2021-02, запускаться будет в 2021-03
Полугодовые рассчеты запускаются только 2 раза в год.

Основные понятия:
- `дата запуска`: дата, когда запустили расчет. Обычно - текущая дата (`sysdate`)
- `рассчитываемый период, отчетный период`: месяц, квартал, полугодие, за которые
  считается премия. Обычно это только что закончившийся месяц, квартал.
- `финансовый календарный год`: начинается с 01.03 каждого года.

Основные поля:

- `login`: автор расчета
- `email`: рассылка, куда будут приходить сообщения о расчете
- `status`: статус расчета. Варианты:
    - `draft`: черновик. С таким статусом расчет не будет запускаться
    - `enabled`: включен. Расчет будет запущен
- `title`: короткое описание расчета
- `pre_actions`: действия, которые необходимо сделать перед расчетом. Список.
    - `order`: порядок запуск. Чем меньше число, тем раньше выполнится
    - `title`: короткое описание действия
    - `type`: тип действия, пока поддерживается 2 значения:
        - `yql`: запуск yql запроса
        - `db_to_yt`: выгрузка из БД Баланса в YT
    - `query`: текст запроса (можно использовать переменные)
    - `path`: путь в YT (актуально для `db_to_yt`, можно использовать переменные)
    - `columns`: описание колонок с типами (актуально для `db_to_yt`)
- `query`: текст расчета в виде YQL (можно использовать переменные)
- `path`: путь в YTкуда будет сохранен результат расчета (можно использовать переменные)
- `cluster`: YT-кластер, на котором будет выполняться расчет
- `scale`: Шкала. Только для договоров с этой шкалой будет применен расчет
- `comm_type`: Тип комиссии
- `from_dt`: Дата, с которой расчет будет запущен. Имеется в виду рассчитываемый период, а не дата запуска.
- `till_dt`: Дата, когда расчет будет запущен последний раз
- `freq`: Периодичность расчетов:
    - каждый месяц
    - каждый квартал
    - каждое полугодие
- `calendar`: Тип календаря
- `env`: Переменные окружения в формате ключ-значение

Обычно в `path` указывается переменная из `env` - `{agency_rewards}`, которая обычно имеет вид `//home/balance/{env}/yb-ar/rewards/{calc_name}/{calc_dt}`.
Рекомендуется всё результаты расчета (даже промежуточные) складывать в `//home/balance/{env}/yb-ar/rewards/{calc_name}`.
Это делается по двум причинам:
- чтобы все данные по одному расчету хранились в одном месте
- у нас в каждом месте выполняются регламентные тестовые прогоны, чтобы убедиться что перед следующим закрытием ничего не сломалось.
И если что-то будет хранить не в `yb-ar/rewards`, то оно может быть перезаписано результатами тестового прогона.