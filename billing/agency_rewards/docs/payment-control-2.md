Контроль оборотов
=================

Для большинства ежемесячных расчетов, премия отдаётся к выплате агентству только
после того, как мы убедились, что все оказанные агентством услуги были оплачены.

Актуально только для постоплатных счетов, т.к. только по ним есть риски неоплаты
оказанных услуг.

Ниже описана вторая версия алгоритма, которая работает с 2019-03-01.
[Версия 1](payment-control-1.md) работала до 2019-03-01.


Термины
-------

- к начислению (`reward_to_charge` в БД) - сумма премии, рассчитанная от актов
  (услуги, оказанные Яндексом агентству)
- к перечислению (`reward_to_pay` в БД) - сумма премии, расчитанная от оплаченных
  услуг (сумма денег, оплаченная агенством Яндексу за оказанные услуги)

Алгоритм
--------

Алгоритм применяется только к сумме актов (оказанные услуги). После того, как
все постоплатные счета за период будут оплачены, сумма, расчитанная от актов,
отдаётся к оплате.

После того, как рассчитано `reward_to_charge`, проверяются оплаты, пришедшие в
текущем периоде. Если находятся периоды, для которых оплаты текущего месяца
покрывают все постоплатные счета, то берется `reward_to_charge` из того периода
и суммируется к `reward_to_pay` текущего периода. А так же в `t_ar_paid_periods`
добавляется запись, где:

- `paid_dt` - текущий отчетный период
- `from_dt` - период, полностью покрытый оплатами в текущем отчетном периоде

Если в текущем отчетном периоде выставлены акты только по предоплатным счетам,
что сразу дублируем `reward_to_charge` в `reward_to_pay` текущего периода.

`reward_to_pay_src` более не используется.


Изменения по отношению к версии 1
---------------------------------

- считаем только 1 раз от актов. не надо пересчитывать от оплат
- не надо контролировать суммы "к начислению"/"к перечислению" за всю историю
  договора
- нет необходимости писать контроль оплат для каждого нового расчета от актов.
  Логика работы расчет универсальна и работает одинаково для любого расчета.


Технические детали
==================

В таблице каждой шкалы (`t_comm_base_src`, `t_comm_prof_src`, ...) есть
следующие поля:

- `turnover_to_charge` - сумма услуг, оказанных за период (сумма актов)
- `reward_to_charge` - премия от услуг
- `turnover_to_pay` - сумма оплат, пришедших за период
- `reward_to_pay` - премия от оплат после контроля оборота
- `reward_to_pay_src` - не используется

В таблице `t_ar_paid_periods` фиксируется факт выплат. Значение колонок:

- `contract_id` - договор
- `discount_type` - тип коммисии
- `from_dt` - период, за который отдали `reward_to_charge` к выплате
- `paid_dt` - период, в котором сделали выплату

