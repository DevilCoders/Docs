Контроль оборотов
=================

Для большинства ежемесячных расчетов, премия отдаётся к выплате агентству только
после того, как мы убедились, что все оказанные агентством услуги были оплачены.

Актуально только для постоплатных счетов, т.к. только по ним есть риски неоплаты
оказанных услуг.

Ниже описана первая версия алгоритма, которая работала до 2019-03-01.

Термины
-------

- к начислению (`reward_to_charge` в БД) - сумма премии, рассчитанная от актов
  (услуги, оказанные Яндексом агентству)
- к перечислению (`reward_to_pay` в БД) - сумма премии, расчитанная от оплаченных
  услуг (сумма денег, оплаченная агенством Яндексу за оказанные услуги)

Алгоритм
--------

Один и тот же алгоритм применяется к сумме актов (услуг) и сумме оплат.
После расчета выполняется проверка, что:

- За всю историю договора сумма "к начислению" должна быть больше или равна
  суммы "к перечислению"

Если "к пречислению" за всю историю договора становится больше, чем
"к начислению", то сумма превышения "переносится" на следующий месяц.

Если за какой-то период не было оплат, то премия не выплачивается до тех пор,
пока не поступит оплата.

То есть, мы не должны выплачивать премий больше, чем посчитали премий от актов.


Недостатки
----------

- Если был штраф по актам за какой-то месяц, то деньги за этот период могут
  покрыть другой период по актам. И может случиться кратковременная переплата

- Не работает для случаев, если есть шкала с нулевым шагом. Например
  [Маркет, Мск/Спб](https://wiki.yandex-team.ru/Balance/TZ/opt2018/#marketmsk),
  где есть следующие условия:
  
  - до 200к оборота, премия = 0%
  - 200к - 300к оборота, премия = 8.25% от суммы свыше 200к
  - 300к - ...

  Не работает, т.к. платежи могут приходить когда угодно и величина их может
  различаться. А для корректного расчета по данной шкале необходимо дождаться
  полной оплаты периода, чтобы понять в какую вилку шкалы мы попадаем.

- Сложность сопровождения, т.к. оплаты могут приходить хаотично и не всегда
  очевидно, какими оплатами какой период покрывается.

- Для каждого нового расчета необходимо писать не только расчет премии от
  актов, но и расчет от оплат + логику контроля оборотов.

  
Технические детали
==================

В таблице каждой шкалы (`t_comm_base_src`, `t_comm_prof_src`, ...) есть
следующие поля:

- `turnover_to_charge` - сумма услуг, оказанных за период (сумма актов)
- `reward_to_charge` - премия от услуг
- `turnover_to_pay` - сумма оплат, пришедших за период
- `reward_to_pay` - премия от оплат после контроля оборота
- `reward_to_pay_src` - премия от оплат (чистая, до контроля оборотов)

