# Проектные дашборды
При обновлении списка или содержания манифестов и коммита в trunk запускается CI flow, в котором будут обновлены дашборды сервисов, подключенных к Новому Биллингу. 

## Где смотреть? 
В двух местах: в [Grafana](https://grafana.yandex-team.ru/dashboards/f/jgUN2QJnk/billing-dashboards) и [Monitoring](https://monitoring.yandex-team.ru/projects/newbilling-tarification/dashboards). 

Между обоими сервисами сохраняется почти полная эквивалентность, так что выбор остаётся за пользователем.

## Входные параметры
`--template`: **Файл шаблона** содержит описание расположения графиков на дашбордах и их содержимого (см. ниже). Находится [здесь](https://a.yandex-team.ru/arc_vcs/billing/hot/manificenta/dashboard_templates).

## Как поменять список и содержание графиков?
Описание шаблона находится в [Аркадии](https://a.yandex-team.ru/arc/trunk/arcadia/billing/hot/manificenta/dashboard_templates/common.yml). После коммита в этот файл все дашборды сервисов обновятся автоматически. 

## Описание шаблона
|      Поле      |           Тип          |                                                     Комментарий                                                     |
|:--------------:|:----------------------:|:-------------------------------------------------------------------------------------------------------------------:|
|     `uid`      | `string`               | `[Grafana only]` Символьный идентификатор дашборда.                                                                   |
|     `title`    | `string`               | Имя дашборда.                                                                                                       |
| `description`  | `string`               | Описание дашборда.                                                                                                  |
|  `parameters`  | `map[string]Parameter` | Список параметров дашборда (например, окружение). В данный момент свободное добавление новых параметров недоступно. |
|    `panels`    | `[]Panel`              | Список панелей на дашборде.                                                                                         |
### Тип `Parameter`
| Поле       | Тип         | Комментарий                                                                        |
|:------------:|:-------------:|:------------------------------------------------------------------------------------:|
| `title`    | `string`    | Заголовок параметра.                                                               |
| `values`   | `[]string`  | Множество значений параметра.                                                      |
| `default`  | `string`    | Значение параметра по умолчанию. Должно принадлежать множеству значений  `values`. |

### Тип `Panel`
|      Поле     |      Тип      |                                                                                                                     Комментарий                                                                                                                    |
|:-------------:|:-------------:|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|
|    `title`    |   `string`    |                                                                                                                  Заголовок панели.                                                                                                                 |
| `description` |   `string`    |                                                                                                                  Описание панели.                                                                                                                  |
|   `layout`    | `PanelLayout` |                                                                                                  Поле, описывающее расположение и размеры панели.                                                                                                  |
|    `type`     |   `string`    | Тип графиков на панели. Возможные значения: Grafana: `line`, `bars`, `points`. Monitoring: `line`, `area`, `column`, `points`, `pie`, `bars`, `distribution`, `heatmap` (некоторые из типов могут быть ещё не поддержаны на стороне MonitoringUI). |
|    `units`    |   `string`    |                                                                                                             Единицы измерения графика.                                                                                                             |
|   `targets`   |   `[]Target`  |                                                                                                Список запросов, описывающих графики на одной панели.                                                                                               |

### Тип `PanelLayout`
| Поле |   Тип  |      Комментарий     |
|:----:|:------:|:--------------------:|
| `x`  | `int`  | X координата панели. |
| `y`  |  `int` | Y координата панели. |
| `w`  | `int`  |    Ширина панели.    |
| `h`  | `int`  |    Высота панели.    |

### Тип `Target`
|   Поле   |    Тип    |                                                                          Комментарий                                                                          |
|:--------:|:---------:|:-------------------------------------------------------------------------------------------------------------------------------------------------------------:|
| `query`  | `string`  |                                                                       Запрос в Solomon.                                                                       |
|  `type`  | `string`  |                              `[Monitoring only]` Тип отдельного графика на панели. Не влияет на остальные графики.                             |
|  `loop`  | `string`  | Идентификатор  поля, на каждое значение которого будет создано по одному графику на этой панели. Подробнее ниже. |

## Контексты
В некоторых полях (список ниже) можно использовать контексты - структуры, в которых лежат названия сервисов и их параметры.
Пример: 
```yaml
  ...
  description: "Dashboard of service {{ .Context.Name }}."
  ...
```

### Основной контекст (`.Context`)
В этом контексте описаны параметры-строки. Их список:

|        Параметр        |                                                                  Описание                                                                  |
|:----------------------:|:------------------------------------------------------------------------------------------------------------------------------------------:|
|     `.Context.Name`    |                                                              Название сервиса.                                                             |
| `.Context.Environment` |                            Окружение, которое берется из параметра дашборда. Принимает значения `test` и `prod`.                           |
|  `.Context.BucketSize` | Размер временн**о**й корзины в графиках, берется из параметров дашборда. Нужен для того, чтобы графики на разных временных отрезках могли быть приведены к читаемому виду. |

### Вторичный контекст (`.LoopItem`)
Этот контекст доступен только в запросах (`Target.query`). Он нужен, чтобы в цикле создавать список графиков на одной панели, количество которых специфично для каждого сервиса. 

Так, например, при подстановке вторичного контекста для сервиса, у которого есть эндпоинты `alice`, `bob` и `eva` запрос

```yaml
...
  targets:
  ...
    - query: "alias(series_sum('name', group_by_time({{ .Context.BucketSize }}, 'avg', {cluster='{{ .Context.Environment }}', project='newbilling-tarification', sensor='client_calculator-{{ .Context.Name }}.interaction_response_code_200', service='processor', name='{{ .LoopItem }}'})), '{{ .LoopItem }}')"
      loop: Endpoints
  ...
...
```

будет преобразован в 

```yaml
...
  targets:
  ...
    - query: "alias(series_sum('name', group_by_time({{ .Context.BucketSize }}, 'avg', {cluster='{{ .Context.Environment }}', project='newbilling-tarification', sensor='client_calculator-{{ .Context.Name }}.interaction_response_code_200', service='processor', name='alice'})), 'alice')"
    - query: "alias(series_sum('name', group_by_time({{ .Context.BucketSize }}, 'avg', {cluster='{{ .Context.Environment }}', project='newbilling-tarification', sensor='client_calculator-{{ .Context.Name }}.interaction_response_code_200', service='processor', name='bob'})), 'bob')"
    - query: "alias(series_sum('name', group_by_time({{ .Context.BucketSize }}, 'avg', {cluster='{{ .Context.Environment }}', project='newbilling-tarification', sensor='client_calculator-{{ .Context.Name }}.interaction_response_code_200', service='processor', name='eva'})), 'eva')"
  ...
...
```

куда дальше уже будет подставлен основной контекст.

### Возможные значения `loop`
|    Параметр   |               Описание              |
|:-------------:|:-----------------------------------:|
| `QueueTopics` | Список топиков сервиса в Logbroker. |
|  `Endpoints`  |      Список эндпоинтов сервиса.     |

## Замечания
* Так как графики в Grafana создаются при помощи API, а не руками, в ней не будет красивой схемы запроса. Она появляется, если передать отдельно поля `tags`, `groupby` и `select` при запросе, из которых потом конструируется запрос и отправляется в Solomon. Тогда, чтобы получить эти поля до запроса, нужно либо запросить их у пользователя шаблона (тем самым добавляя в него большое количество строчек, не увеличивающих функциональности), либо спарсить их из самого запроса, что значительно усложняет задачу.