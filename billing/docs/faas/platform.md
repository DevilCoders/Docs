# Платформа

Платформа представляет собой набор тасок, которые выполняются в Sandbox и обновляют Deploy спеку.

## Ссылки на окружения

### Testing

<big>https://faas.test.billing.yandex.net</big>

### Production

<big>https://faas.billing.yandex.net</big>

## Описание

Таски запускаются с помощью Arcadia CI в рамках релизов. В релизы попадают комиты, которые внесли изменения в манифесты в [Манифисенте](https://a.yandex-team.ru/arcadia/billing/hot/manificenta/manifests/tarifficator).

За релизами можно следить [здесь](https://a.yandex-team.ru/projects/newbillingtarification/ci/releases/timeline?dir=billing%2Fhot%2Fmanificenta&id=billing-faas-deploy).

При запуске релиза выполняются 3 вида тасок:

![alt text](../media/faas/ci_flow.png "CI flow")

- **BillingFaasBuildTask** занимается сборкой Манифисенты и запуском на транке. Далее таска распаршивает полученные манифесты, агрегирует калькуляторы по тенантам и инстансам и запускает таски вида **BillingFaasBuildPythonTask**.
- **BillingFaasBuildPythonTask** занимается сборкой инстанса и проверкой конфигурации калькуляторов. Также, если бинарный ресурс с такими параметрами уже существует, то таска вернет его.
- **TaskletDeployFaas** занимается выкладкой полученных бинарных файлов в Deploy, а также конфигурированием AWACS для пропускания трафика в калькуляторы.

## BillingFaasBuildTask
Данная таска валидирует манифесты из создает таски **BillingFaasBuildPythonTask** для сборки самих бинарных файлов, а после передает их в тасклет для деплоя.

Таска предоставляет отладочную информацию - логи и репорт.

Логи позволяют понять в какой момент работы произошла ошибка, а также в целом посмотреть на этапы работы таски.
Репорт позволяет посмотреть на агрегацию калькуляторов по тенантам и инстансам, что особенно полезно в случаях, когда в один тенант попадают калькуляторы из различных неймспейсов.

### Логи работы
Таска сохраняет свои логи в отдельные файлы, что позволяет отделять логи работы таски от логов самого Сандбокса.
Логи таски можно найти в хедере на вкладке **View**.

Каждый этап работы таски сохраняется в отдельный лог.

![alt text](../media/faas/logs.png "Логи таски")
<small> Логи </small>

### Репорт

После валидации манифестов и агрегации инстансов и тенантов, таска строит таблицу, в которой наглядно видно распределение калькуляторов по инстансам и тенантам.

Также в таблице есть ссылки на все калькуляторы в их ревизии и на все зависимости.

Репорт находится в отдельной вкладке **Faas report**.

![alt text](../media/faas/report.png "Репорт таски")
<small> Репорт таски </small>

### Разработка
Sanbox работает по дефолту на py2, для того, чтобы запускать py3 таски, необходимо запускать их в "песочнице" (aka taskbox).
Этот механизм аналогичен работе с тасклетами. Поэтому PY3 таску нельзя создать через UI Sandbox, только через API - консоль или другую таску.
В рамках платформы это не проблема, т.к. таска все равно запускается только внутри CI, однако это накладывает трудности в разработке.

Таску нельзя подключить через PEEDIR напрямую к `sandbox/registry`, однако можно использовать все py3 библиотеки из Аркадии.

Подробнее про работу с py3 тасками можно прочитать в [документации Sandbox](https://docs.yandex-team.ru/sandbox/dev/binary-task#python3).

#### Сборка и запуск в режиме отладки
Таска собирается стандартным образом через `ya.make`.
```
➜ ya make .
Ok
```

Для того чтобы загрузить таску в Sandbox и запустить, необходимо воспользоваться командой
```
➜ ./bin/billing-faas-build-task run -v -o BILLING-CI \
  --create-only \
  --enable-taskbox \
  --type BILLING_FAAS_BUILD_TASK \
  '{"custom_fields": [{"name": "service", "value": "faas"},{"name":"env", "value":"dev"},{"name": "binary_executor_release_type", "value": "custom"}]}'
...
2022-05-31 13:12:50 INFO Task of type BILLING_FAAS_BUILD_TASK created: https://sandbox.yandex-team.ru/task/1327162410
...
```

После этого можно перейти по полученной ссылке и запустить таску.

Шорткаты доступны в **Makefile** в корне.

#### Релиз
Релиз кода таски происходит с помощью [экшена](https://a.yandex-team.ru/projects/newbillingtarification/ci/releases/timeline?dir=sandbox%2Fprojects%2Fbilling&id=release-billing-faas-build-task),
который запускается автоматически после комита изменений в папку с таской.

После его успешного завершения, необходимо взять ID полученного ресурса типа `SANDBOX_TASKS_BINARY` [пример](https://sandbox.yandex-team.ru/resource/3151950340/view)
и поменять его версию в CI registry в файле [/projects/billing/billing_faas_build.yaml](https://a.yandex-team.ru/arcadia/ci/registry/projects/billing/billing_faas_build.yaml).

На данный момент используется только `stable` версия, однако неплохо было бы внедрить `testing` версию хотя бы для dev пайплайна.

## TaskletDeployFaas
Тасклет занимается обновлением стейджей в Деплое, а также работой с объектами в AWACS.

Тасклет получает бинарные ресурсы и проверяет версии калькуляторов в Деплое, если версии не совпадают, то тасклет обновляет ресурсы.

Платформа faas позволяет гибко управлять развертыванием калькуляторов не только с помощью основного релизного цикла, но и с помощью дополнительных экшенов.
Для этого тасклет имеет несколько режимов работы.

### Основной
Тасклет получает бинарные ресурсы, сопостовляет их с текущим состоянием спеки и изменяет спеку.
- Если ресурс есть, а инстанса в Деплое нет, то он будет добавлен
- Если ресурса нет, а инстанс в Деплое есть, то он будет удален
- Если ресурс есть и инстанс в Деплое есть, то в зависимости от версии ресурсов произойдет обновление инстанса.

#### Approval policy
Тасклет позволяет отправлять запросы на измение в спеку в различных режимах - с ожиданием подтвержения и без.
Если в стейдже настроена Approval policy, то необходимо использовать режим с ожиданием.

Стандартный таймаут ожидания равен таймауту работы таски: **3 часа**.
Во время ожидания комита деплой тикета, в CI отображается progress bar, который заполняется по мере приближения таймаута.

![alt text](../media/faas/ci_deploy_progress.png "Прогресс таски")
<small> Прогрес работы/ожидания таски </small>


### Actions

Другие режимы работы тасклета называются Actions и запускаются с помощью Arcadia CI Actions.

Экшены добавляют гибкости работы с faas, например они позволяют устранить ошибки работы с AWACS.

#### [Synchronize AWACS](https://a.yandex-team.ru/projects/newbillingtarification/ci/actions/launches?dir=billing%2Fhot%2Fmanificenta&id=faas-synchronize-awacs-dev-action)
**Description**
Если калькулятор выехал в стейдж, но таска упала с ошибкой и не успели создатся инстансы в AWACS, то трафик в калькулятор не пойдет.

**Описание работы**
Экшн берет текущие калькуляторы в спеке и проверяет какие инстансы в AWACS отсутствуют для данных калькуляторов.
После этого экшн досоздает отсутствующие объекты.

Также есть дополнительная настройка, которая позволяет удалять лишние AWACS объекты, но по дефолту она отключена.

**Use cases**
При выкатке релиза может затянуться Деплой и релиз упадет с timeout-ом, хотя сами калькуляторы были задеплоены. Если еще раз запустить релиз, то он пропустит проверку Awacs, т.к. увидит, что новых ресурсов нет.

#### [Update template](https://a.yandex-team.ru/projects/newbillingtarification/ci/actions/launches?dir=billing%2Fhot%2Fmanificenta&id=faas-update-template-dev-action)
**Description**
Обновляет шаблон текущих калькулятор шаблоном, который сейчас находится в faas. Этот экшн позволяет обновить шаблон для всех калькуляторов, без изменения версии калькуляторов.

**Описание работы**
Экшн берет текущие калькуляторы в спеке и передеплоивает их с новым шаблоном.

Экшн не проверяет усарели ли ресурсы, все текущие калькуляторы будут заново задеплоены с новым шаблоном.

**Use cases**
При необходимости обновить шаблон deploy unit`ов для всех калькуляторов.


## Конфигурация платформы в манифестах

### Сущности

Платформа faas позволяет настраивать свои калькуляторы на нескольких уровнях гранулярности.

| Название сущности |                                                                    Описание                                                                     |                                             Принадлежность                                             |
|:-----------------:|:-----------------------------------------------------------------------------------------------------------------------------------------------:|:------------------------------------------------------------------------------------------------------:|
|      Tenant       |       Самый крупная сущность, объединяет в себя множество неймспейсов<br/>Позволяет настраивать стратегию деплоя для отдельных инстансов.       |                                                   -                                                    |
|     Namespace     |                 Каждый сервис имеет свой namespace в рамках Нового Биллинга.<br/> Позволяет настроить принадлежность к tenant.                  | Принадлежит одному или нескольким tenant<br/> По умолчанию создается свой tenant для каждого namespace |
|     Instance      | Минимальная единица деплоя в faas.<br/> Для инстанса есть ограничение на ревизию - ревизия всех калькуляторов внутри инстанса должна совпадать. |                                      Принадлежит одному namespace                                      |
|     Endpoint      |      Калькулятор-функция, с которой взаимодействует Процессор.<br/> Позволяет настраивать окружение функции-калькулятора внутри инстанса.       |               Принадлежит одному instance<br/> По умолчанию принадлежит инстансу default               |


### Tenant
Тенант представляет собой группу неймспейсов, которые могут агрегироваться между собой по инстансам.
Т.е. калькуляторы из различных неймспейсов, но в одинаковых инстансах окажутся в одном deploy unit`е, что позволяет экономить ресурсы.
Тенант по умолчанию создается при использовании его в неймспейсе и имеет дефолтные настройки.

Переопределить настройки можно в [/configs](https://a.yandex-team.ru/arcadia/billing/hot/manificenta/configs). Для каждого окружения свои настройки тенантов.

Настройка тенанта имеет следующий формат
```yaml
name: common
instances:
    - name: some-instance
      active: true # default: true.
      dcs:         # default: деплой во всех доступных ДЦ по 1 поду.
        - name: sas
          amount: 1
```
- Поле **instances** позволяет настраивать инстансы внутри тенанта.
  - Поле **active** означает активен ли инстанс - если поле равно false, то инстанс не будет добавлен в платформу или будет из нее удален
  - Поле **dcs** позволяет настроить стратегию деплоя для инстанса.
    По умолчанию, faas задеплоит по 1 поду во все доступные ДЦ.
    При изменении **dcs** переопределяются настройки только для измененных ДЦ, т.е. если деплой доступен в sas и vla, в настройках указано vla: 5, то в sas будет задеплоен 1 под(дефолтная настройка)
    Если нужно выключить поды, но не убить их полностью, то можно поставить *amount: 0*

### Namespace
Неймспейс отвечает за настройки сервиса в Новом Биллиннге. На уровне faas, неймспейс может конфигурировать в каких тенантах он будет расположен.

Настройка неймспейса происходит в конфиге самого сервиса [dummy.yml](https://a.yandex-team.ru/arcadia/billing/hot/manificenta/manifests/tarifficator/dummy.yaml?rev=r9453863#L17)

Настройка неймспейса имеет следующий формат
```yaml
faas:
  tenants: [common, some-other-tenant]  # default: тенант == неймспейсу
```
- В поле **tenants** указываются тенанты, в которые попадет неймспейс.
  Если не конфигурировать данное поле, то неймспейс будет иметь свой тенант с названием неймспейса.

### Instance
Инстанс агрегирует калькуляторы в один бинарь и позволяет экономить ресурсы. Инстанс является cross-tenant, т.е.
может описываться в нескольких неймспейсах.

{% note alert %}

Все калькуляторы в рамках одного инстанса должны иметь одинаковую ревизию. Это обосновано тем, что зависимости калькуляторов попадут в один бинарь, который может собираться только на 1 ревизии.

{% endnote %}

### Endpoint
Эндпоинт - это функция-калькулятор, которая взаимодействует с Процессором.

Настройка эндпоинтов происходит в конфиге эндпоинтов.

Настройка эндпоинта имеет следующий формат
```yaml
  faas:
    function: billing.hot.faas.lib.python.example.bar.bar.BarJSON
    peerdir: billing/hot/faas/lib/python
    revision: 8628482
    instance: not_default
    settings:
      first_value: 123
      second_value: my custom value
```
- Поле **function** - полный путь до функции/класса.
- Поле **peerdir** - **PEERDIR** необходимый для работы калькулятора.
- Поле **revision** - ревизия Аркадии из которой собирать калькулятор. **Ревизия должна быть одинаковой для всего инстанса**
- Поле **instance** - инстанс, в который поселить калькулятор. Если не указывать, то инстанс будет **default**.
  Эндпоинты с одинаковым инстансом будут помещены в 1 бинарный файл.

  {% note tip %}

  Тяжелые калькуляторы лучше селить в отдельных инстансах

  {% endnote %}

- Поле **settings** - дополнительные настройки, которые будут прокинуты в калькулятор и будут доступны в поле `context.settings`

#### Название эндпоинта
Название эндпоинта faas равно названию эндпоинта Процессора в манифисенте.
Если эндпоинт не находится в дефолтном тенанте, то к его названию добавляется префикс с названием неймспейса, в котором описан этот эндпоинт.
Это позволяет объединять неймспейсы с калькуляторами, имеющими одинаковые названия.

{% note info "Пример" %}

<table>
    <thead>
        <tr>
            <th>Tenant</th>
            <th>Namespace</th>
            <th>Instance</th>
            <th>Endpoint</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td rowspan=2>pub</td>
            <td rowspan=1>first</td>
            <td>default</td>
            <td>foo</td>
        </tr>
        <tr>
            <td>second</td>
            <td>default</td>
            <td>foo</td>
        </tr>
    </tbody>
</table>

После валидации и сборки платформой, получится 1 бинарь, в котором указанные калькуляторы будут иметь префиксы:
```
https://faas.billing.yandex.net/faas-pub-default/call/first-foo/json
https://faas.billing.yandex.net/faas-pub-default/call/second-foo/json
```

<table>
    <thead>
        <tr>
            <th>Tenant</th>
            <th>Namespace</th>
            <th>Instance</th>
            <th>Endpoint</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td rowspan=1>first</td>
            <td rowspan=1>first</td>
            <td>default</td>
            <td>foo</td>
        </tr>
        <tr>
            <td>second</td>
            <td>second</td>
            <td>default</td>
            <td>foo</td>
        </tr>
    </tbody>
</table>

После валидации и сборки платформой, получится 2 бинаря, в котором каждый
калькулятор будет доступен без префикса:
```
https://faas.billing.yandex.net/faas-first-default/call/foo/json
https://faas.billing.yandex.net/faas-second-default/call/foo/json
```

{% endnote %}
