orchestra
=========

Небольшой набор инструментов для манипуляций на серверах тестирования (*dev*) и разработки (*test*).

Для функционирования использует [Fabric](http://www.fabfile.org/).


Модуль для непрерывной интеграции
---------------------------------

Документация по ci части [здесь](https://wiki.yandex-team.ru/Balance/Orchestra/)


Общие принципы работы
---------------------

* Список поддерживаемых команд с примерами использования можно получить обычным для Fabric способом: ``fab --list``

* После команды ``fab`` обычно следует произвести выбор хостов, на которых нужно выполнить команды.  

  Выбор осуществляется командой ``host``. Можно выбрать все хосты окружения. Для этого после команды указывается 
первая буква названия окружения (**d** - dev, **t** - test).

  Если выполнение команды на всех хостах окружения не требуется, то при помощи той же команды ``host`` можно указать 
конкретный хост, на котором следует выполнить команду. Команда принимает как полное имя хоста, так и его псевдоним,
в котором первый символ - это всё та же первая буква названия окружения, а последующие - символы, содержащиеся 
в конце имени домена верхнего уровня. 
  Например для ``dmongo1e.yandex-team.ru`` можно выполнить ``fab host:de ...`` или ``fab host:d1e ...``.
  
* Команды семейства ``_log`` служат для мониторинга журналов в прямом эфире.   
  Поддерживают аргумент ``term``, позволяющий фильтровать вывод журнала. Например:
  ``fab host:dg app_log:bcl,term=some``
  
* Команды семейства ``_log_find`` служат для поиска по журналам. Поиск при этом ведётся с конца файла.  
  Помимо аргумента ``term`` (строка поиска) поддерживают аргументы ``limit`` 
  (ограничение максимального количества искомых строк) и ``context`` (количество строк до и после найденной строки). 
  ``context`` может быть как задан одним числом, так и двумя, через двоеточние (``строк_до:строк_после``).   
  В последнем случае нуль указывать необязательно, он подразумевается.
  
* Команды, связанные с приложениями, часто позволяют использовать псевдонимы вместо полных имён приложений. 
  Например: вместо длинного ``balalayka`` можно использовать ``bcl``.
  

Приложение
----------

* При помощи Кондуктора раскатывает последнюю доступную в рамках задачи ``1196`` версию приложения ``bcl`` в окружении *test*:
  ``fab app_rollout:"bcl,1196"``

  Чтобы запустить раскатку в интерактивном режиме (вас спросят что и куда катить) достаточно указать только приложение:
  ``fab app_rollout:"bcl"``

  Для раскатки последней собранной версии из ``master`` (стебля) используйте ``fab app_rollout:"bcl,master"``

  *Внимание*: для работы команды следует в переменной окружения ``CONDUCTOR_TOKEN`` указать токен доступа к Кондуктору,
  получить который можно [здесь](https://oauth.yandex-team.ru/authorize?response_type=token&client_id=eb3c509c74b649cd8411ffc154543fe0).

  Для удобства можно установить ``envbox``, создать файл ``.env`` в корне Оркестра и положить переменную с токеном в него.

* Отправляет команду ``restart`` сервису приложения ``bcl`` в окружении *dev* на сервере ``g``:
  ``fab host:dg app:"bcl restart"``

* Для некоторых приложений, использующих по несколько сервисов в **orchestra** определы группы, позволяющие
  отсылать команду всем сервисам сразу. Например, для остановки всех сервисов балалайки на всех хостах окружения *dev*:  
  ``fab host:d app:"bcl stop"``


Журналы приложения
------------------


* Вывод в реальном времени сообщений, содержащих слово ``exc``, из журнала приложения "балалайка":  
  ``fab host:dg app_log:"bcl,exc"``
  
* Поиск последних двух сообщений, содержащих ``exc`` и следующих за ними пяти строк контекста, из журнала 
  приложения "балалайка":  
  ``fab host:dg app_log_find:"bcl,exc,2,context=:5"``  
  
* Поиск сообщений, содержащих сквозной идентификатор запроса в журнале приложения "балалайка":  
  ``fab host:th app_log_find_request:"bcl,877599bc7ddcf5e0a2dfd3412583dbce"``
  
* Поиск сообщений, содержащих идентификатор исключения в журнале приложения "балалайка":  
  ``fab host:th app_log_find_exc:"bcl,1919e5625340485e893d137293d9dcc8"``


Боевые журналы приложения
-------------------------

``rlog`` - от remote log (журнал с удалённой машины).

* Вывод в реальном времени сообщений, содержащих слово ``exc``, из журнала приложения "балалайка" 
  с боевых серверов:  
  ``fab app_rlog:"bcl,exc"``  
  Чтобы получить данные журнала только с одной ноды, следует указать параметр ``node``:  
  ``fab app_rlog:"bcl,exc,node=1g"``
  
* Вывод из боевых журналов приложения балалайка данных, содержащих ``some``:  
  ``fab app_rlog_find:"bcl,some"``
  
* Поиск в архиве боевых журналов (содержащих в имени ``queue``) балалайки за 23 февраля строк с ``some``:  
  ``fab app_rlog_find:"bcl,some,on_date=2017-01-23,name=queue"``
    
* Поиск в архиве боевых журналов балалайки за 1 октября запроса номер ``877599bc7ddcf5e0a2dfd3412583dbce``:  
  ``> fab app_rlog_find_req:"bcl,877599bc7ddcf5e0a2dfd3412583dbce,on_date=2017-10-01"``
      
* Поиск в архиве боевых журналов балалайки за сегодня исключения номер ``1919e5625340485e893d137293d9dcc8``:  
  ``> fab app_rlog_find_req:"bcl,1919e5625340485e893d137293d9dcc8"``
  

Mongo шарды
-----------
  
* Перезапуск элементов первого шарда Монго в окружении *dev*:   
  ``fab host:d mongo_shard_restart:1``
  
* Журнал второго шарда Монго в окружении *dev* с сервера ``g``:   
  ``fab host:dg mongo_shard_log:2``


Mongo скрипты
-------------
  
* Установка данных контекста подключения к БД:  
  ``fab db_context:name,user,password,port,host ...``
  
* Исполнение команды ``rs.status()`` в оболочке Монго в окружении *dev*:   
  ``fab host:d db_admin mongo_eval:"rs.status()"``  
  Здесь команда ``db_admin`` переключает контекст на нужную БД подобно ``db_context``.
  
* Исполнение команд из локального файла ``some.js"`` в оболочке Монго в окружении *dev* на сервере ``g``:  
  ``fab host:dg db_admin mongo_eval:/home/idlesign/some.js``  
  Здесь команда ``db_admin`` переключает контекст на БД балалайки подобно ``db_context``.


Mongo резервные копии
---------------------

* Развёртывание самой свежей из имеющихся (*latest*) резверных копий БД балалайки (*bcl*).    
  ``fab host:dg db_bcl mongo_restore:latest``  
  Параметром (вместо *latest*) можно указать за какую дату следует взять резерв (например ``2017-03-06``).  
  Если не указывать параметра, будет выведен список всех доступных  на сервере резервных копий.
