# Balance common config

Всебалансовая конфигурация, мигрировавшая из BitBucket.

## Сборка и выкладка
Делается через flow в Acracia CI [Common configs release](https://a.yandex-team.ru/projects/balance/ci/releases/timeline?dir=billing%2Fbalance%2Fconfigs&id=common-config-balance-release)

Разработка ведется в trunk'е. Т.к. конфигами сейчас пользуются разные сервисы и их версии нельзя привязывать к релизному циклу одного сервиса.

Флоу разделен на стадии 
### Build
* Пакеты для всех сред всех сервисов собираются и заливаются в репозиторий пакетов.
### Testing
* Создаются кондукторные тикеты на все тестовые и дев среды всех сервисов (кросе PCI-DSS по их просьбе).
* Кондукторные тикеты на тестинг выкладываются автоматически.
* Кубики на этой стадии ждут и создания и выкладки тикетов.
###  Production
* Создаются кондукторные тикеты на предпродакшен и продакшен среды всех сервисов
* Кондукторные тикеты на предпродакшен и продакшен автоматически не выкладываются. Только создаются.  
* Выкладывать тикеты нужно через таймлайн.
* Тикеты создаются для сред всех сервисов. При желании ветку любого сервиса можно закрыть гэндальфом и тикеты для него не создадутся. Но большого смысла в этом нет. Если мы создаем тикет и не собираемся его катить это не является проблемой насколько я знаю.
### After Production
* Кубик нужно нажать если выкладка на все планируемые среды завершилась (в таймлайне)
* При этом допустимо чтобы выкладка была сделана только на машины одного сервиса - эта версия катилась только на машины баланса.
* Если кубик не нажать релиз не считается завершенным. Нельзя запустить стадию Production для следующего релиза.
* В чейнджлог версии попадают все коммиты с последнего завершенного релиза
* Сделать шаг автоматическим нельзя, т.к. не всегда катаем все созданные тикеты

## Сценарии
### Нужно обновить конфиги
* Делаем пулл-реквест 
* Ревью реквеста по тем же правилам что было в битбакете - для правок траста нужно ревью баланса только если правка может повлиять на функционал баланса.
* Запускаем флоу нажав Run release. Здесь можно выбрать коммит с которого собираться - не обязательно собираться с последнего.
* После выкладки на тестовые среды и тестирования запускаем первый кубик стадии Production
* После создания продакшен тикетов катим их через таймлайн.
* После завершения выкладки в продакшен в таймлайне нажимаем кубик завершения релиза

### Последняя версия катится в продакшен, новую надо собрать на тест
* После старта стадии Production одного релиза следующий сможет раскатиться на тестинги
* До старта фазы Production даже если все кубики стадии Testing завершились - не сможет
* Отменять предыдущий релиз в этой ситуации не нужно

### Выкатили одну версию в прод, хотим катить следующую, но стадия Production нового релиза не начинается.
* В последнем выкаченном релизе нужно прожать кубик подтверждения успешной выкладки
* Новый релиз не сможет начать стадию Productions если предыдущий не начал стадию After Production (а в ней только один ручной кубик). 

### Собрали версию, потестировали, но в прод не покатим
* Отменяем последний релиз и запускаем новый. Отменить можно чекбоксом при запуске или зайдя в предыдущий реиз явно.
* Версия пакета будет все-равно инкрементирована. Но чейнджлог будет отражать все изменения с последней выкладки в продакшен.