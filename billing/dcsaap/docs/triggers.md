# Триггеры Трекера

Для очереди [SSD](https://st.yandex-team.ru/SSD) заведены несколько триггеров, относящиеся к проекту описаны ниже.

## Автоматическое закрытие задачи при нуле расхождений

Триггер направлен на автоматическое закрытие задачи, в запуске которой было найдено 0 расхождений.
Триггер срабатывает при создании задачи или изменении её описания. Действие триггера - закрытие задачи и установка резолюции "Решен".

Условия срабатывания триггера:
- Группа условий (должно выполняться любое):
  - Создано: значение поля изменилось
  - Описание: значение поля изменилось
- Статус: равно Открыт
- Описание: содержит любой из фрагментов:
  - Найдено расхождений: 0
  - Найдено расхождений (всего): 0

Действия триггера:
- Переход в другой статус:
  - Новый статус задачи: Закрыт
- Изменение значений в полях:
  - Резолюция:
    - Установить значение: Решен
  - Компоненты:
    - Удалить из списка: Тестовый запуск

Скриншоты:
- [Условия срабатывания триггера](images/triggers/close_if_zero_conditions.png)
- [Действия триггера](images/triggers/close_if_zero_actions.png)

## Изменение типа запуска на тестовый

Триггер позволяет изменить тип запуска в сверки с продового на тестовый (запуск не будет учитываться при копировании предыдущих расхождений).
Триггер срабатывает на нажатие кнопки "Тестовый запуск", которая добавляет компоненту "Тестовый запуск".

Добавлен по задаче: https://st.yandex-team.ru/CHECK-3390

Настройки перехода "Тествый запуск":
- Функции:
  - Добавить компоненты:
    - Тестовый запуск
  - Установить резолюцию:
    - Резолюция: Неполный

Условия срабатывания триггера:
- Компоненты:
  - Содержит любой из элементов: Тестовый запуск

Действия триггера:
- HTTP-запрос:
  - Метод: `POST`
  - Адрес: https://dcs.yandex-team.ru/api/v1/runs/mark-test
  - Способ авторизации: `NoAuth`
  - Тип содержимого: `application/json`
  - Тело запроса: `{}`
  - Заголовки:
    - `X-Tracker-User-Id`: `{{currentUser.uid}}`
    - `X-Tracker-Issue-Key`: `{{issue.key}}`
    - `X-Tracker-Secret`: `{{var.secret}}`
  - Переменные:
    - `secret`: секрет:
      - для тестового окружения: https://yav.yandex-team.ru/secret/sec-01eq1582frc4bhw5tvmmqdat4s
      - для продакшен окружения: https://yav.yandex-team.ru/secret/sec-01eq82vm06c8xsc7trzm98tanc

Скриншоты:
- [Настройки перехода](images/triggers/test_check_workflow.png)
- [Условия срабатывания триггера](images/triggers/test_check_conditions.png)
- [Действия триггера](images/triggers/test_check_actions.png)

## Закрытие расхождений при закрытии тикета

Триггер позволяет закрыть открытые расхождения и пометить их тикетом запуска (уже закрытые расхождения не модифицируются).
Срабатывает при закрытии тикета.

Добавлен по задаче: https://st.yandex-team.ru/CHECK-3103

Условия срабатывания триггера:
- Статус:
  - Стало равно: Закрыт
- Резолюция:
  - Стало равно: Решен

Действия триггера:
- HTTP-запрос:
  - Метод: `POST`
  - Адрес: https://dcs.yandex-team.ru/api/v1/runs/resolve
  - Способ авторизации: `NoAuth`
  - Тип содержимого: `application/json`
  - Тело запроса: `{}`
  - Заголовки:
    - `X-Tracker-User-Id`: `{{currentUser.uid}}`
    - `X-Tracker-Issue-Key`: `{{issue.key}}`
    - `X-Tracker-Secret`: `{{var.secret}}`
  - Переменные:
    - `secret`: секрет:
      - для тестового окружения: https://yav.yandex-team.ru/secret/sec-01eq1582frc4bhw5tvmmqdat4s
      - для продакшен окружения: https://yav.yandex-team.ru/secret/sec-01eq82vm06c8xsc7trzm98tanc

Скриншоты:
- [Условия срабатывания триггера](images/triggers/update_jira_conditions.png)
- [Действия триггера](images/triggers/update_jira_actions.png)
