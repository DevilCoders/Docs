# Скрипты для генерации графов в Nirvana

## aob_iob_multiple

Небольшой скрипт, для генерации графа множественного запуска сверок в cистеме сравнения данных.
Для каждой из перечисленных в нём сверок генерирует строчку графа, состоящую из запуска подготовки данных и последующего запуска сверки.
Изначально разработан для множественного запуска сверок aob/iob, как аналог мета-сверок `aob_all` и `iob_all` в старом проекте сверок.

Для начала работы требуется унаследовать класс `Config` и указать параметры для генерации:
- `workflow_id`: ID графа в Nirvana, который будет заполняться операциями (instance будет создан автоматически)
- `check_name`: наименование сверки, например `aob` или `iob`
- `check_map`: список кодов сверок и их ID в системе сравнения данных.
- nirvana oauth token в параметре `TOKEN` в os.env. Если токена нет, его можно получить по ссылке https://oauth.yandex-team.ru//authorize?response_type=token&client_id=637ca17604cb4dfa90b262952c00b1e9

`check_map` для `aob` был получен следующим запросом:
```sql
SELECT
FORMAT('(''%s'', %s),',
  coalesce(substring(title from 'aob_?([^)]+)'), 'russia'),
  id)
from core_check
where title like '%aob%'
order by id
;
```

Для запуска скрипта требуется окружение с установленным `nirvana-api`:
```
pip install --extra-index-url https://pypi.yandex-team.ru/simple/ nirvana-api
```

Запуск выполняется с указанием кода сверки, для которой генерируются массовые запуски:
- Для актов:
```
python nirvana/graph_gen/aob_iob_multiple.py --aob
```
- Для счетов:
```
python nirvana/graph_gen/aob_iob_multiple.py --iob
```

Для запуска графа после генерации требуется указать следующие глобальные переменные (сами переменные создаются автоматически):
- `tvm-client-id`:  ID приложения, от имени которого выполняется запуск в формате `2020513:dcsaap-nirvana`
- `tvm-secret`: секрет этого приложения
- `oauth-token`: OAuth-токен, от имени владельца которого будет запущена сверка
- `unique-trait`: идентификатор для сброса детерменированности операций, выставить на текущую дату

Пример сгенерированного графа для сверки `aob`:
https://nirvana.yandex-team.ru/flow/33474ef2-a7fe-44f3-86d7-cd99b1881416/3f3209b6-b8dc-4327-9b13-3b726eeafd8e/graph
