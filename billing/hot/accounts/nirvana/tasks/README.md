###### Общее
Наши операции и воркфлоу лежат в каталогах:
* test: https://nirvana.yandex-team.ru/browse/resolve?path=/billing/hot/test/accounts
* prod: https://nirvana.yandex-team.ru/browse/resolve?path=/billing/hot/prod/accounts

###### Квота
(Новый биллинг) Система счетов
https://dispenser.yandex-team.ru/nirvana/projects/billing30_hot_accounts

###### Операция постановки в очередь
Для отправки создал операцию (прикрепил ее также в папку)
https://nirvana.yandex-team.ru/browse?selected=8083120
Операцию создал руками. Ее json приложил в репозиторий для бэкапа (Export dump в операции чтобы его получить).


Операция смотрит в нашу дев учетку в sqs. Это достигается благодаря тому что в нее добавлен ресурс с дев конфигом
https://nirvana.yandex-team.ru/operation/6dec17d8-b6d5-4a76-a091-e2a1fa9553ee/resources


В будущем будет либо отдельные операции для дева, теста и прода.
Либо получение нужного конфига также будет вынесено в отдельный кубик.
Плюс первого что труднее запустить тестирование на проде.
Плюс второго что если надо обновить конфиг не надо пересоздавать операцию.

###### Редактирование операции
1. Заходим в операцию (если через дерево то в карточке надо нажать Details)
2. Нажимаем Clone
3. Меняем параметры, обновляем версию
4. Предыдущую версию депрекейтим.
   Mandatory - если хотим чтобы во всех реакциях обновилось автоматически.
   Optional - если нет.

Операция заменится на месте

###### Добавление новой джобы
0. Добавляем код джобы в проект (см billing/hot/accounts/pkg/core/tasks)

1. Добавляем для нее воркфлоу

2. Добавляем для воркфлоу реакцию

###### Добавление воркфлоу
1. Создаем новый воркфлоу. Не добавляем в него никаких операций
2. Открываем последний инстанс любой другой джобы
   например https://nirvana.yandex-team.ru/browse?selected=8083069
2. Нажимаем Clone to и выбираем созданный в п1 воркфлоу
3. Кубик Build Arcadia Project не трогаем
4. В кубике Операции постановки в очередь меняем 2 параметра
    * job_name - то же имя что и в коде для данной джобы
    * job_payload - то что хотим иметь в теле сообщения sqs
      Пэйлоад задается в формате json. Его надо окружать одиночными скобками.
      Напр  ```'{"param":"another payload"}'```

5. Нажимаем Approve.

6. Предложит выбрать квоту. Выбираем `(Новый биллинг) Система счетов` https://dispenser.yandex-team.ru/nirvana/projects/billing30_hot_accounts
7. Если джобу безопасно запустить сейчас - нажимаем Run и смотрим что все отработало норм.

###### Правка существующего воркфлоу
1. Открываем последний инстанс нужного воркфлоу
2. Клонируем его
3. Правим
4. Аппрувим

###### Добавление новой реакции
1. Открываем реакцию для какой нибудь джобы
   Напр https://nirvana.yandex-team.ru/browse?selected=8083336

2. Нажимаем Clone
3. Правим имя. Я придерживаюсь шаблона ```{Имя workflow} Reaction```
4. В качестве проекта выбираем ```/billing/balance/Project (ABC: balance)```
5. Правим Cron выражение
6. В ```Source Workflow ID``` вставляем id созданного workflow.
   Не забываем под полем перечекнуть Instance на Workflow - иначе будет ругаться непонятно.

7. В ```Upgrage strategy``` ставим ```Minimum not mandatory deprecated```.
   Тогда при обновлении операции если ее родитель был задепрекейчен со статусом Mandatory -
   наша реакция подхватит изменения автоматически - следующий инстанс будет создан с новой версией реакции.

8. Т.к. клонируем рабочую реакцию то в выпадухе кнопки Clone выбираем ```Leave old reaction as is```
9. Активируем реакцию (кнопка плей)

###### Правка существующей реакции
1. Открываем реакцию
2. Деактивируем ее
3. Нажимаем Clone
4. Меняем параметры
5. В выпадухе кнопки Clone выбираем ```Replace old reaction``` и жмем Clone

###### Обновление бинаря с релизом
Во всех воркфлоу используем операцию Build Arcadia Project


Т.к. она кеширует результаты прогона с одинаковыми параметрами,
то реальная сборка будет сделана один раз в рамках жизни кэша и бинарь переиспользован во всех воркфлоу
todo-igogor сколько живет кэш? Как будет выглядеть пересборка когда он отвалится?


Т.е. чтобы обновить бинарь надо будет пройти по всем воркфлоу и проставить там урл указывающий на другую ревизию
todo-igogor сие боль. Этот вопрос еще прорабатываем вместе с Темой

Запускаемая сборка в сэндбоксе работает под нашей квотой т.к. переданы 2 опции
```Custom sandbox task owner (should be used only with OAuth token)``` - ```BILLING-CI```
```Sandbox OAuth token``` - секрет https://nirvana.yandex-team.ru/secret/77026866-2bb1-486c-80b7-38e1e36c747a


###### Тестирование
1. Добавляем джобу в свою ветку арка
2. Создаем отдельный тестовый вокрфлоу для джобы с тестовой операцией (с тестовым конфигом)
   В нем в качестве параметра урла ссылку на коммит арка ``````
   ```Full SVN url for arcadia (Overwrites base URL and revision, use @revision to fix revision)```
   передаем ссылку на свою ветку как в сэндбоксе ```arcadia-arc:/#4a9dbeabf69391c9ee3ecce89580e43ba315e525```
   Здесь важно передавать не ссылку на ветку (```arcadia-arc:/#users/igogor/BILLING-14_enqueue_binary``) а на коммит,
   т.к. результат сборки кэшируется для одинаковых параметров - после обновления ветки надо поменять парамет урла

3. Собраться конечно можно и из svn и из pr. Параметры как в сэндбоксе.
3. Создаем отдельную тестовую реакцию для этого воркфлоу.
4. После тестирования их можно будет склонить в продовые
   заменив операцию или конфиг
   и кубик сборки бинаря


###### Секреты
1. **testing**. Операция постановки в очередь использует секрет
https://yav.yandex-team.ru/secret/sec-01exh4aa504wzc5w7j8tz4xhsc
Прокинутый в нирвану через
https://nirvana.yandex-team.ru/secret/e214992d-fe36-431a-b4f7-c06dc0f0203a
2. **prod**.  Операция постановки в очередь использует секрет
https://yav.yandex-team.ru/secret/sec-01exh4gv33wz9tyvcpha3na212
Прокинутый в нирвану через
https://nirvana.yandex-team.ru/secret/a1725693-0e22-4872-a3fd-12953dfff7bf

