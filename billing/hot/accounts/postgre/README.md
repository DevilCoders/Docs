###Пользователи для базы
В базе заводится 3 пользователя: `accounts`, `accounts1`, `accounts2`
* В базу можно ходить под любым пользователем. Но по смыслу лучше под `accounts1` и `accounts2`
* `accounts` считается ролью (в postgrese нет принципиального различия между пользователем и ролью). Ему в принципе можно оторвать право на логин, но я оставил на всякий случай.
* `accounts1` и `accounts2` получают роль `accounts` и поэтому могут добавлять, удалять любые сущности (таблицы, матвьюхи, ...) в базе и менять сущности принадлежащие `accounts`
* Чтобы любой из пользователей мог менять любую сущность, `accounts` должен быть владельцем всех сущностей. Для обеспечения этого в скрипты миграции добавлен [хук](callbacks/afterAll/00_reassign_owned_to_accounts.sql).
* Пользователи должны быть
[заведены](https://docs.yandex-team.ru/cloud/managed-postgresql/operations/cluster-users#adduser) и им [присвоена роль](https://docs.yandex-team.ru/cloud/managed-postgresql/operations/grant#grant-role) только через механизмы облака иначе они стираются при следующей операции с базой
* Дока облака этого не говорит, но `SET ROLE accounts` в базах облака тоже не сработает. Поэтому в миграциях создаем сущности под текущим пользователем, а потом передаем право на них `accounts`.
* Несколько пользователей нужны чтобы обеспечить смену пароля без простоя
* Под каким пользователем надо сейчас ходить в базу видно в конфигах.

###Секреты пользователей
1. Тест
    * accounts1 [пароль](https://yav.yandex-team.ru/secret/sec-01fhym56aggrbb4kcxzbxm1pbb/explore/versions)
    * accounts2 [пароль](https://yav.yandex-team.ru/secret/sec-01fhym982zmc0v9ex0razz2svq/explore/versions)
    * accounts [пароль](https://yav.yandex-team.ru/secret/sec-01fhym1969w51c09qq98w8fa76/explore/versions)
      Ему возможно оторву право на логин в будущем.
2. Прод.
    * accounts1 [пароль](https://yav.yandex-team.ru/secret/sec-01fhzn06emmvc5emzp3wj0x8wf)
    * accounts2 [пароль](https://yav.yandex-team.ru/secret/sec-01fhzn3401sbmzff0sz70kaddg)
    * accounts [пароль](https://yav.yandex-team.ru/secret/sec-01fhzmwb35zby771zjdjpqwywk)
      Ему возможно оторву право на логин в будущем.

###Процедура смены пароля
На примере смены `accounts1` на `accounts2`
1. Идем в деплой и добавляем секрет с паролем `accounts2`.
Значение пароля кладем в новую переменную окружения `ACCOUNTSDB_PASSWORD2`
2. Идем в конфиги приложения и меняем имя пользователя на `accounts2` имя переменной с паролем на `ACCOUNTSDB_PASSWORD2`
3. Выкатываем релиз
4. Идем в деплой и удаляем секрет с паролем `accounts1` и переменную окружения `ACCOUNTSDB_PASSWORD1`
5. Ждем некоторое время (если иб не дышит в затылок, то несколько дней). Проверяем что от `accounts1` нет активности.
    * Проще всего посмотреть наличие сессий и запросов от пользователя на вкладке Диагностика производительности на странице кластера в облаке
    * Можно повтыкать в таблицу pg_stat_activity
6. Перегенеряем пароль для `accounts1` и обновляем секрет
7. Обновляем пароль для `accounts1` в настройках mdb (в идеале через терраформ)
8. Если перегенеряли пароль для теста, то не забываем поменять в конфиге интеграциооных тестов

###Скрипт генерации пароля
```python
import secrets
import string


def main():
    # secure password
    password = ''.join((secrets.choice(string.ascii_letters + string.digits + '#!^=:[]') for i in range(30)))
    print(password)
```
Также можно использовать pwgen

###Обновление через терраформ
todo-igogor

###Миграции базы
* Пока вручную. Для этого написан отдельный [Makefile](Makefile)
* Прежде чем что-то мигрировать надо убедиться что мастер не сменился
* После миграции вызовется коллбэк, который передаст права на все созданное пользователю `accounts`
  Если вызвать миграцию из под `accounts` коллбэк отработает без ошибок. Хотя лично меня почему-то операция смены owner'a с accounts на accounts смущает. Но работает.
  Коллбэк можно было бы прописать в конфиг миграции, но тогда этот конфиг подхватывается pgmigrate автоматически всегда и это ломает тесты. Т.к. в них имя пользователя рандомное и пользователь accounts отсутствует.
