## Ссылки
1. [Дизайн-документ](https://wiki.yandex-team.ru/users/lightrevan/todo/billingrefactoring/coreaccounts/)
2. [Явки и пароли](https://wiki.yandex-team.ru/balance/billing30/accounts/env/)

## Общая идея
Основная функциональность сервиса - апи, реализующее операции с т.н. "счетами", сильно напоминающими бухгалтерские счета.
Для каждого счёта определены операции:
* Запись новых событий.
* Получение остатков на дату.
* Получение оборотов за период.
* Получение событий за период.

Счёт характеризуется:
* Типом - например, "комиссии такси".
* Ключевыми атрибутами - например, клиентом и валютой или договором.
* Вспомогательными атрибутами - например, продуктами, регионами и т.п.

Получение остатков и прочего по счёту обязательно делается в разрезе всех ключевых атрибутов и по
некоторому подмножеству вспомогательных атрибутов. Например, по счёту с ключевыми атрибутами "клиент", "валюта" и
вспомогательными атрибутами "продукт", "регион" можно получать данные в разрезе
либо только продукта либо только региона, либо пары регион+продукт.

Помимо этого есть две вспомогательных функциональности, предоставляемых тем же апи:
* Блокировки (эксклюзивные и разделяемые).
* Хранение произвольного состояния json'иной.

Вспомогательные сущности, аналогично со счетами, имеют типы и обязательные атрибуты.

Типы счетов и вспомогательных сущностей, атрибуты и разрешённые подмножества для группировок не фиксированы в коде
а описываются через конфиг.

Детальнее про логику и идеи см. [диздок по ссылке]((https://wiki.yandex-team.ru/users/lightrevan/todo/billingrefactoring/coreaccounts/)).

### Шардирование
Так как в базовых требования к сервису рокетсаенс, хайлоад и горизонтальное масштабирование - Postgresql'ная база шардируется.
Для каждого счёта, блокировки и технического стейта рассчитывается из атрибутов ключ шардирования и хешируется в SHA-1.
Шарды назначаются по диапазонам хешей.

### Агрегация
Для реализации быстрого АПИ получения остатков на произвольную дату асинхронно рассчитываются промежуточные остатки
на заранее определённые интервалы (например, на начало дня). Операция получения остатков должна найти ближайший агрегат,
события которые произошли после даты агрегата, события которые ещё не были агрегированы, и всё это сложить.

### Монотонно возрастающие ID
Есть (как минимум) две задачи, требуемых exactly once обработки событий по счетам:
* Выгрузка в Logbroker.
* Расчёт промежуточных остатков по счетам.

Для реализации exactly once обработок событий отдельным фоновым процессом по ним проставляется монотонно возрастающий ID.
На каждый шард может работать только один процесс простановки ID. Все последующие обработки уже могут оперировать только
последним обработанным ID, будучи уверенным что никогда не появится записей с ID меньшим чем они обработали.

### Фоновые процессы
"Быстрые" фоновые процессы - выгрузка в LB и проставление id - сделаны отдельными точками входа, в которых обработка крутится
в бесконечном цикле. Для всего остального реализован универсальный механизм фоновых тасок через очередь в SQS и реактор.
А именно:
* Через реактор по крону запускается кубик в нирване, который кладёт в sqs'ную очередь сообщение.
* Работает процесс, который вычитывает из SQS сообщения и выполняет нужные обработчики.
* При необходимости сообщения в очередь может класть АПИ или сами обработчики очередей.

Имеющиеся на данный момент фоновые процессы на этом механизме:
* Удаление старых и создание новых партиций.
* Формирование промежуточных агрегатов.

### Компоненты
1. Веб-сервер с REST-API (api).
1. Фоновый процесс простановки монотонно возрастающего ID (aggregates).
1. Фоновый процесс выгрузки в Logbroker (lbexporter).
1. Универсальные фоновые таски (tasks).

## Структура проекта
* `Makefile`: различные полезные команды для сборки, локального запуска, тестирования, сборки образа
* `docker-compose.yml`: запуск локального окружения для разработки
* `packages`: настройки сборки образов для Deploy'я
* `a.yaml`: настройки аркадийного CI
* `configs`: конфигурационные файлы
    * `api`, `aggregates`, `tasks`, `lbexporter`: конфиги соответствующих приложений
    * `settings`: настройки структуры счетов
* `nirvana`: json-конфиги кубиков нирване
    * `jobs`: кубики для запуска фоновых тасок
* `sqs`: json-конфиги используемых очередей в SQS
* `main.go`: точка входа
* `cmd`: директория с командами, которые будут доступны для вызова из итогового бинаря
* `pkg`:
    * `commands`: реализация команд из `cmd`
        * `context.go`: расширение контекста доп. полями для типизированного использования в `actions`
    * `core`: основная логика
        * `actions`: основная бизнес-логика, использует `storage/db`
        * `sequencer`: логика простановки id
        * `tasks`: логика всех фоновых тасок
        * `lbexporter`: логика выгрузки в LB
        * `partitioning`: логика фоновой таски поддержки партиций
        * `entities`: структуры, описывающие основные сущности
        * `entitysettings`: логика работы с настройками
        * `errors`: описание прикладных ошибок
        * `config.go`: структура конфига и функция парсинга структуры счетов
    * `server`: релизация web-сервера
        * `handlers`: функции, обрабатывающие запрос. На вход - http-request, на выходе запись ответа. Вызывают `actions` (см. выше) для формирования ответа
        * `app.go`: оболочка к АПИ
        * `sequencerapp.go` - оболочка к простановщику id
        * `taskapp.go` - оболочка к универсальным фоновым таскам
        * `lbexporterapp.go` - оболочка к выгружатору в LB
        * `context.go`: адаптор, преобразующий контекст к кастомному контексту, чтобы не кастить в каждом `handler`'е
        * `middlewares.go`: локальные `middlewares`
        * `router.go`: сопоставление путей и `handler`'ов
    * `storage`: работа с хранилищами данных
        * `db`: логика, работающая непосредственно с postgres'овой базой
        * `logbroker`: логика, работающая непосредственно с Logbroker'ом
    * `templates`: работа с шаблонами, в частности для сложных запросов в БД (с кэшом):
        * `templates`: файлы шаблонов
* `postgre` - миграции базы через pgmigrate

## Детальные инструкции:
* [Пакетирование, сборка и выкладка](packages/README.md)
* [Локальная разработка](docs/dev.md)
* [Мониторинги](docs/monitorings.md)
* [Фоновые таски](pkg/core/tasks/README.md)
* [Кубики в Нирване](nirvana/tasks/README.md)
* [Очереди в SQS](sqs/README.md)
* [Выгрузка событий в логброкер и ыть](logbroker/README.md)

## Emergency contact
* lightrevan@
* igogor@
* azurkin@
