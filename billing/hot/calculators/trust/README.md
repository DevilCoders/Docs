# Траст калькулятор

## Прежде чем делать изменения в калькулятор
Перед тем как вносить изменения нужно настроить прекоммитные хуки, которые будут напоминать запускать все установленные
линтеры перед коммитами, в проекте используются flake8, mypy, isort и black. Для настройки хуков в аркадии
нужно указать новую секцию в файле конфигурации `~/.arcconfig`, которая содержит информаицю о том, на какие изменения
запускать хуки, а также какой скрипт выполнять. Скрипт запускается перед каждым коммитом из целевой директории(что
удобно, т.к. в ней и лежат конфиги), при этом запуск происходит лишь при наличии в ней изменений.
Подробнее можно почитать здесь: https://docs.yandex-team.ru/devtools/src/arc/hooks#pre-commit

Для удобства настройки прекоммитных хуков написана команда `make setup_arc_hooks`, при ее запуске автоматически
создастся файл `~/.arcconfig`(если не существует) и в него добавится нужная секция траст калькулятора, а также
добавятся права на выполнение на файл `${ARCADIA_ROOT}/billing/hot/calculators/trust/scripts/precommit.sh`,
который и содержит запуск всех комманд(путь до аркадии определяется автоматически при помощи утилиты ya, переменную
окружения проставлять не нужно).

Сами прекоммитные проверки никак не изменяют код, а лишь выводят найденные проблемы. Запуск линтеров отсортирован по
объему вывода(от большего к меньшему) и его важности(от менее важного к более важному), так что самые значительные
проблемы будут напечатаны ближе. При наличии проблем с любым из инструментов, кроме black, проверки упадут. Однако,
black тоже обязательно нужно прогонять)

Запуск команды это единственное, что нужно сделать для настройки хуков:)


## Структура

```
.
├── Makefile
├── pyproject.toml
├── setup.cfg
├── calculator
│   ├── core
│   │   ├── actions
│   │   │   ├── configurable_blocks
│   │   │   ├── adapters.py
│   │   │   ├── base.py
│   │   │   ├── payment.py
│   │   ├── entities
│   │   ├── accounts.py
│   │   ├── analytics.py
│   │   ├── const.py
│   │   ├── types.py
│   ├── faas
│   │   ├── adaptors
│   │   │   ├── base.py
│   │   │   ├── payment.py
│   │   ├── schemas
│   ├── tests
├── faas_example_settings
│   ├── faas.trust.settings
│   ├── faas.mail_pro.settings
│   ├── faas.music.settings
│   ├── faas.scooter.settings
│   ├── faas.games.settings
```


* `Makefile`: полезные команды для запуска линтеров и тестов
* `pyproject.toml` + `setup.cfg`: конфигурация используемых инструментов, размазано на два файла т.к. некоторые инструменты
не поддерживают те или иные форматы входного файла конфигурации
* `calculator`
  * `core`: основная логика
    * `actions`: логикая непостредственно связанная с action'ами
      * `configurable_blocks`: сущности, модифицирующие логику работы калькулятора и настраиваемые в манифесте(фильтры
и мидлвары). Написано по мотивам /billing/library/python/configurable_blocks(такой же интерфейс и структура)
      * `base.py`: Базовый абстрактный класс action'a
      * `payment.py`: Реализация PaymentAction который обрабатывает все платежи
      * `adapters.py`: прослойка между сырыми данными ивентов/строк и action'ом, владеет знанием о том как
доставать данные из событий, а также абстрагирует класс от некоторых блоков логики, например выбор только актуальных строк
платежей(не реверснутых в нулевую сумму). Через секцию dynamic_row_getters манифеста есть частичная возможность
конфигурировать адаптеры, задавая в нем атрибут и значение/логику получения значения. Сам модуль содержит две большие сущности, первая -
это адатпер ивента. Базовый класс BaseEventAdapter и реализации MainEventAdapter и CompositeEventAdapter. MainEventAdapter
представляет адаптер вокруг ивента целиком, то есть ивента, который прилетел в калькулятор. CompositeEventAdapter - это
адаптер вокруг композитной компоненты события, которая ровным счетом такой же ивент как и шапка, но значения некоторых
полей различаются. Для некоторых полей даже когда строка-платеж находится в композитной компоненте - нужно смотреть
в шапку, отсюда необходимость отдельного класса обертки(нельзя оборачивать композитные компоненты в такой же
MainEventAdapter). Вторая сущность - RowEventAdapter, представляет собой собирательный контейнер, который содержит всю
информацию о строке, которая может понадобиться при тарификации - ивент в котором он находится(шапка или композитный),
рефанд, если это строка рефанда, и саму сырую строку. При обработке удобнее передавать контейнер, нежели разные сущности
по отдельности.
    * `entities`: специфичные для калькулятора модели(не описанные в библиотеке billing/library/python/calculator)
    * `accounts.py`: логика связанная со счетами, в частности подбор правильного счета к строке-транзакции(план счетов
описывается в манифесте) и построение инстансов аналитик
    * `const.py`: общие константы
    * `types.py`: описание часто использующихся типов, неудобно каждый раз заново задавать в каждом модуле/при каждом
использовании. Как правило это обобщающие типы, например Union[PaymentType1, PaymentType2], которые используются в
сущностях принимающих любой из перечисленных типов(наследование либо не всегда уместно, либо сложно
реализуемо(dataclass'ы)).
  * `faas`
    * `schemas`: специфичные для калькулятора схемы(не описанные в библиотеке billing/library/python/calculator)
    * `adaptors`: обертки-адапторы поднимаемые в фаасе. Реализуют faas интерфейс и задают поток обработки.
      * `base.py`:  базовый абстрактный класс с общей логикой
      * `payment.py`: адаптор PaymentAction'a
* `faas_calculators_settings`: faas.settings секции манифестов для разных сервисов, удобно использовать для локального
тестирования. Для этого нужно прописать переменную окружения:
`export FAAS_EXTRA_CONFIG_FILE=<arcaida_path>/billing/hot/calculators/trust/faas_calculators_settings/<settings_file>`
  * `faas.trust.settings`: настройки базового калькулятора, который используется лишь для тестирования. На нем
прогоняются интеграционные тесты
  * `faas.mail_pro.settings`: mail_pro калькулятор
  * `faas.music.settings`: music калькулятор
  * `faas.scooter.settings`: scooter калькулятор
  * `faas.games.settings`: games калькулятор



## Линтеры и проверки типов
Помимо прекоммитных хуков можно пользоваться командами и вручную:\
`mypy .`\
`isort .`\
`black .`

Вся конфигурация инструментов находится в файлах `pyproject.toml` и `setup.cfg`, при запуске из директории
`calculators/trust` они будут подтягиваться автоматически.

Также, для удобства можно воспользоваться следующими командами:\
`make style_check` - печатает ошибки типов/стилей и/или diff линтеров, никакие изменения к коду не применяются;\
`make style_run` - прогоняет линтеры и применяет изменения(black/isort).\

Более гранулярные команды можно посмотреть в самом Makefile'e.
