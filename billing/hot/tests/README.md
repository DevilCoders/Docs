## Интеграционные тесты нового биллинга

### Структура проекта

* `clients` - базовый функционал клиентов для различных компонентов биллинга:
  сервисов, очередей, СУБД, ...

* `config` - конфигурация общих компонентов для тестов

* `lib` - библиотека для удобства работы с тестами
  * `date` - удобное создание различных таймстемпов, дат в определенных форматах
  * `matchers` - кастомные матчеры ассертов, в основном на соответствие ответа хэндлера
  * `oebs` - обертка над клиентом логброкера, позволяющая имитировать
    взаимодействие с ОЕБС на высоком уровне абстракции
  * `polling` - модуль для ретраев асинхронных действий
  * `rand` - любой  рандом для тестов можно брать отсюда, сочетает в себе создание
    интов, токенов, uuid'ов, ...
  * `state` - создание стейта для обработки клиента в пайплайне, является аргументом
    многих клиентских функций, обогащая запросы общими параметрами
  * `templates` - загрузка и рендеринг шаблонов для запросов к клиентам,
    загрузка обеспечивает удобную работу с файлами шаблонов, рендеринг обогащает шаблоны данными
  * `testgen` - простое создание тестов в декларативном формате через написание групп действий, которые можно запускать параллельно.
    Про него подробнее ниже.
  * `util` - всякие мелочи, не относящиеся к логике тестов
  * `yav` - все про работу с секретами

* `integration` - все, что относится непосредственно к тестированию, здесь лежат тесты
  * `fixtures` - фикстуры для тестов, содержит инициализацию клиентов
* `templates` - шаблоны для различных запросов, заполнения таблиц, ...

### Как написать свой тест

Базовый сценарий можно посмотреть в [test_base.py](./integration/test_base.py)

#### Инициализация

Все необходимые взаимодействия с системами делаются через клиентов,
инициализирующихся в фикстурах.
Соответственно, нужно их подключить то, что нужно, из [conftest.py](./integration/fixtures/conftest.py).


#### Предобработка
Далее может понадобиться сделать некоторую предобработку в виде, например, создания по клиенту контрактов, счетов в табличке в yt.
Все это делается через билдер стейта, который на выходе отдаст собственно стейт, использующийся при запросах к сторонним системам.
Стейтов в тесте, конечно, может быть несколько.

#### Тестирование
Теперь идет непосредственно логика теста. Здесь выполняются запросы к компонентам
и проверяется корректность. Для формирования запроса следует использовать следующую схему:
Если в имеющихся шаблонах данные сильно отличаются от тех, на которых хочется проверять, то стоит добавить новый шаблон.
Если изменения незначительные, то можно загрузить шаблон, сделать необходимые правки и передать его в запрос,
где ваш шаблон обогатится общими данными из стейта и, возможно, еще сгенеренными данными, которые подставятся в рендерере.

Для запросов к СУБД можно использовать стандартные методы оберкти `clients/database/accounts/db.py:AccountsDB` или либо чистый sql или библиотеку sqlalchemy.
Примеры c ORM можно найти в общей библиотеке по [aiopg.sa](contrib/python/aiopg/README.rst)

#### Дебаг
В `run.log` лежат логи тестов вместе с записью про стейт, где есть request_id, по которому можно грепать логи в реальных окружениях.
Аналогично можно по request_id смотреть трейсы, например, [так](https://jaeger.yt.yandex-team.ru/billing-junk/search?service=accounts&tags=%7B%22http.request_id%22%3A%22c7bab6da7c66fffe3b600f1113dc1312%22%7D).
Оттуда можно получить хосты подов и, например, понять, был ли вызов batch/write из /v1/process.

### Запуск тестов
На текущий момент тесты запускаются только локально через `make test`, поскольку в CI нет доступов до наших сетей.
При отладке одного теста имеет смысл указывать флаг `--test-filename test_anything.py`, чтобы не запускать каждый раз все.
Все тесты предполагаются независимыми по стейтам - вся инициализация должна быть с нуля в каждом тесте и
все запросы в тестах должны забирать данные по сгенеренным айдишникам из стейта.
Только так можно максимально изолировать тесты друг от друга.

Чтобы они работали, нужны доступы до всех используемых компонент:
1) Тестовые базы accountsdb, payoutdb:
    - Секрет с паролем к payoutdb:
      - https://yav.yandex-team.ru/secret/sec-01et7zvf2grek64qf506pp7a34/explore/versions
    - Секрет с паролем к accountsdb:
      - https://yav.yandex-team.ru/secret/sec-01esgbpv1d80kqajc3bmxk8ts1/explore/versions

    Чтобы появился доступ, необходимо иметь роль "Разработчик" в одном из под-сервисов:
    - https://abc.yandex-team.ru/services/newbilling/services/
    
2) Доступ к секрету tvm токена ABC сервиса [newbillingtesting](https://abc.yandex-team.ru/services/newbillingtesting/)
3) Доступы на запись к тестовым таблицам в yt. Нужно иметь роль "Разработчик" в сервисах:
    - https://abc.yandex-team.ru/services/balance/
    - https://abc.yandex-team.ru/services/newbillingpayout
  
    Или запросить доступ явно:
    - https://yt.yandex-team.ru/hahn/navigation?navmode=acl&path=//home/balance/test

4) oauth токен в `~/.yt/token`

### Testgen
Простое создание тестов в декларативном режиме.
Хорош для необходимости запускать некоторые действия асинхронно и для простого задания нескольких одинаковых действий
Пример есть в `test_base.py`, достаточно определить свой Action и передать в раннер
набор ActionGroup. Действия внутри группы выполняются асинхронно, группы между собой упорядочены.
Каждое действие должно реализовывать интерфейс `lib/testgen/actions.py:Action`.
При первой ошибке тест завершается.

### TODO: Параллельный запуск тестов





