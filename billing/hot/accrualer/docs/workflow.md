# Описание работы [WIP]

Сервис состоит из нескольких воркеров, которые параллельно вычитывают входящие
потоки ([подробнее](transports.md#Входящие)) с событиями. Всего используются три потока события:

- поток из системы счетов - это первичный топик из которого сервис получает сообщения;
- поток ручных событий - это резервный топик, чтобы отправить какое-то либо событие не через систему счетов;
- поток событий взаимозачетов - это внутренний топик, в котором крутятся события взаимозачета пока не будут готовы
  расписанные события связанные с ним.

В соответствии с конфигом
приложения ([тест](https://a.yandex-team.ru/arc_vcs/billing/hot/accrualer/deploy/logic_test.yaml)
и [прод](https://a.yandex-team.ru/arc_vcs/billing/hot/accrualer/deploy/logic_test.yaml)) определяется, что делать с
каждым конкретным событием.

События можно условно разделить на 3-4 категории:

- событие взаимозачета;
- событие надо обработать сразу - в нем есть вся информация для начисления;
- событие надо отложить, чтобы потом получить из расписанных - требуется фактическая сумма для начисления;
- особые виды событий (например, удержания в пользу третьих лиц у такси).

Для определения к какой категории относится события для каждой задается набор фильтров. В общем случае фильтр содержит 3
части события:

- `loc` - название счета `event.loc.type`;
- `side` - сторону счета `event.type`;
- `batch` - название операции/батча `event_batch.type`.

Если какое-то из этих полей не задано, то оно не будет участвовать в фильтрации и игнорируется.

Фильтры так же могут содержать какие-то уникальные для нейспейса поля для сравнения (например, так сделано у `bnpl` для
возвратов), в таком случае они указываются в поле `filter` в формате `ключ: значение`, на данный момент значение
проверяется на строгое равенство и работает только для строк.

```yaml
namespace:
    bnpl:
        accruals:
            types:
                agencyFull:
                    events:
                        -   loc: cashless_refunds
                            batch: "bnpl:cashless"
                            type_cc: bnpl_canceled
                            format: bnpl_base
                            filter:
                                refund: canceled
                        -   loc: cashless_refunds
                            batch: "bnpl:cashless"
                            type_cc: bnpl_refunded
                            format: bnpl_base
                    event_fields:
                        refund:
                            path: [ "event_batch", "info", "payload", "cancel_reason" ]
                            type: string
```

При обработке событие проходит все фильтры по очереди сверху вниз в порядке их описания, поэтому более общий фильтр
стоит ниже. В зависимости от того, под какой фильтр подошло событие определяется, что с ним дальше делать:

1. отправить в дополнительный поток по актам (stream only);
2. сформировать агентское начисление;
3. сформировать расходное начисление (stream only);
4. отправить в поток взаимозачетов (stream only).

Для каждого из этих сценариев есть соответствующие обработчик.
На данные момент варианты 1 и 3 работают только для входящих событий, вариант 2 доступен для расписанных (marked)
событий. Вариант 4 так же доступен только для входящего потока и не имеет смысла для расписанных событий, подробнее про взаимозачет [тут](nettings.md).

### Сервисы в коммунальном топике[^1]:

- Оплаты - partition id `0`
- BNPL - partition id `1`
- Plus/FIFO - partition id `2`
- Почта Про - только в актах
- BNPL income - только в актах

[^1]: В настройках конфигурации указываются partition group,
которые [на 1 отличаются](https://logbroker.yandex-team.ru/docs/concepts/resource_model#partition-group) от partition id
и нумеруются с 1.
Указание partition group `0` дает случайную партицию на старте.
