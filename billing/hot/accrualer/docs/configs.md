# Конфигурация

Конфиг приложения состоит из трех частей:

- [системный конфиг](https://a.yandex-team.ru/arc_vcs/billing/hot/accrualer/config/dev/accrualer.yaml): данные для
  подключения к базе, сервисные топики в LB, webserver
- [логический конфиг](https://a.yandex-team.ru/arc_vcs/billing/hot/accrualer/config/dev/logic.yaml):
  описывает поведение приложения в зависимости от типов полученного сообщения (когда обрабатывать, в какой топик
  отправить, как сформировать начисление)
- [конфиг с форматом](https://a.yandex-team.ru/arc_vcs/billing/hot/accrualer/config/dev/formats): это набор файлов с
  правилами по созданию начисления (в какое поле какое значение положить)

Сейчас есть три окружения для конфигов:

- [dev](https://a.yandex-team.ru/arc_vcs/billing/hot/accrualer/config/dev/) - для локального запуска и запуска тестов
- [test](https://a.yandex-team.ru/arc_vcs/billing/hot/accrualer/config/test/) - для работы в тесте
- [prod](https://a.yandex-team.ru/arc_vcs/billing/hot/accrualer/config/prod/) - для работы в проде

Конфиги в этих окружениях независимы между собой и это надо учитывать внося правки только в один из них - в других
изменения форматов и/ли логики не будет видно.

## Конфиг логики

В конфиге два внешних ключа:

- `namespace` - содержит описание поведения для конкретных нейспейсов (фильтры, топики, путь на YT);
- `event` - основные поля из события, они или от системы счетов (`namespace`, `id`, `info`, `amount`) и не меняются или
  из тарификатора, но по договоренностям они обязательно присутствуют и не меняют свою локацию (`dry-run`).

Внутри словаря `namespace` ключом является собственно название неймспейса (`bnpl`, `plus`), к которому относятся фильтры
и другие настройки. Конфиг для одного неймспейса состоит из двух частей:

- `acts` - описание для событий для актов;
- `accruals` - описание для формирования начислений.

### Акты

Сейчас есть только агентские акты (ключ `agency`). Для них описывается в какой топик их надо отправлять (`default`
и `dry-run`), а так же какие события нужно отправлять в эти топики. Кроме фильтра по типу события требуется указывать
знак для учета этого события в будущих актах (`"+1`, `"-1"`).

**Важно**: сейчас по договоренности все события для актов льются в один топик, на это поведение есть юнит-тест.

### Начисления

Конфиг по начислениям состоит из нескольких частей:

1. `types` - указание типов событий с их форматам по каждому классу обработки начислений;
2. `netting` - фильтр для событий взаимозачета (ключевое событие для получения детализации);
3. `ignore` - список событий для игнорирования;
4. `marked_events` - путь на YT, где лежат расписанные события (обычные и для `dry-run`).

В п.1 в качестве формата указывается имя файла из директории с форматами без промежуточных директорий и без расширения.
При указании несуществующего формата будет ошибка в тестах, даже если нет примеров событий на этот фильтр.

## Конфиг формата

Все конфиги с форматами лежат в отдельной директории от остальных конфигов и подключаются сразу все, поэтому если в
одном из них будет ошибка, то приложение не запустится. Название всех файлов должно быть уникально, чтобы не было
проблем с выбором формата по имени. Для удобства можно создавать промежуточные директории, чтобы все не лежало в куче.

Конфиг с описанием формата состоит из двух частей:

- `input` - описывает переменные по данным исходного события;
- `output` - описывает значения для итоговых полей начисления;
- `type` - тип начисления (`agency`, `spendable`), которое формирует этот формат, по умолчанию `agency`; в зависимости
  от значения есть разные проверки на описание формата.

Валидным значением для итогового поля может быть:

- литерал
- переменная определенная в первой части конфига
- операция преобразования; принимает на вход литерал, переменную или другое преобразование
