# Модуль tasks

В tasks запускаются регулярные задачи. Всего их сейчас 4:

- Payout Partitions
- CPF Partitions
- Clean Requests
- Refresh MV

Константы определяются в yaml-файле (`payout/deploy/payout.deploy.yaml` и `payout/deploy/payout.test.deploy.yaml`)
Таски запускаются при рестарте подов, а затем -- с интервалом в `interval` часов.

###  Payout Partitions
Таблица `t_payout` партиционирована по дате создания выплаты. Этот таск:
1) создает партиции на `NextPeriods` дней в будущее;
2) добавляет индексы и триггер для таблицы `t_payout_history`;
3) выдает права на схему и все таблицы пользователю `replicator`.
### CPF Partitions
Выполняет описанные выше пункты 1 и 2 для таблицы `t_cpf`
### Clean Requests
Очищает старые заявки на выплату. Старыми считаются заявки, созданные ранее `OldKeepDays` дней назад.
### Refresh MV
Обновляет Materialized View `mv_payout`

## Про advisory locks
В конкретный момент времени нужно, чтобы каждый таск запустился один раз.
Так как подов несколько, все они пытаются выполнить таски одновременно и мешают друг другу.
Чтобы такого не происходило, мы используем `advisory locks`.
Для каждого таска зарезервирован свой ID (просто число: например, 666).
Первый под, который успел взять advisory lock, и будет выполнять таск.
Остальные поды не смогут взять блокировку и будут ждать следующего запуска через `interval` часов.
