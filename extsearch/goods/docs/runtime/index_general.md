# Индексация
## [Про релизы](../duty/index_releases.md)
## Общее устройство
После сборке поколения индекса, в sandbox появляется ресурс MARKET_REPORT_DIST_META с данными про это поколение. По нему таска [MAKE_GOODS_SHARDMAP_GENCFG](https://a.yandex-team.ru/arc_vcs/sandbox/projects/goods/MakeGoodsShardmapGencfg/__init__.py) умеет строить шардмапу. Сама таска крутится в хитмане в процессе [release_goods_index](https://hitman.yandex-team.ru/projects/goods-runtime/release_goods_index/). Каждые 12 часов берётся последее готовое поколение, строится шардмапа и автоматически расскатывается на репорты через [дашборд](https://nanny.yandex-team.ru/ui/#/services/dashboards/catalog/goods-report)

## Sandbox таска
[MAKE_GOODS_SHARDMAP_GENCFG](https://a.yandex-team.ru/arc_vcs/sandbox/projects/goods/MakeGoodsShardmapGencfg/__init__.py) \
Таска оперирует с ресурсом MARKET_REPORT_DIST_META. Внутри ресурс MARKET_REPORT_DIST_META содержит торрент ссылки на разные куски индекса (шарды, дссм и другие файлы). Сами файлы живут не очень долго (порядка нескольких дней), поэтому по старым ресурсам может не получиться построить индекс. По умолчанию, таска находит последний из ресурсов с индексом ТВ (у ресурса атрибут "is_turbo": "true"), по нему строит 8 шардов (в каждом по 2 реальных шарда) с помощью подтаск + доп ресурс GOODS_REPORT_DATA, в котором лежат разные dssm, мапинги и данные для генерации конфигов (данные о всех бекендах). Подтаска [MAKE_GOODS_SHARD_GENCFG](https://a.yandex-team.ru/arc_vcs/sandbox/projects/goods/MakeGoodsShardmapGencfg/__init__.py?rev=r9167546#L67) находит в дист файле нужные торренты, выкачивает их и распаковывает. Собранные шарды живут месяц.

Сама шардмапа предсталвяет из себя текстовый файл, где для каждого хоста записан торрент файл с шардом. Собственно при релизе шардмапы няня находит в этом файле хост и выкачивает для него указанный торрент файл. Список хостов берётся из report-data ./backend/backends_config.json -- там для каждой машинки свазанной с маркетом написан список шардов.

### Параметры:
* market_report_dist -- в таску можно передать конкретный ресурс MARKET_REPORT_DIST_META, по которому надо построить шардмапу;
* indexer -- указывает, с какого из серверов нужно искать индекс. По умолчанию берёт с любого (просто самый свежий), если указан конкретный -- добавляеть фильтрацию по атрибуту "mi_type" при поиске дист ресурса (в этот атрибут записывается, на каком сервере построен индекс);
* generation -- конкретное поколение, по которому надо построить шардмапу. Доавляет фильтрацию дист файла по атрибуту "generation". Нужно учитывать, что работает вместе с параметром "indexer" -- если его не перевести в состояние "any", то поколение будет искаться в указанном сервере;
* use_production_check -- добавляет [проверки](https://a.yandex-team.ru/arc_vcs/sandbox/projects/goods/MakeGoodsShardmapGencfg/__init__.py?rev=r9167546#L169) на корректность атрибутов дист файла ("not_for_publish": "false", "env_type": "production" и др.). Также с этим флагом таска проверяет, что найденное поколение моложе последней релизнутой шардмапы (находит самую свежую шардмапу с "released": "stable" и сравнивает атрибуты "generation").

## Nanny-сервисы
В няню приезжает 2 ресурса: GOODS_REPORT_DATA на вкладке Files и GOODS_BASESEARCH_SHARDMAP на вкладке Shard. Настроена тикет индеграция с автокоммитом. Когда в сб таске прожимают релиз, на репортах появляется снепшот с индексом.

Сами файлы лежат в контейнере. Репорт смотрит на них не напрямую, а через ссылки -- вся структура файлов репорта осталось прежней. Репорт смотрит в папку ./data/search. Там соответственно есть папки ./data/search/report-data, которая ведёт на ./report-data/report-data и ./data/search/index -> ./shard/shard. Двойные вложенные папки -- артефакт няни. Линки проставляются на preparing стадии. Скриты для этого можно посмотреть на Files -> custom_httpsearch и Instance Spec -> report-prepare_ . \
Все файлы лежат на ссд, выкачиваются на preparing примерно за 30 минут. Также на каждой активации няня запускает "проверку" файлов индекса: репорт трогает папку шарда (видимо добавляет какие-то доп файлы) и меняется checksum ресурса. Из-за этого на activating появляется статус ENTITY_RESOURCE_NOT_READY. Няня пишет, что она выкачивает шард заного, но на практике она просто проверяет эти файлы на 1-2 минуты. \
Сам индекс грузится напрямую в память. За это отвечает флаг "IndexWarmupMode=2" в конфиге репорта.

{% note warning %}

Очень не советую катать GOODS_BASESEARCH_SHARDMAP и GOODS_REPORT_DATA отдельно. По файлу GOODS_REPORT_DATA репорт генерит конфиг и если катать эти файлы отдельно, то на машинку может приехать один шард, а сгенерировать конфиг под другой.

{% endnote %}
