# Релизы индекса
## [Общая информация про индекс](../runtime/index_general.md)

## Основной пайплан
В хитмане в проекте goods-runtime крутится процесс [Release goods index](https://hitman.yandex-team.ru/projects/goods-runtime/release_goods_index). В параметрах процесса указан текущий сервер индексации, basket_id, pool для скрепера и пр. параметры. Через кнопку "Добавить параметр" можно перезаписать любой параметр без переделк графа (выбираем нужный кубик/глобал, имя параметра и значение).

## Подробнее про граф
### Глобальные опции
В глобальных опциях вынесены основные параметры. Также там есть набор флагов -- Release index, Launch beta и т.п. Это флаги для настройки поведения графа. Например, если вы хотите только снять оффлан с индекса, без релиза, надо снять флаг с "Release index" и "Send notification" (чтобы не прилетели алёрты в чаты).

### Make Goods Shardmap Gencfg
Кубик запускат сб таску MAKE_GOODS_SHARDMAP_GENCFG, которая собирает ресурс с шардмапой. Основные параметры:
* indexer -- сервер индексации,
* use_production_check -- для всяких проверок "коррекности" (в основном смотрит на флаги поколения, что оно обычное). [Код](https://a.yandex-team.ru/arcadia/sandbox/projects/goods/MakeGoodsShardmapGencfg/__init__.py?rev=r9535798#L221) про это,
* generation -- чтобы запустить с конкретным поколением.

Если он падает, нужно идти в таску и смотреть, что ей не понравилось (на самом кубике есть ссылка на таску).

### Create beta by shard task
Внутри запускается пограф. В нём много кубиков, но почти все они про разные курлы для сбора информации и перекладывание джсонов. Сожержательный только кубик CREATE_YAPPY_BETA Sandbox task. Собственно он запускает бету с ресурсом шардмапы. Из опции подграфа важные:
* template_name -- имя шаблона в яппи,
* beta_consistency_timeout -- время в секундах, за которое бета должна подняться.

Имя беты состоит из "goods-report-{поколение}-{timestamp}". Если граф падает, нужно идти смотреть на бету (или на странице яппи нати бету, или открыть таску CREATE_YAPPY_BETA, там будет ссылка на бету). Обычно или кончились слоты (тогда удалить что-то из старого), или бета не успела подняться за таймаут (тогда нужно идти на сервис и разбираться, что не так).

### Launch index serps
Подграф со снятием метрик. По своей логике это почти копия графа экспериментов из метрикса. Там много текстовых кубиков с конфигами для метрикса, все важные параметры метрикаса вынесены в глобальные параметры и подставляются автоматом. На время скачки серпов сервис в няне ставится на паузу. Основные параметры:
* basket_id -- номер корзинки,
* aspect -- аспект,
* common-cgi -- cgi для снятия метрик,
* yt-pool -- пулл для скрепера,
* max-runnig-jobs -- кол-во потоков при снятии (рпс).

Если упал/завис кубик Download Serps, вероятно забилась квота. Лучше сходить в чат девопсов и спросить про это. С остальными кубиками надо идти в метрик и смотреть, что случилось. 

### Checks and notification
Подграф проверяет корректность метрик и присылает отбивки в чаты. [Конфиг](https://a.yandex-team.ru/arc/trunk/arcadia/extsearch/goods/indexer/nirvana/index_serps_metrics.json) для проверки метрик. Каждая провека содержит: 
* Имя метрики
* (опционально)value_allowed_diff -- границы изменения значения метрики, которые мы считаем нормальными
* (опционально)perc_allowed_diff -- то же самое, только дифф в процентах
* check_type (CRIT = упади в случаи выхода за границы, остальное -- просто залогируй). Нужен, чтобы новую метрику можно было покрутить несколько дней и посмотреть, какой у неё обычно дифф, а уже потом поставить для неё границы.
{% note warning %}

После коммита в конфиг нужно поменять revision в параметрах в хитмане.

{% endnote %}

Присылаются 2 отбивки: одна (index.hitman.serps_info) в чат некритичных алёртов с описанием всех метрик. Присылается всегда. Вторая (index.hitman.serps_checks_error) присылается в чат крит алёртов, если какая-то из критичных метрик вышла за границы. Во обоих отбивках указано имя поколения и ссылка на метрикс.

По флагу fail-on-checks-error граф падает, если хотя бы одна из метрик вышла за границы.

### Release goods shardmap
Подграф выполняет релиз поколения. Релизтся ресурс и запускается рецепт из дашборда [goods-report](https://nanny.yandex-team.ru/ui/#/services/dashboards/catalog/goods-report) в няне, который выкатывает индекс. Также в чат девопсов приходит 2 отбивки: о начале релиза и о его окончании. Важные параметры:
* release-type -- тип релиза. По умолчанию stable, чтобы раскатить на хамстер нужно выбрать prestable
* deployment_nanny_dashboard_recipe -- отдельный рецепт для прода и хамстера


## Основные сценарии
{% note warning %}

В большинстве сценариев нужно в девопс чате призывать дежурного. Как для опевещения о том, что с сервисом совершаются действия, так и для передачи проблемы дежурному, чтобы он сам выполнил все действия.

{% endnote %}

### Только собрать оффлайн
Клонируем граф, убираем флаги "Release index" и "Send notifications" (или просто удаляем соответствующие кубики).

### Только релиз индекса.
Удаляем "Launch beta", "Launch serps", "Send notifications". Или опять же удаляем кубики.

### Выкатить индекс с упавшими проверками.
Если упали проверки, но мы считаем, что всё ок и можно катить, то нужно склонировать граф и убрать флаг "Fail on checks error".

### Переключение сервера индексации
Чтобы процесс поменять сервер, нужно в хитман процессе поменять параметр "release_goods_dynamic_resource -> indexer" на turbo.stratocaster/turbo.gibson. После этого следующий запуск пробросит в сб таску это новое значение. 

{% note warning %}

Стоит проконтролировать первую после смены выкладку индекса. Во-первых, сам индекс с нового индексатора может оказаться проблемным, например из-за новой логики. Во-вторых, таска берёт последний дист ресурс и в теории может взять с нового сервера ресурс, который построили до переключения -- он также может оказаться проблемным

{% endnote %}

### Зафризить поколение
Идём в [хитман](https://hitman.yandex-team.ru/projects/goods-runtime/release_goods_index) и ставим процесс на паузу. 

### Откатить индекс

#### В процессе релиза
Во-первых, идём на [дашборд](https://nanny.yandex-team.ru/ui/#/services/dashboards/catalog/goods-report). Сверху будет "deployment(s) in progress", кликаем, находим там наш релиз и прожимаем Reject. Можно в принципе отменить так все релизы, если их несколько.

Во-вторых, нужно откатить сам релиз. Два основных способа:
1. Руками проходим по всем прод сервисам и откатываем снепшот. Снепшот репорта начинается с "Release goods gencfg shardmap". Около снепшота выбираем "Rollback" и выбираем рецепт "several_cluster_at_once". На тех сервисах, где ещё не раскатился релиз, нужно переключить current снепшот -- на них кликаем по снепшоту, что в состоянии Active, и нажимаем "Set as current". Если вы ни разу не откатывали через дашборд -- это ваш способ;
2. Идёт в [дашборд](https://nanny.yandex-team.ru/ui/#/services/dashboards/catalog/goods-report), вкладка Revert. Там вверху будут варианты снепшотов с какого/на какой откатится. Находим снепшот индекса, прожимает "from". Дальше идём в рецепты и запускаем деплой через revert_recipe_no_locks. \
  Что происходит: дашборд переключает current снепшот на всех сервисах и дальше мы их "выкатываем" через рецепт. Рецепт начинает с вла -- чтобы откатить сначала частично сломанные локации, а одну из сломанный можно закрыть. Этим способом не нужно ходить по всем серисам и переключать тикеты + рецепт сам прокатит всё.

#### На конкретное версию.
Если снепшот с нужным покалением остался в няне (что маловероятно), то просто активируем этот снепшот на сервисе (рецепт "several_cluster_at_once"). \
В остальных случаях нужно найти таску с этим поколением. Два способа:
1. Идём в [хитман](https://hitman.yandex-team.ru/projects/goods-runtime/release_goods_index), находим нужный запуск -- по поколению можно прикинуть время запуска. Открываем граф этого запуска, выбираем кубик с MakeGoodsShardmapGencfg, там сверху будет ссылка на таску.
2. Идём сразу в sandbox, вкладка Resources. В Reource type прописываем GOODS_BASESEARCH_SHARDMAP, в Attributes добавляем "generation" и там нужное вам поколение. Он найдёт ресурс с шардмапу, можно сразу открыть таску.

У таски прожимаем release (галочка сверху, рядом с кнопками старт/стоп), выбираем stable. Должен появится снепшот на сервисах. Его коммитить отдельно не надо, просто катим через дашборд рецептом auto_deploy_goods_report_with_locks_queue.

### Раскатить конкретное поколение.
Через хитман процесс открываем граф, клонируем. В глобальный опциях прописываем нужно поколение. Запускаем граф. Он сам соберёт поколение (с прод проверками), и раскатит его везде.\
Можно то же самое сделать "руками" -- запустить в сб таску, прожать у неё релиз и раскатить через дашборд. Возможно нужно будет убрать флаг use_production_check (например, он не даст выкатить более старое поколение, чем в проде).

### Раскатить поколение на хамстер
Аналогично прошлому пункту, можно через граф, можно руками.
В графе в глобальных опциях задаём поколение. Проставляем release-type prestable. В deployment_nanny_dashboard_recipe выбираем hamster_recipe. Убираем флаг use_production_check (обычно на хамстер катаем немного странные поколения для тестов). Также можно прописать indexer = any. Это всё в глобальных опциях, кубики сами всё подхватят. \
За релизом можно будет следить на [дашборде](https://nanny.yandex-team.ru/ui/#/services/dashboards/catalog/goods-report).

### Расскатить на конкретный мк.
Выглядит как обычный релиз до момента активации на сервиса. Собираешь шардмапу, отправляем её на релиз. На сервисе появится снепшот с релизм. Препейрим его. Теперь есть 2 способа:
1. Идём в няне в Recipes, для рецепта several_cluster_at_once опцию cluster_at_once ставим 1, сохраняем. Теперь активируем снепшот с этим рецептом. Он начнём катить кластера по одному. После активации на снепшоте нажимаем на Taskgroup. Там будет несколько окон вида "Activate ... mini-cluster #..". Кликаем по "mini-cluster #1" и прожимаем кнопку Block. Теперь активация остановится после певого миникластера. Для безопасности стоит переключить current на предыдущий тикет -- иначе если сверху придёт другой релиз, он прокатит на весь сервис.
2. Через [пингер](http://mi-turbo01v.market.yandex.net/yandex/report-pinger/ping.py) находим нужный миникластер, по нему находим машинки этого мк (ну или другим известным вам способом). В няне около снепшота нажимаем Instsance, там будет список всех машинок. Находим там нужные машинки (для удобства поиска можно внизу поставить по 100 инстансов на странице). Около машинки жмём на колёсико -> Active -> Apply. Так для всех машинок мк.

Для безопасности в обоих случаях стоит переключить current на предыдущий тикет -- иначе если сверху придёт другой релиз, он прокатит на весь сервис.
