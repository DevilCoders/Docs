# Беты
## Общее устройство
Беты живут в [yappy](https://yappy.z.yandex-team.ru). Основные вкладки:

1. Betas (главная). Здесь список всех поднятых в яппи бет. Беты репорта ищутся по "goods-report". Основное назначение -- найти свою бету или посмотреть, сколько вообще бет поднято.
2. Quats. Квота "goods_report_quota". В ней можно посмотреть все сервисы в няне, на которых поднимаются беты и редактировать этот список. Также можно увидеть, какие сервисы сейчас заняты и какими именно бетами.
3. Templates. Список шаблонов, по которым создаются беты. Наш goods-report. Собственно на его страницы происходит создание бет, настройки проверок и пр.

Сервисы с бетами в няне лежат по пути "/goods/report/beta/". Они начинются с "goods_report_beta_". В каждой локации по 2 сервиса. Также есть сервис [goods_report_beta_template](https://nanny.yandex-team.ru/ui/#/services/catalog/goods_report_beta_template) -- это шаблон, с которого копируются все новые меты. Это сервис без инстансов в который приезжают все релизы прода. Любые глобальные фиксы для бет (например, фиксы в скрипты установки/instance_spec) нужно проводить с этим сервисом -- эти патчи автоматом раскатятся на все беты.

Во время поднятия беты, яппи находит незанятый сервис, копирует в него шаблонный сервис + накладывает патч.

## Как поднять бету
{% note tip %}

Настоятельный совет удалять беты после окончания пользования, чтобы не занимать зазря слот. Всегда можно будет создать заного.

{% endnote %}

1. Заходим на вкладку Templates, находим там [goods-report](https://yappy.z.yandex-team.ru/templates/goods-report/create). Create -> goods-report -> __default__ . Листаем вниз, находим пункт Resources.
2. Чтобы добавить любой обычный ресурс (из вкладки Files в няне), например бинарь репорта, прописываем в "Local path" локальный путь из няни (report, report_ctl, formulas и т.п.). Нажимаем "Add resource". Появится новая строчка. В ней в поле Content записываем id sandbox ресурса. В Storage выбираем SSD. Так можно добавлять любое кол-во ресурсов.
3. Чтобы добавить в патч шард, придётся написать в конфиг руками. Патч для шардмапы выглядит тaк:
    ```
    "resources": [
        {
            "manageType": "SANDBOX_SHARDMAP",
            "localPath": "shard",
            "storage": "/ssd",
            "sandboxResourceId": "ID"
        }
    ],
    ```
    ID -- айди ресурса PLAIN_TEXT (это специальная шардмапа для бет) из таски MAKE_GOODS_SHARDMAP_GENCFG, которая собрала нужную шардмапу. К сожалению яппи не умеет подтягивать шардмапу по айди таски, поэтому нужно копировать айди ресурса.

    В итоге общий патч может выглядить примерно так:

    ```
    {
        "resources": [
            {
                "manageType": "SANDBOX_RESOURCE",
                "localPath": "report",
                "sandboxResourceId": "2920885123"
                "storage": "/ssd"
            },
            {
                "manageType": "SANDBOX_SHARDMAP",
                "localPath": "shard",
                "sandboxResourceId": "2920885456",
                "storage": "/ssd"
            }
        ],
        "parentExternalId": "goods_report_beta_template",
        "copyCoredumpPolicy": true
    }
    ```
4. Если вы добавляли шардмапу, нажимаем "Clean and validate" вверху формы. Это нужно, чтобы часть с шардом сохранилась -- интерфейс яппи из-за неё криво отображается
5. Нажимаем "Create beta". Появится форма с суффиксом для беты. Лучше писать туда логин + что-то ещё. Это поможет другим понимать, чья это бета сейчас поднята и кто занял слот.
6. Перекинет на страницу беты. Там через какое-то время появится ссылка на няни сервис (на нём можно следить за активацией). Настоятельно советую зайти и проверить, что сервис не стоит на паузе.

{% note warning %}

По дефолту бета живёт 12 часов (1 рабочий день). Чтобы продлить, нужно на странице беты в яппи открыть вкладку JSON, внизу будет параметр ttl (в часах). Меняем, нажимаем "Clean and validate" и "Submit".

{% endnote %}

{% note warning %}

Беты автоматически обновляются, когда на шаблон приходят изменения. Если вы меняли только бинарь, а на шаблон/прод приехал свежий индекс, то он начнёт катиться на вашу бету и может привести к неожиданному даунтайму. Как вариант обхода, можно ставить сервис на паузу. Только не забудьте её убрать, если будете обновлять патч.

{% endnote %}

## Обновление поднятой беты
1. На вкладке JSON руками редактировать patch. Не забывает сделать "Clean and validate" и "Submit".
2. Вкладка Components, кликаем на "Patch". Там в том же формате, что при заведении беты. Также через "Clean and validate" и "Submit"

## Как пользоваться поднятой бетой
1. Через интерфейс беты. На вкладке "Summary" будет поле для поискового запроса. Это собственно обычный поиск, только запрос для колдуна пойдёт в бету (временно не работает для колдуна)
2. Через domain беты. На той же вкладке есть строка вида "goods-report-{...}.hamster.yandex.ru". Её можно подставлять в хост в запрос (например "http://goods-report-72-0.hamster.yandex.ru/products/search?text=телефон". Собственно это имя беты + hamster.yandex.ru. В этой схеме все машинки подменяются сами (временно не работает для колдуна).
3. Через srcrwr. Берём любую машинку с сервиса няни. Для мейна к запросу нужно будет дописать `&srcrwr=MARKET_REPORT_PROXY:имя_машинки:17060` . Для параллельного `&srcrwr=PRODUCTS:имя_машинки:17050`
4. Для врезки на данный момент бета как есть не будет работать, но наши лучшие инженеры это уже исправляют. Чтобы сходить на бету и увидеть врезку, надо к запросу добавлять `&rearr=market_offers_wizard_for_products=1&rearr=market_parallel_use_products_grouping=1&rearr=market_parallel_sku_search_without_models=1`.

## Бета не работает
Частые кейсы проблем с бетой.
### Сервис на паузе
Иногда люди ставят беты на паузу, чтобы снять оффлайн, и забывают отжать обратно. Из-за этого новый снепшот при создании беты не будет активироваться. Советуем  всегда при создании беты зайти на сервис и проверить, стоит ли он на паузе. Если да, отжимаем -- теперь снепшоты начнут активироваться
### Проблемы на PREPARE стадии
В любом случаи стоит зайти на машинку и почитать report-prepare.err и loop.log.full, есть ли там ошибки.
* Если инстансы висят на PREPARE с ENTITY_RESOURCES_NOT_READY -- скорее всего нужно просто ждать. Это обычно обозначает выкачку ресурсов. Индекс большой по размеру и долго выкачивается. Обычно сервис выкачивает все ресурсы 20-40 мин. Если вы ждёте уже около часа, стоит сходить в девопс чат и попрость о помощи.
* Если инстанс повис с ISS_HOOK_INSTALL_IN_PROGRESS. Также если в логе есть "Current instance is not in instances list". Вероятно yp делал замену пода и для нового пода не генерится конфиг. Идём в Files, пролистываем вниз и ищем файл "instances_numbers.json". В нём для каждого сервиса прописаны номера (да, автоматикой это не получилось нормально сделать). У каждого инстанса на сервисе есть номер (например "goods-report-beta-vla2-{номер}.vla.yp-c.yandex.net"). Проверяем, есть ли он там. Если нет, то идём на сервис [goods_report_beta_template](https://nanny.yandex-team.ru/ui/#/services/catalog/goods_report_beta_template/files#instances_numbers.json) и меняем этот файл, чтобы номера инстансов совпадали. Номеров должно быть 8 штук.
### Бета повисла с HOOK_SEMI_FAILED.
Скорее всего проблемы в вашем патче. Можно попробовать удалить какие-то/все файлы из патча и посмотреть, поднимется ли бета. Если бета не поднимается на дефолтном (пустом) патче, стоит отнести эту проблему в чат девопсов.

## Удаление беты
В интерфейсе яппи на странице беты внизу слева будет 3 кнопки: "Stop", "Clone", "Delete". Прожимаем "Stop", потом "Delete". После этого яппи удалит бету и освободит слот. Рекомендую удалять бету после пользования.

## Релизная машина.
При отведении ветки/тега CI процесс в релизной машины создаст для неё бету. Имя беты будет примерно "goods-report-номер_ветки-номер_тега". У неё в патче будет только бинарь репорта. Её можно использовать для тестирования как и все другие беты.

## Добавление слотов под беты
Если понадобилось добавить слотов под беты, нужно добавить новый сервис в квоту.
1. Копируем шаблонный сервис [goods_report_beta_template](https://nanny.yandex-team.ru/ui/#/services/catalog/goods_report_beta_template). Новый ставим галочку "Copy authorization attrs". Название и расположение сервиса по аналогии с другими бетами.
2. Добавляем в сервис поды. Проще всего открыть список подов на существующей бете, Actions->Copy pod. Откроется окно как при добавлении пода. Копируем все поля оттуда в новый сервис (руками). "Replicas count" ставим 1, "How to name pods" -- Enumerated replicas. В секции "Pod labels", для "replica" ставим значение 0. "Pod annotations" можно не копировать. Прожимаем Allocate, мы создали первый под.
3. Теперь создаём остальные 7. Копируем наш созданный под, меняем у него "replica" на 1, аллоцируем. Для следующего ставим 2 и т.д. Няня не умеет это делать автоматом, поэтому придётся руками создать таким образом все шарды. Должно получиться 8 инстансов со значениями "replica" от 0 до 7.
4. Заходим на вкладку Instances, включаем наши новые инстансы, сохраняем.
5. Нужно выдать сервису доступ к секретам. Заходим в "Instance spec", пролистываем вниз до секции "Instance data volumes". Нас интерессуют секреты со срочками "Keychain" (их должно быть минимум 3). Кликаем по тому, что записано в "Keychain", в новом окне справа вверху будет "Edit keychain". В самом низу "Add service" -> добавляем наш сервис. Глазами проверяем, что он есть в списке. Сохраняем. Повторяем для всех секретов с "Keychain".
6. Идём во вкладку Files, находим файл "instances_numbers.json". Добавляем строчку для нового сервиса с номерами инстансов  для него (в начале это обычно от 1 до 8). Проследите, что на последней строчке нет запятой в конце -- такой json не распарсится. Сохраняем.
6. Активируем сервис. Если сервис завис на PREPARE и инстансов скачет состояние (HOOK_FAILED, ISS_HOOK_INSTALL_IN_PROGRESS) -- вероятно забыли добавить в какой-то из секретов. Если завис на ISS_HOOK_INSTALL_IN_PROGRESS (или в логах есть "Current instance is not in instances list"), то возможно кривой файл "instances_numbers.json". Это лучше искать по логам loop.log.full и report-prepare.err (если второго стабильно нет -- скорее всего секреты). Ждём успешной активации.
7. Идём обратно в шаблонный сервис [goods_report_beta_template](https://nanny.yandex-team.ru/ui/#/services/catalog/goods_report_beta_template), в файле "instances_numbers.json" вносим те же изменения, что и на новом сервисе (можно просто скопировать содержимое). Сохраняем.
8. Идём в яппи, в квотах находим "goods_report_quota". JSON -> добавляем туда наш новый сервис -> Submit

Всё готово. Можно для теста насоздовать пустых бет, пока не попадём в новый сервис и проверить, что он нормально активируется.
