# Релизы
[заглушка](https://wiki.yandex-team.ru/serp/ecom/goods/runtime/releases)

## Репорт
### Релизная машина
[https://rm.z.yandex-team.ru/component/goods_report/manage](https://rm.z.yandex-team.ru/component/goods_report/manage)

При отведении ветки запускается CI процесс. Основные шаги:
1. Build. Таска, которая собирает бинарь репорта. Настройки примерно [здесь](https://a.yandex-team.ru/arc//trunk/arcadia/sandbox/projects/release_machine/components/configs/goods_report.py?rev=r9555870#L30)
2. GenerateBeta GoodsReport Goods. Таска поднимает бету с новым бинарём. [Настройка в конфиге](https://a.yandex-team.ru/arc//trunk/arcadia/sandbox/projects/release_machine/components/configs/goods_report.py?rev=r9555870#L136). Если падает, то или проблема с новым бинарём, или закончились слоты. В самой таске есть ссылка на бету (строка в стиле "Start and wait for beta consistency: goods-report-...").
3. Shooting* кубики. Это обстрелы беты через лунапарк. Патроны варятся автоматом по логам. В таске ShootingAssessment содержатся ассёрты и ссылка на стрельбу. [Настройки](https://a.yandex-team.ru/arc/trunk/arcadia/sandbox/projects/release_machine/components/configs/goods/goods_shooting.py?rev=r9555870)
4. TestLaunchMetrics. Запускает снятие метрик. Должен падать при выходе метрик за границы (но я бы всё равно проверял глазами). [Настройки кубика](https://a.yandex-team.ru/arc/trunk/arcadia/sandbox/projects/release_machine/components/configs/goods/goods_metrics.py?rev=r9555870). [Конфиг метрик](https://a.yandex-team.ru/arc/trunk/arcadia/search/metrics_templates/goods/common.json). [Вики](https://wiki.yandex-team.ru/metrics/metrics-launch-manager/#strukturashablonaprokachki) с подробным описанием структуры. Рм подхватывает конфиг метрик сразу после коммита -- кубик выкачивает их напрямую из аркадии.
5. ReleaseStableNanny. Кубик для релиза. При нажатии происходит релиз ресурса.

### Работа с ветками
Сейчас есть [автоотведение](https://a.yandex-team.ru/arc//trunk/arcadia/sandbox/projects/release_machine/components/configs/goods_report.py?rev=r9555870#L40) новых веток. Автоматика отводит ветку при накоплении 100 коммитов или если с прошлой ветки прошло 3 дня. Также можно отводить ветки руками при нажатии на кнопку CiReleaseStart.

Если нужно откатить/подмержить релиз в ветку, на вкладке "Merge/Rollback" указываем ревизию и нужню ветку. После этого нужно перейти на ci страницу проекта -- или нажать на надпись "release_goods_report #..." -> вкладка ci слева. Или напрямую по [ссылке](https://a.yandex-team.ru/projects/goods/ci/releases/timeline?dir=extsearch%2Fgoods%2Freport%2Freport_base&id=release_goods_report). Там слева под release_goods_report будет транк и ветки. Собственно в той ветке, куда мержили, появится коммит. Справа под "..." запускаем релиз от этого коммита, в интерфейсе рм появится новый тег у этой ветки.

### Обычная схема релизов
1. В релизной машине прокручиваем вниз, там будет таска "ReleaseStableNanny", она отправляет бинари на релиз. Прожимаем её. После релиз появляется на [дашборде](https://nanny.yandex-team.ru/ui/#/services/dashboards/catalog/goods-report) репортов (справа).
2. Коммитим релиз (Select->Commit). На сервисах появляется снепшот.
3. Прожимаем деплой, выбираем рецепт "deploy_goods_report_with_locks_queue". Он катит полокационно репорт, тестинг->прод->хамстер с локами очереди.

Текущую продовую версию можно смотреть по рм + будут приходить отбивки в чат девопсов. Также можно зайти на сервис и там посмотреть по файлу репорта, от какой ревизии он собран.

### Подробнее про конфиг снятия метрик.
В конфиги можно увидеть непонятные айдишники и null. Это следствие создание шаблона через интерфейс [mlm](https://mlm.yandex-team.ru/templates). При сохранении шаблона эти поля автоматически заполняются.
На верхнем уровне в поле "launchTemplates" лежат все запуски (сейчас там 1). Важные места:
1. [Cgi](https://a.yandex-team.ru/arc/trunk/arcadia/search/metrics_templates/goods/common.json?rev=r9552043#L7) общие cgi параметры для снятия.
2. [Пул](https://a.yandex-team.ru/arc/trunk/arcadia/search/metrics_templates/goods/common.json?rev=r9552043#L34) (он в нескольких местах указан).
3. [Корзинка](https://a.yandex-team.ru/arc/trunk/arcadia/search/metrics_templates/goods/common.json?rev=r9552043#L80).
4. [Список метрик](https://a.yandex-team.ru/arc/trunk/arcadia/search/metrics_templates/goods/common.json?rev=r9552043#L86). Указывается название. Также можно прописать criticalCheckerJs и warnCheckerJs -- это проверки, которые будут загараться, в случаи проблем. fatalCheckerJs только для метрик без дооценки.

### Графики
[Parallel](https://graf.yandex-team.ru/d/SGlvq9Inz/goods-parallel-report-global-autogenerated-on-2022-01-17-11-58?orgId=1&refresh=1m&from=now-1h&to=now)

[Parallel аппхост](https://yasm.yandex-team.ru/menu/apphost/WEB/web/PRODUCTS)

[Prime](https://graf.yandex-team.ru/d/zB-N39Ink/goods-warehouse-report-global-autogenerated-on-2022-01-17-11-58?orgId=1&refresh=1m&from=now-1h&to=now)

[Prime аппхост](https://yasm.yandex-team.ru/menu/apphost/GOODS/route_market/MARKET_SEARCH_PROXY/)

Альтернативные графики (более шустрые):
[Parallel](https://monitoring.yandex-team.ru/projects/market-report/dashboards/monk2798esran5ptfs6q?range=1h&p.role%5B0%5D=market-report&p.subrole%5B0%5D=goods-parallel&p.cluster%5B0%5D=stable&p.dc%5B0%5D=Sas&p.dc%5B1%5D=Vla&p.dc%5B2%5D=Myt&p.dc%5B3%5D=Iva&p.dc%5B4%5D=Man&refresh=60)
[Prime](https://monitoring.yandex-team.ru/projects/market-report/dashboards/monk2798esran5ptfs6q?range=1h&p.role%5B0%5D=market-report&p.subrole%5B0%5D=goods-warehouse&p.cluster%5B0%5D=stable&p.dc%5B0%5D=Sas&p.dc%5B1%5D=Vla&p.dc%5B2%5D=Myt&p.dc%5B3%5D=Iva&p.dc%5B4%5D=Man&refresh=60)

### Костыльные варианты
Т.к. бинарь -- просто файл в аркадии, его можно собрать руками в сб (например, склонировать таску, которая сейчас в проде), или собрать локально и загрузить в сб через ya upload и потом подменить ресурс. Если планируется катнуть на часть машин для теста, то можно это сделать руками. Если нужно прокатить кастомные релиз на всё, то нужно указать правильный тип ресурса бинаря (при загрузке указать ya upload -T=GOODS_REPORT_BINARY), прожать у таски релиз и дальше всё по стандартной схеме со 2-го пункта.
