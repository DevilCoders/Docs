# UpgradeBase
Эта утилита позволяет применить Yql-шаблон для таблицы в YT.

Причем таблицы будут отфильтрованы по заранее заданным ключам, а также разрезаны на порции заданной длины.

Сейчас утилита зачастую применяется для обновления дополнительных сведений тумбов. Например загрузка новых факторов от компьютерного зрения, добавление новой модели.

## Использование
UpgradeBase основан на задачах.

Инструкция по запуску:

0. Перед добавлением задачи должны быть созданы соответствующие директории на YT, которые после буду указаны в yaml конфиге, а также директории "{upbase_config.data.input_path}_prepare" и "{upbase_config.data.input_path}_temp".
1. Для начала необходимо описать настройки задача с помощью *.yaml файла. Примеры можно найти в `scripts/*.yaml`
2. В этом yaml файле необходимо добавить id шаблона в yql. 
   1. Шаблоны должны подключать необходимые файлы с помощью `PRAGMA file`. (Если добавить через web-интерфейс, UpgradeBase не будет иметь к ним доступа).
   2. Параметры, заданные в yaml файле и используемые в шаблоне должны содержаться в фигурных скобках. Пример: `{output_table}`.
   3. Если необходимо в шаблоне использовать фигурные скобки, которые не являются параметрами, то нужно использовать двойные фигурные скобки. Пример: `{{"optional":false}}`.
   4. Для robot-imgbase должны быть выданы права на чтение и обновление шаблона.
3. Чтобы добавить новую задачу, необходимо запустить `upbase_queue` тогда задача добавится в очередь задач. Примеры расположены в `scripts/*.sh` 

Посмотреть текущий прогресс выполнения задачи можно во [вьювере](https://images-upbase.n.yandex-team.ru/).

## Детали использования
### Yaml скрипты
Шаблоны конфигов находятся в `lib/upbase_lib/config_templates`
#### upbase_config
* "data.input_path" - директория в которой будут храниться разрезанные данные для операции
* "data.output_path" - директория в которой будут храниться результаты операции
* "process_config.rows_per_operation" - количество строк в одной операции (может различаться от размера порции)
* "process_config.max_operations_at_time" - количество параллельных операций
* "process_config.complete_hungs" - TODO(mrboogie)
#### cutter_config
* "process_config.output_path" - директория в которой будут храниться результаты порцирования (должна совпадать с upbase_config.data.input_path)
* "process_config.filter" - **таблица** с ключами, по которым происходит фильтрация
* "process_config.cut_size" - размер одной порции
* "db_type" - Сейчас поддержвиается только thumbdb и thumbrella

### Yql шаблоны
#### Возможные используемые параметры
* {cluster}
* {pool} - для yt.Pool
* {pool_trees} - для yt.PoolTrees
* {input_table} - порцировання входная таблица
* {output_table}
* {start} - offset порцированной таблицы
* {size} - размер текущей операции (задается в "process_config.rows_per_operation")

### Добавление задачи в очередь
Задача это отдельная нода на YT, в атрибутах которой хранится заданный кофиг.
* `--node-store-prefix` параметр указывает местоположение очереди, сейчас upbase автоматически обрабатывает только очередь `arnold.//home/images/upbase`
* Необходимо передать yt-token и yql-token
* `--templates-path` путь до шаблонов yaml-конфигов. Обычно в `lib/upbase_lib/config_templates`
* `Add Config {*.yaml}` - добавление своего конфига

## Статистика
Статистики по операциям можно отслеживать в Solomon'e. Все графики находятся [здесь](https://solomon.yandex-team.ru/?project=images&cluster=robot&service=upbase).

## Сервер
Сервер сейчас крутится в [cluster master'е](https://images-cm-mrdb.n.yandex-team.ru/graph) и смотрит за очередью `arnold.//home/images/upbase`.

Можно собрать и запустить свой сервер из `runner`.

## Владелец
Создатель утилиты @igorluk. С вопросами также можно обращаться к @mrboogie.