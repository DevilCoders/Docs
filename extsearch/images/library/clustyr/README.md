# Трансгалактический мегакластир

Clustyr - библиотека для создания кластермастерных роботов полностью на питоне. Использует конфигурационные файлы на yaml.
В отличие от стандартных кластермастерных роботов точкой входа является сам бинарь робота.

## Плюсы и минусы

+ Робот пишется на python, а не на bash.
+ Переиспользование кода. Кроме того работают все плюшки аркадии, связанные с автоматическим тестированием.
+ Возможность с полпинка запустить любой таргет из робота с разработческой машины без разворачивания CM.
+ Из коробки поставляет механизм развертования бинарей на все машины с поддержкой версионирования.
+ Иерархическая конфигурация.

- Робота необходимо компилировать - руками на проде не поправишь.
- Сложнее схема развертования робота в многомашинной конфигурации.
- Сейчас clustyr не умеет просто работать с кейсом "разные сценарии переиспользуют одни и те же функции".

## Принцип работы

Clustyr собирает сценарий кластермастера на основе декораторов функций, формирует скрипт вида

```
_scenario() {
    # ..... hostlist и сценарий
}

# ..... служебные башевые таргеты

/robot/binary/full/path "$@"
```

и запускает master с этим скриптом. При вызове он стартует робот.

## Автоматическое обновление

Для простоты обновления бинарей робота в модуле `deploy` лежат две вспомогательные функции:
- `deploy_robot` - с помощью skynet выкачивает из sandbox самый свежий зарелизенный в stable пакет типа, определённого в конфиге, и разварачивает его в файловой системе как новую версию робота, помечая её как last. Пакет ожидается в формате `.tar.gz`, такой, к примеру, можно создать с помощью sandbox-таска `YA_PACKAGE`
- `cleanup_old_robot_versions` - удаляет старые версии робота, оставляя количество версий, указанное в конфиге

С помощью этих функций можно в самом роботе описать последовательность целей для его обновления

## Особенности конфигурации

В ya.make необходимо вписать файл конфигурации как ресурс. Это сделано, потому что ci.yandex-team.ru не умеет подхватывать внешние по отношению к бинарю файлики (и импорт-тесты падают), а также чтобы позволить поставлять бинарь со стандартным конфигом сразу.

В корень конфигурации можно добавить опциональное поле 'target\_namespace'. В него можно вписать префикс полного пути к функции таргета. Если этот префикс есть в конфигурации, имена таргетов в графе кластермастера будут от него избавлены.

## Запуск

```
robot_binary start
```

По конфигу робот сгенерит файл сценария, положит его в нужное место и запустить master.

## Примеры

https://a.yandex-team.ru/arc/trunk/arcadia/extsearch/images/library/clustyr/example - рабочий пример робота на clustyr
