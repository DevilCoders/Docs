# Testlib

Testlib - библиотека для интеграционных тестов приложений, работающих с YT

## Запуск тестов интеграционных тестов

Чтобы просто запустить тесты локально:

```bash
# из папки с проектом интеграционных тестов

ya make -trAP --test-stderr --keep-temps -v --test-param=run_with_yt --test-traceback=long
```

Чтобы запустить и канонизировать новый выход:

```bash
ya make -trAP --test-stderr --keep-temps -v --test-param=run_with_yt --test-traceback=long -Z
svn commit canondata/ -m "canonized data for test 'blablabla'"
```

## Порядок работы тестов

Каждый интеграционный тест наследуется от класса 'YtRegressionTestBase' и состоит из одного или нескольких этапов, результаты которых отдаются в тестовый рантайм как результаты 3 фейковых тестов:

1. test\_files - выходные данные всех этапов (таблицы на YT) сравниваются с каноничными данными
2. test\_exit\_codes - сверяются exit codes тестриуемых приложений на каждом из этапов
3. test\_table\_list - сверяются списки выходных таблиц.

Этапы описываются наследниками класса 'ProcessDescription' и имеют следующий жизненный цикл:

1. system\_cmd - предобработка данных / подготовка среды исполнения
2. cmd - запуск тестируемого приложения
3. post\_cmd - постобработка результатов для сверки
4. dump tables - приложение yson\_converter собирает данные из выходных таблиц в той или иной форме

Подробное описание смотри в docstring класса

## Создание интеграционного теста с нуля

1. Создаем sandbox-ресурс с иерархией нод кипариса (таблиц, файлов и папок на YT) и метаданными, описывающими ноды. Пример такого ресурса можно посмотреть вот тут: https://sandbox.yandex-team.ru/resource/285023981/view . В ресурсе должны содержаться входные и выходные таблицы запускаемых в рамках теста приложений
2. Создаем PY2TEST проект, в DATA зависимостях, к которому указываем наш sandbox-ресурс.
3. Описываем тест в проекте.
4. (опционально) добавляем в yson\_converter новые байндинги для дампа таблиц и прописываем их в suffix\_dump\_modes и regex\_dump\_modes в описании этапа.
5. Запускаем тест по инструкции выше.

Чтобы скачать таблицу для ресурса надо:

```bash
yt read --format=yson <table_path> > <table_file_name>
```

## Подводные камни:

1. Класс интеграционного теста должен начинаться с "Test". Тестовый рантайм ищет тесты по префиксу имени.
2. При создании кастомных protobuf байндингов в yson\_converter надо прописать статическую переменную, чтобы компилятор не отсек лишнее.
3. Если тестируемое приложение - маппер, то выходные результаты надо однозначно сортировать на этапе постобработке, чтобы исключить элемента случайности в порядке строк.
4. При написании новых тестов может быть удобно, чтобы все падало сразу, не дожидаясь общих результатов. Для этого есть опция --test-param=failfast
5. Для просмотра состояния упавших тестов и разработки новых можно оставить локальный YT работать после выполнения тесов при помощи опции --test-param=dont_stop_local_yt, номер порта для этого инстанса локального YT можно взять из логов.
