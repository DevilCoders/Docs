## Утилита для подготовки пула для обучения нейронной сети.

Используется в графе нирваны:

https://nirvana.yandex-team.ru/flow/9820a03f-763f-477d-8bda-75229374d41b/05610ba7-ebf7-4e31-b7db-f09397b5ff43/graph/FlowchartBlockOperation/5b45a57e-2d21-4816-8f78-bfc8166ed2b3

### Входные данные ###
- PRS-таблицы с разметкой документов
- индекс картинок - используется для запуска url2doc и фильтрации документных фичей из метадока (erf, i2t, t2t, omni index)

### Выходные данные ###
- директория на YT, в ней - все временные таблицы и готовые таблицы для обучения модели эмбеддингов.

### Общее описание ###
1. Берем результаты PRS(запускается через fml) - таблицы с оценками, фичами и запросами - для оцененных документов и треша - получаем запросную часть.
2. Прогоняем урлы документов через url2doc и мержим с запросами - для оцененных документов и треша.
3. По докидам выдираем из метадока документые фичи - получаем документную часть.
4. Мержим запросные и документные части: получаем пары запрос документ вместе с запросными и документными фичами.
5. Строим пул для обучения модели.

### Описание режимов работы ###
Воркфлоу проще всего понять через граф нирваны, в нем видны все операции и связи между ними.

####  Запросная часть ####
**prepare_queries** - мержим fml таблицы queries, ratings, features в одну. Выходная таблица содержит поля:
| qid     | query     |  url     | rate     | features | 
| ------------- |:-------------:| -----:|  -----:| -----:|
| qid     | запрос     |  url     | оценка     | запросные фичи |
Для треша проставляется rate = 0

**prepare_for_urls2doc** - подготовка урлов для запуска url2doc. Из таблицы rating достаем qid и url. Эти данные необходимы для запуска url2doc чтобы сопоставить докумены и урлы, им соотвествующие.

**join_urls_with_docs** - объединяем результат работы: url2doc и prepare_for_urls2doc. На выходе получаем таблицы qid, url, doc_id


**join_queries** - объединяем всю информацию по запросной части в одну таблицу. Join на результатах операций **join_urls_with_docs** и **prepare_queries**. Выходная таблица содержит поля:
| qid     | query     |  url     | rate     | features | docid | 
| ------------- |:-------------:| -----:|  -----:| -----:| -----:|
| qid     | запрос     |  url     | оценка     | запросные фичи | docid | 


#### Документная часть ####

**prepare_docs**  - select по метадок-таблицам индекса //home/images/index/$index-state/metadoc/$num/metadoc. Вытаскиваем только необходимую для обучения информацию и сохраняем в таблицу:
| doc_id     | Images::NIndex::TMetaDocPB           | 
| ------------- |:-------------:| -----:|
| docid | метадок |


#### Подготовка пула обучения модели ####

**join_queries_docs** - объединяем запросную и документные части, join по **doc_id**. На этом этапе получается таблица пар запрос - документ(промежуточная таблица если задана опция table_pairs, реально количество записей на обучение) и таблица запрос - документы. Таблица запрос документ содержит сырые данные с фичами - их нельзя засовывать на обучение, но нужно использовать для построение пула простой мап операцией.

**create_model_meta_info_file** - создаем файл с мета информацией для модели: версия i2t, фичи и эмбединги, которые используются в документной и запросных частях, и флаг использования экспериментальных фичей (подробнее ниже).

**create_pool** - на результате операции join_queries_docs делает пул для обучения. На входе получаем i2d модель для построение запросной части ембедингов. В этой операции зашито построение фичей для модели(todo: вынести в отельную либу). Строятся запросные фичи. Строятся документные фичи. Выхлоп в таблицу вида:

| qid     | q_features     |                       docs   | 
| ------------- |:-------------:| -------------------------------------------------:| 
| qid     | запросные фичи     |  массив документов - документные фичей + оценка  | 


**split_pool**  -  бьет результат create_pool на отдельные таблицы train, val, test.

#### Экспериментальный режим ####

По умолчанию пул строится только с фичами, которые используются в продакшн версии модели.
При выставлении флага _--enable-experimental_ в режиме **create_model_meta_info_file** в пул добавляются новые факторы и эмбединги.  
Сейчас экспериментальными являются:
1. Эмбеддинг BertDistill
2. Запросные факторы из _extsearch/images/base/factors/factors_gen.in_, начиная с 752.
3. Статические документные факторы из _extsearch/images/kernel/new_runtime/doc_factors/factors_gen.in_, начиная с 305.
4. Эмбеддинг i2t V12 (по умолчанию V11)
5. Эмбеддинг t2t V3 (по умолчанию V2)
