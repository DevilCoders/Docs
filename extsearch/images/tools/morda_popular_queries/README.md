# Описание
____
Данная тулза предназанчена для загрузки кастомных наборов популярных запросов в saas для экспериментов.

Включить выдачу можно, использовав флаги ```&exp_flags=use_images_popular_queries=1&exp_flags=images_popular_queries_mode={mode}```, где {mode}- значение параметра --mode при загрузки таблиц(id конкретной выдачи)

Изнутри процесс заливки данных довольно прост: На вход режима **add** подается табличка со столбцами "image_url" и "query_text", где в "image_url" лежат ссылки на тумбы. Тулза получает размер тумбов, преобразовывает все данные в нужный формат и добавляет строку к выходной таблице(дефолтный путь таблицы- //home/images/morda_popular_queries/full_table). Далее, использую режим **upload** можно отправить выходную таблицу на загрузку в saas. Если добавить к режиму **upload** параметр **--lock-thumbs**, то произойдет лок всех тумбов в загружаемой таблице.
### Как пользоваться:
```
cd united
ya make -r
```
___
### Описание конфига
Дефолтный конфиг лежит в папке united, можно внутри поменять поля, либо переназначить путь опцией **--config**

**Поля:**
* **resulting_yt_server** - сервер таблицы для загрузки в saas(hahn, arnold, etc...)
* **resulting_yt_dir** - путь до директории, где будет храниться таблица для загрузки в saas и другие необходимые таблицы

* **resulting_table_name** - имя таблицы, где хранятся данные для загрузки в SAAS
---

### У тулзы есть 3 режима работы:
---
**add** - добавление новых данных
##### Обязательные параметры:
* **--input-server** - сервер входной таблицы(hahn, arnold, etc...)
* **--input-table** - путь до входной таблицы
* **--mode** - имя конкретной выдачи для включение через флаг ```&exp_flags=images_popular_queries_mode={mode}```
##### Дополнительные параметры:

* **--lang** - язык выдачи, по дефолту,- 'ru'
* **--config** - путь к конфигу

пример:
```sh
./morda_popular_queries add --input-server hahn --input-table //home/images/fexion/tmp_table_trends_thumbs --mode test_1
```
____
**del** - удаление ненужных данных через интерфейс тулзы
##### Обязательные параметры:
* **--mode** - имя конкретной выдачи
##### Дополнительные параметры:
* **--lang** - язык выдачи, по дефолту,- 'ru'
* **--config** - путь к конфигу
```sh
./morda_popular_queries del --mode test_1
```
___
**upload** - загрузка собранной таблицы в saas

##### Дополнительные параметры:
* **--lock-thumbs** - залочить все тумбы, находящиеся в таблицу
* **--config** - путь к конфигу

```
./morda_popular_queries upload --lock-thumbs
```
Если загрузка завершится успешно, то напечатается id батча, загруженного в saas
```
{"batch":"1596796190013588"}
```
Далее можно будет проверять степень готовности данных, используя этот id:
```
curl http://fast-query-data-images.ferryman.n.yandex-team.ru/get-batch-status\?batch\=1596796190013588
```
Когда вернется статус searchable, данные можно будет использовать


Если использовался режим лока тумбов, то добавится информация про лок тумбов
```
Locking thumbs
return code: 0
stdout:
30b68980-ee12-44de-a102-cad466fb4c59
```
Этот id можно использовать для получения информации о готовности лока тумбов
```
./taascl task-info --task-id 30b68980-ee12-44de-a102-cad466fb4c59
```
____
**get_status** - отдает информацию о состоянии последней заливкии в саас и лока тумбов
* **--config** - путь к конфигу

Про статусы заливки в саас можно почитать тут https://wiki.yandex-team.ru/jandekspoisk/saas/ferryman/#httpapi

Про статусы лока тумбов тут https://wiki.yandex-team.ru/yandeximages/robot/taas/#task-info


пример:
```sh
./morda_popular_queries get_status
```

