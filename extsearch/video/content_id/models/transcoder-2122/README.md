# SVM  Модель детекции дубликатов
Модель обучена для повышения точности детекции дублей для коротких и малодинамичных документов. Обучалась по факторам, получаемым на выходе тяжелого алгорима сравнения VisWord64v2 сигнатуры. Дополнительно в качетве фактора рассчитывался относительный динамизм сигнатуры (сумма битовых расстояний последовательных слов сигнатуры деленная на количетво слов) 

## Сбор сета
1. выбрали все документы, которые были транскодированы за сутки https://yql.yandex-team.ru/Operations/YgTv4ZfFt77CyeKG_Jc5qmlNvznNYfFxbkhTnk8SnL0= полученная таблица https://yt.yandex-team.ru/arnold/navigation?path=//home/zen-video-hosting/transcoder/content_id/dataset/TRANSCODER-2122/input
2. посчитали VisWord64v2 сигнатуры документов для lowres стрима. Фактически сигнатуы были взяли из датасета синтетически аугментированных пар видео - из каждой пары брались только сигнатуры оригинального видео (колонки **sig_1; url_1; duration_1** из таблицы https://yt.yandex-team.ru/arnold/navigation?path=//home/zen-video-hosting/transcoder/content_id/dataset/TRANSCODER-2122/signatures) Более очевидным способом получения дневного среза сигнатур документов является выборка сигнатур из базы, но в эксперименте уже была посчитанная таблица с парами и ссылками на потоки, что удобно для разметки и анализа
3. Из сигнатур колонки **sig_1** (около 30к строк) таблицы signatures при помощи декартова произведения всех на всех формировалась таблица пар crosspairs (размер около 630М строк). Документы короче 15с отфильтровывались.
4. При помощи бинарника **vh_dups MatchPairs** рассчитывались факторы тяжелого алгоритма для всех пар декартова произведения документов. Полученная таблица сортировалась по колонке **matched** (вердикт тяжелого матчера по статическим порогам). Таблица-результат https://yt.yandex-team.ru/arnold/navigation?path=//home/zen-video-hosting/transcoder/content_id/dataset/TRANSCODER-2122/crosspairs.matched
```bash
extsearch/video/duplicates/vh_dups/bin/vh_dups MatchPairs \
    --server arnold \
    --dynamism-thresh 0 \
    --min-duration 15 \
    --pairs-table $path_to_crosspairs \
    --matched-table //home/zen-video-hosting/transcoder/content_id/dataset/TRANSCODER-2122/crosspairs.matched
```

## Разметка сета
Основной целью обучения модели было повышение точности детекции дублей для коротких и малодинамичных документов, на которых текушие статические пороги по факторам тяжелого алгоритма давали высокий FP-rate. В связи с этим была принята гипотеза, что true negative размечаются правильно в подавляющем большинстве случаев, а полученные после тяжелго алгоритма positive пары необходимо очистить от большой доли false positive. Для этого был подобран набор эвристик. Обучение SVM по эвристически размеченному небольшому сету проводилось в предположении, что алгоритм обобщится на похожие случаи.

Эвристики подбирались вручную, рассматривались различные подозрительные (сильно отличающаяся динамичность документов в паре) и крайние (расстояние **avgDist** близко к пороговому) случаи

## Обучение модели
Скрипт ```extsearch/video/content_id/models/transcoder-2122/train``` :
```bash
$ ./train
Train set shape (51680, 7)
Train size 51680
Precision 0.9856677524429968
Recall 0.978021978021978
Validate FPR 0.0007199856002879943
Saving models
```

- Так как таблица crosspair.matched была отсортирована по вердику тяжелого матчера, в начале таблицы сосредоточены negative пары, в конце - positive пары. Для обучения берется хвост таблицы таком образом, чтобы захватить все positive (true + false) в некотором соотношении с negative.
- В процессе подбора параметров модели (размер обучающего сета, параметры SVM) и валидации качества рассчитываются precision/recall метрики на тестовом множестве, и FP-rate на валидационном. Валидационное множество получается путем чтения головы таблицы, где сосредоточены negative пары.
- Обученная модель (объекты scaler, SVM classifier) сохраняется в единый json файл для последующей загрузки в C++ коде

## Полезные ссылки
- Тяжелый алгоритм https://wiki.yandex-team.ru/users/vilenkin/tjazhelyjj-algoritm-sklejjki-dublikatov-po-videosignaturam/
- Сигнатура VisWord64v2 https://wiki.yandex-team.ru/video/videopoisk/signatureduplicates/#opisaniealgoritmapostroenijasignatur
