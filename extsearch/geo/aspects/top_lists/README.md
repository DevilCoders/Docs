### Процессы
* [Построение списков лучшего](https://reactor.yandex-team.ru/browse?selected=9787581) - построение списков лучшего
---

### Структуры данных

#### TTopListsConfig (`top_list.proto`)
Общий конфиг для всех строящихся списков

глобальные параметры для фильтрации компаний и отзывов
* MinTaxiRoutes - минимальное среднедневное количество маршрутов на такси
* MinTaxiRouteDays - минимальное количество дней, в которые строились маршруты
* MinRating - минимальный рейтинг компании (10 - max)
* MinReviews - минимальное количество отзывов
* MinReviewRating - минимальная оценка отзыва, чтобы использовать его для расчета wilson score (5 - max)
* MaxReviewAge - максимальный возраст отзыва, используется для расчета веса отзыва в зависимости от его возраста
* GeoIds - список geo_id городов, для которых строить списки. Если пустой - списки построятся по всем городам из входных данных
* ForbiddenGeoIds - geo_id, компании из которых не участвуют в построении списков (отдаленные районы Москвы и Санкт-Петербурга, которые по сути - другие города)

глобальные параметры для фильтрации компаний по значению wilson score от отзывов с аспектами данного списка
* MinReviewsWilsonScore - минимальное значение wilson score
* ReviewsWilsonScoreTopN - топ компаний из списка, по среднему wilson score которых считается предварительный порог wilson score для фильтрации компаний в списке
* ReviewsWilsonScoreMinShare - доля от среднего wilson score из `ReviewsWilsonScoreTopN` для расчета итогового порога для фильтрации компаний в списке

глобальные параметры для расчета порогов фильтрации компаний в пределах города
* MinTaxiRoutesPercentile - какую долю компаний с наименьшим количеством маршрутов такси удалить
* MinRatingPercentile - какую долю компаний с наименьшим рейтингом удалить
* MinReviewsPercentile - какую долю компаний с наименьшим количеством отзывов удалить
* MinReviewsWilsonScorePercentile - какую долю компаний с наименьшим значением wilson score удалить
* MaxCityCenterDistancePercentile - какую долю компаний с наименьшим расстоянием до центра города сохранить

веса для параметров ранжирующего скора
* TaxiRoutesWeight
* RatingWeight
* ReviewsWilsonScoreWeight


* MinListSize - минимальный размер списка (списки меньшего размера не формируются)
* MaxListSize - максимальный размер списка
* TopListConfigs - конфиги отдельных списков

#### TTopListConfig (`top_list.proto`)
Конфиг для списка (в текущей реализации по данному конфигу строятся списки в разбивке по всем городам из исходных данных)
* Title - префикс названия списка (в конце добавится название города или другого топонима)
* Summary - описание списка (нужно для админки подборок, сейчас нигде не заполняется)
* Image - картинка для интерфейса подборок
* AspectIds - списков аспектов, по наличию которых в отзывах считается wilson socre
* IsGenitiveCase, IsPrepositionalCase - падеж для названия города при формировании Title итогового списка
* AllowedMainRubricIds - белый список главных рубрик для компаний-кандидатов. Любые, если список пустой
* ForbiddenMainRubricIds - черный список главных рубрик, компании с данными главными рубриками не попадут в список
* ForbiddenRubricIds - черный список рубрик, распространяется не только на главные, а на все рубрики
* ForbiddenPermalinks - черный список пермалинков. Не используется, но может пригодится, чтобы банить что-то из списков

список сущностей, по которым список должен срабатывать в геопоиске
* GeosearchRubricIds - рубрики
* GeosearchFeatureIds - признаки
* GeosearchFeatureEnumValueIds - словарные значения признаков

#### TTopListCompany (`top_list.proto`)
Атрибуты компании, которые используются для построения списков
* CityGeoId - geo_id, округленный до города
* Names - основные названия
* RouteAmount - среднедневное количество маршрутов
* Days - количество дней с маршрутами
* Rating - рейтинг компании (10 - max)
* Reviews - количество отзывов
* TCalculatedParams - вычисляемые атрибуты с учетом конфига данного списка, перезаписывается при построении каждого следующего списка

#### TTopListReviewInfo (`top_list.proto`)
* AspectIds - аспекты, выделенные в отзыве
* Timestamp - для расчета веса отзыва от возраста
* Rating - оценка в отзыве (5 - max)

#### TCalculatedParams (`top_list.proto`)
* WeightedReviews - взвешенное на возраст количество отзывов
* AspectReviews - количество отзывов с выделенными аспектами
* WeightedAspectReviews - взвешенное на возраст количество отзывов с выделенными аспектами
* ReviewsWilsonScore - wilson score
* CityCenterDistance - расстояние до центра города
* ScaledTaxiRoutes - количество маршрутов, взвешенное на `TaxiRoutesWeight`
* ScaledRating - рейтинг, масштабированный относительно `MinRating` (с учетом `MinRatingPercentile`) и взвешенный на `RatingWeight`
* ScaledReviewsWilsonScore - wilson score, взвешшный на `ReviewsWilsonScoreWeight`
* Score - ранжирующий score

#### TTopList (`top_list.proto`)
* Title - исходный `Title` конфига списка + название города в правильном падеже
* Alias - транслит от `Title`, используется в качестве уникального id при загрузке в админку подборок
* Permalinks - пермалинки, попавшие в список
* IdsForGeosearch
* Params - параметры списка для дебага
* CompanyDebugInfos - атрибуты компании для дебага
---

### Алгоритм построения списков лучшего `lib/top_lists_calculator.cpp`
В квадратных скобках указана функция, в которой происходит операции

* на вход подается список компаний [`CalculateTopLists`]
* удаление компаний, не удовлетворяющих условиям по географии:
    * `geo_id` компании находится в списке `TTopListsConfig.ForbiddenGeoIds`
    * `geo_id` компании отсутствует в геобазе
* последовательно строятся списки, описанные в TTopListConfig, с разбивкой по географии
* для каждого списка считается wilson score по заданному в конфиге списка списку аспектов [`PrepareReviews`]
* удаление компаний, не удовлетворяющие условиям на рубрики [`ApplyTopListConfigFilters`]
* вычисление порогов параметров по перцентилям из глобального конфига [`CalculateTopListParams`]
    * пороги для параметров по перцентилям объединяются с явно заданными значениями порогов в сторону более строго фильтрации
* удаление компаний по посчитанным порогам [`FilterByThresholds`]
    * на этом этапе также удаляются компании со слишком маленьким wilson score относительно среднего по топу (параметры `ReviewsWilsonScoreTopN`, `ReviewsWilsonScoreMinShare`) для ограничения итогового списка
* вычисление сортирующего скора с учетом параметров `TaxiRoutesWeight`, `RatingWeight`, `ReviewsWilsonScoreWeight` [`CalculateScore`]
* сортировка [`SortAndCrop`]
* удаление не первых филиалов сетей или одноименных компаний [`EraseNotFirstChainBranches`]
* обрезание по максимальному размеру списка [`SortAndCrop`]
* вывод списка, если удовлетворяет по минимальному размеру [`CalculateTopLists`]
---

### YQL запросы
| Запрос               | Описание                                                               |
|----------------------|------------------------------------------------------------------------|
| `taxi_routes.yql`    | кол-во поездок на такси до организаций по дням                         |
| `prepare.yql`        | построение списков по конфигу `config.json`                            |
| `michelin.yq`        | построение списков Мишлен, просто добавление в таблицу готовых списков |
| `add_to_history.yql` | история `top_lists/prepared`                                           |
---

### YQL UDF
* `AspectTools::TopListsCalculator` - построение списков лучшего
---

### Полезные ссылки
* [головной таск](https://st.yandex-team.ru/WOA-1168)
* [данные на YT](https://yt.yandex-team.ru/hahn/navigation?path=//home/geosearch/aspects/top_lists)

#### Запросы
* [дифф списков лучшего](https://yql.yandex-team.ru/Operations/YUnAPgVK8HLJYJqdT1HMf15irjJtfwRPk2to-qUDc5o=)
