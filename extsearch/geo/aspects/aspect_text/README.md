## Качество выделения аспектов из текста

### Процессы
* [Качество выделения из текста](https://reactor.yandex-team.ru/browse?selected=10121609) - расчет метрик качества
* [Аспект-текст](https://reactor.yandex-team.ru/browse?selected=10050228) - разметка в Толоке
* [дашборд](https://datalens.yandex-team.ru/s6f9g6vejqaul-aspekty?tab=Oe) - строится по kpi корзинам, для приемки метрик использовать аналогичные корзины без суффикса `_kpi`
---

### Как устроены метрики
#### Точность
Новая корзина:
* берем текущие выделения аспектов из отзывов (тройки пермалинк-отзыв-аспект)
* сэмплируем так, чтобы в корзине точности было не больше `N` троек на каждый аспект
* сохраняем в кэш тройки, из которых происходило сэмплирование
* при расчете метрики учитываем долю каждого аспекта среди текущих троек

Расширение корзины:
* в течение времени множество выделений может изменяться, и нужно чтобы в корзине были представлены те срезы, где начали выделять аспекты
* из текущих выделения оставляем только те, которых еще нет в кэше корзины
* сэмплируем пропорционально количеству данных в кэше (не будет учитываться небольшой дифф), но не больше `N`

#### Полнота
* берем из текущих выделений уникальные пары пермалинк-аспект
* пересчитываем множество троек выделений так, что приписываем аспект ко всем отзывам компании, если хотя бы из одного ее отзыва был выделен данный аспект
* дальше алгоритм аналогичен точности

#### Как пересобрать корзину по определенному аспекту
Может возникнуть ситуация, когда в результате серии экспериментов в валидейт корзине по каким-то аспектам получились смещенные выборки, и нужно пересобрать по этим аспектам корзину заново. Для этого нужно по данным aspect_id удалить все записи из таблиц `aspect_text/precision_basket`, `aspect_text/precision_cache`, `aspect_text/recall_basket`, `aspect_text/recall_cache`

#### Как увеличить размер корзины
Сейчас в коде есть константа - сколько отзывов на каждый аспект будет в корзине. В текущей реализации изменения этой константы увеличит корзину только по новым аспектам. Чтобы это сделать для уже существующих в корзине аспектов нужно рядом собрать корзину, где на каждый аспект будет `new_value - old_value` отзывов, и долить ее в существующую

---

### YQL Запросы
| Запрос                          | Описание                                             |
|---------------------------------|------------------------------------------------------|
| `markup/prepare_pool.yql`       | подготовка пула для Толоки                           |
| `markup/process_result.yql`     | загрузка результатов разметки                        |
| `markup/update_final.yql`       | построение финальной таблицы из разметки             |
| `quality/precision_basket.yql`  | доливка данных в корзину точности выделения аспектов |
| `quality/precision_metrics.yql` | расчет точности выделения аспектов                   |
| `quality/recall_basket.yql`     | доливка данных в корзину полноты выделения аспектов  |
| `quality/recall_metrics.yql`    | расчет полноты выделения аспектов                    |
---

### Разметка `встречается ли аспект в тексте`
* [Аспект-текст](https://reactor.yandex-team.ru/browse?selected=10050228)
* [шаблон](https://toloka.yandex.ru/requester/apps/zNkgbL966yBtrpBWnlPW) - в аккаунте `Я.Единорог`
* [качество разметки](https://datalens.yandex-team.ru/ticdas5kbityn-dashbordy-metrik-labsa-zakazchiki?state=33f2a4d7180)
* таблица с результатами разметки: `markup/aspect_text_final`
* как отправить данные на разметку:
    * в папке `markup/aspect_text_input` создать новую таблицу со схемой (`см. ниже`)
    * можно явно задать приоритет таблицы, навесив на нее числовой атрибут priority (50 - default, 90 - разметка для метрики)
    * можно явно сбросить кэш разметки через булевый атрибут skip_cache
    * таблицы отправляются на разметку в порядке уменьшения приоритета и возрастания даты создания, удаляются при попадании в пул
* при завершении разметки обновляется [артефакт](https://reactor.yandex-team.ru/browse?selected=10196862), в который записывается обработка какой таблицы закончена

Схема таблицы на вход графу разметки:
* `permalink: Int64`
* `review_id: String?` - если размечаем наличие аспекта в отзыве
* `text: String` - текст, в котором нужно проверить наличие аспекта
* `aspect_id: Int64`

### Разметка `тональность аспекта в тексте`
* [Аспект-текст на тональность](https://reactor.yandex-team.ru/browse?selected=10086802)
* [шаблон](https://toloka.yandex.ru/requester/apps/9LgW46y0jdkC3Q2BZp7O) - в аккаунте `Я.Единорог`
* [качество разметки](https://datalens.yandex-team.ru/ticdas5kbityn-dashbordy-metrik-labsa-zakazchiki?state=f970b041180)
* таблица с результатами разметки: `markup/aspect_text_tone_final`
* как отправить данные на разметку:
    * в папке `markup/aspect_text_tone_input` - формат данных такой же, как в разметке `аспект-текст`
* при завершении разметки обновляется [артефакт](https://reactor.yandex-team.ru/browse?selected=10196864), в который записывается обработка какой таблицы закончена
