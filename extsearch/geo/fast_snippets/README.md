# Сервис для быстрой заливки геопоисковых сниппетов

## Общие сведения о сниппетах

**Сниппет** *(в терминах геопоиска)* — кусок информации об организации, топониме или выдаче в целом, который не включён в индекс и подклеивается к документам в выдаче или, в редких случаях (chains/1.x), к выдаче отдельным документом. 

Сниппеты хранятся в SaaS-KV в виде документов с пустым body, но с заполненными gta-аттрибутами, по названиям совпадающими с названиями сниппетов.

В геопоиске они достаются на среднем метапоиске по набору ключей, которые формируются по выдаче (самые популярные ключи - `пермалинк организации` и `пермалинк + язык`), и по именам сниппетов, которые передаются в запросе.
Как запрашиваются сниппеты, можно почитать [тут](https://a.yandex-team.ru/arc/trunk/arcadia/extsearch/geo/GUIDE.md#%D1%81%D0%BD%D0%B8%D0%BF%D0%BF%D0%B5%D1%82%D1%8B)

В SaaS они заливаются, за очень редкими исключениями, через инструменты, которые поддерживаются командой геопоиска:

* [Task Manager](https://wiki.yandex-team.ru/users/karas-pv/snippetstaskmanager/) - для сниппетов, которые надо обновлять не очень часто (раз в час и реже) и которые заливаются фулл-стейтом.
* fast_snippets - для сниппетов, которые надо обновлять быстро (за секунды) и которые заливаются и удаляются по одному. **Про него ниже и пойдёт речь**.

## Общее описание сервиса
Сервис представляет собой HTTP API (на самом деле [нечто большее](https://a.yandex-team.ru/arc/trunk/arcadia/extsearch/geo/fast_snippets#%D0%B7%D0%B0%D0%BB%D0%B8%D0%B2%D0%BA%D0%B0-%D1%87%D0%B5%D1%80%D0%B5%D0%B7-logbroker-1)) с тремя методами:

* Залить сниппет или группу сниппетов по ключу
* Удалить сниппет или все сниппеты из группы по ключу
* Поискать сниппет или все сниппеты из группы (чтобы например проверить, залился ли) по ключу

Во всех методах тем или иным образом фигурирует:

* имя сниппета или группы сниппетов формата `([a-z0-9_.]+)(\/[a-z0-9_.]+)*`
* ключ (например, пермалинк) 
* (опционально) язык, для которого надо залить сниппет (он прибавится к ключу).

В сервисе предусмотрена возможность как заливать сниппеты as is, так и валидировать его содержимое и конвертировать его в нужный формат.

Сниппеты, заливаемые через сервис, описываются в специальном конфиге. Там указывается название сниппета, какие валидаторы и конверторы использовать для его заливки, куда его заливать и т.д. (подробное описание конфига ниже)

## Конфиг
**Лежит [тут](https://a.yandex-team.ru/arc/trunk/arcadia/extsearch/geo/fast_snippets/config/config.pb.txt)**

Конфиг имеет протобуф-формат со [схемой](https://a.yandex-team.ru/arc/trunk/arcadia/extsearch/geo/fast_snippets/proto/config.proto).
Конфиг прдеставлен в виде древовидной структуры с корнем типа `TConfigSection` с пустым `Name`.

`Body`любого объекта типа `TConfigSection` состоит из:
 
 * Набора опций, которому подчиняется сниппет или группа сниппетов с **относительным именем** `Name` (таким образом, для корневой секции в `Body` описан набор опций, общий для всех сниппетов). Причём опции в `Body` могут переопределять опции из `Body` родительской секции.
 * Если речь о группе сниппетов, списка секций конфига, которые описывают сниппеты или группы, входящую в данную группу.
 
**Абсолютное имя сниппета** (или просто имя сниппета в терминах геопоиска) состоит из относительного имени и всех групп, в которые сниппет входит, перечисленных через `/` от корневой секции к самому сниппету.

### Ой, а что так сложно то?
Так было сделано, так как в геопоиске есть много сниппетов, которые варятся из одних и тех же данных разными способами (просто откройте конфиги Task Manager'а и посмотрите сколько различных `input_table` вы там увидете, спойлер: много меньше, чем сниппетов). 

Более того, есть сниппеты, которые отличаются только форматом, в которые уложены данные (обычно `pb` и `json`), но не отличаются самими данными. 

Идея создания древовидного конфига была в том, как сделать так, чтобы одним запросом можно было бы сварить все сниппеты, которые варятся на посланных запросом исходных данных, используя разные конверторы. С таким конфигом, это делается запросом на заливку по абсолютному имени группы сниппетов.

### Понятно, но есть ли объяснение попроще для тех, кто хочет лить только один сниппет?
Да, если вы заливаете данные, которые нужны для формирования только одного сниппета, вы просто дописываете в конфиг `TConfigSection`, в `Body` которого перчисляете все опции, которые отличаются от определённых в корне (то есть перечисленных вверху конфига). Причём в `Name` можно писать имя со слешами (в коде сниппет с таким именем развернётся в древовидный конфиг, но вас не должно это волновать).

### Описание опций конфига
Здесь описаны опции, которые указываются в `Body`.

* `ChildrenOnly` - имеет смысл только для группы сниппетов. Если равна `true`, запросы на заливку данной группы сниппетов приводят только к заливке дочерних сниппетов и групп.  Установлена в `true` в корневой секции, вам следует её менять в `false`, если группа сниппетов является сама по себе валидным сниппетом.
* `Service` - в какой саасный сервис лить сниппеты. Менять только по согласованию с командой геопоиска, у нас строгие требования к саасным сервисам с точки зрения таймингов на поиск.
* `Output` - выходной формат сниппета. Поддерживаемые форматы перечислены в `EDataFormat`
* `InputJsonSchema` - схема для валидации json во входных данных (`draft-04` и ниже). Если указана, будет использован валидатор json по схеме, имя которой указано тут. Схемы складывать [сюда](https://a.yandex-team.ru/arc/trunk/arcadia/extsearch/geo/fast_snippets/schema)
* `OutputJsonSchema` - схема для валидации результата конвертации, если указан `SpecialConvertor` (**пока не поддержана**)
* `SpecialValidator` - имя валидатора, который следует использовать для сниппета
* `SpecialConvertor` - имя конвертора, который следует использовать для сниппета 
* `Input` - список входных форматов, которые поддерживает заливка сниппета (если `Input` не единственный или не равен `Output`, надо обязательно определить `SpecialConvertor`, который поддерживает все необходимые конвертации)
* `InputSameAsOutput` - если `true`, то `Input` можно не указывать, он считается равным `Output` (так как `true` для этой опции стоит в корневой секции, вам вряд ли нужно её переопределять)
* `Recursive` - имеет смысл только для группы сниппетов. По запросу на заливку данной группы сниппетов, заливаются все дочерние сниппеты и группы из списка.  **По понятным причинам, опция не наследуется**
* `OutputLanguages` - набор языков, в которые надо сконвертировать содержимое сниппета и залить. Если указан, то язык заливки, переданный в запросе игнорируется. Надо обязательно определить `SpecialConvertor`, который поддерживает все указанные языки.
* `TtlMinutes` - время, спустя которое сниппет удаляется из сааса. Если не указано, сниппет живёт там вечно. **Важно:** если не указываете эту опцию, озаботьтесь, пожайлуста, на своей стороне вопросом удаления сниппетов, утративших актуальность.
* `InputTopic` - опция, имеющая смысл при использовании заливки через Logbroker. Указывает топик в логброкере, из которого надо читать данные для сниппетов.
* `InputForLB` -  опция, имеющая смысл при использовании заливки через Logbroker. Формат входных данных, читаемых из LB
* `KeyExtractor` - опция, имеющая смысл при использовании заливки через Logbroker.  Название функции, которая будет использована для того, чтобы вытащить из входных данных ключ для заливки сниппета.
* `UploadOverLBRetryCount` - число ретраев на заливку сниппета при использовании Logbroker. Ретраи обрабатываются в отдельном от основной обработки потоке. Минимальное время между ретраями в миллисекундах можно увидеть [тут](https://a.yandex-team.ru/arc/trunk/arcadia/extsearch/geo/fast_snippets/config/service_config.pb.txt?rev=7479268#L11). Если опция не указана или равна 0 - ретраев нет.

### Префиксы ключей (kps)

К сожалению, в отличие от заливки через Ferryman (которая используется в Task Manager), при заливке сниппетов через Logbroker мы не можем все сниппеты лить в один kps (они начнут по совпадающим ключам перетирать друг друга). Поэтому здесь каждый сниппет льётся в свой уникальный kps.

Список kps для всех сниппетов хранится [здесь](https://a.yandex-team.ru/arc/trunk/arcadia/extsearch/geo/fast_snippets/config/key_prefixes.txt)

**Важно:** при добавлении нового сниппета в конфиг, перед коммитом необходимо запустить [update_prefixes.sh](https://a.yandex-team.ru/arc/trunk/arcadia/extsearch/geo/fast_snippets/config/update_prefixes.sh). Скрипт сгенерит уникальный kps для нового сниппета и допишет в файл. При удалении сниппета из конфига kps можно вручную удалить из файла, убедившись, что все документы внутри этого kps удалены из сааса.

Также, новый kps надо добавить в конфиг геометапоиска [вот сюда](https://a.yandex-team.ru/arc/trunk/arcadia/extsearch/geo/meta/rearrs/conf.json?rev=7460959#L404), чтобы сниппеты запрашивались там.

## Описание HTTP API
API живёт по адресу `addrs-snippets.yandex.net:80` (доступ необходимо запрашивать через Puncher)

Все запросы на заливку/поиск/удаление сниппета или группы сниппетов (есть исключение при [поиске](https://a.yandex-team.ru/arc/trunk/arcadia/extsearch/geo/fast_snippets#%D0%BF%D0%BE%D0%B8%D1%81%D0%BA-%D1%81%D0%BD%D0%B8%D0%BF%D0%BF%D0%B5%D1%82%D0%B0-2)) делаются в
 `[host]:[port]/[абсолютное имя сниппета(группы)]/[ключ]`

Для группы сниппетов проиходит заливка/поиск/удаление всех, сниппетов и групп, указанные в `Recursive` в соответствующей секции конфига (и быть может сам сниппет, описываемый в этой скеции, если в ней `ChildrenOnly = false`)

### Заливка сниппета
Делается PUT запросом с содержимым сниппета (или вход для конвертора при наличии конвертаций) в теле запроса.

При использовании json или pb формата на входе обязательно передавать заголовок `Content-Type: pb` или `Content-Type: json` соответственно.

Если вы заливаете сниппет с локалезависимым содержимым и в конфиге не определён конвертор и список языков для конвертации, сниппеты под каждый язык надо лить самостоятельно, указывая язык в заголовке `Content-Language`

Обязательно нужно дождаться 200 ОК от сервера - это гарантирует, что сниппет отправился на заливку в саас. **НО:** Сниппет будет доступен на поиске не сразу, а через некоторое время (если нет переполнения в очереди на индексацию в саасе - до пары секунд). Появление сниппета в саасе можно мониторить запросами в ручку поиска.

### Удаление сниппета
Делается DELETE запросом в ту же ручку. Тут также следует дождаться 200 ОК.

### Поиск сниппета
Для локаленезависимых сниппетов делается GET запросом в ту же ручку. 
Локалезависимые сниппеты ищутся запросом в `[host]:[port]/[абсолютное имя сниппета(группы)]/[ключ]/[язык]`

В ответе (в случае 200 ОК) возвращается json. Там по ключам, равными абсолютным именам сниппетов, возращается содержимое этих сниппетов. Если содержимое сниппета - json, то оно встраивается в json ответа, если нет - отдаётся в виде строки.

## Валидаторы и конверторы
Это плюсовые классы, которые наследуются от [ISnippetValidator](https://a.yandex-team.ru/arc/trunk/arcadia/extsearch/geo/fast_snippets/lib/validators/base.h?rev=7463843#L6) и [ISnippetConvertor](https://a.yandex-team.ru/arc/trunk/arcadia/extsearch/geo/fast_snippets/lib/convertors/base.h?rev=7463843#L12) соотвественно.

**Валидатор** проверяет содержимое сниппета до конвертации (если она есть) в зависимости от входного формата. При необходимости будет добавлена возможность валидировать сниппет и на выходе конвертора (пока считаем, что конверторы покрыты юнит тестами и на валидный вход невалидного выхода не должны отдавать).
Если валидатор отдаёт `false` на сниппет, он должен заполнить и передаваемый в методы `error`, который вернётся в теле ответа на запрос в ручку заливки (с 4xx кодом).
Для json сниппетов в качестве валидатора по умолчанию испольуется валидация по схеме, указанной в `InputJsonSchema`. Для других форматов валидации по умолчанию нет.

**Конвертор** выполняет преобразование сниппета из указанного в запросе входного формата в указанный в конфиге выходной формат. Также, для локалезависимых сниппетов, переводит сниппет на нужный набор языков (указывается в конфиге).
По умолчанию, используется "тупой" конвертор, который оставляет сниппет как есть при совпадении выходного формата с входным и кидает исключение при несовпадении.

Валидаторы и конверторы создаются один раз при старте сервиса, а не под каждый запрос.

### Как реализовать свой валидатор/конвертор для сниппета.
1) Придумать уникальное название для валидатора/конвертора и указать его в полях `SpecialValidator`/`SpecialConvertor`конфига своего сниппета (группы)
2) Создать `[имя валидатора/конвертора].h/cpp` [тут](https://a.yandex-team.ru/arc/trunk/arcadia/extsearch/geo/fast_snippets/lib/validators) или [тут](https://a.yandex-team.ru/arc/trunk/arcadia/extsearch/geo/fast_snippets/lib/convertors) 
3) Реализовать его, отнаследовав его от любого из реализованных валидаторов/конверторов из соответствующего `base.h`
4) Создать объект валидатора/конвертора и положить его `Convertors` или в `Validators` по ключу `[имя валидатора/конвертора]` [вот здесь](https://a.yandex-team.ru/arc/trunk/arcadia/extsearch/geo/fast_snippets/lib/prepare_data.cpp?rev=7463843#L59)
(TODO: вынести инициализацию из кишков реализации в более удобное место)


## Заливка через Logbroker
Есть альтернативный способ заливки сниппетов - через Logbroker. 

### Как настроить такую заливку
1) Создать очередь в кластере `lbkx`, согласовав число партиций с @yu-semichev или @evelkin. Партиций должно быть достаточно много, чтобы не образовывался лаг записи и чтения (рекомендация логброкера - 2 мб/c на партицию), но не больше, чем необходимо.
2) В топике выдать права `ReadTopic` и `ReadAsConsumer` для TVM 2001886 и 2008261 (тестинг и прод)
3) Создать правило чтения для консьюмера `extmaps/fast_snippets_service` (`Type: All original`)
4) Реализовать функцию, которая из содержимого сообщения из очереди достанет ключ для заливки. Положить её [сюда](https://a.yandex-team.ru/arc/trunk/arcadia/extsearch/geo/fast_snippets/lib/extract_key.cpp?rev=7463843#L18)
5) Кроме всех прочих, указать поля в конфиге: `InputTopic`, `InputForLB`, `KeyExtractor` (сюда пишем ключ, по которому положили функцию в п.3), `UploadOverLBRetryCount`
6) Прислать код и конфиг на ревью

### Особенности
* Можно лить сниппеты, не дожидаясь ответа ручки, но при этом  проседает время заливки.
* В отличие от HTTP API, мы не можем как-то сообщить заливающему, что заливки не случилось из-за какой-то беды. Но зато мы автоматически ретраим заливку (число ретраев настраивается через `UploadOverLBRetryCount`)
* Удалять сниппеты придётся по-прежнему через HTTP API, либо по TTL.


