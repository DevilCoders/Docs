Influx Proxy
==============
Это http-прокси, которое ставится перед InfluxDB для того, чтобы как-то модифицировать запросы и расширять синтаксис.

Как модифицируются запросы
---------------------------
* в операциях деления, если знаменатель - это промежуток времени, то он превращается в секунды и единица измерения убирается:
  * `SELECT sum(rps) / 30s` →`SELECT sum(rps) / 30`
  * `SELECT sum(rps) / 2h` →`SELECT sum(rps) / 7200`

  Это сделано для того, чтобы можно было использовать в качестве знаменателя переменную Графаны `$interval`.
* бессмысленные фильтры типа `f =~ /.*/` и `f =~ /^.*$/` заменяются на `TRUE` с целью оптимизации.

Как расширяется синтаксис
--------------------------
### `TOP BY`
Выбрать top n элементов по какому-либо полю.

Примеры:
* Топ-5 урлов, на которые больше всего RPS `SELECT sum(rps) FROM metric GROUP BY time(30s) TOP 5 rps BY url`.
* Топ-5 комбнаций урл-гео, на которые больше всего RPS `SELECT sum(rps) FROM metric GROUP BY time(30s) TOP 5 rps BY url|geo`.
* Топ-5 урлов, на которые больше всего RPS ("больше всего" выбирается по `MAX`, а не по `SUM`, можно использовать любую функцию) `SELECT sum(rps) FROM metric GROUP BY time(30s) TOP 5 rps BY url USING MAX`.
* Топ-5 урлов, на которые больше всего RPS, плюс сумма по оставшимся ещё одним графиком `SELECT sum(rps) FROM metric GROUP BY time(30s) TOP 5+ rps BY url`.
* Все урлы, на которые больше всего RPS, кроме топовых пяти `SELECT sum(rps) FROM metric GROUP BY time(30s) TOP 5: rps BY url`.
* Заменить в запросе `TOP` одно поле на другое `SELECT sum(rps) FROM metric GROUP BY time(30s) SWAP ((src_geo, dst_geo)) TOP 5 rps BY src_geo`

Некоторые особенности:
* Если в `GROUP BY` будут поля, которые дополнительно разбивают результаты запроса, то результатов вернётся больше, чем `N`.
* Если нужно отключить `TOP BY` через templating-переменную, то можно использовать синтаксис `TOP 5 rps BY ()`
* В TOP BY можно указать несколько тегов, например так BY (ifname|host)
### Оператор `~`
Графана экранирует регекспы в templating-переменных, а значит пользователь не может ввести регексп в поле ввода переменной. Для того, чтобы это обойти, добавлен оператор `~`.

Например, в графике есть такое условие: `field ~ '$value'`

Если пользователь хочет что-то найти:
0. Он вводит в поле свой регексп в виде `~ /my.*pattern/` (пробел важен).
0. Графана превращает это в `field ~ '~ \/my\.\*pattern\/`.
0. Прокся превращает это в `field =~ /(?i)my.*pattern/`, все счастливы. Обратите внимание, что поиск всегда регистронезависимый.

Если же значение приходит из templating-переменной
0. Пользователь выбирает переменные `first` и `second`.
0. Графана превращает это в `field ~ 'first|second'`.
0. Прокся превращает это в `field =~ /^(first|second)$/`, все опять счастливы.

### Ключевое слово `SUMSERIES`
Если ваш запрос возвращает несколько серий, а вы хотите просуммировать их в одну - используйте `SELECT SUMSERIES`.

Пример:

`SELECT mean(tx) FROM metric GROUP BY time(30s), host` вернёт средний битрейт на каждый хост.

`SELECT SUMSERIES mean(tx) FROM metric GROUP BY time(30s), host` вернёт сумму средних битрейтов по всем хостам, одной метрикой.
