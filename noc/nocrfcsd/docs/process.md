# Процесс

## Цель

Целью процесса управления изменениями является снижение рисков ручного изменения конфигураций
систем использующихся для предоставления сервисов конечным пользователям. В область действия
процесса управления изменениями входят:

- ручные изменения конфигурации систем в промышленной эксплутации;
- выкатка в промышленную эксплуатацию кода систем, используемых для предоставления сервисов конечным
  пользователям;

В область действия процесса управления изменениями не входят:

- изменения конфигурации систем при помощи API, которые построены в соответствии с процессом CI/CD и
  проходят автоматическую проверку в процессе внедрения при помощи тестовой среды;
- работы над кодом, который не выкатывается в промышленную эксплуатацию.

## Краткое описание процесса

Основной сценарий процесса:

1. Для внесения изменений в конфигурацию системы заполняется форма запроса на изменение
   [Yandex.Forms: Запрос на изменение (NOCRFCS)](https://forms.yandex-team.ru/surveys/21525/).
2. После заполнения формы автоматически создаётся задача в очереди
   [NOCRFCS](https://st.yandex-team.ru/NOCRFCS) в статусе _Требует согласования_.
3. На основании указанных в RFC данных и с оценкой риска по матрице рисков изменение
   классифицируется как минорное (Minor change), либо критическое (Major change).
4. Минорное изменение согласуется автоматически, критическое изменение должно быть согласовано в
   соответствии с матрицей согласования, при этом на каждый уровень согласования отводится максимум
   24 часа в случае критического изменения и максимум 2 часа в случае экстренного изменения.
5. После согласования изменения задача переходит в статус _В ожидании_ и создаются события в
   [Infra](https://infra.yandex-team.ru) и в [Календаре](https://calendar.yandex-team.ru)
6. Перед началом выполнения изменений по описанному плану задача переводится в статус _В работе_
   через кнопку _Начать выполнение_
7. После успешного завершения изменений задача переводится в статус _Закрыт_ с резолюцией
   _Выполнено_ кнопкой _Закрыть_, резолюция указывается в экранной форме, которая появляется после
   нажатия кнопки

При этом возможны альтернативные сценарии процесса:

- До согласования изменения (пока задача находится в статусе _Требует согласования_) можно отменить
  изменение и перевести задачу в статус _Закрыт_ с резолюцией _Отклонен_ кнопкой
  _Отменить запрос (закрыть тикет)_
- После согласования, но до начала выполнения задачи (пока задача находится в статусе _В ожидании_)
  можно отменить изменение и перевести задачу в статус _Закрыт_ с резолюцией _Отменено_ кнопкой
  _Отмена изменения_
- После начала выполнения изменения, но до его завершения (пока задача находится в статусе
  _В работе_) в случае, если пришлось откатить изменения, можно выбрать альтернативную резолюцию
  _Откат изменения_ по нажатию кнопки _Закрыть_

![Статусы](_assets/startrek-issue-statuses.svg "Статусы")

## Детальное описание процесса

### Создание RFC

RFC может быть создан:

- через заполнение и отправку данных формы
  [Yandex.Forms: Запрос на изменение (NOCRFCS)](https://forms.yandex-team.ru/surveys/21525/)
- через [API](https://nocrfcs-api.yandex-team.ru/)

Описание параметров RFC, которые нужно указывать при заполнении формы, можно почитать на странице
[Свойства RFC](rfc-properties.md).

При создании RFC через форму создастся задача в очереди
[NOCRFCS](https://st.yandex-team.ru/NOCRFCS), и начнется процесс валидации параметров RFC. В случае
обнаружения ошибки валидации на задачу выставится тег `noc-cm:approve-exception` или
`noc-cm:time-exception`, и найденные ошибки валидации будут опубликованы комментарием к задаче.
Примеры:

![Пример ошибки валидации: juggler-мьют требует указания устройств](_assets/validation-error-juggler-mute-requires-devices.png "Пример ошибки валидации: juggler-мьют требует указания устройств")

![Пример ошибки валидации: внешние пользователи запрещены](_assets/validation-error-additional-approver-is-external-user.png "Пример ошибки валидации: внешние пользователи запрещены")

Если ошибок валидации не было, то на основании полей **Влияние на сервис**,
**Область применения изменения** и матрицы рисков определяется категория изменения. В зависимости от
оценки рисков, изменение может быть минорным (Minor change) либо критическим (Major change).

Процесс оценки рисков учитывает следующие [свойства RFC](rfc-properties.md):

- `type`
- `add-approvers`
- `dc`
- `experience`
- `chg-auto`
- `chg-test`
- `service-impact`
- `influence-rollback`

Если изменение является минорным, то оно согласуется автоматически (без привлечения людей к
согласованию).

Если изменение является критическим, то для него запускается согласование, требующее сбора OK-ов.

С момента создания RFC и вплоть до его успешного задача находится в статусе _Требует согласования_,
и в этом состоянии изменение можно отменить, нажав соответствующую кнопку перехода:

![Отменить запрос](_assets/cancel-rfc.png "Отменить запрос")

### Согласование через сбор OK-ов

Критическое изменение должно быть согласовано в соответствии с матрицей согласования. Матрица
согласования задаётся конфигурационным файлом и позволяет определить группы согласовщиков.
Для успешного согласования RFC из каждой группы согласовщиков должен проголосовать хотя бы один
участник согласования (иными словами, между группами условие "и", внутри группы условие "или").
Подробнее про выбор согласовщиков и внесение изменений в конфиг можно почитать на странице
[Согласовщики](approvers.md).

Согласование реализуется через сервис "OK" и представлено виджетом, который публикуется как
комментарий к задаче:

![Комментарий согласования](_assets/ok-comment.png "Комментарий согласования")

Также на этом этапе публикуется два дополнительных комментария, которые помогают в принятии решения
при согласования. Первый комментарий - значение вычисленного по матрице риска:

![Комментарий со значением риска](_assets/risk-matrix-value-comment.png "Комментарий со значением риска")

Второй комментарий - другие события из infra, пересекающиеся текущим RFC по времени:

![Комментарий с пересекающимися событиями](_assets/overlapping-events-comment.png "Комментарий с пересекающимися событиями")

После завершения сбора всех OK-ов задача перейдёт в статус _В ожидании_, и изменение будет готово
к выполнению в соответствии с планом.

### Автоматическое согласование

Минорное изменение автоматически переводит задачу в статус _В ожидании_, и такое изменение можно
выполнять в соответствии с запланированным временем проведения изменения. При этом на задачу
выставится тег `noc-cm:auto-approved`, и будет опубликован соответствующий комментарий:

![Комментарий автоматического согласования](_assets/auto-approve-comment.png "Комментарий автоматического согласования")

На этом этапе также публикуются комментарии со значением риска и пересекающимися изменениями, как и
на этапе согласования через сбор OK-ов.

### Ожидание выполнения

После согласования изменение переходит в статус ожидания начала выполнения. При этом создаются
события в [infra](https://infra.yandex-team.ru) и в [календаре](https://calendar.yandex-team.ru), и
ссылки на эти события постятся комментарием к задаче:

![Комментарий с созданными событиями](_assets/events-posted-comment.png "Комментарий с созданными событиями")

Задача остаётся в статусе _В ожидании_, пока ответственный не начнёт выполнение задачи. Начать
выполнение можно соответствующей кнопкой перехода:

![Начать выполнение](_assets/begin-execution.png "Начать выполнение")

После этого задача перейдёт в статус _В работе_.

Также можно отменить изменение на этом этапе соответствующей кнопкой перехода:

![Отменить согласованное изменение](_assets/cancel-approved-rfc.png "Отменить согласованное изменение")

### Выполнение изменения

После начала выполнения задача находится в статусе _В работе_.

Можно завершить изменение нажатием кнопки перехода "Закрыть":

![Завершить изменение](_assets/close-rfc.png "Завершить изменение")

При этом будет предложено выбрать резолюцию:

- _Откат изменения_ - выполняется в случае, если после выполнения изменения наблюдается
незапланированное поведение системы и приводит к деградации метрик и показателей доступности
системы. Откат может включать в себя либо отмену вводимых команд, либо восстановление конфигурации
системы из резервной копии. При выполнении отката необходимо оценить потенциальные риски, связанные
с отклонением поведения системы от запланированного состояния и риски, связанные с возможной
деградацией производительности системы в процессе осуществления отката изменения.
- _Сделано_ - если изменение выполнено


## Приборы для мониторинга

- [Netmon noc-sla](https://netmon-noc-sla.n.yandex-team.ru/view/noc_sla/?views=bb6%3Audp%3Aconn100%2Cbb6%3Audp%3Artt90) -
  RTT и проверка связности
- [Mondata noc_sla alerts](https://solomon.yandex-team.ru/admin/projects/noc/alerts?text=noc_sla) -
  алерты noc_sla
- [Heatmap](https://heat.yandex-team.ru/) - алерты по различным кастомным проверкам
- [Cacti Weathermap](http://cacti-noc.yandex.net/plugins/weathermap/weathermap-cacti-plugin.php?action=viewmap&id=dc3dd752b90ed19d1485) -
  состояние кросс-ДЦ связности
- [Link Utilization Checker](https://noc-luc.yandex.net/) (LUC) - путь от хоста до хоста и
  утилизация линков
- [Graphene](https://graphene.yandex-team.ru/) - дашборды с графиками сетевых устройств
- [Juggler](https://juggler.yandex-team.ru/dashboards/e177dc66/) - событийный мониторинг, ведет на
  дашборд c алертами для NOC
- [Megaping](https://grafana.yandex-team.ru/d/XS1wH8SWz/megaping?orgId=1) - мониторинг доступности
  AS Яндекса извне
