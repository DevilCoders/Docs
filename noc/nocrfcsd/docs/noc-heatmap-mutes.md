# Мьюты в NOC Heatmap

## Кейс

Для тех, кто активно использует [NOC Heatmap](https://heat.yandex-team.ru), необходимо прямо при
заведении работ в NOCRFCS скрывать некоторые события, которые ожидаемо возникнут во время работ. Это
поможет другим коллегам не реагировать на заведомо ожидаемое плановое событие в мониторинге. При
этом самому ответственному за работы необходимо иметь возможность видеть действительное состояние
события.

## Краткое описание работы

1. При заведении работ в форме указываются устройства и выставляется флаг _Установить мьют в хите_
2. Мьют создаётся после начала выполнения NOCRFCS (нажатие кнопки _Начать выполнение_)
3. В комментарии к NOCRFCS-задаче указывается информация о созданном мьюта
4. В NOC Heatmap по скрываемым событиям виден мьют в комментариях и есть возможность их исключения
   из дашборда

## Детальное описание работы

### Заведение работ через форму

При заведении работ нужно заполнить поля:

- _Устройства_ - указывается список устройств, на которых производится изменение; после заполнения
  этого поля становится доступно следующее поле _Установить мьют в хите_
- _Установить мьют в хите_ - выставляется чекбокс, который и определяет факт создания мьюта
- _Mondata help key {1,2,3}_ - опицонально указываются mondata help keys, по которым нужно создать
  мьют

Пример:

![Установка мьюта при заполнении формы](_assets/form-enable-mute.png "Установка мьюта при заполнении формы")

### Создание мьюта

Мьют создаётся после нажатия кнопки перехода _Начать выполнение_ в startrek-задаче. Создание мьюта
происходит следующим образом:

- демон NOCRFCS создаёт джобу в ЦК типа `nocrfcs_juggler_mute`
- демон NOCRFCS создаёт комментарий к NOCRFCS-задаче с информацией о созданной джобе
- ЦК-джоба создаёт мьют в juggler
- ЦК-джоба создаёт комментарий к NOCRFCS-задаче с информацией о созданном juggler-мьюте
- ЦК-джоба ждёт закрытия NOCRFCS-задачи определённое время
- NOC Heatmap начинает получать juggler-мьют в при поллинге и скрывает событие

![Комментарии о созданном мьюте](_assets/heatmap-mute-startrek-comments.png "Комментарии о созданном мьюте")

### Влияние мьюта на поведение дашборда NOC Heatmap

NOC Heatmap при появлении мьюта делает следующее:

- по хосту и mondata help keys определяет события, которые должны быть замьючены
- показывает на дашборде рядом с событием комментарий "Muted by ..." с указанием NOCRFCS-задачи в
  startrek, если для дашборда **не выставлен** чекбокс "Не показывать замьюченные события"
- скрывает событие, если для дашборда **выставлен** чекбокс "Не показывать замьюченные события"

В зависимости от того, были ли указаны mondata help keys при заведении работ в форме NOCRFCS,
поведение мьютов будет отличаться:

- если при заведении работ в форме NOCRFCS не было указано ни одного mondata help key, то мьютятся
  все события для хостов, указанных в поле "Устройства"
- если были указаны один или несколько mondata help keys, то для хостов, указанных в поле
  "Устройства", мьютятся только те события, которые имеют указанный mondata help key

Ниже приведён пример проставленного мьюта для хоста `noc-sas` с указанием mondata helpkey
`mondata_help_rt-import-bot`. Для хоста `noc-sas` есть несколько событий, но только часть из
них подпадают под условие `mondata_help_rt-import-bot`.

Вариант отображения события с комментарием:

![Комментарии о созданном мьюте](_assets/heatmap-muted-event-visible.png "Комментарии о созданном мьюте")

Если выставить галку в "Не показывать замьюченные события", то события "Duplicate OEM" не будут
отображаться на дашборде, при этом все другие события для хоста `noc-sas` останутся видимыми:

![Скрытие события](_assets/heatmap-muted-event-hidden.png "Скрытие события")

Состояние флага "Не показывать замьюченные события" по-умолчанию определяется настройками дашборда:
нужно выставить `showMuted` в
[YAML-конфиге нужного дашборда](https://a.yandex-team.ru/arcadia/noc/heatmap/dashboards).

### Снятие мьюта

Мьют удалится сам в следующих случаях:

1. При наступлении времени завершения мьюта, которое совпадает с _Временем окончания_ работ,
   указанных в RFC
2. При закрытии NOCRFCS-задачи

В первом случае также ЦК-джоба призовёт _Исполнителя_ RFC в комментарии:

![Призыв ЦК об истёкшем мьюте](_assets/ck-blame-expired-mute.png "Призыв ЦК об истёкшем мьюте")
