# nocrfcsd

Демон, выполняющий автоматизацию вокруг startrek-очереди NOCRFCS:

- создание изменений
- согласование изменений, в том числе через сервис OK
- публикация событий в infra и в календарь

## Интеграции

Демон nocrfcsd взаимодействует с системами:

- [startrek](https://st.yandex-team.ru) - собственно работа с тикетами
- [infra](https://infra.yandex-team.ru) - публикация событий
- [OK](https://wiki.yandex-team.ru/intranet/ok/) - согласование изменений
- [staff](https://staff.yandex-team.ru) - получение uid по username
- [cal](https://calendar.yandex-team.ru) - добавление события в календарь ответственного за изменение
- [tvm](https://wiki.yandex-team.ru/passport/tvm2/) - аутентификация

## Исполняемые файлы

В проекте используется два исполняемых файла:

- `nocrfcs-daemon` - основной демон, реализующий всю автоматику
- `nocrfcs-migrate` - утилита миграции

### nocrfcs-daemon

```bash
nocrfcs-daemon
```

### nocrfcs-migrate

```bash
nocrfcs-migrate
```

## Конфиг

Конфигурируется переменными окружения:

- `LISTEN` - хост и порт, на котором слушает демон
- `POSTGRES` - URI или DSN соеднинения с postgres
- `POSTGRES_MIGRATIONS_DIR` - директория с миграциями
- `STAFF_API_BASE_URL`
- `STAFF_API_TOKEN`
- `INFRA_API_BASE_URL`
- `INFRA_WEB_BASE_URL`
- `INFRA_API_TOKEN`
- `OK_API_BASE_URL`
- `OK_WEB_BASE_URL`
- `OK_API_TOKEN`
- `STARTREK_API_BASE_URL`
- `STARTREK_API_TOKEN`
- `CALENDAR_API_BASE_URL`
- `CALENDAR_WEB_BASE_URL`
- `CALENDAR_TVM_ALIAS`
- `TVM_SELF_ALIAS`
- `MANUAL_APPROVER_LOGINS`
- `RESPONSIBLES` - путь к json-файлу с ответственными за infra-окружения

## Project layout

- `cmd` - команды
  - `nocrfcs-daemon` - основная команда, представляющая запущенный демон
  - `nocrfcs-migrate` - утилита миграции
- `internal` - непубличные компоненты
  - `config` - конфиг демона и парсинг json-файла
  - `db` - реализация репозитория для PostgreSQL с драйвером [pgx](https://github.com/jackc/pgx)
  - `infra` - интеграция с infra.yandex-team.ru
  - `infrapoller` - поллер иерархии infra.yandex-team.ru, сохраняющий всю иерархию в базу
  - `models` - общие модели, которые шарятся между компонентами
  - `ok` - интеграция с ok.yandex-team.ru
  - `repository` - интерфейс к репозиторию, слою персистентности
  - `rfcapi` - будущее HTTP/JSON API для работы с RFC
  - `staff` - интеграция с staff.yandex-team.ru
  - `startrek` - интеграция с startrek.yandex-team.ru
  - `startrekwebhooks` - HTTP-хэндлеры, обрабатывающие интеграционные вебхуки от Startrek
  - `testhelpers` - пакет, который содержит общие вспомогательные функции для тестов пакетов
  - `uuidgenerator` - пакет, предоставляющий реальную и моковую реализацию генерации UUIDv4
  - `workflow` - воркфлоу/логика работы с RFC

## Описание воркфлоу NOCRFCS

Общий воркфлоу работы NOCRFCS:

- создание тикета на изменение
- согласование изменения
- публикация изменения
- выполнение изменения
- завершение

## Создание тикета

Заполняется форма [Запрос на изменение (NOCRFCS)](https://forms.yandex-team.ru/surveys/21525/). После "отправки" формы
создаётся Startrek-задача, и Startrek выполняет триггер, настроенный на вызов nocrfcsd по HTTP-вебхуку
`POST /startrek-webhooks/handle-new-issue`. Получив запрос с данными тикета, nocrfcsd сохраняет в базу тикет вместе со
спаршенным из описания RFC-ом и начинает этап согласования

## Согласование изменения

Согласование происходит по оценке параметров RFC, в том числе в зависимости от числовой оценки риска по риск-матрице.
В зависимости от этих параметров может произойти следующий вид согласования:

- запуск процесса согласования, ручное согласование или согласование через сервис ok.yandex-team.ru (описано ниже)
- автосогласование (описано ниже)

После запуска одного из согласований в Startrek-задачу добавляется два комментария:

- результат оценки числового риска по риск-матрице
- пересекающиеся с RFC по времени другие события из infra.yandex-team.ru

Дальше в зависимости от вида согласования и от действий согласующих, Startrek-задача может либо
перейти в

### Ручное согласование

Выбирается ручное согласование, когда не удалось найти захардкоженных в конфиге ответственных `.approve.responsibles`
или когда в самом RFC не указаны согласующие.

Ручное согласование представляет собой призыв людей, указанных в конфиге `.approve.manualApproverLogins`

Призванные люди могут сделать следующее:

1. В startrek нажать кнопку "Согласовать", и тогда задача перейдёт в статус "В ожидании"
2. В startrek нажать кнопку "Отменить запрос (Закрыть тикет)", и тогда задача перейдёт в статус "Закрыт"

В первом случае workflow пойдёт дальше, во втором он заканчивается

### Согласование через сервис OK

Выбирается согласование через сервис OK, когда имеются захардкоженные в конфиге ответственных `.approve.responsibles`
логины или когда в самом RFC указаны согласующие.

На найдённых ответственных создаётся согласование через сервис OK и в startrek-задачу отправляется комментарий
с виджетом сервиса OK по этому созданному OK-согласованию. В результате изменение либо согласуется (задача перейдёт в
статус "В ожидании"), либо не согласуется (и тогда весь workflow заканчивается).

### Автосогласование

Если изменение по риск-матрице (и по другим параметрам) не оценивается как что-то критичное и требующее согласования, то
происходит автосогласование, при котором nocrfcsd выполняет следующее:

- startrek-задача переводится в статус "В ожидании"
- к startrek-задаче добавляется тег `noc-cm:auto-approved`
- к startrek-задаче добавляется комментарий "This change request is auto approved."

## Публикация изменения

Когда задача согласована переходит в статус "В ожидании", nocrfcsd получает HTTP-вебхук
`POST /startrek-webhooks/handle-post-event` и выполняет следующее:

- создаёт событие в infra.yandex-team.ru с изменением
- добавляет в календарь ответственного за RFC событие (если ответственный согласился на это)
- добавляет к startrek-задаче тег `noc-cm:infra-posted`
- добавляет к startrek-задаче комментарий с созданным в infra событием

## Выполнение изменения

Когда задача согласована и находится в статусе "В ожидании", ответственный за RFC в startrek нажимает кнопку
"Начать выполнение". Задача переходит в статус "В работе"

## Завершение изменения

Когда ответственный за RFC заканчивает работы, он нажимает в startrek-задаче кнопку "Закрыть", после чего
startrek-задача переходит в статус "Закрыт", и созданное в infra событие завершается

На этом этапе nocrfcsd не участвует

## TODO

- аутентификация триггерных вебхуков от Startrek через Basic Auth или по OAuth-токену (связано с STARTREK-19577)
- интеграция с error booster
- мониторинги
