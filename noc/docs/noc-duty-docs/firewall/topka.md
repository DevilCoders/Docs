# Введение

В NOC для раскатывания фаервольных правил организован целый процесс полокационной выкладки.

Основная идея в том, что периодически поллится CVS, который является source-of-truth для фаервольных правил. Из
интересующих нас файлов собирается снапшот, на который впоследствии натравливаются два класса проверок: эвристическая и
интеграционная через Valve.

Если все хорошо, то снапшот помечается как валидный и может быть раскатан на ДЦ согласно расписанию.

Однако, эти проверки иногда могут ломаться, что приводит к блокировке выкладки. Об этом и поговорим поподробнее.

## topka-prod:snapshot_diff_slb {#topka-prod:snapshot_diff_slb}

**Причина проблемы:** скрипт эвристической проверки изменений правил фаервола вернул ошибку, т.к. были превышены
выставленные уставки. Правила фаервола в этом случае перестают обновляться - как на HBF/Core в случае фейла снапшота
HBF, так и на SLB в случае фейла снапшота SLB (эти две блокировки независимы).

В любом случае, требуется вмешательство.

Несмотря на то, что есть более продвинутая автоматика в виде Valve, этот алерт остается актуальным по причине все еще
недостаточно полного покрытия всевозможных потребителей правил.

**Решение:** первое, что стоит делать, это зайти на [firewall.yandex-team.ru](https://firewall.yandex-team.ru)
и проверить, что проблема все еще актуальна.

Если последний снапшот на странице HBF/SLB все еще помечен красным - значит актуальна. Если нет, то все хорошо, ничего делать не надо и алерт в heat погаснет сам.

![](img/topka-1.png)

Дебаг на текущий момент состоит из следующих шагов:
1. Кликнуть на ссылку `Failed`.
   ![](img/topka-2.png)

2. В открывшемся окне кликнуть на кнопку `Compare to Previous Valid`.
   ![](img/topka-3.png)

3. Загрузится цветной diff всех файлов, которые были изменены в этом снапшоте по сравнению с последним валидным.
   ![](img/topka-4.png)

4. Теперь стоит почитать изменение какого файла стриггерило фейл проверки. В данном случае это изменение в балансерной
   секции `dtps.tst.vs.market.yandex.net`. Эвристическая проверка довольно тупая и смотрит просто на количество
   удаленных строк. Причины удаления этих строк и стоит выяснить.

   Одним из наиболее удачных инструментов в этом вопросе является, как ни странно, СтарТрек. Вбиваем интересующий нас
   [таргет](https://search.yandex-team.ru/stsearch?text=dtps.tst.vs.market.yandex.net&sorted=updated) и обязательно
   сортируем по дате изменения, чтобы было проще искать.

   Основные причины удаления строк из файлов:
     - дырки удалили (или отредактировали) штатно, в этом случае найдутся тикеты в `DOSTUPREQ`;
     - дырка была временной и её время истекло, можно проверить, что она была, в поиске Панчера;
     - правило стало выгружаться в другую секцию, а из старой удалилось, в этом случае найдётся тикет на смену секции;
     - назначение из правила было удалено. Тут надо смотреть, что это за назначение. Если VS - то можно проверить в l3mngr, если макрос - то в истории `macros-inc.m4`, если fqdn - то в очереди `DNSREQUESTS`. Надо иметь в виду, что Панчер продолжает выгружать удалённый таргет ещё семь дней после удаления, потому соответствующее событие скорее всего произошло неделю назад.

   В случае на скриншоте в одном из тикетов, ближайщем к дате алерта, [были закопаны](https://st.yandex-team.ru/CSADMIN-33347) балансеры,
   среди которых находился тот, который мы и наблюдаем в диффе.

   Отсюда можно сделать вывод, что изменение вполне валидное.

5. Теперь необходимо протолкнуть снапшот на дальнейшие проверки. Для этого необходимо обновить страницу (вдруг кто-то
   уже это сделал) и нажать на неприметный раскрывающийся список напротив требуемого снапшота, выбрав там
   `Mark diff valid`.
   ![](img/topka-5.png)

6. Надо описать причину разблокировки (номер тикета вполне подойдет) и, собственно, разблокировать. Выкатка после этого
   будет работать в штатном режиме.

7. Итогда случается так, что в момент разблокировки прилетает еще один снапшот, который не проходит проверку по той же
   самой причине. Тогда следует мельком глянуть на изменения и проделать шаг 5.

Если блокировка выкладки произошла по причине удаления файлов из ipfw-sections, можно разблокировать без выяснения причин.


В случаях, когда совсем ничего не понятно, проблему можно сдать [esafronov@].

[esafronov@]: https://staff.yandex-team.ru/esafronov

## topka-prod:snapshot_diff_hbf {#topka-prod:snapshot_diff_hbf}

Проблема аналогична вышеуказанной, только тут уже участвуют не балансерные правила, а HBF. Алгоритм дебага остается
примерно таким же.
