# Шаги, обязательные всегда
- Нужно узнать конретные
    - src (хост или пользователь),
    - dst (хост и порт),
    - протокол
    - как именно проверяется, что доступа нет (`nc`, `telnet` и т. п.), желательно с выводом команды,
    - какое правило должно разрешать доступ.
- Нужно ввести эти src и dst в поиске Панчера и проверить, находится ли разрешающее правило.

# Если правило не находится
- Проверить, нет ли какой-то человеческой ошибки, например
  - заказали одно, а проверяют другое;
  - опечатались в порте;
  - правила ещё нет, есть только неподтверждённая заявка;
  - правило было, но сейчас отредактировано или удалено;
  - заказали дырку от SLB, а ходят с рила.
- В случае динамики (доступы от людей) правило может не находиться, потому что пользователь не входит в группу, указанную в правиле. Это может быть как человеческая ошибка (заказали доступ от какого-то департамента / сервиса, куда пользователь не входит), так и ошибкой со стороны стафф-апи. Группы с точки зрения стафф-апи можно посмотреть по этому урлу - `https://staff-api.yandex-team.ru/v3/groupmembership?person.login=<login>` . Если в интерфейсе стаффа / ABC какая-то группа у пользователя есть, а в выводе апи - нет, то это надо сдать в tools@.
- В случае статики (доступы от серверов) правило может не находиться, потому что хост / макрос (src или dst) не является потомком макроса, указанного в правиле. Иерархию родителей можно проверить по этому урлу - `https://puncher.yandex-team.ru/api/dynfw/parents?q=<хост / макрос / адрес>` . Надо понять, почему ожидания об иерархии не соответствуют реальности.
- Если предыдущие пункты не решли проблему, и правило не находится, хотя явно должно, надо сдать это ответственным за Панчер.

# Если правило находится
- Проверить (с `noc-sas` или `noc-myt`), что dst действительно отвечает по указанному порту.
- Проверить, всё ли хорошо c файрвольной инфраструктурой:
  - в [хите](https://heat.yandex-team.ru/) не горят старые (больше часа) алерты про файрвол, Панчер или Racktables;
  - на [firewall.yandex-team.ru](https://firewall.yandex-team.ru/) ничего не заблочено;
  - нет каких-то глобальных проблем со Стаффом, ABC, IDM (в зависимости от того, про что правило).
- Если правило статическое и до хостнейма (или хостового макроса), проверить, что нет неподтверждённых заявок на смену секции. Искать можно [так](https://st.yandex-team.ru/issues/?_f=type+priority+key+summary+description+status+resolution+updated+assignee+parent&_q=Summary%3A+%22%D0%B8%D0%B7%D0%BC%D0%B5%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5+%D1%81%D0%B5%D0%BA%D1%86%D0%B8%D0%B9+%D0%B4%D0%BB%D1%8F+taxi-protocol-l7.taxi.yandex.net%22+AND+Queue%3A+DOSTUPREQ+and+Resolution%3A+empty%28%29) (замените хост на нужный).
- Если правило до dst в Облаке,
  - убедитесь, что dst всеми (!) своими адресами входит в (является потомком) `_VRF_CLOUD_NETS_`  , `_CLOUDINFRANETS_`  или `_CLOUD_INFRA_PUBLIC_VIPNETS_`  (см. [PUNCHER-933](https://st.yandex-team.ru/PUNCHER-933))
  - в случае дырок до облачных балансеров, убедитесь, что заказаны [нужные дырки до рилов](https://wiki.yandex-team.ru/cloud/devel/platform-team/l7/usage/puncher/)
  - убедитесь, что правило доехало на BSD-шные файрволы.
- Если правило статическое, и на хостах есть HBF, надо убедиться, что разрешающее правило есть на обеих сторонах и нет каких-то руками написанных запрещающих правил (нужен вывод `iptables-save`  и `ip6tables-save` ). Также надо убедиться, что в [логах hbf](https://wiki.yandex-team.ru/runtime-cloud/yandex-hbf-agent/) нет ничего криминального.
- Если правило динамическое, надо убедиться, что
  - само правило [выгружается](https://a.yandex-team.ru/robots/security/security-fw/rules.m4)
  - группа пользователей выгружается в правильном составе в один из файлов [здесь](https://a.yandex-team.ru/robots/security/security-fw/new_files)
    - если не выгружается LDAP-группа, возможно это [NOCDEV-5699](https://st.yandex-team.ru/NOCDEV-5699), надо попросить админов LDAP сделать подгруппы
    - если внешний пользователь не выгружается в составе группы, возможно пользователя нет в выгрузке сертификатора в CVS. (На серверах Панчера её можно глянуть в `/tmp/cvs/security/certs/certs.json`)
- Если ничего из вышенаписанного не помогло, значит история мутная, надо сдавать проблему экспертам.
