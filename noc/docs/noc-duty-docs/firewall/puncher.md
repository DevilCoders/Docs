# Устройство Панчера кратко
Панчер - это инструмент для управления файрвольными правилами. Он хранит в себе информацию о содержимом правил, ходит во внешние системы за всякой дополнительной информацией и выгружает правила в CVS и SVN.

Подробнее можно почитать в ридми [здесь](https://a.yandex-team.ru/arc/trunk/arcadia/noc/puncher/).

Есть небольшой [пользовательский FAQ](https://wiki.yandex-team.ru/noc/nocdev/puncher/FAQ/), возможно там есть ответ на нужный вопрос.

Продакшен хосты можно глянуть [в Кондукторе](https://c.yandex-team.ru/groups/nocdev-puncher). Монга - [вот эта](https://yc.yandex-team.ru/folders/foosk13mu0ib9qrjkh8a/managed-mongodb/cluster/mdbasegu7dup3069c1ru).  Фронтенд-часть живёт [в Деплое](https://deploy.yandex-team.ru/stages/puncher-production/).

# Типичные задачи
## Как выкатить?
В [Arcadia CI](https://a.yandex-team.ru/projects/nocdev/ci/releases/timeline?dir=noc%2Fpuncher&id=puncher-release).

## Где смотреть логи?
На рилах, через journald, `sudo journalctl -u puncher-<имя сервиса> -r`

Также на каждом риле можно выполнить команду `puncher-info monitor`, она покажет состояние мониторингов на этом риле. Также её удобно использовать для определения текущего мастера того или иного сервиса.

## Есть ли метрики?
Есть два дашброрда:
  - [тайминги и фоновые задачи](https://graf.yandex-team.ru/d/eN2pjtLmz/puncher);
  - [количественные показатели](https://graf.yandex-team.ru/d/ozURX-Znz/puncher-counters).

## Как остановить экспорт правил
Если вдруг оказыватся, что рулсет, экспортируемый Панчером, невалидный (например отрывает нужные доступы), можно заблокировать экспорт правил до починки. Вот так:
```
$ puncher-info monitor
...
  exportd_static_writable        | 0;OK
  exportd_dynfw_writable         | 0;OK
$ puncher-info fwprefs list
Dynfw: OK
Static: OK
$ puncher-info fwprefs stop dynfw
```

Синтаксис - `puncher-info fwprefs <mode> <fw>`

- `fw`
  ```
  - dynfw - динамический fw (svn)
  - static|freebsd - статический (cvs)
  - all|fw - все сразу
  ```
- `mode`
  ```
  - start|1|enable - включить
  - stop|0|disable - выключить
  ```

После остановки экспорта рулсет нужно откатить к валидному состоянию, это делается средствами соответствующей VCS (CVS или SVN).

После починки проблемы экспорт включается той же командой с mode `start`.

## Зажёгся алерт, что делать?
Алерты можно разделить на три группы:
  - какой-то сервис не запущен, например `daemon_ping`. Надо пойти на соответствующий хост и посмотреть по логам, почему он не запущен.
  - какой-то периодический процесс завершается с ошибкой или долго не завершается успешно, алерт будет содержать слово `workers` или `last success was`, например `rules_cauth_workers` или `import users from Staff: last success was at 2021-08-18 07:44:44` Надо смотреть логи и разбираться, что именно вызвало эту ошибку (или на каком шаге оно зависло).
  - разъехался выбор мастера, будет содежать `is_master`, например `importd_is_master`. Почти никогда не загорался, но если загорится - какие-то проблемы с выбором мастера через Монгу.
  - `Commit dynwf error`, редкая ошибка, обычно вызванная тем, что рулсет динамического файрвола не проходит валидацию. Надо читать логи в поисках ошибки, одной из причин раньше было то, что в имени группы на стаффе содержалась кириллическая `с`.

Алерты сейчас могут загораться во время деплоя, это планируется починить.

## Пришли с жалобой или вопросом, что делать?
### Не работает дырка
См. [отдельную инструкцию](./debug) на эту тему.

### Что-то не доезжает до Панчера (новый ABC-сервис и т. п)
Среднее время выполнения импорта в `usersd` - около 50 минут (точное время можно посмотреть на [дашборде](https://graf.yandex-team.ru/d/eN2pjtLmz/puncher)). Если после указанного времени искомого объекта всё равно нет в Панчере, надо убедиться, что он отдаётся внешней системой (стафф-апи, RT) и т. д. Если отдаётся, значит баг, нужно дебажить.
Пример проверки сервиса в выдаче: [staff api](https://staff-api.yandex-team.ru/v3/group?service.id=968)

Отдельный случай - генцфг-макрос, который не ищется в RT. Тут ответ скорее всего [такой](https://wiki.yandex-team.ru/noc/nocdev/gencfg-macro-del/).

### Пользователь есть в ABC, а Панчер считает, что нет (и наоборот)
Прежде всего см. предыдущий пункт, надо убедиться, что всё доехало. Если картина актуальная, то скорее всего влияют настройки наследования для вложенных сервисов, посмотреть можно [вот так](https://st.yandex-team.ru/ABC-12878#627b89bfc4b0353c92d20bd1).

### Почему я тут ответственный?
На эту тему есть [пост](https://clubs.at.yandex-team.ru/noc/2916) и [пост](https://clubs.at.yandex-team.ru/noc/3538).

### Как бы мне что-то поменять в DNS и чтоб трафик ходил?
На эту тему есть [пост](https://clubs.at.yandex-team.ru/noc/3303).

### Как мне отредактировать много правил разом?
Через [консольный клиент](https://wiki.yandex-team.ru/noc/nocdev/puncher/konsolnyjj-klient/). Если пользователю не нравится, что придётся ждать явных апрувов, то можно отправить к СИБ, они могут сделать это без апрувов.

### Удалите правило, не могу это сделать через веб-интерфейс
Панчер забирает часть правил из CVS. В правиле указан файл, откуда оно забирается, надо пойти и удалить его руками.

### Администраторы не могут заказать / отредактировать правило до хостов (или хостовых макросов) в L2
Скорее всего это вызвано тем, что после закрытия Голема ответственных за их fqdn в коммунальных сетях брать теперь неоткуда. Проверить можно в RT поиском по FQDN, если там в секциях что-то [отсюда](https://racktables.yandex-team.ru/index.php?andor=and&cft%5B%5D=683&cfe=&page=files&tab=default), то это наш случай.

Стоит предложить съехать из коммунальных сетей в MTN, а при невозможности - обратиться за помощью к СИБ, они могут править любые дырки, даже без ответственных.
