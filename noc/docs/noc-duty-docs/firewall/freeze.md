# Починка заблокированной выкладки правил
Правила файрвола создаются и редактируются, а потом раскатываются на сами файрвольные устройства, где пропускают или блокируют трафик. Но иногда этот процесс нарушается и выкладка правил на каком-то этапе блокируется. Длительная (более часа) заблокированная выкладка - это плохо, потому что у коллег из всей компании перестают доезжать их дырки и страдают бизнес-процессы. Поэтому чинить такое нужно оперативно.

## Что может заблокироваться
Выскоуровнево процесс доставки правил состоит из трёх этапов:
1. Правила генерируются.
2. Правила валидируются.
3. Правила применяются на файрволах.

На каждом из этих этапов что-то может пойти не так и застопориться. Есть ещё несколько причин:

4. Выкладка правил была заблокирована руками (человека или робота).
5. Выкладка заморожена из-за появившихся в большом количестве дропов hbf на rtc серверах.

Рассмотрим эти четыре причины подробнее.

## Проблемы при генерации правил
Источником большей части правил является [Панчер](https://puncher.yandex-team.ru/). Соответственно, проблемы на стороне Панчера могут нарушать ход генерации правил. Подробнее об этих проблемах см. [соответствующий раздел](./puncher).

Также некоторое количество правил по историческим причинам лежит в CVS ([статический файрвол](https://cvs.yandex-team.ru/cgi-bin/cvsweb.cgi/noc/routers/fw/), [балансерный файрвол](https://cvs.yandex-team.ru/cgi-bin/cvsweb.cgi/noc/balancers/iptables/)) и SVN ([пользовательский файрвол](https://a.yandex-team.ru/robots/security/security-fw)). Эти правила меняются редко и обычно под NOCRFCS.

## Проблемы при валидации правил
Для статического и балансерного рулсета у нас существует процесс валидации - перед выкладкой правил, мы убеждаемся (насколько можем), что они ничего не сломают.

Сначала проверяется, что в диффе правил не произошло [подозрительных изменений](https://a.yandex-team.ru/arc/trunk/arcadia/noc/topka/pkg/topka/forge/difftool/errors.go). Если такое случилось, то загорятся алерты вида `topka-prod:snapshot_diff_*`. Что с ними делать, см. в [соответствующем разделе](./topka).

Если дифф хороший, мы прогоняем через рулсет предварительно собранные сэмплы траффика и убеждаемся, что не возникло новых дропов. Если дропы возникли, то загорятся алерты вида `topka-prod:snapshot_validator_*`. Что с ними делать, см. в [соответствующем разделе](./valve).

Другие алерты со словами `topka` или `valve` также могут указывать на то, что у нас что-то сломано с валидацией и выкаткой правил, их нужно обязательно чинить.

## Проблемы при применении правил
На разных файрволах применяются по-разному, но основных подхода два:
  - пуш-модель: какая-то внешняя система идёт на файрвол и запскает на нём обновление рулсета, у нас это балансерный, пользовательский и прочие файрволы на базе FreeBSD;
  - пулл-модель: файрвол сам периодически подтягивает себе свежие правила, у нас это HBF и Yanet.

На файрволах, использующих пулл-модель, в штатном режиме ничего блокироваться не должно. Так что тут какого-то стандартного алгоритма дебага нет, разве что: если на них зажёгся алерт, надо разбираться.

Файрволы, использующие пуш-модель, рестартятся через Racktables (начать смотреть код можно [отсюда](https://noc-gitlab.yandex-team.ru/nocdev/racktables/-/blob/master/scripts/fw-restart.php)). В случае проблем зажигается алерт вида `firewall restart is locked for *`. Дальше будет написан список файрволов, на которых возникли проблемы с рестартом и их тип (например, `balancer:vla1-3lb3b`). Эти устройства надо открыть в RT, перейти на вкладку "Firewall" и там в самом низу страницы можно будет увидеть логи неудачного рестарта. Дальше должно стать понятно, что делать.

Чтобы воспроизвести ошибку, нужно зайти на файрвол и руками перезапустить обновление правил через `make -C /usr/local/router/fw restart`. Командой `make -C /usr/local/router/fw update` можно обновится до актуального состояния правил из CVS.

## Ручная блокировка
Почти на всех этапах, описанных выше, есть ручки, чтобы остановить процесс выкладки правил. Можно запретить выгрузку из Панчера, раскатку из Топки или рестарт файрволов в RT. В этом случае зажжётся алерт из которого будет понятно, что случилось.

Также есть блокировка выкладки правил на основании графика дропов от RTC. В этом случае зажжётся алерт вида `topka-prod: iva, man, myt, sas, vla by robot-topka@ ...`, а в [веб-интерфейсе Топки](https://firewall.yandex-team.ru/) будут ссылки на графики RTC в Головане. Нужно разбираться в причинах дропов, стоит воспользовать следующей [документацией](https://wiki.yandex-team.ru/rtcnetdev/diagnostika-dropov-hbf/). Если по графикам в yasm(ссылки на которые есть в жуглерных алертах) не удалось вычислить(с помощью разложения по проекту) виновника, то вам потребуется доступ на rtc хосты(нужно получить роль в ABC проекте [Дверь в RTC](https://abc.yandex-team.ru/services/doortortc)), по графикам находим хост с дропами, заходим на него и действуем по документации, возможно понадобится помощь команды RTC, не стесняемся им писать. И очень может быть, что понятно ничего не станет, дропы уйдут так же внезапно, как и пришли, а вердикт будет примерно [таким](https://st.yandex-team.ru/NOCREQUESTS-22745#602aa831a4f1f370c164fa68).
