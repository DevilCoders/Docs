# Введение

Валидатор фаервольных правил (a.k.a. Valve) - это комплекс аппаратных и программных средств, осуществляющий предварительную
валидацию правил фаервола непосредственно перед их выкладкой. Можно сказать, это отдельный тестировочный контур.
Более подробно о внутренностях и тонкостях его работы можно почитать в лонгриде в [этушке](https://clubs.at.yandex-team.ru/noc/3295),
ну а мы тут поговорим о том, что делать в случае, когда он показал что ВСЕ ПЛОХО.

В качестве дебага используется в основном его морда, которая живет на [https://manage.valve.yandex-team.ru/](https://manage.valve.yandex-team.ru/),
где нас интересует страница с аудитом (раздельная для HBF и SLB снапшотов).

{% note info %}

Сам валидатор настроен таким образом, что снапшот признается плохим только в случае превышения заранее сконфигурированной уставки.
Например, если зафейлено больше 200 хостов или больше 5% ранее проходящих пакетов начали дропаться на новом рулсете.

Это сделано для того, чтобы минимизировать false-negative срабатывания.

{% endnote %}

По опыту эксплуатации можно выделить несколько категорий срабатываний валидатора, он них и поговорим поподробнее.

## topka-prod:snapshot_validator_hbf {#topka-prod:snapshot_validator_hbf}
**Причина проблемы:** валидатор заметил, что кол-во пакетов (или агрегированно - хостов), которые будут дропнуты при накатке
проверяемого рулсета, превышают уставку.

**Решение:** рядом с алертом всегда присутствует ссылка на страницу валидатора, где располагается результат 
аудита данного рулсета. Как это выглядит:

![](img/valve-1.png)

Здесь для снапшота от `Mon Aug 16 2021 17:34:22`, где 2429 из 106950 хостов будет зафейлено, что, в общем-то, достаточно для блокировки выкладки.

Кликнув на ссылку `CRITICAL` мы попадаем на детальную страницу аудита, где будет показано какие именно пакеты с каких хостов
не прошли валидацию.

![](img/valve-2.png)

Тут есть несколько опций, которые могут нам помочь разобраться в чем же именно дело.

Во-первых, можно проанализировать пакеты глазками и заприметить среди них похожие по каким-либо параметрам: либо src/dst IP, 
либо порты, либо макрос - могут быть одинаковыми, что наводит мысль о причине поломки. Если это - однинаковый макрос и 
поиском по StarTrek'у удается найти недавно протолкнутую похожую заявку, то скорее всего дело именно в этом - правило деструктивно,
и стоит выяснить уверены ли авторы в том, что они делают.

{% note info %}

Для удобства был сделан автоматический резолв IP адресов в макросы - для этого достаточно навести курсор на IP адрес, 
и всплывет popup, как показано на примере выше.

Также может быть полезно напрямую проверить в Puncher'е, а не протухло ли правило. Для этого можно нажать соответствующую
зеленую кнопку рядом с каждым пакетом - будет открыта страница Панчера с уже заранее заполненными полями поиска правила
по пакету.

{% endnote %}

Дело в том, что неоднократно были случаи, когда заростали временные (ха-ха) дырки, которые были сделаны на период переезда сервиса
откуда-то куда-то.

И, разумеется, переезда не случалось.

Если все (или большинство) дропов направлены с- или на- одинаковый IP адрес, то, вероятно, сменился хостнейм, а соединения по-прежнему 
устанавливаются на старый адрес. Например, потому что присутствует локальный DNS cache. Убедиться в этом точно можно, просмотрев
diff правил на [https://firewall.yandex-team.ru/](https://firewall.yandex-team.ru/), можно даже по сравнению с предыдущим состоянием.
Если такой хостнейм найден, то - причина найдена. Но на самом деле алерт вполне валидный, потому что раскатка правил на такой хост
вполне может привести к SPI по разным причинам (например, из-за того же несовершенства локального резолвера).

{% note info %}

В данной ситуации лучше всего подождать какое-то время, обычно не больше часа, пока не протухнут все кэши.
В таком случае в валидатор приедут уже новые сэмплы трафика, и последующие валидации не будут содержать дропы.

{% endnote %}

Наконец, если ничего из вышеперечисленного не подходит, то можно попытаться потрейсить пакет, чтобы предположить какое именно правило
дает сбой. Тут, к сожалению, кроме наличия собственных эвристик, опыта и дергающегося от iptables глаза, довольно сложно достоверно 
определить истинную причину поломки.

Тем не менее - если кликнуть на галочку рядом с хостнеймом и нажать кпопку `Trace` в самом верху страницы, то откроется
страница трассировки пакета по текущим правилам.

![](img/valve-3.png)

Нажав `Submit`, получаем трейс того, как пакет будет матчиться по iptables, где по косвенным признакам, типа похожих портов или адресов,
можно догадаться куда же он по-идее должен заматчиться.

#### Исключения валидатора
Иногда бывает так, что Валидатор показывает, что пакеты начнут дропаться, но мы **точно** знаем, что либо Валидатор ошибается (редко, но потенциально возможно), либо нам по каким-либо причинам не хочется блокировать выкладку из-за таких пакетов.
В качестве примера из жизни можно привести три случая:
- Нам шлют заведомо невалидные пакеты. Когда вся инфраструктура была молодая, такое случалось. Сейчас - почти никогда.
- Пакеты действительно идут, но из-за протухшего/удаленного правила скоро перестанут. 
  Такое решается, в первую очередь, поиском и оповещением ответственного за сервис о сути происходящего. Если владелец согласен с потенциальными рисками, например, блокировкой выкладки по фактическим дропам, которые возникнут после применения правила и последующим за ним SPI - мы можем такие пакеты игнорировать.
- Брешью в безопасности или несовершенством комбинации фаервола и сборщика трафика.
  В качестве примера тут можно привести злоумышленные TCP пакеты с установленными SYN + ACK флагами, которые рассылаются внешними сканерами.
  Фаерволл такие пакеты пропускает из-за общего правила, пропускающего пакеты с возведенным флагом ACK, что приводит к тому, что мы их видим (ведь там также есть SYN), хотя фактически трафик будет дропнут.

Во всех этих случаях можно сказать Валидатору, чтобы он игнорировал пакеты по определенному правилу или правилам и не блокировал выкладку.
Такие попадания будут по-прежнему отображаться на странице аудита, но уже будут носить предупреждающий характер.
То есть логика Валидатора следующая: если пакет был дропнут, то проверить, разрешаем ли мы его в исключениях. Если разрешаем, то мы его фиксируем, но для расчета вердикта не принимаем во внимание. 

Чтобы научить Валидатор игнорировать дропнутые пакеты, надо пойти на главную страницу и выбрать в меню пункт **Settings**.
Далее - вкладку **Exceptions**, где откроется текстовая форма примерно такого вида:

![](img/valve-4.png)

Правила-исключения описываются в IPFW формате с полной поддержкой projectID записи как в компактной форме, так и в расширенной - с раскрытой маской.
Все, что нам нужно сделать, это описать новое правило, которое ловило бы пакеты, которые мы хотим игнорировать.

{% note info %}

Не забудьте оставить комментарий, чтобы ваши коллеги, или вы же сами спустя какое-то время, понимали, для чего исключение было сделано.

{% endnote %}

Стоит отметить, что все правила хранятся единым куском, поэтому тут все нюансы IPFW имеют значение, например, порядок.
После того, как правила-исключения были написаны, осталось их опубликовать. Для этого нажимаем кнопку **Update**, после чего появится окно, требующее ввести аутентификационную информацию:

![](img/valve-5.png)

На текущий момент поддерживается только парольная аутентификация. Требуемые креденшелы можно узнать из [Секретницы](https://yav.yandex-team.ru/secret/sec-01ewdwywfgbc08e3zejj7shj7t), для этого необходимо иметь роль **Администратор** в сервисе **NOCDEV**.

После ввода креденшлов жмем зеленую кнопку, после чего исключения обновятся, либо будет ошибка, которая в 99% случаев является следствием синтаксической некорректности правил.

{% note info %}

Ноды Валидатора подхватывают исключения не мгновенно, а по-таймеру раз в 2 минуты.
Скорее всего, этого должно хватить, чтобы в следующий цикл валидации все подхватилось корректно, но в пограничных случаях, например, когда обновление случилось в середину валидации, можно наблюдать применение исключений частично.

Это нормально. 

{% endnote %}

Если все сложилось удачно, то в последующих итерациях можно увидеть, что пакеты стали корректно игнорироваться, но по-прежнему отображаться в аудите в качестве предупреждений:

![](img/valve-6.png)

На этом работа с исключениями закончена.

{% note warning %}

Если вы дошли до этой стадии и по-прежнему ничего не понятно, то алерт лучше сдать в [esafronov@] со всей собранной дебаг информацией.

{% endnote %}

## topka-prod:snapshot_validator_slb {#topka-prod:snapshot_validator_slb}

Тут все аналогично тому, что было описано в разделе про HBF выше, но только применительно к SLB. Все шаги остаются аналогичными, только
для просмотра диффов следует пользоваться соответствующей вкладкой для SLB в [https://firewall.yandex-team.ru/](https://firewall.yandex-team.ru/).

[esafronov@]: https://staff.yandex-team.ru/esafronov