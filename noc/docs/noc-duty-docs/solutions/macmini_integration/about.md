# Типовое решение подключения Mac Mini

Статья описывает типовое решение подключения устройств Mac Mini к сети ДЦ.

Ответственный: Вадим Воловик@

Статус: В разработке

## Предпосылки решения

Mac Mini включается в сеть ДЦ, потому что по правилам компании Apple сборка программного обеспечения должна
производиться на устройствах Apple, а так как серверов Apple не выпускает, то компания Yandex ставит устройства
Mac Mini для разработчиков iOS. Наливка Mac Mini производится через Internet Recovery.

## Включение по L2

Подключение по L2 не является целевым, но является допустимым до 31.12.2021 (если вы это читаете и уже не 2021 год, то сообщите vdvolovik@).

## Включение по L3

### Процедура подключения Mac Mini

Шаг 1. Устройство подключается к коммутатору, подключается питание.

**Если требуется Recovery.**

Шаг 2. Устройство включается в режиме Recovery.

Шаг 3. Устройство получает IPv4 адрес по DHCP, который настроен на Router Malek

Шаг 4. Устройство идет в интернет для загрузки Recovery образа.

Шаг 5. Устройство перезагружается и готово к работе с IPv6.

Если не требуется Recovery - Шаг 2-5 пропускается.

Шаг 6. На Small Switch активируется VLAN.

Шаг 7. На Mac Mini настраивается IPv6 Link-Local адрес.

Шаг 8. На Router Malek применяются правила FW. Настраивается статическая маршрутизация.

### Схема HLD

![HLD L3](./images/hld_l3.png)

### Физическое подключение Mac Mini в стойку

- Mac Mini подключается к сети одним медным 1GE портом.
- В один юнит стойки помещается два Mac Mini.
- В одну стойку помещается 48 Mac Mini, поэтому необходимо предусмотреть установку 48-портового коммутатора
- Для подключения Mac Mini обязательно использовать устройство Router Malek, выполняющий функции NAT64 и FW.
- Текущее количество устройств MacMini: 1500. План на 2022 год: 250
- Целевая схема организации физического подключения оборудования в стойке:

![Physycal scheme](./images/physical_l3.png)

### Схема подключения по IPv4

Схема применяется при загрузке Mac Mini в режиме Recovery. В этом режим устройство идет в Public Internet за образом ОС.
Это может привести к всплеску нагрузки на сети, в случае массового обновления, поэтому на порт вешается policer 100 Mbps.

![IPv4 Схема](./images/ipv4_l3.png)

### Схема подключения по IPv6

Является штатной схемой работы Mac Mini.

![IPv6 Схема](./images/ipv6_l3.png)

