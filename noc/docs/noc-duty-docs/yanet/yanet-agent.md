# Введение

На каждой машине с YANET фаерволом должен стоять Debian пакет **yanet-agent**, который предоставляет одноименный бинарь.
Это приложение ответственно за доставку фаервольных правил, и, если оно выходит из строя, выкладка останавливается.

Его работа состоит из следующих стадий:
- Периодическое выкачивание фаервольного тарбола из firewall.yandex-team.ru.
- Раскрытие макросов и синтаксическая проверка правил.
- Конвертация правил из ipfw формата в янетовский.
- Перезагрузка контролплейна янета.

В случае возникновения ошибки на какой-либо из этих стадий, процесс начинается заново через какое-то (относительно небольшое) время, чтобы минимизировать теребление человекое в случае флапающих проблем.

Также собираются некоторое количество метрик, которые можно посмотреть [здесь](https://grafana.yandex-team.ru/d/wH2Q8DlGk/yanet-agent?orgId=1&refresh=5s&from=now-3h&to=now).

Теперь поподробнее об алертах.

## nocdev-yanet-agent-errors: sum(diff(errors))=NUMBER > 3 on yanet agent; window=5m {#nocdev-yanet-agent-errors}

**Причина проблемы:** агент накопил достаточное для алерта количество ошибок за последние 5 минут. При этом обновление фаервольных правил не происходит.

Убедиться в наличии проблемы сейчас, а также понять, когда точно она началась, можно посмотрев на этот [график](https://grafana.yandex-team.ru/d/wH2Q8DlGk/yanet-agent?orgId=1&refresh=5s&from=now-1h&to=now):

<iframe src="https://grafana.yandex-team.ru/d-solo/wH2Q8DlGk/yanet-agent?orgId=1&refresh=5s&from=now-3h&to=now&panelId=9&theme=light" width="800" height="400" frameborder="0"></iframe>

**Решение:** Причин может быть несколько, агент на текущий момент не особо их классифицирует (хотя надо бы). Самое часто встречающееся - проблемы в офисной сети, т.к. агент использует 666 vlan для коммуникации. 
Можно зайти на пофейлившуюся тачку почитать логи

{% note info %}

Почитать логи можно следующей командой:

`journalctl -u yanet-agent -n 1000`

{% endnote %}

Возможные причины:
- Не удалось скачать снапшот из firewall.yandex-team.ru - возможно, сетевые проблемы, или сервис перегружен.
  
  Сдать дежурному.
- Не удалось скомпилировать правила - парсер недостаточно хорош, либо приехали какие-то совсем ломающие правила.
  
  Сдать [esafronov@].
- Не удалось скормить конфиг в YANET - возможно, кончились лимиты, или было сделано какое-то ломающее формат действие.
  
  Сдать [esafronov@].
- В случае других проблем сдать [esafronov@].

## nocdev-yanet-agent-past-timestamp: detected snapshot from the past, probably restart {#nocdev-yanet-agent-past-timestamp}
**Причина проблемы:** одно из двух: либо на yanet-agent для YANET фаерволов приехал снапшот с правилами более старой версии, чем был последний, либо он порестартился, скорее всего нештатно.

Убедиться можно, посмотрев на следующий график и сопоставив таймштемп снапшота с тем, что должно быть по расписанию на [https://firewall.yandex-team.ru](https://firewall.yandex-team.ru):

<iframe src="https://grafana.yandex-team.ru/d-solo/wH2Q8DlGk/yanet-agent?orgId=1&refresh=5s&from=now-3h&to=now&theme=light&panelId=13" width="800" height="400" frameborder="0"></iframe>

**Решение:**
В первом случае у нас по какой-то причине сломалась монотонность снапшотов, например, его откатили назад руками. Если так - то надо даунтаймить до следующего более нового снапшота (3 часа), иначе сдать [esafronov@].

Во-втором случае либо агент порестартился нештатно, либо не был проставлен тэг "в оффлайне". Надо чинить или проводить воспитательные беседы, сдать [esafronov@].

[esafronov@]: https://staff.yandex-team.ru/esafronov