# Доступ к ресурсам

Автор: [Александр Прохоров](https://staff.yandex-team.ru/alexprokhorov)

## Базовая информация
---
Для авторизации на оборудование NOC существует несколько систем:  
* `CAUTH`  
* `NOCAUTH` (он же tacacs)
* `LocalUser-DB` (далее **`ludb`**)  

**Для ключей в данный момент должен использоваться `Yubikey`, ключи должны быть сгененрированы и добавлены на `staff`**  

###  **TL;DR Как получить доступ?**
1) Нужно понять под какой системой авторизации работает целевая система  

   Простой способ - если устройcтво есть в `Racktables`, то можно посмотреть на теги: `{работает CAuth}` или `[работает nocauth]`, в остальных случаях можно предполагать что устройство под `ludb`. *Прим. {} - тег, [] - предикат(логическое выражение из тегов)*  

   Исключения - устройства, которые не поддерживают эти типы авторизации могут иметь только локальные учетные записи, которые заведены на устройства руками. Доступы для таких устройств складываются в `yav`.

   В данный момент оборудование можно разделить следующим образом:
   1) Большинство машин NOCDEV работает под `CAUTH`
   2) Если машина FreeBSD (nocdev или рыбки), то локальные учетные записи туда доставляет `ludb`
   3) Если это сетевое оборудование (cisco, huawei, juniper итд), то для похода на оборудование нужно использовать `NOCAUTH`. А `ludb` в этом случае используется только как доступ во время факапа и на случай поломки `NOCAUTH`.

2) Заказать доступ через `IDM`, если это `CAUTH` или `NOCAUTH`
3) Если это `ludb`, то нужно проверить, что твои ключи Yubikey есть в `pubkeys` на `CVS`. Если их нет, то создать заявку в очередь `NOCDEVDUTY` на добавление ключей в `pubkeys`
4) Если вы новый сотрудник, или ранее у вас не было доступов на Cisco и Huawei, то нужно сгенерировать хеши для них и положить в CVS.   
Подробнее можно почитать в документации РТ <https://docs.yandex-team.ru/racktables/scripts/gen-hashes>

---
## Кратко как это работает

---
### **CAUTH** 
#### **Общее описание**
CAUTH позволяет логиниться на linux-машины, для этого на машину устанавливается агент cauth.  
CAUTH проверяет, каким пользователям можно ходить на оборудование, и для авторизации использует их ключи со Стаффа.  
CAUTH предоставляет доступ, исходя из следующих систем: 
- `BOT`: менеджерам аппаратных ресурсов сервиса в `ABC`, к которому привязано оборудование
- `CONDUCTOR`: всем "Администраторам" проекта
- `IDM`: Согласно выданным ролям в системе `CAUTH`.

#### **Как заказать доступ**
Рекомендованный путь: заказывать доступ в `IDM` система `CAUTH` и указать кондукторную группу машин.
Обязательно нужно положить свои публичные ключи на `staff`.

#### **Какие группы есть в IDM для CAUTH**
`CAUTH` может использовать кондукторные группы, посмотреть какие кондукторные группы есть у хоста можно через руку Кондуктора:  
- <https://c.yandex-team.ru/api/hosts2groups/noc-vcs-vla.yndx.net>

#### **Кто имеет доступ на железку под CAUTH**
Для этого можно дернуть ручку с fdqn и узнать список:  
- <https://cauth.yandex.net:4443/info/?q=noc-vcs-vla.yndx.net>  

Групповые, как и персональные доступы, выданные через `IDM`, можно посмотреть в `IDM` указав в фильтре нужные группы:  
- <https://idm.yandex-team.ru/system/cauth/roles#f-status=all,f-role=cauth,sort-by=-updated,f-is-expanded=true>

---
### **NOCAUTH**  
#### **Общее описание**
Это такакс NOC для авторизации на сетевых устройствах.  
У `NOCAUTH` есть две компоненты:
- Первая компонента - такакс-сервер, к которому обращается железка и узнает пользователя и какие у него права, авторизация на нем производится по доменному паролю. Чтобы не передавать доменный пароль существует вторая компонента.  
- Вторая компонента - прокси. Доступ на железки для авторизации по такаксу нужно осуществлять через утилиту nocssh, которая при подключении на устройство - переключает тебя на jump-хост, который проверяет твой ключ, генерирует одноразовый пароль и уже с ним идет на железку. Такакс-сервер при обращении железки с одноразовым паролем уже валидирует этот пароль.

#### **Как заказать доступ**
Правильно заказывать доступ к оборудования в `IDM` система `NOCAUTH` и выбрав нужную группу устройств.

#### **Какие группы устройств есть в IDM для NOCAUTH**
Удобного способа найти это сейчас нет, но это можно выяснить следующими путями:
1) Дернуть ручку IDM: <https://idm-api.yandex-team.ru/api/v1/rolenodes/?system=nocauth&format=json>
2) Посмотреть в Racktables. Можно использовать интерфейс GraphiQL по ссылке: <https://ro.racktables.yandex-team.ru/api>  
Запрос для GraphQL:
    ```graphql
    query {
        predicate(re: "/nocauth_.*/"){
            name
        }
    }
    ```

#### **Кто имеет доступ на железку под NOCAUTH**

Список устройств под `NOCAUTH`:  
- <https://racktables.yandex-team.ru/index.php?andor=and&cfe=%5Bработает+nocauth%5D&page=depot&tab=default&submit.x=20&submit.y=9>  

Групповые, как и персональные доступы выданные через `IDM` можно посмотреть в `IDM` указав в фильтре нужные группы: 
- <https://idm.yandex-team.ru/system/nocauth/roles#f-status=all,f-role=nocauth,sort-by=-updated,f-is-expanded=true>

---
### **LocalUser DB**
Это часть Racktables, которая раскладывает ключи на некоторые linux-машины под управлением `ludb`, на FreeBSD-машины NOC'а, а также на сетевое железо.  Доступа до устройств конфигурируются коммитами [в этот файл](https://noc-gitlab.yandex-team.ru/nocdev/racktables/-/blob/master/scripts/localuser-db/lusettings.php).

Перечень систем под управлением `ludb` можно найти в [Gitlab](https://noc-gitlab.yandex-team.ru/nocdev/racktables/-/blob/master/scripts/localuser-db/ludevice.php).  

Ключи для пользователей берутся из `CVS` из файла `routers/conffiles/pubkeys`  
В этот файл ключи нужно коммитить, для этого желательно обратиться с тикетом в очередь `NOCDEVDUTY`

Для сетевого железа нужно генерировать хеши, чтобы `ludb` положил их на железки. Инструкция как это делать тут:
- <https://docs.yandex-team.ru/racktables/scripts/gen-hashes>

## **Полезные ссылки**
| Описание | Ссылка |
|:---:|---|
| Документация по CAUTH | <https://wiki.yandex-team.ru/intranet/cauth/> |
| Документация по NOCAUTH | <https://docs.yandex-team.ru/nocdoc/nocdev/nocauth/about> |
| Документация по LocalUser-DB | <https://docs.yandex-team.ru/racktables/scripts/add-freebsd-user> |
| Как настроить Yubikey | <https://docs.yandex-team.ru/nocdoc/processes/yubikey/about> |
| Документация Skotty/Yubikey | <https://docs.yandex-team.ru/skotty/> |
| Документация по API Conductor | <https://wiki.yandex-team.ru/Conductor/API/handles/> |
