# Инструкция по проведению учений

Этот документ регламентирует действия, необходимые для проведения учений и работ в ДЦ.

## Общее для учений и работ в ДЦ

Все работы и учения планируются заранее минимум на пол года вперед. Для трекинга и фиксации результатов создана и используется очередь `st/DRILLS`. План глобальных работ и учений ведется в тикете [https://st.yandex-team.ru/DRILLS-2](https://st.yandex-team.ru/DRILLS-2), параллельно все плановые учения (работы) заводятся в сервисе infra, откуда "прорастают" в соответствующий календарь. Также все активности дублируются в ["Глобальный календарь"](https://wiki.yandex-team.ru/9999/globalnyjj-kalendar/).Список постоянных исключений для учений ведется в тикете [https://st.yandex-team.ru/DRILLS-31](https://st.yandex-team.ru/DRILLS-31).

Организацией учений и работ занимается v-team в составе:
- [Андрей Аброскин](https://staff.yandex-team.ru/sereglond)
- [Андрей Савин](https://staff.yandex-team.ru/korxif)
- [Вадим Воловик](https://staff.yandex-team.ru/vdvolovik)

Права на выставление глобального DT на локацию есть у группы [Согласования регламентных работ](https://abc.yandex-team.ru/services/maintcoord).

Заказчиком учений выступает команда '[9999](https://wiki.yandex-team.ru/9999/)'. Заказчиком (инициатором) работ могут выступать службы:
- [NOC(Сеть)](https://abc.yandex-team.ru/services/net/),
- [Служба IT инфраструктуры датацентров](https://abc.yandex-team.ru/services/EXP),
- инженерные службы ДЦ (энергия, вентиляция, охлаждение)
- [Планирование инженерных систем](https://abc.yandex-team.ru/services/ProEngSys/)

На момент написания этого регламента план работ был подготовлен и опубликован в [DRILLS-2](https://st.yandex-team.ru/DRILLS-2) (в марте) на весь год вперед. При публикации плана для каждого события создается отдельный тикет в очереди [DRILLS](https://st.yandex-team.ru/DRILLS/), создаются события в infra и в "Глобальном календаре". Далее план может корректироваться с течением времени под воздействием внешних факторов.

Основные каналы для анонсов:
- [Клуб любителей отключать ДЦ](https://clubs.at.yandex-team.ru/4611686018427387924/) в Этушке
- Telegram чат [Регламентные работы и учения ДЦ](https://t.me/joinchat/PaZhvX5pm5phcPFN).

TODO: м.б. дублировать анонсы в "Ссылки дня"?

## Проведение учений

Учения проводятся по вторникам, каждые 2 недели. Время проведения - с 15:00 до 16:00.В случае, если учения не удалось провести в запланированный день, следующая попытка делается в следующее плановое окно.

### Подготовка к учениям

#### За неделю до учений

За неделю до учений публикуется пост в [“Клубе любителей отключать ДЦ”](https://clubs.at.yandex-team.ru/4611686018427387924/), также информация дублируется в чат регламентных работ и учений в Telegram.

#### За сутки до учений

Минимум за сутки до учений необходимо связаться с Traffic Team (далее TT) и получить подтверждение на сопровождение учений (выделяется инженер TT, который будет снимать анонсы с L3 SLB).

#### В день учений

В день учений за 1 час организаторы напоминают всем через чат  ["Регламентные работы и учения ДЦ"](https://t.me/joinchat/PaZhvX5pm5phcPFN) о начале учений. К времени начала учений ДЦ должен быть готов к учениям.

### Исключение из учений

Во время учений допускаются исключения. Часть сервисов устроены так, что не умеют жить -1ДЦ и в учениях не участвуют. Список ведется в [DRILLS-31](https://st.yandex-team.ru/DRILLS-31). Сервисы, которые находятся в списке, либо в принципе не могут -1 ДЦ (пример - YT), либо имеют тикет на исправление ситуации. Со временем список уменьшается. Все остальные, не находящиеся в списке исключений на постоянной основе, могут запросить в тикете учений разовое исключение из грядущих учений. Для этого надо перечислить сетевые (или кондукторные) макросы, которые необходимо исключить. При этом, также, необходимо приложить соответствующий SPI, подтверждающий аварийную ситуацию или тикет на исправление проблемы в проектной очереди.

### Процесс проведения учений

Последовательность действий при проведении учений.
- обычно, к началу учений Марти снимают трафик с бОльшей части сервисов под L7 на уровне L7 и включают 5хх на хелсчеках L7, таким образом тушат все активные L7 в локации. В первую очередь связываемся с дежурным и получаем подтверждение, что все ок
- убеждаемся, что все готовы (при необходимости выжидаем время, необходимое сломавшимся сервисам для починки, но не более 30-40 минут от начала учений) [1]
- выставляем DT в Juggler на локацию: [Downtimes](https://juggler.yandex-team.ru/downtimes)
  - Необходимо выставлять значения downtime c запасом не более 15 минут от планируемого времени проведения учений
  - При окончании работ до запланированного времени downtime необходимо изменить значение времени окончания downtime.
  - При наступлении времени downtime, указанного в записи downtime, он снимается автоматически с локации.
- снимаем анонсы с L3 SLB.
  - Для этого необходимо в чате Регламентных работ и учений ДЦ написать дежурному инженеру команды TT сообщение с указанием снять анонсы с L3-балансировщиков тестируемой локации
  > **NOTE**
  > балансировщики перестают анонсировать в сеть адреса, на которые приходит трафик извне. В случае, если трафик все же как-то долетит до балансера - он его обработает и отправит дальше, к рилам. Но если часть сессии придет на один балансер, он погаснет и остальная часть пойдет на другой - данные будут потеряны, так как на "новом" балансере нет стейта этой tcp-сессии.
  > Соответственно для пользователя это будет выглядеть, как сброс tcp-сессии и установление ее заново через новый балансер).
- ждем 10 минут, убеждаемся, что всё стабильно. В случае факапов у сервиса действуем в зависимости от критичности (возвращаем анонсы на L3-балансировщиках, даем время на стабилизацию), также обязательно наличие SPI-тикета инцидента, если команда задерживает учения или просит срочно вернуть анонс.
- если все хорошо, переходим к режиму учений HBF. Для этого в [https://firewall.yandex-team.ru/drills](https://firewall.yandex-team.ru/drills) планируем новые учения. В поле `Project` указываем макрос `_YANDEXNETS_`, в поле `Datacenter` указываем необходимый нам ДЦ. Длительность и время начала указываем в зависимости от текущего момента времени. В список исключений добавляем макросы из [DRILLS-31](https://st.yandex-team.ru/DRILLS-31), а также макросы, запрошенные на данные конкретные учения в тикете учений.По окончанию окна режима учений HBF проделываем все действия в обратном порядке [2]:
- отменяем режим учений HBF
- ждем 3-5 минут, возвращаем анонсы на L3 SLB
- ждем еще 3-5 минут, снимаем DT с локации.

> [1]
> Если мы перешли рубеж в 30-40 минут, то начинать учения менее, чем за 20 минут до завершения нет смысла, в таком случае учения просто отменяются. Также возможна ситуация, когда мы вошли в режим учений, но из-за поломок нам пришлось вернуть ДЦ в работу. Если сервис оперативно починился, нашел причину поломки - возможно возобновление режима учений до времени их планового окончания.

> [2]
> В идеальном случае всё можно доверить автоматике, указав заранее время окончания режима учений HBF и время окончания DT. Главное, вовремя вернуть L3 SLB.

### После учений

Фиксируем в тикете учений все найденные артефакты (либо, при наличии массовых проблем, создаем зонтичный SPI и подклеиваем туда все произошедшие инциденты), прикладываем лог чата регламентных работ и любую релевантную информацию. Организаторы вправе требовать от проектных команд тикеты на все инциденты, произошедшие из-за учений. При необходимости, организуем разбор аварий в формате LSR.

Ответственный за проведение учений пишет два комментария:
- Таймлайн проведения учений
  > [**Пример**](https://st.yandex-team.ru/DRILLS-363#61a769a1ae68c001a4f957a3)
- Комментарий с перепиской из координационного чата в Telegram
  > [**Пример**](https://st.yandex-team.ru/DRILLS-363#61a760c5dab7af733c943254)

