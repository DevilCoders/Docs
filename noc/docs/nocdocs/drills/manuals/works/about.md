# Проведение регламентных работ

Регламентные работы - это проведение эксплуатационных работ в ДЦ, обычно работы связанные с электропитанием или обслуживанием сетевого оборудования. От учений регламентные работы отличаются:
- длительностью - общее время проведения регламентных работ всегда занимает более часа,
- отсутствием исключений из HBF
- в случае неснятия ДЦ регламентные работы переносятся на следующий резервный день проведения работ

Работы могут проводиться по двум сценариям:
- плановые работы (заменяют плановые учения в сетке расписания в соответствующем ДЦ).
- аварийные работы (обычно проводятся экстренно, если есть возможность - проводится оперативное согласование с ключевыми сервисами Яндекса).

## Подготовка к работам

### За месяц до работ

Для включения работ в плановые отключения от инициатора работ необходим тикет (в соответствующей инициирующей службе очереди Стартрека), включающий следующую обязательную информацию:
- краткое описание работ
- обоснование (зачем мы это делаем)
- оценка по времени

Данная информация должна быть предоставлена не позднее, чем за 1 месяц до планируемой даты проведения работ.

{% cut "Шаблон для NOC:" %}

Тикет на работы с планом и разбивкой по времени. [Шаблон тикета](https://wiki.yandex-team.ru/users/kachanovskiy/draftregrabot/). В тикет обязательно призвать коллег из NOCDEV и TT для peer-review с их стороны. Peer-review должно быть проведено самое позднее за неделю до даты работ. Синк с планами NOCDEV и TT на работы.

{% endcut %}

### За 2 недели до работ

Не позднее, чем за 2 недели до работ добавить работы в сетку отключений ДЦ [DRILLS-2](https://st.yandex-team.ru/DRILLS-2) по согласованию с координаторами работ путем изменения соответствующего тикета учений:
- при изменении тикета должно поменяться название на "[дата] работы NOC/ITDC/Инженерной службы [DC] "
- в тело тикета добавляется краткое описание цели работ
- в тело тикета расписываем таймлайн работ (ссылки на другие тикеты не приветствуются)
- Меняем в теле тикета условия отмены и переноса на "Если ДЦ не удастся отключить до [deadline] часов прекращаем попытки и возвращаемся к отключению в ближайший рабочий день."
  - deadline рассчитываем так, чтобы если мы начнём работ в этот момент успеть закончить их до 20.00
- Правим событие в infra [alexunix@](https://staff.yandex-team.ru/alexunix) кажется что глобальный календарь должен быть подвязан с конкретным инфра сервисом, тогда не надо править в двух местах и "Глобальном календаре"
- Явно прописываем как работы влияют на сервисы, будет ли отключение сети/выключение хостов.

### За неделю до работ

В случае необходимости проведения работ на инженерных системах, необходимо составить список отключаемого по питанию оборудования - модули ДЦ, стойки, список хостов. Если в списке есть хосты Облака, необходимо совместно с ними проработать возможность обеспечения непрерывной работы их хостов.

Не позднее одной недели до работ в тикете должен появиться детальный план возврата нагрузки со всеми тестами и исключениями. Если в результате работ произошло любое изменение сетевой инфраструктуры, то см. [План возврата нагрузки на ДЦ](https://wiki.yandex-team.ru/users/korxif/drills-load-return/). Согласовать с [Андреем Годиным](https://staff.yandex-team.ru/agodin), кто будет от MDS участвовать в процессе возврата нагрузки (обычно дежурный от MDS на день проведения работ). Заручиться поддержкой RTC и ITDC, если хосты будут отключаться по питанию.

Согласовать план отключения и возврата нагрузки с Облаком ([Андрей Глазков](https://staff.yandex-team.ru/glazgoo), [Евгений Килимчук](https://staff.yandex-team.ru/ekilimchuk)).

Не позднее чем за неделю сделать [анонс работ](https://wiki.yandex-team.ru/users/korxif/drills-inform/) в [Клубе любителей отключать ДЦ](https://clubs.at.yandex-team.ru/4611686018427387924/)

Перед анонсом убедиться, что нет PR-событий на момент даты проведения работ, нет пересечений в "Глобальном календаре", в противном случае выбрать и согласовать другую дату.

- В посте расписываем в понятном виде цель работ
  - Всё остальное копируем из тела тикета:
    - таймлайн
    - условия отмены/переноса
    - событие в infra
  - Добавляем ссылку на тикет и фразу "Координация отключения - в чате ["Регламентные работы и учения ДЦ"](https://t.me/joinchat/PaZhvX5pm5phcPFN)
- Копируем текст поста в TG/чаты "Регламентные работы" и "Согласование регламентных работ" (последний - опционально)
- [Пример поста](https://clubs.at.yandex-team.ru/4611686018427387924/1508)

Для всех инициаторов работ, кроме ITDC, создаем тикет в очереди ITDC на поддержку работ. Явно связываемся с коллегами и убеждаемся, что они про это в курсе. Сергей Давыдов просил создавать тикеты минимум за неделю, чтобы их гарантированно взяли в работу и согласовали ресурсы (особенно в MAN).

Собрать координационный чат для организаторов и исполнителей проведения регламентных работ. Список кого всегда надо добавлять в чат:
- [Руководителя управления базовых инфраструктурных сервисов](https://staff.yandex-team.ru/departments/yandex_infra_tech_components)
- [Руководителя отдела сетевой инфраструктуры](https://staff.yandex-team.ru/departments/yandex_infra_tech_components_dep08429)
- [Руководителя Yandex Global Network](https://staff.yandex-team.ru/departments/yandex_mnt_noc)
- [Руководителя Yandex Network Operational](https://staff.yandex-team.ru/departments/yandex_mnt_noc_perf)
- [Технических менеджеров группы управления проектами](https://staff.yandex-team.ru/departments/yandex_infra_tech_components_dep08429_dep31912)
- [Руководителя ITDC, ответственного за ДЦ](https://wiki.yandex-team.ru/dc/dccontacts/)
- [Дежурного от RTC](https://abc.yandex-team.ru/services/routineoperations/duty/), который будет дежурить во время проведения работ, в случае отключения питания хостов

### За сутки до работ

Заказчик и Организатор работ за сутки и за 12 часов до выполнения работ должны убедиться, что нет критичных проблем, которые могут заблокировать выполнение работ (обрывы трасс, критичные проблемы с оборудованием, сервисами, **PR-события**).

За сутки [продублировать напоминание](https://wiki.yandex-team.ru/users/korxif/drills-inform/) в общем чате регламентных работ.

В случае, если работы аффектят Облако, выполняем процедуру снятия/переключения запчастей Облака (инструкция, ai:[Вячеслав Качановский](https://staff.yandex-team.ru/kachanovskiy) и [Евгений Килимчук](https://staff.yandex-team.ru/ekilimchuk)). Также, минимум за сутки до начала получаем ОК от Облака в явном виде. Не забываем про [TRAFFIC-10887](https://st.yandex-team.ru/TRAFFIC-10887)

**При отключении хостов по питанию**

- Узнать кто будет дежурить со стороны RTC для отключения хоста. Морально подготовить дежурного к отключению хостов.

## Процесс проведения работ

Финальное напоминание про работы:
- если работы начинаются до 13 часов, то анонс делаем за час
- иначе в 12.00, чтобы дать больше времени на подготовку тем, кто забыл про отключение

Создаем координационный чат работ/учений в tg (если еще нет) и zoom-конференцию для оперативных решений. В координационный чат добавляем (всегда) дежурных NOC, дежурного Марти, ответственных от NOC (руководителя NOC, руководителя группы эксплуатации ДЦ, руководителя дежурной смены NOC), дежурного инженера группы эксплуатации ДЦ, дежурного ТТ, дежурного инженера от Облака, ответственного от ITDC.

Снятие нагрузки
- На первом этапе снимаются сервисные балансеры L7. Марти обычно начинают уводить нагрузку за 15 минут до начала работ, а именно - рубит веса там, где можно крутить веса, ждет 5 минут и рубит хелсчеки, там, где имеет доступ рубить. Ждем от сервисов подтверждения снятия ДЦ, убеждаемся, что все стабильно и проблем нет. В случае наличия массовых проблем создаем общий SPI и просим сервисы создавать свои, линкуя их к общему тикету _(поговорить с 99.99 про зонтики и spi:victim:umbrella)_.
- Убеждаемся, что YT увел нагрузку с ДЦ (чтобы не прилетела нагрузка на DNS)
- По готовности снимаем инфраструктурные балансеры, ждем не менее 5 минут, снимаем все L3LB в два этапа. Сначала снимаем общие балансировщики, затем, в последнюю очередь, балансировщики, обеспечивающие работу критичной инфраструктуры.
- {% cut "Выставляем DT на ДЦ в Джаглере (могут сделать только люди из сервиса. [Согласование регламентных работ](https://abc.yandex-team.ru/services/maintcoord/)" %}

  во время работ мы выставляем ДТ на селектор, покрывающий все проверки с железных хостов закрываемого ДЦ, а также проверки, имеющие соответствующий геотег - это позволит даунтаймить не только проверки с железных хостов, но и локационные алерты Голована (предложили коллегам из Соломона тоже подумать на эту тему - Андрей Гущин сказал, что подумают, но чуть попозже - у них по результатам среды выявилось и без того достаточно проблем с алертовой подсистемой - после них планируют вернуться к вопросу). Таким образом, селекторы будут выглядеть так:

   ```
   Сасово: host=BOT%sas | tag=a_geo_sas
   Ман: host=BOT%man | tag=a_geo_man
   Владимир: host=BOT%vla | tag=a_geo_vla
   Ивантеевка: host=BOT%iva | tag=a_geo_iva
   Мытищи: host=BOT%myt | tag=a_geo_myt
   ```

  {% endcut %}

- Анонсируем ДТ в чат регламентных работ
- Ждём 20 минут чтобы убедиться, что все пережили отключение L3LB + что ДТ применился везде
- Выключаем HBF, указываем макрос `_YANDEXNETS_` и исключения не делаем, если специально не запрошены и не согласованы.
- Ждём 20 минут чтобы убедиться, что все пережили отключение HBF

Переходим к основной фазе работ, в соответствии с планом. Чаще всего снимаем маршрутизацию и выполняем регламентные операции.

Если во время работ требуется обесточить модуль ДЦ, смотри детали в инструкции !!TODO!!
Если было запланировано отключение хостов по питанию, делаем это с помощью дежурного сервиса [Регламентные операции](https://abc.yandex-team.ru/services/routineoperations). На отключение обычно нужно около 30 минут. Остатки машин, которые не смогла погасить автоматика, выключаются силами ITDC (+еще 30 минут). Контроль потребления - графана, general, M3 Sensor.

Не забываем про уведомления про статус, не реже 1 раза в 2 часа. Во время переходных процессов, не реже, чем раз в 30 минут.

Возврат нагрузки
- Возвращаем нагрузку в соответствии с [отдельным регламентом](https://wiki.yandex-team.ru/users/korxif/drills-load-return/), краткая последовательность - маршрутизация->HBF->ДТ->L3LB критичной инфраструктуры->Все L3LB->L7 health-check->L7 weights. Если часть хостов была отключена - смотри отдельную инструкцию !!TODO!!
- Даем отмашку всем на возврат нагрузки.

В процессе не забываем постоянно [информировать коллег о ходе работ](https://wiki.yandex-team.ru/users/korxif/drills-inform/).

## После работ

Не расходимся минимум 20 минут после полной стабилизации.

Не забываем отпустить поддержку со стороны ITDC явным сигналом.

После окончания "защитного интервала" все расходятся, поддержкой занимается дежурная смена NOC, в качестве второй линии выступает текущий дежурный группы эксплуатации и развития ДЦ NOC.
Если работы проводились NOC (обсудить с остальными службами) заранее должен быть выделен инженер, который должен выступать в качестве поддержки 2 уровня, он должен быть в курсе что делалось в работах
Делаем встречу для разбора результатов работ, можно использовать [retro-borad](https://ssav.at.yandex-team.ru/72) - [https://retroboard.yandex-team.ru](https://retroboard.yandex-team.ru/)

В случае, если работы длительные, необходимо проговаривать и обеспечивать дублирование ведущих.
