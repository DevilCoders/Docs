# Инструкция по проведению учений

Этот раздел регламентирует действия, необходимые для проведения учений в ДЦ.

## Общее для учений и работ в ДЦ

Все работы и учения планируются заранее минимум на пол года вперед. Для трекинга и фиксации результатов создана и используется очередь [st/DRILLS](https://st.yandex-team.ru/DRILLS). 

План глобальных работ и учений ведется в тикете [https://st.yandex-team.ru/DRILLS-2](https://st.yandex-team.ru/DRILLS-2), параллельно все плановые учения (работы) заводятся в сервисе infra, откуда "прорастают" в соответствующий календарь. 

Также все активности дублируются в ["Глобальный календарь"](https://wiki.yandex-team.ru/9999/globalnyjj-kalendar/).

Организацией учений и работ занимается v-team в составе:
- [Андрей Аброскин](https://staff.yandex-team.ru/sereglond)
- [Андрей Савин](https://staff.yandex-team.ru/korxif)
- [Вадим Воловик](https://staff.yandex-team.ru/vdvolovik)
- С 2022 года к процессу координации учений подключена Дежурная Смена Marty:
  - [Антон Уханов](https://staff.yandex-team.ru/bunnyhop)
  - [Александр Донец](https://staff.yandex-team.ru/alexunix)
  - [Алексей Полуянов](https://staff.yandex-team.ru/alpoluyanov)

Права на выставление глобального DT на локацию есть у группы [Согласования регламентных работ](https://abc.yandex-team.ru/services/maintcoord).

Заказчиком учений выступает команда '[9999](https://wiki.yandex-team.ru/9999/)'. Заказчиком (инициатором) работ могут выступать службы:
- [NOC(Сеть)](https://abc.yandex-team.ru/services/net/),
- [Служба IT инфраструктуры датацентров](https://abc.yandex-team.ru/services/EXP),
- инженерные службы ДЦ (энергия, вентиляция, охлаждение)
- [Планирование инженерных систем](https://abc.yandex-team.ru/services/ProEngSys/)

Основные каналы для анонсов:
- [Клуб любителей отключать ДЦ](https://clubs.at.yandex-team.ru/4611686018427387924/) в Этушке
- Telegram чат [Регламентные работы и учения ДЦ](https://t.me/joinchat/PaZhvX5pm5phcPFN).

## Проведение учений

Учения проводятся по вторникам, каждые 2 недели. Время проведения - с 15:00 до 16:00. В случае, если учения не удалось провести в запланированный день до 15:35 по UTC+3, следующая попытка делается в следующее плановое окно.

### Подготовка к учениям

#### За неделю до учений

За неделю до учений публикуется пост в [“Клубе любителей отключать ДЦ”](https://clubs.at.yandex-team.ru/4611686018427387924/), также информация дублируется в чат регламентных работ и учений в Telegram.

[Пример Этушки](https://clubs.at.yandex-team.ru/4611686018427387924/1560)

{% cut "Пример для Telegram" %}

Коллеги, привет! Напоминаю, что через неделю состоится отключение ДЦ, во вторник 14 декабря в SAS.
Это будут просто учения, без каких-либо работ.
Пожалуйста, не забудьте к ним подготовиться.

Таймлайн:
* 15.00 начало учений 
  * к этому моменту сервисы уже должны снять нагрузку
  * снимаем анонсы L3 балансеров
  * +10 минут закрываем ДЦ HBF
* 16.00 всё возвращаем, учения закончены

Тикет https://st.yandex-team.ru/DRILLS-364

{% endcut %}

#### За сутки до учений

Минимум за сутки до учений необходимо связаться с Traffic Team (далее TT) и получить подтверждение на сопровождение учений (выделяется инженер TT, который будет снимать анонсы с L3 SLB).

Контакты TT:
- [Владимир Неверов](https://staff.yandex-team.ru/neverov)
- [Андрей Киселев](https://staff.yandex-team.ru/ezhichek)

#### В день учений

##### Presets

Необходимо завести Preset в [Drills:UI](https://firewall.yandex-team.ru/drills). Для этого:
- перейти по ссылке
- нажать на **Add preset**
- В Projects написать: `_YANDEXNETS_`
- В DCs написать тот ДЦ в котором будут проводиться учения, например, `IVA`
- В Duration указать продолжительность проведения учений, например, `00:25` минут. **Внимание** это поле не время начала учений, а их продолжительность
- В поле **Exclude** вставляем список исключений, а именно **постоянные** + **временные**
- Нажимаем **Create Preset**

**Исключение из учений**

При проведении учений необходимо также помнить про **исключения**. Под исключениями мы понимаем сервисы, которые по тем или иным причинам не могут работать при отключении одного из ДЦ. Выделяем несколько типов исключений:
- **постоянные** - сервисы, каждый раз исключаемые из учений
- **временные** - сервисы, исключаемые единожды из учений

Сами исключения представляют собой макросы доступов и/или список ip-адресов. Каждый сервис **самостоятельно** определяет список макросов и список ip-адресов, и отвечает за него также самостоятельно.

Список постоянных исключений для учений ведется в тикете [https://st.yandex-team.ru/DRILLS-31](https://st.yandex-team.ru/DRILLS-31). Этот список каждый раз копируется и вставляется в исключения в интерфейсе проведения учений \(об. этом ниже\).

**Временные** исключения добавляются по следующему алгоритму:
1. Владельцы или ответственные за сервис осознают, что они не могут участвовать в учениях
2. Владельцы или ответственные за сервис заводят тикет с описанием проблемы из-за которой нет возможности провести учения для их сервиса
3. В комментарий к тикету учений прикрепляется список сетевых макросов, которые необходимо добавить в исключения, а также тикет
4. Координатор проведения учений добавляет макросы в исключения из учений

Примеры:
- [пример без SPI](https://st.yandex-team.ru/DRILLS-363#61a4f85795687b3d38a8cafb)
- [пример с SPI](https://st.yandex-team.ru/DRILLS-363#61a60e4352545a2de20f6938)

[Пример Preset](https://firewall.yandex-team.ru/drills/presets/edit/219)

##### Downtimes

Подготавливаем форму Downtime:
- Открываем ссылку с [downtimes](https://juggler.yandex-team.ru/dashboards/drills_downtimer/)
- Нажимаем Create
- Вставляем правильный селектор из списка:
```
Сасово: host=BOT%sas | tag=a_geo_sas 
Ман: host=BOT%man | tag=a_geo_man
Владимир: host=BOT%vla | tag=a_geo_vla 
Ивантеевка: host=BOT%iva  | tag=a_geo_iva
Мытищи: host=BOT%myt  | tag=a_geo_myt
```
- Выставляем дату
- Время **не** выставляем, потому что не факт, что начнем учения во время
- Вставляем номер тикета в поле **Startrek ticket**
- Добавляем описание, например, `Проведение учений в ДЦ MAN`
- Больше ничего не нажимаем и не сохраняем, а прото оставляем ссылку открытой до начала учений

##### Напоминание в чате

В день учений за 1 час организаторы напоминают всем через чат  ["Регламентные работы и учения ДЦ"](https://t.me/joinchat/PaZhvX5pm5phcPFN) о начале учений. К времени начала учений ДЦ должен быть готов к учениям.

### Процесс проведения учений

Последовательность действий при проведении учений.
- обычно, к началу учений Марти снимают трафик с бОльшей части сервисов под L7 на уровне L7 и включают 5хх на хелсчеках L7, таким образом тушат все активные L7 в локации. В первую очередь связываемся с дежурным и получаем подтверждение, что все ок
- убеждаемся, что все готовы (при необходимости выжидаем время, необходимое сломавшимся сервисам для починки, но не позднее 15:35 даты проведения учений) [1]
- В случае, когда сервис сломался и не смог починиться до 15:35, то это означает выход на LSR. Соответственно, к тикету должен быть прикреплен тикет LSR, описывающий причины поломки сервиса.
- выставляем DT в Juggler на локацию: [Downtimes](https://juggler.yandex-team.ru/downtimes)
  - в подготовленную форму вставляем время начала и время окончания (+15 минут). Пример: если начинаем в 15:20, то окончание выставляем 16:00. Нажимаем кнопку **Save**
  - При окончании работ до запланированного времени downtime необходимо изменить значение времени окончания downtime.
  - При наступлении времени downtime, указанного в записи downtime, он снимается автоматически с локации.
- снимаем анонсы с L3 SLB.
  - Для этого необходимо в чате Регламентных работ и учений ДЦ написать дежурному инженеру команды TT сообщение с указанием снять анонсы с L3-балансировщиков тестируемой локации
  {% note info %}

  - балансировщики перестают анонсировать в сеть адреса, на которые приходит трафик извне. В случае, если трафик все же как-то долетит до балансера - он его обработает и отправит дальше, к рилам. Но если часть сессии придет на один балансер, он погаснет и остальная часть пойдет на другой - данные будут потеряны, так как на "новом" балансере нет стейта этой tcp-сессии.
  - Соответственно для пользователя это будет выглядеть, как сброс tcp-сессии и установление ее заново через новый балансер).

  {% endnote %}
- ждем 10 минут, убеждаемся, что всё стабильно. В случае факапов у сервиса действуем в зависимости от критичности (возвращаем анонсы на L3-балансировщиках, даем время на стабилизацию), также обязательно наличие SPI-тикета инцидента, если команда задерживает учения или просит срочно вернуть анонс.
- если все хорошо, переходим к режиму учений HBF. 
  - Если подготовили заранее **Preset**: 
  - Если не подготовили заранее **Preset**:
    - В [https://firewall.yandex-team.ru/drills](https://firewall.yandex-team.ru/drills) планируем новые учения. 
    - В поле `Project` указываем макрос `_YANDEXNETS_`, 
    - В поле `Datacenter` указываем необходимый нам ДЦ. Длительность и время начала указываем в зависимости от текущего момента времени. В список исключений добавляем макросы из [DRILLS-31](https://st.yandex-team.ru/DRILLS-31), а также макросы, запрошенные на данные конкретные учения в тикете учений.
    
По окончанию окна режима учений HBF проделываем все действия в обратном порядке [2]:
- отменяем режим учений HBF
- ждем 3-5 минут, возвращаем анонсы на L3 SLB
- ждем еще 3-5 минут, снимаем DT с локации.

{% note info "[1]" %}

Если мы перешли рубеж в 15:35 минут, то начинать учения менее, чем за 20 минут до завершения нет смысла, в таком случае учения просто отменяются. 

Также возможна ситуация, когда мы вошли в режим учений, но из-за поломок нам пришлось вернуть ДЦ в работу. Если сервис оперативно починился, нашел причину поломки - возможно возобновление режима учений до времени их планового окончания.

{% endnote %}

{% note info "[2]" %}

В идеальном случае всё можно доверить автоматике, указав заранее время окончания режима учений HBF и время окончания DT. Главное, вовремя вернуть L3 SLB.

{% endnote %}

### После учений

Фиксируем в тикете учений все найденные артефакты (либо, при наличии массовых проблем, создаем зонтичный SPI и подклеиваем туда все произошедшие инциденты), прикладываем лог чата регламентных работ и любую релевантную информацию. Организаторы вправе требовать от проектных команд тикеты на все инциденты, произошедшие из-за учений. При необходимости, организуем разбор аварий в формате LSR.

Ответственный за проведение учений пишет два комментария:
- Таймлайн проведения учений
  > [**Пример**](https://st.yandex-team.ru/DRILLS-363#61a769a1ae68c001a4f957a3)
- Комментарий с перепиской из координационного чата в Telegram
  > [**Пример**](https://st.yandex-team.ru/DRILLS-363#61a760c5dab7af733c943254)

