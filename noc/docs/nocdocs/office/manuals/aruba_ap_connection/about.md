# Ввод в эксплуатацию точку доступа ARUBA

Действия и данные от HelpDesk'а, необходимые до ввода ТД ARUBA в эксплуатацию при расширении запущенного кластера   iap-wlc:
1. Задача (тикет) на ввод в эксплуатацию, в котором есть таблица коммутаций.
2. ТД должна быть отмечена на карте офиса
3. Нужно понять для каждой точки- какие   ssid помимо «базового набора» она должна вещать, это можно сделать и потом, но займет больше времени.

**Ввод в эксплуатацию:**

- **Проверить маску вланов** на uplink-портах свитча (и соответственно downlink-порту свитча агрегации), в который подключается точка доступа. Она должна покрывать все пользовательские WiFi-вланы офиса.
- Убедиться, что пользовательские WiFi-вланы созданы на коммутаторах (в цепочке до свитчей агрегации)
- Настроить порт на коммутаторе, куда подключена точка:

{% cut "пример для коммутатора Cisco:" %}

```
description
  switchport  trunk  native  vlan <mgmt  vlan>
  switchport  trunk  allowed  vlan <пользовательские WiFi-вланы офиса (обычно 419,423,429,441,443 набор зависит от дополнительных ssid пункта 3)  + управляющий >
  switchport  mode  trunk
  switchport  nonegotiate
  spanning-tree  portfast  trunk
  spanning-tree  bpduguard  enable
```

{% endcut %}

{% cut "пример для коммутатора  Huawei:" %}

```
description  
 port link-type trunk
 port trunk pvid vlan <mgmt vlan>
 undo port trunk allow-pass vlan 1
 port trunk allow-pass vlan <пользовательские WiFi-вланы офиса (обычно 419,423,429,441,443 набор зависит от дополнительных ssid пункта 3)  + управляющий >
 poe legacy enable
 stp edged-port enable
 lldp dot3-tlv power 802.3at <это важно, иначе точки могут не зарработать/ заработать с сниженной производительностью>
 lldp compliance cdp txrx
 lldp compliance cdp receive
 mac-address trap notification learn
 jumboframe enable 9200
 unicast-suppression 90
```

{% endcut %}

{% cut "Для коммутатора Huawei, если AP контроллерная" %}

```
undo enable snmp trap updown
 port link-type access
 port default vlan {VLAN управления точками доступа}
 stp edged-port enable
 poe legacy enable
 lldp dot3-tlv power 802.3at
 lldp compliance cdp receive
 port discard tagged-packet
 jumboframe enable 9200
 storm-control broadcast min-rate 30 max-rate 50
 storm-control multicast min-rate 50 max-rate 100
 storm-control enable trap
 dhcp snooping check dhcp-rate enable
 dhcp snooping check dhcp-rate 5
```

{% endcut %}

# Aruba IAP

Если не добавить "пользовательские Wi-Fi  vlan"- точка введется в эксплуатацию, но Wi-Fi пользователь окажется в тупиковом vlan без сервисов и доступа. Никаких других команд (кроме description который настраивается RackTables) быть не должно, если порт ранее использовался как клиентский- нужно проверить отсутствие на нем  лишних фильтрующих команд, к примеру, dhcp-threshold от «клиентской» настройки порта может легко превышаться при нормальном функционировании точки доступа, что будет приводит к клиентам без IP адресов!
- [Запустить скрипт](https://wiki.yandex-team.ru/noc/office/wifi/aruba-iap/#zapuskskripta) для перевода точек доступа в нужный режим
- Скрипт может для ряда точек доступа вывести сообщение: "!eth0". Это значит, что данные точки доступа нужно перекроссировать с первого порта точки доступа в нулевой и проинициализировать снова.
- В течении 10 минут после захода  скрипта точка перезагрузится несколько раз и подключится к iap-wlc, пароль при этом на ней поменяется - тут нужно призвать   Noc-ов, чтобы они проверили, что точки доступа успешно подключились к контроллеру а также прописали дополнительные  ssid из 3го пункта.-- проверить самостоятельно, используя юзера `rouser` и [пароль](https://yav.yandex-team.ru/secret/sec-01fgk6qydmaw8x4rs3m739vsf8/explore/versions). Для подключения к мастеру достаточно указать в URL адрес вводимой точки, например, [https://ekb-5w1.yndx.net/](https://ekb-5w1.yndx.net/), произойдёт редирект. Если точка доступа подключена в: 100 Мбитный порт коммутатора/ 802.3 af порт коммутатора (изредка так происходит) - об  этом нужно предупредить.
- Проверить или попросить проверить «на местах», что в нужные ssid новых точек доступа можно успешно подключится (есть подключение, выдает ip)
- Создать в RackTables у ТД порты `con0`, `eth0`, `eth1` после чего в LiveCDP выполнить линковку интерфейса `eth0`. Убедиться, что действительность совпадает с таблицей коммутаций. Если точка доступа подключена к консолятору- создать и скроссировать консольный порт.
- Снять теги ещё не работает и ожидает ввода в работу.
- Если в запрашиваемых HD-ом SSID есть MobDevInternet, MobTest, MobDevHotSpot, Yandex_Free то необходимо в РТ поставить тег запрошенного SSID.
- Отписаться о проделанной работе в тикет  HelpDesk'а и закрыть его по необходимости.

## ArubaOS (контроллерная точка доступа)

- [Запустить скрипт](https://wiki.yandex-team.ru/noc/office/wifi/aruba-iap/#zapuskskripta) для перевода точек доступа в нужный режим.
- Скрипт может для ряда точек доступа вывести сообщение: "!eth0". Это значит, что данные точки доступа нужно перекроссировать с первого порта точки доступа в нулевой и проинициализировать снова.
- В течении 10 минут после захода  скрипта точка перезагрузится несколько раз и подключится к железному контроллеру, пароль при этом на ней поменяется - тут нужно призвать   Noc-ов, чтобы они проверили, что точки доступа успешно подключились к контроллеру. Если точка доступа подключена в: 100 Мбитный порт коммутатора/ 802.3 af порт коммутатора (изредка так происходит) - об  этом нужно предупредить.
- Проверить/ попросить проверить «на местах», что в нужные ssid новых точек доступа можно успешно подключится (есть подключение, выдает ip)
- Создать в RackTables у ТД порты `con0`, `eth0`, `eth1` после чего в LiveCDP выполнить линковку интерфейса `eth0`. Убедиться, что действительность совпадает с таблицей коммутаций. Если точка доступа подключена к консолятору- создать и скроссировать консольный порт.
- Снять теги ещё не работает и ожидает ввода в работу.
- Если в запрашиваемых HD-ом SSID есть MobDevInternet, MobTest, MobDevHotSpot, Yandex_Free то необходимо в РТ поставить тег запрошенного SSID.
- Отписаться о проделанной работе в тикет  HelpDesk'а и закрыть его по необходимости.

## **Запуск скрипта**

1. Клонировать/обновить [репозиторий](https://noc-gitlab.yandex-team.ru/ttl256/stuff).
2. Установить необходимые пакеты `pip install -r requirements.txt`
3. В папке `aruba_iap` создать файл `aps_for_commissioning.txt`, в котором перечислить FQDN точек доступа, которые надо ввести в эксплуатацию (каждая ТД на новой строке).

- Если точка доступа IAP
  - В папке `aruba_iap` запустить `python3 ap_commissioning.py`
- Если точка доступа контроллерная
  - В папке `aruba_iap` запустить `python3 ap_wlc_commissioning.py --wlc_ip <wlc_ip>`. Адрес контроллера узнать у сотрудника NOC. Обычно это IP адрес объекта с тэгом "Виртуальный адрес" или [WiFi контроллер](https://racktables.yandex-team.ru/index.php?page=depot&tab=default&cft[]=1396), находящегося в той же локации, что и ТД. Например, для СуперСклада это [supwh-wlc](https://racktables.yandex-team.ru/index.php?page=object&object_id=62209).