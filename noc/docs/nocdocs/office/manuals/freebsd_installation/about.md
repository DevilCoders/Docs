# Инструкция по переналивке машинки

## Общие слова

Установка стремится быть полностью автоматической, тем не менее на данный момент:
- не решена ситуация с IPMI, поэтому все перезагрузки необходимо производить самостоятельно
- работа не опробована на большом количестве машин, поэтому непосредственно после установки необходимо ручками проверить, что же именно поставилосьС другой стороны
- максимально автоматизирован процесс собственно установки, то есть правильное для данного типа коробки ядро, правильный список пакетов, свежие (суточные) снепшоты /usr/local/router, пользователей и их директорий - поставятся автоматически. Точно так же автоматически поставятся все конфиги snmp, quagga, etc. Сгенерируются правильный rc.conf.local, make.conf и loader.conf. Задача пользователя - проверить, что все именно так и случилось. Если случилась какая-либо ошибка - желательно сохранить по ней максимум информации и сообщить

## Дополнительная документация

- [Документация администратора](nalivkafreebsd/adminguide)
- [Документация по использованию](nalivkafreebsd/management)

### Информацию по внутреннему устройству

- [сборка ядра, мира и различных snapshot'ов](nalivkafreebsd/internals)
- [сборка пакетов](nalivkafreebsd/internals/Sborkapaketov)
- eine [freebsd-specific](nalivkafreebsd/internals/eine) [общая информация](/Einstellung)
- Информация по [ядрам](nalivkafreebsd/kernels)
- [устройство наливки использующей пакеты с базовой системой](nalivkafreebsd/internals/freebsd_nalivka)

## Подготовка к новой установке

- Завести в RT актуальную информацию по коробке и повесить тег *еще не работает*  В частности, обязательно должен быть указан **Я-номер** и **FQDN**. Необходимо наличие тэга, позволяющего определить типа роутера (например, *core router*).  Информация об IP-адресах лупбеков и не-проектных сетях должна быть заполнена правильно.  Необходимо завести хотя бы один интерфейс (с любым (em,igb,ix) именем и маком первого интерфейса). Кроме того, для автоматизации перезагрузки можно указать и ipmi мак ({red}(еще не работает)).   Обычно данные из РТ уезжают в наливочные сервера через сутки. Для того, чтобы ускорить этот процесс нужно запустить скрипты на сервере noc:    
  ```
  /usr/local/router/scripts/packnocrepo.sh
  /usr/local/router/scripts/packnocdump.sh
  ```
- {red}(Проверить, что дисковый контроллер работает в режиме AHCI)
- {red}(Включить HyperThreading) {red}(Выключить HyperThreading, если машина с картокой Chelsio 40G.)

## Подготовка к переустановке

- Убедитесь, что в RT содержится актуальная информация по данной коробке и повесить тег *в оффлайне*.В частности, обязательно должен быть указан **Я-номер** и **FQDN**. Необходимо наличие тэга, позволяющего определить типа роутера (например, *core router*).Информация об IP-адресах и не-проектных сетях должна быть заполнена правильно.
- Проверьте, какая конфигурация будет создана автоматически:Для этого необходимо что-то вроде:
```
make -C /usr/local/routers update
....
  make -C /usr/local/routers/conffiles cat-base
```
Последняя команда покажет 3 основных файла ( **make.conf**, **rc.conf.local** и **loader.conf** ), которые будут созданы в новой системе.  Здесь стоит проверить, что в make.conf наличествует правильный ROUTERTYPE и имя ДЦ. В rc.conf.local нас интересует правильность построения lagg (если он есть) и IPv4/IPv6 адреса на всех не-проектных адресах.
- Наливайке необходимо знать мак того интерфейса, которым коробка смотрит в наливочный влан и мак IPMI (если есть). Если нет уверенности, что маки верные - необходимо нажать кнопочку в RT для синхронизации данных по физическим интерфейсам.Кнопочка выглядит так: <file:syn_ifs.png>.''Надо понимать, что сихронизация запишет в racktables **текущую** информацию о портах и линках (т.е. удалит **несуществующие** порты,  lagg'и и изменит согласно LLDP информацию о том, куда воткнут интерфейс).'' Синхронизация в том числе подразумевает, что сервер посмотрит tcpdump'ом в каждый физический интерфейс и подождет там первого LLDP-пакета, поэтому а) она выполняется довольно долгое время (2-3 минуты) и б) на части текущих ядер использование BPF слишком сильно просаживает CPU на высоких нагрузках, поэтому на коробках, связанных с Диском, это лучше делать, когда трафика поменьше. Если синхронизацией по тем или иным причинам воспользоваться не получается, то мак
  и
   необходимо заполнить руками.  Здесь стоит иметь в виду, что lagg меняет мак-адреса на физических интерфейсах, поэтому правильный способ получения мак-адресов на коробках с igb/em выглядит так:
```
19:24 [0] m@ra grep 'Ethernet ' /var/run/dmesg.boot
ix0: Ethernet address: 00:1b:21:a5:6b:ec
ix1: Ethernet address: 00:1b:21:a5:6b:ed
em0: Ethernet address: bc:ae:c5:36:53:93
em1: Ethernet address: bc:ae:c5:36:4f:51
```
- {red}(Проверить, что дисковый контроллер работает в режиме AHCI)
- {red}(Включить HyperThreading. Выключить HyperThreading, если машина с карточкой Chelsio 40G.)
- {red}(Проверить, что выключен железный watchdog (вкладка с IPMI))
- Сервер будет наливаться с нуля, с переразбивкой дисков, поэтому все нужные файлы (если вдруг такие случайно есть) - лучше сохранить заранее.

## Наливка

- Необходимо озаботиться наличием консоли на сервер (желательно ipmi), по крайней мере первое время, в связи с возможными ошибками в процессе наливки. {red}(В случае наливки через 141 влан НЕОБХОДИМО IPMI/KVM для возможности перегрузить машинку руками)
- Нажать кнопочку переключения/наливки. Кнопочка а) вытаскивает первый интерфейс из lagg'а и помещает его в наливочный влан ({red}(пока не работает, это нужно делать руками)), б) добавляет сервер в соответствующую наливайку. В выскочившем диалоге {red}(отказаться) обновлять BIOS и firmware.После того, как появится надпись "Сервер поставлен на наливку", необходимо вернуться в просмотр информации о сервере ("View") и нажать вот такую кнопку: <file:start_setup.png>После нажатия фокус действий перемещается в на наливайку. Если у машинки был настроен IPMI и его мак был указан в RT, то ребут машинки и начало наливки произойдет автоматически, в противном случае - {red}(необходимо самостоятельно отправить машинку в перезагрузку и выбрать загрузку с сети).{red}(При необходимости переключить интерфейс самостоятельно имеет смысл **посмотреть**) [в таблицу](/NOC/nalivkafreebsd#tekushhajainformacijaponalivajjkami) ниже для определения, в какой именно влан его переключать. Кроме того, очень желательно погасить еще и интерфейс port channel'а.
- После загрузки по сети первого меню наливайки нужно нажать кнопку "i", Если дело происходит в КР, то надо набрать "i0".
- Подождать 7-8 минут (примерно 3 минуты на загрузку с сети, и столько же - наливка, столько же - перезагрузка), периодически обновляя статус (а лучше, наблюдая за ним через IPMI).
- При завершении (на данным момент завершение сигнализируется красным этапом *Setup*), необходимо зайти на машинку и выполнить следующие действия:
```
chroot /target /bin/tcsh # чрутимся в свежесозданный мир

# Проверяем rc.conf.local на правильность конфигурации (hostname, адреса лупбеков, lagg):
# less /etc/rc.conf.local

# rc.conf.local autogenerated @2012-05-25 01:06:51 GMT-4
###########################################################################################
###### BEWARE! This file is autogenerated. Do not edit by hand.                   #########
###### Do `make -C /usr/local/router/conffiles ifconfig'  to generate new version #########
###               Please put local changes to /etc/rc.conf.localscripts           #########
###########################################################################################


hostname="ra.yandex.net"

ifconfig_ix0="up mtu 9000"

# lo1
cloned_interfaces="${cloned_interfaces} lo1"
ifconfig_lo1="87.250.228.185/32"
ipv6_ifconfig_lo1="2a02:6b8:0:1600::4/128"

# vlan802
cloned_interfaces="${cloned_interfaces} vlan802"
ifconfig_vlan802="141.8.159.58/26 vlan 802 vlandev ix0 mtu 9000"

# Проверяем make.conf на предмет OURDC_NAME и ROUTERTYPE:
# cat /etc/make.conf
# make.conf autogenerated @2012-05-25 01:06:51 GMT-4

ROUTERTYPE=CORE
BGP_IPV6=1
OURDC_NAME=IVA
OURDC_RREFLECTOR=87.250.234.60
OURDC_NTP=93.158.140.65
OURDC_COMMUNITY=13238:1186
```
- **(ВНИМАНИЕ)!** Если машинка собирает lagg0 и подсоединена к HUAWEI, то перед ребутом машинки, надо заSHUTDOWN'ить на HUAWEI тот порт через который вы наливали. Иначе прилетевшая LACP на порт HUAWEI , который не настроен как LACP, разберёт вам исправно настроенные LACP.!!!  **
```

```
Убедиться, что коробка нормально загрузилась и туда можно залогиниться.
## Ошибки наливки

### Ядро от 9.x при юзерленде от 8.x

Возникает, если наливка оказалась не в состоянии зачистить оба диска в системе. При этом лоадер может загрузить ядро со свежего пула zfs, а само ядро - подтянуть другой пул с другого диска.Как чинить: затирать первые и последние 4 512байт секторов у каждого диска и пробовать ешё раз:
```
sysctl kern.geom.debugflags=16
sudo diskinfo ada0
ada0    512     500107862016    976773168       0       0       969021  16      63
## 4й параметр - количество секторов
dd if=/dev/zero bs=512 count=4 seek=976773164 of=/dev/ada0
sudo diskinfo ada1
ada1    512     500107862016    976773168       0       0       969021  16      63
dd if=/dev/zero bs=512 count=4 seek=976773164 of=/dev/ada1

# А теперь начало
dd if=/dev/zero bs=512 count=4 of=/dev/ada0
dd if=/dev/zero bs=512 count=4 of=/dev/ada1
```
## После наливки

Ряд действий, которые на данный момент недоавтоматизированы.
- {red}(**ОБЯЗАТЕЛЬНО**) перезапустить файрволл (в загруженной версии заведомо не хватает правил с fqdn'ами отличными от {yandex.ru, yandex.new, yandex-team.ru})
- Переключить интерфейс обратно и нажать кнопку "
   Завершить наливку 
  " в RT. Последнее совершенно необходимо, поскольку отбирает возможность у наливайки еще раз (например, случайно по браузерной ссылке) переналить сервер (эффект может быть довольно неожиданным, учитывая наличие impi)
- Удалить publickey налитого хоста для пользователя racktables на noc (/home/racktables/.ssh/known_hosts). Это если хост переналивается и его ключ закэширован на noc-ugr - gescheit зачинил, больше делать не надо, ключ при переналивке останется прежним;
- В случае новой наливки имеет смысл тыкнуть в кнопку синхронизации интерфейсов в RT для актуализации списка/мак-адресов.
- В случае наливки через образ, после загрузки сервера и имея уже работающюю сеть (есть доступ до RT) необходимо актуализировать конфигурацию в файле /boot/loader.conf.d/nic_drv. Для этого выполнить команду: make -C /usr/local/router/conffiles nic install-nic
# Собственная ноковская наливка

Наливочный сервер располагается в Угр-Б, называется noc-nalivka1. Для наливки машин используется VLAN 538.Действия по наливке, используя собственную ноковскую наливку, не отличаются от действий при использовании наливки 

:
1. Интерфейс свитча, куда подключен onboard интерфейс сервера переводится в влан 538.
2. На сервере в BIOS выставляется загрузка по сети.
3. В РТ нажимается кнопка "начать новую наливку"
Влан 538 пока есть только в Угр-Б. Если этот влан создается в каком-то другом месте и выделяется ipv4 сеть, необходимо:
1. Чтобы на noc-nalivka1 в dhcpd.conf были записи для новой сети, аналогичные этим:
```
subnet 37.140.130.128 netmask 255.255.255.248 { 
	pool {
		range 37.140.130.129 37.140.130.133 ;
		option subnet-mask 255.255.255.248 ; 
        	option routers 37.140.130.134 ; 
        	option broadcast-address 37.140.130.135 ; 
		deny unknown-clients;
	}
}
```
2. на роутере где будет терминироваться влан 538 была запущена dhcprelya с такой строчкой в файле dhcprelya.servers:
```
37.9.88.187 vlan538
```
Если такая строчка отсутствует или имеет другие значения, то нужно выполнить 3 таргета:make -C /usr/local/router/conffiles/dhcprelya update make -C /usr/local/router/conffiles/dhcprelya installmake -C /usr/local/router/conffiles/dhcprelya restart
3. Обновить фаерволл в нужных местах, чтобы приехали измнения макроса 
   NOCNALIVKANETS
   /usr/local/routers/scripts/vlans.php --restart 
   NOCNALIVKANETS
Некоторые отличия собственной наливки нок от наливки 

1. При нажатии кнопки "начать новую наливку" сразу происходит update CVS директории noc/routers. Таким образом нет необходимости выжидания суток после заведения новой машины в RT.
2. После наливки нет необходимости в выполнении "cleanup".
3. У машины сразу нормальный фаерволл (разве что не табличный), так что после перезагрузки машины есть сетевая связность и можно просто обновить фаерволл, для того чтобы он стал табличным.
## Наливка машины в регионе или для региона

Раньше в регион машины наливались путем наливки в каком-нибудь ДЦ и исправлением директивы OURDC_NAME в /etc/make.conf на соответсвующее необходимое значение и затем следовала перегенерация конфигурационных файлов. Теперь когда появилась возможность наливать машины в регионе, то следует заранее озаботится наличием необходимой записи в cvs-backup.php, getPOIList(),как пример:
```
'BERBLUE' => '{офис Берлин}',
```
Без подобной записи для региона не будет сконфигурирована перменная OURDC_NAME и наливка будет произведена с ошибками.

Наливка рутера FreeBSD в регионе возможна по двум сценариям:
1. Обычная наливка "по сети", если на площадке развернут vlan538, имеется dhcprelay, etc
2. Создание ISO образа, который монтируется через IPMI Virtual CDROM и с которого в дальнейшем происходит установка.
Создание образа:
1. Убедится, что в RT на машине стоит любой оффлайновый тег, например "апгрейд или замена".
2. Убедится, что в RT для машины добавлены все физические интерфейсы, какие на ней есть (онборды igb0,igb1 или em0,em1; дополнительная 10G карта: ix0 и/или ix1).
3. На вкладке "View" для машины в RT, в выпадающем меню "наливка" выбрать пункт "создать образ FreeBSD/9".
Через 5-10 минут на почту придет письмо, содержащее ссылку на скачивание образа.

Процесс установки с образа:
1. Скачать образ по ссылке из письма.
2. Подключить образ через IPMI CDROM.
3. Перезагрузить сервер и выбрать загрузку с CD.
4. Войти в систему, используя имя пользователя 'root'
5. Скопировать образ диска в память целиком: `q=`mdconfig -a -t swap -s 1G`; dd if=/dev/cd1 of=/dev/$q bs=1M` (нужно делать в sh, а не csh)
6. Смонтировать CD в /mnt директорию командой `mount -t cd9660 /dev/$q /mnt`
7. Запустить установочный скрипт `sh /mnt/install.sh`
8. Установка завершена. Перезагрузить сервер.
9. Проверить установку, при необходимости выполнить действия "После наливки".
# Материальная база наливки

Сама «наливка» состоит из двух группировок виртуальных машин, запущенных на разных гипервизорах.[noc-nalivka1](https://racktables.yandex.net/index.php?page=object&object_id=10987):
- [noc-nalivka1-linux](https://racktables.yandex.net/index.php?page=object&tab=default&object_id=20543)
[caleuche](https://racktables.yandex-team.ru/index.php?page=object&tab=default&object_id=32522):
- [noc-nalivka-freebsd12](https://racktables.yandex.net/index.php?page=object&tab=default&object_id=61212)
- [noc-nalivka-freebsd13](https://racktables.yandex.net/index.php?page=object&tab=default&object_id=61213)
## Гипервизор noc-nalivka1

Виртуальные машины располагаются в директории: **/virt**
```
noc-nalivka1 ~ ls -la /virt
total 3.1G
drwxr-xr-x  6 axscrew axscrew 4.0K Aug  4  2015 .
drwxr-xr-x 23 root    root    4.0K Mar  3  2015 ..
drwxr-xr-x  3 root    root    4.0K Aug  4  2015 fbsd-noc
drwxr-xr-x  2 axscrew axscrew 4.0K May 25  2015 ubuntu-noc
```
Запускаются скриптами:
```
/virt/fbsd-noc/freebsdstart.sh
/virt/ubuntu-noc/linuxstart.sh
```
Для старта при загрузке системы добавлены в /etc/rc.local
## noc-nalivka1-linux

Данный наливочный сервер используется для наливки freebsd и linux машин по сети. Везде в [VLAN538](https://racktables.yandex.net/index.php?page=search&last_page=object&last_tab=default&q=vlan538) есть dhcprelay на адрес этого сервера.При нажатии в RackTables кнопки "Налить FreeBSD 9", "Налить FreeBSD 11" или "Налить балансер", на наливочном сервере запускается скрипт **/netinstall/scripts/editdhcpdconf.sh** которому в параметрах передаются FQDN, MAC-адреса и версия системы, которую требуется налить (rtr9, rtr11, slb и т.д.)Этот скрипт добавляет или удаляет записи из конфигурационного файла DHCPd **/etc/dhcp/dhcpd_nalivka.conf**:
```
#FreeBSD11 hosts group
group {
       filename "FBSD11/boot/pxeboot" ;
       option root-path "37.9.88.187:/netinstall/tftpboot/FBSD11/" ;
on commit {
        set ClientIP = binary-to-ascii(10, 8, ".", leased-address);
        set ClientMac = binary-to-ascii(16, 8, ":", substring(hardware, 1, 6));
        log(concat("FreeBSD RTR11 nalivka IP: ", ClientIP, " Mac: ", ClientMac));
        execute("logger", "FreeBSD RTR11 nalivka:", ClientIP, ClientMac);
}

#RTR11 HOSTS
 host sas1-decap2.yndx.net3 { hardware ethernet 90:E2:BA:3D:C1:69 ; option host-name "sas1-decap2.yndx.net" ; }
 host sas1-decap2.yndx.net2 { hardware ethernet 90:E2:BA:3D:C1:69 ; option host-name "sas1-decap2.yndx.net" ; }
 host sas1-decap2.yndx.net1 { hardware ethernet BC:AE:C5:36:51:0E ; option host-name "sas1-decap2.yndx.net" ; }
 host sas1-decap2.yndx.net0 { hardware ethernet BC:AE:C5:36:55:76 ; option host-name "sas1-decap2.yndx.net" ; }
 
}
```
Машины по сети грузят определенную систему в зависимости от той которую которую требуются налить. Сами директории монтируемые по NFS находятся в **/netinstall/tftboot**.После загрузки машины запускается скрипт наливки, как правилов случае **FreeBSD** это **freebsd-nalivka1-stage1.sh** из **/etc/rc.local**в случае **Linux** это **new_run_stage1_setup.sh** из **/usr/local/balancers/scripts/nalivka**

Скрипты **stage1**, а также необходимые для установки дампы **CVS и GIT репозиториев** обновляются путем запуска по крону раз в 15 минут скрипта **/netinstall/scripts/packnocdump.sh**. Этот скрипт запускается немедленно при добавлении машины в наливку из RT.
## Гипервизор caleuche

[Информация о работе с гипервизором](/noc/office/ghostharbour/#virtualkidljageneraciiiso-obrazov)
### noc-nalivka-freebsd-*

Эти виртуалки используются, когда требуется сгенерировать установочный образ FreeBSD для установки через VirtualCDROM в IPMI.При нажатии в RackTables кнопки "Сгенерировать дамп FreeBSD" запускается с определенными параметрами скрипт **/netinstall/scripts/buildbsd.sh**, который запускает процесс генерации ISO образа в бекграунде. Скрипту передаются такие параметры как FQDN, версия ОС и имя пользователя, запустившего генерацию образа. Сам процесс установки системы происходит в Jail, далее система архивируется, создается ISO образ куда добавляется архив и скрипт установки. Когда образ готов, пользователь получает письмо с указанием по установке, ссылками на образ и на лог генерации.

{% cut "Пример письма:" %}

```
Привет, axscrew.

ISO образ для tulka.yndx.net создан.

Инструкция по установке:
1) Скачать образ по ссылке: http://noc-nalivka1-freebsd.yndx.net/iso/tulka.yndx.net-FreeBSD-9-160822022016.iso
2) Подключить образ через IPMI CDROM.
3) Перезагрузить сервер и выбрать загрузку с CD.
4) Войти в систему, используя имя пользователя 'root' и пароль 'mfsroot'
5) Смонтировать CD в /mnt директорию командой 'mount -t cd9660 /dev/cd0 /mnt'
6) Запустить установочный скрипт 'sh /mnt/install.sh'
7) Установка завершена. Перезагрузить сервер.
8) После загрузки сервера выполнить рестарт фаерволла.
9) Перегенировать nic_drv командой 'sudo make -C /usr/local/router/conffiles nic install-nic'
10) Лог создания образа: http://noc-nalivka1-freebsd.yndx.net/log/setup_log-tulka.yndx.net-160822022016

Полная инструкция: https://wiki.yandex-team.ru/NOC/FreeBSD#nalivkamashinyvregioneilidljaregiona
Свериться с чек-листом: https://wiki.yandex-team.ru/NOC/FreeBSD#poslenalivki
Ранее созданные образы доступны по ссылке: http://noc-nalivka1-freebsd.yndx.net/iso

Это письмо сгенерировано автоматически, отвечать не требуется.


English version.

Hello, axscrew.

ISO image for tulka.yndx.net has been created.

Setup instruction:
1) Download the image from http://noc-nalivka1-freebsd.yndx.net/iso/tulka.yndx.net-FreeBSD-9-160822022016.iso
2) Connect the image via virtual IPMI CDROM.
3) Reboot the server and choose boot from a CD.
4) Sign in with username 'root' and password 'mfsroot'
5) Mount CD to /mnt directory with command 'mount -t cd9660 /dev/cd0 /mnt'
6) Invoke the installation script 'sh /mnt/install.sh'
7) Setup has been completed. Reboot the server
8) Restart firewall once the server boots.
9) Recreate nic_drv with command 'sudo make -C /usr/local/router/conffiles nic install-nic'
10) Log of image creation: http://noc-nalivka1-freebsd.yndx.net/log/setup_log-tulka.yndx.net-160822022016

Full instruction on https://wiki.yandex-team.ru/NOC/FreeBSD#nalivkamashinyvregioneilidljaregiona
Have a look at checklist on https://wiki.yandex-team.ru/NOC/FreeBSD#poslenalivki
All of ever created images are available on http://noc-nalivka1-freebsd.yndx.net/iso

This email has been generated automatically, response is not necessary.
```

{% endcut %}