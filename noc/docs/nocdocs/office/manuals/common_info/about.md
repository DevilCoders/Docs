# Подготовка серверов в новый офис

Источник в [https://wiki.yandex-team.ru/noc/office/fishdeployment/](https://wiki.yandex-team.ru/noc/office/fishdeployment/)

# Общие сведения

## Заказ оборудования

| Наименование | Количество |
| - | - |
| Роутер в стоечном исполнении на базе Supermicro с IPMI на бортуМинимальные требования:- IPMI- 64Gb RAM ECC (48Gb, если память трехканальная)- 2*SSD 240Gb- 1*CPU, Intel XEON любой серии- 2 1G сетевых портах на чипе Intel- 1 PCIe riser для установки дополнительных картВ России можно использовать любую закупаемую для ДЦ платформу, например, X9DRW Super Micro - (E2660/128gb/4*SATA 500Gb/1U) | 2 шт |
| Свичи: `Cisco Catalyst WS-3650-48PS-L` | 1 шт |
| Трансиверы: Cisco GLC-T (или аналог вроде Modultech MT-E-GB-P1RC, Finisar FCLF8522P2BTL) | 4 шт |
| Wifi:

Для России комплект (Cisco AIR-CAP2702E-R-K9 - 1шт., AIR-ANT2524DW-R - 4шт).Для Турции и Европы комплект (Cisco AIR-CAP2702E-E-K9 - 1шт., AIR-ANT2524DW-R - 4шт)NETGEAR A6210-100PES (OmniPeek remote probe) - 1шт | 1 комплект. |
| Dect: Kirk ip6000 base station | 1 шт. |
| Телефоны: cisco 7821 | 5 шт. |
| Телефоны Siemens SL37H | 1-5 шт. |
| Факс: плата FXS+FXO в рутер + медная линия, либо подключение к серверу провайдера либо программный способ отправки через московский офис |  |
| Видеоконференция: Cisco SX20 | 1 шт |
| Стойка для оборудования APC в комплектации:  1 x AR8122BLK  3 х AR8425A  1 х AR2480  2 х AR7540 | 1 комплект |
| Стоечный UPS на 1500-2000VA 230V, с платой RJ-45 из расчета на 1 час автономной работы. Примеры:1. GXT3-2000RT230 + Адаптер SNMP для Intellislot2. SUA1500RMI2U + Плата AP9630 | 1 шт |

[про оборудование для маленького офиса](!/../SmallOfficeRack)
## Подключение офиса к сети

Каждый офис должен подключаться к сети Интернет при помощи двух независимых провайдеров. При этом оба оператора являются рабочими, "резервных", "запасных" и иже с ними не бывает - любой из каналов в произвольное время может быть нагружен пользовательским трафиком.Каждый из операторов связи обязан предоставить нам в единоличное пользование IPv4 сеть размером /29 (8 адресов, 5 рабочих, 3 "технологических").

В офисе к Интернету подключаются 5 портов нашего оборудования:
- два порта eth1 (igb1) роутеров для пропуска трафика через "первого" оператора;
- два порта IPMI роутеров для управления;
- один порт коммутатора для пропуска трафика через "второго" оператора.
Возможные схемы подключения представлены ниже. Как видно из картинки, для NOC наиболее желаемым является "Идеальный вариант", когда наш коммутатор используется для пропуска трафика только одного провайдера, при этом оба оператора тарифицируют все свои порты по суммарной полосе. В большинстве случаев эта идиллия недостижима, и в таких случаях можно IPMI-порты выделять в отдельные подключения с отдельной полосой в 2Mbit/s. В самом низу схем представлены наиболее неблагоприятные, хотя и возможные, схемы подключения. Заметим, что не в каждом офисе есть два коммутатора, так что использование таких схем требует явного согласования с NOC ещё на этапе заказа оборудования.

{% cut "Схемы" %}

![file:Typical%20office%20connections%20plans.png](file:Typical%20office%20connections%20plans.png)[оригинал в Dia](file:"Typical%20office%20connections%20plans.dia")

{% endcut %}

## BIOS

Настройки ниже относятся исключительно к офисным роутерам и VPN-концентраторам и отключают фичи, необходимые серверам-гипервизорам.
### General

| Quiet Boot | Disable |
| - | - |
| Wait for F1 if Error | Disable |
| Restore on AC power loss | Last State |

### CPU

| AES-NI | Enable |
| - | - |
| Intel Virtualization Tech | Disable |
| Hyper Threading/Simultaneous Multi-Threading | Disable |

- Первый абзац [отсюда](/users/junk/Drajjver-ixgbe-i-uluchshenie-setevyx-nastroek/#nastrojjkabios)
### IDE/SATA

Убедиться, что включен AHCI
### Сервер Gigabyte для региональных офисов:

Gigabyte (регофисы)

Advanced:
1. PCI Subsystem Settings -> выключить ROM на всех сетевых картах
IntelRCSetup:
2. Processor configuration -> Hyperthreading disable
3. IIO Configuration -> Intel VT for Directed I/O -> VT-d disable
4. IIO Configuration -> IOAT configuration -> Enable IOAT (enable)
5. PCH Configuration -> PCH devices -> High precision timer (enable)
6. PCH Configuration -> PCH SATA Configuration -> mode: AHCI
Boot:
7. Quiet Boot: disable
Проверяем, что BIOS мат.платы Gigabyte MB10-DS3 обновлен до версии >= F11. Старая версия может вызывать ситуацию, когда после ребута рыбки не поднимается сетевой интерфейс ix0.

{% cut "Обновляем версию так:" %}

1. Скачиваем архив с новым BIOS c офф.сайта
2. Заходим на веб-морду IPMI и идем в пункт Update
3. Выключаем сервер.
4. В Firmware Type указываем "only BIOS". В файл образа подкладываем image.RBU из скаченного архива (папка RBU)
5. Запускаем процесс прошивки и после успешного завершения включаем сервер. Пока сервер не включится, новая версия BIOS не отобразится.
6. BIOS сбросится в дефолт, поэтому настраиваем его по инструкции выше.

{% endcut %}

## 802.1Q домен

С некоторых пор, стоит также делать отдельный VLAN-домен для каждого офиса.Проще всего выполнить клонирование уже существующего на вкладке [RT -> 802.1Q -> Manage Domains](https://racktables.yandex-team.ru/index.php?page=8021q&tab=vdlist). За эталон принят таковой "шаблон для нового офиса". После клонирования можно сменить имя для vlan 811 на название местного ISP.**Важно:** привязать сеть к vlan в 802.1q домене офиса (если он не указан в имени сети), иначе для хостов в ней [не будут созданы PTR записи динамически](https://st.yandex-team.ru/NOCREQUESTS-9738)
## Переход со старой схемы с LiveVlans к 802.1q

Переход на новую схему в старых локациях аналогичен созданию этой локации в 802.1q из предыдущего пункта за исключением некоторых дополнительных шагов.
- Первое, что нужно сделать, это перед конвертацией, в файле [pns.php](https://noc-gitlab.yandex-team.ru/nocdev/racktables/blob/master/plugins/pns.php) произвести изменение режима VTP вновь-наливаемым свитчам в конвертируемой локации. Вот [пример коммита](https://noc-gitlab.yandex-team.ru/nocdev/racktables/commit/23cc49eb2e2a24ca6e1b707375f7d9aad65d477a?merge_request_iid=388), он достаточно прост и может выполняться дежурными. В случае каких либо проблем с подобным коммитом всегда можно обратиться за помощью в NOCDEV.
- Так же следует создать, или убедиться в наличии домена 802.1q в конвертируемой локации
- В домене обязательно должны быть все необходимые вланы, которые могут приехать по 802.1x + несколько дополнительных псевдо-вланов, означающих конфигурацию (13000, 13434). Домен можно так же склонировать с базового шаблона.
  - Группы вланов и правила, по которым они приезжают в определенные локации основаны на тегах и описаны в [этой форме](https://racktables.yandex-team.ru/index.php?page=staffonly&tab=dot1x)
- в [permissions.txt](https://racktables.yandex-team.ru/index.php?page=perms) в предикат 
  поддерживается 802.1X
   необходимо добавить конвертируемый офис
- На коммутаторах Cisco, на которых вланы распространялись через VTP, необходимо переключить режим работы vtp в transparent
- В RT во вкладке 802.1Q order прицепить к комутатору шаблон "полностью ручной IOS/VRP"
- Выполнить втягивание конфигурации с коммутаторов в конвертируемом 802.1q домене (в данный момент кнопки для всего домена нет, надо делать на каждом свитче отдельно ({green}(зеленая) стрелочка pull в 802.1Q sync). Тикет на это дело тут: NOCDEV-1852)
## DHCP

Для IPv4 сетей, в которых должен работать DHCP, на роутере разворачиваются 2 демона:
- DHCPd
- dhcprelya
DHCPd несет в себе конфигурацию сетей, слушает запросы на лупбеке. dhcprelya отвечает за пересылку (релееинг) запросов от конечных потребителей в DHCPd и ответов обратно.
### DHCPd

Конфиг DHCP-сервера един для всех офисов. Обновляется он традиционно через CVS. Рабочая копия должна лежать в /usr/local/dhcpd. В файле 
/usr/local/dhcpd/regions/dhcpd-common.conf.m4
 лежат настройки специфичные для региональных офисных сетей. После редактирования этого файла нужно сделать make install restart в директории /usr/local/dhcpd/regions/, проверить, что все работает, а затем make commit.{red}(RackTables автоматически выкатывает изменения, сохраненные в CVS, так что незакомиченные локальные правки в любой момент могут уйти из активной конфигурации.)

В шаблоне 
dhcpd-common.conf.m4
 можно использовать как традиционное описание конфигурации сети для ISC DHCPd (оно будет выкачено as-is), так и макрос 
NETWORK
, который в большинстве случае сводит описание сети для DHCPd к заданию CIDR'а сети и номера влана - весь конфиг сети, включая дополнительные параметры, макрос вычисляет сам.Запущенные демоны DHCPd смотрят также в файл псевдостатики/usr/local/etc/dhcp-pseudostatics.conf, где описываются зомбики и принтеры, изменения IP которых нежелательны, и указан точный MAC
```
host zomb-cloud-support.zombie.yandex.net { hardware ethernet d4:5d:df:03:3a:74; fixed-address zomb-cloud-support.zombie.yandex.net; }
host prn-993.yandex-team.ru { hardware ethernet 9c:93:4e:8c:d1:2b; fixed-address prn-993.yandex-team.ru; }
```
### dhcprelya

Конфиги демона лежат в 
/usr/local/router/conffiles/dhcprelya/
, правятся и выкатываются вручную. Процесс запускается (рестартится) каждый раз, когда REPS навешивает сети;Перегенерации конфигов при этом не происходит.
### Добавление новой сети, влана

1. DHCPdдобавляем новую сеть в  noc/dhcpd/regions/dhcpd-common.conf.m4 [пример](https://tree.yandex.ru/cgi-bin/cvsweb.cgi/noc/dhcpd/regions/dhcpd-common.conf.m4?r1=1.69&r2=1.70&f=h)Если в офисе уже существовала гостевая сеть на публичных адресах - новую в конфиг добавляем с 
   shared-network
    и 
   NORANGE
   :
   ```sh
   make -C noc/dhcpd/ update
   #коммитим
   make -C noc/dhcpd/ diff commit
   # Делаем рестарт dhcpd на нужной рыбке:
   make -C /usr/local/dhcpd/regions/ install restart
   ```
2. Если это новый vlan, то его необходимо прописать в конфигурацию dhcprelya и применить изменения. Добавляем его в VLAN-домен этого офиса
## Гостевая сеть с NAT

Для офиса выделяем две IPv4-сети:/30 – loopback-и (lo423) для NAT. Выделяется из специального агрегата [93.158.190.0/23](https://racktables.yandex-team.ru/index.php?page=ipv4space&tab=default&clear-cf=&cfe={%24ip4netid_11106}&hl_net=1&eid=11106), который ~~**не входит**~~ не будет входить в будущем в 
YANDEXNETS
. Если в офис планируется более 2 рыбок - агрегат выделять из расчета 2 адреса на рыбку, если не сказано иное (для больших офисов может использоваться 4 или даже 8 адресов на роутер)/23 – серая гостевая сеть. Выделяется из [172.21.0.0/16](https://racktables.yandex-team.ru/index.php?page=ipv4space&tab=default&clear-cf=&cfe={%24ip4netid_5369}&hl_net=1&eid=5369).

Если в гостевой сети нет IPv6 – выделяем. Следует обратить внимание на то, что у серой /23 IPv4-сети и у белой IPv6-сети разные макросы (
NATGUESTNETS
 у IPv4 и 
GUESTS
 у IPv6).

Для каждой рыбки выделяется свой подагрегат /31, все адреса из него навешиваются с типом Loopback на рыбку. Через 10 минут после документации в RT данные будут готовы к использованию в фаерволе, который нужно рестартануть.

Пример: [93.158.191.240/28 для Авроры](https://racktables.yandex-team.ru/index.php?page=ipv4space&tab=default&clear-cf=&cfe={%24ip4netid_11104}&hl_net=1&eid=11104), используется /30 на каждую рыбку, ибо офис большой.
## Инфраструктура Jail

Каждый офисный роутер несет на себе ряд FreeBSD jail, в которых крутятся сервисы, которые полезно изолировать от основной системы по тем или иным причинам. Каждой jail при старте выделяется один IPv6 адрес, который вычисляется на основе IPv6 адреса, который повешен на lo99 роутера средствами RackTables. Чтобы механика работала корректно, адрес на роутере должен быть сформирован следующим образом:`<prefix,64>:0:0:${private_asnum}:${router_number}`
private_asnum
 - вычисляется по формуле 
65200+DC_CODE
 и записывается **в шеснадцатиричном формате**, например для Строганова это 
65301
 и 
ff15

router_number
 - порядковый номер роутера в локации, должен быть уникальным. Для простоты можно использовать тот же номер, что используем в нижних 16 битах IPv6 адреса 
lo1
.Получившийся адрес присваиваем на lo99 с типом loopback.IPv6 адрес контейнера рассчитывается следующим образом:
| Длина в битах |  |  |  |  |
| - | - | - | - | - |
| Содержимое | prefix | jail_id | private_asnum | router_number |

jail_id - уникальный идентификатор jail, который описывает контейнеры этого типа на всех серверах.В DNS [автоматика](https://noc-gitlab.yandex-team.ru/nocdev/racktables/-/blob/master/plugins/dynamic_dns.php#L700) добавляет записи вида `$jail_name.$router_name.yndx.net`.Файловая система всех jail живет в /usr/jail. Базовым элементом является пакет jailer, который устанавливает в /usr/jail/skel базовый набор пакетов (в частности, base) - эти файлы переиспользуются непосредственно контейнерами (делается snapshot skel с последующим clone). По умолчанию внутрь jail устанавливается пакеты для корректного функционирования процессов. Если внутри jail нужно удобное окружение с претензией на полноценную систему, можно прямо изнутри jail установть пакет `jail-interactive`.
### Persistent storage

При обновлении пакета с jail все содержимое уничтожается, кроме файлов, лежащих в /persist. Пакет, устанавливающий jail, должен создавать необходимые символические ссылки на объекты в /persist или использовать его для объектов, которые должны сохраняться при переустановке jail'а.
### Jail "stream" (id 0x1935)

nginx с ретранслятором Я.Эфира внутри. Устанавливается на `{router for office}` вручную после запуска машины. Для работы nginx требуется установка [сертификата](https://yav.yandex-team.ru/secret/sec-01eke3shqhch5k5p0xz9jkvpw6/explore/versions) в `/usr/jail/stream/persist/usr/local/etc/ssl` c именами `streaming.{crt|key}`Помимо nginx в контейнере работает rdr_metrics, отправляющий состояние хоста в HEX.
### Jail "iptel" (id 0x5060)

voipmonitor для анализа качества голосовой связи. Устанавливается на `{router for office}` вручную после запуска машины. В разработке.
### Jail "nucdeploy" (id 0x7005)

MVP для наливки NUC'ов на складах Маркета. Устанавливается на `{router for office}` вручную после запуска машины. В разработке.
## Взаимодействие с СИБ

На рыбках и московских рыболовецких суднах в интересах СИБ запущены два демона:
- softflowd
   - NetFlow-сенсор, отправляющий информацию о сессиях на коллектор СИБ
- passivedns
   - агрегатор DNS-запросов и детектор malware-активности в разрезе DNS. Шлет логи в 
  syslog @ trapdoor.yandex.net
Оба демона запакетированы (включая конфигурацию и rc-крутилки), устанавливаются в рамках метапакетов 
regoffice-router
 и 
vpn-concentrator
. Отправка логов в trapdoor регулируется в шаблоне 
syslog.conf
. Дополнительная конфигурация не требуется, достаточно просто установить пакеты.
## Документирование туннеля

Так как генерация `make -C nodeconfigs regional_office.inc.m4` сделана в BSD-like стиле, следующие операции лучше всего выполнять будучи подключённым на машины noc (например noc-myt).
1. Выделить [при помощи инструмента](https://racktables.yandex.net/index.php?page=staffonly&tab=regoffice) адреса для туннеля. Инструмент сделает следующее:
   
   {% cut "раскрыть подробности" %}
   
   выделит из офисного агрегата:
   - IPv4 /31
   - IPv6 /64На рыбку вешается первый адрес из /31 и ::2 из /64, на VPN-концентратор, соответственно, второй адрес из /31 и ::1 из /64. Тип аллокации во всех случаях - Point-to-point. Обе выделенные сети заносятся в фаервольный макрос _IPSECTUNNELENDPOINTS_, имя сети "IPSec peer to peer", навешивается тег регионального офиса и 
     IPSEC VPN
     .
   
   {% endcut %}
2. клонируем annsuhka из гита
   
   {% cut "(раскрыть подробности, если вы используете гит в первый раз)" %}
   
   Зайдите на браузером ![https://noc-gitlab.yandex-team.ru/](https://noc-gitlab.yandex-team.ru/), используйте там кнопку "Sign in with Yandex" - это создаст пользователя на гите. После этого автоматика возьмет ваш ssh-ключ из наливки и установит в гит. Автоматика делает это два раза в сутки: в 5:00 и 18:00.
   
   {% endcut %}
   
   ```sh
   git clone git@noc-gitlab.yandex-team.ru:nocdev/annushka.git
   cd annushka
   ```
   (либо обновляем содержимое, если клонирование уже делалось ранее
   ```sh
   cd annushka
   git pull --rebase
   ```
   )
3. добавляем в файл *annushka/nodeconfigs/jsdb/regional_office.inc.json* новый туннель:
   
   {% cut "(пример)" %}
   
   ```json
   {
   "PEER1": "whaler",
   "PEER2": "minnow",
   "IFACE": "ipsec202",
   "OUTER1": "195.156.199.197",
   "OUTER2": "46.229.140.149/24",
   "NAT": "",
   "VACANT1": "",
   "VACANT2": "",
   "BGP_OPT": "9",
   "DISABLED": false
   },
   ```
   "PEER1" - концентратор"PEER2" - региональная машинка"IFACE" - номер ipsec, выданный на первом шаге"OUTER1" - адрес концентратора"OUTER2" - CIDR регионального сервера"BGP_OPT" - препенд
   
   {% endcut %}
4. сгенерировать файл regional_office.inc.m4:`make -C nodeconfigs regional_office.inc.m4`
   
   {% cut "(раскрыть подробности, если ругается про ImportError)" %}
   
   Установите необходимые модули: `python3 -m pip install --user -r requirements.txt`
   
   {% endcut %}
5. сохраняем файл и коммитим в git
   ```
   git checkout -b your_branch_name
   git diff
   git commit -a
   git push origin your_branch_name
   ```
   - Идём в веб-интерфейсе в ![https://noc-gitlab.yandex-team.ru/nocdev/annushka/merge_requests/new](https://noc-gitlab.yandex-team.ru/nocdev/annushka/merge_requests/new), выбираем в выпадающем списке 
     Select source branch
      your_branch_name
   - Убеждаемся, что слева от номера коммита стоит зелёная галочка Commit: passed (что тесты прошли)
   - нажимаем зеленую кнопку 
     Compare branches and continue
      . Target branch должен быть 
     master
     .
   - Нажимаем зеленую кнопку 
     Submit merge request
     .
   - выставляем галку 
     Remove source branch
      (она уберет наш your_branch_name).
   - Нажимаем зеленую кнопку 
     Merge
     .
   - ```
     git checkout master
     git pull --rebase
     git branch -d your_branch_name
     ```
6. Обновляем routers/regional_office.inc.m4:`make -C routers update`
7. копируем созданный из j2 файл:`cp annushka/nodeconfigs/tmp/regional_office.inc.m4 routers/regional_office.inc.m4` ,сравниваем:`make -C routers diff`,если всё устраивает - коммитим в CVS:`make -C routers commit`
## Настройка ПНС (пункта наливки свитчей)

Для того, чтобы автоматизировать процесс наливки свичей и ТД нужно использовать ПНС (пункт наливки свичей).
1. Завести гео-тег локаций в RT.
2. Выяснить номер свежесозданного тега, путем наведения на него мыши во вкладке View.
3. Выяснить id управляющей сети. Он указан в url-е сети, при открытии ее страницы в RT.
4. Отредактировать и закоммитить файлы на cvs:noc/switches/autoload: radius.m4 и ~~cisco-wifi.m4~~ wifi-ssids.m4 (если нужно что-то ещё, кроме Yandex (440), PDAS (419), Guests (423), MobCert (429)). В первом файле в параметре MASTER_RADIUS указывается ip-адрес лупбека на офисном рутере. Если в итоговой конфигурации в racktables вместо имени интерфейса vlan400 стоит просто vlan, то это значит, что имя сети VLAN400 не было прописано в названии сети. Нужно писать именно так, большими буквами.
5. В своей рабочей копии [git@noc-gitlab.yandex-team.ru:nocdev/racktables.git](http://noc-gitlab.yandex-team.ru/groups/nocdev), отредактировать файл plugins/pns-resources-office.php. Проверить, что в файле нет синтаксических ошибок: php -l pns-resources-office.php
   ```bash
   git clone git@noc-gitlab.yandex-team.ru:nocdev/racktables.git
   # если нет прав на коммит в мастер
   git checkout -b 'my_branch'
   ```
   Нужно вставить вот такой кусок кода (показан пример для БЦ Морской):
   ```php
   652 => array // офис Одесса БЦ Морской
           (
                   'ipv4pool' => array
                   (
                           'default' => 2819,
                   ),
                   'vlandomain' => FALSE,
                   'type' => 'office',
                   'idxpools' => array (
                                   array ('from' => 1, 'to' => 9),
                                   ),
                   'prefixes' => array
                   (
                           'User Switch' => array('mor-u'),
                           'Server Switch' => array('mor-s'),
                           'default' => FALSE,
                           'WiFi Access Point' => array('mor-w'),
                   ),
                   'm4_defines' => array
                   (
                           'VTP_MODE' => 'client',
                           'CHECK_VTP' => 'true',
                           'VTP_DOMAIN' => 'yandex-mor',
                           'VTP_VERSION' => '3',
                           'VTP_PASSWORD' => '[jkjlmor',
                           'LOCATION' => 'MOR',
                           'FACILITY' => '',
                   ),
           ),
   ```
   Где 652 - номер тэга гео-локации, 2819 - id управляющей сети.
6. Выполнить
```bash
git commit pns-resources-office.php
# если есть права на коммит в мастер
git push
# если нет прав на коммит в мастер
git push -u origin my_branch
```
Последняя команда создаст merge request. Нужно открыть его в браузере и дождаться подтверждения от NOCDEV.  Если вы пошли по пути коммита в мастар, то нужно сделать nocrfcs и самостоятельно задеплоить на активном сервере noc:  `(cd ~racktables/rt-yandex.git/; sudo -u racktables git pull; cd /usr/local/rt-yandex.git/; sudo -u racktables git pull)`
7. Результатом всех этих действий должно стать появление новой локации внутри RT: ![https://racktables.yandex.net/index.php?page=switchgen&tab=manage](https://racktables.yandex.net/index.php?page=switchgen&tab=manage)
   
   Замечание: При заведении свича в удаленном офисе силами инженера NOC нужно выбирать пункты
   - **куда:** новая локация, только что созданная локация
   - **исполнитель:** без тикета
   - **для чего:** свич или ТД
### Настройка свитченаливайки

1. Установить и запустить консольный сервер: 
   ```sh
   pkg install -y yandex-conserver
   make -C /usr/local/router/conffiles install-conserver-conf
   /usr/local/etc/rc.d/conserver start
   ```
2. Описать наличествующие консольные порты в вкладке Ports рыбки, поставить тег "сервер консольного доступа"
3. Добавить USB порты в /usr/local/etc/conserver.cf иначе наливка через USB работать не будет.  
   ```bash
   console "cuauUSB0" { device /dev/cuaU0; }
   console "cuauUSB1" { device /dev/cuaU1; }
   ```
4. Создать в VTP-домене vlan 653, переключить один из портов на коммутаторе в этот влан, пометить этот порт комментарием "Наливка" в RT. Порт настроить следующим образом: 
   ```
   switchport access vlan 653
    switchport mode access
    no cdp enable
    no vtp
    no lldp transmit
    no lldp receive
    spanning-tree portfast
   ```
    Отключение VTP на порту важно - иначе наливка свитчей будет отбиваться с ошибкой валидации. Без CDP на консоли наливаемого свитча будет меньше шума.Интерфейс vlan653 автоматически создается с нужной конфигурации REPS'ом на той рыбке, на которой повешена IPv4 сеть vlan400 или vlan600.
5. Наливать через штатный интерфейс RT
## Подъем MobCert

На одной из Access Point в офисе нужно поднять SSID MobCert, чтобы пользователи могли накатывать на свои мобильные устройства сертификаты для доступа в SSID PDAS. Заготовка для данной сети есть на каждой AP.
1. Убедиться, что для vlan429 выделена сеть
2. Выбрать AP, отметить её в RT тегом "ssid MobCert"
3. Выкатить на AP ((/diy/wifi/mobcertpass/ актуальный пароль сети): 
   ```
   conf t
   dot11 ssid MobCert
   wpa-psk ascii 0 <пароль>
   ```
   , включить 
   ssid MobCert
    на интерфейсах Do0 и Do1: 
   ```
   int Do0
   ssid MobCert
   int do1
   ssid MobCert
   end
   wr
   ```
При наличии тега в RT пароль на ТД будет обновляться автоматически.
## Настройка активного сетевого оборудования


При подготовке/запуске новой локации (или L2-сегмента сети) необходимо фиксировать stp root/backup на d-свитчах (или на других свитчах, выполняющих роль дистрибьюции/агрегации). Это необходимо для более предсказуемой развертки stp-дерева.

При наливке через ПНС софт на коммутаторах и ТД обновляется до актуального автоматически.Актуальные версии софта описаны [тут](https://noc-gitlab.yandex-team.ru/nocdev/racktables/blob/master/switchconf/CiscoSerial.rb#L111).Все образы ПО лежат на серверах noc-myt/noc-ugr в 
/tftpboot
 и доступны по tftp,ftp и http(s). В случае использования http в виде транспорта, URL: `http://93.158.158.93/tftpboot/<тарбол>`.

Команда для обновления ПО: `archive download-sw /imageonly <URL к тарболу>`. После установки ПО коммутатор лучше перезагружать по питанию, а не командой 
reload
(ключем 
/reload
 команды 
archive
)

Если возникает ошибка при попытка зайти на вкладку Live VLANS "ERR: password not found", то это означает, что вместо FQDN указан ip адрес.
## VPN-концентратор whaler

VPN-концентратор whaler предназначен для собирания туннелей без использования адресов Яндекса. Такие туннели необходимы для случаев, когда один или несколько провайдеров в региональном офисе имеет с нами пиринг. В случае аварии на нашем с ним стыке или аварии на магистральном канале Москва-регион, туннели, построенные на адресах Яндекса сломаются, пока у этого провайдера не сойдется BGP (см NOC-7390).Правила сборки туннелей до whaler следующие:
- туннель собирается от каждого внешнего IP-адреса рыбки до различных адресов whaler (195.156.199.197 для первого ISP офиса, 195.156.199.198 для второго)
- при появлении третьего ISP в каком-то офисе на whaler нужно будет навесить ещё один адрес (вероятно, .199) и собрать туннель от этого ISP на него.
- все туннели собираются с prepend=9Адреса предоставлены TeliaSonera.Информация о сервисе:
  ```
  Delivered services
  1. Subscription: Sonera Yritysinternet Plus IN25577 New
   Delivery address: HyvinkДДntie 185 04680 HIRVIHAARA
   Maintenance level: Package A 24h
   Speed: 1 Gbit/s
   IP Address: 195.156.199.206/28
   Delivery date: 27 March 2015
  ```
  Контакты: tel. +35820690801, Email yritystap@sonera.com (on duty 24 h,mpm/pvm)).
## Strongswan

Для IPSEC-туннелей в качестве IKE демона используется [StrongSwan](https://www.strongswan.org/). Конфигурируется из шаблонов в `/usr/local/router/strongswan` привычным образом. Логи пишутся в файл 
/var/log/charon.log
## Сертификаты

Для успешной работы vpn-сервисов и авторизации dot1x на региональном офисном рутере должны быть установлены валидные сертификаты, укомплектованные приватными ключами.Типичный офисный рутер содержит две сущности, для которых нужны сертификаты: это IPSEC-туннель до vpn-концентратора и модуль авторизации радиуса через 802.1X. Сертификаты представляют собой файлы формата x509 с раздельно хранимым не шифрованным приватным ключом.На машинах сертификаты расположены в следующих местах:

Для IPSEC (strongswan):
```
сертификат: /usr/local/etc/ipsec.d/certs
ключ: /usr/local/etc/ipsec.d/private
```
в данном случае сертификат назван по имени машины, с расширение .crt, например sudak.crt, ключ же всегда имеет название private.key.

Для radius 802.1X:
```
сертификат и ключ :/usr/local/etc/raddb/certs/
```
в данном случае сертификат назван по имени машины, с расширение .pem, например sudak.pem. Ключ тоже назван по имени машины и имеет расширение .key, например sudak.key. Кроме того для radius-а необходимо создать симлинки radius.cert и radius.key, указывающие на сертификат и ключ соответственно.
## Просмотр сертификата и сравнение его с ключом

Если возникает необходимость просмотреть сертификат в читаемом виде, то это можно сделать командой:
```
openssl x509 -text -noout -in certname.pem
```
Просмотр ключа:
```
openssl rsa -text -noout -in keyname.key
```
Чтобы убедиться, что ключ соответствует данному сертификату нужно сравнить секции modulus в выводе.
## Получение и установка сертификатов

Для Strongswan и RADIUSd требуется получить 2 разных сертификата. Приватные ключи и запросы на оба изготавливаются автоматически при помощи Makefile'ов в каталогах`/usr/local/router/strongswan` и `/usr/local/etc/raddb` соответственно
### Полная процедура

1. Сгенерить приватный ключ`make generate-private-key`
2. Сгенерить запрос на сертификат`make generate-csr`На выходе сформируется запрос на сертификат, который будет показан в консоли, а также, в случае с сертификатом для RADIUS, скопирован в файл 
   /usr/local/etc/raddb/certs/`hostname -s`.csr
3. Подписать сертификатОткрываем [Сертификатор](https://crt.yandex-team.ru/api/certificate/?type=client-server&ca_name=InternalCA)В форме внизу страницы выбираем 
   type=client-server
   , 
   Ca name=InternalCA
   , поле 
   Desired ttl days
    оставляем пустым, в 
   Request
    вставить содержимое файла запроса сертификата.В ответ форма должна отдать структуру данных, начинающуюся с 
   HTTP 201 Created
   . Сертификат в BASE64 лежит по ссылке "download2" вместе с цепочкой - в файлы на машинах копируется только сертификат, без цепочки.
   
   {% cut "Муки с занзибаром, если кто любит по-острее." %}
   
   Отправить запрос на сертификат на zanzibar, для выписывания сертификата нашим Certificate Authority (CA): Открыть в браузере ссылку: ![https://zanzibar-caint.ld.yandex.ru/certsrv](https://zanzibar-caint.ld.yandex.ru/certsrv)В поле формы "Base-64-encoded certificate request (CMC or PKCS #10 orPKCS #7):" вставить содержимое файла запроса сертификата. Выставить переключатель "Client-server template" в положение "Client-server computer with aproval" для Strongswan и "Web-сервер (с подтверждением)" для RADIUSd и openvpn. В итоге Zanzibar вернет номер запроса, с этим запросом нужно обратиться на 
   
    объяснив цель использования сертификата (после отправки письма можно позвонить по 2900). Затем снова перейти по ссылке ![https://zanzibar-caint.ld.yandex.ru/certsrv](https://zanzibar-caint.ld.yandex.ru/certsrv) (обновление страницы приведет к формированию еще одного запроса, что нам не нужно) и выбрать "View the status of a pending certificate request", забрать сертификат в base64 формате. Это и будет новый файл сертификата в формате x509.
   
   {% endcut %}
4. Установить скаченные сертификаты
   ```sh
   /usr/local/etc/ipsec.d/certs/<fishname>.crt  #для strongswan
   /usr/local/etc/raddb/certs/<fishname>.crt  #для RADIUSd
   /usr/local/etc/openvpn/certs/<fishname>.crt #для OpenVPN (неприменимо для наливки обычной рыбки)
   ```
5. Заменить файл сертификата на машине, рестартовать изменный сервис :
   ```sh
   make -C /usr/local/router/strongswan restart #для strongswan
   make -C /usr/local/etc/raddb restart #для RADIUSd
   make -C /usr/local/etc/openvpn restart #для OpenVPN
   ```
   Рестарт strongswan и openvpn нужно производить исключительно в ночное время между 2 и 6 часами ночи по местному для сервера времени, когда количество пользователей минимально. Проверяйте себя при помощи ![https://time.yandex.ru](https://time.yandex.ru)
6. Убедиться, что владелец файла с сертификатом для RADIUSd - пользователь freeradius (chown):
```
sudo chown freeradius:freeradius /usr/local/etc/raddb/certs/<имя рыбки>.crt
```
### Обновление сертификата

Т.к. все используемые сертификаты получаются через Сертификатор, это позволяет значительно упростить процедуру обновления сертификатов - Сертификатор хранит CSR всех запросов, что делает возможным воспользоваться специальной ручкой для обновления сертификата в его API. Вокруг API написан скрипт, который автоматизирует получение сертификата, на момент написания этого раздела скрипт лежит в `/usr/local/etc/raddb/certs/` и называется 
update_cert.py
 (TODO: вынести в отдельный пакет и устанавливать в 
/usr/local/bin
):
```
[14:01:32 MSK+0300]root@muksun.yndx.net:
/usr/local/etc/raddb/certs>./update_cert.py --help
usage: update_cert.py [-h] [--force] [--out FILENAME]
                      crt_filename key_filename

Renew existing client-server certificate using it as an authentication factor.
Works only for certs that were signed with CRT as it reuses the same CSR.

positional arguments:
  crt_filename    /path/to/certificate/file
  key_filename    /path/to/key/file

optional arguments:
  -h, --help      show this help message and exit
  --force         By default if a certificate expirates in more than 120 days,
                  renewal is rejected. This option forces renewal.
  --out FILENAME  Filename to store new cert into. By default certificate
                  serial number is being used with '.crt' added at the end
```
Для обновления сертификата скрипту надо передать опциями пути до файлов сертификата и соответствующего ему приватного ключа. На выходе, если всё прошло хорошо, будет создан файл с именем вида 

.crt
 (например: 
34365C35000200099C1F.crt
)).Далее переходим к 5 пункту [процедуры](!/#polnajaprocedura).
## RADIUS

У нас используется FreeRadius. Все его настройки лежат в /usr/local/etc/raddb, на всех рыбках эта директория уже добавлена в GIT, поэтому, чтобы обновить версию конфигов до актуальной или закоммитить изменения - все команды надо выполнять прямо в этой директории, например: `make -C /usr/local/etc/raddb update`. Радиус работает под управлением daemontools. Это означает, что он не стартует и не останавливается скриптами из /usr/local/etc/rc.d.Для перезапуска RADIUS нужно пользоваться`make -C /usr/local/etc/raddb restart`Все остальные действия над процессами, работающими под управлением daemontools [можно посмотреть тут](https://wiki.yandex-team.ru/borislytochkin/daemontools).{red}(В нормальной ситуации администраторам не требуется никакого вмешательства в работу RADIUS, особенно его остановки или запуска вручную. Все подобные ситуации - аварийные и причину их возникновения нужно чинить, не ограничиваясь восстановлением сервиса. Обо всех таких ситуациях нужно сообщить 

 + 
)

Логи демона лежат в /var/log/radius.log, есть более подробная информация  в /var/log/radacct/
### Взаимодействие с внешними источниками данных

На офисных vpn-концентраторах поднят any-cast адрес 93.158.158.98 (dynfwcollector.yandex.net). При помощи rsync-а (по крону) рыбки синхронизируют директории /var/spool/norfolk/ и /var/db/radius. В первой находятся файлы с файрвольными дырками пользователей для разных типов доступа. Во второй находятся файлы с разрешениями для подключения к разным типам сетей: 802.1 (провод), WiFi, VPN, также там находится файлы для Mac-based access.
## Динамический фаервол

Проверить наличие директорий, файлов, владельцев freeradius и прав:
```
/var/spool/norfolk/
/var/db/dynamic-rules/local
/var/log/dynamicfw.log
```
Подробнее читаем тут:![https://wiki.yandex-team.ru/noc/office/firshopfw/](https://wiki.yandex-team.ru/noc/office/firshopfw/)
# Возможные проблемы и методы их устранения

Часть из проблем можно найти, читая рассылку [root-noc](https://ml.yandex-team.ru/lists/root-noc/)Наиболее часто возникающая проблема - необходимость снять трафик с одного из операторов из-за проблем с каналом. Сделать это можно двумя способами:
1. Воспользоваться переменной Makefile BROKEN_ISP_IFACE при генерации конфига bird:
```sh
# обновляем шаблоны конфигурации
make -C /usr/local/router update
# внимательно просмотреть diff и убедиться, что все изменения являются ожидаемыми
make -C /usr/local/router/conffiles/bird all bird-diff BROKEN_ISP_IFACE=vlan814
# убрать весь трафик с vlan814 (как IPSEC-туннели, так и доступ во внешний Интернет)
make -C /usr/local/router/conffiles/bird all install loadrun BROKEN_ISP_IFACE=vlan814
# вернуть "как было"
make -C /usr/local/router/conffiles/bird all bird-diff
make -C /usr/local/router/conffiles/bird all install loadrun
```
Переменная переопределяет приоритеты маршрутов, убирая их в глубокий резерв. Т.е. в случае поломки оставшегося канала трафик всё же сможет пройти по больному плечу.]}
2. Потушить BGP-сессии со стороны VPN-концентраторов.
## Другие проблемы

| **Проблема** | **Возможная причина** | **Действия** |
| - | - | - |
| Не работает динамика. Правила не создаются в /var/db/dynamic-rules даже локально | 2. Нет данных accounting-а от dhcprelya. Неверная настройка dhcprelya | Скорее всего дело в dhcprelaya.servers указан не тот ip |
| Не работает динамика. Правила создаются в /var/db/dynamic-rules на удаленных рутерах и балансерах, но трафик все равно не ходит | Сети источники не попадают в макросы диверта | Пропишите сети-источники в соответствующем макросе |
| Не работает разрешение имен. | Не запущен unbound | Запустить и исправить причину остановки |
| Не проходит аутентификация 8021X на коммутаторе, при этом коммутатор не отправляет ничего в RADIUS, в tcpdump клиента не видно EAPOL START | Нет vlan 999 | Создать vlan 999 на VTP primary server |
| На рыбке не пингуется внутренний адрес с ошибкой
```
ping: sendto: Permission denied
ping: sendto: Permission denied
``` | Не работает IPSEC для этого туннеля | Починить IPSEC |
| Не работает IPSEC-туннель, не пингуется внутренний адрес | Некорректный маршрут до верхнего адреса туннеля. | Проверить, что статический маршрут сгенерировался в 
/etc/rc.conf
 или прилетел по BGP. См [условия генерации](!/#zapusktunnelja). |
| Не работает IPSEC-туннель, не пингуется внутренний адрес | Если менялись адреса туннелей, то может мешать файрвол | `cd /usr/local/router/fw; make update restart` |
| Не работает IPSEC-туннель, не пингуется внутренний адрес | Со стороны концентратора маршрут идет через интерфейс с включенным jumbo-frames. | Проверить, что статический маршрут сгенерировался в 
/etc/rc.conf
. |
| Не работает IPSEC-туннель, не пингуется внутренний адрес | Провайдер портит IPSEC-трафик (например, пересобирает пакеты, дропает фрагменты) | Найти в tcpdump признаки неполного (или измененного) прохождения пакетов от рыбки до VPN-концентратора. Если IPSEC-сессия не собрана, то пакеты ловить фильтром 
host <адрес рыбки> and host <адрес концентратора> and udp
. При нахождении проблемы на уровне пакетов - отправить провайдеру жалобу на неработающий канал Интернета. |
| Не работает IPSEC-туннель, не пингуется внутренний адрес | Что-то ещё | Читать логи 
/var/log/charon.log
. Если по логам причина не становится понятной - эскалировать. |
| Не поднимаются bgp сессии | 2. Мешает файрвол | `cd /usr/local/router/fw; make update; make restart` |
| Не поднимаются bgp сессии | 3. Благодаря bgp маршрут на пир идет через другой интерфейс, а не через connected | Для v6 снять адрес с интерфейса (ifconfig ipsecXX inet6 v6_адрес -alias, удалить маршрут из ядра route del -inet6, повесить адрес обратно |
| Не поднимаются bgp сессии | 4. Не сконфигурирован bgp | `cd /usr/local/router/conffiles/bird; make update; make clean ; make all bird-diff; bird-check install loadrun` |
| Не поднимаются bgp сессии | 5. С одной из сторон пир административно опущен | Попробовать выяснить, кто и для чего опустил пир. Поднять пир с нужной стороны, если очевидно, что его нужно поднять. |
| Не выдаются адреса по dhcp | 1. на транках не выставлен ip dhcp snooping trust | Выставить ip dhcp snooping trust |
| Не выдаются адреса по dhcp | 2. Копирование db для snooping-а иногда мешает получить адрес быстро | Убрать строку `ip dhcp snooping database http:// ....` Разобраться, почему копирование не работает, после чего конфигурационную строку вернуть |
| При попытки сделать обновление в /usr/local/router/bgp выдается сообщение: unknown hostname "rinko" (make update?)*** Error code 1 | Нет нужной информации в cvs-backup.php | см. <!/#nastrojjkasostoronyjadra> |
| Не стартует файрвол | Характеризуется наличием маленького всеблокирующего файрвола после перезагрузки и полным непрохождением пакетов | Подгрузить модуль ipfw_nat `kldload ipfw_nat` |

# Тестирование пропускной способности канала

Проверка пропускной способности канала осуществляется между рыбкой и концентратором, с которым построен IPsec туннель, на внутренних адресах туннеля с помощью iperf.

`address` - внутренний адрес IPsec туннеля на концентраторе.

На концентраторе запускается **iperf сервер**: 
TCP
```
iperf -se -B `<address>`
```

UDP
```
iperf -sue -B `<address>`
```

На рыбке запускается **iperf клиент**:

TCP
```
iperf -c `<address>` -re -P 6 -t 30 -i 10
-r - поочередный двунапраавленный тест. Сначала трафик идет клиент<->сервер, потом сервер<->клиент.
-P - количество TCP потоков. На канале более 500Mbps 6 потоков давали наибольшую суммарную скорость.
```

UDP
```
iperf -c `<address>` -rue -b 500m -t 30 -i 10
-b - целевая пропускная способность
```

После завершения теста в одну сторону будет финальный SUM. Тест двунаправленный, так что SUM будет два: первый - UL, второй - DL.
