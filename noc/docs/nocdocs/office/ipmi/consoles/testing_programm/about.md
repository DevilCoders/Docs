## План и инструкция по тестированию консольного коммутатора MOXA

 Рассмотрим процедуру тестирования оборудования MOXA. 

 Тестирование необходимо проводить в случаях:
 - изменения hardware
 - изменения software

 Процедуры для обоих случаях одинаковы, за исключением подписания протокола для MOXA.

 ### Подготовка к тестированию

 Что необходимо для проведения тестирования:
 - Флеш-карта с софтом
 - Устройство MOXA
 - Любой коммутатор с консольным портом
 - Два медных патч-корда
 - Переходник RJ45 - USB
 
 Если что-то пойдет не так, то дополнительно:
 - отвертка
 - переходник UART - USB
 - 4 проводка типа "мама-мама"

 ### Подготовка флеш-карты

 Предварительно необходимо прошить карту. 

 Налитую флешку необходимо дополнительно подготовить:
 - вставляем флешку в ноут или еще куда-то. Для этих целей отлично подходит zomb-устройство в офисе
 - монтируем флешку
 - помещаем свой `id_rsa.pub` в `home/racktables/.ssh/authorized_keys` на флешку
 - копируем или запоминаем настройки сети `lan1` из `etc/config/network`
 - правим `etc/firewall.user`, удаляя лишнее, заменяя `DROP` на `ACCEPT`

 ### Тестирование

 - Вставляем в MOXA флеш-карту
 - Подключаем `lan1` к ноутбуку
 - Включаем MOXA
 - MOXA загрузилась
 - Устанавливаем на ноуте ip-адрес из подсети, которую показывает MOXA. Обычно, `192.168.127.100/24`
 - Открываем броузер, переходим по `192.168.127.254`
 - Login: admin, Password: moxa
 - Скачиваем прошивку: [Borian Firmware](https://wiki.yandex-team.ru/noc/consoleserver/.files/np6610-170310-fx01-2021.np6k)
 - В web ui переходим в раздел обновления ПО и подгружаем прошивку
 - MOXA перезагрузилась
 - **Внимание** на этом этапе что-то может пойти не так и MOXA будет просто включена с зеленым экраном:
   - Стоит выключить MOXA, зажать и держать кнопку **MENU** на панели, включить MOXA.
   - Возможно это из-за проблем с флешкой и ее надо переналить. 
- Должна пойти процедура загрузки и в конце вы должы увидеть hostname и адрес MOXA.
- Поменяйте адрес на ноутбуке
- Зайдите на консоль со своим `id_rsa` (`ssh -i ~/.ssh/id_rsa racktables@1.1.1.1`)
- Проверьте версию прошивки
- Проверьте работоспособность консольных портов `console -n -p10101 -M 127.0.0.1 ttyS{1..32}`
- Добавьте информацию в тикет

Проверьте работоспособность sudo

sudo работает

sudo не работает

### Если MOXA окирпичилась

- Не стоит переживать
- Открутите крышку
- Подключитесь к UART 
- Включите MOXA и начинайте дебажить

### Примеры проведенного тестирования

Можно посмотреть записи о проведенном тестировании тут:
- [NOC-20082](https://st.yandex-team.ru/NOC-20082)
