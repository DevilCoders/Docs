# Процедура наливки MOXA

## Наливка флешки для MOXA

В настоящий момент самый надежный способ обновления софта на MOXA - это перепрошивка флеш-карты. 

{% note warning %}

Учтите, что на microSD с высокой скоростью записи/чтения (например Transcend microSD 500S), консоляторы не запускаются, даже при успешной наливке карты.

{% endnote %}

Обновление софта состоит из двух этапов.

### Этап 1. Подготовительный

Этот этап применется только для новых MOXA "из коробки". Процедура следующая:
1. Установить NM-TX02 в слот
2. Подключить прямой шнурок в основной сетевой порт и в ноут
3. Настроить на ноутбуке адрес из сети 192.168.127.0/24
4. Подать питание, дождаться загрузки
5. С помощью кнопок и экрана узнать адрес, полученный прибором (обычно 192.168.127.254)
6. Зайти на Web-интерфейс прибора (логин/пароль: admin/без пароля(на новых может быть пароль moxa))
7. Выбрать пункт обновления прошивку и загрузить в прибор:
  - Если MOXA была куплена до 2021, то [прошивка такая](https://wiki.yandex-team.ru/noc/consoleserver/.files/np6610-170310-fx01.np6k)
  - Если MOXA была куплена после 2021 года, то [прошивка такая](https://wiki.yandex-team.ru/noc/consoleserver/.files/np6610-170310-fx01-2021.np6k). [NOCDEV-4371](https://st.yandex-team.ru/NOCDEV-4371)
8. Прибор перезагрузится, зажжёт экран и начнёт мигать светодиодом "Ready". С этого момента N-Port содержит в себе Linux, а не проприетарную прошивку самой Moxa.
9. Установите MOXA в стойку, если еще нет

{% note %}

На консоляторах после 2021 года не работает onboard com порт, точнее он работает не верно, подробности все в том же таске, так что дебажить можно только через ssh. Данную проблему сочли не критичной для закупки.

{% endnote %}

### Этап 2. Прошивка флеш-карты

Процедура прошивки флеш-карты следующая:
1. Скачать образ с Linux для VirtualBox, образ есть на [Miracle](smb:miracle/Projects/DC-ENG.Res/soft/Nport/НаливкаКонсоляторов.zip) есть копия на [Ydisk](https:yadi.sk/d/QFCf819VhwIiyQ).
2. Устанавливаем дополнительный набор VirtualBox Extension Pack для проброса флешки в виртуальную машину(если не установлено).
3. Запускаем Linux (пользователь: `justauser` пароль: `justauser`)
4. Пробрасываем флешку в виртуальную машину
5. Переходим в директорию `cd git/nport/`
6. Флешку нужно отформатировать в системе FAT32
   ```
   sudo umount /dev/sdc1
   sudo mkfs -t vfat -n FLASH /dev/sdc -I
   ```
   - /dev/sdc1 - имя флешки в файловой системе
   - vfat - файловая система 
   - FLASH - имя устраойства, можно указать любое 
   - /dev/sdc - путь к устройству
7. Запросить настройки lan1 и lan2 у NOC
8. Под sudo запустить скрипт nport-nalivka, выбрать доступное устройство с флэшкой. Указать только fqdn, скрипт сам найдет нужные параметры в RT
```
sudo ./nport-nalivka -d /dev/sdc -h consoles-sas1-1
```
9. Если возникли проблемы с выполнением скрипта, то скрипту НУЖНО передать все параметры через command-line ( --lan1 ip:mask:gw)(скрипту нужно передать 2 ip, если у вас только 1 ip, то второй можно указать типа 192.168.1.0:24:192.168.1.255)
```
sudo ./nport-nalivka -d /dev/sdc -h consoles-sas1-1 -1 37.140.144.1:22:37.140.147.254 -2 37.140.165.1:26:37.140.165.62
```
10. По завершению выполенения скрипта (сообщение на консоли: "Everything is done. Remove SDHC card"), вынуть карту, обклеить мелким шрифтом, оставив от названия только часть имени, специфичную для ДЦ и порядкового номера прибора, например, sas1-4 ". Если карта представляет собой micro(mini)SD с переходником, то наклейка с именем должна быть наклеена так, чтобы предотвратить случайное выпадение карты из адаптера (т.е., фактически, "запломбировать" карту в адаптере наклейкой с именем).

### Порт-кнокинг

Для софта >= 2022: 40, 666

Для софта до 2022: 13, 238
