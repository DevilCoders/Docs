# 9. Примеры прохождения трафика#

Рассмотрим наиболее распространенные сценарии передачи трафика:
1. Между двумя серверами в одном ДЦ внутри одного модуля.
2. Между двумя серверами в одном ДЦ в разных модулях.
3. Между двумя серверами, расположенными в разных ДЦ.
4. IPv4 запрос от пользователя до сервера.
5. IPv6 запрос от пользователя до сервера.

## Сценарий 1. Передача трафика внутри модуля

![](./images/samples_dataflow/Packetwalk1.svg)

1. Отправитель (сервер в стойке "Server Rack 1") передает трафик на шлюз по умолчанию (в направлении стоечного коммутатора) в одном из VLAN-ов (FB или BB);
2. Стоечный коммутатор определяет VLAN отправителя, выполняет L3-lookup по таблице VRF _Hbf_ и находит маршруты к получателю, анонсированный другим стоечным коммутатором внутри этого модуля. При отправке пакета выбирается один из доступных ECMP-маршрутов и пакет передается в сторону Spine1;
3. Коммутатор Spine1, выполняет L3-lookup по таблице VRF _Hbf_ и передает трафик стоечному коммутатору, который агрегирует адресное пространство серверной стойки "Server Rack 2";
4. Стоечный коммутатор в зависимости от адреса получателя формирует Ethernet-заголовок с dot1q-тэгом и отправляет пакет в сторону искомого сервера.

## Сценарий 2. Передача трафика внутри ДЦ

![](./images/samples_dataflow/Packetwalk2.svg)

1. Отправитель (сервер в стойке "Server Rack 1") передает трафик на шлюз по умолчанию (в направлении стоечного коммутатора) в одном из VLAN-ов (FB или BB);
2. Стоечный коммутатор определяет VLAN отправителя, выполняет L3-lookup по таблице VRF _Hbf_ и находит маршруты к получателю, анонсированный другим стоечным коммутатором вне этого модуля. При отправке пакета выбирается один из доступных ECMP-маршрутов и пакет передается в сторону Spine1;
3. Коммутатор Spine1 выполняет L3-lookup по таблице VRF _Hbf_ и находит агрегированный маршрут к получателю, анонсированный маршрутизатором Spine1 другого модуля, для которого указано, что требуется выполнить операцию по добавлению двух MPLS-меток: сервисной, сигнализированной по протоколу BGP и транспортной, сигнализированной по протоколу LDP. При отправке пакета, выбирается один из доступных линков в сторону Spine2;
4. Коммутатор Spine2, при получении пакета производит lookup по MPLS-метке, выбирает один из множества равноценных исходящих интерфейсов, производит операцию по удалению вышестоящей транспортной метки и отправляет пакет с сервисной меткой в сторону коммутатора Spine1;
5. Коммутатор Spine1 по сервисной метке определяет VRF (в общем случае - единственный Vrf _Hbf_), производит L3-lookup и передает трафик стоечному коммутатору, который агрегирует адресное пространство серверной стойки "Server Rack 2";
6. Стоечный коммутатор в зависимости от адреса получателя формирует Ethernet-заголовок с dot1q-тэгом и отправляет пакет в сторону искомого сервера.

## Сценарий 3. Передача трафика между ДЦ

Последовательность передачи пакета в данном сценарии аналогична предыдущему _Сценарию 2_, за исключением нескольких деталей:
* Маршруты к получателю будут анонсированы коммутатором в другом ДЦ через BGP RR;
* На шаге 4 коммутатор Spine2 после lookup-а по mpls-метке отправит пакет в сторону граничных Edge устройств и далее в магистральную сеть;
* LSP будет в общем случае будет включать больше двух хопов.

## Сценарий 4. Передача IPv4-трафика из Интернета к сервису

В силу того, что фабрика внутри ДЦ только IPv6,  для передачи IPv4-трафика до сервиса, IPv4-трафик потребуется туннелировать от балансировщика до хоста и от хоста до декапсулятора, как это было описано в разделе “Сервисная модель”.

![](./images/samples_dataflow/Packetwalk3.svg)
  1. IPv4-запрос из Интернета к VIP сервиса попадает на граничный маршрутизатор (Border) и маршрутизируется в один из ДЦ через магистральную сеть с MPLS-инкапсуляцией;
  2. Коммутатор уровня Spine1 принимает такой запрос, снимает MPLS-метки, ищет наилучший маршрут в таблице GRT и отправляет чистый IPv4-пакет сервисному коммутатору;
  3. Балансировщик _Lb_ выбирает один из доступных real-серверов и передает инкапсулированный IPv4-over-IPv6 пакет сервисному (А) коммутатору через интерфейс в VRF _Hbf_.
  4. Далее трафик маршрутизируется по IPv6-заголовку через фабрику ДЦ;
![](./images/samples_dataflow/Packetwalk4.svg)
  5. Real-server получив и обработав входящий запрос отправляет ответ через туннельный интерфейс до anycast-адреса декапсуляторов трафика;
  6. Декапсулятор, на который был смаршрутизирован трафик от real-сервера снимает с пакета внешний IPv6-заголовок и передает его по маршруту по умолчанию на GRT-интерфейс сервисного коммутатора, который передает его через магистральную сеть Яндекса в Интернет.

## Сценарий 5. Передача IPv6-трафика из Интернета к сервису

Последовательность передачи пакета в данном сценарии аналогична предыдущему _Сценарию 4_, за исключением нескольких деталей:
* При передаче пакета через магистральную IPv4-only сеть используется технология 6PE;
* Балансировщик _Lb_ будет использовать IPv6-over-IPv6 инкапсуляцию.
