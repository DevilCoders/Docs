# Граница сетей Яндекса и Яндекс.Облака

**Статус**: draft

## Введение
В данном документе описан высокоуровневый дизайн границы взаимодействия сетей Яндекса и Яндекс.Облака с указанием физической и логической топологии, а так же применяемых сетевых протоколов для обмена маршрутной иформации.

## Терминология
**BGP** - border gateway protocol, протокол маршрутизации, используемый на границе сетей Яндекса и Облака.

**CE** - cloud edge, маршрутизатор на границе сети Облака, выполняющий роль P/PE;

**Cloud** - выделенный vrf в сети Облака, где живет инфраструктура;

**CPB** - cloud P and border, маршрутизатор на границе сети Яндекса, выполняющий роль P/PE.

**DCI** - datacenter interconnect, меж-ДЦ сеть: у Яндекса она построена на MPLS, у Облака она в процессе строительства;

**GRT** - global routing table, глобальная таблица маршрутизации;

**Hbf** - host based firewall, выделенный vrf в сети Яндекса, где живет инфраструктура;

**LU** - labelled unicast, адресное подсемейство протокола BGP, где маршруты семейств IPv4/IPv6 передаются с метками MPLS;

**MPLS** - multiprotocol label switching, протокол коммутации по меткам;

**Overlay** - сегмент виртуализации сети в Облаке;

**P** - устройство в MPLS сети, коммутирующие трафик по меткам;

**PE** - provider edge, устройство в MPLS сети, терминирующее на себе vrf'ы;

**SLB** - service load balancer, балансировщик нагрузки в сети Яндекса;

**Underlay** - сегмент сети Облака, где живут сервера виртуализации и другая инфраструктура Облака;

**vrf** - virtual route forwarding, вирутальный сегмент сети.

## Топология границы
Граница между сетями Яндекса и Облака физически проходит в датацентрах Сасово, Владимир и Мытищи.
С обоих сторон интерконнект организован на базе устройств Juniper PTX10002-60C, внешний вид которых представлен на картинке ниже:

![Juniper PTX10002-60C](./images/yacloud_border/Juniper_PTX10002-60C.png)

Со стороны Яндекса маршрутизаторы именованы как **\<dc-code\>-cpb-\<num\>**, где аббревиатура **cpb** обозначает роли cloud P and border и выполняют роль P/PE, а так же пиринга:
- **b** - роль border, где проходит граница внешнего пиринга и связность в vrf'ах: Cloud и Hbf;
- **cp** - роль cloud P, где проходит связность IPv4/LU, для организации DCI Облака через MPLS ядро Яндекса.

Со стороны Облака маршрутизаторы именованы как **\<dc-code\>-\<num\>ce\<num\>**, где аббревиатура **ce** обозначает роль cloud edge, и выполняют аналогичные роли со стороны Облака.

Ниже представлена схема типового подключения устройств на границе в одном датацентре:

![Cloud DCI L1](./images/yacloud_border/Cloud_DCI_L1.png)

## Логика взаимодействия

Схема взаимодействия сетей Яндекса и Облака разбита на 4 логических сегмента:

- **LU** - предназначен для обеспечения меж-ДЦ связности Облака, через MPLS ядро Яндекса, ввиду отсутствия у Облака собственного DCI. В будущем, когда у Облака появится свой DCI, данный сегмент останется в работе как резервный;
- **Hbf** - предназначен для обеспечения связности инфраструктуры Облака с хостами Яндекса в vf Hbf;
- **Cloud** - предназначен для обеспечения связности инфраструктуры Облака vrf Cloud с сервисами Яндекса в GRT через FW или напрямую в [SLB](https://st.yandex-team.ru/NOCREQUESTS-22314);
- **Peers, Peers-v6** предназначен для обеспечения связности Облака с сервисами Яндекса, аналогично внешним клиентам Яндекса.

Более подробно с картой хождения трафика Облака между сегментами ожно ознакомиться [тут](https://wiki.yandex-team.ru/cloud/devel/NetInfra/traffic-map/#izoblakavjandeks).

Ниже представлена схема логического взаимодействия на границе сетей Облака и Яндекса по BGP:

![Cloud DCI L3 BGP](./images/yacloud_border/Cloud_DCI_L3_BGP.png)

## Взаимодействие в vrf Hbf
Для обеспечения связности инфраструктуры Облака с инфраструктурой Яндекса, живущей в vrf Hbf, на бордерах настроен vrf lite BGP пиринг с обменом маршрутами в рамках агрегатов Hbf и последующим анонсом VPNv6 маршрутов на рефлектора.

Помимо этого, бордер Яндекса пирится с PE устройствами в локальном ДЦ, от которых бордер получает дефолтный маршрут и реанонсирует его Облаку.

Часто в случае проведения регламентных работ в ДЦ с закрытием маршрутизации, данный пиринг между локальными бордерами и PE переводится на PE устройства другого ДЦ, для обеспечения непрерывности функционирования Облака.

Ниже представлена схема политик обмена маршрутами BGP в vrf Hbf между Яндексом и Облаком, на примере одного стыка в Сасово:

![Cloud DCI Hbf](./images/yacloud_border/Cloud_DCI-Option_A_vrf_Hbf.png)

## Взаимодействие в vrf Cloud
Для обеспечения связности инфраструктуры Облака, которая живет в vrf Cloud, с сервисами Яндекса, на бордерах настроен vrf lite BGP пиринг с обменом маршрутами в рамках агрегатов Cloud и последующим анонсом VPNv6 маршрутов на рефлектора.

Помимо этого, бордер Яндекса пирится с PE устройствами в локальном ДЦ, от которых бордер получает дефолтный маршрут и реанонсирует его Облаку. При этом, на PE реализован ликинг маршрутов сервисных агрегатов в GRT, для оптимальной маршрутизации трафика в обход Firewall.

Часто, в случае проведения регламентных работ в ДЦ с закрытием маршрутизации, данный пиринг между локальными бордерами и PE переводится на PE устройства другого ДЦ, для обеспечения непрерывности функционирования Облака.

Ниже представлена схема политик обмена маршрутами BGP в vrf Cloud между Яндексом и Облаком, на примере одного стыка в Сасово:

![Cloud DCI Cloud](./images/yacloud_border/Cloud_DCI-Option_A_vrf_Cloud.png)

## Взаимодействие в LU
На текущий момент DCI Яндекса используется Облаком для организации взаимодействия между сетями в ДЦ Мытищи, Владимир и Сасово. Свой собственный DCI облака в процессе построениея. 

Для предоставления сервиса транспорта DCI на бордерах настроен BGP LU пиринг для обмена Облачными Underlay IPv4 маршрутами помеченными MPLS метками, которые обеспечивают возможность маршрутизации пакетов Облака поверх DCI Яндекса, построенном на базе MPLS. Между датацентрами бордеры обмениваются маршрутами с помощью специально выделенных под LU рефлекторов.

Ниже представлена схема политик обмена маршрутами BGP LU между Яндексом и Облаком, на примере одного стыка в Сасово:

![Cloud DCI LU](./images/yacloud_border/Cloud_DCI-GRT_LU.png)

## Внешний пиринг
Внешний пиринг Яндекса с Облаком принципиально ничем не отличается от всех остальных типовых пирингов Яндекса, за исключением того, что он, помимо внешних площадок, еще и настроен внутри каждого ДЦ, где живет Облако.

Такая схема позволяет "спрямить" хождение трафика по кратчайшему пути внутри ДЦ, и использовать более высокие скорости подключения на линках - 100 Gb/s в ДЦ, а на внешних площадках линки по 10 Gb/s.

Ниже представлены схема применяемых политик для обмена внешними маршрутами между Яндексом и Облаком, на примере одного стыка в Сасово:

![Cloud DCI PEERING](./images/yacloud_border/Cloud_DCI-GRT_PEERIG.png)
--------

Автор:
- [Артем Денисов](https://staff.yandex-team.ru/artemdenisov)
