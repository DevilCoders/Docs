# 7. Сервисная модель
Итак, пришла пора обсудить те детали, которые в большей степени связаны с серверной частью, однако дать их полное описание - не цель данного документа. Цель, лишь собрать главные тезисы и дать читателю навигацию по уже созданной ранее документации о сети Яндекса.
Затронем главные моменты:
## Выделение адресного пространства
Граница L2-связности ограничивается портом коммутатора.

На коммутатор выделяется одна IPv6-сеть /57 и одна /64, эта /57 разбивается на /64 для каждого физического хоста. Чтобы занять /64, хосту достаточно поднять в этом vlan link-local IP fe80::a:{0..7f}. Каждому такому IP соответствует одна из /64 внутри /57 (по порядку). Чтобы обеспечить уникальность этих IP в пределах стойки, рекомендуется выбирать их по имени порта свича согласно маппингу.

### Почему именно /57?

[Тикет ST](https://st.yandex-team.ru/RUNTIMECLOUD-1795)

На свичах с Trident2 было 32 40G порта, большую часть из которых сплитовалось в 4x10G, чтобы подключать сервера.
С учетом того, что коммутации могут делаться по разным схемам, сервер может быть включен в любой порт, что давало 4x32=128 вариантов. Это же, к сожалению, заставило нас использовать __все__ сети в выделенном на свич агрегате, включая нулевую.
Во имя единообразия свичи выделяется сеть размером в 128 /64 сетей - то есть, /57.
Идентификатор сети (он же часть link-local адреса) считается следующим образом:

----
Project_id - это другой способ организации адресного пространства, когда все проекты живут в общей IP-сети, а идентификатор проекта закодирован в младшей (хостовой) части IP-адреса

|          |            |            |            |
|:--------:|:----------:|:----------:|:----------:|
|  prefix  |  geo-часть | PROJECT_ID | host-часть |
|  40 бит  |  24 бита   | 32 бита    | 32 бита    |
----
- Хост получает информацию о сети по RA и выбирает для себя IP адрес со своим project_id
  - /64 спускаемый на хост в штатных ситуациях не меняется
- На хостах нет нативного IPv4
  - При необходимости IPv4 может спускаться на хосты через [туннели](https://wiki.yandex-team.ru/noc/ipv6/4in6/) или [NAT64](https://wiki.yandex-team.ru/users/ilysogor/nat64/)

## Про HBF
- Трафик между серверами Яндекса вместо выделенных серверов с firewall'ами обрабатывается прямо на хостах
- Для разделения трафика проектов, для каждого проекта на хост выделяется отдельный IPv6 адрес
  - в адресе зашиты географическое положение хоста (от ДЦ до стойки) и project_id (числовой идентификатор в 32 бита)
- Правила firewall'а задаются в racktables/puncher
  - Для новых ДЦ макросы, соответствующие project_id, вместо подсетей или набора адресов разворачиваются в маску на project_id часть IP адреса
  - Отдельный процесс на хостах регулярно обновляет правила

Еще про HBF, MTN и адресацию:
- [Более детально про Hbf](https://wiki.yandex-team.ru/noc/newnetwork/hbf/)
- [Устройство жизни во Владимире 1](https://clubs.at.yandex-team.ru/noc/1913)
- [Как мы выключали большой файрвол. Часть 1](https://clubs.at.yandex-team.ru/noc/2509)
- [Как мы выключали большой файрвол. Часть 2](https://clubs.at.yandex-team.ru/noc/2609)

## SLB и Decap-ы
Для того чтобы отказаться от маршрутизации IPv4-трафика внутри ДЦ, но при этом сохранить возможность предоставлять IPv4-сервисы, нам необходимо туннелировать IPv4-трафик до конечных хостов через IPv6-сеть ДЦ. Процесс инкапсуляция и декапсуляции трафика на конечном хосте не очень ресурсоёмок, но на балансировщике он может создать серьезную дополнительную нагрузку. Чтобы разгрузить SLB решено использовать отдельные декапсуляторы, на которые будет подаваться трафик “от серверов”, в то время как трафик “к серверам” будет, как и раньше, идти через балансировщик. Декапсуляторы работают в “stateless" режиме, что позволяет, используя anycast адрес, направлять трафик “от сервера” на любой из декапсуляторов.
- [Внутреннее устройство и диагностика проблем с балансерами](https://github.yandex-team.ru/ezhichek/public/blob/master/lb-intro.md)
- [Документация на L3mngr](https://doc.yandex-team.ru/l3-manager/guide)
- [Серия статей про балансеры](https://neverov.at.yandex-team.ru/1050)
- [Документация на декапы](https://wiki.yandex-team.ru/users/adess/newdecaps/)

## [CDN](https://wiki.yandex-team.ru/users/ilysogor/cdn-notes/)

## Подключение хостов

[NOCDOC-56](https://st.yandex-team.ru/NOCDOC-56)
