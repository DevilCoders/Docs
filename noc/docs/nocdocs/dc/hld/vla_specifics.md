# 10. Модификации дизайна, необходимые для запуска единой фабрики в ДЦ VLA

## Требования

- Единая фабрика между всем зданиями в ДЦ VLA. В перспективе это 4 здания по 5 модулей по 160 стоек и 800G/стойку
- Отсутствие переподписки между Leaf-коммутаторами

## Допущения
- Между обновлениями сети в ДЦ проходит более 5 лет, соответственно требуется поддержка в течение данного периода. Для VLA2 планируется по 8 аплинков на стойку (8-100G) и в перспективе 1-2 апгрейда скорости аплинков за время жизни ДЦ. В качестве вводных данных есть существующий VLA1 с 400G на стойку и модульными коммутаторами Spine1 с перспективой апгрейда до 800G.
- Максимальное количество Leaf-коммутаторов в единой фабрике # 3200. Максимальный размер фабрики определяет число уровней Spine, количество портов, СКС и кросс-коннект. Изменение дизайна СКС после запуска, практически невозможно, поэтому он должен быть разработан с учетом возможных будущих расширений и модернизации. С 2-мя уровнями Spine, плотностью портов в коммутаторах 32-100G/RU и плотностью дуплексных портов 64/RU на одну патч-панель, мы уже сильно ограничены в свободном пространстве (окончательная конфигурация фабрики - 8 стоек Spine2 + 6-8 стоек кросс-коннекта для каждого здания).
- Полное отсутствие VRF - все проекты находятся в VRF _HBF_, который может быть трансформирован в GRT внутри ДЦ. Это даст более широкий выбор оборудования разных вендоров из-за максимально упрощенных требований, в том числе возможность использования single-chip-коммутаторов. Так же, мы избегаем проблем с масштабируемостью ECMP которым подвержено большинство реализаций MPLS. Инкапсуляция пакетов в данном случае не изменяется при прохождении через фабрику, что упрощает мониторинг и диагностику сети. Кроме того, в DSCP доступно больше битов, чем в MPLS Traffic Class. Адресация - по одной /57 и одной /64 на Leaf-коммутатор, суммарно 4 префикса (2BB + 2FB).

## Ключевые архитектурные решения

Clos-топология с 2-мя уровнями Spine:
- Нет реальной альтернативы Clos-топологии, если нам требуется симметричная топология с высокой пропускной полосой
- Каждый новый уровень Spine пропорционально увеличивает стоимость сети, т.к. полоса пропускания должна быть одинакова между каждой парой уровней Spine. Мы рассматривали вариант со Spine 3, однако отвергли его из-за экономических соображений
Single-chip-коммутаторы фиксированной конфигурации для уровней Spine1 и 2
- Достаточный функционал и масштабируемость
- Достаточное количество портов для построения фабрики только с двумя уровнями Spine2
- Радикально проще модульных коммутаторов, нет сложных взаимодействий внутри шасси, уменьшен домен отказа
- Протокол маршрутизации имеет лучшую информацию о сети - каждый узел маршрутизации более или менее соответствует одной единице оборудования, которая либо работает, либо нет. В то время, модульная коробка (# сеть внутри коробки), может иметь промежуточные состояния с частичной деградацией пропускной возможности.
- Лучшая плотность портов (~ в 2 раза)
- Стоимость за порт. В 3-4 раза ниже
- Быстрый цикл разработки и выхода на рынок. Новые чипы выходят каждые пару лет, часто с удвоенной мощностью по сравнению с предыдущим поколением. Циклы обновления модульных коробок зачастую длиннее
Кросс-коннект уровней Spine1 и Spine2 через промежуточные патч-панели
- Упрощает СКС и оставляет возможности для модификации
BGP в качестве протокола маршрутизации
Агрегация префиксов на уровне Leaf-коммутатора
Внешняя связность через выделенный Edge PoD

## Топология
## Масштабируемость сети с двумя уровнями Spine ##
Мы можем построить сеть только с двумя уровнями Spine:
- 2 уровня Spine с количеством портов #64 достаточно для 2000 стоек в фабрике. 3200 стоек потребуют коммутаторов с 128 портами. Такие коробки будут доступны в текущем 2019-м году, но слишком поздно для заказа для новой фабрики.
- Но _действительно_, количество портов > 64 на уровне Spine2, нам нужно только лишь когда здание Gamma будет построено. До этого момента мы можем установить СКС для финальной топологии (в здании A и B) и использовать свичи с 64 портами и позже заменить их на 128-портовые.
- Поскольку половина Spine2 должна быть в зданиях, которые еще не построены, (1) мы временно используем 64-портовые свичи, установив их в стойки Spine2 и (2) подключаем их с помощью блоков кросс-коннекта.
Более подробно про СКС:
- [Все про новый дизайн в целом](https:_wiki.yandex-team.ru/noc/vla-fabric-design-notes/)
- [И все про СКС](https:_wiki.yandex-team.ru/dmitrijjershov/vla2-cabling/)

Финальная топология:

![](./images/vla_specifics/vla-fabric-2-spine-levels.svg)

## Маршрутизация

- Подключение большого количества узлов и линков к OSPF-домену (Backbone-сети) невозможно, в виду особенностей Link-state протоколов. Главная проблема - flooding протокольной информации. Решение - вынести подключение магистральной сети в отдельный Edge Pod, оставить OSPF/MPLS там и использовать eBGP между Leaf и Spine1, Spine1 и Spine2. Дефолтный маршрут и агрегаты будет анонсироваться от Edge POD к фабрике. Специфичные маршруты - в обратном направлении, от фабрики VLA к Edge POD
Никакой агрегации выше уровня Leaf:
- Агрегация приводит к потере трафика при деградации элементов фабрики в определенных сценариях. Во VLA1 мы делаем агрегацию, для того чтобы сохранить количество LFIB записей, компенсируя это костылями в виде VPN-mesh и иногда маршрутизируя трафик через Edge-устройства. При текущей схеме выделения IP-адресов, агрегация попросту ненужна - 160-5-4 # 3200 префиксов на здание, 12800 суммарно, но в таком случае, адресация жестко привязана к топологии и миграция адресов в другую часть сети невозможна
Только IPv6, полный отказ от VRF:
- Сеть внутри ДЦ поддерживает только IPv6. Все потребители поддерживают MTN, необходимость в VRF полностью отпадает
## Edge PoD
Edge PoD обеспечивает внешнюю связность для ДЦ. Он состоит из:
1. Выделенного уровня коммутаторов Spine1, подключенных к уровню Spine2, как и другие серверные PoD-ы, используются такие же модели коммутаторов.
2. Z-коммутаторов. Являются PE-маршрутизаторами, терминируют на себе Vrf HBF, включены в OSPF/MPLS домен.
3. E-маршрутизаторов. Чистые P-маршрутизаторы, Head/Tailend-ы для RSVP TE LSP. Подключаются к каждому Z, при этом суммарная полоса линков между E-Z должна позволять пропускать внешний трафик всего ДЦ, даже при отказе одного из устройств (E или Z).
Сервисные стойки с A-коммутаторами подключаются непосредственно к Z, двумя саб-интерфейсами (в GRT и в Vrf _HBF_, аналогично существующим).
К A-коммутаторам, по-прежнему, подключены балансировщики, декапсуляторы, файрволы, тунеляторы и NAT64.

Стек протоколов и распространение маршрутной информации представлены на рисунке ниже:

![](./images/vla_specifics/Edge-pod-v2-4.svg)

Более подробно про bgp: [Линк](https:_wiki.yandex-team.ru/NOC/hld/bgp/)

## Наименования ##
Кодировка для нового vla2:
```
1. TOR    - vla<BUILDING>-<MODULE>s<NUMBER>
2. Spine1 - vla-<POD>d<PLANE>
3. Spine2 - vla-<NUMBER>x<PLANE>
4. DCI router - vla-<POD#32,64,96,128>z<NUMBER>
```
Примеры:
```
vla2-6s101
vla-33d1
vla-16x1
vla-32z1
```
Переменные:
```
<BUILDING> - 1..4, сквозная нумерация для ToR
<MODULE>   - 1..20, сквозная нумерация, для VLA2 - 6..10
<POD>      - 1..128, сквозная нумерация, по 32 POD-а в здании, последний POD в здании (32,64,96,128) зарезервирован под EdgePOD
<PLANE>    - 1..8
<NUMBER>   - 1..32 для Spine2, per-plane; 1..999 - для ToR, per-module
```

- Spine 1 и 2 объединены на все здания, выполняют одну роль, носят одно название, но с разным уровнем (в отличие от X и D во VLA1).
- Плоскости видны в явном формате, и в узнаваемом месте
- POD для Spine1 дает жесткую привязку к зданию
- Для TOR POD не обязателен, т.к. коммутация жестко предопределяет Spine1

## ASN's

- TOR коммутаторы используют уникальную AS.
- Spine2 коммутаторы используют одну и ту же AS.
- Spine1 коммутаторы используют одну AS per POD.

Используется 4byte ASNs, левая часть некоторая база для ДЦ (одна для всех зданий), не на основе codes
```
Spine2: base_vla.(65000)
Spine1: base_vla.(65000 + (#POD))
TOR:    base_vla.<MODULE#01..20>-1000 + <NUMBER#1..999>
```
Примеры:
```
Spine2:         65000.65000
Spine1 POD33:   65000.65033
TOR vla2-6s101: 65000.06101
```

## Link-local addresses

Учитывая тот факт, что между парой устройств будет несколько физических линков (Spine1 -> Spine2 (128-100, в условии отсутствия 3 и 4 здания), требуется кодировать номер порта в LL-адрес.
1. Первый байт с конца кодирует порт устройства.
2. Второй байт с конца в адресе характеризует локацию и тип устройства.
3. Третий байт с конца назначается исходя из роли устройства.
```
E - TOR
C - S1
B - S2
```

## Миграция VLA1

Однако, для того, чтобы осуществить шаги, озвученные выше нам придется изменить логику внутри уже работающего VLA1. Их можно разделить на несколько этапов:
1. Создание нового Edge PoD, перенос внешней связности
  - установка и интеграция дополнительного оборудования
  - анонсирование внешних маршрутов через Edge PoD
2. IPv6-only VLA1
  - отключение половины Spine2 VLA1
  - смена стека протоколов на существующей фабрике, уход от OSPF/MPLS в пользу BGP
  - замена модульных коммутаторов Spine2 VLA1 на одночиповые
3. Финальная интеграция VLA1 и VLA2 в единую фабрику
  - установка и кроссировка оборудования
  - конфигурация и анонсирование сервисных префиксов

![](./images/vla_specifics/vla1-fabric+edgepod+2.svg)
