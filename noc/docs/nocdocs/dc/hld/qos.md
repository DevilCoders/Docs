# 8. Классы трафика и качество обслуживания

> Механизмы QoS находятся на стадии внедрения и не применяются повсеместно

## I Взаимодействие _Leaf-коммутатор - сервер_
Все сервера подключаются к ToR коммутаторам одним физическим линком без резервирования подключения.
Скорость подключения может меняться в зависимости от версии дизайна дата-центра и типа ToR коммутатора от 1G Ethernet до 50G Ethernet.
Для подключения могут использоваться:
- оптические/медные кабели с SFP/SFP+/SFP28/SFP56 трансиверами
- оптические/медные DAC кабели (зависит от дата-центра и даже модуля в дата-центре).
- DAC кабели 100G-4x25G или 40G-4x10G в случае использования коммутаторов с 100G или 40G портами

Подключение осуществляется при помощи 802.1Q транка с 4-мя VLAN:
- VLAN 333 (в данный VLAN также попадает не тегированный трафик). Используется для Backbone трафика dom0. В данный VLAN должен попадать только служебный трафик серверов. На коммутатор выделяется /64 сеть для данного VLAN.
- VLAN 688. Используется для Backbone трафика контейнеров. На коммутатор выделяется /57 сеть для данного VLAN.
- VLAN 700. Используется для Fastbone трафика dom0. В данный VLAN должен попадать только служебный трафик серверов. На коммутатор выделяется /64 сеть для данного VLAN.
- VLAN 788. Используется для Fastbone трафика контейнеров. На коммутатор выделяется /57 сеть для данного VLAN.

Областью распространения данных VLAN является ToR коммутатор. L3 интерфейсы для этих VLAN терминируются на ToR коммутаторе.

Сети /57 для VLAN 688 и VLAN 788 логически разделяются на индивидуальные сети /64 для каждого сервера.
Поэтому, максимальное количество серверов, которое может быть подключено к одному ToR коммутатору, ограничено 128 серверами.
На ToR коммутаторе для VLAN-ов 688 и 788 создаются статические маршруты для сетей /64 на link-local адреса, настроенные на dom0 серверов.
Шлюзом по умолчанию для виртуальных машин или контейнеров является логический интерфейс Linux bridge.

Пример настройки подключения сервера к ToR коммутатору:
_Пример конфига коммутатора_
```
interface 10GE1/0/3
  port link-type trunk
  port trunk pvid vlan 333
  port trunk allow-pass vlan 333 688 700 788
  undo port trunk allow-pass vlan 1
  mac-address notification learning
  stp edged-port enable
ipv6 route-static 2A02:6B8:C0D:3000:: 64 Vlanif688 FE80::A:0
ipv6 route-static 2A02:6B8:C0D:3001:: 64 Vlanif688 FE80::A:1
ipv6 route-static 2A02:6B8:C0D:3002:: 64 Vlanif688 FE80::A:2
<--snip-->
ipv6 route-static 2A02:6B8:C0D:307F:: 64 Vlanif688 FE80::A:7F
ipv6 route-static 2A02:6B8:FC14:3000:: 64 Vlanif788 FE80::A:0
ipv6 route-static 2A02:6B8:FC14:3001:: 64 Vlanif788 FE80::A:1
ipv6 route-static 2A02:6B8:FC14:3002:: 64 Vlanif788 FE80::A:2
<--snip-->
ipv6 route-static 2A02:6B8:FC14:307F:: 64 Vlanif788 FE80::A:7F
interface Vlanif333
  # Backbone HW
  ipv6 enable
  ipv6 address 2A02:6B8:C0E:60::1/64
  ipv6 address FE80::1 link-local
  ipv6 nd ra min-interval 10
  ipv6 nd ra max-interval 14
  ipv6 nd ra halt disable
  ipv6 nd autoconfig other-flag
  ipv6 mtu 9000
  dhcpv6 relay destination 2A02:6B8:0:3400::5004
  dhcpv6 relay source-ip-address 2A02:6B8:C0E:60::1
  damping time 20
  statistics enable
  mtu 9000
interface Vlanif688
  # BB SW
  ipv6 enable
  ipv6 nd ra prefix 2A02:6B8:C0D:3000::/57 2400 1200 no-autoconfig
  ipv6 address 2A02:6B8:C0D:3000::1/57
  ipv6 address FE80::1 link-local
  ipv6 nd ra min-interval 10
  ipv6 nd ra max-interval 14
  ipv6 nd ra halt disable
  ipv6 mtu 9000
  damping time 20
  statistics enable
  mtu 9000
interface Vlanif700
  # Fastbone HW
  ipv6 enable
  ipv6 nd ra prefix 2A02:6B8:FC09:60::/64 2400 1200 no-autoconfig
  ipv6 address 2A02:6B8:FC09:60::1/64
  ipv6 address FE80::1 link-local
  ipv6 nd ra min-interval 10
  ipv6 nd ra max-interval 14
  ipv6 nd ra halt disable
  ipv6 nd ra router-lifetime 0
  ipv6 mtu 9000
  damping time 20
  statistics enable
  mtu 9000
interface Vlanif788
  # FB SW
  ipv6 enable
  ipv6 nd ra prefix 2A02:6B8:FC14:3000::/57 2400 1200 no-autoconfig
  ipv6 address 2A02:6B8:FC14:3000::1/57
  ipv6 address FE80::1 link-local
  ipv6 nd ra min-interval 10
  ipv6 nd ra max-interval 14
  ipv6 nd ra halt disable
  ipv6 nd ra router-lifetime 0
  ipv6 mtu 9000
  damping time 20
  statistics enable
  mtu 9000
```

На серверах сетевой интерфейс настраивается при помощи [\[RTC\] yandex-netconfig](https://wiki.yandex-team.ru/runtime-cloud/yandex-netconfig/).
Пример настроек `/etc/network/interfaces`

```shell
iface eth0 inet6 auto
    project-id 4172
    ya-netconfig-bb-disable YES
    ya-netconfig-fb-disable YES
    # если нужен фастбон (vlan 700), закомментируйте выше и раскомментируйте ниже
    # ya-netconfig-fb-iface-vlan788-disable YES
```

Во время наливки через setup/walle это можно сделать, добавив в профиль наливки следующее:

```shell
[network]
method # auto
family # inet6
project_id # 4172
ya-netconfig-bb-disable # YES
ya-netconfig-fb-disable # YES

[infrapackages_extras]
yandex-archive-keyring #
repo-common-stable #

[packages]
yandex-netconfig #
```

Схема подключения серверов к ToR коммутаторам:
![Схема подключения серверов к ToR коммутаторам](./images/qos/server_connection_20200818.png)

## II Профили трафика с точки зрения сервера

Сервер принимает и отправляет два типа трафика: FastBone (FB) и BackBone (BB). Первый тип, как уже было сказано, используется для репликации баз и другого служебного трафика, второй тип используется для продуктивного и пользовательского трафика. На сервере vlan 333 (нетегированный) и 688 используются для передачи BB трафика, а 700 и 788 для FB трафика. Порядок выбора используемого адреса и интерфейса определяется на сервере.

## III Классификация трафика

Попадая на Leaf, трафик помещается в тот или иной L2 vlan, причем направление (внутри Leaf или за его пределы) и тип (L2/L3) трафика не имеет значения.
Каждый vlan имеет допустимый набор основных красок. Краска смотрится в IPv6 TC поле.
Для BB vlan-ов (333, 688) такие цвета [здесь и далее DSCP 6 bit в десятичном представлении] - 24 и 32. Все остальные будут сброшены в значение CS3 (включая некрашенный трафик).
Для FB vlan-ов такой набор красок - 8 и 16. Все остальные будут сброшены в значение CS1 (включая некрашенный трафик).
Для BB vlan-ов мы также отдельно классифицируем dscp 1,25,33 для собственных нужд.

## IV Буферизация, scheduling, rewrite

С помощью классификации трафик попадает в ту или иную очередь:
- BB dscp 0 (трафик без краски) -> очередь 0 (иногда очередь 3). Мы понимаем, что некоторое время, (возможно всегда), будет существовать трафик без краски, но очень хотим от него избавиться. Под очередь выдано 15%
- BB dscp 24 -> очередь 3
- BB dscp 32 -> очередь 4
- BB dscp 1,25,33 -> очередь 5
- BB остальные dscp -> очередь 3
- FB dscp 8 -> очередь 1
- FB dscp 16 -> очередь 2
- FB в остальных dscp -> очередь 1
- СS6-7. Краска под контрольный трафик сети. Вес 3% каждая

Под контрольный трафик используются очереди 6 и 7, куда не попадает трафик от хостов, а попадает либо трафик от удаленных сетевых объектов, либо трафик, сгенерированный самими коммутаторами.
Буфер на коммутаторе сейчас shared. В дальнейшем планируем ограничить сверху максимальный размер байт в буфере для очередей FB (1,2) до значения в 20-40%
На ряде коммутаторов в очереди 4 включен congestion avoidance (AQM) с помощью ECN. В других очередях используется tail-drop
На интерфейсах настроен WRR/DWRR/WFQ для каждой очереди с определёнными весами. Приоритетных очередей (в том числе для очередей контрольного трафика) нет.
В зависимости от очереди (traffic class), ipv6 TC поле трафика на выходе ремаркируется. Используется соответствие CS--номер_очереди, кроме очереди 0.
Например, очередь 1 - dscp 8, очередь 2 - dscp 16 и так далее. Для очереди 0 используется ремаркировка в dscp 24.

Текущие настройки:

| Code point | Описание                                   | DSCP значение (dec/hex) 6bit | Trafic class значение ToS (dec/hex) 8bit | Вес | Пример использования                                                                                             |
|------------|--------------------------------------------|------------------------------|------------------------------------------|-----|------------------------------------------------------------------------------------------------------------------|
| CS0        |                                            |                              |                                          | 15  | Временно для трафика без краски                                                                                  |
| CS1        | FB трафик, выкладки поиска                 | 8/0x8                        | 32/0x20                                  | 12  | Раскладка поиска в фастбоне, либо любой другой bulk-трафик фатсбона, который готов жить вместе с этой раскладкой |
| CS2        | FB трафик, остальной bulk фатсбона         | 16/0x10                      | 64/0x40                                  | 12  | Раскладки других проектов которые используют фастбон, YT раскладки между датацентрами                            |
| CS3        | BB трафик, меж дц, пользовательские данные | 24/0x18                      | 96/0x60                                  | 25  | Поисковый полезный трафик, важный небольшой трафик приложений, контрольный трафик                                |
| CS4        | BB трафик, внутри-ДЦ (ECN)                 | 32/0x20                      | 128/0x80                                 | 25  | Bulk внутри ДЦ, например MapReduce. В этом классе включен ECN                                                    |
| CS5        | YTTL                                       |                              |                                          | 5   |                                                                                                                  |
| CS6        | Сетевой сигнальный трафик                  |                              |                                          | 3   |                                                                                                                  |
| CS7        | Сетевой сигнальный трафик                  |                              |                                          | 3   |                                                                                                                  |

Светлое будущее:

| Code point | Описание                                   | DSCP значение (dec/hex) 6bit | Trafic class значение ToS (dec/hex) 8bit | Вес | Пример использования                                                                                             |
|------------|--------------------------------------------|------------------------------|------------------------------------------|-----|------------------------------------------------------------------------------------------------------------------|
| CS0        |                                            |                              |                                          | 15  | Временно для трафика без краски                                                                                  |
| CS1        | FB трафик, выкладки поиска                 | 8/0x8                        | 32/0x20                                  | 12  | Раскладка поиска в фастбоне, либо любой другой bulk-трафик фатсбона, который готов жить вместе с этой раскладкой |
| CS2        | RDMA                                       | 16/0x10                      | 64/0x40                                  | ?   | RDMA для GPU-кластеров                                                                                           |
| CS3        | BB трафик, меж дц, пользовательские данные | 24/0x18                      | 96/0x60                                  | 25  | Поисковый полезный трафик, важный небольшой трафик приложений, контрольный трафик                                |
| CS4        | BB трафик, внутри-ДЦ (ECN)                 | 32/0x20                      | 128/0x80                                 | 25  | Bulk внутри ДЦ, например MapReduce. В этом классе включен ECN                                                    |
| CS5        | YTTL                                       |                              |                                          | 5   |                                                                                                                  |
| CS6        | Сетевой сигнальный трафик + CNP            |                              |                                          | 3   |                                                                                                                  |
| CS7        | Сетевой сигнальный трафик                  |                              |                                          | 3   |                                                                                                                  |

https://st.yandex-team.ru/NOC-16605
Вес указан в процентах для удобства. В отсутствие трафика других очередей, каждая очередь имеет возможность использовать всю полосу целиком. При наличии двух конкурирующих очередей и отсутствии других, свободная полоса распределится между этими двумя очередями соответственно их весам.

## V Фильтрация

На каждом физическом порту используется L3 ipv6 ACL в направлении inbound. Для простоты автоматизации создается уникальный ACL per l2 server-faced интерфейс.
Правила фильтрации используют match полей L3 и L4 пакета в следующем виде:
- разрешается трафик на служебные адреса и служебные сервисы (dns, dhcp, icmp)
- разрешается трафик на ProjectID
- для project ID ACL используются рваные (discontiguous) маски, например: rule 10 permit ipv6 source 2A02:6B8:FC14:F80:: ::7F:7FFF:FFFF:FFFF:FFFF


## VI Менеджмент

Приоритетным является использование v6-only management, помещенный в выделенный VRF, который живет в отдельной управляющей сети.
Все сервисы (dns, syslog, snmp, sftp, scp, ssh, ntp...) работают по v6 в vrf и маркируются CS6.

## Важные замечания
Где делается покраска:
- На хостах при открытии сокетов приложениями
- На хостах в маршрутах
- На хостах в Hbf-агенте
- На Leaf коммутаторах в зависимости от типа vlan-а и возможностей самого коммутатора.
