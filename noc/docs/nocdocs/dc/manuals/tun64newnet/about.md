# Порядок выделения tun64 сетей

## Общее

- Необходимо навесить тег 'TUN64 block' на сеть
- Необходим тег сервиса (если нет - создаём новый), это нужно для того чтобы проросли нужные доступы для редактирования маппингов через токен.
- Необходимо назначить влан для сети в домене tun64 (в РТ из влана наследуются ответственные, управляющие маппингами), это нужно так же для того чтобы YP выдал права по этому VLAN (не актуально для qloud). Так же vlan позволяет использовать альтернативный доступ к редактированию маппингов через RT.
- Так же инструкция для дежноков описана дополнительно [тут](https://wiki.yandex-team.ru/noc/racktables/#vorkfloudljadezhnokov)
## Фаервол

### Стандарт

Стандартную фаервольную политику вкратце можно описать как, выдается по умолчанию всем, кто не запросил иного, покрывает бОльшую часть потребностей:
- разрешен tcp наружу и публичные сервисы Яндекса
- запрещен tcp syn к нам
- запрещен udp
- разрешен icmp
- запрещен трафик в yandexnetsПрописывать ее в фаерволе теперь **не** надо.
### Кастом

Есть несколько крупных клиентов, активно использующих нестандартные фаервольные политики (MDS,Zora), а также совсем единичные случаи совсем кастомного рулсета ( напр. телефония или мониторинги ), которых пока надо добавлять вручную в фаервол, в таких случаях обратиться к 

, 


**Или**, если запрашивается расширение или добавление новой сети к существующему кастому, нужно найти его в fw/router-fw.m4 и приатачить сеть к существующей политике, пример для ![https://st.yandex-team.ru/NOCREQUESTS-15677](https://st.yandex-team.ru/NOCREQUESTS-15677) :
```
SKIPTO_TUN64_SRCDST(`141.8.189.208/28', `:TUN64_TOWORLD_FASTTCP_DNS', `:TUN64_FROMWORLD_FASTTCP_DNS', `:TUN64_TOYA_CACHEDNS')
```
Достаточно коммита, у тунов есть фаервольная очередь, вручную апдейтить правила на каждом более не надо
## Фаервольный макрос

Каждому проекту на сеть необходим их уникальный макрос, можно либо смотреть по аналогии какие уже приатачены к сетиПример ![https://st.yandex-team.ru/NOCREQUESTS-15827](https://st.yandex-team.ru/NOCREQUESTS-15827) - сетям выделен макрос 
GEOMEDIAAD_TUN64_NETS
Если нет макроса, создаём так же макрос вида 

_TUN64_NETS
  и указываем в ACL и ответственных - сервис ABC. Трафик через данный макрос не ходит, и носит административный характер (используется для тарификации).
## Локационность

Ввиду все возрастающего количества клиентов такой схемы и массового ухода в 'облака', мы отказываемся от правила обязательной локальности хоста и туннелерной фермы. Теперь граница локальности проходит через весь ДЦ, и здесь необходимо учесть два момента
- Сеть обязательно должна светиться из двух независимых модулей данного ДЦ для отказоустойчивости, при этом все туннеляторы в ферме должны иметь идентичный набор сетей.
- Если проект все-таки большой (zora,mds) - их стараться светить из модулей, где их присутствие ожидается максимальное ( по сути это единственные клиенты, местоположение которых нас до сих пор интересует до модуля )
## Выкатывание сети

аннушка:

{% cut "старый способ" %}

> make HOST=iva-b-tun641 configs-diffmake HOST=iva-b-tun641 install
дернуть берд:
> birdc configure

{% endcut %}

Новый:
1. новую сеть достаточно выделить и навесить теги локации и tun64 block, это инструктирует генератор навесить сеть на туннелер, т.е. дополнительно вешать адрес сети на каждую железку теперь не требуется.
2. после выделения сети:
- Мытищи: `./ann deploy --entire-reload -g BirdTUN64 '{Мытищи} and {TUN64 gateway} and not {в оффлайне} and not {research and development}'`
- Ивантеевка:`./ann deploy --entire-reload -g BirdTUN64 '{Ивантеевка} and {TUN64 gateway} and not {в оффлайне} and not {research and development}'`
- Cасово:`./ann deploy --entire-reload -g BirdTUN64 '{Сасово-2} and {TUN64 gateway} and not {в оффлайне} and not {research and development}'`
- Владимир:`./ann deploy --entire-reload -g BirdTUN64 '{Владимир} and {TUN64 gateway} and not {в оффлайне} and not {research and development}'`
- Мянтсяля:`./ann deploy --entire-reload -g BirdTUN64 '{Мянтсяля-1} and {TUN64 gateway} and not {в оффлайне} and not {research and development}'`

## NAT64 для Zora

Если вдруг надо выделить новую сеть для зоры:
1. Создаем сеть с тегами `{zora} {NAT64} {dont use WKP} {поисковый rdns}`.
2. Выкатываем на активные YANET nat64 трансляторы (пока что только в MAN и SAS)?:`./ann deploy -g controlplane.conf,firewall.conf '{Мянтсяля} and {YANET} and {NAT64 gateway} and not {в оффлайне}'``./ann deploy -g controlplane.conf,firewall.conf '{Сасово} and {YANET} and {NAT64 gateway} and not {в оффлайне}'`
3. После выкатывания сделать `systemctl reload yadecap-controlplane.service` или подождать 5 минут - конфиги подтянутся автоматически.