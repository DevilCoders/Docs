# Организация IPv4 доступа для IPV6-only серверов

## Организация IPv4 доступа для IPV6-only серверов

Как известно, коммутационные фабрики новых датацентров строятся в варианте IPV6-only.Подразумевается, что поверх этой сети в конкретной вычислительной платформе можно реализовать любые варианты наложенных сетей с любой схемой адресации.

Для тех, кто, в силу обстоятельств, вынужден подключаться непосредственно к фабрике существует два варианта выхода из IPv6 мира в IPv4:
### NAT64

NAT64 подразумевался как средство выхода в интернет без дополнительной конфигурации для всяких вспомогательных вещей (пакет скачать какой-нибудь из внешниего репозитория, etc), которым наличие NAT не мешает. Воспользоваться им просто, но из-за необходимости сохранять состояние трансляции он плохо масштабируется, да и динамический адрес для многих применений - закрытые api/ресурсы, например,  плохо подходит.   Он остается и поддерживается для задач системного администрирования, не связаных с доступом к внешним критичным данным. [RFC6146](https://tools.ietf.org/html/rfc6146)

UPD. Из RFC6146
```
If there exists some other BIB entry containing S' as the IPv6
      address and mapping it to some IPv4 address T, then the NAT64
      SHOULD use T as the IPv4 address.  Otherwise, use any IPv4 address
      of the IPv4 pool assigned to the NAT64 to be used for translation.
```
NAT64 не гарантирует постоянный ipv4 адрес одному клиенту (особенно в кейсах разных dst-портов как напр у FTP)
### Наложенная IPv4-сеть в виде туннелей aka TUN64

На серверах/контейнерах, которым требуется внешний IPv4 на больших скоростях, нужно поднимать туннель с белым IPv4 адресом. При этом у сервера появляется нормальный статический IP в IPv4 интернете, что позволяет прописывать им, например, доступы в чужих файрволлах. Эта схема масштабируется линейно добавлением новых серверов и вполне надежна. Основной фетчер документов из интернета - Zora работает по этой технологии. Туннель приземляется на [Anycast-адрес](https://ru.wikipedia.org/wiki/Anycast) внутри основной сети (backbone) - 2a02:6b8:b010:a0ff::1, за которым может находиться любое количество серверов в любых локациях. Новые туннельные сервера, построенные на технологии [Intel DPDK](https://en.wikipedia.org/wiki/Data_Plane_Development_Kit), вполне себе способны обрабатывать 

 трафика каждый.

Примерная схема:

1) Заказываем обычным путем IP-сеть нужного размера, пока через форму: </noc/ipreq/>       
2) [Получаем Auth-Token](http://oauth.yandex-team.ru/authorize?response_type=token&client_id=950f303bdd4446f3870c8d4156a1c1c9) для API Racktables (если у вас его еще нет)
3) Определяем для себя соответствие IPv4-адрес = IPv6-адрес сервера.       
4) Прописываем эту связку во вкладке **map64** у выделенной сети в интерфейсе Racktables, либо через [ручку](https://wiki.yandex-team.ru/noc/racktables/export/#/export/map64request.php). \
`Изменения реплицируются на все туннельные сервера в сети минут за 5 (если нужно менять чаще - пишите, будем думать)`
5) Конфигурируем туннель на машинах:
```
ip -f inet6 tunnel add tun0 mode ipip6 remote 2a02:6b8:b010:a0ff::1 local **IPv6addr**
ip addr add **IPv4addr/32** dev tun0
ip link set up dev tun0
ip route add 0/0 dev tun0  mtu 1450 advmss 1410
```
Эти команды нужно выполнять **в runtime**. Для того, чтоб настройки не сбрасыались при ребутах, оберните каждую команду в `post-up` и поставьте абсолютный путь к `ip`. Например:
```
auto tun0
    iface tun0 inet **manual**
    post-up /sbin/ip -f inet6 tunnel add tun0 mode ipip6 remote 2a02:6b8:b010:a0ff::1 local **IPv6addr**
    post-up ...
```
*В macOS требуется дополнительно подтюнить настройку `sysctl net.inet6.ip6.gifhlim=64`*

Файрволльный макрос по умолчанию ``INET4ALL / INET4ALL_IN``\
краткое содержание:
- разрешен на выход со state TCP
- запрещен любой UDP
- запрещен любой трафик в YANDEXNETS.
