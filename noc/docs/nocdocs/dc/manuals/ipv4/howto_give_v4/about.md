# Выделение IPv4 сети

## Пререквизиты для выделения IPv4 сети
- Размерность (маска) подсети
- VLAN ID
- Локация
- Основной макрос fw, в который сеть должна быть добавлена

##  Выделение сетей для L3

Новые сети выделяются под Project_id, сети которого маршрутизируются в VRF Hbf.

> **NOTE**
>
> Если требуется выделить IPv6 сеть, то:
> 1. воспользуйтесь инструкцией заведения [нового Project_id](https://docs.yandex-team.ru/nocdoc/processes/project_id/get_new_project_id/about)
> 2. Установите hbf-агент на ваши устройства по инструкии: [yandex-hbf-agent](https://wiki.yandex-team.ru/runtime-cloud/yandex-hbf-agent/). Если требуется дополнительная информация или комментарии, то обращайтесь к [Роману Аникину](https://staff.yandex-team.ru/squirrel) или [Евгению Килимчуку](https://staff.yandex-team.ru/ekilimchuk)

IPv4 в L3 сети, достигается путём инкапсуляции v4-пакетов в IPv6 (TUN64). Чтобы выделить такую сеть, нужно выполнить следующие шаги:
1. Убедиться, что заказывающие понимают, что им придётся использовать туннельные интерфейсы и отдельные адреса. Если в заявке это не указано явно, стоит уточнить.
2. Выделить сеть нужного размера из обычного агрегата ДЦ. Помимо тегов локации и проекта обязательно указать тег "TUN64 block". Использовать макрос `INET4ALL` и любой vlan, используемый этим проектом (он будет нести исключительно информационную функцию).
3. Повесить сеть на TUN64 gateway для этого ДЦ или попросить сделать это кого-то из группы эксплуатации ([Алексей Есин](https://staff.yandex-team.ru/adess), [Роман Глебов](https://staff.yandex-team.ru/kitaro) - получить навык навешивания туннельных сетей можно у них же).
4. На этом работа окончена, теперь заказчик должен указать пары IPv4 - IPv6 во вкладке "64 map" выделенной сети в RT (для примера см. любую сеть с тегом "TUN64 block"). Если по какой-то причине эта вкладка заказчикам не видна, нужно обратиться к Алексею Андриянову.

## Добавление новой сети ipv4 для L2

1. Анализируем маску на адекватность запрашиваемого размера сети и количества предполагаемых хостов. Для сетей роботов поиска (Spider) всегда выделяем только /24.
2. Находим в [ipv4space](https://racktables.yandex.net/index.php?page=ipv4space&tab=newiprange) подходящий префикс в агрегате искомой локации. Берём верхний тег для ДЦ ("Мытищи"), но не берём "офис ***" ("офис Мытищи"). В названии сети, включающей вашу предполагаемую сеть, не должно быть никаких слов типа "vrf", "ipmi" - только "агрегат" и тег локации. Если не находим, размещаем новый агрегат на датацентр (тег "RIPE allocation block").
3. Создаём сеть, используя [ipv4space форму](https://racktables.yandex.net/index.php?page=ipv4space&tab=newiprange). Добавляя сеть, не забываем привязывать к ней все необходимые тэги (по аналогии с сетями на этом же влане в других дц) и присваивать имя, взятое из описания сети проекта в другом датацентре. Если подходящего влана не существует, его [необходимо создать до выделения сети](https://racktables.yandex.net/index.php?page=8021q&tab=default). Сразу при выделении сети указываем для неё макрос FW. Очень важно выбрать правильный макрос. Самый правильный - это тот, который прицеплен на остальные такие сети в других ДЦ. Если проект новый, админы могут сообщить имя макроса для его сетей. Имя должно заканчиваться на `NETS_`. Можно создать новый макрос прямо из формы выделения сети, если поставить галку "new macro".
4. Найти подходящий роутер для сети. На роутере должен быть тэг "core router" и не должно быть следующих тегов: "в оффлайне", "firewall".
5. Привязать IP интерфейс к выбранному роутеру: как правило это предпоследний в диапазоне адресов выделяемой сети.
6. Если все прошло удачно, идем в закладку "проектные сети", и выполняем на выбранном нами роутере:
"выкатить vlan на свитч" (опциональна, может и не быть) - создает влан на свиче, и добавляет его в транк;
"применить конфиг на роутере" - создает интерфейс на роутере.
7. Если создавался новый сетевой макрос или новый VLAN в старом макросе, то тикет необходимо переложить в очередь FWREQ (тикет будет обработан ответственными за эту очередь и при необходимости возвращён во внутренние задачи NOC).
8. Если создавался новый VLAN, нужно пройти в пункт RT Сервисы -> ACL, вбить в поле поиска номер нового влана и вписать ответственных, указанных в заявке (не забываем нажать save).

## Добавление новой сети ipv6 для L2

В целом, всё похоже на предыдущий пункт. Отличия следующие:
1. По умолчанию размер сети /64.
2. Выбирается "агрегат общего назначения" (искать по тегам "песочница", "агрегат") для данного ДЦ. Внимание: даже если сеть принадлежит поиску, но это не vrf, её всё равно нужно выделять из песочницы! Подойдёт любая сеть с описанием "Агрегат общего назначения".
3. Сети всегда цепляются за роутер адресом ::1.

## Удаление сети

1. Удаляем адрес сервера(ов) из этой сети через вкладку "IP" в свойствах хоста (не забываем нажать нужные кнопки во вкладке "проектные сети"). Для сети на L3 ToR снимаем сеть со свитча через вкладку "IP".
Убеждаемся, что сеть не является последней в макросе firewall (щелкаем на макрос fw на странице сети и смотрим список сетей в макросе).
2. Если она последняя, то добавляем в grep-шаблон из п.6 ещё и имя этого макроса. Если сеть - последняя в своём макросе, нужно убедиться, что всё правила в/из этого макроса удалены (так как макрос будет автоматически удалён тоже). Проверяем этот момент в панчере. Далее запрашиваем на FWREQ удаление макроса. Не разбирайте последнюю сеть, пока не разобран макрос - вы рискуете сломать рестарт фаервола! Если удаляем целую секцию, нужно также удалить всех ответственных в пункте RT Сервисы -> ACL (в поле поиска вбиваем название секции).
3. Также нужно проверить, что сеть - не последняя в своём влане (в пределах влан-домена или вообще). Если последняя вообще, удаляем сначала всех ответственных за vlan в разделе RT Сервисы -> Permissions. Далее удаляем сам влан в разделе 802.1q.
4. Если в сети остались real-сервера, участвующие в балансировке (на странице сети отмечены стрелочкой и именем RS пула), просим ответственных за сеть разобраться с ними письмом на slb@ или тикетом в TRAFFIC.
5. Удаляем сеть из RT на вкладке Properties на странице сети.
6. Грепаем различные файрволлы по IP-адресу сети и слешу (без маски). Список файрволлов, где нужно искать:
   - cvs:noc/router/fw
   - cvs:noc/balancers/iptables
   - svn+ssh://arcadia.yandex.ru/robots/security/security-fw/rules.m4 (или в Puncher)
7. Если сеть найдена в CVS, призываем в тикет удаления сети artem@ или lytboris@. Для svn - просить ответственного за сеть почистить доступы в puncher

## Выделение или расширение сети для офиса

[Порядок выделения новых сетей для офиса](https://wiki.yandex-team.ru/noc/office/newofficenets/)

## Расширение сети ipv4

Перед выделением сети ищем уже выданную сеть в запрашиваемой локации. Если уже есть сеть, то выделяем сеть с большей маской, в которою потом переедет старая сеть. На старую сеть вешаем тег "расширение отсюда", на новую - "расширение сюда".

-----
Первоисточник: [https://wiki.yandex-team.ru/noc/NetworkAlloc/](https://wiki.yandex-team.ru/noc/NetworkAlloc/)