# Порядок выделения новых сетей для офиса

## Выделение новых сетей для офиса

Процесс выделения сетей для офисных нужд, в отличие от проектных, требует дополнительных действий.

## Документирование в RT

Wi-Fi сети терминируются на рыбках, в то время как проводные сети могут терминироваться и на мальках.



- Если свободная сеть нужного размера в офисном агрегате отсутствует

  {% cut "Детали ... " %}

  - Выделить новый агрегат:
    - С помощью racktables найти свободную сеть (в зависимости от нужд - обычно /24 или /23). Пометить ее тегами `агрегат` и локации офиса.
  - Если свободных сетей для выделения агрегата нет, выделять сеть напрямую allocation block и использовать тег bgp-агрегат
    Добавить сеть в noc/routers/global-routers-inc.m4 в строчку идентификатора офиса, идентификатор можно узнать в строчке OURDC_NAME файла /etc/make.conf на роутере этого офиса. Закомитить изменения. На всех концентраторах, обслуживающих рыбки данного офиса и на самих рыбках, добавить новый префикс в раутмап:
    ```
    make -C /usr/local/routers update
    make -C /usr/local/routers/conffiles/bird all install loadrun
    ```
    
   {% endcut %}

- Выделить с помощью racktables сеть нужного размера из агрегата данного офиса, дать название вида "VLANXXX ПРЕДНАЗНАЧЕНИЕ", протегировать по локации офиса и предназначению, провязать с фаервольным макросом.
- Если сеть первая в данном влане данного офиса — добавить vlan на офисные коммутаторы вручную.

## DHCP

- Посмотреть в других офисах как сделаны сети аналогичного vlan с точки зрения DHCP.
- При необходимости добавить vlan в конфиг dhcp-релея /noc/routers/conffiles/dhcprelya/dhcprelya.servers.m4
- Добавить сеть без лиз в конфиг dhcp (в зависимости от локации):
  - Красная роза
  - Остальные офисы
- Повесить средствами racktables шлюз новой сети на роутер, не вешать если работает DHCP и сеть в нём ещё не описана
- Открыть тестовый диапазон лиз (10-20% от емкости ести) в dhcp (в зависимости от локации)
  - Красная роза
  - Остальные офисы
- Подождать пару рабочих дней на удостовериться в отсутствии жалоб
- Открыть весь диапазон:
  - Красная Роза
  - Остальные офисы

Если выделяется новая более широкая сеть вместо старой, то:
1. Открываем тестовый диапазон для новой сети и закрываем часть лиз из старой
2. Через пару дней открываем весь диапазон в новой и делаем NORANGE для старой сети
3. Ждём, когда в старой сети не останется ни одного устройства.
4. Снимаем сеть с роутреа (первым шагом!!),
5. Удаляем её из RT(вторым шагом!),
6. Удаляем из конфига DHCPd

## FW

- Если сеть первая в данном влане данного офиса — описать vlan в fw
- Если сеть пользовательская, которая может использоваться сотрудниками для динамических доступов:
- Если сеть НЕ пользовательская (телефоны, видеокамеры etc) — проверить, что рэктейблс отправил нужные фаерволы в рестарт
