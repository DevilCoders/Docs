# Сценарий damaged-link

## Введение

Сценарий ЦК damaged-link создан для того чтобы автоматизировать процедуру диагностики линка фабрики.

При запуске он убирает трафик с линка, после чего ожидает действий со стороны инженера ITDC. После выполнения диагностики, сценарий производит проверку живости линка, и если он выглядит нормально - возвращает нагрузку и закрывает тикет.


## Текущие ограничения

* Только для линков в l3-фабрике: tor<->spine1 spine1<->spine2
* Только для новых фабрик, iva/myt не поддерживаются
* Проверка живости линка пока очень простая - то что линк поджегся и видит соседа по lldp
* Пока джобу нужно создавать на тикет ITDC - [NOCDEV-6325](https://st.yandex-team.ru/NOCDEV-6325)

## Как создать

### Через интеграцию в шаблонах heat

Для некоторых проверок linkeye сейчас настроена интеграция heat с ЦК.

1) Создаем комментарий событию и ставим галку на ITDC тикет ![01](images/heat_01_create.png)
2) В тикет прилетает комментарий ссылкой на создание джобы. Копируем отсюда номер тикета `ITDC` ![02](images/heat_02_comment_link.png)
3) Перейдя по ссылке в ЦК можно увидеть предзаполненную форму для нужного порта. Тут **нужно подставить номер тикета ITDC** скопированного на предыдущем шаге (*поправим в ближайшее время NOCDEV-6325*). ![03](images/heat_03_filled_form.png)

Интеграция включена для проверок с zabbix-тегом ck_damaged_link. Подробности можно посмотреть в `mondata/discovery/linkeye.py` и `heat-ticket-templates/templates/itdc.py`

### Вручную
1) Создаем тикет в ITDC (через хит либо руками) ![01](images/01_itdc_ticket_created.png)
2) Переходим на noc.yandex-team.ru и выбираем spine с коротого снимаем нагрузку и нажимаем `Create`. ![02](images/02_select_spine_device.png)
3) Заполняем форму создания джобы. Вставляем тикет. В типе указываем `damaged-link`. В поле port указываем имя порта с которого убираем нагрузку. Важный момент: *название порта должно совпадать с его названием в Racktables*. Например: `100ge1/0/1`, `e2/1/3`, `et-1/2/3` и тд. ![03](images/03_fill_job_form.png)
4) После этого в тикете должен появится отчет о том что сценарий запущен, а после этого о том что трафик снят ![04](images/04_ticket_started_report.png)
5) После этого ожидается что инженер будет переводить тикет в состояние `Требуется информация` каждый раз когда требуется перепроверить порт. В тикет после этого будет приходить отчет ![05](images/05_check_fail.png)


## Детали работы

Логика сценария лежит в репозитории ЦК: [link](https://noc-gitlab.yandex-team.ru/nocdev/noc-ck/-/blob/master/app/declarative/damaged_link.yml)

### Снятие трафика
На порт выставляется cable-id `damaged` после чего на него деплоются изменения через `ann`. На данный cable-id завязаны две возможные логики

Для обычного l3 интрерфейса: гасится пир через команду shutdown/inactive/ignore [commit](https://noc-gitlab.yandex-team.ru/nocdev/annushka/commit/0f95dd401d46da1e14406f626e86ffd290b71dfe)

Для l2 интерфейса в Lagg'e: от убирается из member'ов [commit](https://noc-gitlab.yandex-team.ru/nocdev/annushka/commit/87a1f77743c5da727d0ae7fb46240e78ff1379d9)


### Проверка порта
После того на устройство выкачено снятие трафика сценарий ожидает пока трафик действительно уйдет с порта. Проверяется это через вывод команды `show interface <port>`.

Проверка того что порт работоспособен в данный момент заключается в двух шагах (в последствии их будет больше)

* Проверка физического статуса порта
* Проверка наличия LLDP соседа


### Статусы тикетов
Статусы тикетов подогнаны к требованиям очереди ITDC. Как выглядят статусы с точки зрения пользователя

* При запуске робот проставляет статус `Open`
* Инженер произвел манипуляции и нужно произвести проверку он ставит руками статус `Нужна информация`
* Робот проверил состояние и нашел его неудовлетворительным, выставив статус `Информация получена`
* Робот проверил состояние и нашел его удовлетворительным, возвращаем нагрузку и закрываем тикет

![Статусы тикетов](images/ticket_statuses.png)

## Ссылки
Cценарий с логикой взаимодествия с устройством: [link](https://noc-gitlab.yandex-team.ru/nocdev/noc-ck/-/blob/master/app/declarative/damaged_link.yml)
Шаблон хита с логикой интеграции создания джобы: [link](https://noc-gitlab.yandex-team.ru/nocdev/heat-ticket-templates/-/blob/master/templates/itdc.py#L78)
Интеграция проверок linkeye с шаблоном хита: [link](https://noc-gitlab.yandex-team.ru/nocdev/mondata/-/blob/master/discovery/linkeye.py#L63)
****
