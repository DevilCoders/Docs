# Обновление коммутаторов

| Авторы | Контакт |
|:------:|:-------:|
| Евгений Кулемзин | [ekulemzin](https://staff.yandex-team.ru/ekulemzin) |

---------------------------

## Обновление офисных коммутаторов

**Что нужно?**

Используется автоматика noc-ck по заранее созданным сценариям, которые можно посмотреть в [Ck:UI:Devices](https://noc.yandex-team.ru/devices)

**Как использовать?**

Шаг 1. В поле hostname вводим нужные нам свитчи (поле поддерживает регулярные выражения).

Шаг 2. Выбираем checkbox нужных свитчей и нажимаем кнопку create.

Шаг 3. Указываем тикет по которому ведутся работы, выбираем нужный сценарий и выбираем дату/время старта/окончания.

![](./_images/img1.png)

![](./_images/img2.png)

Шаг 4. Проверяем, что в списке работ появились запланированные работы.

![](./_images/img3.png)

**Как работает?**
Коллеги из офисной группы создают сценарий для обновления конкретных моделей оборудования и при заведении тикета на обновления указывают какой сценарий нужно использовать.
В сценарии прописана вся автоматика (зайти на свитч/скачать прошивку/поставить прошивку/перезагрузиться).

**Алгоритм работы:**
1. Получить в тикете список свитчей и название сценария обновления
2. Завести в noc-ck работы на эти свитчи с нужным сценарием.
3. После работ проверить uptime свитча и версию софта.

-----------

## Обновление коммутаторов Huawei

**Что это?** 

How-to по скрипту soft-modernizer для обновления софта на ряде коммутаторах Huawei (в данный момент поддерживаются только некоторые Huawei) [https://noc-gitlab.yandex-team.ru/nocdev/comocutor-contrib/-/tree/master/utils](https://noc-gitlab.yandex-team.ru/nocdev/comocutor-contrib/-/tree/master/utils)

**Как поставить?** 

Скачать с гита в свою домашнюю директорию
```
[noc-myt/noc-sas ~]$ git clone git@noc-gitlab.yandex-team.ru:nocdev/comocutor-contrib.git
```
**Как работает?**
1. Сами файлы софта и прошивок лежат на tftp. `noc-myt/tftpboot/Huawei`
2. Скрипт поддерживает разный формат входных данных и несколько ключей.

- Выборка по ключу с RackTables.
```
python soft_modernizer.py '({Huawei 6870} and {серверный свитч} and {Владимир-1} and {Владимир-1.1} and not {в оффлайне}) and ({$attr_10000_88672})'
```
- Одиночный свитч или список через пробел.
```
python soft_modernizer.py vla1-1s101

python soft_modernizer.py vla1-1s101 vla1-1s102
```
3. Скрипт заходит на свитч, проверяет версию софта и патча.За одну итерацию скрипт может или залить и прописать в загрузку новый софт, или обновить патч. Патч ставится без перезагрузки, для установки софта после того, как скрипт разложит новый софт - требуется перезагрузка свитча.Если требуется обновить и софт и патч - нужно сначала пройти скриптом для того чтобы залить новый софт, потом перезагрузит свитчи и ещё раз пройти спиртом, чтобы поставить патч.

Версии софта, патча и модели коммутаторов захардкожены в теле скрипта. [https://noc-gitlab.yandex-team.ru/nocdev/comocutor-contrib/-/blob/master/utils/soft_modernizer.py](https://noc-gitlab.yandex-team.ru/nocdev/comocutor-contrib/-/blob/master/utils/soft_modernizer.py)

Перед обновлением, нужно проверить нужная ли версия прописан, если нет внести изменения и закоммитить.

![](./_images/img4.png)

**Дополнительные ключи**Часто используемый ключ, чтобы предварительно проверить где требуется обновление софта, а где только патча
```
-n - не обновлять софт, а только показать где нужно обновить.
```

**Примеры работы:**
```
1) vla1-1s10: OK
2) vla1-1s101: need to update patch from VRPPatchVersion<V200 R19 SPC7> to VRPPatchVersion<V200 R19 SPC12>
3) myt6-s16: need to update from VRPVersion<V100 R5 C10> to VRPVersion<V200 R2 C50>
```
1. На свитче последняя актуальная версия софта и патча.
2. На свитче актуальная версия софта, будет обновлен патч.
3. На свитче требуется обновить софт, новый софт будет скопирован с tftp, после этого требуется перезагрузить коммутатор.

**Переменная при проблеме с авторизацией:** export COMOCUTOR_NO_NOCAUTH=1

**Как сформировать ключ в RT для списка коммутаторов**Заходим в RT в раздел с устройствами [https://racktables.yandex-team.ru/index.php?page=depot](https://racktables.yandex-team.ru/index.php?page=depot)

В списке справа выбираем подходящий фильтр, например "свитчи Huawei 6865, Владимир-1, не в оффлайне и не cloud"

![](./_images/img5.png)

Нажимаем кнопку "сделать текстовое выражение"

![](./_images/img6.png)

Получаем текстовый ключ, по которому фильтруется выбранный нами список свитчей.

![](./_images/img7.png)

**Алгоритм работы:**
1. Проверить, что в [файле](https://noc-gitlab.yandex-team.ru/nocdev/comocutor-contrib/-/blob/master/utils/soft_modernizer.py) прописана актуальная версия софта и патча.
2. Проверить требуется ли перезагрузка или только установка патча на списке свитчей (используя ключ "-n")
3. Обновить и при необходимости перезагрузить свитчи.
4. Повторно пройтись скриптом с ключом -n для проверки

---------------

[Исходник](https://wiki.yandex-team.ru/soft-modernizer/)
