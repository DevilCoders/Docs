# Снятие трафика между spine свитчами

```
git clone git@noc-gitlab.yandex-team.ru:rmammadov/manage_traffic.git
```
Для снятия трафика с линков между spine свитчами можно использовать скрипт manage_spine_traffic.py. Для его работы требуется добавить токен для создание тикетов, это должен быть файл key.txt в той директории, в которой находится скрипт. Файл с токеном можно найти тут: `noc-duty.yndx.net:/opt/cmmoc-robot/key.txt`Рассмотрим принцип работы на примере - vla-7x5 100ge1/0/7 <-> vla-34d5 100ge1/0/25. Вводные данные - действие с трафиком ( снимаем или возвращаем трафик ), название свитча и порта ( название порта надо также как он назван в RT):
```
Действие с трафиком ( 1 - Cнимаем , 2 - Возвращаем ) : 1
Введите название свитча : vla-7x5
Введите интерфейс : 100ge1/0/7
=====================================================================
Cable ID of link is not damaged.
Do you want to mark link damaged [Y/n]?:
```
Важно! Необходимо снимать трафик со стороны x-ов, так как, в основном, YTTL тэг будет вешаться на x-ы. Случай с выходом из строя карт на d-ках надо будет рассматривать вручную.После ввода данных, если трафик:
1. Снимаем - будет предложено пометить данный линк как damaged.
2. Возвращаем - будет предложено снять метку damaged с линка.
Данная процедура требует rw прав в RT, скрипт необходимо запускать с машин NOC-а, у которых есть rw права в RT. Сейчас - noc-sas. Узнать, кто сейчас Master, можно командой `test -e ~racktables/master  && echo MASTER || echo SLAVE`После чего происходит подключение к устройству и сбор данных необходимых для снятия трафика. На основе этих данных выводятся данные, которые попадут NOCRFC:
```
=====================================================================
Link description :
 vla-7x5 100ge1/0/7 - vla-34d5 100ge1/0/25
=====================================================================
Action diff :
 # -------------------- vla-7x5.cfg --------------------
  interface 100GE1/0/7
-   description vla-34d5 100ge1/0/25
+   description vla-34d5 100ge1/0/25 damaged
bgp 65000.65000
+   peer FE80::34:C5 ignore

=====================================================================
Deploy command :
 # -------------------- vla-7x5.patch --------------------
interface 100GE1/0/7
  description vla-34d5 100ge1/0/25 damaged
  quit
bgp 65000.65000
   peer FE80::34:C5 ignore

Cоздаем NOCRFC [Y/n]?:
https://st.yandex-team.ru/NOCRFCS-3872
Был добавлен тэг YTTL отключен
```
Если всё устраивает и вы выбираете Y, то создается NOCRFC c временем проведения +5 мин от реального, длительность работ 10 мин.Также происходит проверка:
1. При снятии, если тэга YTTL на свитче не было, трафик снят с L3 интерфейса или L2 линка, который повлечет падение LAG-а, то данный тэг ставится. В случае, если трафик при помощи выведения линка из LAG-a и не влечет никаких последствий для самого LAG-a, то YTTL не ставится.
2. При возврате, если YTTL тэг есть и на свитче помимо данного линка, нет L3 линков указанных как damaged, то тэг снимается.Если такие линк есть, то тэг остается. Информация о действие с YTTL тэгом будет выведена в конце.