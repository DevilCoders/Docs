# Специфика DC SAS

## Каскадная схема в SAS1

Всего в SAS1 (aka Старое Сасово) около 700 1G ToR. По экономическим соображениям пока не принято решение об их апгрейде и существующие ToR используются для подключения серверов. Текущие модели 1G ToR это Huawei CE5850-48T4S2Q с 40x1G, 4x10G и 2x40G портами. 

В SAS1 есть три SPINE1:
- sas-1d2 и sas-1d4 - Huawei CE12812 c 12 линейными картами 36x100G - используется для L3 трафика.
- sas1-d3 - Nexus C9508 c 8 линейными картами 36x40G - используется для L2 сегментов размазанных по ToR.
Схема подключения 1G ToR к S1 реализована через гидры 4x10G, т.е. 100G порт разбивается на четыре 10G порта. В некоторых случаях для аплинка используется 40G порт, но из-за большого количества ToR приходится использовать гидры. Если 1G ToR требуется подключить к L2 сегменту используется отдельное соединение с sas1-d3.

Это создает значительные проблемы, поскольку:
- некоторые сервера в SAS1 требуют 10G порт и таких серверов может быть больше чем портов 10G в ToR;
- двух аплинков по 10G для L3 трафика часто не достаточно.
В качестве решения проблемы, предложено сделать каскад из ToR коммутаторов, т.е. фактически создать еще один уровень ToR, который получил RT тэг `ToR-агрегатор`, а подключенные к нему ToR получили тэг `ToR-агрегатор slave`. ToR-агрегатор это новые коммутаторы серии Huawei 6865/6870 с портами 25Gb и шестью или восемью портами 100G.

Особенностью схемы является:
- на три стойки ставится один ToR-агрегатор;
- к одному ToR-агрегатор может быть подключено от 1 до 6 ToR-агрегатор slave.
Схема перехода от старого дизайна к новому:![https://wiki.yandex-team.ru/users/gslv/specifika-dc-sas/.files/limitationssas11-1.png](https://wiki.yandex-team.ru/users/gslv/specifika-dc-sas/.files/limitationssas11-1.png)

Очевидным ограничением этой схемы является отсутсвие резервных подключений у ToR-агрегатор slave и таким образом обслуживание или проблемы на ToR-агрегатор влияют сразу на три стойки. Наиболее простым решением здесь является подключить каждый ToR-агрегатор slave к двум ToR-агрегатор, но, к сожалению, из-за физических ограничений, такую схему реализовать можно только у небольшого количества коммутаторов. И кроме этого, это требует слишком больших усилий со стороны ITDC, значительно загруженных другими задачами. Подобная схема реализована у единичных ToR-агрегатор slave. Проработка различных решений резервирования проводилась в тикетах:
- NOC-19516
- NOC-19763
- NOC-19764

## Дефолтные маршруты в SAS1

Поскольку в SAS2 используется фабрика с четырьмя плейнами, а в SAS1 всего два S1, то подключаются они только в четные плейны, т.е. в plane 2 и 4. Это создает небольшой перекос в трафике фабрики, который ходит между SAS1 и SAS2, поскольку маршруты SAS1 отсутствуют в нечетных плейнах.

Основной схемой подключения ToR в фабрике SAS1 является RR-схема, которая представляет собой устаревший дизайн фабрик. Смысл этой схемы сводится к следующему:
- все ToR имеют подключение через L2 порты к S1;
- два RR (bird) так же подключены к S1 (каждый RR включен в каждый S1 отдельным интерфейсом);
- на S1, ToR и RR подняты L3 интерфейсы в одном VLAN и настроены BGP сессии от каждого ToR к каждому RR;
- RR убирает из as-path свою AS.

В SAS1 каждый из двух S1 образует свой L2 домен с RR, но с S1 на RR анонсируется только дефолтный маршрут, поскольку 1G ToR SAS1 имеют ограниченный FIB, в который не влезают все маршруты в фабрике. В следствии этого, ToR в SAS1 видят маршруты всех ToR в SAS1 + дефолт и отправляют трафик за пределы SAS1 на два четных плейна.

Здесь возникает интересный момент связанный с тем, что если какой-то маршрут отствует в одном из двух четных плейнов, то трафик "поднимается" по дефолтному маршруту до EdgePod до Z-коммутаторов и там уже развернется вниз в нужный Pod, поскольку все Z-ки включены во все плейны. В этой схеме надо быть краней осторожным при отключении любого из S1 EdgePod подключенного к четным плейнам. Если получится так, что подключение к четным пленам будет не симметричным, есть риск нарушить связность, см. SPI-27803.

Каскадная схема, так же реализует ограниченный набор маршрутов для ToR-агрегатор slave. Но в отличии от RR схемы ToR-агрегатор slave видит только маршруты с других ToR-агрегатор slave подключенных к тому же ToR-агрегатор + дефолтный маршрут. Таким образом, потенциальная проблема с ассиметричностью становится еще более масштабнее.

Примерная схема текущей фабрики (без учета L2 сегмента и SAS3) выглядит следующим образом:![https://wiki.yandex-team.ru/users/gslv/specifika-dc-sas/.files/limitationssas12.png](https://wiki.yandex-team.ru/users/gslv/specifika-dc-sas/.files/limitationssas12.png)

## L2 сегмент

L2 сегмент SAS1 представлен единственым S1 - sas1-d3 (Nexus C9508) который подключен к сервисным коммутаторам с индексами sas1-a3\[cd\]. На этих коммутаторах подняты интерфейсы для L2 сегментов с резервированием по VRRP. Далее трафик уходит либо на EdgePod или на FW в заисимости от адресов назначения. Эта схема находится на термиральной стадии своего развития, новые проекты туда не заходят, а старые проекты постепенно уносят нагрузку в более современные ДЦ.

Следует отметить, что большинство ToR подключенных к L2 сегменту так же имеют подключение и к L3 S1, т.е. для роутинга L3 трафика используются sas-1d, а L2 коммутация идет через sas1-d3.
