# Автоматизация сетей Яндекса

В данном разделе приводится описания работы систем автоматизации сетей Яндекса, приведено описание работы и тестирования системы.

## Введение

Автоматизации процессов обслуживания сети уделяется большое внимание в Отделе сетевой инфраструктуры. С помощью автоматизации добиваемся следующих целей:
- увеличение производительности обслуживания сети
- снижение аварий на сети

В **стек автоматизации** сетей Яндекса входят следующие системы:
- Ann (Аннушка)
- Comocutor
- Racktables
- BOT
- ChK
- Ck
- Grad
- Gfglister
- Alexandria (roadmap 2022)

**Принципы автомаизации**
- не навреди

Основной упор автоматизации идет на минимизацию ручного монотонного труда сотрудников эксплуатации сети. Поэтому основными направлениями развития системы является:
- устранение diff на сетевом оборудовании
- автоматизация повторяющихся действий (сценариев)

Под **diff** понимаем разницу между **ожидаемой** конфигурацией на устройстве и **реальной** конфигурацией на устройстве. Более подробно про diff можно почитать в статье [...](https://docs.yandex-team.ru/nocdoc/utils/404).

## Diff/Patch

Рассмотрим более подробно понятие **diff**. Исходя из его [определения](https://docs.yandex-team.ru/nocdoc/glossary#d1) очевидно, что необходимо иметь два объекта:
- ожидаемая кофигурация устройства
- реальная конфигурация устройства

Источником ожидаемой конфигурации устройства считаем **Аннушку**, а источником реальной конфигурации устройства является само устройство, с которого **gfglister** выгружает конфигурацию устройства. Высокоуровнево происходит следующий процесс:
1. **gfglister** получает конфигурацию и хранит в svn
2. **ann** генерирует ожидаемую конфигурацию устройства (это происходит локально на noc-ck)
3. **ChK** производит расчет разницы (diff) между реальной и ожидаемой конфигурацией устройства
4. Расчитаный diff отправляется в Mongo DB, откуда он доступен в [UI](http://noc.yandex-team.ru)

![](_images/img1.jpg)

**Причины появления diff**

Основными причинами появления diff являются:
- изменение генераторов в ann
- изменение inventory data оборудования (в racktables, netbox)
- изменение внешних для сети параметров (изменение ip адреса сервера мониторинга, ip адрес стыка с соседом и пр.)
- hotfix на сетевом устройстве
- ручные изменения на устройстве
- применение конфигурации на устройстве не из основной ветки ann

Статистику по diff на сети можно посмотреть на [графиках в Datalens](https://datalens.yandex-team.ru/myq3sqesiexog-total-cfg-diff-counts?state=c1571afe220).

В общем случае количество diff должно быть равно нулю - в этом случае сеть настроена точно так, как положено. Мы стремимся сокращать количество diff внедряя различные приемы и процессы, которые зависят от класса diff. На текущий момент выделяем несколько классов diff:
- Safe Diff,
- Unsafe Diff.

### Safe Diff

Под safe diff понимаем такой diff, устранение которого не приносит вред пользовательскому трафику и в тоже время не вызывает проблем доступа на устройство. Такие diff устраняются в автоматическом режиме. В планах на 1Q 2022 наладить устранения safe diff по расписанию для каждого ДЦ.

Для того чтобы выделить safe diff в генераторе **ann** определяется `acl_safe` в генераторе. Более детальная информация, а также инструкция по работе с safe diff приведена [статье Safe Diff](https://docs.yandex-team.ru/nocdoc/nocdev/automation/manuals/safe_diffs/about).

Так как `safe acl` запланирован к автоматическому применению на сети, то было принято решение о более жестком контроле внесения изменений в генераторы в целом. Более подробно процесс изменения генератора описан в данной статье: [Процесс изменения генератора конфигурации](https://docs.yandex-team.ru/nocdoc/nocdev/automation/manuals/gen_update/about)


### Unsafe Diff

Под unsafe diff понимаем diff, устранение которого потенциально или точно нанесет вред пользовательскому трафику или доступность устройства. Такие diff будут устраняться в специальном режиме. Roadmap на 2022 приступить к процессу устранения unsafe diff.
