# Мониторинг аномалий BGP.

@startuml
cloud "Network Devices" as devices {
}

package dc1-bmp01 {
  [pmbmpd]
  [routinator]
  [bmp_importer]
  [bmp_analyzer]
  [upflow_manager]
}

node Juggler {
}

node Solomon {
}

devices --> pmbmpd
bmp_importer -> pmbmpd
bmp_importer -> PgSQL
bmp_analyzer <--> PgSQL
bmp_analyzer -> routinator
bmp_analyzer --> Juggler
bmp_analyzer --> Solomon
upflow_manager -> pmbmpd
upflow_manager -> PgSQL

database "PgSQL" {
}
@enduml

Мониторинг BMP живёт на машинках из группы %nocdev-bmp, которые несут на борту следующие компоненты:

## pmbmpd
[Сервис][4], принимающий bmp-данные от сетевых железок(машинки-получатели прописаны в Аннушке). Пишет данные в два файла: лог и дамп. Если он ломается - bmp_importer и upflow_manager перестают получать данные для обработки, из-за чего весь воркфлоу превращается в тыкву. Данные от железок дублируются т.ч. каждая машинка получает свою копию и может работать автономно, пока есть хотя бы один живой pmbmpd - всё будет хорошо.

## routinator 
[Сервис][3], отдающий RPKI-данные. Если он ломается - вместе с ним разваливается bmp_analyzer, живущий на том же хосте т.к. последнему нужны данные из роутинатора для исследования аномалий. 

## bmp_importer
Приложение на питоне, которое парсит логи и дампы, после чего складывает их в сыром виде в базу(PostgreSQL в mdb). Имеет под капотом два треда, читающих файлы и по N парсящих тредов, если последние по каким-то причинам падают - это сказывается на производительности и может произойти ситуация, когда логи пишутся быстрее, чем парсятся. В общем случае для фикса рандомных проблем скорее всего подойдёт рестарт, но предварительно имеет смысл почитать логи дабы понять, на чём развалился проблемный тред.

Импортеры работают параллельно на всех машинках, получая на вход одинаковые данные т.ч. до тех пор пока в кластере есть хотя бы один исправный - проблем с данными быть не должно.

## bmp_analyzer
Ещё одно приложение на питоне, которое читает из базы сырые данные, анализирует их складывает результат в Solomon, Juggler и таблички с готовым данными. Имеет под капотом два суб-процесса(rtrlib, который используется для анализа данных плохо умеет в треды), один из которых анализирует логи, другой - дампы. Поломка bmp_analyzer’a приводит к тому, что данные перестают обновляться.

Способ починки - аналогичный, через чтение и осознание логов с последующим рестартом. Если будет нужно убрать дыру в графиках, связанную с падением - bmp_analyzer может быть запущен с ключиком, позволяющим начать читать данные не с текущего момента, а из прошлого.

## upflow_manager
И ещё одна питонячка, по сути это еще один обработчик дампов, выдающий "рейтинг" по размеру АС, используется для определения источника аномалии, читает линейно дамп, складывает данные в базу.


## Ссылки
[Код][1]
[Графики][2]

[1]: <https://a.yandex-team.ru/arc_vcs/noc/bmp_monitor>
[2]: <https://solomon.yandex-team.ru/?project=noc&cluster=all&service=bmp_monitor>
[3]: <https://routinator.docs.nlnetlabs.nl/en/stable/>
[4]: <http://www.pmacct.net/>
