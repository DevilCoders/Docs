# Автоматическая выкатка sls файлов (юнитов)

Текущий вариант автовыкладки сделан на уровне sls файлов.
Сюда так же входит специальный кейс с init.sls который превращает родительский каталогв в единый
стейт, за счёт чего каталог может быть подключен как один sls файл.

Юнит тут [units/auto][2]
Он подключен всем через `top.sls` вот так
```
'*':
  - units.auto.include
```

Этот юнит содержит такие части
- `include.sls` - В этот файл при рендере `jinjа`-ой дописываются sls файлы, которые подключен через pillar-ы
- `self.sls` - тут cron который обновляет сам себя и тянет все подключенные sls из `include.sls`

`self.sls` тесно интегрирован с юнитом процентной катки, который расположен тут [units/percent][1]
В этом файл находится скрипт мониторинга, который включается в том случае, если в pillar-ах какой-то из `sls` файлов помечен маркером `monitor: True`, см примеры дальше.


## Добавление sls файла в автоприменение салтом

Перед подключением необходимо хотябы один раз прогнать `highstate` на конечном хосте,
иначе на него не выкатится `units.auto.include` и дальнейшие действия не вызовут никакого эффекта.

Добавляем нужне `sls` файлы в `pillar-ы`, на примере `pillar/nocdev-valve/init.sls`
```
salt-autodeploy-sls:          # специальный ключ, по которому конфигурится юнит units.auto
  units.percent:              # произвольный sls файл, который будет деплоиться кроном  
  nocdev-valve.autodeploy:    # ещё один sls файл
    monitor: True             # специальный маркер, о том, что нужно мониторить успешность применения
                              # этого sls файла. Этот маркер работает только при использовании юнита units.percent
                              # и без него не имеет смысла и сломает стейт.
```

{% note tip %}

Обратите внимание, что `salt-autodeploy-sls` - это словарь (`dict` в питоне), и в него вложены либо пустые словари
```
  units.percent:
```

Либо словари с доп. опциями.
```
  nocdev-valve.autodeploy:
    monitor: True
```

{% endnote %}

Теперь на кластер `nocdev-valve` кроном `/etc/cron.d/salt-autodeploy` притянутся
и применятся стейты из  `sls` файлов `units.percent` и `nocdev-valve.autodeploy`.
Про маркер `monitor: True` читайте в  [документации про units.percent](./percent)


  [1]: <https://a.yandex-team.ru/arc_vcs/admins/salt-media/noc/roots/units/percent.sls>
  [2]: <https://a.yandex-team.ru/arc_vcs/admins/salt-media/noc/roots/units/auto>
