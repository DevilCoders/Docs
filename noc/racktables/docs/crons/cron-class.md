## Обертка для Мультидевайсных кронов

## Что это
Обертка (cron-class.php) нужна чтобы проще писать и запускать кроны в РТ, которые выполняют на девайсах полезную работу.  
Пример, обходить устройства и синкать с них физичесие порты в РТ.

## Описание применения
**MultideviceCron** - абстрактный класс, наследуюясь от которого нужно реализовать один метод - `Action($cell)`, где `$cell` - массив с данными по устройству из РТ (результат `spotEntity('$object', $id);`)

`Action` можно запустить на выполнение последовательно и параллельно методами `run` и `run_concurrently` соответственно.  

Результат выполения `Action` по устройству отправляется в Juggler с сервисом равным имени созданного класса.

Также, в Juggler отправляется успешность заверешения методов `run` и `run_concurrently`, и время их выполнения в Solomon.

Детали реализации в rt-yandex/plugins/cron-class.php

## Как запустить новый крон
1. Создать функцию, внутри которой определить класс-наследник от `MultideviceCron`  
Реализовать метод `Action()`, где выполнить любую полезную работу с девайсом.   
***Внутри можно использовать методы класса `SendJugglerEvent()`, `SendJugglerWithCancel()` и `statsd()` для отправки мониторинговых событий в Juggler/Solomon.***  

{% note warning %}

Пока не реализован NOCRT в Juggler - не стоит отправлять сырые события из Action. Их будет много и они не поместятся в агреграт.  
[Juggler NOCRT](https://docs.yandex-team.ru/juggler/aggregates/groups#nocrt). 

{% endnote %}

2. Создать предикат по которому будет работать Cron в `permissions` в секции Cron
3. Создать экземпляр класса с предикатом, по которому должен работать `Action`.  
4. Вызвать `$cronMyClass->run()` или `$cronMyClass->run_concurrently()`
5. Добавить вызов функции в `update-rt-crontab.sh`
6. Создать Кулебяки в `mondata` для нового Крона в `noc/mondata/kulebyaks/nocdev/nocdev-rt-multidevice-crons.yml`

Рекомендации: 
 - Нейминг файла нового крона лучше сохранять `cron-***`
 - Нейминг функции и класса-наследника лучше делать значимым и одинаковым
 - Внутри Action лучше не обрабатывать исключения подключения к оборудованию. Их отловит декоратор при запуске `run()` и отправит в Juggler.


Примеры:
- `/rt-yandex/plugins/cron-auto-sync-ports.php`
- `/rt-yandex/plugins/cron-auto-lldp-link.php`

## Примечания
- В Juggler события отправляются в namespace `Racktables`
- В Juggler отправляются события со статусом `CRIT`, внутри Action лучше отправлять со статусом `WARN`.  
- Теги Juggler'а: 
   - `['racktables', 'cron', 'multidevice_cron' '%ClassName%']`
   - \+ `'noc_responsible_***'`
   - \+ `'concurrently'` or `consequentially`
   - \+ `'cron_status'` or `cron_device`

- В Соломон события отправляются в namespace `noc`
- В Соломон отправляется:
  - Время выполнения операции
  - Количество успешных девайсов
  - Количество сфейленных девайсов

