# 802.1x псевдо-VTP

## Что это
Мотивацией для доработки RT-плагина 802.1q послужили следующие причины:
* Распространение vlan с помощью Cisco VTP не подходит для использования на коммутаторах Huawei
* Состав и настройки Vlan существенным образом зависят от имплементации 802.1x
Фича 802.1Х в этом месте исторически была сделана через подкапотный вызов аннушки для генерации патча.
Теперь RT умеет управлять 802.1X самостоятельно.

## Управление поведением
### Теги
Появилось 4 новых тега:

#|
|| Tag | Описание ||
|| `{802.1Q vtp}` |
Если повесить на vlan-домен, то все коммутаторы этого домена будут обрабатываться новой логикой RT.
Ожидается, что к моменту проставления этого тега, для всех вланов, которые должны присутствовать на всех коммутаторах
проставлен режим `permanent`. Вланы, которые должны создаваться и удаляться в зависимости от своего наличия на портах
должны иметь режим `auto`.

Если тег повесить на отдельный коммутатор, то он так же начнет управляться новой логикой RT.

Так же тег включает проверку количества вланов в домене, и проверку присутствия всех нужных для работы 802.1X групп в списке
вланов домена. Проверки описаны в `scripts/check-8021q-vtp.php`.
||
|| `{802.1Q vtp auto}` |
Так же вешается на vlan-домен или коммутатор вместо `{802.1Q vtp}` и разрешает еще и автоматическое удаление влана
с коммутаторов. В основном предназначен для безопасного перехода на новую схему.
||
|| `{skip 802.1Q vtp}` |
Вешается на коммутатор, отключает на нем новую логику и включает старую через аннушку
||
|| `{skip 802.1Q vtp clean}` |
Вешается на коммутатор, запрещает удалять вланы домена с коммутатора. Нужен для случая `{802.1Q vtp auto}` на домене при
желании запретить удаление вланов на конкретном коммутаторе.
||
|#

### Настройки
- `8021X_AUTO_PERMANENT` - если установить в `yes` включит возможность автоматического перевода вланов в permanent
- `8021X_AUTO_PERMANENT_LIST` - RackCode, для доменов попадающих в него автоматически поменяется тип всех вланов на permanent.
   Предполагается что это будет`{802.1Q vtp auto}`.

### Cron
`check-8021q-vtp.php` - запускается по крону раз в час, пишет в логгер `rt-cron.check-8021q-vtp`
Можно запустить руками с `--dry` и посмотреть что будет. Отправляет сырые события `check_8021q_vtp_{$vdomid}` и
`check_8021q_vtp_{$vdomid}_obj_{$switch['id']}` в Juggler.

### Примечания
В RT есть фича "чужих" вланов, но она в незапамятные времена отключена пилотом для выбора в интерфейсе.
Если влан в домене разметить таким образом, то он будет игнорироваться логикой диффа, его нельзя будет добавить или убрать как allowed,
порты, на которых он native, тоже нельзя будет поменять через интерфейс.
