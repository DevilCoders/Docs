# Поддержка PDU в RT

## Назначение
Поддержка PDU состоит в умении RT определять Power-интерфейсы на PDU и документировать их в RT
Дополнительно для PDU реализован хак, который позволяет линковать порты PDU по указанному reservation_comment

## Описание
 Поддержка реализована в двух частях:
 - `sync-ifaces.php`
 - `pdu.php`

### sync-ifaces.php
 В `sync-ifaces.php` реализован поиск интерфейсов через `snmp`, составление имени и документирование (создание) Power-порта в RT.
 Кратко, поиск интерфейсов осуществляется по snmp `` oid'ам:
 - `.1.3.6.1.4.1.13742.6.3.5.3.1.2.1` (port id)
 Возвращает `STRING: "1"`
 - `.1.3.6.1.4.1.13742.6.3.5.3.1.29.1` (socket type)
 Возвращает `STRING: "IEC 60320 C13"`
 - `.1.3.6.1.4.1.13742.6.3.5.3.1.33.1` (Circuit OID)
 Возвращает `OID: .1.3.6.1.4.1.13742.6.3.4.3.1.2.1.1`
 - `.1.3.6.1.4.1.13742.6.3.4.3.1.2.1` (Circuit Number)
 Возвращает `STRING: "C1"`


 После дискаверинга создает интерфейсы с именем равным `id`, и 'Visible Label' равным типу розетки и цепи питания. (Если порт уже создан, ничего не делает)

### pdu.php
 В `pdu.php` реализована поддержка кнопки линковки по `reservation_comment`.
 Кнопка появляется в `object->ports` только для устройств с `$breed == 'raritan'`
 Поведение следующее:
 - Если порт слинкован - ничего не делать
 - Если у порта не заполнено поле `reservation_comment` - ничего не делать
 - Если `reservation_comment` заполнено, то осуществляется поиск в РТ объекта по полям: `Name`, `Label`, `Asset No`, `FQDN`.
 - Если по значению в поле `reservation_comment` найдено больше одного устройства - ничего не делать
 - Если устройство найдено и оно одно, то дальше проверяется наличие и количество Power Port'ов на удаленной стороне
   - Если портов нет - создается Power Port на удаленной стороне и линкуется с ним
   - Если порты есть и хотя бы один свободен - линкуется с первым попавшимся
   - Если порты есть и заняты, то если их не больше 2х (`MAX_POWER_PORTS`), можно создать новый
   - Если power-портов на удаленной стороне 2х и больше и свободных нет - ничего не делать


### linker.php
 В `linker.php` добавлены хаки для корректной и удобной линковки PDU
 1) Если порт на стороне PDU с типом `AC-OUT` и установлен флаг `*` для создания интерфейса на стороне **b**, то на удаленной строне создается интерфейс с типом `AC-in` для возможности корректной линковки
 2) Если объекта **b** не существует, то у объекта **a** у указанного порта будет оставлен `reservation_comment` с указанием объекта на стороне **b** для документации в тексте и возможности последующей линковки после появления в РТ объекта **b**
 3) Если указан только объект и порт **a** и только объект **b** без указания порта **b**, то будет оставлен `reservation_comment`, для последующей линовки с помощью кнопки из `pdu.php`

### Ожидаемый пайплайн использования:
PDU в Racktables уже добавлен
1) Запустить синк интерфейсов по кнопке во вкладке `object->ports`
2) Через Linker в `Служебный вход -> Link Ports` добавить `reservation_comment` к портам PDU
3) Во вкладке `object->ports` для PDU прилинковать устройства по `reservation_comment`


### Release Notes
#### 05.2022
- Добавлена поддержка Raritan в `sync-ifaces.php`
- Добавлена кнопка линковки по `reservation_comment` для `breed == 'raritan'`
- Добавлены хаки для `linker.php`
