# Deploy

## Как катить

Здесь краткая выжимка. Подробности как это устроенно описаны ниже. Шаги, описаные *italic*, приведены для понимания, часто могут быть опущены.

1. Замерджить все изменения, планируемые к катке, в мастер.
1. *[Тут](https://a.yandex-team.ru/reviews/incoming?filter=open(true)%3Bauthor(robot-nocdev-ci)&sort=-updated_at) находим и следим за состоянием PR.*
1. *После мерджа релиз начнется автоматически, если нет - нужно запустить руками [тут](https://a.yandex-team.ru/projects/nocdev/ci/releases/timeline?dir=noc%2Fracktables%2Frt-yandex%2Fdebian&id=rt-release).*
1. После выкатки на `prestable` надо проверить насколько хорошо он работает. Смотреть за прогрессом надо из релиза, который можно найти [тут](https://a.yandex-team.ru/projects/nocdev/ci/releases/timeline?dir=noc%2Fracktables%2Frt-yandex%2Fdebian&id=rt-release). 
1. Если все ок - нажимаем в релизном пайплайне `play` на катке в `stable` и ждем появления тикета в кондукторе. `Create gitlab release` иногда фейлится с кодом 28, это какой-то непонятный артефакт CI, надо просто перезапустить.
1. Аппрувим тикет.
1. Ждем.
1. Profit!

## Под капотом

Катка RT собрана на двух CI - гитлабном и аркадийном. Последний начал использоваться для того, чтобы переиспользовать уже имеющиеся кубики к кондуктору, инфре и вообще быть ближе к переезду в аркадию.

### Gitlab CI
`.gitlab-ci.yml`

Для ветки `master` в нем происходит проверка стиля, запуск стейджинга, сборка и загрузка в репозиторий пакетов для debian и freebsd, сборка докер-образов, синхронизация части репозитория в аркадию для выкладывания документации и запуска уже аркадийного CI.

#### Синхронизация в аркадию

Поскольку пакет собирается в гитлабе и версия определяется тегами на ветке `master` и коммитом, на котором происходит сборка, то эти данные выгружаются в файлы и отправляются в аркадию.
    - `debian/version`      - версия пакета и релиза
    - `debian/ci.changelog` - изменения с последнего релиза
    - `debian/ci.commit`    - sha коммита в репозитории

### Аркадийный CI

По мерджам в `trunk` создается и выкатывается релиз. Катка на `prestable` автоматическая без подтверждений. Происходит через создание тикета в кондукторе и ожидание его выкладки. 
 
 Для попадания релиза в `stable` уже надо проверить работоспособность на `prestable` и нажать `play` на шаге выкладки в стейбл. Далее CI заведет событие в инфре и создаст кондукторный тикет. Потом на переданном коммите (`sha`), создает релиз в гитлабе, в описание которого помещается список измменений, номер релизного пайплайна из аркадийного CI и другая полезная информация. После CI будет ждать выкладки кондуктором (**пока тикет надо одобрять руками**) пакетов на linux-ноды RT. И, наконец, на bsd-нодах гитом привезет изменения, помеченные номером релиза. **При этом, если в рабочей копии были локальные изменения, то они будет помещены в stash**.

## Полезные ссылки

- [Релизы в гитлабе](https://noc-gitlab.yandex-team.ru/nocdev/racktables/-/releases)
- [Список открытых PR робота](https://a.yandex-team.ru/reviews/incoming?filter=open(true)%3Bauthor(robot-nocdev-ci)&sort=-updated_at)
- [Страница релизов в Аркадийном CI](https://a.yandex-team.ru/projects/nocdev/ci/releases/timeline?dir=noc%2Fracktables%2Frt-yandex%2Fdebian&id=rt-release)