## Netmap

### Что это

`Netmap` - это набор скриптов для сбора и формирования выгрузок информации о подключенных конечных узлах сети.
Файлы выгрузок импортируются в БД `netmap` на мастере RT, раздаются через
[ro RT](https://ro.racktables.yandex.net/export/netmap/) и [noc-export](http://noc-export.yandex-team.ru/rt/netmap/) всем имеющим дырки.
При прочих равных стоит отдавать предпочтение `noc-export`, как более отказоустойчивому сервису, он просто раздает статику, но может отставать.

На всех нодах RT netmap находится в `/netmap` и из `/www/export/netmap` созданы символические ссылки на те файлы, которые необходимо раздавать наружу.
Код скриптов лежит в директории `netmap` репозитория [racktables](https://noc-gitlab.yandex-team.ru/nocdev/racktables).

В тексте ниже пути к файлам исходников даны относительно корня репозитория `racktables`.

Каждая инсталяция `netmap` может работать либо как мастер, либо как слейв. Режим слейва лишь копирует с помощью `rsync` готовые
выгрузки с мастера. Режим определяется наличием файла `~racktables/netmap-master`.
Источник готовых файлов, который используется для копирования, задается в `~racktables/netmap-sync` на слейв-ноде. Поведением `rsync` можно немного управлять через `netmap/rsync_include` и `netmap/rsync_exclude`.

Основное действо (`netmap/DO_netmap.sh`) происходит на мастере и состоит из следующих основных шагов:

- подготовка списка устройств
- построение списка портов и состояния вланов на них (ports.txt)
- построение списка портов, их типа и линка для некоторых коммутаторов в DC (racktables-portlist)
- получение информации от контроллеров точек доступа
- получение информации от девайсов (коммутаторов, роутеров и точек доступа) по ip, arp, соседям
- построение L12* файлов
- построение IntStatus
- построение L123* файлов
- загрузка в БД `netmap`

При получении данных от девайсов логи общения сохраняются в `/netmap/cmlogs.$curdate/`, сырые данные в `/netmap/rawdata.$curdate/`,
статус портов - `/netmap/int-status/`
`$curdate` выставляется в значение времени запуска `netmap/DO_netmap.sh` и добавляется ко всем именам файлов, которые создаются во время выполнения (промежуточный выхлоп, исторические файлы, журналы, etc).

Данные в таблицах БД `netmap` правит так же несколько запчастей `cfglister`, см. `scripts/mac-learning-handler.php` и `maclearning.queue` в `cfglister` (`/usr/local/cfglister` на ноках).

На ноябрь 2021 года роль мастера может выполнять только FreeBSD-машины RT - `noc-sas` или `noc-myt`.

### Выгрузки

Важная информация:
1) Формат выгрузок важен: в части выгрузок столбцы разделены символом табуляции, в части - пробелом.
2) Выгрузки формируются в том числе на основе данных с кешей свичей/маршрутизаторов.
При отсутствии актуальной информации в кешах (протухание записей, переполнение, атака злоумышленника)
выгрузки netmap'а могут отличаться от реальной топологии сети.
Однако использование LLDP уменьшает риск появления подобных проблем.
3) Выгрузки содержат информацию о подключенных устройствах в данный момент, а также за последние несколько дней.
Если в течение продолжительного времени (несколько дней) устройство не присутствует в выгрузке
или нам не удается получить информацию о нем (например, свитч недоступен),
тогда информация о подключенном устройстве исчезнет из выгрузок.
За доступность и работоспособность всех устройств ответственны другие компоненты.

```bash
$ grep -l $'\t' *
L12.f
L23
L23.t
L23.v46
L23.v6
ap-bssid-export
portconf
ports.txt

$ grep -vl $'\t' *
IntStatus
L12.fv
L12.fvt
L123
L123.v46
L123.v6
L123r
L123r.v46
L123r.v6
L12_walle.fvt
L3.equiv
L3.equiv.v46
L3.equiv.v6
```

Для парсинга кодом на питоне часто используется такая конструкция:

```python
if '\t' in line:
 ...
else:
 ...
```

#### ap-bssid-export

Список точек доступа, BSSID на них, режим работы и контроллер.

Формат строки (разделитель - таб):
1) fqdn точки доступа
2) BSSID точки доступа, он же mac адрес
3) SSID, имя сети
4) полоса (a - 5GHz, b - 2GHz)
5) profile - почти всегда совпадает с SSID. Возможно, настройки безопасности. TODO: уточнить в будущем.
6) fqdn контроллера. Или прочерк("-"), если таковой отсутствует.

Варится `Makefile.getdata -> wl-ap-portlist.php -> wl-ap-portlist -> .`

[NOCDEV-4793](https://st.yandex-team.ru/NOCDEV-4793)

#### IntStatus

Состояние Up/Down портов.

Формат строки (разделитель - пробел):
1) port подключения: канонизированное имя порта (начало fqdn + сокращенное имя порта).
2) статус (connected/notconnect/disabled)

`int-status/* -> .`

#### L12.fvt

Список из устройств (как физических, так и виртуальных) и
информации об их подключении к сети яндекса.
Устройство может иметь несколько интерфесов и использовать несколько vlan'ов,
в этом случае mac будет присутствовать несколько раз.
Собирается из таблиц MAC адресов на свичах.

Примечание:
1) при учете исторических данных, мы добавляем только те mac'и,
которые не присутствовали в более свежих выгрузках.
2) Иногда устройства подключены в железки, с которых мы не можем собирать информацию.
В этом случае точкой подключения считается порт ближайшего "умного" устройства.

Формат строки (разделитель - пробел):
1) mac устройства
2) vlan в котором находится mac
3) port подключения: канонизированное имя порта (начало fqdn + сокращенное имя порта).
4) timestamp когда мы последний раз наблюдали этот mac.

```
rawdata/*.L12 -> L12
 -> выкидывает порты из blacklist, повторы,
    выбирает порт с минимальным количеством маков
 -> L12.fv.$curdate
 ```

`L12.fv.$curdate + history -> .`

#### L12.fv

TLDR: `L12.fvt -> .`

Выгрузка аналогична L12.fvt (собирается тоже из неё), только без timestamp'а.

Формат строки (разделитель - пробел):
1) mac устройства
2) vlan в котором находится устройство
3) port подключения: канонизированное имя порта (начало fqdn + сокращенное имя порта).

#### L12.f

TLDR: `L12.fv -> .`

Выгрузка аналогична L12.fv (собирается тоже из неё), только без vlan'а.

Формат строки (разделитель - пробел):
1) mac устройства
2) port подключения: канонизированное имя порта (начало fqdn + сокращенное имя порта).

#### L12_walle.fvt

Костыль для преобразования `swname-old` -> `swname` в целях упрощения жизни walle пока идет наливка нового коммутатора.
Формат совпадает с L12.fvt.

[NOCDEV-5317](https://st.yandex-team.ru/NOCDEV-5317)

#### L23.t

TLDR: `rawdata/*l23 -> + history -> .`

Список из ip устройств и их mac'ах, подключеных к сети яндекса.
Собирается из arp/ndp кешей на маршрутизаторах, которые предварительно записываем в файлы rawdata/*l23,
и исторических данных.

Примечание: при учете исторических данных, мы добавляем также присутствующие ранее пары (ip, mac).

Формат строки (разделитель - таб):
1) ip устройства
2) mac устройства
3) timestamp когда последний раз видели устройство с этим ip.

#### L23 и его симлинки L23.v46 L23.v6

TLDR: `L23.t -> .`

Выгрузка аналогична L23.t (собирается тоже из неё), только без timestamp'а.

Формат строки (разделитель - таб):
1) ip устройства
2) mac устройства

#### L123 и его симлинки L123.v46 L123.v6

TLDR: `L12.f + L23 -> .`

Информация об устройствах присутствующих в обеих выгрузках L12.f и L23 (собирается из них же).

Формат строки (разделитель - пробел):
1) port подключения: канонизированное имя порта (начало fqdn + сокращенное имя порта).
2) ip устройства
3) mac устройства

#### L123r и его симлинки L123r.v46 L123r.v6

TLDR: `L123 -> dns resolve -> .`

Выгрузка полученная из L123 dns резолвом ip устройств.

Формат строки (разделитель - пробел):
1) начало fqdn свича к которому подключено устройство.
2) сокращенное имя порта
3) mac устройства
4) ip устройства
5) fqdn устройства или пустая строка если не удалось разрезолвить.

#### L3.equiv и его симлинки L3.equiv.v46 L3.equiv.v6

TLDR: `L23 -> .`

Список ip адресов, mac'и устройств которых одинаковы.
Если устройство имеет только 1 ip адрес, тогда оно не присутствует в этой выгрузке.
Получается из L23.

Формат строки (разделитель - пробел):
1) список ip'шников, у которых одинаковые mac адреса.
2) пробел в конце строки

#### ports.txt

TLDR: `ports.txt -> .`

Информация по настройке портов, содержащаяся в RT.

Формат строки (разделитель - таб):
1) port подключения: канонизированное имя порта (начало fqdn + сокращенное имя порта).
2) настройки порта: тип подключения и vlan'ы.
3) роль порта, возможные значения: trunk, access, uplink, downlink, none
4) remote port

Примечание:
в настройках порта могут присутствовать фейковые vlan'ы,
которые являются псевдонимами для различных костылей (например 13000 для 802.1x костылей)

#### portconf

Конфигурация портов. Получается из ports.txt

Формат строки (разделитель - таб):
1) port подключения: канонизированное имя порта (начало fqdn + сокращенное имя порта).
2) настройки порта: тип подключения и vlan'ы.

#### frtrlist.txt

legacy, список non-vendor маршрутизаторов. Скорее всего уже нигде не используется.
И совершенно точно не обновляется.
