## Особенности huawei и его поддержки

### Пароли и их хеши
Для управления учётными записями локальных пользователей на сетевых устройствах необходимо уметь решать 3 задачи:
* знать вариации хеша для пароля и уметь их генерировать (generate),
* уметь сравнивать вариации хэша для одного пароля (report),
* уметь добавлять на устройства новые пароли в виде совместимого хэша (deploy).

Huawei делает эти задачи нетривиальными. В данном случае не найдено нормальной MOP документации.
Простой хеш мы можем генерить самостоятельно, остальные пока только на девайсах. Хорошего решения пока нет, массово мы
можем менять пароли только на некоторой части хуавеев.
На начало 2022 года на нашей сети используются ([{#T}](../scripts/gen-hashes.md)) хуа как минимум с такими вариантами хешей:
- `cipher ...!!`
    Это тот первый хеш из `HUAWEI_USER`, но на некоторых девайсах он воспринимается
    как plain-text пароль. Его мы умеем генерить самостоятельно.
- `irreversible-cipher %@%@...%@%@`
    По идее `cipher ...!!` может быть как-то сконвертирован в этот, но эксперименты к успеху не привели
- `irreversible-cipher %^%#...%^%#`
- V200R009C00SPC500
- `irreversible-cipher $1a$...$`
- `irreversible-cipher $1b$...$`
- `irreversible-cipher $1c$...$`
    алгоритм - scrypt, второй хеш из `HUAWEI_USER`, по идее может быть установлен напрямую через
    `local-user <name> irreversible-cipher $1c$...$` вместо a и b хешей.
- `irreversible-cipher $1d$...$`
    Примерно с `V300R020` попытка установки `$1c$..$` приводит к `Error: The old version password is not supported.`
    Пока непонятно что это за хеш и как с ним быть.



### Поддерживаемые типы хэшей
> Информация получена от поддержки Huawei и нуждается в проверке на оборудовании

Для генерации предлагается использовать реальное оборудование.
#### S.* (Campus Switches)
по-умолчанию используются следующие типы hash:
* версии V2R10 до V2R13:`$1a$...$`
* версии V2R19 до V2R21:`$1c$...$`, но совместимы с `$1a$...$`

master-key не меняется динамически.

#### CE.* (CloudEngine)
по-умолчанию используются следующие типы hash:
* версии V2R5C10: `$1c$...$`
* версии V2R19C10: `$1c$...$`
* версии V3R20C00: `$1b$...$`
* версии V3R20C10+: `$1d$...$`

#### [root key | master key]
Origin: https://st.yandex-team.ru/NOCDEV-4481

В версиях VRP, начиная с V300.*, изменилось поведение для генерации irreversible hash.

По-умолчанию при каждой перезагрузке имзменяется **master-key**(он же root-key).
Но если настроить свой master-key, то hash будет неизменным, а также будут приниматься более старые типы hash.

Наша политика в отношении master-key описывается следующим образом:
```python
if (version >= 'V3R20C10'):
    if master_key = 'user-defined':
        supported_hashes = "all"
    else:
        set_master_key()
```


