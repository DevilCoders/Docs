# Текущее состояния
Сейчас подсистема кэшей для rtapi/invapi реализована в рамках самого воркера. Некоторые запросы поддерживают частичную инвалидацию кэшей в рамках воркера, но этим можно пренебречь. В большинстве случаев задержка между записью изменений и получением этих изменений через API в основном зависит от времени жизни воркеров.

![Current state](images/rt_cache_current.jpeg "RT Cache current state")

# Краткосрочные планы
Для снижения задержки в получении обновлённых данных в краткосрочных планах планируется реализовать 2 вещи:
1. Заменить время жизни воркера invapi на единичное исполнение воркера. Благодаря GraphQL в большинстве случаев для получения всех необходимых данных достаточно выполнить единичный запрос. На первых этапах внедрения это должно позволить не использовать кеши между запросами, из-за их сравнительно не большого количества и использовать кеши воркера только в рамках выполнения конкретного запроса.
2. Для rtapi начать отслеживать binlog MySQL на предмет изменений в таблицах, содержащих требовательных к задержке обновления данные (объекты, тэги, etc) и порождать событие о необходимости инвалидации кэша. Реализацию инвалидации предполагается сделать максимально упрощённой – в виде перезапуска пула воркеров.

![Short term plan](images/rt_cache_short_plan.jpeg "RT Cache short term plan")

Данные изменения, должны позволить значительно снизить задержку в получении обновлённых данных принеся в жертву вычислительные ресурсы, затрачиваемые на перезапуск воркеров и построение свежих кэшей в них.

# Среднесрочные планы
После решения проблемы с получением устаревших данных предполагается приступить к оптимизации кэшей RT. А именно:
1. Организовать глобальный (общий) кэш для всех воркеров, работающих в рамках одного узла. Кандидаты для реализации пока не определены.
2. Постепенно рефакторить функции РТ для использования и обновления общего кэша вместо локального.
3. Начать разделять события об обновлении данных для сброса пула воркеров и сброса глобального кэша
4. Начать более точечно выделять события, позволяющие производить частичную инвалидацию глобального кэша вместо его полного сброса.

![Long term plan](images/rt_cache_long_plan.jpeg "RT Cache long term plan")

После успешного внедрения глобальных кэшей и механизмов их инвалидации для rtapi можно будет рассмотреть возможность вынесения этих механизмов в самостоятельную сущность и использованию её для invapi и других компонентов RT.

