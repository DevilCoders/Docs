# Puncher
Панчер  - это система управления правилами файрвола. В этом репозитории лежит её backend-часть.

## Быстрые ссылки

- Веб-интерфейс:
    - [prod](https://puncher.yandex-team.ru)
    - [unstable](https://puncher-unstable.yandex-team.ru)
- [Пользовательская документация](https://wiki.yandex-team.ru/noc/nocdev/puncher/Spravka/), а также [FAQ](https://wiki.yandex-team.ru/noc/nocdev/puncher/FAQ/)
- [Консольный клиент](https://wiki.yandex-team.ru/noc/nocdev/puncher/konsolnyjj-klient/)
- [Репозиторий с веб-фронтендом](https://github.yandex-team.ru/data-ui/puncher)
- [Sandbox scheduler для сборки пакетов из аркадии](https://sandbox.yandex-team.ru/scheduler/20235/view)

## Устройство Панчера коротко
Панчер хранит правила файрвола в своей MongoDB. Периодически (раз в несколько минут) он выгружает их во внешние репозитории, откуда они уже разъезжаются по файрволам.

В правилах можно использовать хосты, сетевые макросы, пользователей, группы пользователей, роли в ABC и другие сущности. Все их Панчер периодически подтягивает из внешних систем.

Для создания / изменения / удаления правила заводится заявка, которая должна быть подтветрждена, чтобы изменение произошло. Панчер [определяет](https://clubs.at.yandex-team.ru/noc/2916) пользователей, ответственных за заявку. Некоторые заявки требуют несколько этапов подтверждения: сначала ответственные, потом коллеги из СИБ. Весь жизненный цикл заявки отражает в привязанном тикете в Страртреке, там же идёт всё обсуждение.

Некоторые правила приезжают в Панчер из внешних систем, например, из CAuth. Они видны в интерфейсе, но их нельзя редактировать.

Также Панчер периодически проходится про своим правилам и заявках и приводит их в порядок: актуализирует ответственных, удаляет неактуальные правила и т. п.

Всё это сделано через несколько микросервисов, которые общаются между собой, кидая друг в друг JSON'ы через HTTP.

## Структура кода
- В `cmd/` лежит код микросервисов.
- В `models/` лежат структуры и объекты, общие для всех микросервисов. Например, `Rule`, `Request` т. п.
- В `client/` лежат клиенты для общения с микросервисами или внешними системами.
- В `lib/` лежит всякий вспомогательный код, ничего не знающий о бизнес-логике Панчера.

## Существующие микросервисы
### daemon
Открытое наружу HTTP API. Служит прослойкой перед другими микросервисами.

### rulesd
Хранилище правил, позволяет их искать, создавать и редактировать. Никуда не ходит, ничего кроме этого не делает.

### usersd
Хранилище таргетов: возможных источников и назначений для правил. Периодчески ходит за ними во внешние системы: Staff, IDM, SVN динамического файрвола, LDAP. Информацию о сетевых макросах берёт из `macrosd`. Наружу отдаёт информацию о таргетах, знает об иерархии таргетов.

### macrosd
Хранилище информации о сетевых макросах и секциях файрвола. Подтягивает её из [Racktables](https://racktables.yandex-team.ru/). Также отвечает за определение ответственных. За ответственными за хосты ходит в Голем, за пользователями ходит в `usersd`.

### requestsd
Хранилище заявок. Позволяет их искать, создавать и редактировать. Пишет изменения заявки в Стартрек. В случае подтверждения заявки применяет изменеия в `rulesd`.

### exportd
Периодчески выгружает правила и таргеты в CVS (статический (серверный) файрвол) и SVN (динамический (пользовательский) файрвол). За правилами ходит в `rulesd`, за таргетами - в `usersd`.

### importd
Периодески проходится по всем правилам (из `rulesd`) и заявкам (из `requestsd`) и приводит данные в них в соответствие данным из `usersd` и `macrosd`. Если изменение требует ручного подтверждения, создаётся автозаявка через `requestsd`.

### rules-cauth
Периодически забирает информацию о правилах из CAuth и CVS, подготавливает Панчеровские правила, записывает их в `rulesd`.

### st-watcher
Периодически ходит в Стартрек и проставляет (через `requestsd`) заявкам флаги о том, что заявка обсуждается с СИБ или ответственными.

### puncher-config, puncher-info
Сервисы для мониторинга. Дампят конфиг и отдают всякие метрики. Вызываются [из мондаты](https://noc-gitlab.yandex-team.ru/nocdev/mondata/-/blob/master/discovery/puncher.py).

## Выкатка
Катится [через CI](https://a.yandex-team.ru/projects/nocdev/ci/releases/timeline?dir=noc%2Fpuncher&id=puncher-release).
