# Анонс сервиса

После того, как вы создали новый сервис или изменили конфигурацию существующего, необходимо доставить новые настройки конфигурации до L3 балансеров. Этот процесс называется _деплоем конфигурации_. Деплой конфигурации происходит в несколько этапов. В процессе деплоя:

1. L3 manager тестирует, сохраняет в Git и доставляет до L3 балансеров новую конфигурацию.
1. L3 балансеры проверяют доступность рилов виртуальных серверов.
1. L3 балансеры объявляют о новой конфигурации вашего сервиса в сети.

Объявление о доступности сервиса в сети называется _анонсом_. Логика анонса задается на этапе [настройки виртуального сервера](config-settings.md). В зависимости от заданной логики балансеры самостоятельно анонсируют или снимают сервис с анонса.

В интерфейсе L3 manager активная конфигурация анонсированного сервиса имеет следующие признаки:

- Конфигурация находится в [статусе](#conf-stat) «Active». Статус конфигурации указан в поле **State**.
- Описание статуса конфигурации — «Updated state "DEPLOYING" -> "ACTIVE"». Описание указано в поле **Description**.
- Балансеры сервиса находятся в [статусе](#belencer-stat) «ANNOUNCED». Балансеры сервиса указаны в столбце **Load balancers**.
- Рилы сервиса отвечают на [проверки доступности](checks.md) от L3 балансеров. Количество успешных ответов указано в столбце **Resolved RSs**.

![image](../_assets/active-config.png =600x270)

## Статусы конфигурации {#conf-stat}

В процессе деплоя конфигурация проходит следующие этапы:

#|
||**Статус конфигурации**|**Поле Description**|**Описание**|**Следующие статусы**||
||NEW|Created new config|Статус новой конфигурации или статус конфигурации после внесения изменений (например, добавления нового виртуального сервера).|PREPARED||
||PREPARED|Created new config|Начальный статус при деплое конфигурации.|TEST_PENDING||
||TEST_PENDING| |Конфигурация стоит в очереди на тестирование.|TESTING||
||TESTING| |Конфигурация тестируется. На этом этапе всем виртуальным серверам конфигурации назначаются тестовые балансеры, которые можно увидеть в поле **Load balancers** блока **Virtual servers**.|- TEST_SUCCESS
- TEST_FAIL||
||TEST_SUCCESS|Updated state "TESTING" -> "TEST_SUCCESS"|Тестирование пройдено успешно.|VCS_PENDING||
||TEST_FAIL| |Тестирование не пройдено.|Конечный статус.||
||VCS_PENDING| |Конфигурация стоит в очереди на сохранение в Git.|TEST_SUCCESS||
||VCS_UPDATING|Updated state "TEST_SUCCESS" -> "VCS_PENDING"|Конфигурация сохраняется (коммитится) в Git.|- VCS_COMMITTED
- VCS_FAIL||
||VCS_COMMITTED|Updated state "VCS_UPDATING" -> "VCS_COMMITTED"|Конфигурация сохранена в Git.|PENDING||
||VCS_FAIL| |Ошибка при коммите. Список ошибок приведен в разделе [Возможные ошибки](troubleshooting.md).|Конечный статус.||
||PENDING| |Конфигурация стоит в очереди на деплой.|DEPLOYING||
||DEPLOYING|Updated state "VCS_COMMITTED" -> "PENDING"|Конфигурация деплоится. На этом этапе всем виртуальным серверам конфигурации назначаются [L3 балансеры](#belencer-stat).|- ACTIVE
- FAIL||
||ACTIVE|Updated state "DEPLOYING" -> "ACTIVE"|Деплой прошел успешно, конфигурация была доставлена до L3 балансеров.|Конечный статус. При деплое другой конфигурации статус сменится на INACTIVE.||
||FAIL| |Ошибка при деплое конфигурации. Список ошибок приведен в разделе [Возможные ошибки](troubleshooting.md).|Конечный статус.||
||INACTIVE| |Конфигурация отключена.|Конечный статус. При повторном деплое конфигурации статус изменится на PREPARED.||
|#

## Статусы L3 Балансеров {#belencer-stat}

После того, как статус конфигурации будет изменен на «DEPLOYING», начнется деплой конфигурации на L3 балансеры. Статусы балансеров:

- COMMITED — начальный статус L3 балансера. Конфигурация была сохранена в Git и ожидает деплоя. В интерфейсе L3 manager балансер выделен серым цветом.
    
- ACTIVE — конфигурация была доставлена до балансеров. В интерфейсе L3 manager балансер выделен желтым цветом.
    
    Как только L3 балансер получит [ответ от рилов](checks.md), он перейдет в статус ANNOUNCED. Тестовый балансер не переходит в данное состояние.
    
- ANNOUNCED — балансер получил ответ от рилов виртуального сервера. Анонс сервиса прошел успешно, балансер готов получать трафик от пользователей. В интерфейсе L3 manager балансер выделен зеленым цветом.
    
    В столбце **Resolved RSs** будет отображено количество рилов, умноженное на количество балансеров. Например, если была указана группа кондуктора с 2 рилами, и все 8 балансеров получили ответы только от одного из рилов, в поле **Resolved RSs** будет видна запись **RS states 8/16**.
    

Если необходимо обновить информацию о состоянии балансеров, используйте кнопку **Update states**→**OK**. Эта кнопка создает внеочередную задачу на обновление. Кнопка **Refresh** обновляет только отображение статусов в интерфейсе L3 manager.

