# Решение проблем

## Ошибки в процессе деплоя конфигурации {#concept_y4x_ytt_5fb}

### GitCommandError... Could not read from remote repository {#section_xj3_hwv_qfb}

Возможная причина — отсутствие доступа к Git на стороне L3 manager.

Повторите деплой конфигурации спустя некоторое время. Если проблема повторилась, напишите [команде L3](mailto:slb@yandex-team.ru).

### Exception('Inconsistent GIT state',) {#section_ey3_hwv_qfb}

Ошибка с Git на стороне L3 manager. Напишите [команде L3](mailto:slb@yandex-team.ru).

### Exception('VS: 49201; Expected: 1; Actual: 0',) {#section_aqj_hwv_qfb}

Ошибка возникает, если при деплое конфигурации часть рилов не прошла [проверки доступности](checks.md#rs-checks).

Если несмотря на это вы хотите выкатить конфигурацию, в списке конфигураций нажмите кнопку ![image](../_assets/config-options.png) → **Force deploy**.


## Пользовательский трафик не поступает на рилы {#concept_cfd_wtt_5fb}

Если конфигурация виртуального сервера [успешно выкачена](quickstart.md), но ваш сервис не получает трафик от пользователей, вы можете самостоятельно выполнить диагностику. Для этого зайдите на любой из рилов вашего сервиса и выполните следующие действия:

[Проверьте наличие балансерных запросов](#section_srb_2wt_5fb)
[Проверьте наличие входящих пакетов на IP-адрес виртуального сервера](#section_lk1_gwt_5fb)
[Проверьте наличие исходящих пакетов](#section_a5f_jwt_5fb)

О результатах диагностики напишите [команде L3](mailto:slb@yandex-team.ru).

### Проверьте наличие балансерных запросов {#section_srb_2wt_5fb}

Убедитесь, что L3 балансеры корректно отправляют запросы с [проверками доступности](checks.md):

1. Узнайте адрес вашего физического интерфейса. Для этого выполните команду `host <адрес вашего рила>`. Команда выведет IP-адрес вашего сервиса:
    
    ```
    <адрес вашего рила> has IPv6 address 2a02:6b8:0:1482::115
    ```
    
1. Узнайте название вашего физического интерфейса с помощью команды `ip -o address show|fgrep <IP-адрес вашего сервиса>`:
    
    ```
    2: eth0    inet6 2a02:6b8:0:1482::115/64 scope global \       valid_lft forever preferred_lft forever
    ```
    
1. Выполните команду `tcpdump -np proto ipencap or proto 41 -i <название вашего физического интерфейса>`:
    
    {% cut "Пример дампа трафика" %}
    
    ```
    15:47:31.103869 IP6 2a02:6b8:0:1a1a:428d:5cff:0:ba26 > 2a02:6b8:0:1482::115: IP6 2a02:6b8:b000:164:428d:5cff:fe34:f932.53052 > 2a02:6b8:0:3400::5015.443: Flags [S], seq 4172935825, win 26550, options [mss 1220,sackOK,TS val 160230032 ecr 0,nop,wscale 8], length 0
    15:47:31.117746 IP6 2a02:6b8:0:1a1a:428d:5cff:0:ba26 > 2a02:6b8:0:1482::115: IP6 2a02:6b8:b000:164:428d:5cff:fe34:f932.53052 > 2a02:6b8:0:3400::5015.443: Flags [.], ack 3388427157, win 104, options [nop,nop,TS val 160230035 ecr 3850850631], length 0
    
    15:47:30.988426 IP6 2a02:6b8:6666::ba > 2a02:6b8:0:1482::115: IP6 2a02:6b8:0:1400::e0.50017 > 2a02:6b8:0:3400::5015.443: Flags [S], seq 3231604891, win 28800, options [mss 1440,nop,nop,sackOK,nop,wscale 7], length 0
    ...
    15:47:30.998176 IP6 2a02:6b8:6666::ba > 2a02:6b8:0:1482::115: IP6 2a02:6b8:0:1400::e0.50017 > 2a02:6b8:0:3400::5015.443: Flags [R.], seq 533, ack 4808, win 356, length 0
    ```
    
    {% endcut %}
    
1. Найдите в дампе трафика проверочные запросы от балансеров. Такие запросы, как правило, отправляются с адреса `2a02:6b8:6666::ba`:
    ```
    15:47:30.998176 IP6 2a02:6b8:6666::ba > 2a02:6b8:0:1482::115: IP6 2a02:6b8:0:1400::e0.50017 > 2a02:6b8:0:3400::5015.443
    ```
    
    Значение `2a02:6b8:0:1400::e0.50017` в данном запросе — это IP-адрес и порт отправителя инкапсулированного пакета. Для проверочных запросов это IP-адрес и порт L3 балансера.
    
1. Удостоверьтесь, что запросы с адреса `2a02:6b8:6666::ba` действительно принадлежат балансерам:
    
    1. Определите FQDN отправителя пакета. Для этого выполните на вашем риле команду `host <IP-адрес отправителя пакета>`. Например, для пакета выше команда будет выглядеть как `host 2a02:6b8:0:1400::e0`.
    
       Результат выполнения команды:
    
       ```
       0.e.0.....a.2.ip6.arpa domain name pointer <FQDN отправителя пакета>
       ```
    
    1. Проверьте, что полученный FQDN принадлежит одному из балансеров вашего проекта. Чтобы посмотреть ваши балансеры, перейдите в L3 manager в раздел [ABC Services](https://l3.tt.yandex-team.ru/abc), выберите ваш abc-сервис и перейдите на вкладку **Load balancers**.
    
1. Если в дампе трафика отсутствуют запросы от балансеров, сверьте IP-адрес рила с тем, что указан в [списке рилов](config-settings.md#section_lkx_rlf_sfb) вашего виртуального сервера и, при необходимости, обновите список рилов.
    
    Если IP-адреса совпадают, но дамп не содержит трафика с балансеров, напишите [команде L3](mailto:slb@yandex-team.ru).
    

### Проверьте наличие входящих пакетов на IP-адрес виртуального сервера {#section_lk1_gwt_5fb}

Чтобы убедиться в том, что пакеты поступают на ваш сервер:

1. Выполните команду `tcpdump -np host <IP-адрес виртуального сервера> -i any`. Результат выполнения команды:
    
    ```
    16:01:20.005241 IP <SRC IP-адрес клиента> > <IP-адрес виртуального сервера>: Flags [S], seq ..., win ..., options [...], length 0
    16:01:20.005283 IP 5.255.240.50.443 > 95.108.237.53.41355: Flags [S.], seq 2952887964, ack 341441325, win 28200, options [mss 1410,nop,nop,sackOK,nop,wscale 7], length 0
    ...
    ```
    
1. Если конфигурация настроена корректно, то пользовательский трафик будет приводить к появлению [SYN-RECV состояний](http://www.cs.northwestern.edu/~agupta/cs340/project2/TCPIP_State_Transition_Diagram.pdf). Проверьте наличие состояний командой `ss -n -o state syn-recv`. Результат выполнения команды:
    
    ```
    Netid  Recv-Q Send-Q              Local Address:Port                    Peer Address:Port
    tcp    0      0                   2a02:6b8:0:3400::5015:443             2a02:6b8:b010:569:225:90ff:fe83:402:34675  timer:(on,996ms,0)
    ```
    
    Если ваше приложение отвечает на запросы пользователей, то ответы будут приводить к появлению [SYN-SENT состояний](http://www.cs.northwestern.edu/~agupta/cs340/project2/TCPIP_State_Transition_Diagram.pdf). Проверьте наличие состояний командой `ss -n -o state syn-sent`. Результат выполнения команды:
    
    ```
    Netid  Recv-Q Send-Q             Local Address:Port                     Peer Address:Port
    tcp    0      1                  2a02:6b8:0:1482::115:60092             2a02:6b8:0:200::5:179    timer:(on,13sec,5)
    tcp    0      1                  2a02:6b8:0:1482::115:56562             2a02:6b8:0:3400::818:12000  timer:(on,1sec,0)
    ```
    

Причины, по которым могут отсутствовать SYN-RECV и SYN-SENT состояния:

- Наличие правил фаерволла, которые запрещают [ipencap-пакеты](https://en.wikipedia.org/wiki/IP_in_IP).
    
    Правила фаерволла можно посмотреть командами `iptables -nvL` и `ip6tables -nvL`.
    
- Отсутствие туннельных интерфейсов или их состояние «DOWN».
    
    Проверьте наличие интерфейсов командой `ip tunnel list` или `ip -6 tunnel list`:
    
    ```
    tunl0: ip/ip  remote any  local any  ttl inherit  nopmtudisc
    ```
    
    и их состояние командой `ip link show dev tunl0`:
    
    ```
    tunl0@NONE: <NOARP> mtu 8950 qdisc noqueue state DOWN mode DEFAULT group default
    link/ipip 0.0.0.0 brd 0.0.0.0
    ```
    
    Если состояние интерфейса «DOWN», выполните команду `ip link set up dev tunl0`.
    
- Наличие IP-адреса сервиса на lo-интерфейсе или одном из dummy-интерфейсов.
    
    Чтобы это проверить, выполните команду `ip -o addr show | fgrep <IP-адрес вашего сервиса>`:
    
    ```
    1: lo    inet 5.255.240.50/32 scope global lo\       valid_lft forever preferred_lft forever
    ```
    
- Отсутствие слушающего приложения на порте, указанном в [конфигурации виртуального сервиса](config-settings.md#port).
    
    Проверьте наличие приложения командой `ss -lpn | fgrep <IP-адрес вашего сервиса>:<порт>`:
    
    ```
    tcp    LISTEN     0      128         5.255.240.50:443   *:*  users:(("nginx",14795,16),("nginx",14794,16),("nginx",14793,16),("nginx",14792,16),("nginx",14791,16),("nginx",14790,16))
    ```
    

### Проверьте наличие исходящих пакетов {#section_a5f_jwt_5fb}

Чтобы убедиться в том, что ваш сервис корректно отвечает пользователям:

1. Выполните команду `tcpdump -np src host <IP-адрес виртуального сервера> -i any`.
    
    При корректной работе рилов будут видны исходящие пакеты:
    ```
    16:18:57.288185 IP 5.255.240.50.443 > 95.108.237.53.39897: Flags [S.], seq 1443925349, ack 4050230827, win 28200, options [mss 1410,nop,nop,sackOK,nop,wscale 7], length 0
    16:18:57.288439 IP 5.255.240.50.443 > 95.108.237.53.39897: Flags [.], ack 296, win 229, length 0
    ```
    
1. Если исходящие пакеты отсутствуют:
    
    - Проверьте логи приложения и системные маршруты командой `ip route get <IP-адрес клиента> from <IP-адрес виртуального сервера>`.
    
      Результат выполнения команды:
    
      ```
      95.108.237.53 from 5.255.240.50 via 77.88.1.118 dev eth0
      cache  mtu 1450 advmss 1410
      ```
    
    - Проверьте список маршрутных правил для вашего виртуального сервиса с помощью команды `ip rule show`:
    
      ```
      0:      from all lookup local
      32765:  from 5.255.240.50 lookup <таблица маршрутов вашего сервера>
      32766:  from all lookup main
      32767:  from all lookup default
      ```
    
      Проверьте таблицу маршрутов для вашего сервиса с помощью команды `ip route show table <таблица маршрутов вашего сервера>`:
      
      ```
      default via 77.88.1.118 dev eth0  mtu 1450 advmss 1410
      ```
    
1. Напишите о результатах проверки [команде L3](mailto:slb@yandex-team.ru).
    


## Неравномерное распределение трафика на рилы {#concept_qtp_xtt_5fb}

Под трафиком подразумевается количество пользовательских сессий. L3 балансеры не работают с RPS, QPS и т. д. Это означает, что в рамках сессии на один рил может отправляться большое количество запросов, а в рамках сессии на другой рил — один запрос. С точки зрения L3 балансеров такое распределение трафика будет считаться равномерным.

Трафик может распределяться неравномерно как между рилами в одном, так и в разных ДЦ.

### Рилы в разных ДЦ {#section_zzk_d5t_5fb}

Трафик зависит от маршрутизации между ДЦ и следует правилам:

- Согласно правилам [BGP](https://en.wikipedia.org/wiki/Border_Gateway_Protocol), локальный ДЦ приоритезирован. Это означает, что клиенты из региона, где расположен ДЦ, всегда будут перенаправляться на рилы в данном ДЦ.
- Трафик между ДЦ распределяется в соответствии с количеством маршрутов по [RR-распределению](http://kb.linuxvirtualserver.org/wiki/Round-Robin_Scheduling).
- ДЦ Мянтсяля [пессимизирован](config-settings.md#section_vrw_rlf_sfb).

Если вы хотите более равномерно распределять трафик между ДЦ:
- Воспользуйтесь DNS RR балансировкой со своим адресом для каждого из ДЦ.
- Обратитесь к общим в компании решениям балансировки на L7.
- Используйте TCP-прокси.

### Рилы в одном ДЦ {#section_bhb_25t_5fb}
Возможные причины:
- Алгоритм балансировки. Ознакомьтесь с доступными [алгоритмами балансировки](config-settings.md#ul_wxl_ylf_sfb) и, при необходимости, измените алгоритм.
- Веса рилов. [Измените веса рилов](checks.md#weigths) для более равномерного распределения трафика.
- [Флапающий рил](terms.md#flapping-reel). Найти флапающий рил можно при помощи [логов рила](logs.md#logs) или логов вашего приложения.

