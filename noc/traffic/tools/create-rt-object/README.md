create\_rt\_lb
==============

Превращает JSON в карточки объектов в RackTables, облегчая заведение или
переконфигрурацию оборудования в инвентаре.

Как использовать
----------------

Создаем JSON, пример можно посмотреть в data\_example.json. Файл разбит на N
секций, где N от 1 до бесконечности. Первая секция называется 'global' и
определяет глобальные переменные. Все остальные секции называются именем
балансировщика (коротким, не FQDN) и определяют переменные для конкретного
балансировщика, переопределяя глобальные при совпадении. В каждой секции может
быть до 3 следующих подсекций:
* location\_tag: ID тега локации, в которой находится сервер. Обязателен.
  Можно найти в [RackTables](https://racktables.yandex-team.ru/index.php?page=tagtree),
  наведя мышкой на нужный тег.

* asset\_num: инвентарный номер a.k.a. Я-номер сервера. Обязателен. Ищем в
  RackTables, bot, заявках на оборудование и т.д.

* interfaces: описание физических и виртуальных интерфейсов. Обязателен.
  Состоит из N подскеций.

Каждый интерфейс имеет отедльную секцию в 'interfaces', озаглавенную именем
этого интерфейса. Содержимое может включать:
* type: тип интерфейса. Обязателен. **Внимание**: данный скрипт поддерживает
  ограниченный набор типов: 100Base-TX, 1000Base-T, SFP28, loopback. Для
  описания интерфейса dummy255 использовать loopback.

* link\_switch: коммутатор, к которому этот порт подключен. Не обязателен,
  без link\_port не имеет смысла.

* link\_port: порт коммутатора, к которому подключен этот порт
  балансировщика. Не обязателен, если есть * порты будут слинкованы.

* ipv4\_network: IPv4 префикс из которого взять IP адрес для назначения на
  этот интерфейс. Не обязателен.

* ipv6\_network: IPv6 префикс из которого взять IP адрес для назначения на
  этот интерфейс. Не обязателен.

* link\_local\_vlan: VLAN ID для создания subinterface. Не обязателенБ если
  есть * будет описан subinterface с IPv6 link-local адресом.
Запускаем `newlb/cli.py --create file.json`, если хотим создать новые карточки
или `newlb/cli.py --replace file.json`, если хотим переписать уже существующие.
В случае если выбран create а карточки существуют и наоборот - скрипт упадёт с
ошибкой.

Особенности работы
------------------

Вызовы RTAPI, которые завершаются неуспехом, но не бросают исключений -
напечатают сообщение о проблеме, но не остановят работу скрипта. Это относится,
например, к линковке портов или назначению IP адресов (нет свободных v4, занят
v6).

IPv6 адреса создаются по схеме PREFIX::bNL, где PREFIX - выбранный IPv6
префикс, N - номер балансировщика, L - буква балансировщика. Например
sas-1lb7a, получит адреса PREFIX::b7a. Актуально и для global и для link-local.

MAC адреса портов будут распаршены из bot. eth0 и eth1 получат адреса Expansion
card, eth2 и eth3 - адреса Motherboard, IPMI - свой.

Скрипт очень балансеро-центричен. Чтобы наконфигурировать что-то ещё его нужно
править. У меня получалось относительно быстро создавать фаерволы.

Качество скрипта у меня самого вызывает вопросы, но причесать его я так и не
удосужился. Коллеги из NOCDEV делали что-то подобное, возможно тут стоит
объединить усилия.

Рекомендуется проверять результат в RT staging, используя для его создания
[rttctl](https://noc-gitlab.yandex-team.ru/nocdev/rt-docker#%D0%B1%D1%8B%D1%81%D1%82%D1%80%D1%8B%D0%B9-%D1%81%D1%82%D0%B0%D1%80%D1%82-%D0%B4%D0%BB%D1%8F-%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F-rttctl).

Видео демонстрация
------------------

Даже такое есть! [LINK](https://jing.yandex-team.ru/files/darkyman/zoom_1.mp4)

Кто это наделал
---------------

darkyman@yandex-team.ru
