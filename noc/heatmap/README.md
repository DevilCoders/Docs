# Сервис heatmap
Продакшен – [heat.yandex-team.ru](https://heat.yandex-team.ru)
Разработка/тестинг – [dev-heat.common-int](https://dev-heat.common-int.yandex-team.ru)

## Устройство кода
### server
Точка входа - `main.py`. Обновляет события из Заббикса и Джагглера, подтягивает для них комменты из Постгреса. Также обновляет кеш Rack-кодов и объектов из Racktables.

Общение с постгресом лежит в `storage.py`, с Заббиксом - в `znoc_api.py`, c Джагглером - в `juggler_api.py`, с Racktables - в `rt_api`.

Также реализует REST-апи, и отдачу событий на фронтенд через Вебсокеты. События отдаются все сразу, без сохранения стейта на фронтенде.

Хандлеры HTTP лежат в `rest_api.py`. Общение с редисом и постгресом лежит в `storage.py`, данные события готовятся в `services.py`, логика создания тикетов в Стартреке - в `startrek.py`.

### static
Single-page application, написанное на Angular 1. Основная логика лежит в `app/app.js`. Куски вёрстки лежаит в `partial/`. Писалось (и продолжает писаться) людьми, максимально далёкими от фронтенд-разработки.

## Деплой
Сервис хостится в Qloud ([прод](https://qloud.yandex-team.ru/projects/noc/noc-heatmap/test), [дев](https://qloud.yandex-team.ru/projects/noc/noc-heatmap/dev))
Иснталяция состоит из 4 компонентов:
 1. **api** – основной компонент бэкенда
 2. **static** - раздаёт статику nginx-ом
 3. **updater** – обновляет кэш событий
 4. **redis** – используется для хранения кэша событий

Образ **redis** используется из официального docker hub'а. Если хочется его обновить, то надо запулить официальный образ и запушить в наш репозиторий.

Для обновления других образов можно использовать скрипт `deploy.sh`, ему в качестве аргумента передаётся имя компонента.

Скрипт соберёт образ (используя кэш) и запушит образ в наш репозиторий. После этого можно обновлять компонент в интерфейсе qloud'а.

Скрипт `deploy_prod.sh` делает тоже самое но добавляет тег `release` к образу (в окружении production ставятся эти образы).


# Шаблоны тикетов и комментариев robot-noc-ck

Разрабатываются в данный момент в [noc-heat-templates в noc-gitlab](https://noc-gitlab.yandex-team.ru/nocdev/heat-ticket-templates/), там же лежат тесты для них и документация по написанию.

После вливания merge request в `master` надо просто подождать – каждые 10 минут репозиторий шаблонов подтягивается в Хит.
