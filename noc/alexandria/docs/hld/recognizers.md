## Признаваторы
Для контроля и определения действующего состояния ПО на устройствах используются признаваторы.  
Так как версия базового образа или пакета ядра зачастую являются лишь частью состояния ПО, то критерием признания(определения ПО) является полное совпадение списка файлов для данного типа устройства.

{% note info %}

Признаватор "признаёт" в установленном программном обеспечении известный для Alexandria экземпляр Soft по именам файлов или пакетов. 

{% endnote %}

### Критерии "признания" (определения) ПО
Помимо указания на желаемое ПО, согласно [Matchers](./match.md), Alexandria должна уметь определять текущее состояние ПО на устройстве.  
Каждый экземпляр [Soft](./softs.md) обязательно содержит в себе список объектов типа File, определяемых типом и именем файла.  
Например: 
```json
  {
    "ID": "Huawei_VRP_8.5/CE8850EI/V200R019C10SPC800_V200R019SPH020.yaml",
    "Type": "vrp85",
    "SWType": "Huawei VRP 8.5",
    "Files": [
      {
        "Type": "main",
        "FileName": "CE8850EI-V200R019C10SPC800.cc",
        "Version": "V200R019C10SPC800",
      },
      {
        "Type": "patch",
        "FileName": "CE8850EI-V200R019SPH020.PAT",
        "Version": "V200R019SPH020",
      }
    ],
    "Deprecated": false
  },
```
Чтобы Alexandria определила, что на устройстве установлен данный экземпляр ПО, необходимо чтобы парсер нашёл:
* Бинарный файл VRP `CE8850EI-V200R019C10SPC800.cc`, активный, типа `main`
* Патч `CE8850EI-V200R019SPH020.PAT`, активный, типа `patch` 
> Возможно будут добавлены более сильные критерии определения по размеру файлов и sha/md5 sum

#### Короткий алгоритм признаватора:
* Из выводов команд сервис собирает set(`map[entities.SoftFileKey]struct{}`), элементы в котором представлены в виде Go--структуры, состоящей из `Type` и `FileName`.
* Если необязательный файл не найден(например vrp patch), то элемент в set не создаётся
* Такой же set собирается в каждом экземпляре ПО при сборке Alexandria
* Список экземпляров ПО для сравнения фильтруется по breed
* Признаватор считает софт найденным при полном совпадении двух set

### Запросы и особенности парсинга
#### Параметры запроса
Все запросы для признаватора выполняются методом POST `/recognize/` в виде списка объектов. [Актуальная схема.](https://alexandria.yandex-team.ru/swaggerui/)

```json
[
  {
    "Breed": "string",
    "Cmds": {
      "commandName1": "string",
      "commandName2": "string",
      "commandName3": "string"
    },
    "ObjectID": "string"
  }
]
```

Для определения экземпляра ПО устройства требуется знать его Breed и список выводов команд(Cmds). Source of Truth, определяющий абстракцию Breed, выступает Racktables.  

В текущей реализации обязательным параметром запроса в API также является RT objectID, но данная особенность просто упрощает взаимодействие с Invapi и работу действующих сценариев использования в NOC. Если в запросе НЕ передан breed, то он будет вычислен на стороне RT, на основе objectID. 

#### Выводы CLI
Список команд, которые должен передать клиентский сервис для определения ПО, закреплен за конкретным breed. 

Для упрощения работы клиентской стороны, при недостатке выводов команд, сервис укажет на ошибку и запросит выводы в явном виде:

```json
"CmdsShortage": {
    "commandName1": {},
},
```
Таким образом, допустимым сценарием является выполнение двух последовательных запросов в Alexandria: 
1) Со списком объектов без необходимых выводов `Cmds`
2) Со списком объектов и необходимые выводы после их определения(`CmdsShortage`) и сбора

С сокращениями сервис не разберётся: `"sh ver" != "show version"`

### Отсутствие известного экземпляра ПО
Для совпадения экземпляр ПО не обязан быть рекомендуемым для данной группы устройств. Матчинг никак не участвует в процессах признаватора.

Если в базе Softs не было найдено совпадение с существующим экземпляром ПО, но парсинг прошёл без ошибок, то сервис выдаст результат лишь в виде структуры экземпляра ПО, с указанием набора файлов и их версий. 

```json
"RecognizedSoft": null,
"ParsedSoft": {
    "ID": "parsed",
    "Type": "vrp55",
    "Files": [
    {
        "Type": "main",
        "FileName": "s5700ei-v200r003c00spc300.cc",
        "Version": "V200R003C00SPC300",
    },
    {
        "Type": "patch",
        "FileName": "s5700ei-v200r003sph003.pat",
        "Version": "V200R003SPH003",
    }
}
...
```

{% note tip %}

Если ПО является популярным или важным для контроля, рекомендуется добавить данный экземпляр в Alexandria согласно [инструкции](../repository/contribute.md).

{% endnote %}
