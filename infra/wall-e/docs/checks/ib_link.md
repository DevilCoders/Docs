# Починка Infiniband Fabric (проверка ib_link)

## Пайплайн работы
1. Wall-E получает информацию о том для каких хостов и портов эта проверка актуальна походом в Racktables ([ручка](https://ro.racktables.yandex-team.ru/export/IB-sw-to-host-link.txt)).
  Одному хосту может соответствовать сразу несколько портов IB.
2. Wall-E заводит в Juggler агрегаты только для хостов c IB портами. Особенность этих агрегатов в том, что children не раскрывается динамически через группы Juggler (`WALLE`), а зашиты в описании агрегата. В отличии от агрегатов по другим проверкам, в ib_link child зашивается порт в поле `instance`. Таким образом одному хосту может соответствовать несколько child'ов, отличающихся портом.
3. Сырые события для агрегатов засылает в Juggler LinkEye NOC'ов. В случае поломки доставки событий (команда Wall-E скорее всего заметит это по missing проверкам) надо завести тикет в очереди https://st.yandex-team.ru/NOCDEVDUTY . Зелёные OK присылаются LinkEye с интервалом в 30 минут, но CRIT'ы присылаются сразу же после обнаружения поломки.
4. В health API Wall-E, при получении здоровья от Juggler, происходит агрегация всех child'ов одного хоста в одну проверку, которая уже сохраняется в Health DB Wall-E. Информация о том какой именно порт сломался остаётся доступна в metadata проверки. В случае поломки нескольких портов выбирается самый старый.
5. В случае поломки создаётся тикет в ITDC ([пример](https://st.yandex-team.ru/ITDC-449572)) с описанием того какой именно порт выпал.
6. При превышении лимитов на починку у одного хоста, он деактивируется. 

## Основные тикеты в рамках которых шла разработка
* https://st.yandex-team.ru/NOCDEV-3678 - соновной со стороны NOC
* https://st.yandex-team.ru/WALLE-4238 - интеграция в Wall-E
