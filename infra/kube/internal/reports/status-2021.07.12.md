# Status report 12.07.2021
Новостей очень мало, Вася последнюю неделю дежурил и помогал с hostman'ом. Эту неделю Вася в отпуске, поэтому большого прогресса не ждём.

## Рассказ про унификацию инфраструктуры
Провёл 2 два пробных прогона ([слайды](https://a.yandex-team.ru/api/tree/blob/trunk/arcadia/infra/kube/reports/universal-control-planes-wip.pdf?repo=arc&rev=8407922)):
  * для коллег из соседних отделов (devtools, MDS, Данила Штань)
  * на лидов и менеджеров внутренней и гибридной инфраструктуры

Подготовка отняла много времени, но была крайне полезной в плане получить обратную связь и наладить синхронизацию.

## Подготовка к демо
В рамках подготовки к "стратегической сессии инфраструктуры" и, в большей степени, чтобы проверить, что конструкция работает в сборе.
В результате смогли (заранее, до показа):
  * получить настроенный kubectl для 4х окружений
  * показать работу с аллокациями Няни через kubectl
  * показать через kubectl поднятый как объект k8s кластер в Azure
  * показать через kubectl поднятый nginx с образом из cr.yandex (из Аркадии), который отвечает на публичном IP адресе (т.е. завести трафик)
  * показать работу gatekeeper'а для (как пример) требования обязательных label'ов (без перезапуска сервиса и через kubectl)

## Managed k8s @ Yandex.Cloud
В процессе подготовки улучшили документацию по тому, как всё это разворачивать заново. Узнали, что по-умолчанию, у VPC сетей нет доступа в Интернет. Соответственно, по-умолчанию, managed k8s поднимается в таких сетях и совершенно непригоден ни для чего. Даже для доступа к облачному (и платному) container registry cr.yandex нужен "доступ в Интернет". Это можно организовать через:
  * публичные IP - не выглядит хорошей идеей давать публичный адрес каждой виртуальной машине
  * egress NAT - это по запросу в превью (ждём)
  * NAT host - это руками настроить NAT на какой-то виртуалке и в сети настроить роуты через неё - [инструкция](https://cloud.yandex.ru/docs/solutions/routing/nat-instance).

Освоение этого заняло немало времени (и нервов), зато:
  * получили опыт общения с технической поддержкой
  * познакомились с baranovich@

## Nanny + Gatekeeper
Краткое описание Gatekeeper и ссылки - [тут](https://a.yandex-team.ru/arc/trunk/arcadia/infra/kube/docs/policies.md).

Родилась идея попробовать это в Няне (где годами через adhoc механизмы в конфиге такие политики пишутся вручную):
  * Использовать Gatekeeper и политики.
  * Научить nanny-api-server ходить с AdmissionReview запросами в хук.
Детали - [тут](https://a.yandex-team.ru/arc/trunk/arcadia/infra/kube/projects/nanny-gatekeeper.md).

## Документация / FAQ
"Евангелизм" среди коллег поднял приоритет проблемы - недостатка знаний. Нет чётких ответов (кроме взмахов руками) на вопросы:
  * почему это не Terraform
  * как это интегрировать с текущей инфраструктурой
и т.д. Начал восполнять пробелы, stay tuned.


## Планы
Буду больше заниматься документацией и подготовкой рассказов и т.д.

