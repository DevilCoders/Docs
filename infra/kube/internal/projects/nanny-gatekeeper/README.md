Tracked in: [st/SWAT-7856](https://st.yandex-team.ru/SWAT-7856).

# Nanny and Gatekeeper
В экосистеме kubernetes есть проект [Open Policy Agent Gatekeeper](https://open-policy-agent.github.io/gatekeeper/website/). Его обзор с примером есть в [документах](https://a.yandex-team.ru/arc/trunk/arcadia/infra/kube/docs/policies.md).

История может быть такой:
>Я в роли администратора Няни хочу дать возможность определённой группе людей (по логинам, ABC сервисам) или в определённых сервисах (id) дать возможность указывать заказ LVM.

# Схема работы Gatekeeper и Няни
Gatekeeper работает в двух ролях:
  * controller, который подписан на изменение своих объектов в kube-apiserver
  * HTTP сервис, который ожидает [AdmissionReview](https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#request) запросы

Предлагается:
  * использовать kube-apiserver в качестве инструмента администратора
  * научить nanny-api-server ходить в gatekeeper с запросами на review

Сам gatekeeper можно запускать в том же pod'е/контейнере для простоты администрирования (не нужен балансер и service discovery).
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="421px" viewBox="-0.5 -0.5 421 440" content="&lt;mxfile host=&quot;drawio.yandex-team.ru&quot; modified=&quot;2021-07-08T08:12:47.091Z&quot; agent=&quot;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.114 Safari/537.36&quot; etag=&quot;rn4Vl53Nxm6gdH-EYNFA&quot; version=&quot;12.7.0&quot;&gt;&lt;diagram id=&quot;0L5A6zRBTy9aB1rR9Ojj&quot; name=&quot;Page-1&quot;&gt;3Vjbbts4EP0aPSagJNtRHhMnTbvIbgJkF22fCloaS2woUSDpWOrXL2lRF5qO7abO1fADOeL1nDkzI3nhNK+uOC6zv1kC1AtQUnnhhRcE/igIPP1HSd1YImQMKSeJGdQb7sgvMEZkrAuSgLAGSsaoJKVtjFlRQCwtG+acLe1hc0btXUucgmO4izF1rV9JIjNzizHq7Z+BpFm7s4/Mkxy3g41BZDhhy4EpvPTCKWdMNq28mgLV4LW4NPM+PfK0OxiHQu4z4eZfDKP0yzcq/b9qcT4d3/yTHp2as8m6vTAk6v6my7jMWMoKTC976zlniyIBvSpSvX7MNWOlMvrK+BOkrA2ZeCGZMmUyp+ape3JzGcEWPIYtxz0xHoB5CnLLuKgZp+8y2MDgcgUsB8lrNYADxZI82Fxj4zJpN65HVTUMsL8BcuvLD5guzFZnSaIhYJTEtUOBhEraiGFK0kK1Y4UYcGV4AC6J8tIz8yAnSdKQA4L8wrPVUpqekpFCri40PvfGF8pC8QzoOY7v0xWRU0YZX+0bzle/jQRtcx59Fqi8DWo057Ac3sLfzDpCx8EpCpu5JlC0HO5NkVn9Vl+4XzqyF22paBdg87lQnrTOcHfEp5N+soHznBQO2SoslLq5yOlZLNmQ3GvN1C0TRBKmSZ4xKVm+H4XrDiK1NocuxRaSkgKmXdxE25TpcPwol2GELMhHbfxb9uEzNKZsEDkn6HFq/0x949eIcVAR+U1PPx6b3nezmG5fVMNO3XYKdd/BJN393q6nO/20Vc+adwucKMB0dNhO5c4gG+0ZZH3/TUXZyBHcfSS8YEJ1LJ1x1Up1C5fkSABXDv2oFONaKSNZxdllRiTclXgF2FKVODbLs8ZNrmedoRPlTaOvXSlvf2GNfFtYnYoGwppsEFb0bMLyHcQdSHeGsp1xqiUlr1JdYR7PsCDxccF+iDqfMXqIiHUytoCdBA6uXVU3BLYzHh7ZwEH2Cku4Byi126679AsXEDrYiSbuHcq113KGj1wKog0MBM9GwMgh4CuWcdbWbAQ2RJb3T0O4RkPkRpjTl6ShS1nvKXUjZCVvtUrUGV4mgfuT95nB23MPVFfgoqh/K4mrfUgpYHfuxqJsCt85qbS7HEJBAdqdozcFsufL0a/ygv8kBanOugSeWhD/gXT2/cLQ+upbkY77uvmf2FLifpS3TX9kCy48feW3zcD91jPloIo3ZbtTEYso9/t4lYM/ntg0TFwaNtbQz1c6uCW0/v4ihHZurcoHAst3j7uqx+yKDY1c3P3D4K66/cfq5itZ/8k/vPwf&lt;/diagram&gt;&lt;/mxfile&gt;" onclick="(function(svg){var src=window.event.target||window.event.srcElement;while (src!=null&amp;&amp;src.nodeName.toLowerCase()!='a'){src=src.parentNode;}if(src==null){if(svg.wnd!=null&amp;&amp;!svg.wnd.closed){svg.wnd.focus();}else{var r=function(evt){if(evt.data=='ready'&amp;&amp;evt.source==svg.wnd){svg.wnd.postMessage(decodeURIComponent(svg.getAttribute('content')),'*');window.removeEventListener('message',r);}};window.addEventListener('message',r);svg.wnd=window.open('https://drawio.yandex-team.ru/?client=1&amp;lightbox=1&amp;edit=_blank');}}})(this);" style="cursor:pointer;max-width:100%;max-height:440px;"><defs/><g><path d="M 255 358 L 255 303 L 300 303 L 300 254.37" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 300 249.12 L 303.5 256.12 L 300 254.37 L 296.5 256.12 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 302px; margin-left: 264px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; background-color: #ffffff; white-space: nowrap; ">Add policy</div></div></div></foreignObject><text x="264" y="305" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">Add policy</text></switch></g><ellipse cx="255" cy="365.5" rx="7.5" ry="7.5" fill="#ffffff" stroke="#000000" pointer-events="all"/><path d="M 255 373 L 255 398 M 255 378 L 240 378 M 255 378 L 270 378 M 255 398 L 240 418 M 255 398 L 270 418" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe flex-start; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 425px; margin-left: 255px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; background-color: #ffffff; white-space: nowrap; ">Admin</div></div></div></foreignObject><text x="255" y="437" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">Admin</text></switch></g><path d="M 300 168 L 300 134 L 285 134 L 285 106.37" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 285 101.12 L 288.5 108.12 L 285 106.37 L 281.5 108.12 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"/><path d="M 270 184 C 270 162.67 330 162.67 330 184 L 330 232 C 330 253.33 270 253.33 270 232 Z" fill="#ffffff" stroke="#000000" stroke-miterlimit="10" pointer-events="all"/><path d="M 270 184 C 270 200 330 200 330 184" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 58px; height: 1px; padding-top: 220px; margin-left: 271px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">k8s<br />api-server</div></div></div></foreignObject><text x="300" y="224" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">k8s...</text></switch></g><path d="M 235 50 C 235 22.39 257.39 0 285 0 C 312.61 0 335 22.39 335 50 C 335 77.61 312.61 100 285 100 C 257.39 100 235 77.61 235 50 Z M 313.95 69.7 C 323.46 55.8 321.72 37.1 309.81 25.19 C 297.9 13.28 279.2 11.54 265.3 21.05 Z M 256.15 30.3 C 246.68 44.18 248.41 62.84 260.27 74.74 C 272.14 86.64 290.79 88.43 304.7 79 Z" fill="#ffffff" stroke="#000000" stroke-miterlimit="10" pointer-events="all"/><rect x="340" y="40" width="80" height="20" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 50px; margin-left: 380px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap; ">Gatekeeper<br /></div></div></div></foreignObject><text x="380" y="54" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">Gatekeeper&#xa;</text></switch></g><rect x="290" y="118" width="90" height="20" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 128px; margin-left: 335px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap; ">Watch policies<br /></div></div></div></foreignObject><text x="335" y="132" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">Watch policies&#xa;</text></switch></g><path d="M 100 168 L 100 58.5 L 229.13 58.5" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 234.38 58.5 L 227.38 62 L 229.13 58.5 L 227.38 55 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"/><ellipse cx="100" cy="208" rx="40" ry="40" fill="#ffffff" stroke="#000000" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px; padding-top: 208px; margin-left: 61px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">nanny<br />api-server</div></div></div></foreignObject><text x="100" y="212" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">nanny...</text></switch></g><path d="M 15 328 L 15 288 L 100 288 L 100 254.37" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 100 249.12 L 103.5 256.12 L 100 254.37 L 96.5 256.12 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"/><ellipse cx="15" cy="335.5" rx="7.5" ry="7.5" fill="#ffffff" stroke="#000000" pointer-events="all"/><path d="M 15 343 L 15 368 M 15 348 L 0 348 M 15 348 L 30 348 M 15 368 L 0 388 M 15 368 L 30 388" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe flex-start; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 395px; margin-left: 15px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; background-color: #ffffff; white-space: nowrap; ">User</div></div></div></foreignObject><text x="15" y="407" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">User</text></switch></g><rect x="16" y="298" width="100" height="20" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 308px; margin-left: 66px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap; ">Create Service<br /></div></div></div></foreignObject><text x="66" y="312" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">Create Service&#xa;</text></switch></g><rect x="89" y="42" width="110" height="20" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 52px; margin-left: 144px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap; ">Admission review</div></div></div></foreignObject><text x="144" y="56" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">Admission review</text></switch></g></g><switch><g requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"/><a transform="translate(0,-5)" xlink:href="https://desk.draw.io/support/solutions/articles/16000042487" target="_blank"><text text-anchor="middle" font-size="10px" x="50%" y="100%">Viewer does not support full SVG 1.1</text></a></switch></svg>

## Further reading
  * [Contraint framework](https://github.com/open-policy-agent/frameworks/tree/master/constraint) - что такое contraints и как их писать.
  * [Policy Writing Hands On](https://cloud.redhat.com/blog/better-kubernetes-security-with-open-policy-agent-opa-part-2) - подробные HOWTO по написанию Policy
  * [Mutating Webhook Example Issue](https://github.com/open-policy-agent/opa/issues/943) - тикет с примерами mutating webhook'а.