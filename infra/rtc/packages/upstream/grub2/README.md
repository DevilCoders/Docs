# GRUB2

Для поддержки загрузки на NVMe-only хостах с BIOS в RTC используется патченая версия grub2 - 2.04-yandex1. Это версия grub, поставляемая в Ubuntu 20.04 с исключенной парой патчей в районе работе с EFI (из-за этих патчей пакет не собирался) и добавленным патчем, который при выполнении grub-install всегда использует модуль biosdisk, независимо от того, что указано в параметрах (при использовании nativedisk хосты не грузятся).

Пакет пришлось собирать, использую исходники и патчи от focal, а debian control files - от xenial. Прямая сборка пакета focal -> xenial не удалась, т.к. в пакете немного поменялся набор бинарных пакетов, а это критично, чтобы не словить странных спецэффектов, при замене пакетов внутри одного релиза дистрибутива. По этой же причине была отвергнута версия grub-nvme=2.04 (которая, оказалась 2.05 собранной из master).


## Сборка

Для сборки рекомендуется использовать виртуальную машину с xenial.

Ставим базовые пакеты для сборки:

    sudo apt-get install devscripts build-essential dupload debhelper

Для успешной сборки и подписи changes стоит до начала сборки принести на виртуалку свой gpg-ключ, которым будет подписываться пакет.

Выкачиваем исходники пакета:

    echo "deb-src http://dist.yandex.ru/search-xenial unstable/source/" | sudo tee /etc/apt/sources.list.d/search-xenial.list
    sudo apt-get update
    mkdir build && cd build && \
    sudo apt-get source grub2=2.04-yandex1


Получаем распакованные и попатченные (патчами из debian/ubuntu) исходники в директории grub-2.04. Дальше пробуем в grub-2.04 собрать пакет: `debuild`. Смотрим на вывод, доустанавливаем недостающие сборочные зависимости.

При необходимости, накладываем свои патчи, добавляем запись в debian/changelog (либо командой dch, либо осторожно руками). Пробуем собрать еще раз, видим предложение закоммитить изменения и команду для этого. Выполняем ее, следуем инструкциям. Собираем пакет с помощью `debuild`.
