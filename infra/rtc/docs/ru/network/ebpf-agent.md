# ebpf-agent

ebpf-agent - агент для управления глобальными bpf-программами на хосте. Сейчас используются только программы, которые вешаются на рутовую v2 сигруппу, но в дальнейшем функицонал может быть расширен. При запуске агента происходит загрузка и аттач всех включенных в конфиге программ, при останове - детач и выгрузка из памяти ядра. Есть возможность не детачить программы при останове агента, и обнаруживать и обновлять неактуальные на старте, но мы ей в данный момент не пользуемся для простоты. Также агент умеет инициализировать bpf-мапы и передавать их в нужную программу. Далее приведен список программ и их краткое описание.

TBD
Голован

## tcp_rto

Программа делает несколько вещей.
Во-первых, она подкручивает inital RTO (retransmit timeout) в зависимости от направления коннекции, задавая его равным p95 rtt по данным нетмона (значения статически прошиты в бинарнике). Это позволяет быстрее перепослать неудачный пакет, не ожидая дефолтной секунды в линуксе, но при этом может вызывать излишние ретрансмиты в сети, если приемник начинает тупить.
Во-вторых, tcp_rto берет на себя управление flowlabel-ами в IPv6 пакетах. По сути, здесь есть два состояния - flowlabel рандомизируется в каждом ретрансмите, либо зафиксирован для всех пакетов в сессии. Последнее нужно для того, чтобы при включенной flowlabel-балансировке на торах, соединения к stateful-сервисам (L3 ipvs, TUN64, NAT64) шли одним и тем же маршрутом и попадали в один и тот же инстанс anycast-адреса.
В-третьих, она умеет в каждом втором SYN-ретрансмите выставлять так называемый YaTTL-бит, равный текущей краске +1 (CS[0-5] + 1), а также в нем же фиксировать flowlabel. Этот бит нужен для мониторинга и более точного определения проблемных участков сети со стороны НОК.

## tcp_tos

Программа для покраски трафика по направлениям и по project id.

## tclass_lock

Программа для запрета изменения краски трафика (IPV6_TCLASS). По сути, если в setsockopt передается IPV6_TCLASS, то мы просто скипаем логику в ядре и возвращаем 0.

## net_stat_{tx/rx} / net_stat_dc_{tx/rx}

Программы для посигруппного сбора сетевой статистики, в том числе с разбивкой по ДЦ.
