# Заказ работ

## Регламент

1. Заказчики (ITDC, NOC, ...) определяются с основными направлениями проводимых работ и проводят их разбиение по ДЦ и стойкам свитчам. Составляют предпочтительный план проведения работ постоечно и распределяют понедельно.

2. В начале каждой неделе план по свитчам на следующую вносится [документ](https://yandexteam.sharepoint.com/:x:/s/Relocation21_GLOBAL/EWkKB-0rwshGhssx-9qg5-0BcEPyPmTy4HUC3zsdpiFYfQ?e=0Lj981), по котрому должны быть получен ОК от warwish@ или max7255@ по каждой стойке, согласование и синхронизация будет производиться в [чате](https://t.me/joinchat/EBa9khgDp4UGx7Ji).

3. После согласования плана, заказчикам необходимо будет заводить сценарии на проведение работ. Как правило, ожидается что сценарии на следующую неделю будут заводиться на текущей. Учитывая текущие worst-case ограничения, описанные в [регламенте разгрузки](https://rtc.yandex-team.ru/docs/operations/rack-maintenance#yp-proekty), работы **на понедельник следующей недели** необходимо заводить **за 5 дней** - то есть, **в среду на текущей неделе**.

4. В согласованные дни закачики получают запрошенные хосты/стойки для выполнения работ.

5. После проведения работы со стойкой, заказчики обязаны дождаться успешного завершения сценария (этапа возврата хостов в RTC). Если этот этап затягивается **свыше 2 часов** - мы считаем это нештатным поведением, просьба сразу обращаться к дежурным SRE для оперативной оценки и решения проблем.


Заказать работы можно через [форму](https://forms.yandex-team.ru/surveys/18592/).

Если вы хотите получить квоту в YP то стоит воспользоваться другой [инструкцией](../quotas.md#how-to-get).


## Почему так

### Введение
В процессе эксплуатации хостов, стоек, ДЦ или сетевой инфраструктуры зачастую возникают задачи требующие выполнения физических работ с хостами - перестановки, замена свитчей, оборудования в стойках, электропитания - и тд.

При этом, службы ITDC и NOC работают независимо - как друг от друга, так и от пользователей хостов или тенантов облака над этими хостами - в частности, в RTC.
Проведение таких работы "несмотря ни на что" чревато потерей данных, проливом трафика или потерей запаса вычислительной емкости сервисов.

Поэтому, для выполнения таких работ у нас установлен механизм синхронизации между RTC и ITDC/NOC.


### Проведение работ в RTC, проблематика
Раньше это выполнялось через отдельные заявки в очередь к SRE RTC, теперь мы перешли на механизм сценариев.

Для проведения работ с каким-то множеством хостов или стоек, пользователи должны заблаговременно заводить сценарии проведеиня работ.

Под капотом сценария будут происходить этапы согласования и расселения, а также синхронизация этих работ между различными компонентами системы. И, к заказанному времени проведения работы автором сценария требуемые стойки/хосты будут расселены/подтверждена безопасная работа - и машины можно будет безопасно для пользователей выключать.

Практика показала, что у этого подхода есть ограничения:

1. Число заявок на работы от ITDC и NOC оказалось довольно велико и наши текущие пайплайны не могут адекватно обработать такие "берсты".

2. Из-за сложности внутренней структуры RTC, мы не можем досконально гарантировать сроки расселения/отдачи каждого свитча. Также случаются различные риски и накладки.

3. У нас появилась необходимость следить за природой работ происходящих под нами, так как это может потенциально влиять на стабильность и производительность кластера.

4. Есть риски возникновения гонок между ITDC & NOC, так как обе службы заказывают достаточно большое число работ, так что их пересечение может приводить к проблемам и затупам.

Огня добавляет тот факт, что работы заказывают у нас два больших самодостаточных
актора - NOC и ITDC.

Указанные проблемы приводят к формированию задержек и срывов планов работ у ITDC и NOC - эту проблему необходимо решать ASAP.

### Предлагаемый workaround

Указанные предпосылки намекают на необходимость разработки автоматики планирования, синхронизации и ограничения сценариев, для координации между всеми заинтересованными сторонами.

Прямо сейчас мы не сможем предоставить такой инструмент, основные причины:

1. Нам сейчас не хватает информации - ни по типичным кейсам, ни по всем возможным возникающим (и появляющимся в процессе жизнедеятельности системам) проблемам - без этого, качественный "планировщик сценариев" сделать не представляется возможным. Необходимо накопления такого опыта и фиксация его в сколько-нибудь формальном виде.

2. Наши (и wall-e, и SRE) возможности в плане ресурсов на разработку - ограничены, пока не можем позволить себе погрузиться в такую неформально поставленную задачу.

Дальнейшие изыскания команд Wall-e и SRE по данному вопросу ведутся в [тикете](https://st.yandex-team.ru/WALLE-4250)

Учитывая указанное, предлагается ввести промежуточное согласование и планироивание работ NOC/ITDC совместно с SRE - последние будут консультировать, модифицировать и согласовывать набор работ на предстоящую неделю. Это позволит нам более предсказуемо выполнять и заказывать работы, оценивать потенциальную суппортную нагрузку на дежурных RTC, а также расселять сами хосты "вовремя".
