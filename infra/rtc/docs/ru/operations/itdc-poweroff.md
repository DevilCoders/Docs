# Назначение
Форма [русская версия](https://forms.yandex-team.ru/surveys/18592/), [английская версия](https://forms.yandex-team.ru/surveys/45986/) предназначена для заказа перевода единичных хостов в maintenance (с выключением) и ускорения этого процесса.

## Порядок работы с формой
1. Заполнить форму:
* в поле `Тип работ` необходимо выбрать `выключение хостов для ITDC`.
* в поле `Список ID` серверов необходимо указать инвентарные номера серверов, один номер в строке.
* в поле `Тикет из очереди ITDC` необходимо указать тикет, по которому происходит выключение.
* в поле `Ответственный за работы` необходимо указать логин человека, отвечающего за работы.
2. Дождаться отбивки в тикете из очереди ITDC, что хосты выключены;
2. Выполнить работы;
2. Включить сервер;
2. Закрыть тикет из очереди ITDC;
* с соответствующим тикету из очереди ITDC тикетом в очереди RUNTIMECLOUD ничего делать не требуется

## Как это работает
1. После заполнения формы в очереди `RUNTIMECLOUD` будет создан тикет, связанный с указанным в форме тикетом из очереди ITDC.
2. Тикет из очереди RUNTIMECLOUD обрабатывается роботом. Робот выполняет следующие действия:
* проверяет права пользователя на операцию
* проверяет входные данные
* проверяет лимит на количество одновременно выполняемых операций
* выполняет операцию
3. На каждом этапе в случае ошибки робот сообщает статус операции в оба тикета комментарием с описанием.

### Порядок проверки прав пользователя на операцию
* проверяется ABC группа ответственного. Ответственный должен состоять в группе [Служба IT инфраструктуры датацентров](https://abc.yandex-team.ru/services/EXP/) с ролью `Поддержка`.
* в случае обнаружения ошибки в оба тикета пишется причина ошибки, тикет в очереди RUNTIMECLOUD закрывается, обработка прекращается.

### Порядок проверки требований к хостам
* не более **8** в тикете.
* введены в Wall-E.
* находятся в проектах,  управляемых RTC (у проекта есть тег `rtc`).
* **все хосты находятся в одной стойке**.
* в случае обнаружения ошибки в оба тикета пишется причина ошибки, тикет в очереди `RUNTIMECLOUD` закрывается, обработка прекращается.

### Проверка на количество одновременно выполняемых операций
* проверяется ограничение на количество одновременное выполняемых операций (тикетов). В настоящий момент установлен лимит в **две** операции.
* в случае превышения лимита производится соответствующая запись в тикеты и выполнение приостанавливается до тех пор, пока не появится свободная квота.

### Порядок выполнения операции
* Хостам посылается команда `set-host-maintenance power-off:True `.
* В случае ошибок с какими либо хостами информация об этом заносится в оба тикета.
* После перевода **всех** хостов из заявки в `maintenance`,  производится запись в оба тикета, а тикет из очереди `RUNTIMECLOUD` завершается как решенный.
  **Примечание:** робот отслеживает факт перевода хоста в `maintenance`, который происходит после отправки команды на `power-off`. Сам факт выключения хоста не проверяется. Обычно такой переход занимает не много времени.
* После появления в тикете записи о том, что перевод в maintenance состоялся, если хосты физически ещё не выключены, их можно выключать по кнопке.

