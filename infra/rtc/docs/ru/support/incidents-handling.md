# Обработка инцидентов

## TL;DR
1. Запустите [инцидент](https://wiki.yandex-team.ru/jandekspoisk/sepe/dezhurnajasmena/procedures/zelenyjj-protokol/) через YaIncBot с помощью команды `/green`
1. Уведомите ответственных
1. Выберите координатора
1. Заведите соответствующее событие в infra и уведомите своего руководителя
1. Устраните влияние на пользователей и почините проблему
1. Заведите SPI и привяжите протокол к нему командой `/green SPI-XXXXX`
1. Завершите протокол командой `/green end`
1. Не забудьте разобрать инцидент

## Подготовительный этап
1. 5 минут: по первым признакам определяется команда, к которой относится инцидент. Уведомляется ее(их) руководители вплоть до уровня службы. Уведомить необходимо любым способом (по телефону, ночью и т. д., не оставляя попыток до успеха), если не удается - эскалировать более высокому руководителю. Это можно делегировать в MARTY.
1. 2 минуты: руководитель этой команды или замещающий его коллега назначает координатора инцидента (далее Координатор). Координатора нужно назначать с учетом того, что он НЕ должен чинить инцидент собственноручно (или, в крайнем случае, помогать делать это только после выполнения регламентных действий). Им рекомендуется назначать в порядке приоритета:

- технического менеджера предметной области, достаточно опытного, чтобы определить остальные роли и грамотно формулировать им задачи
- самого руководителя или замещающего его коллегу (самоназначение)
- инженера, хорошо знакомого с предметной областью, но не самого опытного (т. к. ему предстоит работать над инцидентом).

## Действия Координатора после назначения
1. 2 минуты: назначение технического руководителя инцидента (далее Руководитель). Эту роль должен исполнять самый опытный (в области инцидента) из присутствующих на рабочем месте инженеров. Им может быть и Координатор, но тогда задачи координатора должны выполняться в приоритете. В последствии, роль можно передать более опытному коллеге, с которым удастся связаться удаленно (при необходимости в случае высокой серьезности инцидента). Дальнейшая работа должна проводиться в тесном взаимодействии с Руководителем.
1. 1 минута: для инцидентов, которые затрагивают пользователей, создать событие в infra. Если затронутые ДЦ неизвестны, создается событие в среде ALL.
1. 2 минуты: заводится специальный чатик по координации инцидента, в него добавляются необходимые коллеги.
1. 2 минуты: если SPI еще не создан дежурной сменой, он создается самостоятельно или координируется его создание силами дежурной смены.
1. После уточнения зоны поражения создаются дополнительные / модифицируется созданное событие в infra для уточнения затронутых ДЦ.
1. В случае получения примерной оценки времени до разрешения от Руководителя, вносит соответствующую информацию в infra.
1. 5 минут: После того, как одна из гипотез оказывается верной, Координатор останавливает работу инженеров и, если они более не нужны, возвращает их к текущим задачам.
1. 5 минут: После разрешения инцидента с помощью infra делается уведомление о его окончании. Координатор с Руководителем назначают ответственного за разбор инцидента (одного из них или др. опытного инженера).

## Действия технического руководителя инцидента
1. Начать расследование и купирование проблемы. Подготовить гипотезы о причинах инцидента и способах быстрого купирования проблемы (hotfix в объеме, необходимом для быстрого ремонта). Передать данную информацию Координатору с просьбой найти необходимых в проведении исследования инженеров (вместе с гипотезами сообщаются, при необходимости, способы их проверки). Себе Руководитель берет на проверку наиболее вероятную причину.
1. После того, как находится причина инцидента и способ купирования проблемы, Руководитель (при необходимости, с участием коллег) подготавливает более детальный план по быстрому купированию инцидента, фиксирует его в инцдентном тикете или координационном чате, формирует задачи и распределяет их между коллегами. План должен по возможности включать в себя:
2.1. Сбор сведений о масштабах инцидента (подсчет затронутых хостов) и проверку правильности гипотезы о причине (сверить, что гипотеза о причине подтверждается на всех хостах, где пользователи сообщали о проблемах).
2.2. Действия, предотвращающие потерю логов и истории на хостах для детального разбора инцидента.
2.3. В случае необходимости проведения действий, ведущих к потере какой-либо информации о хостах во время инцидента, все полезные и уничтожаемые данные сохраняются в надежном месте или оставляются хосты для более глубокого изучения.
2.4. Сохранение небольшого количества хостов с проблемой для постинцидентного изучения. Такие хосты не должны затрагивать пользователей.
1. На любом этапе процесса не реже, чем каждые 15 минут обновляет Координатора свежей информацией об инциденте. По возможности передает информацию о примерном времени до разрешения инцидента. Вносит необходимую для дальнейшего разбора информацию в тикет инцидента.
1. После того, как инцидент завершен, уведомляет об этом Координатора. Руководитель и Координатор назначают ответственного за разбор инцидента (одного из них или др. опытного инженера).

## Действия других инженеров
Помогают в расследовании (проверке гипотез о причинах инцидента), починке инцидента. Выполняются только те действия, которые согласованы координатором и Руководителем. Вести общение нужно преимущественно через Координатора, чтобы не мешать другим коллегам и Руководителю. После того, как гипотеза оказывается верной, информация об этом передается в Руководителя.

## Разбор сразу после купирования инцидента
Как только инцидент исчерпан (в нерабочее время начать нужно не позднее начала следующего рабочего дня), ответственный за разбор инцидента проводит более глубокий анализ инцидента. В случае, если гипотеза, на основе которой делали hotfix оказывается неверной:

- если снова страдают пользователи: фиксируется рецидив инцидента и регламент повторяется
- если пользователи не страдают: проводится поиск реальной причины инцидента в рабочем порядке с наивысшим приоритетом.

