# Dist Proxy
[dist_proxy](https://nanny.yandex-team.ru/ui/#/services/catalog/dist_proxy/) - сервис для раздачи внутренних debian-репозиториев 
(и не только). Часть сервиса dist.yandex.ru. Пользовательская и немножко админской документации можно найти [тут](http://wiki.yandex-team.ru/runtime-cloud/services/dist/).

В директории bundle находятся конфиги, которые используются в сервисе. Конфиги собираются с помощью YA_PACKAGE в tgz-пакет. Сам пакет используется в сервисе в качестве верхнего porto-слоя. Маппинг путей в слое: `./bundle -> /conf`.


## Побочные функции
* Раздача legacy dist-archive
* Раздача наливочных образов

## Раздача legacy dist-archive
Активно закапываем в HOSTMAN-449. 

## Раздача наливочных образов
Исторически сложилось так, что дист начал раздавать наливочные образы, чтобы при наливке/переналивке ДЦ setup смог выдержать нагрузку (подробная история зафиксирована в HOSTMAN-451). Такое решение выглядит логичным.

Конфигурация раздачи образов находится в `nginx_sites_10-dist-proxy.conf.tmpl` и `nginx_proxypass-setup-s3.conf`. 

В `nginx_sites_10-dist-proxy.conf.tmpl` настроена раздача образов для RTC и настроены location для подключения `nginx_proxypass-setup-s3.conf`.

В обоих случаях схема выглядит так: dist_proxy кеширует у себя (с небольшим TTL, но с достаточно большим периодом отдачи stale data) и раздает запрашиваемые образы. Сами образы лежат в s3 и управляются независимо от диста.

## Неочевидные костыли, требующие объяснения
### vhost на порту 8088
Этот vhost предназначен для взаимодействия кондуктора с дистом. При выкатке тикетов кондуктор ходит в этот vhost dist_proxy в ручку `POST /dmove` для перемещения пакетов из ветки в ветку. Такая схемса используется т.к. в кондукторе для репозитория указывается fqdn и этот же fqdn используется для конструирования запросов на dmove. Эти запросы дальше пробрасываются на dist_duploader, на котором уже запущены dmove driver. Заставить кондуктор ходить напрямую в duploader возможности нет, т.к. кондуктор используется для выкатки пакетов не только с использованием диста.

