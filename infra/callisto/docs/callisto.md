Каллисто – это полностью автоматический конвейер, выгружающий базу из YT,
раскладывающий выгруженное по проду и бесшовно переключающий прод.
Основной смысл: каллисто требует 10% дополнительной мощности для бесшовного переключения,
причем можно сделать и 5%, и 1%, заплатив скоростью переключения.

**Выгрузка из YT**
Управляется табличкой (https://yt.yandex-team.ru/arnold/navigation?path=//home/callisto/shard_deploy/callisto_base).
Когда в табличке появляется новая запись,
контроллер выгрузки раздает задания выгружающим демонам (одно задание – один шард).
В дальнейшем контроллер выгрузки следит за выпадениями и скоростью работы демонов и перепланирует задания
(TODO: описать алгоритм перепланирования). Выгруженные шарды регистрируются в трекере; 
трекер – это http api над динамическим таблицами в YT.

**Раскладка в прод и переключение**
Алгоритм (упрощенно): 
1) разобьем шарды на несколько групп (например, сейчас это 180 шардов в 10 группах) 
и выделим в проде мощности под 11-ю группу, изначально там ничего нет и в конфигах вышестоящего уровня этой группы нет
2) запустим выкладку в 11-ю группу шарды 1-й группы новой базы и запустим над шардами базовый поиск;
так как вышестоящий уровень ничего про эту группу не знает, запросы в неё не пойдут
3) когда нужная степень репликации шардов в группе будет достигнута
(например, сейчас алгоритм требует присутствия каждого шарда в 5 репликах из 6),
сгенерируем новый конфиг для вышестоящего уровня таким образом:
1-ю группу старой базы из конфига уберем, 1-ю группу новой базы, запущенную в 11-й группе прода, в конфиг включим
4) переконфигурируем вышестоящий уровень не одновременно, а каким-нибудь окном, например, по 2 инстанса из 60
5) повторим эти шаги для 2-й группы шардов, используя в качестве пустой группы освободившуюся 1-ю

Этот алгоритм реализован в контроллере переключения. В реальности чуть более сложно,
так как нужно корректно выходить из ситуаций, когда одна база выехала в прод не полностью, а уже появилась следующая.
Алгоритмом в этом случае гарантируется прогресс, и определенные группы определенных баз могут быть пропущены,
чтобы быстрее догнать выгрузку, то есть, например, 3-я группа переключится сразу на базу + 2 от текущей.

Контроллеры – это процессы, работающие в единственном экземпляре (захватывается распределенная блокировка).
Перезапуск и/или остановка контроллера приводит к остановке конвейера, но никак не сказывается на работе прода:
каждое атомарное управляющее воздействие контроллера оставляет прод в стабильном состоянии.