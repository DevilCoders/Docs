---
title: Сценарии
rank: 30
---

### Сценарии

#### Отправка транзакционного письма через Оркестратор

**Последовательность вызовов**

 - Orchestrator формирует контекст письма, чеки, ваучеры
 - Orchestrator вызывает API Notifier

   - Вызов обрабатывается API
   - API передает задачу в Процессинг
   - Процессинг вызывает Отправщик
   - Отправщик собирает данные и вызывает Renderer

     - Renderer отображает данные в html, возвращает их Отправщику
   
   - Отправщик передает html и вложения в sender

В случае переотправки - Админка вызывает те же методы АПИ.


#### Onboarding письма

**Последовательность вызовов**

  - travel-front вызывает travel-api
  - travel-api вызывает API Notifier
  
    - API вызывает Процессинг

      - Модуль подписок в Процессинге сохраняет новую подписку
      - Модуль onboarding писем в Процессинге вызывает Планировщик, планируя отправку писем на +k и +n дней
      
        - Планировщик планирует отправку писем
        
  - асинхронно, в нужное время Планировщик вызывает Процессинг
    - Процессинг вызывает Отправщик
    - Отправщик вызывает Renderer
    - Отправщик вызывает sender


#### PreTrip

**Последовательность вызовов**

 - Orchestrator формирует контекст письма, чеки, ваучеры
 - Orchestrator вызывает API Notifier

   - Вызов обрабатывается API
   - API передает задачу в Процессинг
   - Процессинг планирует отправку писем в Планировщике

 - в нужное время Планирощик передает задачу в Процессинг
   - Процессинг проверяет состояние заказа и передает задачу в Отправщик
   - Отправщик собирает данные и вызывает Renderer
     - Renderer отображает данные в html, возвращает их Отправщику
   
   - Отправщик передает html и вложения в sender

#### Дополнительные письма по заказу (например ссылки на рассрочку)

**Последовательность вызовов**

 - Orchestrator формирует контекст письма
 - Orchestrator вызывает API Notifier

   - Вызов обрабатывается API
   - API передает задачу в Процессинг
   - Процессинг вызывает Отправщик
   - Отправщик собирает данные и вызывает Renderer

     - Renderer отображает данные в html, возвращает их Отправщику
   
   - Отправщик передает html и вложения в sender

В случае переотправки - Админка вызывает те же методы АПИ.


#### ad-hoc маркетинговые рассылки

Важный нюанс тут в том, что такие рассылки должны рассылаться тем, кому нужно (либо у людей стоит галочка о согласии на спам, либо другие правила - в т.ч. по всей базе email'ов). Сами письма могут верстаться внешними людьми и попадать к нам в виде готовых html.

**Последовательность вызовов**

  - Notifier вызывает renderer
  - Notifier вызывает sender
  
`TODO: прояснить схему работы с транзакционными письмами, в частности кем, как и когда формируются эти самые списки получателей.`
