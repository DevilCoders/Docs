# Что это?
Это тулза, которая позволяет поставить задания толокерам на сопоставления геобъктов из баз поставщиков в наши.

# Как пользоваться?
1) Клонируете [pool](https://toloka.yandex.ru/requester/project/15923/pool/2937571 "Жми") (Справа будет кнопка со стролочкой, расположенная рядом с редактировать -> Клонировать)
2) Меняете название pool на `production YYYY-MM-DD`
3) Идете вниз и жмете кнопку желтую **Cохранить**
4) Из урла выдираете pool_id  `https://toloka.yandex.ru/requester/project/[project_id]/pool/[pool_id]`
5) И запоминаете его, он пригадиться позже
6) Затем заливаете обучающие и контрольные задания, которые я приложил в этот [таск](https://st.yandex-team.ru/BUSES-11/ "Жми"):
7) На странице с pool ищите кнопку загрузить (она желтая)
8) Выбираете умное смешевание
9) Ничего не меняете
10) Жмете на другую кнопку загрузить (она тоже желтая)
11) Выбираете скаченный файлиз пункта (6)
12) Потом оно подумает, и предложит добавить
13) Жмем на желтую кнопку `добавить`
14) на странице pool у вас должно отобразиться, что 91 задание обучающее и 194 контрольных, все остальное по нулям
15) Затем идете на свою дев машинку
16) И определяете две переменнуе окружения TOLOKA_TOKEN, CONNECTION_SCRIPT. Все пароли и явки [здесь](https://yav.yandex-team.ru/secret/sec-01d4jmyzbwd2wyxr3asq9m9dkc "ЖМИ")
17) И запускаете мой бинарник
18) `./toloka_matcher upload --pool-id POOL_ID --limit LIMIT --supplier SUPPLIER`
```
POOL_ID берете из шага (5)
LIMIT максимально количество созданных заданий (В апи толоки нельзя слать слишком много заданий рекомендую лать по 1000)
SUPPLIER список поставщиков, через запятую и слитно (s1,s2,s3). Если не указано, будет выгребаться по всем
```
19) Затем идете на страницу pool и убеждаетесь, что ваши задачи там оказались
20) Жмете на кнопку запустить (кнопка выглядит как значек плеера)
21) Оставляете толоку в покое на денек
22) На следующий день приходите, и убеждаетесь, что все ваши задания обработаны толокой, если нет, то на шаг (21)
23) Затем нужно загрузить данные обработанные данные из толоки:

`./toloka_matcher fetch --pool-id POOL_ID`

24) Затем нужно эти данные применить к нашей базе:

`./toloka_matcher apply`

25) Затем нужно применненые данные из таблицы toloka_matching перенести в toloka_results (пока руками через psql)
```
INSERT INTO matching.matching (rasp_id, supplier, supplier_id) (
    SELECT 
        code, supplier, supplier_id FROM matching.toloka_aggregated_results 
    WHERE 
        (supplier, supplier_id) NOT IN (SELECT supplier, supplier_id from matching.matching) 
        AND score >= 0.8 AND code IS NOT NULL
);
```

26) Затем идете на страницу pool и архивируете его

27) Готово!
