# Debug

## Получение информации об использовании памяти

Возможно произвести запись файлов со статисктикой использования памяти и снэпшота кучи. Перед записью производится запуск сборщика мусора (для его запуска node должна быть запущена с флагом `--expose-gc`. supervisor в контейнере запускает процесс с данным флагом). Для того, чтобы модуль heapdump не производил запись еще одного снэпшота по сигналу SIGUSR2, нужно чтобы процесс имел переменную окружения `NODE_HEAPDUMP_OPTIONS=nosignal` (процессы node в контейнере имеют данную переменную и локальный сервер тоже).

Чтобы записать файлы нужно выполнить команду

```bash
kill -USR2 <pid>
```

где `<pid>` - это id процесса.

Файлы появятся в директории `/reports/memory/<pid>/2020-09-08_09-39-00/`.
Для анализа файл со снэпшотом кучи (.heapsnapshot) можно загрузить в chrome dev tools на вкладке memory.

Процесс создания снэпшота кучи синхронный и на момент создания увеличивает количество памяти, используемой процессом, миниму в два раза.
