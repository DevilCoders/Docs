###### Тулза для подгонки distribution.pb.txt - конфига распределения хостов/IP по воркерам.

Использование по шагам:
1. Подготовка таблицы со статистикой распределения запросов
    
    `./monstercalc calc -i <logs> -o <out> --shards <count> --distr <config> --proxy <yt_cluster>`
    
    Где:
   
    `<logs>` - таблица логов зоры вида `//logs/zora-spider-info-logs/30min/2021-05-25T15:00:00`
   
    `<out>` - путь выходной таблицы
   
    `<shards>` - число шардов в rolekeeper'е, можно посмотреть в `rolekeeper_spider.pb.txt` конфиге нужной инсталляции
   
    `<config>` - путь до нынешнего `distribution.pb.txt` или `explicit_distribution.pb.txt` конфига. 
   Он нужен для правильного вычисления хостового суффикса и оценки качества получившегося конфига

    `<yt_cluster>` - здесь и далее имя кластера, по умолчанию `arnold`
   

2. Подготовка хостовой статистики

    `./monstercalc hosts -i <calc> --output-by-size <out_size> --output-by-count <out_count>`

    Где:
   
    `<calc>` - `<out>` прошлого этапа
   
    `<out_size>` - таблица со статистикой хостов по размеру
   
    `<out_count>` - таблица со статистикой хостов по числу запросов


3. Генерация конфига

    `./monstercalc generate -h <hosts_size> -h <hosts_count> -e <explicit_conf> -o <out_conf> --distributed-size <size> 
   --distributed-count <count> --default-distr <def> --top-hosts <top> --min-distr <min_distr>`
   
    Где:

    `<hosts_size>`/`<hosts_count>` - полученные с прошлого этапа таблички
   
    `<explicit_conf>` - конфиг с явно заданными правилами. Можно использовать `config_examples/explicit_distribution.pb.txt`,
   пропустить или подготовить новый (для этого потребуется таблица IP-монстров, см. ниже).
   
    `<out_conf>` - генерируемый конфиг
   
    `<top_hosts>` - число хостов в когфиге, берутся самые большие

    `<min_distr>` - минимальный коэффициент распределения для попадания хоста в конфиг. Оптимальные значения в диапазоне [2..4]

    `<count>`/`<size>` - сколько примерно документов/гигабайт должен прокачивать один шард за интервал времени лога (полчаса). 
   Вычисляется из RPS лимита и сетевой нагрузки спайдеров и числа шардов на спайдер. Либо можно взять из поля `Comment`
   предыдущего конфига. Соответственно эти параметры запишутся при генерации нового конфига.
   
    Должно получиться что-то похожее на `config_examples/distribution_before_merge.pb.txt`
   
    
4. Склеивание сгенерированного конфига со старым. По сути это нужно чтобы размазать сравнительно маленькие хосты для увеличения их рейта прокачивания

    `./monstercalc merge --new-input <new_in> --old-input <old_in> --new-output <new_out> --old-output <old_out>`
   
    Где:

    `<new_in>` - сгенерированный на прошлом этапе конфиг

    `<old_in>` - путь до `distr.conf` конфига зоры

    `<new_out>` - склеенный конфиг в новом формате

    `<old_out>` - склеенный конфиг в старом формате
   

5. Перепроверка полученного конфига.
   Для этого считаем статистику по шардам командой
   
    `./monstercalc calc -i <in> -o <out> --shards <count> --distr <config>`
   
    аналогично этапу 1, подставляем `<new_out>` конфиг из этапа 4. Далее генерируем статистику по шардам:

    `./monstercalc shards -i <in> --output-by-size <out_size> --output-by-count <out_count>`

    Где:
   
    `<in>` - таблица с только что сгенерированной статистикой, т.е. `<out>` из прошлого запуска

    `<out_size>`/`<out_count>` - таблицы со статистикой по размеру и числу запросов.

    Анализируем полученные таблицы - в идеале на самых больших шардах должно оказаться не больше значений `<count>`/`<size>` из шага 3.
   Если это не так - повторяем шаги 3..5, указав меньшие значения
   

6. (опционально) Чтобы подготовить IP-распределение необходимо сварить статистику IP-шников, добавить большие IP в
   `explicit_distribution.pb.txt`, и подставить его при генерации конфига (этап 3).
    
    `./monstercalc ips -i <logs> --output-by-size <out_size> --output-by-count <out_count>`

    Где:
   
    `<logs>` - табличка логов зоры, по аналогии с этапом 1
    
    `<out_size>`/`<out_count>` - выходные таблички IP-шников по размеру/числу запросов.


В конце концов должно получиться что-то похожее на `config_examples/distribution.pb.txt`
