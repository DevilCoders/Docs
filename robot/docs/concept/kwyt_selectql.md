Информация о проиндексированным Zora страницах хранится в таблицах Kwyt, откуда можно забрать, к примеру, текстовый архив таких страниц, однако забирать эти данные в свободном доступе не получится, поскольку доступ к ним был закрыт. В открытом доступе останется [линк на один шард](https://yt.yandex-team.ru/arnold/navigation?path=//home/kwyt/examples/original_pages) и еще для тестов есть [маленький сэмпл всех шардов](https://yt.yandex-team.ru/arnold/navigation?path=//home/kwyt/examples/pages)


## Почему данные закрыты?
В Квите есть много шардов. В каждом есть стейт (data) и постоянно копятся дельты. Наш процесс берёт очередной шард и создаёт в нём новый стейт, подмёрживая дельты к старому. Физически создаётся новая табличка стейта с тем же путём, а старая удаляется (это стандартный механизм работы транзакционности в YT). На один шард уходит примерно час, весь KwYT обрабатывается примерно за сутки.
Внешние операции над таблицами, в том числе YQL, берут read-lock на таблицы, то есть, заблокирует ее удаление. Если операция и наш процесс пересекутся (то есть, наш процесс обработает шард, на который операция взяла read-lock), то старая табличка со стейтом не сможет удалиться и будет жить в памяти YT, пока операция не завершится и не снимет блокировку. Причём жить она будет в квоте KwYT. И чем больше будет таких таблиц - тем больше лишней фантомной памяти будет использовано из нашей квоты. В какой-то момент память кончится, и процесс зависнет.

Ранее из-за таких операций процесс периодически останавливался, поэтому сейчас доступ выдается только тем людям/роботам, которые не будут запускать операцию над более чем одной таблицей KwYT.

А чтобы это условие было проще выполнить, можно использовать два инструмента: **qwytql** и **selectql**.

## qwytql

Первый инструмент, [qwytql](https://a.yandex-team.ru/arc/trunk/arcadia/robot/kwyt/tools/kwytql) последовательно выполняет указанный запрос над всеми (или указанными) шардами kwyt. С его помощью также можно указать pre-query и final-query, которые выполнятся соответственно до и после основных операций.

```js
  --yql-token TEXT           Yql token
  --yql-token-path FILENAME  path to yql token
  --pool TEXT                YT pool
  --query FILENAME           путь к файлу с запросом, который нужно выполнить. Используйте "{input}" в качестве входной таблицы. Также можно использовать {shard_number}, например для создания временных таблиц для хранения промежуточных результатов, или для получения информации о шарде, из которого получили результат
                             tables names  [required]
  --final-query FILENAME     путь к файлу с запросом, который выполнится после того, как отработает основной запрос на всех шардах
  --pre-query   FILENAME     путь к файлу с запросом, который выполнится до основного запроса
  --shards-list TEXT         список шардов, на которых нужно выполнить запрос в формате "1-3,5,7-10,12". Если не указано, будут обходиться все шарды квита
  --kwyt-path TEXT           Путь в yt к таблицам данных. (По умолчанию - /home/kwyt/pages)
  --use-two-operations       Можно запустить одновременно две операции (при этом они не должны складывать результаты в одну таблицу)
  --cluster                  кластер yt, на котором выполнять запросы. Дефолтное значение - arnold
  -v, --verbose
```

Пример:
```js
./kwytql --pool pool --query ./query --shards-list 1-5,7,8 --kwyt-path //home/kwyt/examples/pages/ --final-query final_query
```
То есть, выполнить запрос из файла query над шардами 1-5,7,8, после этого выполнить final_query. Операции видны в интерфейсе yql пользователя, от имени которого запускается скрипт. Пока что история будет засоряться запросами для каждого шарда. Это можно будет исправить, когда yql научиться [https://st.yandex-team.ru/YQL-14051](отпускать снапшот локи после commit).

Для инструмента также есть [кубик в нирване](https://nirvana.yandex-team.ru/alias/operation/kwytql-by-akhovrychev/options).
[Пример использования](https://nirvana.yandex-team.ru/flow/2f105851-233c-4cc2-8d8a-717b7cb6b65c/263447c1-01b3-4d01-8264-76dd6e46552c/graph/FlowchartBlockOperation/code/kwytql)
[Таск в sandbox](https://sandbox.yandex-team.ru/task/1167512875/view)

## selectql

Вторая, [selectql](https://a.yandex-team.ru/arc/trunk/arcadia/robot/kwyt/tools/selectql), умеет выбирать данные из kwyt либо по списку урлов, либо по условию. В случае со списком урлом она сначала вычитывает нужные данные из Yt, складывает во временную таблицу, потом применяет к ним yql-запрос. поскольку урл является одним из ключей в kwyt, то это работает быстрее, чем просто yql-запрос.

```js
  --yql-token TEXT           Yql token
  --yql-token-path FILENAME  Path to yql token
  --pool TEXT                YT pool
  --where TEXT               Условие
  --urls-list FILENAME       Файл со списком урлов
  --columns TEXT             Нужные колонки (В данный момент игнорируются, если происходит сразу чтение и запись в итоговую таблицу (то есть если не указан аргумент where))
  --output TEXT              [required] Таблица, в которую будут записаны результаты (в данный момент может быть только на арнольде)
  --limit TEXT               Лимит на количество строк (не используется при работе со списком урлов). Если лимит будет достигнут до обхода всех шардов, обход будет остановлен
  --get-last-version         Выбрать только последние скачанные докумениы (IsLast = True)
  --kwyt-path TEXT           Путь к данным квита (по умолчанию - //home/kwyt/pages/)
   --cluster                  кластер yt, на котором выполнять запросы. Дефолтное значение - arnold
Ей нужен YT_TOKEN, либо в ~/.yt/token, либо в переменной окружения YT_TOKEN
```

Пример 1:
```js
./selectql --columns '(Host || Path) AS Url, HttpCode' --output '//home/kwyt-test/akhovrychev/selectql_test_output' --urls-list urls  --get-last-version
```

- Получить Url и HttpCode для последних версий документов из списка урлов urls (также тут можно указывать where-условие)

Пример 2:
```js
./selectql --columns * --output '//home/kwyt-test/akhovrychev/trololo7' --where 'HttpCode = 404'  --get-last-version --limit 100
```

- выбрать все поля для 100 документов, удовлетворяющих условию 'HttpCode = 404'


И для нее тоже есть [кубик в нирване](https://nirvana.yandex-team.ru/operation/c0d6ce5c-5e11-411a-bb08-0382c7fdbd94/options).
[Пример 1](https://nirvana.yandex-team.ru/flow/5d22a4e1-9ad9-4921-9d36-00b7ddc91e02/301493ac-ddf2-4baa-a819-5b990baf982a/graph/FlowchartBlockOperation/code/selectql_mr_proc)
[Пример 2](https://nirvana.yandex-team.ru/flow/efbfa4ae-fea1-4f23-878a-fc57e2428d6a/abc60929-1b1e-4638-beff-e5a32421806e/graph/FlowchartBlockOperation/code/selectql_2)
И [таск для sandbox](https://sandbox.yandex-team.ru/task/1169673456/view).

## Как узнать, на каком шарде нужный url?

Если вам нужно узнать, на каком шарде в RTHUB лежит нужная вам страница или группа страниц, это можно сделать:
- При помощи [запроса в YQL](https://yql.yandex-team.ru/Operations/Yn5YyNJwbCy4l8K0MZKSimgyDVuUN8hcWPP3MiuvyxI=);
- Скрипта в [pyton](https://a.yandex-team.ru/arc/trunk/arcadia/robot/kwyt/tools/selectql/__main__.py?rev=r9398871#L43).

## Контактные данные

Получить доступ к таблицам квита можно будет, написав в [чат Kwyt/RThub](https://t.me/+QgT8d8lDxQqzvEjN)

