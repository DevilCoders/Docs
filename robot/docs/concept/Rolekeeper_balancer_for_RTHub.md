# Rolekeeper balancer for RTHub

Балансер состоит из двух частей: сам ролкипер на воркерах и полироль. Ролкипер пытается распределить партиции по воркерам наиболее равномерным образом. Но идеальной балансировки не существует, у нас всегда есть перегруженные партиции и/или воркеры. Поэтому полироль доводит балансировку до блеска: освобождает перегруженные партиции, чтобы их подобрали другие воркеры.

## Ролкипер на воркерах

[Код](https://a.yandex-team.ru/arc/trunk/arcadia/robot/rthub/algo/rolekeeper_balancer/rolekeeper_balancer.h)

С точки зрения ртхаба это обычный балансер, похожий на rthub_lb_balancer.

Как настроить:
* Прописать общие ролкиперные настройки. [Пример](https://a.yandex-team.ru/arcadia/robot/rthub/conf/conf-production/pages.pb.txt?rev=r9488485#L1578-1586);
* Для каждой пары {входящий топик, кластер} прописать роль, число партиций и вес (дефолтный вес - 1);

{% note warning %}

**число партиций входящего топика берётся из конфига**, при его изменении нужно обновить конфиг.

**Вес нужно задавать пропорционально потоку в одну партицию**, а точнее, cpu, необходимой для обработки одной партиции, подробности ниже. [Пример](https://a.yandex-team.ru/arcadia/robot/rthub/conf/conf-production/pages.pb.txt?rev=r9488485#L1578-1586).

{% endnote %}

* Для каждого инпута прописать `UseRolekeeper: true` и связанные с ним роли во всех кластерах (vla, sas, iva...). [Пример](https://a.yandex-team.ru/arcadia/robot/rthub/conf/conf-production/pages.pb.txt?rev=r9488485#L12-24).

{% note info "Проверь себя" %}

Для нового инпута нужно поменять два места: добавить новые роли с весами и партициями в конфиг ролкипера и привязать эти роли в самом инпуте.

{% endnote %}

Ролкипер пытается распределить все роли по воркерам так, чтобы суммарный вес ролей у воркеров был одинаковый (точнее, пропорциональный мощности, но она у нас [всегда 1](https://a.yandex-team.ru/arcadia/robot/rthub/algo/rolekeeper_balancer/rolekeeper_balancer.cpp?rev=r9488485#L37)). Например, воркер с толстой партицией весом 10 будет считаться сбалансированным с воркером с пятью партициями весом 2. Отсюда следует, что вес партициям стоит задавать пропорционально среднему cpu, который нужен на обработку. И понятно, что партиции одного топика в разных ДЦ могут иметь разный вес из-за разного потока.

Стейт ролкипера живёт на [Маркове и он человекочитаем](https://yt.yandex-team.ru/markov/navigation?offsetMode=key&path=//home/zora/rthub/pages/rolekeeper/roles)


## Полироль

[Код](https://a.yandex-team.ru/arcadia/robot/rthub/tools/balancer_polirol/__main__.py)

В любом случае, у нас будут перегруженные партиции: запись в партиции всё-таки неравномерная, балансировка не бывает идеальной, машинки могут быть плохими и т.п. И на таких партициях будет копиться лаг. При нативном запуске таких партиций было ~3%. В идеале перегруженные партиции нужно отдавать на другие хосты. Этим и занимается Полироль.

Идея простая: давайте найдём партиции с лагом, найдём воркеров, которые их обрабатывают, и ненадолго их выключим. Тогда партиции с лагом переедут на другие машинки и разгребутся. Плюс не стоит слишком часто выключать машинки. И стоит дать время на разгребание лага.

Алгоритм для одной итерации (все числа прописаны в конфигах и аргументах):
* читаем стейт Полироли и включаем машинки, которые включены уже 10 минут;
* читаем инфу про партиции pages:vla, находим там подозрительные (lag > 200k). Убираем из подозрительных те, которые мы дёргали за последний час, чтобы не дёргать партиции слишком часто;
* читаем инфу про привязку ролей из YT, находим там воркеров с подозрительными ролями. Из них убираем воркеров, которых мы трогали за последний час;
* Из получившегося списка берём 10 случайных и выключаем на них ролкипер. Через 10 минут мы их включим обратно, но за это время их роли уже уедут на другие машинки;
* Записываем в стейт полироли инфу про забаненных воркеров и их партиции.

Полироль запускается в rthub-cm раз в 5 минут. В pages 1k воркеров, за раз полироль останавливает не более 10. Так что даже если полироль сойдёт с ума, полная перебалансировка с помощью полироли будет занимать ~10 часов. Единичные потери стейта нам тоже не страшны - будет несколько неработающих машин, которые заработают с перевыкаткой.
