<div align="center">
    <img src="https://frontend.s3.yandex.net/health/_/heart.svg"><img src="https://frontend.s3.yandex.net/health/_/yandex.svg"><img src="https://frontend.s3.yandex.net/health/_/health.svg">
</div>

# Фронтенд сервиса


## Переменные окружения

`AD_DISABLED` - по умолчанию, в гермионе и в `development` окружении реклама выключена. <br/>
Для тестировании рекламы в локальном окружении нужно запускаться на стандртном порту. Чтобы запуститья на стандртном порту, нужны root-права. Пример запуска:

```sh
sudo AD_DISABLED= npm start -- --port 443
```

`BETA_HEALTH_API` - путь до беты HEALTH_API, используется для обновления GRAPHQL-схемы, пример:
```sh
BETA_HEALTH_API=http://kupsrskfu2uzrvzt.sas.yp-c.yandex.net:443/graphql npm run graphql:update-schema
BETA_HEALTH_API=http://kupsrskfu2uzrvzt.sas.yp-c.yandex.net:443/graphql npm run graphql:generate-types
```
`Не работает на виртуальных машинках QYP из-за permission denied, при этом пишет`:
```sh
Error: Expected undefined to be a GraphQL schema.
```

## Релиз

Автоотведение релизов отключено https://github.yandex-team.ru/search-interfaces/frontend/pull/12653

Релизный процесс живёт в терминах и понятиях [релизного цикла СЕРПа](https://wiki.yandex-team.ru/serp/release/).

### Планово

Релизы проекта подчиняются правилам планировщика отведения релизов для репозитория `frontend`.

Релизы для всех сервисов отводятся автоматически каждый [рабочий день в 4:20 утра](https://sandbox.yandex-team.ru/scheduler/13212).

В результате отведения релиза произойдёт следующее:

  - будет обновлена минорная версия сервиса (прямой коммит роботом в `master`);
  - будет создана релизная ветка (см. `services/health/.config/release.json` секция `git.releaseBranch`);
  - будет создан релизный тикет в очереди `SEAREL` с компонентом `YaHealth` (см. `services/health/.config/release.json` секция `issue.components`);
  - собранная статика будет выложена в production, а динамика на тестовый стенд для регрессионного тестирования.

#### Порядок проверок:

  - отведённый релиз автоматически переводится в `Ready for Regress` и попадает на радары QA инженера;
  - QA инженер проводит необходимые работы по регрессионному тестированию релиза (ассессоры, ручные проверки и т.д.);
  - QA инженер при положительном вердикте выставляет релизу статус `Tested` (`Протестировано`), иначе выход [1];
  - QA инженер или релизный менеджер (тот на кого назначен релизный тикет) уточняет у бэкенда, безопасно ли отправлять шаблоны в production, иначе выход [2];
  - QA инженер или релизный менеджер нажимает кнопку `Ready for production`;

[1] - если были найдены баги, то при текущем релизном цикле следует закрыть релизный тикет с резолюцией `Invalid`(`Некорректный`) и отвести [релиз вручную](#Релиз-вручную) после починки багов (вмержённых в мастер).

[2] - ждём готовности бэкенда, принятие решения о релизе лежит на менеджере команды (в случае, если релизный менеджер не владеет информацией).

#### После релиза

Релиз считается выкаченным в production как только автоматика закроет его, отметив время и дату выкатки.

Пишем в релизный чат [Health Releases](https://nda.ya.ru/3UYL2q) информацию о том, что выкатилось (версия + кратко и ёмко описание содержимого).

С этого момента следует мобилизоваться всем заинтересованным участникам команда, которые не заняты другой деятельностью, но в особенности QA инженеру или релизному менеджеру:

  - следует проверить работоспособность production
  - тщательно мониторить:
    - https://yasm.yandex-team.ru/panel/yamd
    - https://yasm.yandex-team.ru/panel/frontend-server-errors
    - https://yasm.yandex-team.ru/panel/frontend-client-errors
  - при возникновении непрекращающихся всплесков и/или явных проблем в production следует действовать согласно описанию [нештатных ситуаций](#Нештатные-ситуации).

#### FAQ:

  - Q: Если автоматический релиз отвёлся, но команда решает его не раскатывать?
  - A: Следует закрыть его с резолюцией `Invalid`(`Некорректный`).

  - Q: Если отведённый релиз не успели протестировать к тому времени когда автоматически должен быть отведён новый релиз?
  - A: Тикет прошлого релиза автоматически закроется с резолюцией `Invalid`(`Некорректный`), а новый отведётся штатно.

При закрытии релизных тикетов с резолюцией `Invalid`(`Некорректный`) происходит следующее:

  - робот удалит релизную ветку.

При закрытии релизных тикетов с резолюцией `Fixed`(`Решен`) кроме вышесказанного происходит следующее:

  - робот удалит релизную ветку и проставит релизный тэг (см. `services/health/.config/release.json` секция `git.releaseTag`).

### Релиз вручную

Для отведения внеочередного релиза существует [таск](https://sandbox.yandex-team.ru/scheduler/13842)

Все необходимые инструкции находятся в описании этого таска. Сервисозависимые значения:

    "SERVICE_NAME": "health"
    "RELEASE_TYPE": "minor"

Отведение релиза вручную допускается только с согласования с ответственным менеджеров и только в критических ситуациях.

После ручного отведения релиза следует руководствоваться описанию [планового релиза](#Планово).

## Нештатные ситуации

Такими ситуациями являются:

  - критичный баг в production, из-за которого следует откатить релиз;
  - необходимость выкатить hotfix релиз вручную.

При инцидентах в продакшн после выкатки вёрстки следует незамедлительно связать с дежурным по RR со срочной просьбой откатить шаблоны.

Узнать кто именно дежурит можно в [календаре дежурств](https://nda.ya.ru/3UYJvM).

Связываться следует непосредтсвенно по мобильному телефону: в ясной и понятной форме, соблюдая приличия и уважение,
изложить суть проблемы.

### Откатка релиза

Следует заранее приготовить ссылку на тикет в nanny, чтобы отправить его дежурному через любой канал связи.

### Hotfix

В случае необходимости выкатить в production правок с hotfix'ом нужно внести правки и вмержить их в master, а затем отвести [релиз вручную](#Релиз-вручную).

После [плановых проверок релиза](#Планово) отправляем hotfix нажатием кнопки `Ready for production`.

Общаемся с дежурным по мобильному телефону для сокращения времени доставки hotfix'а до пользователей.



**Внимание!** Дежурный RR работает с 12:00 до 20:00. Заявки дежурному, созданные после 20:00 будут обработаны на следующий день.


## Разное

#### Создание exp flags
Все флаги используемые в приложении должны иметь описание в виде `.json` файла в `/.expflags`
`npx expflags` интерактивная cli тулза для создания экспфлагов

Флаги появятся здесь https://ab.yandex-team.ru/flag_storage/flag#handler=HEALTH&ordering=name&is_deprecated=False

Настройки хендлера тут https://ab.yandex-team.ru/api/v1/flag_storage/handler/HEALTH

#### Тесты компонентов скриншотами через Storybook и Hermione

Перед снятием скриншота необходимо собрать Storybook командой `npm run storybook:build` или  достаточно выполнить команду `npm run hermione:storybook -- <имя файла>` или `npm run hermione:storybook -- --grep "<имя story>"` (save и play не нужно)

Для компонента нужно создать файл `*.stories.tsx`, где отобразить нужные состояния компонента. Пример:

```jsx
import React from 'react';

import { ComponentStories } from '@yandex-int/storybook-with-platforms';
import { Button, ButtonTheme, ButtonPin } from './Button';

new ComponentStories('Components|Button', Button, 'health')
    .add('plain', Button => (
        <Button
            theme={ButtonTheme.GREY}
            pin={ButtonPin.CLEAR_CLEAR}
        >
            Кнопка
        </Button>
    ));
```

Hermione-тест пишется в файле `*.hermione.js` рядом с файлом `*.stories.tsx`. Пример теста:

```js
specs({
    feature: 'Components',
    type: 'Button',
}, () => {
    it('plain', function() {
        return this.browser
            .yaOpenComponent('components-button--plain')
            .assertView('plain', this.PO.Button());
    });
});
```

В команду `yaOpenComponent` передается id story, который можно получить из URL `http://localhost:6006/?path=/story/`*`components-button--plain`*
