# Метрики из целей

В процессе сбора метрик есть несколько этапов:
- собрать метрики
- сохранить метрики
- настроить сбор по расписанию
- построить графики по сохраненным данным

## Важно

Все графы и реакции хранятся в [папке голсов](https://nirvana.yandex-team.ru/browse?selected=8999260) в Нирване. Именование:
- `{metric}` - граф для сбора метрики
- `{metric}-reaction` - реакция для запуска этого графа по расписанию

Все данные и графики хранятся в папке голсов в DataLens. Именование:
- `{metric}` - набор данных для графика
- `{metric}-chart` - график

## TLDR

Разбирать "как всё работает" будем на примере метрики заполненности людей из поискового портала в ОКР целях
- [Граф в Nirvana](https://nirvana.yandex-team.ru/flow/6fed2332-1ec4-4925-8306-65a3763bcf3f)
- [Реакция в Reactor](https://reactor.yandex-team.ru/reaction?id=8999397)
- [YT таблица](https://yt.yandex-team.ru/hahn/navigation?path=//home/goals/stats/search-portal-fullness)
- [DataLens Dataset](https://datalens.yandex-team.ru/datasets/mazwh0z6l348g-search-portal-fullness)
- [DataLens Wizard](https://datalens.yandex-team.ru/wizard/oc1ztic145egi-search-portal-fullness-graph)
- [График](https://datalens.yandex-team.ru/preview/oc1ztic145egi)

## Сбор метрик

Метрики собираются с помощью графа в [Нирване](https://nirvana.yandex-team.ru/). Граф состоит из кубиков - операций.  
В примере данные собираются из трекера и из стаффа, потом аггрегируются. Всё это происходит с помощью кубиков [Python3 Json Process](https://nirvana.yandex-team.ru/operation/ef1681df-f12e-4068-8b1b-ee3080973a07), которые умеют выполнять произвольный код на python3. На выходе получается JSON с метриками + timestamp для этого JSON

## Хранение метрик

Метрики нужно куда-то складывать. В данном случае мы складываем в YT.  
Папка для метрик [тут](https://yt.yandex-team.ru/hahn/navigation?path=//home/goals/stats), структуру стоит сохранять идентичную с Нирваной  
Чтобы передать метрики из Нирваны в YT используется кубик [Yt Put](https://nirvana.yandex-team.ru/operation/0026ce21-f924-4e21-9fca-586106a5808b), в котором задается куда и что складывать

## Сбор метрик по расписанию

Для запуска графа по расписанию существует сервис Reactor. Он проинтегрирован с Нирваной, добавить реакцию можно со странице графа

![Скриншот панели добавления реакции](https://jing.yandex-team.ru/files/poalrom/2021-05-31T12:07:10Z.f0aaa36.png)

![Скриншот панели добавления реакции](https://jing.yandex-team.ru/files/poalrom/2021-05-31T12:11:33Z.c72dc5e.png)

## Отображение данных на графиках

Для отображения данных используется [DataLens](https://datalens.yandex-team.ru/). В нём у нас есть собственная папка `goals`, в ней в папке `stats` хранятся данные и графики.

Чтобы построить график нужно 2 части: данные и сам чарт.  
Данные мы создаем через раздел "Датасеты", используем:
- подключение - robot-goals-yt
- таблица - таблица с данными из YT
- поля - все нужные поля для построения графика

![Скриншот настройки датасета](https://jing.yandex-team.ru/files/poalrom/2021-05-31T12:20:13Z.34b2020.png)

После этого создаем график по кнопке справа сверху со страницы датасета. Перетаскиваем нужные поля на график и всё готово!

## Для самых внимательных

### Как удобно отлаживать python код для кубика локально

Заходим в [папку в аркадии](https://a.yandex-team.ru/arc_vcs/junk/poalrom/goals-python-stats), смотрим как там сделан запуск, делаем так же.  
P.S. Магия лежит в utils.py в функции run. Она парсит аргументы из командной строки, как это делает сам кубик