# Генератор маршрутов
Стори: https://st.yandex-team.ru/GARAGEIDEA-150

## Как работает:
Пользователь находит место на карте (кликает на карту),
выбирает время какое хочет потратить на прогулку, нажимает "Построить маршрут",
после чего ему предлагается маршрут из n точек соединеных в определенном порядке

## Алгоритм
### В общих чертах:
Нахождение точек происходит на фронтовом бэкенде (./backend/api).

Приходит GET запрос от клиента, с точкой начала маршрута и желаемом времени.
Также в запросе приходит рандомное направление движения пользователя (рандом происходит на клиенте)

В обработчике вычисляется полигон, до куда может дойти пользователь и вернуться обратно.
После чего в этом полигоне через геопоиск ищутся интересные места (около 100 точек).
Следующим шагом фильтруются точки: находится 6 таких точек,
чтобы расположение было отдаленное от центра и как можно ближе приближенное к квадрату.

В ответ клиенту возвращается json объект, где описан упорядочный массив точек,
по которым с помощью карты строится маршрут.


### Вычисление полигона
Функция [getReachableArea](https://a.yandex-team.ru/arc_vcs/frontend/services/garage/src/projects/walkgen/backend/api/helpers.ts?rev=a9ab1ce295#L175)

1) По минутам вычисляется радиус максимального круга, по которому пользователь может дойти до края,
   пройти по окружности 90 градусов круга и вернуться обратно (L = 2*R + P*R/2).

2) Находятся линии в 8 углах (по 45 градусов). Каждая линия разбивается на 10 точек.
3) Делается запрос в маршрутизацию с этими 80 точками от начальной точки
4) Находятся максимально удаленные точки по каждым линям, из чего складывается полигон

### Нахождение интересных точек
Функция [getGeoObjects](https://a.yandex-team.ru/arc_vcs/frontend/services/garage/src/projects/walkgen/backend/api/getGeoObjects.ts?rev=a9ab1ce295#L36)

В рубрикаторе выбрали следующие [категории](https://a.yandex-team.ru/arc_vcs/frontend/services/garage/src/projects/walkgen/backend/api/constants.ts?rev=a9ab1ce295#L11):
- Достопримечательность
- Смотровая площадка
- Декоративный объект, доска почёта
- Памятник, мемориал
- Памятник технике
- Озеро
- Фонтан
- Стрит-арт
- Ключ, ручей
- Сквер
- Сад
- Беседка
- Собачья площадка
- Пристань
- Природа
- Часовня, памятный крест
- Жанровая скульптура
- Арт-объект
- Собачья площадка
- Скамейка
- Придорожная зона отдыха

После чего делается запросы за точками по 5 категорий, пока количество точек не достигнет 100 (100 - это ограничение размерности матрицы на ответ от маршрутизации).
Разделение на несколько запросов позволило сделать приоритетность категорий.

### Фильтрация точек

На этом этапе имеется 100 точек, которые нужно отфильтровать максимум до 10 и привести эти точки ко времени

Сначала сортируется массив по удаленности от центральной точки и
отрезается до 33 точек расположенных как можно дальше от центра

Далее берется направление (передается в запросе клиента) и находится самая удаленная точка в этом направлении, и две точки под углами 45 и 90 градусов (массив [endPoints](https://a.yandex-team.ru/arc_vcs/frontend/services/garage/src/projects/walkgen/backend/api/generateWay.ts?rev=a67a193a8f#L35)).
В идеальном варианте пытаемся, чтобы из найденных точек и начальной точки образовывался квадрат на карте.


Делается [запрос](https://a.yandex-team.ru/arc_vcs/frontend/services/garage/src/projects/walkgen/backend/api/generateWay.ts?rev=a67a193a8f#L51)
за матрицей маршрутов, где точки начала - это точка начала маршрута и две найденные точки под углом 90 градусов.
Точку под 45 градусов не отправляется, так как до нее можно посчитать расстояние от двух оставшихся точек.
Конечные точки - все точки. Так как массив всех точек отсеян до 33, в итоге приходит матрица менее 100 элементов.

Далее высчитывается маршрут по найденным точкам (квадрату).

Если маршрут [больше необходимого времени](https://a.yandex-team.ru/arc_vcs/frontend/services/garage/src/projects/walkgen/backend/api/generateWay.ts?rev=a67a193a8f#L64) -
вырезаем среднюю точку и отправляем массив из 3 точек клиенту как готовый маршрут.
`Тут надо дополнительно обрабатывать случай, когда и по треугольнику маршрут длинее заданного`

Если маршрут короче, то необходимо как можно ближе привести время прохождения квадрата к заданному времени.
Это делается за счет [разбиения ребер известных вершин](https://a.yandex-team.ru/arc_vcs/frontend/services/garage/src/projects/walkgen/backend/api/generateWay.ts?rev=a67a193a8f#L79).
То есть берется начальная точка и точка из endPoints (по которым была построена матрица маршрутов)
и находится промежуточная точка максимально далеко расположенная в пределах доступного времени.
Если такая точка нашлась - добавляем ее в результат между взятыми двумя точками.

Таким образом можно разделить два ребра, так как матрица маршрутов построена из 3 точек до всех остальных точек.

Так как [радиус изначальной окружности](#Вычисление-полигона) максимален для маршрута, в идеальном случае, если найдутся досягаемые и интересные точки на краях окружности, пользователю вернется 4 точки -
начальная, точка направления, 45 и 90 градусов. И этот маршрут будет приводить к заданному пользователю времени, поэтому ребра не разделятся



### Что можно улучшить/доделать
Подтюнить работу с категориями и ответом из геопоиска (либо показывать что там за точка нашлась).
