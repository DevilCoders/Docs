# Экспериментальные флаги

Некоторые изменения и нововведения нельзя выкатить сразу на всех пользователей, так как перед этим необходимо предварительно провести AB-тестирование. Для проведения такого тестирования нужна возможность включать новую функциональность по параметру — именно таким параметром и является экспериментальный флаг.

Примеры использования:
1. `&exp_flags=enable_sorting=1` — активация одного флага
2. `&exp_flags=enable_sorting=1;GOODS_enable_price_filter=1` — активация нескольких флагов

## Декларация флага в проекте

**После создания/изменения/удаления флага необходимо запустить сборку реестра флагов командой `npm run build:generate-flags-allowed`** или вместе с полной сборкой проекта командой `npm run build`.

Все проектные флаги должны начинаться с префикса `PRODUCTS_`.
Все флаги должны быть задекларированы в директории `expflags/` в виде JSON-файлов следующего формата:
```
{
  "date": "dd.mm.yyyy", // Дата создания флага.
  "description": "...", // Описание сути флага.
  "manager": "staffname", // Ответственный за флаг сотрудник.
  "dataDependent": true, // Является ли функциональность под флагом зависимой от данных.
  "platforms": [ // Платформы, на которых флаг функционирует.
    "desktop",
    "phone"
  ],
  "handlers": ["PRODUCTS"], // Всегда такое значение. Идентификатор нашей группы флагов.
  "validation_type": "01", // Тип значения флага (см. подробнее ниже).
  "values": { // Допустимые значения флага.
    "Включить функциональность": 1
  },

  // Не обязательные поля:
  "internal": true, // Флаг только для внутренней сети.
  "system": true // Системный флаг (выполняющий инфраструктурную задачу и не имеющий срока годности).
}
```

### Поле `validation_type`

Данное поле хранит допустимый тип значения флага, который будет валидироваться на уровне AB.

Чаще всего используются типы `01` и `str`, но иногда могут пригодиться и остальные, вот полный список:

| validation_type | пример       |
| ----------------|:-------------|
| 01              | `"01_attr": 1`
| str             | `"string_attr": "строка"`
| int             | `"int_attr": 42`
| float           | `"float_attr": 3.14`
| bool            | `"boolean_attr": true`
| list_of_str     | `"list_of_str_attr": ["value1", "value2", "value3"]`
| json            | `"json_attr": "some json value"`

## Использование флагов в коде

Флаги приходят к нам в данных, фильтруются на основании имеющихся деклараций и кладутся в redux-стор, по пути `Ya.store.getState().internal.expFlags`.

Для проверки наличия флага необходимо использовать хук `src/hooks/useExpFlag.ts`:
```js
const withValidateCounters = useExpFlag('validate_counters') === 1;
if (withValidateCounters) {
  //...
}
```

## Технические подробности

Команда `npm run build:generate-flags-allowed` запускает скрипт `tools/generate-flags-allowed.js`, который генерирует два файла:
1. `build/flags_allowed.json` — для фильтрации приходящих в данных флагов (кладётся в пакет и используется в рантайме)
2. `build/flags_allowed.ts` — для валидации имён флагов средствами TS во избежание опечаток и рассинхронов

## Синхронизация

Далее задекларированные в проекте флаги синхронизируются с [хранилищем флагов](https://ab.yandex-team.ru/flag_storage/flag#handler=PRODUCTS) с помощью [инфраструктурного пакета](https://a.yandex-team.ru/arc/trunk/arcadia/frontend/packages/frontend-ci#frontend-ci-expflags-sync-2) и становятся доступными при создании AB-эксперимента.
