## Портальное табло сервисов

Табло живет на [yastatic.net](http://yastatic.net/tableau/tableau.html?service-id=test) и доставляется на сервисы с помощью [IFRAME-обвязки](https://github.yandex-team.ru/lego/tableau-iframe).

### Для разработчиков обвязки

При подключении табло в строке запроса можно указать следующие GET-параметры:

- `preset` — название отображаемого пресета (по умолчанию `ru`)
- `services` — произвольный набор сервисов (идентификаторы сервисов через `+`); переопределяет набор сервисов, заданный в текущем пресете
- `services=all` — разработческий шоткат для просмотра всех доступных сервисов
- `lang` — язык отображения табло (по умолчанию `ru`)
- `domain` — домен для урлов сервисов (по умолчанию `ru`)
- `device` — устройство, для которого показываем табло (по умолчанию `desktop`)
- `target` - в значении `blank` — открывать ссылки в новом окне (по умолчанию ссылки открываются в том же окне)
- `service-id` — ID сервиса, используется для сбора статистики, **обязательный параметр, без него табло не работает!**
- `is-business` — добавляет кнопку «Сервисы для бизнеса»

#### Примеры

http://yastatic.net/tableau/tableau.html?preset=ru&lang=en&service-id=images

— табло для России на английском языке для десктопов на сервисе Картинки.

http://yastatic.net/tableau/tableau.html?preset=tr&services=weather+probki+mail+images+maps+market&device=touch-pad&service-id=video

— табло для Турции с произвольным набором сервисов для планшетов на сервисе Видео.

#### Обмен `postMessage`-сообщениями

##### Сообщения обвязка → табло

###### Проброс поискового запроса

С помощью `postMessage` можно пробрасывать поисковой запрос для ссылок на сервисы. Пример:

```js
tableauIFrame.contentWindow.postMessage('{ "fnName": "updateUrls", "fnArgs": [{ "text": "yandex" }] }', '*')
```

Этот код пробросит поисковой запрос "yandex" в ссылки на сервисы.
Если GET-параметр `serviceId` совпадает с идентификатором сервиса, то поисковой запрос проброшен не будет.

###### Подсчет статистики показов

Для подсчета статистики показов необходимо на стороне обвязки отпралять в табло следующее `postMessage`-сообщение:

```js
tableauIFrame.contentWindow.postMessage('{ "fnName": "open" }', '*')
```

##### Сообщения табло → обвязка

В момент загрузки табло отправляет следующие `postMessage`-сообщения родительскому окну:

1. `tableau.ready` - информирует о готовности табло
1. `tableau.height:<value>`, - сообщает высоту табло в пикселях (например: `tableau.height:502`)
1. `tableau.delay:<value>`, - сообщает задержку перед показом табло в милисекундах (например: `tableau.delay:300`)

Во время работы табло отправляет следующие `postMessage`-сообщения родительскому окну:

1. `tableau.close` при нажатии клавиши `ESC`, что позволяет управлять закрытием табло с помощью клавиатуры.
1. `tableau.click` по клику на сервис.

### Для разработчиков табло

- `tableau/tableau.html` — собранный HTML-файл с табло сервисов. Содержит в себе все необходимое (стили, картинки, скрипты, локализационные пресеты и правила мапинга урлов).
- `tableau/_tableau.png.css` — иконки сервисов для устройств, не поддерживающих SVG (IE8, Android < 4).

### Выгрузка на статику

Выгрузка на статику происходит из корневой папки /tableau.

#### Как добавить новый пресет

1. Открываем `bundles/tableau/tableau.bemjson.js`.
1. У блока `tableau` в специальном объекте `presets` добавляем новый пресет.
1. Запускаем `enb make`.
1. Забираем результат в папке `tableau`.

Каждому пресету можно указать набор сервисов, а также язык по умолчанию (см. комментарии в BEMJSON).

#### Как добавить новый сервис

1. Добавляем в каталог `icons/svg/` SVG-иконку сервиса 56х56 пикселей. Иконка будет автоматически оптимизирована и продублирована в формате PNG при пересборке табло.
1. Добавляем идентификатор сервиса в поле `services` блока `tableau` в файле `bundles/tableau/tableau.bemjson.js`.
1. Добавить `i18n` и `url` в пакет [@yandex-lego/services](https://github.yandex-team.ru/lego/islands/tree/dev/packages/services)
1. Выпустить новую версию `@yandex-lego/services`
1. Обновить в [package.json](./package.json) версию `@yandex-lego/services`

[conductor]: http://c.yandex-team.ru/
[doc]: http://doc.yandex-team.ru/Debian/deb-pckg-guide/concepts/About.xml
[debianize]: http://wiki.yandex-team.ru/verstka/methods/debianize

#### Памятка: как собрать новый релиз

1. Добавить в релизный тикет ссылки на решенные задачи
1. Добавить информацию об изменениях в [CHANGELOG.md](/CHANGELOG.md)
1. Определить тип версии по [SemVer](http://semver.org) (минор/патч)
1. Подвинуть версию в [package.json](/package.json)
1. Пересобрать табло (`enb make -n`)
1. Вручную проверить что все работает (`enb server` => http://0.0.0.0:8080/tableau/tableau.html?service-id=test)
1. Необходимо убедиться, что новая версия попала в [тестинг][testing] (в исходном коде в секции `<head>` есть комментарий вида `<!-- Tableau version=X.X.X -->`)
1. В релизный тикет добавить комментарий со ссылкой на [тестовый стенд][testing]
1. Перевести тикет в тестирование
1. Когда табло будет протестировано, найти тикет в кондукторе и нажать ссылку `в стэйбл`

### Ссылки

+ [Testing][testing]
+ [Production](http://yastatic.net/tableau/tableau.html?service-id=test)
