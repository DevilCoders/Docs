# Стаб для AppHost источника на TypeScript

## Комплект поставки
- Пример кода обработки запроса от AppHost в ваш источник.
- Development сервер, позволяющий тестировать/дебажить запросы в ваш источник локально.
- Автоматическое поднятие тестового графа из [локального конфига](https://a.yandex-team.ru/arc_vcs/frontend/services/stub/graphs/testing.json?rev=cb11ab456c8e73cc7cbb2d0b2c6337643da3724b). Как следствие, можно построить любой граф и тестировать/дебажить свой источник в абсолютно любой компоновке.
- Автоматический деплой беток в PRе (+ автоматическое удаления после закрытия PR). Такую бетку можно подставить через `srcrwr` в любой существующий граф.
- _Soon!_ Автоматический деплой в production окружение на базе YDeploy.

## Quick Start
### Prerequisites
- Базовое понимание [компонентов AppHost](https://docs.yandex-team.ru/apphost/pages/concepts).
- Членство в [ABC группе](https://abc.yandex-team.ru/services/frontend/) для создания upstream в балансере.

### Создание сервиса
- Установить зависимости в корне `frontend` - `npm ci`.
- Запустить скрипт генерации нового листа - `npm run create-leaf`, выбрать `service-apphost-source` в качестве типа создаваемого листа.
- Перейти в папку свежесозданного сервиса `/services/<service-name>`.
- Создать upstream на балансере `hamster.yandex.ru` - `npm run update-upstream`

### Разработка
- `npm start` 
  - Стартует `ts-node-dev` сервер, который следит за изменения в `./src` и перезапускает сервер автоматически.
  - Загружает граф из конфигурации (`./graphs/testing.json`) в horizon.
    - **!!Важно!!** Дождитесь раскатки загруженного графа по тестовым инстансам AppHost, без этого ничего работь не будет. Следить за прогрессом можно в horizon (ссылка пишется в лог при запуске). Будет исправлено в задаче https://st.yandex-team.ru/FEI-13910.
  - Создает tunnel до локального сервиса с публичным URL'ом.
  - Формирует URL для запроса в граф со всеми нужными параметрами перенаправления запроса в локально запущенный сервис.
- Готово! Посылая HTTP запросы по указанному URL вы будете получать запросы от AppHost в локально развернутый сервис.

## Автоматический деплой бет в PR
### Prerequisites
- Наличие ABC сервиса с имеющейся YP квотой. Для старта можно легко получить [Free Tier Quota](https://wiki.yandex-team.ru/ftq/).
- Членство `robot-frontend` в ABC сервисе.
- Наличие проектного сетевого макроса (`_SEARCHSAND_` к использованию не рекомендуется). Завести новый можно [тут](https://racktables.yandex-team.ru/index.php?page=services&tab=projects).

### Подготовка деплоя
Деплой реализован на базе [frontend.ci.deploy](https://a.yandex-team.ru/arc_vcs/frontend/packages/frontend.ci.deploy), поэтому:
- Вручную подготавливаем `stage` в YDeploy, на основе которого будут создаваться последующие `stage` для PR'ов ([пример](https://deploy.yandex-team.ru/stages/stub-apphost-source-testing)).
  - Заготовка конфигурации деплоя тестовых `stage` находится в `./config/deploy/config.js`.
  - `stage` лучше назвать по имени сервиса с суффиксом `-testing`, чтобы не менять ничего в заготовке конфига.
- Вручную подготавливаем балансер в Awacs ([пример](https://nanny.yandex-team.ru/ui/#/awacs/namespaces/list/stub-apphost-source.in.yandex-team.ru/show/)).
  - Заготовка конфигурации деплоя тестового балансера находится в `./config/deploy/config.js` (секция `awacs`).
  - Проще всего создать балансер прямо на странице ранее созданного `stage` в YDeploy ([пример](https://nda.ya.ru/t/k4thoH8J3zNPVk))
  - В качестве идентификатора `namespace` и доменного имени лучше использоваться имя сервиса с суффиксом `-testing`, чтобы не менять ничего в заготовке конфига.
- Проверяем `./config/deploy/config.js` на соответсвие имена созданных на предыдущих шагах сущностей.

При каждом создании/обновлении PR сервис будет развернут в YDeploy и будет создана запись в баланнсере, указывающая на развернутый сервис. URL'ы развернутого сервиса и инстанс YDeploy будут в описании PR. URL сервиса можно использовать для переопределения источников (`srcrwr`) в любом графе.

## Автоматический деплой в production
// TBD
Пока нет инструкции, можно проконсультироваться у [i-zuev](https://slack-apps.in.yandex-team.ru/ya-admin/redirect-to-dm?username=i-zuev).

# Поддержка
При возникновении проблем/вопросов по стабу - [si_frontend](https://yndx-all.slack.com/archives/CFFAR0VR6).
