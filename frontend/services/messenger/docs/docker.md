# Docker-образы

## Автосборка образов и деплой в Qloud

Если в папке с образом были изменения, то Trendbox CI может автоматически собрать и выложить образ из этой папки в Qloud.

Версию тега он берет из актуально версии репозитория, номера PR'а, коммита.

Для автоматического деплоя в Qloud у пользователя robot-mssngr-issuer должны быть доступы к окружению уровня USER и DEPLOY (MAINTAINER в терминах IDM).

Важно! Первый раз в каждом окружении, нужно создать компонент руками.

### Конфиг

Этот процесс конфигурируется в файле, находящемся в рамках папки образа. Обычны он называется `.docker.json`.

Пример:

```js
{
    // tag образа
    "image": "registry.yandex.net/messenger-frontend/___image-name-server___",
    // Project.Application в Qloud
    "app": "mssngr.web-bots",
    // Списки окружения в Qloud, в которые нужно деплоить при указанных событиях
    "environmentsByEvent": {
        "pr": ["internal-test"],
        "dev": ["internal-dev", "internal-alpha"],
        "release": ["internal-prod"]
    },
    // Название компонента в Qloud, в который происходит деплой
    "component": "___component_name___"
}
```

А так же файл регистрируется в файле `.config/docker-registry.js` в виде ключ (путь до папки с сервером) и значение (require конфига `.docker.json`).

## Ручная сборка

Ручная сборка осуществляется через archon. Версию необходимы выставлять самостоятельно, но важно учесть, что бы она не соответствовала релизным версиям.

Запуск команды сборки:

```npm run docker -- -f ./service/folder -t username.test1 --push --envs internal-test,external-test --dry-run```

**Опции команды:**

| Опция | Комментарий |
| --------- | -------- |
| -f, --folder <path> | Папка сервиса |
| -t, --tag <version> | Версия образа |
|     --push | Пушить ли образ в Docker registry? |
|     --envs <envs> | Окружения в qloud, на которые нужно выкатить (через запятую), только если push')
|     --no-install | Не запускать установку зависимостей |
|     --no-build | Не запускать javascript-сборку |
|     --dry-run | Только попробовать, посмотреть что будет :) |
|     --help | Подсказка по запуску |
