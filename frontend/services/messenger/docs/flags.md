# Флаги

Флаги - это параметры, которые конфигурируют приложение чатов. Они могут быть как зашиты в сборку
с определенным дефолтным значением, так могут быть переопределены в параметрах адресной строки или конфига.

Разделяют 3 вида флагов:

## Build-флаги

Бинарные флаги, по умолчанию выключены. Регулируют, что вообще можно включать или выключать в клиентских флагах.
Влияет на то, какой код оказывается в сборке или исключается из нее.

В коде используется через глобальный объект `FLAGS`.

Конфигурируется в webpack config.

Описаны в файле `src/configs/flags/types.d.ts`

Доступны из глобальной константы `FLAGS`. Для подстановки значения флага и корректной работы code splitting:
* использовать флаг как есть: `if (FLAGS.WEB_SPEECHKIT) { ... }`;
* не деструктурировать константу `FLAGS`: `const { WEB_SPEECHKIT } = FLAGS;`;
* не присваивать значение флага переменной: `const webSpeechkit = FLAGS.WEB_SPEECHKIT`;
* не передавать флаг через `props`: `<Awesome webSpeechkit={FLAGS.WEB_SPEECHKIT} />`.

### Конфигурация

```js
const data: Partial<GlobalFlags> = { ... };

module.exports = {
    ...restConfig,

    plugins: [
        ...restPlugins,

        require('../../flags/plugin')(data)
    ]
}
```

Значение флага в `data`:
* `undefined` (или если флаг не указан) - код под флагом не попадет в сборку;
* `true` - код под флагом попадает в сборку и включен по умолчанию;
* `false` - код под флагом попадает в сборку, но выключен по умолчанию.

Попавшие в сборку части кода, можно конфигурировать через клиентские флаги.

### Список доступных build-флагов

| Имя флага | Описание |
| --- | --- |
| `YA_BRO` | сборка для баллуна Ябро |
| `ASSISTANT` | включена Алиса |
| `MESSENGER` | работает ли Мессенджер, мб только Алиса |
| `WEB_SPEECHKIT` | переключение нативного (виндовый ябро) и js спичкит (мас ябро) |
| `INDEXED_DB` | включение работы с локальной бд |
| `ASSISTANT_INDEXED_DB` | хранения для Алисы диалогов (вкл) |
| `CALLS` | звонки |
| `WEBPUSH` | включение тумблера веб пушей (не ябро) |
| `NOTIFICATION_SUGGEST` | пока не включила уведомления, пишешь в чат, попап про подписку на веб пуши (либо инапп нотификации) |
| `HOT_KEY_COMBINATIONS` | включение хоткеев |
| `OS_DOWNLOAD` | поддержка поиска скаченных файлов в системе, только десктоп |
| `MOBILE_APP_SUGGEST` | запрос смс установки ПП в шаринге, онбординге, чатлисте |
| `YABRO_VIEW_IN_WINDOW` | переключение выноса в окно |

### Переопределение через Runtime флаги

Runtime флагами можно выключить или включить тот код, который попал в сборку (в конфигурации `true` / `false` или в переменной
окружения `1` / `2`).

Имя флага указывается в lower case. Например, для выключения `WEB_SPEECHKIT` необходимо написать `?query=web_speechkit=0`.

Значения:
`0` - код под флагом будет выключен;
`1` - код под флагом будет включен.

### Шпаргалка

Таблица соответствия значений и что в результате будет с кодом.

| Конфигурация | Runtime | В сборке | Включен |
|--------------|---------|----------|---------|
| -            | -       | Нет      | Нет     |
| -            | 0       | Нет      | Нет     |
| -            | 1       | Нет      | Нет     |
| true         | -       | Да       | Да      |
| true         | 0       | Да       | Нет     |
| true         | 1       | Да       | Да      |
| false        | -       | Да       | Нет     |
| false        | 0       | Да       | Нет     |
| false        | 1       | Да       | Да      |

## Клиентские флаги

Клиентские флаги передаются в GET параметре `?flags=...`

Все флаги указываются в нижнем регистре, указывают значение через знак `=` и отделяются друг
от друга точкой с запятой `;`.

**Пример:** `?flags=recommended_chats=0;theme=light`

В коде они используются путем вызова функций:
- `getFlag(string): string` отдаст значение флага,
- `getBinaryFlag(string): boolean` скажет, включена или выключена функциональность, передается как 0 или 1,
- `getNumberFlag(string): number` поможет установить числовой параметр, напр. таймаут.

Описаны в файле `src/client/helpers/flags.ts`

### Список доступных клиентских флагов

| Имя флага | Тип | Описание |
| --- | --- | --- |
| `anonymous` | `binary` | для эфиров |
| `calls_sdp_semantics` | `string` | связанное с работой звонков, режим |
| `compactView` | `binary` | переключение в контактный режим, без баллунов, только сообщения |
| `disableNavigation` | `binary` | нельзя навигироваться по чатам, нет форвардов, нет чатлиста, только один чат |
| `disableAutoFocus` | `binary` | отключает автофокус при открытии виджета |
| `disableChatList` | `binary` | убрать чатлист |
| `disableChatHeader` | `binary` | убрать шапку |
| `isWidget` | `binary` | Мессенджер открыт во внешнем виджете (например, чат для бизнесов для левых сайтов) и по другому считаются непрочитанные |
| `filterByMemberGuid` | `string` | чтобы в списке чатов отображались только определенные гуиды |
| `readOnly` | `binary` | ридонли, для хуральных |
| `sticker_packs` | `string` | можно указать набор стикерпаков |
| `theme` | `string` | тема |
| `tvView` | `binary` | настройка тема |
| `video_sandbox_version` | `string` | версия видеопреера яндекса |
| `waitToken` | `binary` | для авторизации через oauth токен, Мессенджер ждет пока виджет ему передаст токен через пост мессендж |
| `historyPollingIntervalMS` | `number` | для эфира |
| `newHeader` | `binary` | новая шапка |
| `hideClose` | `binary` | скрыть крестик в шапке |
| `checkUndeliveredIntervalMS` | `number` | механизм недоставок |
| `fullscreenSupported` | `binary` | возможно ли открыть картинки на весь экран |
| `supPushes` | `binary` | использовать подписку на суповые пуши |
| `supPushesYabro` | `binary` | использовать подписку на суповые пуши в десктопном ябро |
| `internal` | `binary` | yandex-team сборка |
| `recommendedContacts` | `binary` | карусель рекомендованных каналов |
| `autojoin` | `binary` | автоматическая подписка на чат, например после логина  |
| `callsDisplay` | `binary` | включить возможность шаринга экрана в звонках |
| `recommendedChatsDisabledForAnonymous` | `binary` | рекомендация каналов для анонимов |
| `onboarding` | `binary` | онбординг |
| `xiva` | `binary` | xiva |
| `updatePanel` | `binary` | если обновляется десктопная версия Мессенджера, он ходит для проверки наличия обновления, только десктоп, если апдейт прилетел во время открытого Мессенджера |
| `serviceWorker` | `binary` | включение нашего св |
| `embedButton` | `binary` | нужна был на переходный период между новой и старой шапки |
| `embed` | `binary` | включает статус-бар для внутренней встраиваемой версии |
| `alwaysShowMessagesSearch` | `binary` | всегда отображать интерфейс поиска сообщений в чате |
| `disableDisplayRestriction` | `binary` | выключает показ [попап с уведомлением "Вы выглядите так"](https://jing.yandex-team.ru/files/joshuan/2021-02-10T10%3A59%3A04Z.png) при начале пользования мессенджером |
| `visibilityMode` | `'visible_and_focused' or 'visible' or 'always'`  | селектор логики проверки является ли мессенджер видимым: <br>`visible_and_focused` - если вкладка в фокусе и видима, <br>`visible` - если вкладка видима, <br>`always` - всегда |
| `unreadCountersByChats` | `binary` | Отправляет событие counters-by-chats содержащее каунтеры по всем чатам |
| `importantMessages` | `binary` | Важные сообщения
| `picturePicker` | `binary` | Пикер поиска картинок
| `reactions` | `binary` | Реакции
| `recommended_chats` | `binary` | Рекомендованные чаты
| `voice` | `binary` | Голосовые сообщения
| `helloMessage` | `binary` | Приветственное сообщение в чате

## Серверные флаги

Флаги, которые влияют на поведение шаблонов на сервере. Могут конфигурироваться только через frontendConfig.json

Не имеют строгой типизации, в коде используются, получая их из контекста:
```javascript
const frontendConfig = getFrontendConfig(Util, ctx, { isHermione });
const frontendConfigFlags = getConfigFlags(frontendConfig, { isHermione });
```

### Хранилище конфигурации

Файл с конфигом хранится в S3 и подключается к каждому запросу на уровне AppHost'а.

Что бы его обновить, достаточно выполнить команду `npm run config:frontend:release`
в папке сервиса.

Команда проверит валидность файла по json-схеме, обновит ему версию и положит его на S3,
откуда он будет скачиваться шаблонами при запросах пользователя.

**Внимание! После деплоя, обязательно сделать ПР с конфигурацией и влить изменения в репозиторий!**

Если при деплое, скрипт ругается на не корректную версию файла, то необходимо скачать актуальный конфиг
с помощью команды `npm run config:frontend:download`, внести в него изменения флагов, после чего
перезалить.

### Условия флагов

В конфигурации, можно указать, при каких условиях применять флаг.

Для этого есть поля `enabled_builds`, `disabled_builds`, `enabled_services`, `disabled_services` и `only_yandex_net`.

Все (кроме only_yandex_net) являются массивами названий сборок и serviceId соответственно.

Можно включить флаг только для определенной сборки, только для определенного сервиса, или для определенного
сервиса на определенной сборке.
А так же можно включить флаг только для посетителей из внутренней Яндексовой сети.

Без указанных этих параметров, значение будет использоваться, как значение по умолчанию для всех сборок/сервисов.

### Список доступных серверных флагов

| Имя флага | Описание |
| --- | --- |
| `version` | Версия статики, которую необходимо отдавать |
| `csp` | Включать или нет строгий режим CSP |
