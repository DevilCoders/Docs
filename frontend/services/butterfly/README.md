# Яндекс.Жук
Жучок — удобное и быстрое средство сообщить о проблеме команде сервиса.

В основе жучка лежат два основных компонента:
1. Скрипт для отрисовки формы жучка.
2. [Конструктор форм](https://wiki.yandex-team.ru/forms/), который отвечает за отрисовку и отправку формы фидбека.

Помимо основной формы, жучок умеет отображать разнообразные [модули](#Modules), необходимые для работы со страницей или сервисом.

## Подключение

### Глоссарий
- Внешний сервис — сервис на домене **\*.yandex.{tld}**, который доступен пользователям из внешней сети.
- Внутренний сервис — сервис на домене **\*.yandex-team.{tld}**, доступ к которому ограничен только сотрудниками Яндекса.

### Подключение на сервис
Для того, чтобы подключить жучок на сервис, необходимо сделать следующие вещи:

#### <a name="FormSetUp"></a> 1. Настроить форму для сбора фидбека
В зависимости от того, является ли ваш сервис внутренним или внешним, необходимо использовать соответствующую админку конструктора форм.
Содержание самой формы, а также способ доставки проблемы (трекер, почта, уведомления и т.д.) определяется непосредственно ответственными за сервис.

**Самый простой способ**
1. Cклонировать себе эталонную [форму](https://forms.yandex-team.ru/ext/admin/10034159/edit). [Старая форма](https://forms.yandex-team.ru/ext/admin/10014938/edit)
2. Поменять список проблем в первом вопросе формы
3. Поменять очередь в разделе "Уведомления", добавить дополнительные данные и теги
4. Не забыть дать доступ к очереди на создание тикетов Команде поддержки бизнеса.

**Поля в форме, которые использует жук**
- поле скриншота **answer_files** - жук прикрепляет файл именно к нему
- **text** (если задано)
- **data** (если задано)


Дальше приведены общие рекомендации по настройкам, которые используются на поисковых сервисах:<br/>
**Транспорт**
* Очередь **BRAK** в Трекере. Данную очередь можно использовать для любых новых сервисов, которые подключают себе Жучок. Очередь разбирается командой саппортов с призывом ответственных в создаваемые тикеты.
* Чтобы упростить работу поддержки с проблемой, Жучок прокидывает данные со страницы в GET-параметры формы, но для того, чтобы эти данные появились в тикете/на рассылке, необходимо поддержать их в настройках интеграции.

**Содержание формы**
Все содержание формы строится на обычных контролах конструктора форм
* Тип проблемы. Позволяет быстро классифицировать обращения пользователя и передавать проблему нужному отвественному
* Описание проблемы
* Выбор файла. Часто пользователю необходимо приложить один или несколько скриншотов
* Также конструктор форм позволяет собрать информацию о пользователе, такие как *логин/cookie/useragent*. Очень часто это помогает в определении причины проблемы, рекомендуются добавлять данные поля.

#### 2. Подключить скрипт жучка к себе на страницу
Конфигуратор жучка находится на странице: https://butterfly.si.yandex-team.ru<br/>
Для подключения необходимо скопировать и вставить предлагаемый код к себе на страницу. После подключения на странице появится следующее:
1. Загрузится скрипт конструктора форм
2. Загрузится скрипт метрики
3. Появится элемент `<div class="YndxBug"></div>`

**Пример скрипта:**
ВНИМАНИЕ: id подключаемого скрипта должен быть обязательно `yndxbug`. По id ищется скрипт и с него берутся параметры подключения (модули, позиционирование и т.д.)<br/>
`<script src="https://yastatic.net/s3/frontend/butterfly/latest/butterfly.js" id="yndxbug" position="right" modules="forms,ab,session,info" form="10014426" data-data="experiments: 1, 2, 5" data-text="Test" custom-theme="" screenshot="true" data-domain="yandex" async="" crossorigin=""></script>`

**Описание настроек:**
  1. *Положение*. (`position="right"`). По умолчанию жучок умеет отображаться в левой или правой части экрана. При необходимости вы можете самостоятельно изменить его положение, добавить стили на элемент `.YndxBug`. Также можно стилизовать:
      - `YndxBug` - контейнер жука (содержит иконку и форму);
      - `YndxBug-Icon` - иконка жука;
      - `YndxBug-Body` - попап жука;
      - `YndxBug-Paranja` - заливка за попапом.
2. *Номер формы*. (`form="10014426"`). Номер формы, созданной в [пункте 1](#FormSetUp).
3. *Домен формы*, созданной в [пункте 1](#FormSetUp) (`data-domain="yandex-team"`)
4. *Внешняя форма*, добавьте `data-external="true"`
5. *Текст для отправки* (`data-text="Test"`). Данные из этого поля попадут в элемент формы "короткий текст" со слагом "text". **Максимальный размер - 255 символов**. Иначе данные будут обрезаны. Со стороны сервиса можно js переопределить поле на нужную текстовую переменную. Поисковые сервисы передают в ней текст запроса, новости - reqId. Каждый сервис может самостоятельно это решать.
6. *Дополнительные данные* (`data-data="experiments: 1, 2, 5"`). Данные из этого поля попадут в элемент формы "длинный текст" со слагом "data". Также можно переопределить на стороне сервиса на нужные данные.
7. *Модули* (`modules="forms,ab"`). Жучок умеет подключать и отображать только необходимые модули. Список модулей и их описание находятся [тут](#Modules), можно передавать любой набор через запятую.
8. *Тема* (`custom-theme=""`) по умолчанию применяется стандартная тема жука с сокращенным до 4х строк полем сообщения. Можно подставить свою, заранее подготовленную тему.
9. *Включение скриншотилки* (`screenshot="true"`) - поле позволяет включить/выключить скриншотилку в Жуке для конкретного сервиса.<br/>
Скриншотилка использует библиотеку [html2canvas](https://github.com/niklasvh/html2canvas).<br/>
На данный момент она может кидать CORS и CSP ошибки, т.к. пытается читать изображения с других доменов. Скриншот будет сделан, но вместо этих изображений будет черный фон.  *Будет исправлено в будущем*.<br/>
Также скриншотилка не умеет в некоторые стили. [Подробнее о поддержке css-свойств](http://html2canvas.hertzen.com/features).
При включении скриншотилки появляется вкладка с превью скриншота.
10. *Текущие эксперименты*, в которых находится пользователь (`data-exp="experiments: 35428,75889"`), данные из этого поля попадут во вкладку "Текущие эксперименты"
11. *Дополнительная информация*. Объект в формате JSON (`data-info=JSON.stringify({ version: 1.0 })`).<br/>
Требуется модуль info. Эти данные будут отображены в вкладке "Инфо"
12. *Id HTML-элемента*, куда вставлять жука, по-умолчанию - document.body (`container-id="id"`)
13. *Ручка для экспериментов* (`exp-path="https://yandex.ru/ecoo"`), по умолчанию определяется доменом страницы. Можно указать несколько значений через разделитель `|`, но при этом для записи сессий будет использована только первая ручка. Также обрабатываться ответы будут только у первой ручки. Во все следующие ручки запросы будут дублироваться без обработки ответа от них. Нужно редко - [пример](https://st.yandex-team.ru/INSECT-185)
14. *Тема для жука* (`bug-color-theme=""`) Принимает значения `light` (по умолчанию), `dark`, `auto`.
- `light` (по умолчанию) - светлая тема жука. Будет всегда светлой, несмотря на системную тему. По умолчанию, так как большинство сервисов по умолчанию светлые и не поддерживают темную темы.
- `dark` - темная тема жука. Будет всегда темной, несмотря на системную тему.
- `auto` - включает светлую или темную тему. Светлая - когда выбрана светлая('l') тема в значении `skin` куки `yp` или выбрана светлая системная тема. Темная - когда выбрана темная('d') тема в значении `skin` куки `yp` или выбрана темная системная тема.
**Жук НЕ** следит за изменением системной темы. Но мы принимаем ПР:-)
**Внимание** Жук не перекрашивает форму. Если хотите форму в тёмной теме - переходите в настройки формы и настраивайте ее так, как вам угодно и прокидывайте парамер `custom-theme` для формы :-)
15. Без `crossorigin=""` все логируемые ошибки будут Script error.
Если по какой-то причине `crossorigin` мешает подключению жука, например ошибки CORS или CSP, создайте [здесь](https://st.yandex-team.ru/INSECT) задачу - разберемся.
16. При открытии формы, созданной в [пункте 1](#FormSetUp), в форму также прокидывается параметр lang, который берется у элемента html (document.documentElement) (по умолчанию `ru`).
17. *Дополнительные параметры формы*. (`data-additional-query-string="answer_choices_1029594=1609471&answer_boolean_1029592=True"`).

#### 3. Ограничить отображение жучка
Так как жучок не умеет определять, где и на каком сервисе он находится и по умолчанию может отображаться всем пользователям, необходимо ограничить подключение жучка на стороне сервиса. Командой жучка рекомендуются следующие правила:
* Пользователь из внешней сети с привязанным к Стаффу логином. Это можно определить по выставленным сидам со значениями **668** или **669** из ответа blackbox. [список Sid'ов](https://wiki.yandex-team.ru/passport/sids/)
* Пользователь находится внутри сети Яндекса. Для поисковых/app_host сервисов необходимо значение поля `reqdata.is_yandex_net`.

#### <a name="styleNonce"></a> 4. Для сервисов, у которых запрещена вставка inline-стилей
По умолчанию при загрузке скрипта вставляются inline-стили для жука. Но у некоторых сервисов в CSP `style-src` прописан `nonce`. Из-за чего стили не подгружаются.

Чтобы все работало, необходимо во вставляемом скрипте поменять js-файл в поле `src`. Он имеет следующий шаблон:<br/>
`src=".../butterfly[.no-css][.no-react][.no-polyfill].js"`<br/>
Например, вместо<br/>
`src="https://yastatic.net/s3/frontend/butterfly/latest/butterfly.js"`<br/>
написать<br/>
`src="https://yastatic.net/s3/frontend/butterfly/latest/butterfly.no-css.js"`<br/>

Также нужно вставить файл стилей `butterfly.css`. Например,<br/>
`<link rel="stylesheet" href="https://yastatic.net/s3/frontend/butterfly/latest/butterfly.css">`<br/>

При таком подключении все равно идут ошибки CSP, но они идут от скриншотилки.<br/>
Отключение скриншотилки `screenshot=""` решает эту проблему. *Будет исправлено в будущем*.

Есть следующие сборки (шаблон имени файла чуть выше):
- сборка с css, без реакта и полифилов (https://yastatic.net/s3/frontend/butterfly/latest/butterfly.js);
- `no-css` - сборка без css;
- `no-react` - сборка без Реакта (Реакт должен быть подключен на сервисе);
- `no-polyfill` - сборка без полифилов.

### <a name="Modules"></a> Модули
* forms — Отображение iframe с формой из конструктора форм.
Настройки:
  * `form="10014426"` - номер формы (жук тестируется на форме `10014426` - серповая форма). Ссылка на форму https://forms.yandex.ru/10014426/
  * `custom-theme="my-theme"` - тема формы
  * `data-text="Text"` - данные попадут в элемент формы "короткий текст"
  * `data-data="data"` - данные попадут в элемент формы "длинный текст"
  * `data-domain="yandex-team"` - домен формы (`yandex-team` или `yandex`), жук сам сгенерирует нужный путь к форме
  * `data-external="true"` - если хотите использовать внешнюю форму (/u/$formID)
  * `screenshot="true"` - включает скриншотилку
* ab — Компонент серповых экспериментов с залипанием
Настройки:
  * `data-exp="experiments: 35428,75889"` - эксперименты, в которых находимся
* session - Компонент для записи сессий https://sema.n.yandex-team.ru/
* info - Отображение дополнительной информации.
Настройки*:
  * `data-info=JSON.stringify({ version: 1.0 })` - передаваемая информация в виде JSON-объекта

### Ошибки CORS и CSP
* В общем случае, нужно идти в сервис, откуда запрашиваем данные, и дописать соответсвующие правила. Примеры:
  * [CSP при вставке формы в iframe](https://st.yandex-team.ru/FORMS-5135)
  * [CORS при загрузке скрипта](https://st.yandex-team.ru/ISL-7685)

* Некоторые частные ошибки:
  * `
Access to image at 'the-image-url' from origin 'origin-url' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource.
`
Ошибка возникает из-за того, что скриншотилка пытается прочесть картинку и не может из-за CORS. Скоро починят.
*Как исправить:* отключить скриншотилку, либо добавить на домене картинки `the-image-url` в CORS домен, куда встраиваете жучка, `origin-url`.
  * `
Refused to apply inline style because it violates the following Content Security Policy directive: "style-src 'unsafe-inline' 'unsafe-eval' 'nonce-PeUcqCl8Uq' <URL> <URL> <URL>".
`
На сервисе запрещена вставка inline-стилей.
*Как исправить:* [Описано тут](#styleNonce)
  * В IE жук не отображается, если установлен атрибут `crossorigin`

### API жука

#### Подписка на открытие формы жука
Доступны опции - подписка на события открытия, скрытия и закрывания (данные, введенные в форму не сохраняются) форма.

События:
- `butterfly/open` - форма жука открылась;
- `butterfly/hide` - форма скрылась;
- `butterfly/close` - форма закрылась (данные потерлись).

Пример использования:
```javascript
window.addEventListener('butterfly/open', () => console.log('b' + 'a' + +'a' + 'a')); // baNaNa
```

#### Динамически обновлять данные в открытой форме
Реализовано через механизм [CustomEvents](https://developer.mozilla.org/en-US/docs/Web/API/CustomEvent).
Жук внутри себя подписывается на событие `butterfly/v1/update-form-data`, в котором ожидает объект в поле `detail` пришедшего CustomEvent'a.
Все поля объекта он прокидывает в форму через PostMessage `set-question-value`, который описан тут https://doc.yandex-team.ru/forms/external/postmessage.html?lang=ru.
Пример кода:
```javascript
window.dispatchEvent(new CustomEvent('butterfly/v1/update-form-data', { detail: { field : 'value' }}))
```

#### Обновление данных в модуле Инфо
Аналогично обновлению формы, можно также добавлять и обновлять данные в блок Инфо. Значение передаются в формате json.
Пример кода:
```javascript
window.dispatchEvent(new CustomEvent('butterfly/v1/update-info', { detail: { field : 'value' }}))
```

## Разработка
### Запуск
1. Запустить локальный сервер - `npm run start`. Опция `--public` внутри npm-скрипта необходима, чтобы обойти проблему с _csp_ при загрузке формы.

2. Открыть ссылку, адрес которой будет напечатан в консоль, и добавить `/butterfly` в конец. Например,
```
https://username-1-ws3.tunneler-si.yandex.ru/butterfly
```
Должна открыть страницу с жуком и формой настройки жука.

3. Скрипт жука будет доступен по ссылке:
```
https://username-1-ws3.tunneler-si.yandex.ru/butterfly.js
```

### Ручки для залипания
https://wiki.yandex-team.ru/serp/experiments/zerotesting/apidescription/

### Деплой
Жук живет в https://deploy.yandex-team.ru/projects/butterfly

### Отведение и выкатка релиза релиза
Так как жук живет в монорепозитории, то его релизы отводятся каждый будний день, если есть изменения, в очереди [SEAREL](https://st.yandex-team.ru/SEAREL/order:updated:false/filter?resolution=empty()&components=55620).<br>
Отводить релиз нужно через [UI арканума](https://a.yandex-team.ru/projects/frontend/code/frontend/services/butterfly), так как для жука выключены автоматические релизы.<br>
Там продолжить по [документации](https://a.yandex-team.ru/arc_vcs/frontend/docs/how-to/arc/setup-releases.md#отведение-релиза-из-ci) и запустить релиз для сервиса Яндекс.Жук.
После выполнения таски `Deploy:release` жук будет залит на статику по адресам
- `https://frontend.s3.mds.yandex.net/butterfly/v{version}-{commit_sha}/butterfly.js`
- `https://yastatic.net/s3/frontend/butterfly/latest/butterfly.js`

`https://yastatic.net/s3/frontend/butterfly/latest/butterfly.js` имеет `Cache-Control: public, max-age=86400` ([тикет](https://st.yandex-team.ru/YASTATIC-167#61bb0334b7cf030c1379c1c6)), поэтому обновится автоматически чуть позже.
Этот скрипт нужно протестировать, подключив его или к какому-то сервису напрямую, или указав в конфигураторе.
Если нашлисть проблему - нужно выпустить новую версию, чтобы она перетёрла `latest`.

**Как работать с релизной таской**<br>
В работу -> Готово к тестированию -> Протестировано -> Готово к продакшн - > Закрыт/решен

## FAQ
#### Жук не отображается на выдаче
Для этого есть несколько причин:
- Вы используете браузер, в котором не поддерживается жук (TODO: список окружений)
- Неверно установлены bbSid (сиды). Варианты это проверить:
    - попросить проверить [сиды](https://wiki.yandex-team.ru/passport/sids/) 668 и 669 в очереди TOOLSUP
    - проверить, что сиды выставлены, и вы залогинены под тем аккаунтом, что отображается здесь https://staff.yandex-team.ru/profile-api/ext_passport_view/{login}
