# Стаб для новых проектов в монорепе

Стабильная ссылка на бету, которая собирается по транку: https://renderer-stub-trunk.hamster.yandex.ru/stub/

С помощью стаба можно и нужно создавать все новые сервисы в монорепе.

При возникновении проблем/вопросов по стабу - писать в слак в канал `si_frontend` **https://yndx-all.slack.com/archives/CFFAR0VR6**.

Что на данный момент предоставляет стаб:

- Самый базовый скелет приложения
- SSR
- Линтинг
- Сборку через вебпак для двух платформ – desktop и touch
- Инфраструктуру для локальной разработки и авто поднятия бэт в пуллреквестах
- Инфраструктуру для тестирования: hermione для автотестов, jest для unit тестов
- Различные хелпер-команды по работе с апхостом, можно посмотреть запустив `npx archon --help` после создания сервиса
- Подключенный Errorbooster и Rum для логирования перфоманса и ошибок с UI. (https://rum.yandex-team.ru/projects/name_of_new_project/projectDashboard, https://error.yandex-team.ru/projects/name_of_new_project/projectDashboard)
- Подключены заголовки CSP из пакета [@yandex-int/csp-presets-pack](https://a.yandex-team.ru/arc_vcs/frontend/packages/csp-presets-pack?rev=r8485676#nabor-csp-pravil-dlya-servisov-yandeksa)

Чего в стабе нет:

- Полноценного скелета "боевого" приложения, нет redux, нет примеров работы с bem-react:v3 и тд
- Нет метрик: либо Я.Метрики, либо баобаба
- Конфиги гермионы/вебпака и т.д. предоставляют самую базу, в реальных проектах они немного/много сложнее

## Как создать новый сервис

0. Убедитесь, что вы входите в группу **Разработка сервиса** https://abc.yandex-team.ru/services/frontend/?scope=development это нужно для создания upstream в балансере.
1. Установить/обновить все зависимости в корне монорепы (сделать `npm i` в корне `./frontend`)
2. Выполнить команду `npm run create-leaf` и выбрать в появившемся визарде тип листа service, после заполнить оставшиеся поля (установка зависимостей может занять несколько минут)
3. Перейти в каталог свежесозданного сервиса и запустить скрипт `npx apphost-service` - скрипт генерит различные конфиги для работы под apphost-ом. Шаги выполнения команды:
    1. `Введите название проекта (name_of_new_project)` - по дефолту возьмется название папки, ничего не вводим и жмем Enter
    2. `Введите проектный хэндлер (yandex.tld/<name_of_new_project>) (name_of_new_project)` - это путь по которому будет доступен ваш сервис, по факту настройка в балансере, по идее тоже равен названию папки, если да, ничего не вводим и жмем Enter
    3. `Выберите вертикаль (Use arrow keys)` - вертикаль в которой живет сервис, определяет квоты на железо. Есть возможность завести проект в коммунальной вертикали `SHARED` либо же в своей собственной.
    4. `Введите ID проектного шаблона (name_of_new_project)` - id шаблона в rr, `ids` в файле `routes.json`, также равно названию папке, ничего не вводим и жмем Enter
    5. `Введите логины релизеров пакета шаблона через запятую` - люди, которые смогут релизить шаблоны; по умолчанию запишется человек, запустивший команду, **обязательно надо добавить юзера `robot-frontend` если ваш сервис будет под авторелизами монорепы**, после заполнения жмем Enter
4. Дальше начнется генерация всех необходимых файлов, после команда спросит `Для локальной разработки на kotik и/или деплоя бет необходимо выполнить подготовку тестинга` наш ответ да, то есть вводим `y` и жмем Enter, команда выполняется пару минут.
5. После выполнения предыдущей команды, необходимо сделать еше одну вещь, а именно загрузить свой локальный апхостовый граф `./graphs/testing.json`, это делается во время запуска команды `npm start`. Поэтому необходимо выполнить команду `npm start`, после того как в консоле будет сказано `Граф успешно загружен`, можно стопнуть команду `npm start` и перейти к следующему шагу.
6. Далее необходимо немного подождать пока идет расскатка/обновление всех конфигов и тд, в среднем занимает минут 10-15.
7. Снова выполнить команду `npm start`, поскольку граф мы уже загрузили и он не изменился, то можно сразу перейти на адрес `https://local.yandex.ru:3443/name_of_new_project` - там будет дефолтная страничка стаба
8. В случае, если при дальнейшей разработке тестовый граф поменялся, то нужно загрузить его явно с помощью команды `npm run upload-graph`
9. Убедить, что для [жука](https://a.yandex-team.ru/arc_vcs/frontend/services/stub/src/utils/butterfly/butterfly.ts) заведена отдельная форма на https://forms.yandex-team.ru

## Как выложить сервис в production в первый раз

1. Переименовать в `a.yaml` файл `name_of_new_project/a.template.yaml` и внести туда изменения в соответствие с вашим сервисом. [Подробнее тут](https://a.yandex-team.ru/arc_vcs/frontend/docs/how-to/setup-releases.md).
2. Через [форму отведения релизов](https://forms.yandex-team.ru/surveys/50569/) отвести релиз нового сервиса. 
3. После заполнения формы будет создан SEAREL тикет и запущена SANDBOX таска для подготовки релиза. Информация о таске автоматически опубликуется в виде комментария в SEAREL тикет. После завершения SANDBOX таски, нужно сходить в команду report-renderer https://wiki.yandex-team.ru/search-interfaces/infra/report-renderer/duty/ чтобы дежурный внёс необходимые измнения в nanny
4. Все последующие релизы шаблонов выкладываются разработчиками сервиса самостоятельно по [инструкции](https://wiki.yandex-team.ru/search-interfaces/infra/report-renderer/selfduty/#relizyvsharediydo)

# Полезная информация

- Про apphost можно почитать здесь https://docs.yandex-team.ru/apphost/ и здесь https://wiki.yandex-team.ru/search-interfaces/infra/dev-at-apphost
- TS Пакет с тайпингами и API для работы с контекстом апхоста: https://a.yandex-team.ru/arc_vcs/frontend/packages/frontend-apphost-context
- Про Archon https://a.yandex-team.ru/arc_vcs/frontend/projects/infratest/packages/archon
- Про Kotik https://a.yandex-team.ru/arc_vcs/frontend/projects/infratest/packages/kotik
