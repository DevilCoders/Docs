## Блок геолокации

- по клику запрашивает браузерную геолокацию у пользователя и сохраняет её в куку `gpauto`
- по окончании запроса перекидывает пользователя на страницу определившегося города с перезагрузкой страницы
- в случае если сохранённый в куках город совпадает с текущим, имеет специальное визуальное представление (это
реализуется на стороне сервиса)

### Визуальное представление

Блок визуально представлен иконкой со стрелкой. Имеет 4 состояния:

- обычное (иконка стрелки в незакрашенном кружке)
- для текущего местоположения (иконка стрелки в закрашенном кружке)
- in progress (иконка стрелки в незакрашенном кружке медленно пульсирует)
- ошибка (виден попап с текстом ошибки, который можно закрыть крестиком)

### Подробное описание алгоритма работы:

На стороне сервера при формировании страницы определяется текущий город, а также координаты из LaaS.
Сервис самостоятельно определяет, совпадают ли они. Если да, то блок создаётся в состоянии "для текущего
местоположения", если нет – в "обычном". Если в браузере нет поддержки геолокации (отсутствует объект
`navigator.geolocation`), блок вовсе не добавляется в DOM.

При клике:

- Пробуем получить данные геолокации из браузера
- Отсекаем устаревшие (старше 15 мин) или слишком неточные (шире 2 км) данные
- (опционально) Проверяем, есть ли город по этим координатам (см. ниже)
- Сохраняем эти координаты в куку `gpauto` с помощью ручки `gpsave`.
- Переходим на страницу определившегося города с перезагрузкой страницы. После перезагрузки блок создаётся заново как
в п. 1.
- При ошибке на любом шаге показываем попап об ошибке

**Важно:** Предполагается, что на сервисе есть единая главная страница, на которой сервис отображает данные для
текущего города. То есть переход на страницу определившегося города эквивалентен просто переходу на главную сервиса
без параметров, а правильный город сервис определяет самостоятельно по данным из LaaS.

### Интерфейс блока:

````js
{
    "block": "geolocation-control",
    "isCurrentLocation": true,                    // Создать блок в визуальном состоянии "для текущего местоположения?"
    "verificationEndpoint": "..."                 // Урл ручки на стороне сервиса для проверки, что по координатам есть какой-то город
    "pageUrl": "...",                             // Куда идти после успешной геолокации. Считаем, что это урл главной страницы сервиса.
    "gpsaveEndpoint": "https://yandex.ru/gpsave", // Урл ручки для сохранения куки
    "secretKey": "...",                           // CSRF-токен для сохранения куки
    "lang": "ru"                                  // Язык (тоже для сохранения куки)
}
````

### Документация по кукам геолокации и LaaS

Про яндексовые куки геолокации — см. https://wiki.yandex-team.ru/Geolocation/Cookies/

Про заголовки, которые выставляет L7-балансер, глядя на эти куки — см. https://doc.yandex-team.ru/laas/laas-user/concepts/balancer_headers.html

Про ручку `/gpsave` (для мобильных надо использовать `/mgpsave`), которая эти куки пишет - см. https://wiki.yandex-team.ru/morda/handlers/

Про СSRF-токен, который надо передавать в эту ручку – см. https://wiki.yandex-team.ru/security/For/web-developers/csrf/

Про миддлвару для Express, которая может этот токен генерировать – см. https://github.yandex-team.ru/toolbox/express-secretkey

### Проверка наличия города по координатам

Возможно, ваш сервис захочет сохранять только те координаты, для которых удалось определить город,
а для остальных показывать ошибку. Поскольку логика определения города по координатам описана на стороне сервиса
(в том месте, где вы формируете Turbo-JSON, зная куки и, следовательно, координаты конкретного пользователя),
для такой проверки нужна реализованная на стороне сервиса отдельно стоящая ручка, реализующая ту же самую логику.

Ручка должна принимать GET-параметры lat и lon, и возвращать любой JSON (формат и содержание ответа не важны) с кодом
200 в случае успеха и код ошибки в случае отсутствия города.

Как ориентировочный пример, можно на стороне сервиса сделать ручку, проксирующую наружу
https://geobase.qloud.yandex.ru/v1/region_id_by_location, но в случае ответа "-1" отдающую код 404.
Ручку для проверки наличия города сервис-пользователь пишет сам, основываясь на том, как у него устроен алгоритм
определения города по координатам на сервере (п. 1).

Урл такой ручки указывается в поле `verificationEndpoint`. Если это поле не указано, проверка производиться не будет
и валидные координаты отправятся в gpsave в любом случае.
