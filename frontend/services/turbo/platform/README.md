# Turbo Components

## [Мотивация](https://wiki.yandex-team.ru/taap/#mordaiturbo)
Можно выделить три представления сервисов Яндекса:

1. Основная версия сервиса по отдельному адресу;
1. В рамках многомордия — функциональности в виде табов, позволяющей открывать страницу сервисов сразу на главной Яндекса;
1. Турбированная версия, которая открывается моментально в модальном окне на странице большого поиска.

Данная платформа позволяет разрабатывать компоненты, которые могут быть использованы во всех трёх представлениях одного сервиса, а так же позволяет переиспользовать компоненты между сервисами.

## Команды и Сервисы на платформе
https://wiki.yandex-team.ru/turbo/services/

### [Contribution](/platform/CONTRIBUTION.md)

### Доступы (GitHub Repo и [Tunneler](https://wiki.yandex-team.ru/users/unikoid/tunneler/user-doc/))
Скинуть свою ссылку на staff в личку [mviktorov@](https://staff.yandex-team.ru/mviktorov)

## Как подключить сервис в многомордие
Морда - главная странице yandex.ru

1. Разработать [application](/platform/CONTRIBUTION.md#Что-делать,-чтобы-добавить-новое-приложение)
2. [Создать задачу в очереди HOME](https://st.yandex-team.ru/createTicket?queue=HOME) на добавление нового application

## Публикация лоадера
Публикация лоадера выполняется скриптом `platform/public/publish.sh`

## Как начать подключать сервис к Turbo
Turbo - турбо-страницы, которые призваны ускорить интернет.

1. Написать команде Турбо в [Q](https://q.yandex-team.ru/#/join/52a4de5e-7730-4e91-8cee-f0e9a895a35d)
1. Настроить ручку для Турбо
1. Для разработки и тестирования можно использовать стабы данных в примерах блоков, для этого необходимо:
    1. Создать в директории с примером нужного блока json-файл. Если страницы/блока, которые надо турбировать:
    ```
        common.blocks/
        ├── page/
        ├───── page.examples/
        ├──────── zen-vertical-mobile.json
    ```
    1. Добавить адаптер данных. (TBD: куда положить адаптеры платформы и как их собирать)
    1. Запустить локальный сервер — `npm run start:kotik`
    1. Перейти по ссылке http://localhost:3000/turbo?stub=page/zen-vertical-mobile.json, где параметр `stub` содержит имя_блока/имя_стаба.
    1. В окне браузера вы увидите получившуюся страницу.
1. Запустить эксперимент на внутреннюю сеть (чтобы проверить и протестировать).
1. Запустить эксперимент на внешнюю сеть.

## Как выпустить новую версию пакетов компонентов
Для выпуска **тестовой версии** (canary) пакетов турбо-компонент из вашей ветки разработки (для проверки работоспособности текущего кода вашей ветки в другом сервисе, например, для сборки беты в веб4), необходимо создать PR в турбо и воспользоваться командой `/canary all` в комментарии к PR.

В результате, будут открыты PR'ы во все целевые репозитории. Список репозиториев находится в конфиге `.canary.json`
Никаких изменений (тегов) в гит внесено не будет.

### Выпуск релизных пакетов
Отводим ветку от dev вида `packages-release/v<будущая-версия>` (пожалуйста, не публикуйте релиз пакетов c кодом не влитым в dev).

В ней необходимо выполнить команду
```
# Для авторизации использовать OAuth-токен
# https://doc.yandex-team.ru/si-infra/npm/npm.html#autentifikatsiia-cherez-pasport
npm run login

npm version <version> --prefix platform/<package>

cd platform/<package>

# Права на публикацию нужно запросить через idm
# https://clubs.at.yandex-team.ru/nodejs/1296
npm publish --registry=http://npm.yandex-team.ru
```
Где `version` одно из: `patch`, `minor`, `major`.
Где `package` одно из: `core`, `components`.

npm изменит файл `package.json`, изменив версию пакета. Необходимо зафиксировать изменения и открыть PR из релизной ветки для влития в dev.
При публикации пакетов будет запущена сборка необходимых ассетов. Очистить локальную директорию от артефактов можно командой `git clean -xdf`

**В случае проблем с авторизацией/публикацией пакета в npm писать на npm@yandex-team.ru**

## Как разрабатывать блок на статичных данных.

Для удобства разработки и тестирования в Турбо есть возможность создания статичных данных и отлаживания на них. Они называются `examples`.

`Examples` - это данные блока в формате json. Они лежат в блоке в папке `Block.examples`. Например, `platform/components/Price/Price.examples`.

В файле надо указать данные, которые придут на вход блоку. Например:
```
{
    "block": "price",
    "price": 4000
}
```
После создания файла `Price/Price.examples/default.json` и сборки проекта, он будет доступен по урлу `http://localhost:3333/turbo?stub=price/default.json`.
Также он будет доступен на бете ПР и в продакшене, как только задача зарелизится.

Так как в Турбо есть 2 платформы, то и примеры можно писать для разных платформ:

- `file.json` - для обоих платфом
- `file@desktop.json` - для десктопа
- `file@touch.json` - для телефонов

**Важно:** тест, специализированный для одной из платформ, не будет открываться на другой.

## Как писать функциональные тесты.

Тесты на блоки и приложения пишутся с использованием [Hermione](https://tech.yandex.ru/hermione/), которая представляет собой обертку над [WebdriverIO](http://webdriver.io/).
С помощью Hermione можно тестировать внешний вид блока, а также интераткивность.
Тесты пишутся на застабленных примерах ([examples](#Как-разрабатывать-блок-на-статичных-данных)), которые лежат в папке с блоком.

Файлы с тестами лежат в блоке и папке `__tests__`. Тест состоит из 2 файлов:
1. [yml-файл](#yml-файл) - файл, в котором тестовый сценарий описан в человекочитаемом виде.
2. [hermione-файл](#hermione-файл) - файл с кодом автотеста.

### YML-файл.

Файл называется в формате `myBlock.testpalm.yml`. Подробнее про формат [yml](https://docs.ansible.com/ansible/latest/reference_appendices/YAMLSyntax.html).

Рассмотрим пример теста для блока `myBlock`:
```
# указываем название блока или приложения
feature: myBlock

# описываем тестовые сценарии (обязательно!)
specs:
  # заголовок секции it в hermione тесте должен быть такой же: it('Базовый вид блока', ...)
  Базовый вид блока:
    # шаги в hermione тесте должны 1 к 1 повторять шаги сценария
    # do - дествия
    - do: открыть главную страницу Поиска, удалить все параметры кроме yandex.ru и добавить в адресную строку к URL '/turbo?stub=my-block/default.json'
    # assert - сравнение
    - assert: мой блок должен быть видим
    # screenshot - снятие скриншота и сравнение его с оригиналом
    - screenshot: внешний вид соответствует скриншоту [plain]

files:
  - platform/components/MyBlock/__tests__/myBlock.hermione.js

# указываем ответственную за блок команду (News, Praga, ...). Если блок базовый - тогда ставим Turbo.
v-team: Turbo

# ответственный менеджер
manager: tanzwuta

# ответственный тестировщик
qa-engineer: olga0321

```

### Hermione-файл.

Файл называется в формате `myBlock.hermione.js` и выглядит следующим образом:

```
specs({
    feature: 'myBlock'
}, () => {
    it('Базовый вид блока', function() {
        return this.browser
            .url('/turbo?stub=my-block/default.json')
            .yaWaitForVisible(PO.myBlock(), 'Блок не появился') // селекторы задаются с использованием [PageObjects](#PageObjects)
            .assertView('plain', PO.myBlock());
    });
});

```

### PageObjects

Чтобы в тесте вызвать `PO.myBlock()`, надо добавить селектор в `hermione/page-objects` в файл:
- `blocks.js` - если описываете блок. В тесте вызывается, как `PO.blocks.myBlock`.
- `index.js` - если описываете фичу, состоящую из комбинации блоков. В тесте вызывается, как `PO.myFeat`.

Для удобства все блоки также заносятся в `index.js`, как `elems.myBlock = blocks.myBlock.copy();` для удобного использования в тестах.

Важная особенность PO - при использовании `.copy()` копируется вся внутренняя структура блока. То есть:
```
// blocks.js

blocks.myBlock = new El({ block: 'myBlock' });
blocks.myBlock.whatever = new El({ block: 'myBlock', elem: 'whatever' });

// index.js

elems.myFeat = new El({ block: 'myFeat' });
elems.myFeat.myBlock = blocks.myBlock.copy();

// в этом случае селектор PO.myFeat.myBlock.whatever будет определен и не надо дополнительно копировать всю внктреннюю структуру блока.
```

Подробнее о том, как писать селекторы на PO [тут](https://github.yandex-team.ru/search-interfaces/bem-page-object).

### Важные команды

Так как Hermione - это обертка над WebdriverIO, то в тестах работают все команды WebdriverIO, а также дополнительные:

- `assertView` - снимает скриншот и сверяет его с эталоном. Если эталонного скриншота нет - предлагает сохранить.
- `yaWaitForVisible` - ждет появления блока на странице. Обертка над `waitForVisible` из WebdriverIO с возможность пробрасывать кастомный текст ошибки.

Кастомные команды лежат в `https://github.yandex-team.ru/serp/turbo/tree/dev/hermione/commands`.

## Запуск тестов.

Hermione-тесты прогоняются в selenium grid на дампах. Перед запуском тестов надо правильно настроить git lfs ([инструкция](https://wiki.yandex-team.ru/search-interfaces/git-lfs/)) и выполнить `git lfs pull`.

Команды запуска тестов:
- `npx hermione` - запускает все тесты
- `npx hermione gui` - запускает все тесты с графическим интерфейсом для проверки и принятия скриншотов.

Полезные параметры:
- `npx hermione --grep 'myBlock'` - запускает тест по имени. Еще можно --grep 'myBlock Базовый вид блока' запустит конкретный it.
- `npx hermione platform/components/MyBlock/__tests__/myBlock.hermione.js` - запускает все кейсы в файле.
- `npx hermione -b iphone` - запускает все тесты в одном браузере. Какие браузеры доступны можно посмотреть в конфиге
- `npx hermione --retry 0` - запускает все тесты без ретраев при падении (по-умолчанию локально происходит 4 ретрая).

Режим запуска для работы с дампами:
- `npx hermione --create` - сохраняет дампы для нового теста, для которого еще нет дампов.
- `npx hermione --save` - обновляет дампы для существующего теста.
- `npx hermione --play` - запускает тест на сохраненых ранее тестах. С этим параметром тесты запускаются в ПР.

**Важно**: если дампы не сохранены - тест при прогоне в ПР упадет с ошибкой.

## [Покрытие фичи счетчиками baobab](/platform/BAOBAB.md)
