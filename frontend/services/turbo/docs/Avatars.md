# Аватарница

Аватарница — общеяндексовое хранилище картинок.
Она сохраняет оригинальное изображение без изменений и предоставляет возможность кадрировать изображение,
изменить его размер и сохранить для последующей выдачи.

Полная документация находится [по ссылке](https://wiki.yandex-team.ru/mds/avatars/).

## Тестовая аватарница [deprecated]

`avatars.mdst.yandex.net`

Картинки из тестовой аватарницы видны только внутренней сети Яндекс, поэтому мы ей не пользуемся, т.к. наши примеры смотрят ассесоры из внешней сети.

## Продакшн аватарница

`avatars.mds.yandex.net`

Картинки из продовой аватарницы видны всем пользователям, поэтому нужны права. Для возможности добавления картинки нужно запросить доступ к любой dev машинке с такими правами, для нас это `dale.search.yandex.net`.

### Получение прав

1. Заходим на https://idm.yandex-team.ru/system/cauth/roles#f-status=all,f-role=cauth,sort-by=-updated
2. Сверху справа кнопка "Запросить роль", нажимаем
3. Заполняем форму
  - Хост: `dale.search.yandex.net`
  - `ssh`
  - Указываем себя
  - Со сроком "навсегда"
  - Обоснование: `Нужна возможность заливать медиа в прод. аватарницу для тестовых примеров турбо-страниц`
4. "Далее" -> "Запросить роль"
5. Пишем [Стасу](https://telegram.me/stasmakeev), иначе роль будут подтверждать вечность
6. Пришло письмо с подтверждением роли

### dale.search.yandex.net

После получениия прав на dev машинку можно зайти через

```
> ssh dale.search.yandex.net
Are you sure you want to continue connecting (yes/no)?
> yes
```

После захода на сервер (первый раз заходит долговато) можно отправяль запросы на
`avatars-int.mds.yandex.net`.

### Положить картинку

Положить картинку по ссылке:
```
curl "http://avatars-int.mds.yandex.net:13000/put-turbo?url=адрес_картинки"
```

#### Отправка картинок через файл

Иногда `url` картинки может быть недоступен для `avatars-int.mds.yandex.net` и залить ёё в аватарницу
по ссылке не получится. В таком случае, нужно скачать и отправить ее на `dale`.

Для отправки есть команда
```
scp название_картинки ваш_логин@dale.search.yandex.net:~
```
Картинок можно передавать несколько за раз.

Положить локальную картинку:
```
curl "http://avatars-int.mds.yandex.net:13000/put-turbo" -F file=@имя_файла
```

svg картинки можно добавлять только через файл следующим образом:
```
curl "avatars-int.mds.yandex.net:13000/put-turbo" -F svg=@имя_файла
```

### Получить картинку

```
http://avatars.mds.yandex.net/get-turbo/ид_группы/название/размер
```

`ид_группы` и `название` возвращает аватрница при добавлении картинки, доступные `размеры` можно получить [следующим образом](https://wiki.yandex-team.ru/mds/avatars/#getinfo).
В тубро-json мы указываем ссылку без `размера`
```
http://avatars.mds.yandex.net/get-turbo/ид_группы/название/
```
размер подбирает
[код алиасов](https://github.yandex-team.ru/serp/turbo/tree/dev/core/utils/avatars)
исходя из формы контейнера картинки, размера и качества экрана и т.д.

#### Возможные проблемы

Если заливать много картинок, в какой-то момент может появится ошибка
```
{“status”:“error”, “description”:“too many put requests to your namespace”}
```
Чтобы это поличить, нужно переподключится к серверу.
```
> exit
> ssh dale.search.yandex.net
```
