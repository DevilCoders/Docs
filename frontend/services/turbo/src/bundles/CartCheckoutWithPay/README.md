# Логика страницы корзины с заказом или покупкой онлайн

смотри [пример страницы](https://yandex.ru/turbo?exp_flags=platform%3Dtouch&stub=ecomcartpage%2Fdefault.json)

## Из каких экранов состоит страница

1. Первый экран (cart) - экран корзины со списком товаров и кнопкой "Оформить"
2. Второй экран (form) - экран с формой и кнопкой оформить/отправить
3. Третий экран (pay) - экран с ифреймом для оплаты покупки онлайн

На второй экран можно попасть на первый по кнопке "Оформить заказ".

На третий экран - только если выбрана опция "Способ оплаты" в "Картой онлайн" и форма корректно заполнена.
На этот экран нельзя попасть с помощью перехода по истории.

## Основные сценарии оформления заказа

1. С оплатой наличными
2. С оплатой онлайн

## Оплата наличными

Сценарий оплаты наличными срабатывает, когда в форме выбрана опция "Способ оплаты" в "Наличными при получении".

### Если сабмит формы прошел неуспешно:

Показываем попап "Произошла ошибка". При закрытии остаемся на том же экране с формой.

### Если сабмит формы прошел успешно:

Показываем попап "Заказ оформлен".
При закрытии попапа или нажатии браузерного "Назад" - возвращемся на первый экран с очищенной корзиной.
Блокируем переход на форму через переходы по истории - так как больше нет товаров и нечего заказывать.


## Оплата онлайн

Сценарий оплаты онлайн отрабатывает, когда в форме выбрана опция "Способ оплаты" в "Картой онлайн".
При сабмите формы открываем третий экран со спиннером на месте ифрейма оплат.

### Если сабмит формы прошел неуспешно:

Показываем попап "Произошла ошибка". При закрытии позвращаемся на предыдущий экран с формой

### Если сабмит формы прошел успешно:

Заменяем спиннер на страницу траста, куда надо вводить данные карты для оплаты. Ифрейм траста сообщает о своих статусах через postMessages.

#### Если оплата не прошла:

Если получаем postMessage с ошибкой - показываем попап "Произошла ошибка". При закрытии позвращаемся на предыдущий экран с формой

#### Если оплата прошла успешно:

Не третьем экране вместо ифрейма Оплат показываем экран успешного заказа и кнопкой "Перейти в каталог".
Чистим корзину.
При нажатии браузерного "Назад" делаем 2 шага по истории - на первый экран с пустой корзиной.
Блокируем переход на форму через переходы по истории - так как больше нет товаров и нечего заказывать.

## Дополнительные особенности формы

### Цена доставки

При изменении контролла delivery актуализируем в стейте данные о доставке, чтобы выводить актуальную сумму на кнопке Оплатить (цена заказа + цена доставки)

### Запоминаем пользовательские данные

При сабмите формы запоминаем почту пользователя, чтобы потом указать ее на странице успешной оплаты.
