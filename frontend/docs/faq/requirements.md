# Требования монорепозитория frontend

## Требования к структуре файлов

[Аркадия][Arcadia] накладывает [ряд ограничений][Arcadia_fs] на файловую структуру репозитория.

Часть требований можно проверить с помощью линтера:

```bash
# Выполнить в корне git-репозитория
NPM_CONFIG_REGISTRY=https://npm.yandex-team.ru npx @yandex-int/arc-filepath-linters .
```

[Arcadia]: https://docs.yandex-team.ru/devtools/src/arcadia
[Arcadia_fs]: https://docs.yandex-team.ru/devtools/src/arcadia#filestructure

### Бинарные файлы в Git LFS

В монорепозитории запрещено хранить бинарные файлы в [git](https://git-scm.com/).

> Паттерны бинарных файлов указаны в файле [`.gitattributes`](../../.gitattributes).

Бинарные файлы должны храниться в [Git LFS](https://git-lfs.github.com/) ([наша документация](https://wiki.yandex-team.ru/search-interfaces/git-lfs/)).

## Требования к npm-пакетам

### Требования к владельцам пакетов

Все пакеты должны содержать owner `robot-frontend`. Именно от этого робота версии обновляются автоматически.

### Требования к Node.js

Код всех npm-пакетов должен работать с единой версией [Node.js](https://nodejs.org/en/).

Стоит использовать те же версии, что и в CI.
Окружение изолировано в LXC контейнере и хранится в Sandbox ресурсе.
ID актуального ресурса можно найти в [`.trendbox.yml`](../../.trendbox.yml) по ключевому слову `container`.
Версии инструментов указаны в описании Sandbox задачи, создавшей этот ресурс.

Для ресурса `#1612109818` это:

* npm 6.14.5
* node 12.18.1
* git 2.27

> Актуальная версия указана также в [`.nvmrc`](../../.nvmrc).

### Требования к зависимостям npm-пакетов

Монорепозиторий накладывает ограничение на использование ряда npm-пакетов.

> Требования хранятся в файле [`.depslint.json`](../../.depslint.json).

Запрещено использовать версии npm-пакетов, отличные от указанных в поле `versions.actual`. Также запрещено использовать версии npm-пакетов, указанные в поле `versions.outdated`.

Запрещено использовать зависимости по протоколу `git://`.

### Требования к npm-скриптам

Внутри npm lifecycle скриптов, а так же внутри любых пользовательских скриптов нельзя завязываться на git. Гита может не быть так как сейчас мы находимся в состоянии переезда с git/github на arc/arcanum.

### Требования к `.npmrc`

Файл `.npmrc` в директории npm-пакетов и сервисов должен содержать следующие строки:

```
registry=http://npm.yandex-team.ru
save-exact=true
unsafe-perm=true
```

### Требования к `package.json`

Поле `owners` в `package.json` файле должно содержать ссылку на [ABC-сервис](https://abc.yandex-team.ru/), ответственный за npm-пакет:

```json
{
  "owners": [
    "https://abc.yandex-team.ru/services/<your_service>/"
  ]
}
```

Для работы CI в монорепозитории названия скриптов должны соответствовать соглашению.
Также есть соглашения о работе самих проверок.

> Подробнее о настройке CI читайте в разделе [Проверки в монорепозитории](./checks.md).

### Требования к `package-lock.json`

В монорепозитории `package-lock.json` обновляются автоматически. 

> Подробнее читайте в разделе [Автопубликация пакетов](./packages-autopublish.md).

Файлы `package-lock.json` нельзя добавлять в `.gitignore` и `.arcignore`.

При добавлении нового пакета начальную версию `package-lock.json` нужно сгенерировать вручную.

> Подробности в задаче [FEI-18975](https://st.yandex-team.ru/FEI-18975)

## Требования к исходному коду

Весь исходный код в монорепозитории должен соответствовать единому код-стайлу.
Правила код-стайла зафиксированы в npm-пакете [@yandex-int/lint](../../packages/lint/README.md).

Разрешается переопределять правила на уровне npm-пакетов и Node.js-сервисов.

## Требования к пулреквестам на arc

В настоящий момент мы находимся в переходном периоде, когда frontend работает на основе Trendbox CI, а другие проекты (например, web4) работают на основе Sandbox CI. Из-за этого факта нельзя в одном пулреквесте затрагивать разные проекты (даже если они находятся в рамках одной CI системы), так как у них могут быть разные CI-конфиги. Такой пулреквест не сможет прокрасить статусы обязательных проверок и влиться. Можно править код внутри frontend. Но нельзя одновременно трогать `frontend/projects/*` и `frontend/services` или `frontend/packages`.

## Требования к очередям в Трекере

Выдать доступ на чтение тикетов роботам:
* [robot-prosperity@]: нужно сервису [prosperity], он форматирует описание и заголовок пулл-реквестов;
* [robot-frontend@]: используется машинерией релизов, например, для форматирования чейнджлогов в релизах;
* [robot-serp-bot@]: используется TrendboxCI для нотификации в релизные тикеты о статусе релизной сборки.

[robot-frontend@]: staff.yandex-team.ru/robot-frontend
[robot-serp-bot@]: staff.yandex-team.ru/robot-serp-bot
[robot-prosperity@]: staff.yandex-team.ru/robot-prosperity
[prosperity]: https://arcanum.yandex-team.ru/arc_vcs/frontend/projects/microservices/services/prosperity/docs/pr-description-v2.md
