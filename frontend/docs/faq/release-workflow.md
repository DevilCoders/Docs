# Описание релизного процесса сервисов в монорепозитории

## Концепция зеленого транка
Все пакеты и сервисы в монорепозитории разрабатываются по методологии "зеленого транка". То есть все изменения вносятся через пулл-реквесты, в которых запускаются все имеющиеся виды проверок и тестов (см. [checks.md]). Таким образом, каждый коммит в основной ветке `trunk` считается стабильным, то есть не содержащим (заметных) багов. Также важно, что в ветке `trunk` нет прямых атомарных коммитов, а только merge-коммиты, которые считаются законченными фичами. Эти два положения позволяют нам отводить релиз от любого коммита в `trunk`.

## Релизные теги и версии пакетов
Каждый сервис в монорепозитории является де-юре npm-пакетом, т.к. содержит файл package.json. Однако, де-факто мы не выпускаем пакеты с сервисами не публикуем их в npm-репозиторий. Это значит, что нет необходимости версионировать сервисы через package.json. Более того, обновление версии сервиса в package.json должно сопровождаться сооветствующим коммитом, а это может усложнить работу Merge Queue.

Наши деплой-системы ориентируются на ветки и теги в системе контроля версий. Для очередного релиза сервиса нужно выставить тег на последний коммит в trunk в формате `releases/frontend/<сервис>/vMajor.Minor.Patch`, где `<сервис>` — название папки с кодом сервиса в папке `services`.

Примеры: `releases/frontend/news/v1.123.0`, `releases/frontend/ydo/v0.82.1`.

Номер мажорной версии в большинстве случаев не меняется и может означать создание с нуля совсем новой версии сервиса. Минорная версия является основной рабочей и используется для версионирования регулярных релизов из `trunk`. Патчевая версия используется для хотфиксов, когда релизная ветка отводится от текущего продакшен-тега и стабилизируется черри-пиками из `trunk`. Релизные ветки не нужно мерджить обратно в `trunk`, они фиксируются тегами: `tags/releases/frontend/granny/v1.128.3`.

[checks.md]: ./checks.md

## Отведение релизов

### Автоотведение релизов
Вы можете настроить автозапуск релиза по расписанию. Подробнее про настройки можно прочитать в [документации][schedule]. Простой пример конфига автозапуска:

```yml
auto:
  conditions:
    - schedule:
        days: MON, WED
        time: 04:00 - 04:30 MSK
        day-type: workdays
      since-last-release: 30m
```

[schedule]: https://docs.yandex-team.ru/ci/release#usloviya-avtozapuska-relizov

### Внеплановое отведение релиза
1. В [CI] на вкладке Releases найдите название вашего сервиса и перейдите на него.
1. На левом верхнем углу есть кнопка **Run release**, нажмите на неё.
1. В появившемся модальном окне выберите **Release flow**:
   * release-flow - для регулярных релизов
   * hotfix-flow - для хотфиксов
1. Нажмите на кнопку **Run release**.

[CI]: https://a.yandex-team.ru/projects/frontend/ci/releases/timeline?dir=frontend/services

### Сборка и выкладка в тестинг
При отведении релизной ветки или при пуше нового коммита в релизную ветку срабатывает Trendbox-хук, который запускает джобу Deploy из файла [.trendbox.yml](../../.trendbox.yml), которая запускает скрипт [../../packages/frontend-ci/legacy/trendbox/run-deploy.js](../../packages/frontend-ci/legacy/trendbox/run-deploy.js?rev=7b326160f33a50fe42f7b2dff2d8b3b9296d557b). Этот скрипт сделает следующее:

1. Соберёт сервис командой `npm run build`.
1. Выложит его статику в MDS командой `npm run ci:deploy:static`.
1. Соберёт пакет с динамикой командой `npx run ci:artifacts`.
1. Опубликует пакет с динамикой как sandbox-ресурс командой `npx sandbox upload-resource`. Это делается с помощью пакета [sandbox-shovel-cli](https://github.yandex-team.ru/search-interfaces/infratest/tree/master/packages/sandbox-shovel-cli).
1. Заведёт тикет на выкладку пакета с динамикой в няне командой `npx nanny-workflow create-release`. Это делается с помощью пакета [nanny-workflow-cli](https://github.yandex-team.ru/search-interfaces/infratest/tree/master/packages/nanny-workflow-cli). После выкладки няня отправит хук в `webhook-handler`, и сервис отпишется о раскатке в релизный тикет в стартреке.

Если в этой машинерии что-то сломалось, и не удаётся быстро разобраться, можно сходить к команде FEI, заполнив [форму](https://wiki.yandex-team.ru/infraduty/form/).

### Допушивание задачи в тестинг
Если вам нужно докатить багфиксный коммит до тестинга, а то, что влито в `trunk`, вы не хотите катить,то нужно сделать следующее:

1. Найти ту релизную ветку, которая сейчас в тестинге — она будет вида `releases/frontend/ugc/v1.44.0`, а точное имя можно понять из релизного тикета в стартреке.
1. Черипикать туда ваш фикс.
1. Запушить релизную ветку.

При пуше сработает хук, который запустит Trendbox-таску Deploy, которая соберёт сервис, задеплоит статику, соберёт динамику и т.д. — как при обычной выкладке в тестинг. Релизный тикет при этом не обновится, работа продолжится в старом.

### Выкладка в продакшен
Когда релизный таск находится в статусе «Протестировано», нужно перевести его в статус «Ready for Production». После этого автоматически заведётся выкладка в няне, типа [такой](https://nanny.yandex-team.ru/ui/#/r/SANDBOX_RELEASE-687301629-STABLE/). Ссылку на него автоматика должна добавить в комментарий к релизной таске. Затем нужно самостоятельно (силами дежурного от сервиса) выкатить этот релиз.

Процесс раскатки релиза описан в [инструкции](https://wiki.yandex-team.ru/search-interfaces/infra/report-renderer/selfduty/#relizyvshared). После этого ваш релизный тикет автоматически закроется.

### После релиза
Релиз считается выкаченным в production как только автоматика закроет его, отметив время и дату выкатки. С этого момента следует мобилизоваться всем заинтересованным участникам команды, которые не заняты другой деятельностью, но в особенности QA инженеру или релизному менеджеру:

  - следует проверить работоспособность production
  - тщательно мониторить:
    - https://yasm.yandex-team.ru/panel/yamd
    - https://yasm.yandex-team.ru/panel/frontend-server-errors
    - https://yasm.yandex-team.ru/panel/frontend-client-errors
  - при возникновении непрекращающихся всплесков и/или явных проблем в production следует действовать согласно описанию [нештатных ситуаций](#Нештатные-ситуации).

### Откатка релиза
Если в продакшене нашёлся критичный баг, релиз нужно откатить. Для этого нужно написать заявку [дежурному RR](https://wiki.yandex-team.ru/search-interfaces/infra/report-renderer/duty/), в которую приложить ваш релизный тикет из [SEAREL](https://st.yandex-team.ru/SEAREL), и продублировать её звонком.

### Выкладка хотфикса
Если вы обнаружили критичный баг в продакшене, который надо срочно починить, а в основной ветке уже появились задачи, которые катить рано, то нужно выкатить хофтикс – небольшой коммит с исправлением поверх версии, которая сейчас в продакшене.

Для этого:
1. В [CI] отвести хотфикс релиз.
1. Накатить в созданную ветку фикс. Про [реверт][del-pr] и [черипик][add-pr] коммитов в релизную ветку можно прочитать в [инструкции][add-pr].
1. Протестировать собранный релиз.
1. Найти в Sandbox ресурс с собранной динамикой.
    Пример [ресурсов с динамикой UGC](https://sandbox.yandex-team.ru/resources?type=WEB_UGC_MICRO_PACKAGE). Попросить дежурного Report Renderer выкатить ваш пакет [через форму](https://wiki.yandex-team.ru/search-interfaces/infra/report-renderer/duty/). Дежурному нужно позвонить по телефону, чтобы убедиться, что он возьмёт его в работу. СМС может не разбудить его ночью. Дежурного можно найти на той же странице в Вики.

> Запушенные сборки после пуша в релизную ветку можно посмотреть интерфейсе [Trendbox UI] по строке `type:branch branch:releases/frontend/<сервис>/<версия>`.

[Infraduty]: https://forms.yandex-team.ru/surveys/17756/
[CI]: https://a.yandex-team.ru/projects/frontend/ci/releases/timeline?dir=frontend/services
[add-pr]: https://wiki.yandex-team.ru/serp/release/#add-pr
[del-pr]: https://wiki.yandex-team.ru/serp/release/#del-pr
