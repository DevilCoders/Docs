# favorites

`favorites` — Набор компонентов для работы с API [коллекций](https://wiki.yandex-team.ru/collections/Ruchki-dlja-Edinogo-Izbrannogo/).

## Содержание
1. [Требования](#Требования)
1. [Состав](#Состав)
1. [Использование](#Использование)
    1. [favorites-settings](#favorites-settings)
    1. [favorites-iframe](#favorites-iframe)
    1. [favorites-modal](#favorites-modal)
1. [Методы](#Методы)
1. [События](#События)
1. [Установка](#Установка)
1. [FAQ](#FAQ)

## Требования
Компоненты в технологии `i-bem`, для корректной работы необходимы компоненты `popup`, `modal`, `tooltip` из Лего на проекте.

## Состав
* `favorites-controller` — блок реализующий [методы API](https://wiki.yandex-team.ru/collections/Ruchki-dlja-Edinogo-Izbrannogo/) для работы с коллекциями
* `favorites-settings` — блок глобальных настроек для компонентов работы с коллекциями
* `favorites-iframe` — блок для отображения списка коллекций в iframe-окне
* `favorites-modal` — блок для предварительного отображения списка коллекций для быстрого добавления на платформе `touch-phone`
* `header-favorites-button` — блок кнопка со значком Избранное
* `favorites-control` - блок кнопка для добавления в отложенные

## Использование
Для подключения компонента на сервисе достаточно подключить контриб на проект и в зависимостях прописать `favorites-settings`.

### favorites-settings
Для инициализации компонента на странице должен присутствовать базовый блок `favorites-settings` с настройками:

```js
{
    block: `favorites-settings`,
    edit: Boolean,
    loginUrl: String,
    js: {
        target: String,
        logged: Boolean,
        withoutButtons: Boolean,
        counterParams: {
            serpid: String,
            reqid: String
        }
    }
}
```

| Параметр | Тип | Описание |
| --- | --- | --- |
| `edit` | `Boolean` | Показывать ли кнопку «Изменить» в тултипе после добавления карточки |
| `loginUrl` | `String` | Url к паспорту для авторизации со всеми параметрами для успешного возращения в нужное состояние сервиса |
| `js` | `Object` | Параметры пробрасываемые в клиент |
| `js.target` | `String` | CSS селектор якоря, куда привязать тултип об успешном или неуспешном добавлении в коллекцию |
| `js.logged` | `Boolean` | Признак что пользователь аутентифицирован, на его основании компонент будет добавлять в коллекцию по умолчанию и после показывать предложение авторизоваться |
| `js.withoutButtons` | `Boolean` | В различных сценариях на сервисах необходимо скрывать кнопки в тултипе _(устарело)_ |
| `js.counterParams` | `Object` | Параметры пробрасываемые в счётчик, для правильного подсчёта нужны `serpid` и `reqid` используемые для склейки |

### favorites-iframe
Для показа списка коллекций нужно подключить блок `favorites-iframe` на desktop и `favorites-modal` на touch-phone платформе.

```js
{
    block: 'favorites-iframe',
    js: {
        iframeUrl: String,
        logged: Boolean,
        withModal: Boolean,
        source_type: String,
        counterParams: {
            serpid: String,
            reqid: String
        }
    }
}
```

Параметры аналогичны `favorites-settings`, кроме:

| Параметр | Тип | Описание |
| --- | --- | --- |
| `iframeUrl` | `String` | Необязательный параметр iframe-коллекций, по умолчанию будет использоваться коллекции поднятые на той же бете |
| `source_type` | `String` | тип контента по умолчанию, призван ускорить первую загрузку iframe для заданного контента, может быть одним из [допустимых типов карточки](https://wiki.yandex-team.ru/collections/Ruchki-dlja-Edinogo-Izbrannogo/) |
| `withModal` | `Boolean` | Используется ли вместе с `favorites-modal` — для некоторых сервисов нужна возможность экспериментировать в разных комбинациях — на desktop платформе нужно всегда в `true`, на touch-phone в зависимости от потребности сервиса _(устарело и в следующих версиях дефолты будут в самих блоках)_|

### favorites-modal
Для показа списка коллекций на touch-phone платформе стоит подключить блок `favorites-modal`.

```js
{
    block: 'favorites-modal',
    js: {
        logged: Boolean,
        withIframe: Boolean,
        counterParams: {
            reqid: reqId
        }
    }
}
```

Параметры аналогичны `favorites-settings` и `favorites-iframe`, кроме:

| Параметр | Тип | Описание |
| --- | --- | --- |
| `withIframe` | `Boolean` | Используется ли вместе с `favorites-iframe` — для некоторых сервисов нужна возможность экспериментировать в разных комбинациях _(устарело и в следующих версиях дефолты будут в самих блоках)_|

### header-favorites-button

| Параметр | Тип | Описание |
| --- | --- | --- |
| `hidden` | `Boolean` | Управляет видимостью кнопки при отрисовке. Кнопка скрывается до её перемещения в шапку. **Default**: true |

### favorites-control

```js
{
    block: 'favorites-control',
    mods: {
        saved: Boolean
    }
}
```

| Параметр | Тип | Описание |
| --- | --- | --- |
| `mods` | `Object` | Модификаторы |
| `mods.saved` | `Boolean` | Признак того, что карточка уже сохранена |

### setSource(params, sourceName)
Метод для сохранения данных о карточке (используются при добавлении/удалении)

| Параметр | Тип | Описание |
| --- | --- | --- |
| `params` | `Object` | Данные |
| `params.itemId` | `String` | Уникальный идентификатор, используется для кэширования. Необходим для работы кнопки |
| `params.isFavorite` | `Boolean` | Если карточка уже добавлена в Коллекции |
| `sourceName` | `String` | Источник данных, отправляется в бэкенд Коллекций для аналитики |

Остальные данные согласно документации бэкенда Коллекций.

## Методы

Публичные методы есть только у блока `favorites-controller`:

### createCard(itemId, card, useDefault)
Добавления карточки в коллекцию с использование полного пользовательского сценария — открытия окна, и пробросом всех нужных данных для его работы.

| Параметр | Тип | Описание |
| --- | --- | --- |
| `itemId` | `String` | Идентификатор документа на сервисе _(это не ID карточки на сервисе коллекций)_.|
| `card` | `Object` | Объект карточки в [заданном формате](https://wiki.yandex-team.ru/collections/Ruchki-dlja-Edinogo-Izbrannogo/#ruchkadobavlenijakartochki). |
| `useDefault` | `Boolean` | Параметр, который выключает сценарий использования окна списка коллекций и добавляет в коллекцию по умолчанию.|

### addCard(itemId, card, board)
Добавления карточки непосредственно в нужную коллекцию _(без пользовательского взаимодействия)_

| Параметр | Тип | Описание |
| --- | --- | --- |
| `itemId` | `String` | Идентификатор документа на сервисе _(это не ID карточки на сервисе коллекций)_.|
| `card` | `Object` | Объект карточки в [заданном формате](https://wiki.yandex-team.ru/collections/Ruchki-dlja-Edinogo-Izbrannogo/#ruchkadobavlenijakartochki). |
| `board` | `String` | ID коллекции куда добавляем |

### removeCard(itemId, card, params)
Удаление карточки из коллекции

| Параметр | Тип | Описание |
| --- | --- | --- |
| `itemId | `String` | Идентификатор документа на сервисе _(это не ID карточки на сервисе коллекций)_.|
| `card` | `Object` | Объект карточки в [заданном формате](https://wiki.yandex-team.ru/collections/Ruchki-dlja-Edinogo-Izbrannogo/#ruchkadobavlenijakartochki). |
| `params` | `Object` | Устаревший параметр для совместимости со старыми ручками коллекций|

### moveCollectionsCard(card, boardId)
Перемещение карточки из одной коллекции в другую

| Параметр | Тип | Описание |
| --- | --- | --- |
| `card` | `Object` | Объект карточки в [заданном формате](https://wiki.yandex-team.ru/collections/Ruchki-dlja-Edinogo-Izbrannogo/#ruchkadobavlenijakartochki). |
| `boardID` | `String` | ID коллекции куда перемещаем карточку |

### hasCollectionCard(itemId)
Проверяет сохранена ли карточка в одну из коллекций. Если карточка ранее добавлялась/перемещалась и это отражено в кеше — возвращает `true`.

| Параметр | Тип | Описание |
| --- | --- | --- |
| `itemId` | `String` | Идентификатор документа на сервисе _(это не ID карточки на сервисе коллекций)_.|

### markAsSaved(itemId)
Помечает картинку как сохраненную в коллекциях.

| Параметр | Тип | Описание |
| --- | --- | --- |
| `itemId` | `String` | Идентификатор документа на сервисе _(это не ID карточки на сервисе коллекций)_.|


## События
Компонент использует `i-bem` канал `collections` для различных событий:

| Событие | Описание |
| --- | --- |
| 'window:ready' | iframe со списком коллекций открыт и готов к взаимодействию.|
| 'window:saved' | Карточка добавлена в коллекцию.|
| 'window:removed' | Карточка удалена из коллекций.|
| 'window:closed' | iframe со списком коллекций был закрыт.|
| 'favorite:error' | Возникла ошибка при добавлении в коллекцию и будет показан тултип об этом.|
| 'favorite:blur' | Возникло событие предполагающее прекращение взаимодействия с интерфейсом компонента — будут скрыты тултипы и окно со списком добавления коллекций.|
| 'deferred:before:save' | Карточка в начале процеса сохраниния в отложенные.|
| 'deferred:saved' | Карточка сохранена в отложенные.|
| 'deferred:before:remove' | Карточка в начале процеса удаления из отложенных.|
| 'deferred:removed' | Карточка удалена из отложенных.|

_(В  некоторые события приходит и сам объект карточки, но текущее соглашение не предполагает, что сервис анализирует её контент. На событие можно подписаться чтобы знать, что оно произошло.)_

## Установка

```bash
npm i @yandex-lego/favorites --registry https://npm.yandex-team.ru
```

## FAQ

### Как разрабатываться на сервисе

Для удобства разработки устанавливаем symlink на пакет, для этого заходим в папку с пакетом и пишем `npm link`, далее идем в нужный сервис и ставим текущий пакет через symlink `npm link @yandex-lego/favorites`, при изменениях в пакете на сервисе необходимо запускать полную сборку, чтобы пакеты из `node_modules` тоже обновлялись.

### Тестирование

После того, как все изменения были сделаны необходимо отдать в тестирование на `fiji` и `web4`, для этого необходимо выпустить [тестовую](#Выпуск-тестовой-версии) версию.

>**_Если вы видите, что версия на сервисе отличается от вашей больше чем на одну, то в тестировании необходимо проверить все платформы._**

При написании тестов на сервисе нужно помнить, что компонент ходит в API ручки и показывает iframe с сервиса Коллекций.
Для написания тестов лучше стабить эти методы, например [как это сделано в fiji](https://github.yandex-team.ru/mm-interfaces/fiji/blob/dev/features/sakhalin/common/collections/assets/mock-collections-api.js):

```js
BEM.decl('favorites-controller', {}, {
    _favoritesGetResponse: function(action, itemId, card) {
        // ...
    }
}
```

### Выпуск тестовой версии

Обновляем версию вручную в `package.json`, добавляем суффикс к основной версии `0.0.1-beta.1` и публикуем в тэг со своим ником `npm publish --registry https://npm.yandex-team.ru --tag <username>`.

### Влитие в dev

Перед влитием в dev необходимо раскатить [стабильную](#Выпуск-стабильной-версии) версию на сервисы `fiji` и `web4` и добавить в текущий ПР ссылки на влитые ПР в сервисах, чтобы убедиться, что код был протестирован.

### Выпуск стабильной версии

Версионирование происходит по [semver](https://semver.org), определяем какой тип изменений был, обновляем версию `npm version patch|minor|major` и публикуем `npm publish --registry https://npm.yandex-team.ru`.
