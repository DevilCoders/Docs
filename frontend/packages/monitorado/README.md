# Monitorado

![](https://badger.yandex-team.ru/npm/@yandex-int/monitorado/version.svg)
![](https://badger.yandex-team.ru/npm/@yandex-int/monitorado/owner.svg)
[![OKO health](https://oko.yandex-team.ru/badges/repo.svg?vcs=arc&repoName=frontend/packages/monitorado)](https://oko.yandex-team.ru/repo/search-interfaces/frontend?repoFilter=packages/monitorado)

![monitorado-logo](https://wiki.yandex-team.ru/iddqd/.files/monitorado.png/)

:warning: Внимание: начиная с версии **6.2.0**, NPM-пакет переехал из `monitorado` в `@yandex-int/monitorado`

Утилита для настройки мониторингов на различные метрики

* [стейджа в Deploy](./docs/deploy.md)
* [компонента в Qloud](./docs/qloud.md)
* [сервиса в Nanny (RTC)](./docs/nanny.md)
* [балансера, сконфигурированного через AWACS (RTC)](./docs/awacs.md)
* [базы в MDB](./docs/mdb.md)
* [проекта в Error booster](./docs/error_booster.md)

При помощи простого файла конфигурации позволяет настроить уведомления в Telegram, по смс, почте и звонком.

[Чат поддержки](https://q.yandex-team.ru/#/join/fbe8b000-35bf-49ec-ad34-8549f62ca86c)

- [Что делает Monitorado](#что-делает-monitorado)
- [Миграция со старых версий конфига](#миграция-со-старых-версий-конфига)
- [Getting started](#getting-started)
    - [Что нужно для работы](#что-нужно-для-работы)
    - [Установка](#установка)
    - [Токены](#токены)
    - [Создание конфига](#создание-конфига)
    - [Применение мониторингов](#применение-мониторингов)
- [Важные факты о мониторингах](#важные-факты-о-мониторингах)
- [Команды](#команды)
    - [diff](#diff)
    - [exec](#exec)
    - [gen](#gen)
    - [unsafe-delete](#unsafe-delete)
- [Конфигурационный файл](#конфигурационный-файл)
    - [Секция juggler_checks_defaults](#секция-juggler_checks_defaults)
    - [Секция juggler_notify_statuses](#секция-juggler_notify_statuses)
    - [Секция notifications](#секция-notifications)
    - [Секция deploy](#секция-deploy)
    - [Секция qloud](#секция-qloud)
    - [Секция mdb](#секция-mdb)
    - [Секция nanny](#секция-nanny)
    - [Секция awacs](#секция-awacs)
    - [Секция error_booster](#секция-error_booster)
- [FAQ](#faq)
    - [Как настроить уведомления в Telegram](#как-настроить-уведомления-в-telegram)
    - [Как настроить уведомления по календарю](#как-настроить-уведомления-по-календарю)
    - [Как удалить настроенные алерты](#как-удалить-настроенные-алерты)
    - [Как переехать в свой Juggler-неймспейс](#как-переехать-в-свой-juggler-неймспейс)
- [Поддержка](#поддержка)


## Что делает Monitorado

1. Получает из нескольких API информацию об объектах и настроенных Yasm алертах.
1. Синхронизирует настроенные на объект Yasm алерты и привязанные к ним Juggler чеки с конфигом (добавленные в конфиг - создает, убранные из конфига - удаляет, при изменении настроек в конфиге - обновляет).
1. Привязывает Telegram логины к Juggler, чтобы пользователю (либо в группу) мог писать бот Juggler Search.

В итоге: можно навесить на любую численную метрику ограничения (`warn`/`crit`) и получать уведомления о том, что значения метрики вышли за ограничения или нормализовались. Режим `inverse` инвертирует ограничения, 
т.е. алерт находится в статусе `CRIT`, если значение метрики меньше `crit`, и в статусе `OK`, если оно выше `warn`.

## Миграция со старых версий конфига
- Для обновления конфига **с версии 1 до версии 4** нужно перенести секции `apps` и `alertsets` внутрь новой секции `qloud` и добавить в начало конфига `version: 4`.
- Для обновления конфига **с версии 2 до версии 4** нужно поменять полное имя базы, добавив название облака в начало и название базы данных в конец, а также добавить в начало конфига `version: 4`.
- Для обновления конфига **с версии 3 до версии 4** нужно добавить в начало конфига `version: 4`.

- Для обновления конфига **с версии 4 до версии 5** нужно:
  * переписать секцию `notifications` в соответствии с новым форматом (было `<preset>.<login>: [<method>]`, стало: `<preset>.<method>: [<login>]`)
  * перенести массив `golem_responsibles` в `notifications.<preset>.phone` (`golem_responsibles` нужно удалить)
  * добавить в начало конфига `version: 5`.

- Для обновления конфига **с версии 5 до версии 6** нужно в секции `mdb.databases` добавить в начало идентификатора `postgresql:`, убрать имя базы (последний компонент) и добавить в начало конфига `version: 6`.
- Для обновления конфига **с версии 6+ до версии 8** нужно добавить в начало конфига `version: 8`.
- Для обновления конфига **с версии 8 до версии 9** нужно добавить в начало конфига `version: 9` и прописать неймспейс для Juggler-проверок. См. ниже.
- Для обновления конфига **с версии 9 до версии 10** нужно добавить в начало конфига `version: 10`. У всех алертов в diff изменится хэш, это нормально.

## Ломающие изменения

* В **версии 8.0.0** к имени Juggler-проверок для всех объектов, кроме Qloud-компонент, добавился приефикс `m.`. Если у вас есть ручные правила нотификации,
настроенные на хост, их нужно поменять.
* В **версии 9.0.0** обязательно нужно задать неймспейс для Juggler-проверок. Инструкция: [тыц](#как-переехать-в-свой-juggler-неймспейс).

## Getting started

### Что нужно для работы

1. Node.JS версии >= 8.0
1. Доступ на чтение до каждого заданного проекта и окружения в Qloud
1. Доступ до каталога (фолдера) для каждой заданной базы данных

### Установка

```
npm i -g @yandex-int/monitorado --registry=https://npm.yandex-team.ru
```

### Токены
Токен можно получить [тут](https://oauth.yandex-team.ru/authorize?response_type=token&client_id=171fcece39a04fd0a6b8b74950336008)
и положить в переменную окружения `MONITORADO_OAUTH_TOKEN`. Если она пуста, Monitorado попытается обменять ssh-ключ из файла `~/.ssh/id_rsa` автоматически.

Также поддерживается загрузка из файла `.env`, который должен лежать в рабочей директории. [Пример](./examples/example.env)

### Создание конфига

Есть два варианта получить свой собственный конфиг:

1. Воспользоваться командой [gen](#gen), которая сгенерирует конфиг и положит в `.monitorado.yml`.

        # Запускаем генератор конфига и отвечаем на вопросы
        monitorado gen

2. Взяв [пример полного конфига](./examples/full.example.yml) за основу, поменять настройки уведомлений (`notifications`).

> :bulb: Стоит просмотреть полученный конфиг хотя бы по диагонали и при необходимости подкрутить пороговые значения под себя.

### Применение мониторингов

1. Кладем конфиг в `.monitorado.yml`.

1. Смотрим, какие изменения будут сделаны:

   `monitorado diff -v`

1. Настраиваем мониторинги:

   `monitorado exec -v`

## Важные факты о мониторингах
1. Когда алерт переходит в статус `CRIT`, происходит следующее:
   1. Срабатывает флаподав, который "гасит" проверку на некоторое время:
      * если статус стабильно равен `CRIT`, то на `flaps.stable` секунд (по умолчанию 2 минуты).
      * если статус флапает, то на `flaps.critical` секунд (по умолчанию 5 минут).
   1. Отправляются уведомления в виде сообщения (методы `telegram`, `sms`, `email`).
   1. Если в уведомлениях указан метод `phone`:
      1. Запускается задержка перед звонком на `phone.delay` секунд (по умолчанию 5 минут).
      1. Робот начинает обзвон людей.

   Таким образом, при поломке сервиса мы получим текстовое уведомление через **2-5 минут** и звонок через **7-10 минут**.
   Если для вас это слишком долго, нужно покрутить указанные выше параметры из секции `juggler_checks_defaults` и опций метода `phone`.

1. Не стоит редактировать созданные Yasm алерты или Juggler проверки руками через морды Yasm/Juggler/Qloud.
   При использовании Monitorado другой версии алерты могут быть обновлены. В этом случае все ручные правки будут потеряны.

1. Monitorado работает только с алертами с префиксом `monitorado.` и привязанными проверками.
   Потому мониторинги, настроенные вручную или другими генераторами, не будут затронуты.

## Команды

### diff

Показывает разницу между уже настроенными алертами и алертами, описанными в конфиге.
Генерирует HTML с диффом в git-like формате. Полезно, если вы не понимаете, что происходит.

Опциональные параметры:

* `-c` (`--config`) - Путь до конфига. По умолчанию `.monitorado`.
* `-v` (`--verbose`) - Включает подробный вывод.
* `-n` (`--no-validate`) - Выключает валидацию конфига по json-схеме.
* `-d` (`--configs-dir`) - Применить ко всем .y(a)ml в указанной директории.
* `-r` (`--recursive`) - Применить рекурсивно(т.е. к файлам директории, указанной в `-d`, и всех sub-директорий). Если 
  `-d` не указан, поиск происходит из текущей директории.
* `-a` (`--allow-downgrade`) - Разрешить перезаписывать существующий алерт более старой версией. По умолчанию запрещено.

Пример:
```
> monitorado diff

info: Список ответственных за qloud-ext.doc.support-api.production.backend будет обновлен
info: Хост qloud-ext.doc.support-api.production.backend:
info:     Будет создано алертов: 3
info:         monitorado.doc.support-api.production.backend.http_4xx
info:         monitorado.doc.support-api.production.backend.http_499
info:         monitorado.doc.support-api.production.backend.timings_p99
info:     Будет удалено алертов: 1
info:         monitorado.doc.support-api.production.backend.cpu_load
info:     Будет обновлено алертов: 1
info:         monitorado.doc.support-api.production.backend.http_5xx
info:     Не изменилось алертов: 1
info:         monitorado.doc.support-api.production.backend.mem_usage
info: Список ответственных за хост mdb.postgresql.meta-infra.locdoc-dev.support актуален
info: Хост mdb.postresql.meta-infra.locdoc-dev.support:
info:     Будет создано алертов: 1
info:         monitorado.mdb.postresql.meta-infra.locdoc-dev.support.cpu_load
info:     Не изменилось алертов: 0
info: Посмотреть, что именно изменилось в алертах в git-like формате: file:///var/folders/16/hrc8f9mx4cgcrs8l735bg0_r4t31j1/T/diff_2020-3-31_14:32:48.html
```

### exec

Синхронизирует настроенные алерты с теми, что описаны в конфиге, а также при необходимости
привязывает Telegram логины к Juggler.

Опциональные параметры:

* `-c` (`--config`) - Путь до конфига. По умолчанию `.monitorado`.
* `-v` (`--verbose`) - Включает подробный вывод.
* `-n` (`--no-validate`) - Выключает валидацию конфига по json-схеме.
* `-d` (`--configs-dir`) - Применить ко всем .y(a)ml в указанной директории.
* `-r` (`--recursive`) - Применить рекурсивно (т.е. к файлам директории, указанной в `-d`, и всех sub-директорий). Если
  `-d` не указан, поиск происходит из текущей директории.
* `-a` (`--allow-downgrade`) - Разрешить перезаписывать существующий алерт более старой версией. По умолчанию запрещено.
  
Пример:
```
> monitorado exec

info: Обновление ответственных за хост qloud-ext.doc.support-api.production.backend
info: Создание алерта monitorado.doc.support-api.production.backend.http_4xx
info: Создание алерта monitorado.doc.support-api.production.backend.http_499
info: Создание алерта monitorado.doc.support-api.production.backend.timings_p99
info: Обновление алерта monitorado.doc.support-api.production.backend.http_5xx
info: Удаление алерта monitorado.doc.support-api.production.backend.cpu_load
info: Создание алерта monitorado.mdb.meta-infra.postresql.locdoc-dev.support.cpu_load
info: Телеграм аккаунт @locdoc-mon2 привязан к Juggler.
info: Теперь нужно пригласить @JugglerSearchBot и написать "/start locdoc-monitoring".
```

### gen

Запускает интерактивный генератор конфига и сохраняет результат в файл `.monitorado.yml` внутри рабочей директории.

[Как это выглядит](https://jing.yandex-team.ru/files/nikshel/screencast_2019-03-12_14-58-22.mp4)

### unsafe-delete

Удаляет алерты с заданным префиксом.

Принимает один обязательный параметр `--prefix`.

> :warning: Следует использовать **только** в случае, когда объект мониторинга был
удален или перемещен (переименован). Например, MDB-базу перенесли в другое облако.

> :warning: Перед тем, как ответить "Да", убедитесь, что удаляете только свои алерты!

Пример:
```
# Удаляем все алерты для MDB-баз в старом каталоге locdoc-dev
> monitorado unsafe-delete --prefix mdb.postgresql.meta-infra.locdoc-dev

warn: Будут удалены следующие алерты:
warn: mdb.postgresql.meta-infra.locdoc-dev.daas.cpu_load
warn: mdb.postgresql.meta-infra.locdoc-dev.daas.mem_usage

? Удаляем? В списке точно нет нужных или чужих алертов? Yes
info: Алерты были удалены
```

## Конфигурационный файл

* [Минимальный конфиг](./examples/simple.example.yml)
* [Конфиг с демонстрацией всех возможностей](./examples/full.example.yml)

Например:

```yaml
version: 10

# Настройки для сгенерированных Juggler-проверок
juggler_checks_defaults:
  # Неймспейс, к которому будут привязаны Juggler-проверки
  namespace: maps

# Пресеты уведомлений
notifications:
  # Пишем логины и методы оповещения
  default:
    telegram: [ya-maps-monitoring, abc:maps:administration]
    email: [some-login1, abc:maps:administration]
    phone: [some-login1, some-login2]  # Кому звонить, когда все плохо

# Общие настройки для всех алертсетов
settings_defaults:
  notifications: [default]  # Пресеты, по которым нужно отправлять уведомления
  abc: maps  # Имя ABC-сервиса, к которому будут привязаны алерты

# Мониторинги на стейджи и деплой юниты в Deploy
deploy:
  objects:
    stage:maps_backend: default  # На весь стейдж целиком
    deploy_unit:maps_backend.backend: default  # На один деплой юнит
    workload:maps_backend.backend.application: default  # На один ворклоад

  alertsets:
    default:
      alerts:
        cpu_usage:
          signal: '%cpu_perc(99)'  # 99-ый перцентиль потребления CPU
          warn: 60  # Статус WARN, если больше 60%
          crit: 80  # Статус CRIT, если больше 80%

# Мониторинги на компонент в Qloud
qloud:
  # Пишем полные имена своих компонентов
  apps:
    # * означает "любое приложение в проекте maps"
    maps.*.production.www: default

  alertsets:
    default:
      alerts:
        http_5xx:
          signal: '%5xx_perc'  # Процент пятисоток
          warn: 0.1  # Статус WARN, если больше 0.1%
          crit: 2  # Статус CRIT, если больше 2%

# Мониторинги на базу в MDB
mdb:
  # Пишем тип и полный идентификатор базы данных
  databases:
    postgresql:maps_cloud.maps_folder.maps_cluster: default

  alertsets:
    default:
      alerts:
        cpu_load:
          signal: '%cpu_perc'  # Процент потребления CPU
          warn: 50  # Статус WARN, если больше 50%
          crit: 85  # Статус CRIT, если больше 85%
          tier: master  # Учитываем только мастер

# Мониторинги на сервис в Nanny
nanny:
  # Пишем имя сервиса
  services:
    maps_backend_man: default

  alertsets:
    default:
      alerts:
        cpu_load:
          signal: '%cpu_perc'  # Процент потребления CPU
          warn: 50  # Статус WARN, если меньше 50%
          crit: 25  # Статус CRIT, если меньше 25%
          inverse: true # Режим, при котором высокие значения соответсвуют статусу ОК 

# Мониторинги на AWACS-балансер
awacs:
  # Пишем имя неймспейса и report uuid секции
  sections:
    # неймспейс = maps.yandex.net
    # report uuid = service_total, означает "мониторим сразу все апстримы"
    maps.yandex.net.service_total: default

  alertsets:
    default:
      alerts:
        http_5xx:
          signal: '%5xx_perc'  # Процент пятисоток
          warn: 0.1  # Статус WARN, если больше 0.1%
          crit: 2  # Статус CRIT, если больше 2%

```

### Секция juggler_checks_defaults

Настройки сгенерированных Juggler-проверок. Далее их можно будет переопределить для каждого алертсета или алерта. Необязательная секция.

По умолчанию выставляются такие значения:
```yaml
juggler_checks_defaults:
  refresh_time: 30
  ttl: 900
  aggregator: logic_or
  aggregator_kwargs:
    nodata_mode: force_crit
  flaps:
    stable: 120
    critical: 300
    boost: 0
  tags: []
```

Все поля необязательные, про их значения можно почитать [в документации Juggler](https://wiki.yandex-team.ru/sm/juggler/objects/#aggregate).
Тэги из массива `tags` будут добавлены ко всем алертам. Это может быть полезно, если вы хотите настраивать уведомления централизованно через [Notify Rules в Juggler](https://juggler.yandex-team.ru/notification_rules/).

Также тут стоит указать неймспейс, в котором будут создаваться проверки, добавив поле `namespace: my-namespace`.
Подробнее про неймспейсы можно почитать [здесь](https://wiki.yandex-team.ru/sm/juggler/authentication/).

### Секция juggler_notify_statuses

Список статусов или переходов статуса, в ответ на которые будет отправляться уведомление (не влияет на звонки).

Формат:
```yaml
juggler_notify_statuses:
  - from: WARN
    to: CRIT
  - from: OK
    to: CRIT

# либо
juggler_notify_statuses:
  - CRIT
```

По умолчанию уведомление отправляется при любой смене статуса.

### Секция notifications

Пресеты настроек для уведомлений. Определяют, кому и как нужно отправить сообщение или позвонить при изменении статуса проверок.

Формат:
```yaml
notifications:
  <имя_пресета>:
    settings:
      juggler_notify_statuses: [CRIT]
    sms: [<логин1>, <логин2>, ...]
    email: [<логин1>, <логин2>, ...]
    telegram: [<логин1>, <логин2>, ...]
    phone: [<логин1>, <логин2>, ...]  # Сюда также можно передать опции, см. ниже
```

Для каждого пресета можно переопределить глобальный `juggler_notify_statuses` (см. [juggler_notify_statuses](#секция-juggler_notify_statuses)).

Уведомления с методами `sms`, `email` и `telegram` отправляются при **любых** переходах алерта между статусами `OK`, `WARN`, `CRIT`, а с методом `phone` - только при нахождении в `CRIT` на протяжении некоторого времени.
Все поля с методами отправки необязательны.

* Для `sms`, `email` указываются внутренние логины. Кроме того, можно настроить отправку уведомлений участникам встреч в определенном календаре.
  Для этого в качестве логина нужно указать `calendar_<id>`, где `<id>` - идентификатор календаря. Подробнее [в FAQ](#как-настроить-уведомления-по-календарю).

  Также поддерживаются ABC-роли в формате `abc:{service}:{role}`. В этом случаяе уведомления будут приходить всем, у кого есть роль.

* Для `telegram` указываются либо внутренние логины, либо ABC-роли (см. выше), либо имена групп и логины **из Telegram**, куда будет писать бот Juggler Search.
  В первых двух случаях случае нужно, чтобы Telegram-логин был привязан на Стаффе.
  О том, как настроить уведомления в Telegram, можно прочитать [в FAQ](#как-настроить-уведомления-в-telegram).

* Для `phone` указываются внутренние логины. Их порядок определяет то, как именно робот будет обзванивать людей.
  Вместо массива можно передать объект со следующими полями:

  * `logins` - массив логинов. Единственное обязательное поле.
  * `delay` - задержка в секундах перед первым звонком после перехода проверки в `CRIT`. По умолчанию `300` (5 минут).
  * `repeat` - сколько раз звонить по указанному списку логинов. По умолчанию `2`.
  * `call_tries` - сколько раз пытаться дозвониться до каждого пользователя. По умолчанию `1`.
  * `time_start` и `time_end` - определяют временной диапазон, за пределами которого звонить не нужно.

  Механика работы `phone`:
  Когда алерт переходит в статус `CRIT`, робот ждет `delay` секунд, после чего звонит первому человеку из списка.
  Если человек взял трубку и завершил эскалацию (нажал `4` на клавиатуре), обзвон прекращается.
  Новый обзвон в этом случае начнется только если алерт перешел в `OK`/`WARN`, а затем обратно вернулся в `CRIT`.
  Если же человек трубку не взял, робот перезванивает/звонит следующему, в зависимости от настроек, описанных выше.

Пример:
```yaml
notifications:
  chat:  # Бот будет писать в телеграм-группу
    telegram: [locdoc-mon]
  team:  # Уведомления членам команды
    telegram: [nikshel-tg]
    sms: [dimastark]
    email: [kvas]
    phone: [nikshel]
  calendar:  # Уведомления участникам встреч в календаре
    sms: [calendar_1234]
    email: [calendar_5678]
```

### Секция settings_defaults

Настройки по умолчанию для алертсетов. Далее их можно будет переопределить для каждого алерта. Необязательная секция. Все поля также необязательны.

1. `notifications` - массив названий пресетов уведомлений.

   Определяет общие настройки уведомлений для всех алертов в алертсете.

1. `abc` - имя (слаг) ABC-сервиса, к которому будут привязаны алерты.

Пример:
```yaml
settings_defaults:
  notifications: [chat, team]
  abc: maps
```

### Секция deploy

Настройки алертов для Deploy стейджей и деплой юнитов.

[Документация](./docs/deploy.md).

### Секция qloud

Настройки алертов для Qloud компонент.

[Документация](./docs/qloud.md).

### Секция mdb

Настройки алертов для баз данных в MDB.

[Документация](./docs/mdb.md).

### Секция nanny

Настройка алертов для Nanny сервисов.

[Документация](./docs/nanny.md).

### Секция awacs

Настройка алертов для балансеров (неймспейсов), конфигурируемых через AWACS.

[Документация](./docs/awacs.md).

### Секция error_booster

Настройка алертов для проектов в Error booster.

[Документация](./docs/error_booster.md).

## FAQ

### Как настроить уведомления в Telegram

1. В личку человеку
   Привязываем телеграм-аккаунт на стафф, затем отправляем `@JugglerSearchBot` команду `/start`

2. В общую группу
   Добавляем `@JugglerSearchBot` в группу и отправляем ему `/start@JugglerSearchBot <название_группы>`.
   Название группы тут то же самое, что указывается в качестве логина в нотификациях

Также имеет смысл сразу настроить бота:
* `/set_format short_with_host` - меняем формат мониторингов на более компактный (без тэгов).
* `/enable_dt_buttons` - добавляем кнопки для управления даунтаймами.

### Как настроить уведомления по календарю

1. Создаем новый календарь [тут](https://calendar.yandex-team.ru/).
1. На странице настройки доступов тыкаем "Открыть публичный доступ".
1. Запоминаем идентификатор календаря. Это параметр `layer_ids` в публичной ссылке на календарь.
1. Создаем одну или несколько регулярных встреч. Встречи должны быть открытыми, а в участники нужно добавить `@robot-juggling`.
1. В секции `notifications` в качестве логина указываем `calendar_<id>`, где `<id>` - идентификатор из пункта 3.
1. Проливаем мониторинги.

Теперь при срабатывании алерта уведомления будут отправлены участникам встречи, которая **идет в данный момент**.
Поэтому рекомендуется сразу создать регулярную ежедневную встречу на весь день.

### Как удалить настроенные алерты

Нужно положить в алертсет пустой объект:
```yaml
alertsets:
  default:
    alerts: {}
```

А затем запустить [exec](#exec).

Если это не помогает (не получается найти хост по идентификатору),
нужно вручную удалить алерты с помощью команды [unsafe-delete](#unsafe-delete).

### Как переехать в свой Juggler-неймспейс

Раньше проверки создавались в коммунальном неймспейсе `yasm.abmry.simple`, но теперь обязательно нужен свой.

1. Создать его [тут](https://juggler.yandex-team.ru/namespaces/).
2. Добавить в начало конфига [секцию juggler_check_default](#секция-juggler_checks_defaults) с полем `namespace`, см. примеры.
3. Пролить мониторинги. Проверки переедут бесшовно.

## Поддержка

Со всеми вопросами и предложениями можно приходить в [очередь MONITORADO](https://st.yandex-team.ru/createTicket?queue=MONITORADO) или [чатик поддержки](https://q.yandex-team.ru/#/join/fbe8b000-35bf-49ec-ad34-8549f62ca86c).
