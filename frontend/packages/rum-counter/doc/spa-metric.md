# RUM SPA Manager

Модуль `dist/bundle/spa-metric.js`.

## Мотивация
Хочется иметь возможность измерять скорость загрузки не только основной страницы, но и SPA-переходов.

В связи с этим создали данный модуль, который позволяет собрать данные о скорости загрузки и отрисовки SPA-страниц или любых других больших кусков верстки, которые догружаются в процессе жизни приложения.

## API модуля
В RUM появляется объект `spa`, который содержит 7 функций логирования этапов SPA-перехода:
- `makeSpaSubPage` - создает подстраницу с заданным именем. Принимает параметры:
    - `subPageName` - наименование подстраницы;
    - `options` - конфиг отправки метрик для этой подстраницы (описан в пункте Отправляемые метрики и конфигурация их отправки). Имеет дефолтное значение;
    - `isBlock` - флаг, влияющий на полное наименование подстраницы (`true` - название подстраницы будет начинаться с block, `false` - c `page`). В будущем префикс названия подстраницы будет влиять на то, учитываются ли метрики данной подстраницы при подсчете средней скорости SPA-переходов сервиса (`page` - учитывается, `block` - нет). Значение по умолчанию - `false`.
    - `shouldFinalizePageMetrics` - флаг, влияющий на то, будут ли финализированы комулятивные метрики (`traffic`, `LCP`, `CLS`). Значение по умолчанию - `false`.
    - `params` - список дополнительных параметров, которые можно прокинуть в подстраницу, чтобы уточнить информацию об окружении.
- `startDataLoading` - для последней созданной подстраницы с заданным именем отправляет время начала загрузки данных. Принимает параметры:
    - `subPageName` - наименование подстраницы;
- `finishDataLoading` - для последней созданной подстраницы с заданным именем отправляет время окончания загрузки данных. Принимает параметры:
    - `subPageName` - наименование подстраницы;
    - `isCachedData` - были данные запрошены по сети или взяты из кеша/локального хранилища (по умолчанию `false`);
- `startStubRendering` - для последней созданной подстраницы с заданным именем отправляет время начала отрисовки стаба, а также время конца отрисовки (регулируется флагом). Принимает параметры
    - `subPageName` - наименование подстраницы;
    - `shouldCallFinishStubRendering` - нужно ли вызывать отправку окончания рендеринга из этой же функции (значение по умолчанию - `true`);
- `finishStubRendering` - для последней созданной подстраницы с заданным именем отправляет время окончания отрисовки стаба (вызов не обязателен, по умолчанию вызывается из `startStubRendering` автоматически); Принимает параметры:
    - `subPageName` - наименование подстраницы;
- `startDataRendering` - для последней созданной подстраницы с заданным именем отправляет метрики рендеринга. Принимает параметры:
    - `subPageName` - наименование подстраницы;
    - `renderType` - опционально добавляет префикс к отправляемой метрике. Значение по умолчанию - `''`.
    - `shouldCallFinishDataRendering` - определяет надо ли вызывать метод отправки `finishDataRendering` внутри данной функции или пользователь хочет позвать ее самостоятельно. Значение по умолчанию - `true`.
    - `animationCheckTime` - имеет смысл только в случае вызова `finishDataRendering` внутри данной функции. Определяет длительность в миллисекундах замера частоты отрисовки после рендеринга. Значение по умолчанию - `1000`.
- `finishDataRendering` - для последней созданной подстраницы с заданным именем отправляет метрику окончания рендеринга. Принимает параметры:
    - `subPageName` - наименование подстраницы;
    - `renderType` - опционально добавляет префикс к отправляемой метрике. Значение по умолчанию - `''`.
    - `animationCheckTime` -  определяет длительность в миллисекундах замера частоты отрисовки после рендеринга. Значение по умолчанию - `1000`.

## Порядок вызова функций из API модуля
__Порядок вызова функций для каждой подстраницы строго определенный.
Ответственность за соблюдение данного порядка лежит полностью на пользователе модуля.__

### Ожидаемый порядок вызова
Минимальный набор вызываемых функций:
```js
// Пользователь нажал на кнопку, которая открывает попап/делает SPA-переход. Приложение тут же начинает поход по сети за данными.
window.Ya.Rum.spa.makeSpaSubPage('main-feed');

// Приложение завершает поход по сети за данными.
window.Ya.Rum.spa.finishDataLoading('main-feed');

// Приложение начинает отрисовку полученных данных.
window.Ya.Rum.spa.startDataRendering('main-feed');
```
Максимальный набор вызываемых функций:
```js
window.Ya.Rum.spa.makeSpaSubPage('main-feed');

window.Ya.Rum.spa.startStubRendering('main-feed', false); // Второй параметр указывает на ручной вызов finishStubRendering
window.Ya.Rum.spa.finishStubRendering('main-feed');

window.Ya.Rum.spa.startDataLoading('main-feed');
window.Ya.Rum.spa.finishDataLoading('main-feed');

window.Ya.Rum.spa.startDataRendering('main-feed', 'multi', false); // Второй параметр указывает на ручной вызов finishDataRendering
window.Ya.Rum.spa.finishDataRendering('main-feed');
```

Опционален вызов функции `startDataLoading`. В случае, если момент создания подстраницы и момент начала получения данных совпадают,
нет необходимости вызывать `makeSpaSubPage` и `startDataLoading` подряд.
Если собираетесь не вызывать функцию `startDataLoading` - в `options` необходимо не задавать `startDataLoadingMetric` (Подробнее про `options` в следующем разделе)

Невызов функции `startDataLoading` приведет к:
1. Функция `finishDataLoading` будет вести отсчет своих метрик от момента создания страницы.
2. Вызов функции `finishDataLoading` будет писать ошибку в консоль в случае если в `options` прописано `startDataLoadingMetric = true` (Ошибка не повлияет на отправку метрики окончания загрузки данных)

Опционален вызов функции `finishDataRendering`. В случае, если в `startDataRendering` не переопределялся параметр `shouldCallFinishDataRendering` она сама вызовет `finishDataRendering` в следующем фрейме.

Опционален вызов функций `startStubRendering` и `finishStubRendering`.
Если всё же стабы есть и их отрисовку хочется замерять, то существует 2 варианта вызова этих функций (как и с рендерингом данных):
вызвать только `startStubRendering` и позволить ей позвать `finishStubRendering` через requestAnimationFrame
или вызвать обе функции в нужное вам время.

### Что произойдет в случае нарушения порядка вызова

#### Не вызван `makeSpaSubPage`
Произойдет полная анархия. Если ранее подстраница с таким именем создавалась и при этом её отрисовка, не была завершена, то в одну подстраницу нашлется куча метрик одного и того же типа.
Иначе будет падать ошибка и метрики слаться не будут.

#### Не вызван `startDataLoading`
Вызов данной функции опционален. В случае, если момент создания подстраницы и момент начала получения данных совпадают,
нет необходимости вызывать `makeSpaSubPage` и `startDataLoading` подряд.
Если собираетесь не вызывать функцию `startDataLoading` - в `options` необходимо не задавать `startDataLoadingMetric` (Подробнее про `options` в следующем разделе)

Невызов функции `startDataLoading` приведет к:
1. Функция `finishDataLoading` будет вести отсчет своих метрик от момента создания страницы.
2. Вызов функции `finishDataLoading` будет писать ошибку в консоль в случае если в `options` прописано `startDataLoadingMetric = 'timemark'` (Ошибка не повлияет на отправку метрики окончания загрузки данных)

#### Не вызван `finishDataLoading`
Приведет к ошибке на этапе вызова `startDataRendering` ни одна из метрик про рендеринг отправлена не будет.

#### Не вызван `startDataRendering`
Всё будет хорошо:)

#### Не вызван `finishDataRendering`
Вызов данной функции опционален. Но даже при `shouldCallFinishDataRendering=false` для `startDataRendering` невызов данной функции не приведет ни к каким последствиям.

## Отправляемые метрики и конфигурация их отправки (параметр `options`)
После создания SPA-страницы появляется возможность отправить 8 метрик, для отправки каждой из них вызываются определенные функции из модуля:
1. Функция `startDataLoading` отправляет
    1. время начала получения данных
1. Функция `finishDataLoading` отправляет
    1. дельту между началом и окончанием получения данных (или если метод `startDataLoading` не вызван - дельту между временем создания подстраницы и концом получения данных)
1. Функция `startStubRendering` отправляет
    1. время начала отрисовки стабов
    2. время окончания отрисовки стабов (опционально)
1. Функция `finishStubRendering` отправляет
    1. дельту между началом и окончанием отрисовки стабов (или если метод `startStubRendering` не вызван - дельту между временем создания подстраницы и концом получения данных)
1. Функция `startDataRendering` отправляет
    1. дельту между окончанием получения данных и началом отрисовки
    1. дельту между началом и окончанием отрисовки данных (опционально)
    1. среднее время между кадрами сразу после окончания отрисовки (опционально)
    1. медианное время между кадрами сразу после окончания отрисовки (опционально)
1. Функция `finishDataRendering` отправляет
    1. дельту между началом и окончанием отрисовки данных
    1. среднее время между кадрами сразу после окончания отрисовки
    1. медианное время между кадрами сразу после окончания отрисовки

Пользователь модуля может конфигурировать, какие метрики он хочет отправлять.
```typescript
type Options = {
    startDataLoadingMetric?: boolean;
    finishDataLoadingMetric?: boolean;
    startStubRenderingMetric?: boolean;
    finishStubRenderingMetric?: boolean;
    startDataRenderingMetric?: boolean;
    finishDataRenderingMetric?: boolean;
    animationSpeedMetric?: boolean;
};
```

А может не конфигурировать, тогда применится дефолтное значение конфига:
```js
options = {
    finishDataLoadingMetric: true,
    startDataRenderingMetric: true,
    finishDataRenderingMetric: true,
};
```

## Отправка дополнительных метрик в SPA-подстраницу
Созданную модулем подстраницу можно использовать для отправки дополнительных delta и timemark.
Для того, чтобы совершить отправку метрики, закрепив ее за конкретной подстраницей, необходимо воспользоваться функцией
`window.Ya.Rum.spa.getLastSpaSubPage('main-feed')`, которая вернет последнюю созданную подстраницу с переданным наименованием.

Далее кастомные метрики можно слать в обычном порядке:
```js
const subpage = window.Ya.Rum.spa.getLastSpaSubPage('main-feed');

window.Ya.Rum.sendDelta('additional-delta', 12345, subpage);
window.Ya.Rum.sendTimeMark('additional-time-mark', 12345, true, subpage);
```
