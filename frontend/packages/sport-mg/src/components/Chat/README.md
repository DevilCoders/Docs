## Описание работы шторки для компонента комментариев

### Открытие шторки

Шторка с комментариями может открываться тремя разными способами:
- из сюжета (по клику на бабл)
- из рубрики или главного, из поиска (по клику на бабл) 
- нажатие на аппаратный forward 


1. При открытии комментариев в сюжете баблик выставляет `id` комментариев в глобальный контекст.
Компонент чатов добавляет запись в историю и `id` комментариев в  `history.state`, открывает шторку. Так же 
в url добавляется `comments=1`

2. Открытие из рубрики/главного/поиска происходит аналогично. Но пользователь, открывший сюжет с открытыми 
комментариями, должен остаться в сюжете при закрытии шторки. Для этого подменяем историю, удаляя параметр
`comments=1` из урла и добавляем ещё одну запись в историю. Глобальный контекст при этом уже инициалирован `Id` чата при открытии страницы. 

3. При открытии шторки по аппаратному forward, происходит событие `popstate`. 
Чаты достают `id` открытого чата из `histrory.state`, инициализируя комментарии. 
Сменяем `modalMode` на `open`.
В урле уже содержится `comments=1`
 
В таблице представлены параметры, с которыми открываются чаты (входные данные для компонента Chat)

| Параметры/ открытие | В сюжете по клику на бабл | Перешёл из ленты или по урлу с comments=1 (колокольчик) | аппаратный froward | 
| ------ | ------ | ------ | ------ |
| mode | closed | closed | closed |
| comments (query) | - | 1 | 1 |
| history.state | { ...state } | { ...state } | { cmntId: 1, ...state } |  

Ниже в таблице состояние компонента чата, которое
должно быть после инициализации комментариев и открытия шторки

| Параметры/ значение | | 
| ------ | --- |
| mode | open |
| comments (query) | comments=1 |
| history.state | { cmntId: 1, ...state } |  

------
### Закрытие шторки

Шторка с комментариями может закрываться:
- по нажатию на аппаратный back
- по свайпу (клик на стрелку вниз)

1. По нажатию на аппаратный back ловим событие `popstate`. Удаляем `id` комментариев 
 из глобального контекста. Меняем `modalMode` на `closed`.
2. Если закрыли по свайпу (по стрелке вниз), вызываем `history.back`.  

Закрытие чатов:

| Параметры / закрытие | По свайпу | аппаратный back | 
| ------ | ------ | ------ |
| mode | closed | open |
| comments (query) | 1 | - |
| history.state | { cmntId: 1, ...state } | { ...state } |

Состояние при закрытой шторке:

| Параметры / значение |  | 
| ------ |---  |
| mode | closed |
| comments (query) | - |
| history.state | { ...state } |

### Известные проблемы

#### Десктоп

1. Для отображения чатов используется компонент [Modal](https://lego-docs.s3.mds.yandex.net/story/dev/index.html?path=/docsx/lego-components-modal-desktop--playground) из библиотеки лего.
Он встраивается в страницу посердством ReactDOM.createPortal, но при первом рендеринге возвращает null, вместо children. Таким образом,
компоненты проброшенные в Modal в качестве потомков рендерятся только при открытии модального окна.
А компонент Chats должен инициализироваться при открытии страницы - как раз он отвечает за открытие модального окна. 

    **Решение:**
   
   Вся бизнес-логика отвечающая за открытие/закрытие модального окна, инициализацию чатов 
   вынесена в отдельный компонент ChatController рендерится в корне приложения. 
   Компонент Chat на десктопе отвечает только за представление комментариев в модальном окне.
   


