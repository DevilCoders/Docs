# beta-cleaner

Пакет одной команды. Нужен для удаления лишних бет, развернутых для пулл-реквестов

## Использование

Есть 2 варианта использования:
- из консоли
- регулярной таской в sandbox, готовить проще, если вы живете во фронтовой монорепе

### Запуск из консоли

**Опции**
- project - имя проекта из Y.Deploy, взять можно [со страницы стенда](https://jing.yandex-team.ru/files/poalrom/2021-04-26T16%3A52%3A43Z.png). Регистрозависимо!
- arcToken - OAuth токен для Arc. [Брать здесь](https://a.yandex-team.ru/api/token)
- path - путь от корня аркадии до вашего проекта, нужен для получения только ваших PR. Со слешом в начале, например `/frontend/services/goals`
- regexp - регулярное выражение для поиска стендов для PR среди всех окружений. Должно содержать одну capture group, которая матчится на номер pr в имени стенда. Например `tools_goals_pr-(\d+)`
- dry - флаг для запуска всего процесса без удаления стендов. Выводит таблицу со списком стендов для удаления и их PR'ов
- deployConfig - путь до deploy конфига для пакета [frontend.ci.deploy](../frontend.ci.deploy/README.md)

### Регулярная sandbox таска

1. Склонировать себе [шедулер](https://sandbox.yandex-team.ru/scheduler/45217)
2. Заменить тег GOALS на тег своего проекта, чтобы легче искать шедулер и таски
3. Заменить переменные окружения
   1. BETA_CLEANER_PROJECT - как для опции project
   2. BETA_CLEANER_PATH - как для опции path
   3. BETA_CLEANER_REGEXP - как для опции regexp
   4. BETA_CLEANER_CONFIG - как для опции deployConfig, от корневой папки вашего проекта
   5. BETA_CLEANER_DRY - true
4. Сделать пробный запуск таски, проверить, что в логах записаны только те беты, которые должны удалиться
5. Убрать из шедулера переменную окружения BETA_CLEANER_DRY
6. Запустить шедулер, лучше всего раз в день, чтобы чистить за ночным погонятором
