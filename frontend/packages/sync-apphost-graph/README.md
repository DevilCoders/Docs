# @yandex-int/sync-apphost-graph

## Что это?

Утилита для синхронизации тестового и продового графа аппхоста

Чуть подробнее: При разработке под аппхостом формат графа который используется котиком для локальной разработке немного отличается от формата в котором этот же граф представлен в конфигурации аппхостовой вертикали. Утилита решает проблему синхронизации жтих двух графов. Подобный функционал также есть в интерфейса Хорайзена, но к сожалению он имеет ряд недостатков (например, невозможность отредактировать файл перед открытием PR)

## Как пользоваться?

### 1. Описываем конфиг

Создать конфиг `.sync-apphost-graph.json` в корневой папке проекта. Название и путь может быть другим, но в таком случае путь нужно будет указать аргументом `sync-apphost-graph <path-to-config>`

Пример конфига:

```json
{
    "graphs": {
        "testing": "frontend/services/user-id/graphs/testing.json",
        "vertical": "apphost/conf/verticals/LEGO/userid.json"
    }
}
```
Все пути в конфиге должны быть относительно корневой папки аркадии.

По умолчанию утилита попытается определить отступы из конфига вертикали. Но есть возможность переопредилить отступ указав его явно в кофниге

```json
{
    "indent": "  "
}
```

Также есть возможность задать в конфиге маппинг имен бэкендов. Может быть полезно если бэкенды тестового графа отличаются от продовых. 
Имена бэкендов для который маппинг неопределен останутся нетронутыми

```json
{
    "backendsMap": {
        "LEGO__RENDERER_USER_ID_RC": "RENDERER_USER_ID"
    }
}
```

### 2. Запускаем

```bash
npm_config_registry=https://npm.yandex-team.ru npx sync-apphost-graph
```

## Как работает?

Под капотом используется `@yandex-int/horizon-client`, он отвечает за парсинг тестового графа. Для конвертации в формат вертикали используется самописный "сериализатор" протобафов аппхоста. В случае необходимости добавить какие-то поля (сейчас синхронизируется лишь сабсет полей конфига) приносить PR придется как и в `@yandex-int/sync-apphost-graph` так и в `@yandex-int/horizon-client`.

## Поддержка

Если у вас возникли вопросы и предложения по пакету, пишите команде [Лего](https://abc.yandex-team.ru/services/lego2/)
