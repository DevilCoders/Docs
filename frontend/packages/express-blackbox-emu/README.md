# express-blackbox-emu

Данная мидлварь позволяет аутентифицировать облачных федеративных пользователей (неимеющих паспортных учеток). Ответ мидлвари идентичен ответу `express-blackbox`, но при авторизации облачного пользователя в ответе появляется свойство `isCloudAuth`. Эту мидлварь можно использовать вместо `express-blackbox`, поскольку, если передать параметр `useOriginalExpressBlackbox = true`, то она вернет оригинальный `express-blackbox`. Если же работа осуществляется черех эмулятор блекбокса, то нельзя использовать метод `oauth`, так как эмулятор поддерживает только метод `sessionid`. Мидлварь содержит ряд своих опций помимо тех, что она передает в `express-blackbox`.

## Опции:
- **`apiEmu`**: хост облачного эмуятора blackbox (например, `https://bb.private-api.cloud-preprod.yandex.net:8654`)
- **`cloudConsoleHost`**: хост консоли облака (например, `console-preprod.cloud.yandex.ru`)
- **`cloudApiIamHost`**: хост iam api облака (например, `iam.api.cloud-preprod.yandex.net`)
- **`cloudApiOauthHost`**: хост oauth api облака (например, `oauth.private-api.cloud-preprod.yandex.net:8655`)
- **`cloudClientId`**: clientId вашего сервиса для облака (запрашивается у разработчиков облака)
- **`cloudClientPassword`**: пароль вашего сервиса для аутентификации в консоли облака (запрашивается у разработчиков облака)
- **`yandexInternalRootCAPath`**: путь к файлу корневого сертификата (например, `/usr/local/share/ca-certificates/YandexInternalRootCA.crt`)
- **`cloudServiceAccountId`**: id сервисного аккаунта облака (как создать сервисный аккаунт https://cloud.yandex.ru/docs/iam/operations/sa/create)
- **`cloudServiceAccountKeyId`**: id авторизованного ключа сервисного акаунта облака (как создать авторизованный ключ https://cloud.yandex.ru/docs/iam/operations/authorized-key/create)
- **`cloudServiceAccountKeyPem`**: авторизванный ключ (private) сервисного акаунта облака в формате .pem (например, `-----BEGIN PRIVATE KEY-----\n<закрытый ключ>\n-----END PRIVATE KEY-----`)
- **`cloudPayloadAudHost`**: хост, который будет указываться в payload при запросе iam-token. В идеале этот хост должен совпадать с `cloudApiIamHost`, но на текущий момент для препрода здесь нужно указывать продовый хост `iam.api.cloud.yandex.net`. Это не обязательный параметр. Если он не указан, то вместо него берется `cloudApiIamHost`.
- **`authCallbackPath`**: url-путь на вашем сервисе, на который облако будет редиректить пользователя для завершения аутентификации и выставления сервисной куки. Все эти действия также выполняются в данной мидлваре, ваш сервис должен не блокировать запросы на заданный url. Например `/cloud_auth_callback`. Важно! Данный пусть необходимо зарегестрировать на стороне облака (делается через разработчиков облака), иначе облако на него не будет редиректить пользователей.
- **`authFederationPath`**: url-путь на вашем сервисе, при заходе на который будет выполняться принудительная аутентификация федеративного пользователя через облако. Эти действия выполняются в данной мидлваре, ваш сервис должен не блокировать запросы на заданный url. Это не обязательный параметр. Например `/auth/federation`. Так же мидлварь потом позволяет обращаться к данному урлу с указанием id федерации. Для приведенного примера url будет выглядеть так `/auth/federation/bfbvsft0054prhkkodrs`.

## Принцип работы:
Общее описание схемы аутентификации https://wiki.yandex-team.ru/cloud/iamrm/services/API-autentifikacii-Oblaka/?API-autentifikacii-Oblaka#obshhajamexanika

Когда пользователь заходи на url сервиса, мидлварь проверяет, есть ли у него кука `yc_session`, если нет, то мидлварь фолбечится на `express-blackbox`. Если кука есть, то мидлварь проверяет пользователя через облачный эмулятор блекбокса. Если все ок, то мидлварь завершает работу предоставив данные о пользователе в том же формате, что и `express-blackbox`. Если в процессе аутентификации облаку понадобиться установить или обновить сессионную куку для пользователя на вашем сервисе, то оно средиректит пользователя на `authCallbackPath`, передав в этот url необходимые параметры для мидлвари, чтоб она смогла выставить нужную куку. После этого мидлварь редиректит пользователя на изначальную страницу входа на ваш сервис.

Путь `authFederationPath` нужен для принудительной аутентификации через эмулятор, так как если на ваш сервис заходит человек вообще без кук, то нельзя определить федеративный он или паспортный и по умолчанию его редиректит на паспорт. Данный url принудительно проводит аутентификацию через эмулятор блекбокса, после чего у пользователя уже будет проставлена нужная кука и на эту ссылку ему заходить уже не нужно.
