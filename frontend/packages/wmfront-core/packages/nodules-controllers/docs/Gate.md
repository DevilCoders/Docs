# Gate

Базовый контроллер гейта (обработчика AJAX-запросов).

* Родитель: [Controller](Controller.md)

## API

### Статические свойства

#### GateError

Класс ошибок. Наследник [`Controller.ControllerError`](Controller.md#controllererror).

Коды ошибок:

* `UNEXPECTED_ERROR` — используется в качетсве кода ответа пользователю, если в цепочку `after` пришла ошибка,
а гейты не находятся в состоянии отладки (в режиме отладки на клиент будет передана оригинальная ошибка);
* `UNEXPECTED_RESULT` — используется в качестве кода ответа клиенту, если в цепочку `after` пришел результат
выполнения действия `null` без сопутствующей ошибки;
* `CAN_NOT_SERIALIZE_RESULT` — используется в качестве кода ответа клиенту, если не удалось сериализовать
результат выполнения действия, который пришел в `after`;
* `INVALID_SIGNATURE` — см. [`Gate#validateSignature()`](#validatesignature);
* `METHOD_NOT_IMPLEMENTED` — исключение возникает, если абстрактные методы гейта не переопределены.

#### SIGNATURE_PARAM_NAME

`{String} SIGNATURE_PARAM_NAME = 'crc'`

Имя параметра запроса, где содержится подпись запроса, если запрос подписан.

#### action()

`action(descriptor) → this`

Расширяет [`Controller.action()`](Controller.md#action) опцией `signed`:

* `{Boolean} [descriptor.signed=true]` — флаг необходимости проверки подписи запроса перед выполнением действия.

Возвращает `this`.

#### setVersion()

`setVersion(version) → this`

* `{String|null} [version]` — версия гейта.

Устанавливает версию гейта. По-умолчанию версия `null`. Если версия гейта `null`,
то проверка соответствия версий клиента и гейта будет всегда выполняться успешно.

Проверка версии клиента происходит в цепочке `after` и, если версии клиента и гейта определены и расходятся,
в JSON-ответ гейта будет добавлен «[refresh tag](#setrefreshtag)».

Возвращает `this`.

### Свойства прототипа

#### isActionMustBeSigned()

`isActionMustBeSigned(actionName) → {Boolean}`

Возвращает `true`, если запрос действия `actionName` должен быть подписан клиентом.

Использует внутри цепочки `before` для принятия решения о необходимости проверки подписи запроса.

#### validateSignature()

`validateSignature(signature) → {Boolean}`

> Абстрактный метод

Метод должен быть реализован наследником.

Метод должен возвращать результат проверки подиси запроса, переданной первым аргументом.

Результат выполнения метода: `true`, если подпись принята; `false` — если нет.

Если метод вернул для подписи `false`, то метод действия вызван не будет, а управление будет передано
в цепочку `after` с ошибкой `GateError { code: INVALID_SIGNATURE }`. Клиент получит ответ с кодом ошибки `UNEXPECTED_ERROR`.

#### isClientUpToDate()

`isClientUpToDate() → {Boolean}`

Возвращает `false` только в случае, если гейту установлена версия, клиент передал поддерживаемую версию гейта в параметре `version` запроса,
и эти значения версий не равны. Во всех остальных случаях вернет `true` (в том числе, если гейту не установлена версия, или клиент не передал
параметр `version`).

Метод используется в цепочке `after`, и, если он вернет `false`, то в JSON-ответ гейта будет добавлен «[refresh tag](#setrefreshtag)»

#### createRawResponse()

`createRawResponse(response) → {Boolean}`

Оборачивает `response` так, чтобы в обработчике `after` не происходило преобразование ответа и `response` был записан в `Controller#res` как есть.

Пример:
```javascript
MyGate.action({ name : 'ping', fn : function() {
    this.res.setHeader('content-type', 'text/text');

    return this.createRawResponse('pong');
});
```

Ответом такого действия гейта будет строка `"pong"`, а не JSON `{ "response": "pong" }`.

Метод возвращает объект, который не стоит модифицировать, а вернуть из метода действия как есть.

#### pushTask()

`pushTask(name, options) → {Gate}`

* `{String} name` — название задачи;
* `{*} [options]` — параметры задачи (не обязательно).

Если в процессе выполнения гейта добавлена хотя бы одна задача, то в объекте ответа будет
поле `tasks`, содержащее массив объектов `{ name : <name>, options: <options> }`.

При ошибке сериализации (например, при наличии циклических ссылок в `options`) поле добавлено не будет.

Возвращает `this`.

