## Описание
**user** – блок пользователя, расположенный в правой части шапки страницы.

Блок пользователя, авторизованного любым доступным способом (логин/пароль, [социальная авторизация](https://wiki.yandex-team.ru/passport/social/about)), может состоять из:

* [имени авторизованного пользователя](#uname);
* [иконки пользователя (аватарки)](#uicon);
* [выпадающего меню пользователя](#umenu_yes);
* [выпадающего меню пользователя с мультиавторизацией](#umenu_multiauth);
* [нотификационной панели](#np). 

Блок неавторизованного пользователя состоит из кнопки «Войти», для авторизации на Яндексе.

Блок позволяет [скрывать пункты](#hide_item) выпадающего меню.

## Техническое описание
### Элементы блока
#### enter: кнопка «Войти»

---
**NB** В islands 4.х `enter` и `enter-icon` (на `touch-phone`-уровне) стали необязательными. 

_При использовании опциональных элементов необходимо нужные подключить в зависимости блока_.

---

Отображается для неавторизованного пользователя(если не переданы ни `login`, ни `this['i-global'].displayName.name`, ни `this['i-global'].login`), вместо имени и/или аватарки.
При нажатии кнопки появляется блок [domik](../domik/domik.ru.md) c формой авторизации.

В коде элемента формируется нужный BEMJSON Домика, в зависимости от заданных значений [JS-параметров](#jsdomik) блока `user` для блока `domik` – `domikMods` и `domikJs`.

На `touch-phone`-уровне вместо элемента `enter` выводится элемент `enter-icon` – иконка с всплывающей подсказкой. 

Надпись на кнопке и текст всплывающей подсказки локализуются автоматически.

<a name="uname"></a>
#### name: имя пользователя
Необязательный элемент. HTML-тег: `<span>`. <br>
_При использовании подключите элемент в зависимости блока_.


Элемент предназначен для отображения имени пользователя. Возможные источники для значения (в порядке уменьшения приоритета):
 
* `[user__name]this.ctx.content`
* `[user__name]this.ctx.login`
* `[user]this.ctx.login` (заданный на уровне блока `user`)
* `this['i-global'].displayName.name`
* `this['i-global'].login` (значение по умолчанию) 

```js
[{
    block: 'i-global',
    params: {
        login: 'someLogin'
    }
},
{
    block: 'user',
    mods: {menu: 'yes'},
    js: {mail: 101, uid: '84473936'},
    content: {elem: 'name'}
}]
```

<a name="jsname"></a>

Имя оформлено жирным черным текстом, первая буква – красного цвета (в стиле Яндекса).
Перед попаданием в результирующий HTML, конечное представление имени формируется методом `cleverSubstring` из [i-common__string](../i-common/i-common.ru.md). Максимальная длина имени и погрешность длины определяются значениями полей `maxLength` и `maxLengthRelative`. По умолчанию максимальная длина составляет 16 символов, погрешность – 3. При превышении указанных ограничений лишние символы заменяются троеточием.

```javascript
{
    block: 'user',
    content: {
        elem: 'name',
        login: 'Василий Тёркин',
        maxLength: 15,
        maxLengthRelative: 0
    }
}
```

Имя пользователя может быть ссылкой, адрес которой формируется исходя из способа регистрации пользователя:

* с социальной регистрацией: `social-host` – хост Брокера.
* с регистрацией на Яндекс: `passport-host` + `/passport?mode=passport`.

`social-host`, `passport-host` – глобальные параметры из блока `i-global`.

---
**NB** Для телефонов (`touch-phone`-уровень) имя пользователя по умолчанию не отображается.
Пользователь может самостоятельно настроить его показ в интерфейсе.

---

##### Имя пользователя при социальной авторизации
В блоке `user` выполняется проверка на наличие логина. Если логин пуст, вместо содержимого блока пользователя отображается кнопка «Войти».

Для социального аккаунта после регистрации в [Паспорте](http://doc.yandex-team.ru/Passport/AuthDevGuide/concepts/about.xml) генерируется случайный логин с префиксом `uid-*` (значение параметра `i-global.login`) для обратной совместимости. Но формально логин считается отсутствующим и возвращается пустым. Поэтому для социально авторизованного пользователя содержимое блока не выводится.

Чтобы была возможность разрешить эту ситуацию и пробросить параметр для получения имени пользователя на клиенте, в JS-параметрах блока `user` передается флаг `isUglyUserName:true`.   

**NB** У аккаунта, вне зависимости от типа, существует параметр `displayName` для отображения имени пользователя в интерфейсе. Значение для него следует запрашивать с помощью аргумента `regname` одного из методов [Черного ящика](http://doc.yandex-team.ru/blackbox/concepts/about.xml). Но в данной реализации  блока `user` – `regname` не задействован. Поэтому значение для `displayName` не возвращается.

<a name="uicon"></a>
#### icon: аватарка пользователя

Необязательный элемент. HTML-тег: `<span>`. <br>
_При использовании подключите элемент в зависимости блока_.


Аватарка – картинка авторизованного пользователя, которая устанавливается в [Паспорте](https://passport.yandex.ru/passport?mode=changeavatar) (может быть анимированной).
Если у пользователя отсутствует аватарка, возвращается стандартная картинка-заглушка.

Аватарки хранятся в [Аватарнице](https://wiki.yandex-team.ru/Jaru/Avatarnica).
Домен, с которого запрашиваются аватарки, определяется модой `host` в шаблонах и задается в JS-параметре блока `avatarHost`. Значение по умолчанию: `//avatars.mds.yandex.net`.

На странице аватарка отображается круглой формы для всех современных браузеров. В MSIE ниже 9 версии – деградирует до квадратной. 

Размер аватарки (в том числе – картинки-заглушки) зависит от разрешения экрана и устройства. Для уровня `desktop` и `touch-pad` размер аватарки составляет `42x42` px. Для уровня `touch-phone` – `28x28` px.

Изображение аватарки задается через свойство `background-image`. Путь к изображению формируется из следующих параметров: домена Аватарницы, идентификатор аватарки (берётся из поля `[i-global][displayName][default_avatar]`, разрешение экрана и устройства.

Также аватарка отображается при отключенном JavaScript на клиенте. При клике по аватарке произойдет переход на [Яндекс.Паспорт](https://passport.yandex.ru). 

Чтобы у авторизованного пользователя появилась аватарка, нужно задать [uid](http://doc.yandex-team.ru/Passport/AuthDevGuide/concepts/Account_About.xml) и добавить в `content` блока элемент `icon`.

Возможные источники `uid`(в порядке уменьшения приоритета):
* js параметр `uid`
* BEMJSON параметр `uid`
* `this['i-global'].uid` (значение по умолчанию) 

Возможные источники идентификатора аватарки (в порядке уменьшения приоритета):
* js параметр `avatarId`
* `this['i-global'].displayName['default_avatar']` (значение по умолчанию)

```js
[{
    block: 'i-global',
    params: {
        login: 'lego-team',
        uid: '4001140776',
        displayName: {
            'default_avatar': '1450/4001140776-39966'
        }
    }
},
{
    block: 'user',
    js: {
        uid: '84473936',
        avatarHost: '//avatars.mdst.yandex.net'
    },
    content: [
        {elem: 'icon'},
        {elem: 'name'}
    ]
}]
```

Параметр `uid` может быть передан через BEMJSON:

```javascript
{
    block: 'user',
    uid: '103020150',
    content: [
        {elem: 'icon'}
    ]
}
```
Так же `uid` можно передать через блок `i-global` (если на проекте используется Ромочка 2.10.22 и выше):
 
```javascript
{
    block: 'i-global',
    params: {
        login: 'petrov',
        uid: '103020150'
    }
}
```

#### ticker: счетчик уведомлений
Необязательный элемент.  
Блок [ticker](../ticker/ticker.ru.md) внутри блока `user`. Счетчик уведомлений, отображается около аватарки авторизованного пользователя. 

Чтобы появился счетчик уведомлений, нужно поместить элемент `ticker` в `content` блока пользователя. Значение счетчика, задается в поле элемента – `count`. Отобразится он только в том случае, если значение в `count` превышает `0`.

```js
[{
    block: 'i-global',
    params: {
        login: 'yet.another.login',
        uid: '84473936',
        displayName: {
            'default_avatar': '1450/4001140776-39966'
        }
    }
},
{
    block: 'user',
    js: true,
    mods: {menu: 'yes'},
    attrs: {
        style: 'margin-left: 150px'
    },
    content: [
        {elem: 'icon'},
        {elem: 'name'},
        {
          elem: 'ticker',
          count: 7
        }
    ]
}]
```

Максимальное отображаемое число сообщений пользователя – `maxCount` (поле элемента `ticker`). Значение по умолчанию – `99`.
Если число новых сообщений больше максимального, то отобразится `maxCount+` (`99+`). 

### Модификаторы блока

<a name="umenu_yes"></a>
#### Меню пользователя `menu_yes`

Необязательный модификатор.  

Модификатор `menu` в значении `yes` добавляет выпадающее меню пользователя со ссылками на различные сервисы, настройку профиля и выход. 

При установке модификатора выполняются BEMHTML-преобразования, в результате которых, блок `user` оборачивается в блок [dropdown-menu](../dropdown-menu/dropdown-menu.ru.md) с выпадающим меню снизу (блок [popup](../popup/popup.ru.md)). 

По умолчанию меню авторизованного пользователя формируется в BEMHTML-шаблоне блока, в котором зафиксированы пункты меню и порядок их следования (в скобках указан тип `type` элемента меню `item` в `dropdown-menu`):

* Почта (`mail`)
* Написать письмо (`mailCompose`)
* Диск (`disk`)
* Настройки (`tune`)
* Паспорт (`passport`)
* Выход (`logout`)

Пример добавления меню пользователя:

```js
[{
    block: 'i-global',
    params: {
        login: 'yet.another.login',
        displayName: {
            'default_avatar': '1450/4001140776-39966'
        }
    }
},
{
    block: 'user',
    js: {
        mail: 101,
        uid: '84473936',
        avatarHost: '//avatars.mdst.yandex.net'
    },
    mods: {menu: 'yes'},
    attrs: {
        style: 'margin-left: 150px'
    },
    content: [
        {elem: 'icon'},
        {elem: 'name'}
    ]
}]
```

<a name="hide_item"></a>
Чтобы **скрыть некоторые пункты меню**, нужно на своем проектном уровне в шаблоне модификатора [menu](../../common.blocks/user/_menu/user_menu_yes.bemhtml.js) добавить соответствующую функцию для фильтра.

Скрыть один пункт меню, например, «Почту»:

```javascript
block('user')
    .mod('menu', 'yes')
    .mode('user-menu')(function() {
        return applyNext().filter(function(item) {
            return item.type !== 'mail';
        });
});
```

Скрыть несколько пунктов меню, например, «Почту» и «Диск»:

```javascript
block('user')
    .mod('menu', 'yes')
    .mode('user-menu')(function() {
        return applyNext().filter(function(item) {
            return ['mail', 'disk'].indexOf(item.type) === -1;
        });
});
```

<a name="umenu_multiauth"></a>
#### Меню пользователя с мультиавторизацией `menu_multiauth`

Необязательный модификатор.

Модификатор `menu` в значении `multiauth` добавляет выпадающее меню пользователя с мультиавторизацией.

Выпадающее меню повторяет особенности меню с [модификатором menu в значении yes](#umenu_yes).

По умолчанию выпадающее меню с мультиавторизацией состоит из следующих пунктов (обязательные – отмечены «*»):

* Почта (`mail`)
* Написать письмо (`mailCompose`)
* Загрузить файлы (`disk`)
* Настройки (`tune`)
* Паспорт (`passport`) *
* Имя авторизованного пользователя с аватаркой *
* Добавить пользователя *
* Редактировать список *
* Выйти (`logout`) *

Чтобы **скрыть необязательные пункты меню**, которые не используются сервисом, воспользуйтесь способом описанным в разделе [Меню пользователя](#hide-item).

Пример добавления меню пользователя с мультиавторизацией:

```js
[{
    block: 'i-global',
    params: {
        login: 'someLogin',
        displayName: {
            'default_avatar': '1450/4001140776-39966'
        }
    }
},
{
    block: 'user',
    js: {
        mail: 101,
        uid: '84473936',
        avatarHost: '//avatars.mdst.yandex.net'
    },
    mods: {menu: 'multiauth'},
    content: {elem: 'icon'},
    attrs: {
        style: 'margin-left: 150px'
    }
}]
```

#### Скрыть имя пользователя при сворачивании блока `hide-name`

Необязательный модификатор.  

Модификатор `hide-name` в значении `yes` скрывает имя пользователя при сворачивании блока `user` или текст на кнопке «Войти», если пользователь не авторизован. Используется только на `desktop`-уровне, для обратной совместимости. 

### API блока
#### BEMJSON (входные данные)

* `{String} login` – логин пользователя в Яндексе.
* `{String} uid` – [uid](http://doc.yandex-team.ru/Passport/AuthDevGuide/concepts/Account_About.xml) пользователя.
* `{String} mailCallerId` — [Идентификатор потребителя](https://beta.wiki.yandex-team.ru/users/jkennedy/api2/#obshhiepolozhenija) для ручки получения количества непрочитанных писем. Используется модификаторами `menu_yes` и `menu_multiauth`. Передаётся в js-параметр `caller` блока `user-menu-update`. Необязательное поле.
* `{String} counter` –  счетчик для сбора различных статистических данных (подсчет кликов, переходов и т. п.). В поле передается функция, которая реагирует на событие `onmousedown`  блока. Необязательное поле.

```javascript
{
    block: 'user',
    content: {elem: 'icon'},
    counter: 'console.log("Send me to server")' // счетчик с функцией логирования в консоль
}
```

#### JS-параметры

* `{Number} mail` –  количество новых писем в меню пользователя.
* `{String} uid ` –  [уникальный числовой идентификатор аккаунта](http://doc.yandex-team.ru/Passport/AuthDevGuide/concepts/Account_About.xml) пользователя. Значение по умолчанию: `[i-global].uid`.
* `{String} login` – имя пользователя. Значение по умолчанию: берется из BEMJSON или из `[i-global].login`.

* `{String} avatarHost` – хост Аватарницы. Значение по умолчанию: `//avatars.mds.yandex.net`.
* `{String} avatarId` – идентификатор аватара пользователя. Значение по умолчанию: берется из `[i-global][displayName][default_avatar]`.

* `{Number} maxLength` – максимальная длина имени пользователя. Значение по умолчанию: `16`.
* `{Number} maxLengthRelative` – погрешность максимальной длины имени. Значение по умолчанию: `3`.
* `{Boolean} isUglyUserName` – признак пустого значения `login`. Значения: `true` – после авторизации поле `login` пустое и отсутствует `displayName`, `false` – иначе.

* `{String} accountsUrl` – URL сервиса аккаунтов в Паспорте. Значение по умолчанию: `[i-global][pass-host] + /accounts`.
* `{Number} getAccountsTimeout` – предельное время ожидания ответа от сервера аккаунтов в миллисекундах. Значение по умолчанию: `5000`.
* `{String} dataProvider` – провайдер данных от сервера. Значение по умолчанию: `i-request_type_ajax`.

<a name="jsdomik"></a>
JS-параметры блока **user** передаваемые в блок [domik](../domik/domik.ru.md):

* `{Object} domikMods` – модификаторы Домика;
* `{Object} domikJs` – JS-параметры Домика.

---
**NB** JS-параметры `maxLength`, `maxLengthRelative`, `isUglyUserName` можно задать и через контекст элемента `name`, для обратной совместимости. Смотри [пример](#jsname). 

---

### Варианты использования
Пример полного блока для авторизованного пользователя:

```js
[{
    block: 'i-global',
    params: {
        login: 'someLogin',
        displayName: {
            'default_avatar': '1450/4001140776-39966'
        }
    }
},
{
    block: 'user',
    js: {
        mail: 101,
        uid: '84473936',
        domikMods: { logo: 'ru', type: 'popup' },
        avatarHost: '//avatars.mdst.yandex.net'
    },
    attrs: {
        style: 'margin-left: 150px'
    },
    mods: {menu: 'yes'},
    content: [
        {elem: 'icon'},
        {elem: 'name'}
    ]
}]
```
