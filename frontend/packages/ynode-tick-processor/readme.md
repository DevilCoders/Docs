# ynode-tick-processor

Пакет скриптов для обработки логов `v8.log` и вывода итогов в человекочитаемом формате.

Информация по получению логов `v8.log` лежит здесь: https://v8.dev/docs/profile

Основан на https://github.com/dex4er/js-tick-processor.

Содержит оригинальные скрипты из https://github.com/v8/v8/blob/master/tools/, пропатченные для обратной совместимости с логами 8.X, и для использования новой версии `nm` под MacOS X.

## Требования

1. Node >= 8.0.0
2. Установленная в системе утилита `nm`
3. Версия для MacOS X требует утилиты `nm`, которая совместима по опциям и формату вывода с аналогичной утилитой в Linux (необходимы опции `-n -C -D`).

## Установка

```shell
npm i -g @yandex-int/ynode-tick-processor --registry=http://npm.yandex-team.ru
```

## Применение

1. Собираем лог

```console
node --prof script.js
```

После выполнения скрипта будет сгенерирован лог вида `isolate-0x123456-v8.log`.

2. Обрабатываем

```console
ynode-tick-processor isolate-0x123456-v8.log > isolate-0x123456-v8.txt
```

3. Смотрим в консоли ошибки обработки лога

- ошибка `nm не может найти библиотеку` - это очень плохо (стектрейсы, попадающие в данную библиотеку,
  будут посчитаны неверно или не посчитаны вообще); надо разбираться и чинить
- ошибка `line 12345: unknown code state: 0x6789a` - это терпимо, означает ошибки в разборе указанной строки лога
  на отдельные поля, (для данного кода не будет нарисована `*` или `~`, будет выведено неправильное название);
  чаще всего возникает для RegExp с запятыми внутри, при желании можно в исходном логе отредактировать RegExp,
  убрав или заэкранировав запятые, убрав кавычки и повторить обработку лога
- ошибка `Code move event for unknown code: 0x12345` - терпимо, можно игнорировать
- ошибка `dropping: overflow` - терпимо, можно игнорировать

4. Анализируем обработанный профайл

Перед названием функции встречаются символы `~` или `*`.

- `~` означает, что код можно оптимизировать (`CodeState.OPTIMIZABLE`)
- `*` означает, что код уже оптимизирован (`CodeState.OPTIMIZED`)
