# magicdev
![](https://badger.yandex-team.ru/npm/@yandex-int/magicdev/version.svg)
![](https://badger.yandex-team.ru/npm/@yandex-int/magicdev/owner.svg)
[![OKO health](https://oko.yandex-team.ru/badges/repo.svg?repoName=frontend/packages/magicdev&vcs=arc)](https://oko.yandex-team.ru/repo/toolbox/magicdev)

Run your node app in local environment with one simple command

## Установка

    npm i --save-dev --save-exact @yandex-int/magicdev registry=https://npm.yandex-team.ru


# Что это, зачем, и как этим пользоваться
В большинстве случаев ваше nodejs-приложение должно быть доступно по https (например, чтобы иметь доступ к secure-кукам).
В продакшн-среде и при использовании отдельного сервера для разработки эту проблему решает за вас облачная платформа/админы
серверов, где работает ваше приложение. При локальной разработке решение этой проблемы ложится на вас.

Также вашему приложению, как правило, нужен домен с реальным TLD (top-level domain).

Данное приложение позволяет вам с минимальными усилиями обеспечить https для вашего приложения и разрабатываться локально.

Кроме этого, мы предлагаем вкусные плюшки, такие как:

- Слежение за файловой системой и автоматический перезапуск проекта при внесении изменений
- Запуск скриптов по изменениям файлов в проекте
- Эмуляция балансера, который монтирует приложение по какому-то пути и вырезает этот путь из URL (читай L7/Qloud router)
- Автоматический перезапуск через sudo с сохранением окружения, чтобы можно было использовать стандартные порты 80 и 443

## Требования к приложению
1. У приложения должен быть файл, являющийся точкой входа. Этот файл должен экспортировать функцию,
которая может быть обработчиком http-запросов (см. https://nodejs.org/api/http.html#http_event_request).
Для приложений на фреймворке express - это сам объект [Application](http://expressjs.com/en/4x/api.html#app).
2. В вышеописанном файле не следует создавать http/https-серверов, иначе - возможен конфликт.
Для express - вы НЕ должны делать `app.listen(...)`.
Для продакшн-окружения вы можете сделать, например, index.js, в котором и создавать сервер.

Если у вас приложение на [project-stub](https://github.yandex-team.ru/project-stub/generator-project-stub) - все должно
сразу быть хорошо и от вас не требуется никаких доработок.

## Как использовать (простейший вариант)
Установить magicdev глобально (`sudo npm install -g @yandex-int/magicdev --registry=https://npm.yandex-team.ru`) и в корне приложения выполнить `magicdev`.

После этих нехитрых манипуляций ваше приложение должно быть доступно по HTTP на порту 80 и по HTTPS на порту 443.
Возможно, у вас будет запрошен ваш пароль для sudo.

HTTPS-сертификат, который поставляется в комплекте с magicdev выписан для
доменов (.*\\.)?localhost.msup.yandex(-team)?.(ru|ua|kz|by|com|com.tr|com.ua|net).
Если у вас нет таких DNS-записей, вы можете добавить из в /etc/hosts или попросить вашего системного администратора
добавить их для адреса 127.0.0.1 или ::1.

Если вам нужно разрабатывать приложение под другим доменом, вы можете сделать
следующее:

1. Добавить домен в /etc/hosts с указанием IP 127.0.0.1 и ::1
2. Выписать сертификат через [сертификатор](https://crt.yandex-team.ru),
    положить его где-то локально, а также раздать коллегам. При выписывании
    сертификата нужно использовать внутренний CA. Внимание: файл
    сертификата должен быть в формате .pem и должен содержать приватный ключ.
    Сертификатор отдает приватный ключ в pem только первые 7 дней после выписывания
    сертификата.
3. Указать домен и путь к сертификату с помощью аргумента командной
    строки `-c` или опции `customCerts` в конфиге

## Опции
На текущий момент magicdev поддерживает следующие опции:

- `-a`, `--app` - путь до точки входа в приложение. Если не задан - magicdev пробует найти приложение сначала в `./app.js`,
затем в `./server/app.js` относительно текущей рабочей директории.
- `--app-resolve-timeout"` - ждать асинхронной инициализации приложения указанное количество миллисекунд. По умолчанию _10000_
- `-p`, `--port`, `--ports` - порты для HTTPS и HTTP, на которых будет доступно приложение. Должна быть передана строка,
содержащая либо один порт для HTTPS, либо 2 порта, разделенных запятой. По-умолчанию используется `443,80`.

    Если задан только один порт, приложение доступно _только по https_.
Данная опция позволяет отказаться от sudo, используя непривилегированные порты; работать с несколькими приложениями
одновременно, запуская их на разных портах и т.д.
- `l`, `--listen` - позволяет поменять IP-адрес, на котором будет доступно приложение. По-умолчанию: `127.0.0.1`.
Полезно для доступа из виртуальных машин.
- `-e`, `--env` - установить NODE_ENV. Если не задано, используется текущее значение переменной окружения. Если такой
переменной окружения нет - подставляется значение local.
- `-s`, `--secure` - если значение эквивалентно true (true, on, enable, 1), на HTTP-порту запускается редирект на
HTTPS-порт, если false (false, off, disable, 0) - по HTTP-порту доступно само приложение. Опция имеет смысл только
если задан HTTP-порт.
- `-n`, `--namespace`, `--l7path` - неймспейс балансера. Если ваше приложение в продакшне обслуживается неким балансером
(L7 или Qloud router) по заданному пути (допустим, '/app') и этот путь вырезается балансером - с помощью magicdev можно
получить такое же поведение при локальной разработке. Путь должен обязательно начинаться с символа `/`.
- `-w`, `--watch` - позволяет задать паттерн для слежения за файлами. При появлении изменений в этих файлах сервер будет
автоматически перезапущен. Можно задать несколько паттернов путем повтора опции несколько раз с разными аргументами,
например `-w server/ -w config/`. В качестве паттерна может быть файл, директория или glob-паттерн. В последнем случае,
паттерн обязательно нужно взять в одинарные кавычки, чтобы ваш shell не раскрывал glob. Иначе результат может быть
неожиданным.
- `-d`, `--debounce` - перезапускать сервис и запускать скрипты не чаще, чем через указанное количество миллисекунд.
- `-r`, `--reload` - вкупе с опцией `-w` позволяет автоматически перезагружать страницу в браузере после перезапуска
сервера, при появлении изменений в файле.
- `--ws` - позволяет выполнять npm-скрипт при обнаружении изменений в каких-либо файлах. Принимает 2 аргумента: паттерн
для файлов (такой же, как для опции `-w`) и имя скрипта.
Пример: `--ws static/desktop.blocks build`, что означает,
что при обнаружении изменений в директории static/desktop.blocks запускается npm-скрипт build. Сервер при этом НЕ
перезапускается. Если во время работы скрипта файлы опять поменяются - скрипт будет убит и перезапущен. **Осторожно:**
если ваш скрипт изменяет файлы, соответствующие отслеживаемому паттерну - он будет бесконечно перезапускаться.

Также, как и в случае опции `-w`, можно задать несколько правил (пар паттерн-скрипт).
- `-c`, `--cert` - позволяет задать собственный SSL-сертификат для какого либо
домена. Принимает 2 аргумента: домен и путь до файла с сертификатом
- `--node-opts` -  все, что идет после этой опции, считается опциями nodejs и передается "как есть". Это позволяет использовать
функции nodejs и v8 для отладки, а также включать harmony-расширения и т.д.
- `-i`, `--inspect` - запустить отладку на указанном порту, либо паре `host:port`.
- `-h`, `--help` - показать краткую справку

## Конфигурация через файл
Помимо задания опций через командную строку, вы можете управлять поведением magicdev через конфигурационные файлы.
Доступны все те же опции, что и через командную строку. Конфигурационный файл должен называться .magicdev.json и, как
следует из названия, должен содержать опции в формате JSON.

При запуске magicdev ищет конфигурационные файлы на всех уровнях ФС начиная с текущей директории до домашней директории
пользователя или корня `/`. Если какие-то опции не заданы в конфигурационном файле на текущем уровне, но заданы в
на уровне выше - они также будут учтены. Таким образом, наибольший приоритет имеют параметры командной строки, затем идут
конфигурационные файлы по мере их отдаления от рабочей директории.

Таким образом, можно задавать конфигурацию как по-проектно, так и для групп проектов.

Краткое описание формата конфигурационного файла (все поля являются необязательными):

- `"app"` {string} - путь до приложения (абсолютный, либо относительный от рабочей директории)
- `"appResolveTimeout"` - ждать асинхронной инициализации приложения указанное количество миллисекунд. По умолчанию _10000_
- `"env"` {string} - значение NODE_ENV
- `"httpPort"` {number|string} - порт для HTTP
- `"httpsPort"` {number|string} - порт для HTTPS
- `"namespace"` {string} - путь до приложения относительно корня web-сервера (l7path)
- `"secure"` {boolean} - включать ли редирект HTTP->HTTPS
- `"watch"` {Array.\<string>} - паттерны для отслеживания файлов, при изменении которых сервис перезапустится
- `"debounce"` {boolean|number} - Перезапускать сервис и запускать скрипты не чаще, чем через _200_ или указанное количество миллисекунд
- `"reload"` {boolean} - перезагружать ли страницу при перезапуске сервиса
- `"nodeOpts"` {Array.\<string>} - массив опций, которые будут переданы самому процессу nodejs при запуске приложения.
- `"watchScripts"` {Object.\<string, Object|string|Array.\<string|Object>>} - словарь вида {команда: [правила]}. При изменении файлов,
    соответствующих какому-либо паттерну, запускается соответствующая команда. Для команды можно задать аргументы, которые будут вычисляться в зависимости от имени файла. Подробнее смотри в следующей секции.
- `"customCerts"` {Array.\<Array.\<string>>} - список, содержащий набор пар
  вида [домен, путь до сертификата].
- `"inspect"` {boolean|number|string} - Запустить отладку на порту _9229_ или указанном, или указать пару `host:port` (актуально для IPv6 Only хостов у которых нет `127.0.0.1`)

### Настройка автозапуска скриптов через "watchScripts"
Опция `watchScripts` служит для того, чтобы при изменении файлов в проекте запускать различные скрипты.
В качестве скриптов используются npm-скрипты, описанные в `package.json`.

Формат конфигурации для этой опции следующий:

```
"watchScripts: {
  "scriptName": <params>
}"
```

Здесь scriptName - это название скрипта, а params может быть:
- строкой - тогда это glob-паттерн, указывающий на файлы, при изменении которых скрипт будет запущен
- объектом вида

```
{
  "paths": ["pattern"],
  "args": ["array", "of", "cmd", "args"],
  "regex": ""
}
```

Здесь `paths` - это glob-паттерн, либо список паттернов, а необязательный параметр "args" позволяет передать скрипту дополнительные
аргументы. При этом если в аргументах встречается сочетание `$0`, оно заменяется на полный путь к файлу, а `$1`, `$2` и так далее -
на соответствия в пути, задаваемые параметром regex. Смотри пример в разделе Рецепты и подсказки.
- списком, содержащим вышеописанные строки и объекты в произвольном порядке

### Ручной перезапуск
Если вам нужно вручную перезапустить приложение, вместо остановки и перезапуска magicdev можете ввести в терминале строку `rs`,
затем нажать <kbd>Enter</kbd>, и magicdev перезапустит сервер.

## Рецепты и подсказки
### TypeScript
Приложения на TypeScript можно запускать без предварительной компиляции в JS.
Для этого следует установить [ts-node](https://github.com/TypeStrong/ts-node) и
задать поле `nodeOpts` в `.magicdev`, например, таким образом:
```
"nodeOpts": ["-r", "ts-node/register/transpile-only"]
```

### project-stub
Для приложений на project-stub можно воспользоваться следующей командой:

```
magicdev -e local -r -w server -w configs --ws 'static/*.blocks/**' build --ws 'static/*.bundles/*/blocks/**' build -n /app
```

Так вы получите:

- NODE_ENV=local
- приложение будет доступно на https://localhost.msup.yandex.ru/app/
- редирект с HTTP на HTTPS, как в продакшне
- рестарт сервера и перезагрузку страницы браузера при изменениях в директориях server или config
- пересборку статики при изменениях в любых файлах в блоках (запуск npm run build) и перезагрузку страницы браузера после

Похожее поведение можно получить, добавив в корень приложения конфигурационный файл `.magicdev.json` со следующим содержимым:
```
{
  "env": "local",
  "reload": true,
  "namespace": "/app",
  "watch": ["server", "configs"],
  "watchScripts": {
    "build": ["static/*.blocks/**", {
      "paths": "static/*.bundles/*/blocks/**",
      "args": ["--", "$1/$2"],
      "regex": "static/(.*\\.bundles)/(.*?)/.*"
    }]
  }
}
```
Стоит обратить внимание на секцию `watchScripts`. Она написана так, что при изменении файла в `static/*.blocks` будет запущена
полная пересборка проекта, а при изменении в `static/*.bundles` - только конкретного бандла.

### Отладка из виртуализированных систем
Иногда нужно отлаживать верстку и клиентский JS из других ОС, таких как Windows, Linux, Android. Как правило, они запущены в
виртуальной машине, в то время как разрабатываемое приложение - на хосте.
Чтобы попадать из виртуальной машины в приложение на хосте проще всего перенаправить DNS-запись
`localhost.msup.yandex.ru(com/ua/etc)` на хостовую машину. Для этого в `/etc/hosts` или `%WINDIR%\System32\Drivers\etc\hosts`
нужно внести запись:

```
1.2.3.4 localhost.msup.yandex.ru
```

где 1.2.3.4 нужно заменить на ваш IPv4-адрес (поскольку с IPv6 и Windows наблюдались некоторые проблемы).
Узнать его можно из настроек ОС или зайдя на https://yandex.ru/internet/.
Для модификации файла hosts нужны права администратора (рут для андроида).

После подмены DNS-записи нужно запустить magicdev с опцией `-l 1.2.3.4`, где 1.2.3.4 нужно также заменить на ваш IP адрес.


### Настройка BrowserSync
Когда у вас включено обновление страницы по изменению файлов/запуску скриптов - работает встроенный в magicdev BrowserSync.
Он также запускает свою собственную консоль управления, доступную на http://localhost.msup.yandex.ru:3001/

С ее помощью можно управлять параметрами BrowserSync, такими как синхронизация форм, кликов и т.д.
