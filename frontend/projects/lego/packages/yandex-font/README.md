# yandex-font

Общий пакет для подключения шрифта на сервис.

## Поддержка в браузерах
Кастомные шрифты **НЕ** нужно включать в
* OSFamily Android < 4.4
* OSFamily Bada
* BrowserName UCBrowser
* BrowserName IEMobile
* BrowserName MSIE < 11

*TODO вынести эти проверки в код библиотеки*

**font-display** пока не используется, недостаточно стабильно работает в браузерах.

## Механизм

Для проверки того, загружены ли файлы шрифтов на клиенте, используется кука `font_loaded` на пути `path=/` со значением версии
шрифта `YSv1`.
Если куки нет, то первый показ происходит с дефолтными шрифтами. Таким образом минимизируем FOUT/FOIT.

Кука общая на домен второго уровня. Статика лежит на s3. Предполагается, что шрифты меняются редко и все сервисы могут использовать
прогретую статику, просто подключив этот пакет.

Файл `browser.css` нужно инлайнить в продакшене, чтобы уменьшить число сетевых запросов до отображения страницы. `browser.js` подключается инлайном или со статики в зависимости от того, как работает страница (см. ниже) 
Для локальной разработки предполагается использование файлов со статики. Пути до них указаны в `meta.js` или `meta.json`.

Если у вас на проекте используется особенная сборка и/или шаблонизация, вы можете использовать для этого данные из
`meta.js` или `meta.json`. Там есть версии пакета и шрифта, имена класса и куки, пути до статики.

## Подключение

### Для страниц с серверным рендерингом

На сервере проверяем поддержку в браузерах, есть ли кука `font_loaded` и совпадает ли ее версия с версией библиотеки.
* Если успешно, то добавляем класс `font_loaded` на `html`. Добавляем инлайновый стили из `browser.css`
* Если нет, добавляем на страницу файл `browser.js` (внешним запросом), который в фоне скачает файлы шрифтов и выставит куку `font_loaded` нужной версии. 

Загрузка может немного отличаться, если где-то еще на странице используются элементы с кастомными шрифтами, которые не видны в первом экране. Тогда
нужно подгружать стили из `browser.css` всегда, а `browser.js` лучше подключать инлайном.

### Для страниц с клиенстким рендерингом

На страницу подключается инлайновые файл `browser.js` и `browser.css`.
При загрузке выполняется скрипт `browser.js`, который проверяет, загружен ли шрифт, и выставляет класс `font_loaded` на `html`.
Срабатывает селектор из `browser.css` и шрифт включается.

## Примеры. подключения
* https://github.yandex-team.ru/morda/main/blob/dev/tmpl/common/blocks/fonts/fonts.view.js
* https://github.yandex-team.ru/news/nerpa/search?q=font_loaded&unscoped_q=font_loaded
* https://github.yandex-team.ru/serp/turbo/pull/3408

## Планы

1. сделать поддержку одновременного использования разных версий шрифта.
1. поэкспериментировать с облегченной версией загрузчика (https://github.yandex-team.ru/serp/web4/pull/12714)
1. поэкспериментировать с лучшим сжатием шрифтов
1. внедрить в максимальное количество сервисов (и попробовать на серпе)
1. добавить src local для шрифта

## Что ещё

- [ ] автоматическая публикация
- [ ] стенд для проверки шрифта
- [ ] автоматическое создание PR с canary версией пакета в сервисы

## Поддержка
 Если у вас возникли вопросы и предложения по пакету, пишите нам:

- https://staff.yandex-team.ru/deemidroll
- https://staff.yandex-team.ru/qfox
