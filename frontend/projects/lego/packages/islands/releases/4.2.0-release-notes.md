# islands 4.2.0

Изменения, вошедшие в релиз islands 4.2.0, разделены на группы:

* [Минорные изменения](#Минорные-изменения) — задачи, в рамках которых произошло расширение API блоков;
* [Исправлено и улучшено](#Исправлено-и-улучшено) — различные исправления, не затрагивающие API блоков;
* [Дополнительно](#Дополнительно) — задачи, не касающиеся кода блоков (документация, инфраструктура и т.д.)

Все минорные изменения подробно описаны в конце соответствующих разделов.

## Минорные изменения

| Заголовок                                                        | Задача     | PR     |
| :--------------------------------------------------------------- | :--------- | :----- |
| [user-menu-update: Перейти на новую ручку почты](#ISL-1153)      | [ISL-1153] | [#726] |
| [slider: Добавить логику про формат вывода значений.](#ISL-2107) | [ISL-2107] | [#758] |
| [b-page__link: Перенести на common-уровень](#ISL-2146)           | [ISL-2146] | [#804] |
| [button2: Доработки для select2 и мелкий рефакторинг](#ISL-2158) | [ISL-2158] | [#814] |

## Исправлено и улучшено

| Заголовок                                                                             | Задача     | PR             |
| :------------------------------------------------------------------------------------ | :--------- | :------------- |
| [domik: В iOS при фокусе из одного инпута в другой прыгает позиция](#ISL-1492)        | [ISL-1492] | [#778], [#794] |
| [i-ua: Скорректировать работу i-ua_inlinesvg_no на Windows Phone](#ISL-1817)          | [ISL-1817] | [#793]         |
| [domik: На ios8 при клике по чекбоксу в домике происходит скролл страницы](#ISL-1832) | [ISL-1832] | [#777]         |
| [i-hidden: Подготовить к удалению](#ISL-2089)                                         | [ISL-2089] | [#802]         |
| [input: Белый цвет шрифта в Safari у input_disabled_yes](#ISL-2132)                   | [ISL-2132] | [#784]         |
| input__clear: В Firefox не работает один из тестов                                    | [ISL-1793] | [#786]         |
| Завернуть статические объекты в генераторы для bem-xjst@next                          | [ISL-2150] | [#797]         |
| Избавиться от использования $.event.handle                                            | [ISL-1898] | [#748]         |

## Дополнительно

| Заголовок                                                                        | Задача     | PR     |
| :------------------------------------------------------------------------------- | :--------- | :----- |
| [dropdown: Увеличить покрытие unit-тестами до 100%](#ISL-1933)                   | [ISL-1933] | [#827] |
| [tooltip: Добавить паблик метод setContent](#ISL-2065)                           | [ISL-2065] | [#783] |
| [b-form-checkbox: Подготовить к удалению](#ISL-2070)                             | [ISL-2070] | [#803] |
| [b-icon: Объявить устаревшим](#ISL-2071)                                         | [ISL-2071] | [#775] |
| [b-tabbed-pane: Подготовить к удалению](#ISL-2087)                               | [ISL-2087] | [#782] |
| [i-counter: Подготовить к удалению метод Lego.ch](#ISL-2088)                     | [ISL-2088] | [#824] |
| [b-statcounter: Подготовить к удалению элементы services и statface](#ISL-2113)  | [ISL-2113] | [#811] |
| check-button: Подготовить к удалению логику про реакцию на ENTER и выставление.. | [ISL-2124] | [#819] |
| b-page_theme_social: Подготовить к удалению                                      | [ISL-2166] | [#826] |
| arr: Подготовить к удалению                                                      | [ISL-2099] | [#808] |

## Пояснения


<a name="ISL-1153"></a>
### [ISL-1153 – user-menu-update: Перейти на новую ручку почты](https://st.yandex-team.ru/ISL-1153)

Теперь количество непрочитанных сообщений берется из [почтового API второй версии](https://beta.wiki.yandex-team.ru/users/jkennedy/api2/#counters).

Есть два нюанса, которые требуют активных действий со стороны сервиса, чтобы ручка заработала.
1. Кросс-доменные запросы. Новая ручка из соображений безопасности использует `CORS` и не поддерживает `JSONP`.
   Чтобы получить доступ к ручке, нужно написать администраторам почты на рассылку
   [mail-admin@](https://ml.yandex-team.ru/lists/mail-admin/) или [yamail-admin@](https://ml.yandex-team.ru/lists/yamail-admin/)
   и попросить их добавить свой домен в правила для `CORS`.
2. Идентификатор потребителя ([caller](https://beta.wiki.yandex-team.ru/users/jkennedy/api2/#obshhiepolozhenija)),
   который подставляется в URL ручки при каждом запросе. Его также нужно согласовать с администраторами.

Смежные изменения:
- `i-request_type_ajax` теперь принимает js-параметр `xhrFields` и прокидывает его в `jQuery.ajax()`.
- Блок `user-menu-update` теперь принимает js-параметр `caller` (идентификатор потребителя).
- У блока `user` появилось кастомное поле `mailCallerId`, из которого параметр `caller` прокидывается в `user-menu-update`.

<a name="ISL-1492"></a>
### [ISL-1492: domik: В iOS при фокусе из одного инпута в другой прыгает позиция](https://st.yandex-team.ru/ISL-1492)

Начиная с iOS 8 при фокусе на элементах ввода браузер пытается подвести видимую
область поближе к элементу ввода. Но в случае, когда элементы ввода находятся
внутри элементов с фиксированным позиционированием (`position: fixed`)
появляются неизлечимые до конца сайд-эффекты, которые дважды дергают
фиксированный элемент по странице, отрывая его от исходной позиции.

Как максимально незначительная мера было решено рекомендовать не использовать
элементы ввода внутри фиксированных элементов (в т.ч. и домик) на тачпадах.

Для iOS на уровне touch-pad сделаны следующие изменения:
- убран `position: fixed` и `left/right: 0` с `body`;
- добавлен `position: absolute` на `domik__popup`;
- домик теперь приклеен к шапке (`top: 150px`) вместо центрирования.

<a name="ISL-1817"></a>
### [i-ua: Скорректировать работу i-ua_inlinesvg_no на Windows Phone](https://st.yandex-team.ru/ISL-1817)

Теперь i-ua_inlinesvg_no выставляется только для Windows Phone < 8.1, а не для всех версий.

Дело в том, что Windows Phone до версии 8.1 отображал svg-иконки, установленныые на `background` замыленно и не красиво,
поэтому для всех WP выставлялся `i-ua_inlinesvg_no`, чтобы срабатывали `png`-фоллбеки. Однако, с выходом WP 8.1 отображение
svg починили, так что теперь `i-ua_inlinesvg_no` устанавливается только для версий WP8.0 и ниже.

<a name="ISL-1832"></a>
### [ISL-1832 – Скачущие контролы в fixed, ios8](https://st.yandex-team.ru/ISL-1832)

Больше на ios8 при клике по чекбоксу в домике (и других местах) не происходит скролл страницы:
- modal: Добавлен пример с элементами ввода.
  Пример, выявляющий ошибки в ios8+, с различными (в т.ч. скрытыми) `input`,
  `textarea` и `contenteditable` в попапе с `position: fixed`.
- control, radiobox: Решение проблемы с `input` в `fixed` в iOS 8 и выше.
  отмена `focusin` для предотвращения дерганий интерфейса при смене значений.

<a name="ISL-1933"></a>
### [ISL-1933: dropdown: Увеличить покрытие unit-тестами до 100%](https://st.yandex-team.ru/ISL-1933)

В рамках задачи в блок внесли ряд мелких, обратно совместимых изменений.
Кроме этого, объявили устаревшим JS-параметр `switcherBlock`.

В версии 5.0 код, связанный с этим параметром, будет удален.
В случае, если вы используете этот параметр, сообщите нам с какой целью.

<a name="ISL-2065"></a>
### [ISL-2065: tooltip: Добавить паблик метод setContent](https://st.yandex-team.ru/ISL-2065)

Добавлено описание и пример использования метода `setContent`.

<a name="ISL-2070"></a>
### [b-form-checkbox: Подготовить к удалению](https://st.yandex-team.ru/ISL-2070)

Блок `b-form-checkbox` объявлен устаревшим и будет удален в одной из следующих мажорных версий,
вместо него рекомендуется использовать [`checkbox`].

[`checkbox`]: https://lego.yandex.ru/libs/islands/v4.x/desktop/checkbox

<a name="ISL-2071"></a>
### [b-icon: Объявить устаревшим](https://st.yandex-team.ru/ISL-2071)

Блок `b-icon` объявлен устаревшим. Вместо него используйте `icon` или `image`. `b-icon` может использоваться
только другими устаревшими блоками (`b-form-button`, `b-form-attach` и т.д.) и будет удален как только
появятся замены на использующие его блоки.

<a name="ISL-2087"></a>
### [b-tabbed-pane: Подготовить к удалению](https://st.yandex-team.ru/ISL-2087)

Блок `b-tabbed-pane` объявлен устаревшим и будет удален в islands 5.0, вместо него рекомендуется использовать
[`tabs`] совместно с [`tabs-panes`].
Добавлен [пример](https://lego.yandex.ru/libs/islands/v4.x/desktop/tabs/examples/#15-control-menu-vert),
демонстрирующий как можно доопределить стили блока [`tabs-menu`] чтобы получить аналог вертикального меню
(`b-tabbed-pane_layout_vert`).

[`tabs`]: https://lego.yandex.ru/libs/islands/v4.x/desktop/tabs
[`tabs-panes`]: https://lego.yandex.ru/libs/islands/v4.x/desktop/tabs-panes
[`tabs-menu`]: https://lego.yandex.ru/libs/islands/v4.x/desktop/tabs-menu

<a name="ISL-2088"></a>
### [i-counter: Подготовить к удалению метод Lego.ch](https://st.yandex-team.ru/ISL-2088)

Метод `Lego.ch`, который используется в [параметризованном счетчике клика на ссылку в шапке](https://github.yandex-team.ru/lego/islands/blob/dev/common.blocks/i-counter/i-counter.ru.md#Параметризованный-счетчик-клика-на-ссылку-в-шапке) объявлен устаревшим и будет удален в следующей мажорной версии islands 5.0.

Также устаревшим объявлен модификатор `b-form-button_counter`, в котором использовался этот метод.

<a name="ISL-2089"></a>
### [ISL-2089: i-hidden: Подготовить к удалению](https://st.yandex-team.ru/ISL-2089)

Мы объявили устаревшим блок `i-hidden` и собираемся удалить его в следующей мажорной версии islands (5.0).
Блок представлял из себя один CSS-файл следующего содержания:

```css
.i-hidden
{
    display: none !important;
}
```

Если вы по какой-то причине используете этот блок, то вам нужно запланировать рефакторинг.

<a name="ISL-2107"></a>
### [ISL-2107: slider: Добавить логику про формат вывода значений](https://st.yandex-team.ru/ISL-2107)

В блоке `slider` появилась возможность самостоятельно задавать формат выводимых значений.
Для этого были добавлены методы `toDisplay` и `fromDisplay`, предназначенные для преобразования
отформатированного значения в числовое и наоборот.

![office_hours_block](https://jing.yandex-team.ru/files/karamadjong/office_hours_block.png)

Демонстрацию использования методов `toDisplay` и `fromDisplay` можно посмотреть в примере [custom][custom-example].

[custom-example]: https://lego.yandex-team.ru/__example/islands/v4.1.0/desktop.examples/slider/custom/custom.html

<a name="ISL-2113"></a>
### [b-statcounter: Подготовить к удалению элементы services и statface](https://st.yandex-team.ru/ISL-2113)

- Элемент `services` хранит ID счетчиков Gemius и Metrika для различных сервисов.
  Идентификаторы используются в качестве значений по умолчанию элементами `gemius` и `metrika`.
  Список идентификаторов давно не актуализировался, планируется удалить его из библиотеки.
  Элемент объявлен устаревшим, рекомендуется передавать значения кодов явно.

- Элемент `statface` содержит единственный модификатор `rstat`, который раньше использовался для нужд проекта
  [antirobot](https://wiki.yandex-team.ru/jandekspoisk/sepe/antirobotonline/).
  Счётчик объявлен устаревшим и в следующей мажорной версии библиотеки будет удалён.

<a name="ISL-2132"></a>
### [ISL-2132 – input: Белый цвет шрифта в Safari у input_disabled_yes](https://st.yandex-team.ru/ISL-2132)

Исправлен цвет текста в Safari при `_disabled_yes` (с белого на нужный).

<a name="ISL-2146"></a>
### [ISL-2146: b-page__link: Перенести на common-уровень](https://st.yandex-team.ru/ISL-2146)

Перенесли элемент `link` блока `b-page` с touch-уровня на common-уровень.
Теперь он стал доступен для любой платформы.
Также, в BEMJSON API элемента были добавлены поля `rel`, `type`, `url`, `title` и `sizes`
для удобства определения соответствующих атрибутов.

Например, передав следующий BEMJSON:
```js
{
    block: 'b-page',
    elem: 'link',
    rel: 'search',
    url: 'https://yandex.ru/opensearch.xml'
    type: 'application/opensearchdescription+xml',
    title: 'Яндекс'
}
```

Вы получите такой HTML:
```html
<link rel="search" href="https://yandex.ru/opensearch.xml" title="Яндекс" type="application/opensearchdescription+xml">
```

<a name="ISL-2158"></a>
### [ISL-2158: button2: Доработки для select2 и мелкий рефакторинг](https://st.yandex-team.ru/ISL-2158)

В блок `button2` добавлен опциональный JS-параметр `pressKeys`.
В параметре можно передать массив идентификаторов клавиш (см. [keycodes]),
которые могут выполнить нажатие кнопки.
Иными словами, когда кнопка находится в фокусе, при нажатии одной из этих клавиш,
блок будет получать модификатор `pressed_yes`.

Пример:
```js
{
    block: 'button2',
    js: {
        pressKeys: ['SPACE', 'UP', 'DOWN']
    },
    text: 'Кнопка'
}
```

Также в блоке `keycodes` расширен интерфейс метода `is`,
вторым параметром стало возможно передавать массив.

Теперь эти вызовы равнозначны:
```js
BEM.blocks.keycodes.is(e.keyCode, 'UP', 'RIGHT', 'DOWN', 'LEFT');
BEM.blocks.keycodes.is(e.keyCode, ['UP', 'RIGHT', 'DOWN', 'LEFT']);
```

[keycodes]: https://github.yandex-team.ru/lego/islands/blob/dev/common.blocks/keycodes/keycodes.js



[ISL-1153]: https://st.yandex-team.ru/ISL-1153
[#726]: https://github.yandex-team.ru/lego/islands/pull/726
[ISL-1492]: https://st.yandex-team.ru/ISL-1492
[#778]: https://github.yandex-team.ru/lego/islands/pull/778
[#794]: https://github.yandex-team.ru/lego/islands/pull/794
[ISL-1817]: https://st.yandex-team.ru/ISL-1817
[#793]: https://github.yandex-team.ru/lego/islands/pull/793
[ISL-1832]: https://st.yandex-team.ru/ISL-1832
[#777]: https://github.yandex-team.ru/lego/islands/pull/777
[ISL-1933]: https://st.yandex-team.ru/ISL-1933
[#827]: https://github.yandex-team.ru/lego/islands/pull/827
[ISL-2065]: https://st.yandex-team.ru/ISL-2065
[#783]: https://github.yandex-team.ru/lego/islands/pull/783
[ISL-2070]: https://st.yandex-team.ru/ISL-2070
[#803]: https://github.yandex-team.ru/lego/islands/pull/803
[ISL-2071]: https://st.yandex-team.ru/ISL-2071
[#775]: https://github.yandex-team.ru/lego/islands/pull/775
[ISL-2087]: https://st.yandex-team.ru/ISL-2087
[#782]: https://github.yandex-team.ru/lego/islands/pull/782
[ISL-2088]: https://st.yandex-team.ru/ISL-2088
[#824]: https://github.yandex-team.ru/lego/islands/pull/824
[ISL-2089]: https://st.yandex-team.ru/ISL-2089
[#802]: https://github.yandex-team.ru/lego/islands/pull/802
[ISL-2107]: https://st.yandex-team.ru/ISL-2107
[#758]: https://github.yandex-team.ru/lego/islands/pull/758
[ISL-2113]: https://st.yandex-team.ru/ISL-2113
[#811]: https://github.yandex-team.ru/lego/islands/pull/811
[ISL-2132]: https://st.yandex-team.ru/ISL-2132
[#784]: https://github.yandex-team.ru/lego/islands/pull/784
[ISL-2146]: https://st.yandex-team.ru/ISL-2146
[#804]: https://github.yandex-team.ru/lego/islands/pull/804
[ISL-2158]: https://st.yandex-team.ru/ISL-2158
[#814]: https://github.yandex-team.ru/lego/islands/pull/814
[ISL-2124]: https://st.yandex-team.ru/ISL-2124
[#819]: https://github.yandex-team.ru/lego/islands/pull/819
[ISL-1793]: https://st.yandex-team.ru/ISL-1793
[#786]: https://github.yandex-team.ru/lego/islands/pull/786
[ISL-2150]: https://st.yandex-team.ru/ISL-2150
[#797]: https://github.yandex-team.ru/lego/islands/pull/797
[ISL-2166]: https://st.yandex-team.ru/ISL-2166
[#826]: https://github.yandex-team.ru/lego/islands/pull/826
[ISL-2099]: https://st.yandex-team.ru/ISL-2099
[#808]: https://github.yandex-team.ru/lego/islands/pull/808
[ISL-1898]: https://st.yandex-team.ru/ISL-1898
[#748]: https://github.yandex-team.ru/lego/islands/pull/748
