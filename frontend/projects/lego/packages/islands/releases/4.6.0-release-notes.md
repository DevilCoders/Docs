# islands 4.6.0

## Важное в этом релизе:

1. В рамках работ по повышению debuggability, в этот релиз вошли первые ласточки-сообщения об использовании [устаревших/приватных методов](https://github.yandex-team.ru/lego/islands/blob/089ef26f63ba32289e20f707648f3f0375dcef14/common.blocks/auth/auth.js#L419) — в блоке `auth`.

 Сообщения выводятся через методы консоли. В дальнейшем мы увеличим количество сообщений, чтобы покрыть все методы, которые будут удалены в следующем мажорном релизе.

 Чтобы начать их получать, нужно при сборке технологии `js` воспользоваться пакетом [enb-define][] для enb или любым другим аналогом, и передать в значение переменной `ISLDEBUG` легко запоминающуюся комбинацию: `*/!/*`.

 ```js
nodeConfig.addTechs([
   [require('enb-define'), {
      target: '?.js',
      sources: ['?.pre.js'],
      variables: {
        ISLDEBUG: '*/!/*'
      }
    }]
]);
```

2. Мы окончательно унифицировали тачевую шапку в islands с шапками в других сервисах Поискового портала.

Все изменения, вошедшие в релиз islands 4.6.0, разделены на группы:

* [минорные изменения](#Минорные-изменения) — задачи, в рамках которых произошло расширение API блоков;
* [исправлено и улучшено](#Исправлено-и-улучшено) — различные исправления, не затрагивающие API блоков;
* [дополнительно](#Дополнительно) — задачи, не касающиеся кода блоков (документация, инфраструктура и т.д.).

Все важные изменения подробно описаны [ниже](#Пояснения).

## Минорные изменения

| Заголовок                                                                           | Задача     | PR      |
| :---------------------------------------------------------------------------------- | :--------- | :------ |
| [auth: Добавить возможность пробрасывать параметр origin](#ISL-1468)                | [ISL-1468] | [#955]  |
| [button: Добавить методы setUrl/getUrl](#ISL-2371)                                  | [ISL-2371] | [#1006] |
| [i-jquery: обновить элемент inherit](#ISL-2332)                                     | [ISL-2332] | [#997]  |
| [menu: Перейти на синхронное событие change вместо асинхронного changed](#ISL-2350) | [ISL-2350] | [#993]  |

## Исправлено и улучшено

| Заголовок                                                           | Задача     | PR      |
| :------------------------------------------------------------------ | :--------- | :------ |
| b-flash: Рефакторинг примеров                                       | [ISL-2223] | [#1027] |
| b-form-attach: Сократить количество примеров                        | [ISL-2225] | [#1012] |
| b-form-button: Сократить количество примеров                        | [ISL-2226] | [#1021] |
| b-form-checkbox: Сократить количество примеров                      | [ISL-2180] | [#1024] |
| b-icon: Сократить количество примеров                               | [ISL-2228] | [#1010] |
| b-layout-table: Сократить количество примеров                       | [ISL-2230] | [#979]  |
| b-menu-horiz: Сократить количество примеров                         | [ISL-2231] | [#982]  |
| [head-menu: Неверно исправляет ссылки при первом заходе](#ISL-2333) | [ISL-2333] | [#1029] |
| spin: Сократить количество примеров                                 | [ISL-2217] | [#1015] |
| tabs: Сократить количество примеров                                 | [ISL-2218] | [#1008] |
| user: На iPad не открывается домик при клике по Войти               | [ISL-2384] | [#1025] |
| Отказаться от использования elemMatch в BEMHTML                     | [ISL-2366] | [#1001] |
| Правка шаблонов для совместимости с bemhtml-next                    | [ISL-2135] | [#995]  |
| Унифицировать мобильную шапку СЕРПа с шапкой Лего                   | [ISL-2360] | [#1026] |

## Дополнительно

| Заголовок                                    | Задача     | PR     |
| :------------------------------------------- | :--------- | :----- |
| b-form: Подготовить к удалению               | [ISL-2224] | [#887] |
| [human-date: Рефакторинг примера](#ISL-2197) | [ISL-2197] | [#983] |
| i-global: Доработать документацию из ромочки | [ISL-2328] | [#999] |

## Пояснения


<a name="ISL-1468"></a>
### [auth: Добавить возможность пробрасывать параметр origin][ISL-1468]

__ВНИМАНИЕ__ Мы произвели рефакторинг блока `auth`.
Эти изменения могут вам что-то сломать, читайте внимательно.

#### Переход на button2

Теперь в элементах `button`, `remember` и `register`, которые реализованы в модификаторе `_content_auto`,
вместо устаревшего блока `button` используется блок `button2`.

Т.е. для вот этих трех кнопок теперь используется новый блок

![](https://jing.yandex-team.ru/files/karamadjong/Prostaya_forma_avtorizatsii_2015-12-29_20-59-01.png)

В некоторых сценариях использования это может сломать ваши стили и JS.

Документация к блоку `button2`: https://lego.yandex-team.ru/libs/islands/v4.x/desktop/button2/docs/

#### Изменился способ применения шаблонов auth_content_auto

Раньше BEMHTML-шаблоны `auth_content_auto` имели следующий вид:
```js
block('auth').mode('auto-content')(...)
```

Теперь они имеют такой вид:
```js
block('auth').mod('content', 'auto').mode('auto-content')(...)
```

Т.е. раньше шаблоны `auth_content_auto` расширяли основной шаблон блока по факту подключения файла в сборку.
Теперь вам нужно не только подключить файл, но и явно указать модификатор `content_auto`.

#### Удалили шаблоны auth__social-link

Шаблоны `auth__social-link` использовались в браузере для создания списка ссылок социальной авторизации.
Мы удалили их в пользу прямого использования блока `link` с миксом `auth__social-link`.

#### Изменились ссылки «Вспомнить пароль» и «Регистрация»

У ссылок «Вспомнить пароль» и «Регистрация» при шаблонизации больше не добавляются
параметры `from` и `retpath`. Генерируется только необходимый минимум.

Параметры `from` и `retpath` добавляются уже в JS на клиенте при инициализации блока.

Сами ссылки поменялись на более новые красивые `passport.yandex.ru/restoration` и `passport.yandex.ru/registration`.

#### Удалили моду action в BEMHTML-шаблонах

Ранее, с помощью этой моды можно было задать значение по умолчанию атрибуту `action` у формы.

Теперь значение по умолчанию через шаблоны переопределить нельзя, но у вас по-прежнему есть
возможность задать произвольное значение атрибута `action` через поле `url` в BEMJSON.

```js
{
    block: 'auth',
    mods: {content: 'auto'},
    url: 'https://passport.yandex.ru/secret/handler',
    ...
}
```

#### Удалили логику про отправку формы по ENTER в IE9

В файле `desktop.blocks/auth/auth.js` располагался специальный костыль с подпиской на `keydown`
и принудительной отправкой формы по ENTER в IE9, которая якобы не происходит по умолчанию.
Нам не удалось этого воспроизвести, отправка по ENTER работает нормально, так что файл мы удалили.

Если с отправкой по ENTER в IE9 возникнут какие-то проблемы, пожалуйста, дайте нам знать.

#### Новые поля retpath, from, origin и timestamp

В BEMJSON API блока появились поля `retpath`, `from`, `origin` и `timestamp`.
Через них можно передать значения соответствующих скрытых полей (`<input type=hidden>`) формы.

По умолчанию значения полей `retpath` и `from`, как и раньше, определяются из `i-global`.
Если поля не переданы, а значений по умолчанию нет, то будут добавлены поля с пустыми значениями.

Поле `timestamp`, как правило, передавать не нужно, оно используется в JS в момент отправки формы.

Использование:
```js
{
    block: 'auth',
    mods: {content: 'auto'},
    origin: 'serp.domik',
    retpath: 'https://yandex.ru/search/?text=котятки'
}
```

Результат:
```html
<form action="https://passport.yandex-team.ru/auth" class="auth auth_content_auto" method="post">
    <div class="auth__username">...</div>
    <div class="auth__password">...</div>
    <div class="auth__button">...</div>

    <input class="auth__hidden auth__retpath" name="retpath" type="hidden" value="https://yandex.ru/search/?text=котятки" />
    <input class="auth__hidden auth__from" name="from" type="hidden" />
    <input class="auth__hidden auth__origin" name="origin" type="hidden" value="serp.domik" />
    <input class="auth__hidden auth__timestamp" name="timestamp" type="hidden" />
</form>
```

#### Элемент hidden

В блоке появился элемент `hidden`, предназначенный для добавления в форму скрытых параметров.
Имя и значение параметра передаются через BEMJSON-поля `name` и `val`.

Использование:
```js
{
    block: 'auth',
    mods: {content: 'auto'},
    content: [
        {elem: 'username'},
        {elem: 'password'},
        {elem: 'button'},

        {elem: 'hidden', name: 'enought', val: 'оливье'},
        {elem: 'hidden', name: 'letsgo', val: 'танцевать'}
    ]
}
```

Результат:
```html
<form class="auth auth_content_auto" method="post" action="https://passport.yandex.ru/auth">
    <div class="auth__username">...</div>
    <div class="auth__password">...</div>
    <div class="auth__button">...</div>

    <input class="auth__hidden" type="hidden" name="enought" value="оливье">
    <input class="auth__hidden" type="hidden" name="letsgo" value="танцевать">

    ...
</form>
```

#### Новые JS-методы

В JS API блока появились методы `setRetpath` и `getRetpath`, для получения и установки
значения параметра `retpath`.

На замену статическим методам `_getRegisterURL` и `_getRememberURL` были добавлены
методы прототипа `getRegisterURL` и `getRememberURL` с тем же смыслом.

#### Устаревшее

Логика про получение значений по умолчанию для параметров `retpath` и `from` из
блока `i-global` объявлена устаревшей. В следующей мажорной версии мы ее удалим.
Пожалуйста, переходите на передачу этих параметров через одноименные BEMJSON-поля

Чтобы обновить параметр `retpath` на клиенте, используйте метод `setRetpath`.

Статические методы `_getRegisterURL` и `_getRememberURL` объявлены устаревшими.
Если вы используете эти методы, пожалуйста, запланируйте переход на использование
соответствующих методов прототипа `getRegisterURL` и `getRememberURL`.

#### Информация про поле origin

Поле `origin` обозначает место авторизации/регистрации на сервисе и сам сервис.
В случае, если на сервисе несколько мест, где можно аутентифицироваться и их хочется различать,
то для каждого нужно задать отдельный `origin`.
Кроме того, если место входа или форма регистрации отличается для `desktop` и `touch`,
то их так же нужно разделить с помощью `origin`.

Формат (пример): `origin=market`, `origin=market.domik`, `origin=market.cart`.

Если вы еще не используете поле `origin`, то вам следует как можно скорее начать.
Дополнительную информацию можно получить у [@arhibot] и [@eaandreeva].

[@arhibot]: https://staff.yandex-team.ru/arhibot
[@eaandreeva]: https://staff.yandex-team.ru/eaandreeva

<a name="ISL-2371"></a>
### [button: Добавить методы setUrl/getUrl][ISL-2371]

В блок `button` добавлены методы `setUrl` и `getUrl` для совместимости с API `button2`.

<a name="ISL-2333"></a>
### [head-menu: Неверно исправляет ссылки при первом заходе][ISL-2333]

Исправлен баг в функции `updateLinks()` из-за которого в ссылках на сервисы удалялась часть `pathname`.
В частности, это затрагивало [Картинки](https://yandex.ru/images) и [Видео](http://yandex.ru/video).

Блок `head-menu` сложно централизованно поддерживать в актуальном состоянии, так как список сервисов определяется
с помощью BEMJSON на каждом сервисе отдельно. Поэтому блок объявляется устаревшим, а вместо него рекомендуем использовать
[Табло сервисов](https://github.yandex-team.ru/lego/tableau), встраиваемое в iframe.
В [примерах блока](https://lego.yandex-team.ru/libs/islands/v4.x/touch-phone/head-menu/examples/#tableau)
продемонстрирован способ добавления Табло сервисов на уровне проекта.

<a name="ISL-2197"></a>
### [human-date: Рефакторинг примера][ISL-2197]

Пример использования блока `human-date` немного причёсан
и переименован в [all](https://lego.yandex-team.ru/libs/islands/v4.x/desktop/human-date/examples/#all).

<a name="ISL-2332"></a>
### [i-jquery: обновить элемент inherit][ISL-2332]

В `i-jquery__inherit` были портированы изменения из библиотеки [inherit] v2.2.3.

1. Поддержка [примесей][inherit-mixin] (в `i-bem` будет портирована [отдельной задачей][i-bem-mixin]):

```javascript
var A = $.inherit();
var M = $.inherit({
    methodM: function() {
        return 'M';
    }
});
var B = $.inherit([A, M]);
```

2. Возможность [наследоваться][inherit-plain] от простой функции-конструктора:

```javascript
function A() {}

var B = $.inherit(A, {
  __constructor: function () {
    this.__base(); // equal to call A.call(this);
  }
});
```

3. Возможность [подменить][inherit-base-mock] `__base` для конкретного метода:

```javascript
var A = inherit({
    m: function() {
        return 'A';
    }
});
var B = inherit(A, {
    m: function() {
        return this.__base() + 'B';
    }
});
B.prototype.m.__base = function() { return 'C'; };
```

[inherit]: https://github.com/dfilatov/inherit
[i-bem-mixin]: https://st.yandex-team.ru/ISL-2368
[inherit-mixin]: https://github.com/dfilatov/inherit/issues/8
[inherit-plain]: https://github.com/dfilatov/inherit/issues/9
[inherit-base-mock]: https://github.com/dfilatov/inherit/pull/18

<a name="ISL-2350"></a>
### [menu: Перейти на синхронное событие change вместо асинхронного changed][ISL-2350]

В блоке `menu` удалена логика про асинхронную генерацию события `changed`.
Вместо этого теперь генерируется синхронное событие `change` (имя поменялось).


[enb-define]: https://github.com/tadatuta/enb-define
[ISL-1468]: https://st.yandex-team.ru/ISL-1468
[#955]: https://github.yandex-team.ru/lego/islands/pull/955
[ISL-2223]: https://st.yandex-team.ru/ISL-2223
[#1027]: https://github.yandex-team.ru/lego/islands/pull/1027
[ISL-2225]: https://st.yandex-team.ru/ISL-2225
[#1012]: https://github.yandex-team.ru/lego/islands/pull/1012
[ISL-2226]: https://st.yandex-team.ru/ISL-2226
[#1021]: https://github.yandex-team.ru/lego/islands/pull/1021
[ISL-2180]: https://st.yandex-team.ru/ISL-2180
[#1024]: https://github.yandex-team.ru/lego/islands/pull/1024
[ISL-2224]: https://st.yandex-team.ru/ISL-2224
[#887]: https://github.yandex-team.ru/lego/islands/pull/887
[ISL-2228]: https://st.yandex-team.ru/ISL-2228
[#1010]: https://github.yandex-team.ru/lego/islands/pull/1010
[ISL-2230]: https://st.yandex-team.ru/ISL-2230
[#979]: https://github.yandex-team.ru/lego/islands/pull/979
[ISL-2231]: https://st.yandex-team.ru/ISL-2231
[#982]: https://github.yandex-team.ru/lego/islands/pull/982
[ISL-2371]: https://st.yandex-team.ru/ISL-2371
[#1006]: https://github.yandex-team.ru/lego/islands/pull/1006
[ISL-2333]: https://st.yandex-team.ru/ISL-2333
[#1029]: https://github.yandex-team.ru/lego/islands/pull/1029
[ISL-2197]: https://st.yandex-team.ru/ISL-2197
[#983]: https://github.yandex-team.ru/lego/islands/pull/983
[ISL-2328]: https://st.yandex-team.ru/ISL-2328
[#999]: https://github.yandex-team.ru/lego/islands/pull/999
[ISL-2332]: https://st.yandex-team.ru/ISL-2332
[#997]: https://github.yandex-team.ru/lego/islands/pull/997
[ISL-2350]: https://st.yandex-team.ru/ISL-2350
[#993]: https://github.yandex-team.ru/lego/islands/pull/993
[ISL-2217]: https://st.yandex-team.ru/ISL-2217
[#1015]: https://github.yandex-team.ru/lego/islands/pull/1015
[ISL-2218]: https://st.yandex-team.ru/ISL-2218
[#1008]: https://github.yandex-team.ru/lego/islands/pull/1008
[ISL-2384]: https://st.yandex-team.ru/ISL-2384
[#1025]: https://github.yandex-team.ru/lego/islands/pull/1025
[ISL-2366]: https://st.yandex-team.ru/ISL-2366
[#1001]: https://github.yandex-team.ru/lego/islands/pull/1001
[ISL-2135]: https://st.yandex-team.ru/ISL-2135
[#995]: https://github.yandex-team.ru/lego/islands/pull/995
[ISL-2360]: https://st.yandex-team.ru/ISL-2360
[#1026]: https://github.yandex-team.ru/lego/islands/pull/1026
