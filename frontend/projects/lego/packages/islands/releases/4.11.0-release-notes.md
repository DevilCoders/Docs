# islands 4.11.0

<!-- ЧЕЛОВЕЧЕСКОЕ ВСТУПЛЕНИЕ -->

Изменения, вошедшие в релиз islands 4.11.0, разделены на группы:

* [минорные изменения](#Минорные-изменения) — задачи, в рамках которых произошло расширение API блоков;
* [исправлено и улучшено](#Исправлено-и-улучшено) — различные исправления, не затрагивающие API блоков;
* [дополнительно](#Дополнительно) — задачи, не касающиеся кода блоков (документация, инфраструктура и т.д.).

Все важные изменения подробно описаны [ниже](#Пояснения).

## Минорные изменения

| Заголовок                                                                | Задача     | PR      |
| :----------------------------------------------------------------------- | :--------- | :------ |
| [i-ua_orient: Инлайнить выставление ориентации экрана](#ISL-2555)        | [ISL-2555] | [#1196] |
| [logo: Рефакторинг](#ISL-2466)                                           | [ISL-2466] | [#1213] |
| [Реализовать шапку для экспериментов в СЕРПе/Картинках/Видео](#ISL-2430) | [ISL-2430] | [#1269] |

## Исправлено и улучшено

| Заголовок                                                                                     | Задача     | PR      |
| :-------------------------------------------------------------------------------------------- | :--------- | :------ |
| input: В блоке с длинным содержимым невозможно переместить курсор в iOS                       | [ISL-2348] | [#1211] |
| pointerevents: Сделать так, чтобы polyfil отрабатывал только один раз                         | [ISL-2100] | [#1261] |
| [pointerevents__click: В Chrome iOS срабатывает pointerclick](#ISL-2560)                      | [ISL-2560] | [#1265] |
| slider: Падает скрипт на отсутствии e._preventScroll                                          | [ISL-2579] | [#1206] |
| [i-services: Выкинуть elemMatch в support/4.x](#ISL-2691)                                     | [ISL-2691] | [#1342] |

## Пояснения


<a name="ISL-2555"></a>
### [i-ua_orient: Инлайнить выставление ориентации экрана][ISL-2555]

Чтобы страница не мерцала из-за бага в видео на новых планшетах c экранной клавиатурой,
понадобилось изменить логику добавления модификатора `orient` блока `i-ua`,
отвечающего за ориентацию экрана.

Теперь класс модификатора `.i-ua_orient_*` добавляется в `<html>`
до загрузки стилей и скриптов на странице.
После загрузки скриптов модификатор добавляется в `<body>`.
При смене ориентации экрана меняется и значение модификатора у `<html>` и `<body>`.

Если у вас используются стили вида `.i-ua_orient_portrait.i-ua_platform_android`
необходимо изменить их на `.i-ua_orient_portrait .i-ua_platform_android`.

### Модификаторы
Допустимые значения модификатора `orient`:
- `portrait` — портретная;
- `landscape` — альбомная.

### Зависимости
```javascript
/* .deps.js */
({
    shouldDeps: [
        {
            block: 'i-ua',
            elem: 'orient'
        }
    ]
});
```

<a name="ISL-2466"></a>
### [logo: Рефакторинг][ISL-2466]

В блоке `logo` произошли существенные изменения BEMJSON API.

Верстка блока `logo` упростилась. Теперь это просто `inline-block` с фоновым изображением.
В `logo` больше не используется блок `i-global` и не определяется язык пользователя.
У блока есть набор стандартных изображений (модификатор `name`) для логотипа в шапке.
Набор включает в себя обычный и белый варианты в размерах 63x27, 84x36 и 98x42.

Вы также можете легко задать свое изображение, добавив новое значение модификатора `name`.

Пример получения кириллического логотипа, размером 84x36 px:
```js
{
    block: 'logo',
    mods: {
        name: 'ru-84x36'
    }
}
```

Пример получения большого кириллического логотипа ссылкой, размером 98x42 px,
с атрибутом title и нестандартным адресом:
```js
{
    block: 'logo',
    mods: {
        type: 'link',
        name: 'ru-98x42'
    },
    title: 'Перейти на главную страницу',
    url: 'https://ya.ru/'
}
```

__Миграция__

Элемент `link` объявлен deprecated. Если вы применяли к нему какие-то стили или шаблоны,
теперь вам нужно применять их непосредственно к блоку с модификатором `type_link`.

Модификатор `lang` объявлен deprecated.
Теперь вместо жесткого набора логотипов, привязанных к языкам, может использоваться любая
картинка любого размера. Идентификатор картинки задается с помощью модификатора `name`.

Поле `alt` объявлено deprecated. Используйте вместо него поле `text`.

<a name="ISL-2560"></a>
### [pointerevents__click: В Chrome iOS срабатывает pointerclick после открытия контекстного меню][ISL-2560]

В Chrome 50 под iOS не происходит событие `touchcancel` при открытии контекстного меню.
Но после закрытия меню, при касании в любом месте страницы, браузер сгенерирует событие
`touchend` элементу, который вызвал контекстное меню.

Чтобы такой сценарий не распознавался как `pointerclick`, теперь используется таймаут в
__250 мс__ (как в [hammer.js]). То есть если между событиями `pointerdown` и `pointerup`
будет задержка более 250 мс, то событие  `pointerclick` не генерируется.

[hammer.js]: http://hammerjs.github.io/recognizer-tap/

<a name="ISL-2691"></a>
### [i-services: Выкинуть elemMatch в support/4.x][ISL-2691]

Из bem-xjst 6.4.1 была удалена поддержка `elemMatch`: https://github.com/bem/bem-xjst/pull/263

Чтобы поддержать это изменение, нам пришлось удалить из `i-services` логику про удаление элементов отличных от `name` и `url`.
Если вы используете bemhtml 1.x и вам важно такое поведение, перенесите его на проектный уровень.

```javascript
// i-services.bemhtml.js
block('i-services')
    .elemMatch(function() { return this.elem !== 'name' && this.elem !== 'url'; })
    .def()('');
```

<a name="ISL-2430"></a>
### [Реализовать шапку для экспериментов в СЕРПе/Картинках/Видео][ISL-2430]

Изменения в шапке и блоках использующихся в шапке.

## `header2`

Стили блока были обновлены, чтобы соответствовать актуальной версии дизайна.

### `_layout_simple`

Предыдущая версия блока поддерживала раскрывающуюся стрелку — сложный дизайнерский концепт, который не прижился на сервисах.
Суть состояла в том, что при раскрытии старой версии табло сервисов (`services-table`),
форма поиска по сервису исчезала и на её месте появлялась поисковая стрелка.
На практике это означало, что скрывались элементы `left` и `right` и становился видимым элемент `websearch` с поисковой стрелкой.
Элементы `logo` и `nav` оставались на месте.

![](https://jing.yandex-team.ru/files/incrop/websearch-animated.gif)

Так как необходимости в раскрывающейся стрелке нет, появилась возможность упростить структуру шапки.

Модификатор `layout_simple` содержит шаблоны для «облегченной» версии шапки. В ней используются следующие поля:

- `logo` — контейнер для логотипа;
- `left` — контейнер для контента выровненного по левому краю шапки;
- `right` — контейнер для контента выровненного по правому краю;
- `under` — второй этаж шапки.

Следующие поля объявлены устаревшими:
- `websearch` — контейнер для поисковой стрелки. BEMJSON для поисковой стрелки теперь следует передавать в поле `left`;
- `nav` — контейнер для блока `user` и кнопок управления. Его содержимое следует передавать в `right`. Для сохранения
обратной совместимости элемент `nav` примешивается к `right`.

BEMJSON-поля `websearch` и `nav` и одноименные элементы объявлены устаревшими и будут удалены в islands 5.0.
Также не используются и будут удалены модификатор `show-websearch_yes` и вспомогательный элемент `middle`.

Рекомендуется выставить модификатор `layout_simple` уже сейчас, в islands 5.0 раскладка шапки определяемая этим модификатором
будет использоваться по умолчанию.

### `_border_transparent`

Модификатор содержит стили шапки для поисковой выдачи и обычно используется совместно с `fixed_yes`.
Раньше модификатор дорисовывал в нижней части шапки полупрозрачный градиент, чтобы создать иллюзию что выдача
при скролле «уползает» под стрелку.
Теперь модификатор отменяет высоту шапки `70px`, шапка начинает растягиваться по высоте содержимого.
Сразу после содержимого шапки теперь располагается элемент `white-stripe` — отступ высотой `4px`,
прозрачный для кликов (`pointer-events: none`).
Он нужен для того чтобы увеличить доступную для кликов область меню сервисов,
которое располагается под шапкой и частично ей перекрывается.

![](https://jing.yandex-team.ru/files/incrop/white-stripe.gif)

### `_progress_yes`

Раньше полоса загрузки (`header2__progress`) передавалась внутрь элемента `under`.
Теперь дизайн изменился и полоска переместилась в верхнюю часть шапки, чтобы не конфликтовать с меню сервисов.
Теперь, чтобы её использовать, нужно установить модификатор `header2_progress_yes`. Шапка с установленным
модификатором сгенерирует блок `progress` с примешанным к нему `header2__progress`.
На клиенте можно выполнить `header2.findBlockInside('progress', 'progress')` и затем использовать
[API](https://lego.yandex-team.ru/libs/islands/v4.8.0/desktop/progress/jsdoc/) блока `progress`.

### `__logo`

Теперь в шапке используется обновлённый блок `logo` с модификаторами `type_link` и `name_ru-84x36`/`name_en-84x36`
(в зависимости от текущего языка, установленного в `BEM.I18N`).

### `__action`

Стили элемента обновились, чтобы его оформление соответствовало блоку `button2`
с модификаторами`size_head`, `theme_clear`, `pale_yes`, `type_check`.

### `__gap`

Ширина стандартного отступа в шапке уменьшилась с `20px` до `12px`.

## `ticker`

Толщина шрифта счетчика непрочитанных писем увеличилась, изменилось позиционирование блока относительно аватара пользователя.

## `search2`

- Увеличился размер шрифта у элемента `input__found` (количество найденных результатов).
- Контейнер для поискового поля `search2__input` больше не растягивается на 100%, теперь его размер определяется содержимым.
- Для `search2_theme_websearch` ширина `search2__input` (`550px`) перенесена на уровень `desktop`.
- У `input_theme_websearch` убран градиент, теперь цвет поискового поля однородный: `#ffdb4d`.

## `button2`, `button`, `check-button`

Немного изменились стили модификатора `theme_clear` для кнопок:
- `opacity` для активного состояния (`hovered_yes`, `checked_yes`) изменилось с `1` на `0.8`;
- `opacity` для неактивного состояния изменилось с `0.25` на `0.3`.

Теперь цвета кнопки `theme_clear` совпадают с цветами элементов поисковой строки: крестика и кнопки расширенных настроек.

Для кнопок-иконок слева от блока `user` совместно с `theme_clear` следует использовать модификатор `pale_yes`,
он устанавливает `opacity: 0.2` для неактивного состояния кнопок.



[ISL-2555]: https://st.yandex-team.ru/ISL-2555
[#1196]: https://github.yandex-team.ru/lego/islands/pull/1196
[ISL-2348]: https://st.yandex-team.ru/ISL-2348
[#1211]: https://github.yandex-team.ru/lego/islands/pull/1211
[ISL-2466]: https://st.yandex-team.ru/ISL-2466
[#1213]: https://github.yandex-team.ru/lego/islands/pull/1213
[ISL-2100]: https://st.yandex-team.ru/ISL-2100
[#1261]: https://github.yandex-team.ru/lego/islands/pull/1261
[ISL-2560]: https://st.yandex-team.ru/ISL-2560
[#1265]: https://github.yandex-team.ru/lego/islands/pull/1265
[ISL-2579]: https://st.yandex-team.ru/ISL-2579
[#1206]: https://github.yandex-team.ru/lego/islands/pull/1206
[ISL-2430]: https://st.yandex-team.ru/ISL-2430
[#1269]: https://github.yandex-team.ru/lego/islands/pull/1269
[ISL-2691]: https://st.yandex-team.ru/ISL-2691
[#1342]: https://github.yandex-team.ru/lego/islands/pull/1342
