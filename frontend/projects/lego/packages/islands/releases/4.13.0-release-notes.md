# islands 4.13.0

<!-- ЧЕЛОВЕЧЕСКОЕ ВСТУПЛЕНИЕ -->

Изменения, вошедшие в релиз islands 4.13.0, разделены на группы:

* [минорные изменения](#Минорные-изменения) — задачи, в рамках которых произошло расширение API блоков;
* [исправлено и улучшено](#Исправлено-и-улучшено) — различные исправления, не затрагивающие API блоков;
* [дополнительно](#Дополнительно) — задачи, не касающиеся кода блоков (документация, инфраструктура и т.д.).

Все важные изменения подробно описаны [ниже](#Пояснения).

## Минорные изменения

| Заголовок                                                            | Задача     | PR      |
| :------------------------------------------------------------------- | :--------- | :------ |
| [tabs: Добавить возможность выбирать 'disabled' элементы](#ISL-2725) | [ISL-2725] | [#1437] |
| [Добавить зависимости в технологии js от i18n для блоков](#ISL-1836) | [ISL-1836] | [#1386] |

## Исправлено и улучшено

| Заголовок                                                      | Задача     | PR      |
| :------------------------------------------------------------- | :--------- | :------ |
| [services-table: Заменить Яндекс.Авто на Авто.ру](#ISL-2568)   | [ISL-2568] | [#1450] |
| auth__social-icon: Рефакторинг                                 | [ISL-2165] | [#1390] |
| b-statcounter: Кэшировать скрипты систем аналитики             | [ISL-2626] | [#1364] |
| button: Не снимается состояние focused при переходе в disabled | [ISL-2598] | [#1458] |
| nampelate: Исправить сломанный логотип Афиши                   | [ISL-2417] | [#1413] |
| Удалить неиспользуемый код для планшетов из islands            | [ISL-2411] | [#1376] |

## Дополнительно

| Заголовок                                                                | Задача     | PR      |
| :----------------------------------------------------------------------- | :--------- | :------ |
| i-common__string: Объявить метод highlight deprecated                    | [ISL-1142] | [#1430] |

## Пояснения


<a name="ISL-2725"></a>
### [tabs: Добавить возможность выбирать 'disabled' элементы][ISL-2725]

В блоке `tabs` добавлена возможность программно выбирать неактивную вкладку ( модификатор `disabled` в значении `yes`) . Теперь метод `.activate(index)` позволяет устанавливать модификатор `checked` для вкладки даже при наличии модификатора `disabled`.

<a name="ISL-1836"></a>
### [Добавить зависимости в технологии js от i18n для блоков][ISL-1836]

Добавлена поддержка сборки кейсетов `i18n` [адаптированных для клиента][enb-bem-i18n].
Теперь вы можете, немного изменив сборку, сократить количество переводов попадающих на клиент.

Для каждого блока использующего `BEM.I18N()` в клиентском js, в deps-by-tech добавлена зависимость
```javascript
({
    tech: 'js',
    shouldDeps: {
        tech: 'i18n',
        block: 'name' // Для случаев когда переводы элемента/модификатора лежат в директории блока
    }
})
```

Для каждого блока использующего `BEM.I18N()` в шаблонах, добавлена зависимость
```javascript
({
    tech: 'bemhtml',
    shouldDeps: {
        tech: 'i18n',
        block: 'name' // Для случаев когда переводы элемента/модификатора лежат в директории блока
    }
})
```

Вам нужно будет проделать аналогичную работу с зависимостями на уровне своего сервиса.
Для автоматизации процесса можно использовать наш [скрипт для миграции](https://github.com/bem-kit/i18n-deps.script.js).

После этого вам нужно будет подправить конфиг сборки, чтобы для клиента происходила сборка отдельного кейсета.
Если вы собираете бандлы, примеры или gemini-тесты с помощью `islands-tools`, достаточно включить
опцию `browserI18n: true`. В других случаях нужно будет сделать изменения аналогичные указанным ниже.

Также, если вы используете технологию [depsByTechToBemdecl], мы рекомендуем включить опцию `bemdeclFormat: 'deps'`.
Из-за [бага в технологии][deps-by-tech-issue], в BEMDECL стандартного формата могут попадать лишние зависимости.

__Было:__

```javascript
nodeConfig.addTechs([
    // ...
    deps,
    files,
    [mergeKeysets, {lang: '{lang}'}], // Собираем кейсеты для сервера и клиента
    [depsByTechToBemdecl, {
        sourceTech: 'js',
        destTech: 'bemhtml',
        target: '?.browser-bemhtml.bemdecl.js'
    }],
    [deps, { // Собираем депсы для клиентсих шаблонов
        target: '?.browser-bemhtml.deps.js',
        bemdeclFile: '?.browser-bemhtml.bemdecl.js'
    }],
    [files, {
        depsFile: '?.browser-bemhtml.deps.js',
        filesTarget: '?.browser-bemhtml.files',
        dirsTarget: '?.browser-bemhtml.dirs'
    }],
    // ...
]);
```

__Стало:__

```javascript
nodeConfig.addTechs([
    // ...
    deps,
    files,
    [keysets, {lang: '{lang}'}], // Эти кейсеты будут использоваться только на сервера
    [depsByTechToBemdecl, {
        sourceTech: 'js',
        destTech: 'bemhtml',
        bemdeclFormat: 'deps', // Используем deps, так на клиент не приедут лишние зависим
        target: '?.browser-bemhtml.bemdecl.deps.js'
    }],
    [deps, {
        target: '?.browser-bemhtml.deps.js',
        bemdeclFile: '?.browser-bemhtml.bemdecl.deps.js'
    }],
    [files, {
        depsFile: '?.browser-bemhtml.deps.js',
        filesTarget: '?.browser-bemhtml.files',
        dirsTarget: '?.browser-bemhtml.dirs'
    }],

    [depsByTechToBemdecl, { // Собираем депсы для кейсетов использующихся из js
        sourceTech: 'js',
        destTech: 'i18n',
        bemdeclFormat: 'deps',
        target: '?.browser-i18n-js.bemdecl.deps.js'
    }],
    [depsByTechToBemdecl, { // Собираем депсы для кейсетов использующихся из шаблонов, которые попадут на клиент
        filesTarget: '?.browser-bemhtml.files',
        sourceTech: 'bemhtml',
        destTech: 'i18n',
        bemdeclFormat: 'deps',
        target: '?.browser-i18n-bemhtml.bemdecl.deps.js'
    }],
    [mergeDeps, { // Склеиваем депсы для js и шаблонов
        target: '?.browser-i18n.deps.js',
        sources: ['?.browser-js-i18n.deps.js', '?.browser-bemhtml-i18n.deps.js']
    }],
    [files, {
        depsFile: '?.browser-i18n.deps.js',
        filesTarget: '?.browser-i18n.files',
        dirsTarget: '?.browser-i18n.dirs'
    }],
    [keysets, { // Сюда не попадут кейсеты использующиеся только на сервере
        dirsTarget: '?.browser-i18n.dirs',
        target: '?.browser.keysets.{lang}.js',
        lang: '{lang}'
    }],
    // ...
]);
```

<a name="ISL-2568"></a>
### [services-table: Заменить Яндекс.Авто на Авто.ру][ISL-2568]

В блоке `i-services` добавлен сервис Авто.ru (идентификатор `autoru`), который заменит собой закрывающийся сервис Яндекс.Авто(`auto`). Также для него были добавлены данные (иконка и ссылка в блоках `service-icon` и `i-services` соответственно). Сервис добавлен в пресет `ru` блока `service-table`.

[enb-bem-i18n]: https://github.com/enb/enb-bem-i18n/blob/master/README.md#%D0%A1%D0%B1%D0%BE%D1%80%D0%BA%D0%B0-%D1%82%D0%BE%D0%BB%D1%8C%D0%BA%D0%BE-%D0%BD%D0%B5%D0%BE%D0%B1%D1%85%D0%BE%D0%B4%D0%B8%D0%BC%D1%8B%D1%85-%D0%BF%D0%B5%D1%80%D0%B5%D0%B2%D0%BE%D0%B4%D0%BE%D0%B2
[depsByTechToBemdecl]: https://github.com/enb/enb-bem-techs/blob/master/docs/api.ru.md#depsbytechtobemdecl
[deps-by-tech-issue]: https://github.com/enb/enb-bem-techs/issues/218


[ISL-2568]: https://st.yandex-team.ru/ISL-2568
[#1450]: https://github.yandex-team.ru/lego/islands/pull/1450
[ISL-2165]: https://st.yandex-team.ru/ISL-2165
[#1390]: https://github.yandex-team.ru/lego/islands/pull/1390
[ISL-2626]: https://st.yandex-team.ru/ISL-2626
[#1364]: https://github.yandex-team.ru/lego/islands/pull/1364
[ISL-2598]: https://st.yandex-team.ru/ISL-2598
[#1458]: https://github.yandex-team.ru/lego/islands/pull/1458
[ISL-1142]: https://st.yandex-team.ru/ISL-1142
[#1430]: https://github.yandex-team.ru/lego/islands/pull/1430
[ISL-2417]: https://st.yandex-team.ru/ISL-2417
[#1413]: https://github.yandex-team.ru/lego/islands/pull/1413
[ISL-2725]: https://st.yandex-team.ru/ISL-2725
[#1437]: https://github.yandex-team.ru/lego/islands/pull/1437
[ISL-1836]: https://st.yandex-team.ru/ISL-1836
[#1386]: https://github.yandex-team.ru/lego/islands/pull/1386
[ISL-2411]: https://st.yandex-team.ru/ISL-2411
[#1376]: https://github.yandex-team.ru/lego/islands/pull/1376
