# Миграция islands 4.x → 5.x

- [Мотивация и общие замечания](#Мотивация-и-общие-замечания)
- [Обновление технологий](#Обновление-технологий)
- [Работа с булевыми модификаторами](#Работа-с-булевыми-модификаторами)
- [Ручная установка модификатора theme](#Ручная-установка-модификатора-theme)
- [Список обратно несовместимых изменений в блоках](#Мажорное)
- [Список удаленных блоков](#Удаленное)
- [Прочее](#Прочее)

## Мотивация и общие замечания

Итак, вы собираетесь обновить `islands`.

Стоит сразу предупредить, это довольно продолжительный и трудоемкий процесс.
У ряда блоков изменилось публичное API (BEMJSON и/или JS), некоторые БЭМ-сущности были удалены.
Но в качестве вознаграждения за проделанную работу, после обновления библиотеки, вы получите ряд преимуществ:
* сокращенный размер собранной статики;
* более стройное API;
* регулярные (раз в две недели) обновления библиотеки.

Гайд по миграции должен помочь при обновлении. Не обязательно читать весь документ сверху вниз.
Достаточно перед обновлением:
* внимательно прочитать раздел про обновление `bem-xjst`;
* бегло просмотреть основные разделы по оглавлению выше;
* посмотреть списки затронутых обновлением блоков, прикинуть какие из них используются на сервисе и почитать инструкции точечно по блокам.

Несколько практических советов:
* Очень важно завершить обновление как можно быстрее. Pull request с изменениями получится объемным,
на активно развивающемся проекте будут возникать конфликты, поддерживать его в актуальном состоянии будет сложно.
* Обновление `bem-xjst` — один из самых трудоемких этапов. Так как `islands` 4.x поддерживает последние версии `bem-xjst`,
шаблонизатор можно обновить отдельной задачей перед обновлением `islands`.
* На большом проекте может быть сложно найти все фрагменты кода, сломавшиеся из-за изменений в `bem-xjst`.
Для поиска проблемных мест можно использовать [отладочные шаблоны](https://gist.github.com/miripiruni/ece794f072e73ba597d142732464f333).
Шаблоны нужно добавить в разработческую сборку, в самом конце. Hint: чтобы не менять сборку, можно просто посмотреть
какой блок приезжает последним в собранных deps.js и дописать шаблоны в него.
* Не обязательно выполнять все _рекомендуемые_ инструкции гайда. Для многих блоков допустимо «срезать углы» — временно перенести
удаленную логику на проектный уровень, чтобы не блокировать обновление. Не забудьте завести отдельную задачу на рефакторинг.
* В Лего есть [механизм вывода предупреждений](https://github.yandex-team.ru/lego/islands#Сообщения-об-ошибках).
В процессе работы над релизом мы добавили в ряд блоков `islands` 4.x предупреждения о грядущих изменениях API в 5.x.
Для начала мы рекомендуем включить вывод предупреждений для разработческой сборки и обновить `islands` до последней версии 4.x.
Затем протестировать свой сервис, найти все фрагменты кода, генерирующие предупреждения, и запомнить их (например, можно оставить в
коде комментарии-маркеры). При обновлении до 5.x вы будете знать, куда нужно внести правки.
* В любой непонятной ситуации обращайтесь в Лего:
  * почта: lego@yandex-team.ru
  * slack: https://lego-team.slack.com/messages/support/
* Если обновление кажется слишком сложным — пишите нам, мы выделим разработчика и обновим сервис совместными усилиями.

В целом, если вы пережили обновление `islands` 3.x → 4.x, обновление до 5.x должно показаться легким.

## Обновление технологий

### [Обновление bem-xjst до 6.x](https://st.yandex-team.ru/FEI-1809)

Начиная с версии `islands` 5.0 прекращается поддержка компилятора [bem-xjst](https://ru.bem.info/platform/bem-xjst/)
ниже версии 6.0.

При переходе на `bem-xjst` версии 6.х, необходимо учесть следующие изменения:
* В BEMJSON модификаторы элемента задаются только через зарезервированное поле
[elemMods](https://github.com/bem/bem-xjst/blob/master/CHANGELOG.md#2016-01-29-v500-miripiruni).
Раньше можно было использовать также и поле `mods`.

__Было:__

```javascript
// *.bemjson.js
({
    block: 'button',
    elem: 'icon',
    mods: {type: 'comment'}
})
```

__Стало:__

```javascript
// *.bemjson.js
({
    block: 'button',
    elem: 'icon',
    elemMods: {type: 'comment'}
})
```

* Для работы с модификаторами, вместо `this.ctx.mods` и `this.ctx.elemMods`, следует использовать `this.mods` и `this.elemMods`
соответственно. В `this.ctx` содержится входной BEMJSON, который не следует изменять.
Свойства `this.mods` для блока и `this.elemMods` для элемента содержат текущие значения модификаторов и не могут быть `undefined`.

__Было:__

```javascript
// domik.bemhtml.js
block('domik').match(function() { return !Object(this.ctx.mods).logo; })(
    def()(function() {
        // …
    })
);
```

__Стало:__

```javascript
// domik.bemhtml.js
block('domik').match(function() { return !this.mods.logo; })(
    def()(function() {
        // …
    })
);
```

* Для применения шаблонов на элемент с модификатором, вместо `mod()` следует использовать `elemMod()`.

__Было:__

```javascript
// block__elem_mod_val.bemhtml.js
block('block').elem('elem').mod('mod', 'val').tag()('span');
```

__Стало:__

```javascript
// block__elem_mod_val.bemhtml.js
block('block').elem('elem').elemMod('mod', 'val').tag()('span');
```

* Поле `attrs` теперь [по другому](https://github.com/bem/bem-xjst/releases/tag/v4.3.3) обрабатывает булевы значения атрибутов.
Раньше значение `true` приводилось к строке `"true"`, теперь оно означает булев атрибут без значения.
Обратите внимание, `aria`-атрибуты принимающие значения `true` или `false`
(c характеристикой [Value](https://www.w3.org/TR/wai-aria/states_and_properties#propcharacteristic_value_header)
равной `true/false`, `tristate` или `true/false/undefined`) надо указывать в строковой форме.

__Было:__

```javascript
// *.bemjson.js
({
    tag: 'button',
    attrs: {disabled: 'disabled', 'aria-hidden': true},
    content: 'Кнопка'
})
```

```html
<!-- *.html -->
<button disabled="disabled" aria-hidden="true">Кнопка</button>
```

__Стало:__

```javascript
// *.bemjson.js
({
    tag: 'button',
    attrs: {disabled: true, 'aria-hidden': 'true'},
    content: 'Кнопка'
})
```

```html
<!-- *.html -->
<button disabled aria-hidden="true">Кнопка</button>
```

### [Обновление bh до 4.x](https://st.yandex-team.ru/ISL-2610)

Прекращена поддержка `bh 3.x`.
Список изменений в `bh` 4.x можно посмотреть в [changelog](https://github.com/bem/bh/blob/master/CHANGELOG.ru.md).
Практика показывает, что обновление должно пройти безболезненно.

### [Обновление jQuery до 2.x](https://st.yandex-team.ru/ISL-2613)

В `islands` была добавлена поддержка `jQuery` 2.x.

Мы рекомендуем вам обновить версию `jQuery` до 2.2.3, эта версия используется при тестировании `islands`.
Для IE8 следует использовать `jQuery` 1.8.3 через условные комментарии.

Т.к. мы продолжаем использовать `jQuery` 1.8.3 для тестирования в IE8, вам не обязательно обновлять `jQuery` одновременно с
`islands`. Однако, нужно учесть что мы прекратим поддержку `jQuery` 1.8.3 в будущем, когда (мы надеемся)
доля использования IE8 станет ничтожной.

__Было:__

```javascript
// *.bemjson.js
({
    block: 'b-page',
    content: [
        // …
        {
            elem: 'cc',
            condition: 'IE 8',
            content: {elem: 'js', url: 'https://yastatic.net/es5-shims/0.0.2/es5-shims.min.js'}
        },
        {block: 'i-jquery', mods: {version: 'default'}}
        // …
    ]
})
```

__Стало:__

```javascript
// *.bemjson.js
({
    block: 'b-page',
    content: [
        // …
        {
            elem: 'cc',
            condition: 'IE 8',
            content: [
                {elem: 'js', url: 'https://yastatic.net/es5-shims/0.0.2/es5-shims.min.js'},
                {block: 'i-jquery', mods: {version: '1.8.3'}}
            ]
        },
        {
            elem: 'cc',
            condition: 'gt IE 8',
            others: true,
            content: {block: 'i-jquery', mods: {version: 'default'}}
        }
        // …
    ]
})
```

### [Удаление i-bem__html](https://st.yandex-team.ru/ISL-2484)

В `islands` 5.0 больше не поддерживается компилятор `bem-xjst` версии 1.x.
Поэтому из блока `i-bem` был удален элемент `html`, который содержал базовые шаблоны для `bem-xjst` версии 1.x.
Также были удалены все зависимости от него в других блоках.

Если вы на проекте все еще используете `bem-xjst` 1.x, обновите его до последней версии следуя
[инструкции по миграции](https://github.yandex-team.ru/lego/islands/blob/v4.13.0/releases/4.0.0-migration.md#Конвертация-шаблонов-в-новый-js-синтаксис).

## Работа с булевыми модификаторами

Версия `i-bem` из `islands` не поддерживает «честные» булевы модификаторы.
Для эмуляции булевых модификаторов используется следующее соглашение:
* Модификатор устанавливается с помощью `.setMod(modName, 'yes')`.
* Модификатор удаляется с помощью `.delMod(modName)`.
* Значение модификатора проверяется с помощью `.hasMod(modName)`.

Любое значение булевого модификатора отличное от пустой строки будет восприниматься библиотекой как `true`.
Это соглашение должно упростить добавление поддержки булевых модификаторов в будущем мажорном релизе.

Мы планируем сделать булевыми ряд модификаторов отвечающих за состояние (`disabled`, `hovered`, `pressed`, `checked` и т.д.).
Если вы на уровне проекта определяли для этих модификаторов дополнительные значения (например `no`, `transition`),
вынесите их в отдельный модификатор или попробуйте переписать проектную логику без них.

## Ручная установка модификатора theme

В `islands` 5.0 мы удалили логику выставления по умолчанию модификатора `theme` в значение `normal` в шаблонах [ряда блоков](#theme-blocks).
В предыдущих версиях `islands` тема оформления некоторых блоков выставлялась по умолчанию.

Практика использования данной логики показала ее ошибочность по следующим причинам:
- В сборку всегда попадают стили для темы по умолчанию, даже если она не используется на сервисе.
- Для вложенного блока иногда удобнее задавать стили не в собственном модификаторе `theme`, а, например, в элементе родительского блока.
В этом случае придется переопределять стили темы по умолчанию, либо устанавливать модификатору `theme` значение-заглушку (`theme_fake`).

Теперь для правильной работы этих блоков необходимо самостоятельно в BEMJSON установить значение для модификатора `theme`,
а также добавить зависимости от модификатора на проектном уровне.

Если при обновлении `islands` внести эти изменения на сервис проблематично, и они блокируют переход,
можно временно перенести логику про автоматическую установку модификатора на проектный уровень:

```javascript
// some-block.bemhtml.js
block('some-block').match(function() { return !this.mods.theme; }).def()(function() {
    return applyNext({'mods.theme': 'normal'});
});

// some-block.bh.js
bh.match('some-block', function(ctx) {
    ctx.mod('theme', 'normal');
});

// some-block.deps.js
({
    shouldDeps: [
        {mods: {theme: 'normal'}}
    ]
})
```

<a name="theme-blocks"></a>
Подробнее смотрите в разделах про соответствующие блоки:

- [button](#button)
- [check-button](#check-button)
- [checkbox](#checkbox)
- [link](#link)
- [radio-button](#radio-button)
- [radiobox](#radiobox)
- [tabs](#tabs)
- [tumbler](#tumbler)

## Мажорное

Список блоков, в которых произошли изменения, ломающие обратную совместимость:

- [auth](#auth)
- [b-page](#b-page)
- [b-statcounter](#b-statcounter)
- [button](#button)
- [checkbox](#checkbox)
- [check-button](#check-button)
- [dropdown2](#dropdown2)
- [dropdown](#dropdown)
- [header2](#header2)
- [i-common__string](#i-common__string)
- [i-counter](#i-counter)
- [i-geolocation](#i-geolocation)
- [input](#input)
- [i-request-animation-frame](#i-request-animation-frame)
- [i-services](#i-services)
- [i-ua](#i-ua)
- [lang-switcher](#lang-switcher)
- [link](#link)
- [link_pseudo_yes](#link_pseudo_yes)
- [logo](#logo)
- [popup](#popup)
- [radiobox](#radiobox)
- [radio-button](#radio-button)
- [search2](#search2)
- [share-dropdown](#share-dropdown)
- [slider](#slider)
- [social-broker](#social-broker)
- [suggest2-item](#suggest2-item)
- [tabs](#tabs)
- [tooltip](#tooltip)
- [tumbler](#tumbler)

<a name="header2"></a>

### [header2](https://st.yandex-team.ru/ISL-2544)

В шапке был сделан ряд обратно несовместимых изменений, чтобы упростить верстку и уменьшить размер статики.

#### header2_layout_simple

Раскладка из модификатора `layout_simple` теперь применяется по умолчанию, а сам модификатор `layout` удален.

__Было:__

```
Раскладка:

╒═header2═══════════════════════════════╕
│╒__main═══════════════════════════════╕│
││╒══════╕╒═__middle═══════════╕╒═════╕││
│││      ││╒═__middle-wrap════╕││     │││
│││      │││╒══════╕ ╒═══════╕│││     │││
│││__logo││││__left│ │__right││││__nav│││
│││      │││~~~~~~~~~~~~~~~~~~│││     │││
│││      ││││__websearch│     │││     │││
│└┴──────┴┴┴┴───────────┴─────┴┴┴─────┴┘│
│╒═════════════════════════════════════╕│
││                __under              ││
└┴─────────────────────────────────────┴┘
```

```javascript
// *.bemjson.js
({
    block: 'header2',
    // Поле logo можно не указывать, т.к. логотип добавляется автоматически. Язык логотипа определяется локалью BEM.I18N
    websearch: {block: 'search2', template: 'websearch'},
    left: {elem: 'nameplate'},
    right: {elem: 'action', mods: {type: 'settings'}},
    nav: {block: 'user'}
})

// *.deps.js
({
    // Элемент logo раньше был обязательным.
    shouldDeps: {elems: ['left', 'right', 'websearch', 'nav', 'under']}
})
```

__Стало:__

```
Раскладка:

╒═header2═════════════════════════╕
│╒═__main════════════════════════╕│
││╒══════╕╒════════════╕╒═══════╕││
│││__logo││__left      ││__right│││
│└┴──────┴┴────────────┴┴───────┴┘│
│╒═══════════════════════════════╕│
││           __under             ││
└┴───────────────────────────────┴┘
```

```javascript
// *.bemjson.js
({
    block: 'header2',
    logo: {elem: 'logo', elemMods: {preset: 'ru'}}, // Элемент logo теперь нужно передавать явно.
    // Поле websearch использовать не следует, желтая стрелка должна быть только на поисковых сервисах.
    left: {elem: 'nameplate'},
    right: [
        {
            block: 'button2', // Вместо элемента action следует использовать блок button или button2
            mods: {size: 'head', theme: 'clear'}, // с модификаторами size_head, theme_clear
            icon: {
                // Иконки для header2__action_type_filter, header2__action_type_settings, header2__action_type_tableau
                // были перенесены в icon_action_filter, icon_action_settings, icon_actione_tableau
                mods: {action: 'settings'}
            }
        },
        {elem: 'gap'}, // Отступ между кнопкой и аватаром пользователя.
        {block: 'user'}
    ]
})

// *.deps.js
({
    // Элемент logo теперь опциональный, а left — обязательный.
    shouldDeps: {elems: ['logo', 'right', 'under']}
})
```

#### header2_panels_yes

У блока `header2` изначально был JS API, который позволял внешним компонентам переключать виртуальные панели,
относящиеся к шапке, и реагировать на переключение панелей. На практике этим механизмом пользовались редко.
В `islands` 4.x, чтобы дать возможность не подключать лишний JS, API было вынесено в модификатор `panels_yes`.
Чтобы не ломать обратную совместимость тем, кто это механизм использовал, модификатор устанавливался в шаблонах блока автоматически,
если в BEMJSON не установлено поле `disablePanels: true`.
В `islands` 5.0 модификатор больше не добавляется в зависимости и не устанавливается автоматически.

Если вы используете у себя на проекте JS API блока (событие `panel-switch` или один из методов `getOpenedPanel()`,
`openPanel()`, `closePanel()`, `togglePanel()`), установите  модификатор `panels_yes` в BEMJSON  и добавьте его в зависимости блока.

#### header2__logo

Логотип в шапке больше не отображается по умолчанию. Теперь блок `logo` следует передавать в BEMJSON в поле `logo`.
Чтобы логотип правильно позиционировался, его следует оборачивать в элемент `logo`.
Если нужен стандартный русскоязычный или англоязычный логотип, можно установить элементу `logo` модификатор
`preset` со значением `ru` или `en` и добавить его в зависимости.

<a name="search2"></a>

### [search2](https://st.yandex-team.ru/ISL-2544)

Для формирования желтой поисковой стрелки в `search2_theme_websearch` используются блоки `input` и `button`/`button2`
с модификатором `theme_websearch`. Раньше для них следовало указывать модификатор `size_m`. Теперь для поисковой стрелки
используется специальный размер `ws-head`. Для обратной совместимости в шаблоны модификаторов `theme_websearch` для
блоков `input` и `button` была добавлена логика автоматически меняющая значение `size` с `m` на `ws-head`.

Теперь эта логика удалена, в BEMJSON блока нужно явно установить модификатор `size_ws-head` и добавить его в зависимости.

Блоку `search2` больше автоматически не устанавливается модификатор `theme_websearch`, если в поле `input` или `button`
передан блок с модификатором `theme_websearch`. Его нужно явно установить в BEMJSON блока и добавить в зависимости.

Из модификатора `theme_websearch` блока `input` удален стиль устанавливающий цвет элемента `hint`. Если вы его используете,
задайте [стиль](https://github.yandex-team.ru/lego/islands/blob/v4.13.0/common.blocks/input/_theme/input_theme_websearch.css#L32-L35)
на своем уровне.

Модификатор `template_websearch` теперь по умолчанию генерирует кнопку с помощью блока `button2` вместо `button`.

Чтобы использовать поисковую стрелку в `islands` 5.0, нужно сделать следующее:
* Установить у `input_theme_websearch` и `button_theme_websearch` модификатор `size_ws-head`.
* Установить блоку `search2` модификатор `theme_websearch`.

__Было:__

```javascript
// *.bemjson.js
({
    block: 'search2',
    input: {
        block: 'input',
        mods: {size: 'm', theme: 'websearch'}
    },
    button: {
        block: 'button2',
        mods: {type: 'submit', size: 'm', theme: 'websearch'},
        attrs: {tabindex: -1},
        text: 'Найти'
    }
})
```

__Стало:__

```javascript
// *.bemjson.js
({
    block: 'search2',
    mods: {theme: 'websearch'},
    input: {
        block: 'input',
        mods: {size: 'ws-head', theme: 'websearch'}
    },
    button: {
        block: 'button2',
        mods: {type: 'submit', size: 'ws-head', theme: 'websearch'},
        attrs: {tabindex: -1},
        text: 'Найти'
    }
})
```

<a name="input"></a>

### input

#### [input__hint](https://st.yandex-team.ru/ISL-2710)
Элемент `hint` блока `input` заменен полем `placeholder`.

Элемент `hint` может использоваться только для совместимости со старыми версиями браузеров,
которые не поддерживают атрибут `placeholder`. Если на вашем проекте необходимо поддерживать IE8, укажите значение
элементу `hint` через BEMJSON-поле `placeholder` и добавьте элемент `hint` в зависимости блока.

Обратите внимание, что в IE11+ нативный `placeholder` не отображается при фокусе.

__Было:__

```javascript
// *.bemjson.js
({
    block: 'input',
    mods: {theme: 'normal', size: 'm'},
    content: [
        {elem: 'hint', content: 'Подсказка'},
        {elem: 'control'}
    ]
})
```

__Стало:__

```javascript
// *.bemjson.js
({
    block: 'input',
    mods: {theme: 'normal', size: 'm'},
    placeholder: 'Подсказка',
    content: [
        {elem: 'control'}
    ]
})
```

<a name="input_poll_yes"></a>

#### [input_poll_yes](https://st.yandex-team.ru/ISL-2571)

В блоке `input` удалена зависимость от блока `i-system`.

На уровне `desktop` значение всех блоков `input` на странице синхронизировалось со значением внутреннего контрола по
событию `tick` блока `i-system` каждые 50мс. Отказ от использования этой логики позволяет уменьшить расход памяти браузера
и улучшить отзывчивость страницы.

Теперь значение блока синхронизируется по событию `input` (с полифиллами для IE8, IE9 и Оpera12).
Логика синхронизации по событию `tick` вынесена в модификатор `poll_yes` и теперь находится на уровне `common`.

Использование модификатора `poll_yes` целесообразно только в нескольких случаях:
* Чтобы отслеживать значение поля формы. Во многих браузерах можно
отследить изменение поля при использовании браузерного автозаполнения только с помощью частого опроса.
* Чтобы отслеживать значение блока `input`, когда значение его внутреннего контрола может изменяться программно, например
с помощью стороннего плагина `jQuery`.

Если на вашем проекте нужно реализовать перечисленное выше поведение, точечно добавьте модификатор `poll_yes` нужным блокам.

<a name="radio-button"></a>

### [radio-button](https://st.yandex-team.ru/ISL-2504)

В шаблонах блока `radio-button` модификатор `theme` больше не устанавливается по умолчанию в значение `normal`.
Его нужно вручную указать в BEMJSON и добавить в зависимости, или перенести логику автоматической установки темы на проектный уровень.

<a name="radiobox"></a>

### [radiobox](https://st.yandex-team.ru/ISL-2663)

В шаблонах блока `radiobox` модификатор `theme` больше не устанавливается по умолчанию в значение `normal`.
Теперь его нужно явно указывать в BEMJSON блока и добавлять в зависимости. При необходимости логику автоматической установки темы можно перенести на проектный уровень.

<a name="check-button"></a>

### [check-button](https://st.yandex-team.ru/ISL-2491)

В блоке `check-button` удален модификатор `pseudo`, который использовался только для установки блоку модификатора `theme`
в значение `pseudo` и задавал пустое значение для `value`.

Теперь значение `pseudo` для модификатора `theme` нужно задавать явно в BEMJSON блока и добавлять в зависимости.
При необходимости логику автоматической установки темы можно перенести на проектный уровень.

Событие `change` для блока `check-button` стало генерироваться синхронно, то есть отправляться в том же тике.
Если вам нужно, чтобы реакция происходила в следующем тике, оберните логику внутри своего обработчика `change` в `afterCurrentEvent()`.

Также удалена логика установки модификатора `checked_yes` по нажатию **Enter**.
Это поведение не соответствует нативному поведению браузеров.

<a name="checkbox"></a>

### [checkbox](https://st.yandex-team.ru/ISL-2492)

Удалена схема с комбинированными данными в поле `content` и поле теперь никак не модифицируется.
Теперь нужно либо передавать весь `content` в конечном виде, либо использовать поля `box`, `text`,
`control` для доопределения ключевых элементов `box`, `label`, `control` соответственно, а также
поле `checkboxAttrs` для задания атрибутов элемента `control`.

В шаблонах блока `checkbox` модификатор `theme` больше не устанавливается по умолчанию в значение `normal`.
Теперь его нужно явно указывать в BEMJSON блока и добавлять в зависимости. При необходимости логику автоматической установки темы можно перенести на проектный уровень.

Изменился способ установки модификатора `checked`. Теперь он выставляется только блоку. Ранее он выставлялся и элементу `box`.
Событие `change` для блока `checkbox` стало генерироваться синхронно, то есть отправляться в том же тике.
Если вам нужно, чтобы реакция происходила в следующем тике, оберните логику внутри своего обработчика `change` в `afterCurrentEvent()`.

<a name="button"></a>

### [button](https://st.yandex-team.ru/ISL-2490)

В шаблонах блока `button` модификатор `theme` больше не устанавливается по умолчанию в значение `normal`.
Его нужно вручную указать в BEMJSON и добавить в зависимости, или перенести логику автоматической установки темы на проектный уровень.

Также, из-за перехода на [pointerevents], из блока удалена поддержка `FastClick`.
Если вам на сервисе нужно использовать `FastClick`, добавьте следующее доопределение на проектный уровень:

```javascript
// button.js
BEM.DOM.decl('button', {}, {
    live: function() {
        this.__base.apply(this);
        this.liveBindTo('click', function(e) {
            var isPseudoTypeLink = (this.hasMod('pseudo', 'yes') && this._href);

            if(this.isDisabled() || isPseudoTypeLink) {
                e.preventDefault();
            }
        });
    }
});
```

Это доопределение позволит кнопке обрабатывать синтетическое событие `click`, которое генерирует `FastClick`, и предотвращать стандартные
действия в заблокированном состоянии.

<a name="link"></a>

### [link](https://st.yandex-team.ru/ISL-2503)

В шаблонах блока `link` модификатор `theme` больше не устанавливается по умолчанию.
Раньше, при отсутствии явно заданного модификатора `theme` в BEMJSON блока, тема по умолчанию выставлялась следующим образом:
- `pseudo` при наличии модификатора `pseudo_yes`;
- `outer` при наличии модификатора `outer_yes`;
- `normal` в остальных случаях.

Теперь соответствующий модификатор `theme` нужно вручную указать в BEMJSON и добавить в зависимости,
или перенести логику автоматической установки темы на уровень проекта.
Кроме того, модификатор `outer_yes` удален, так как не содержал другой логики кроме установки темы.
Используйте вместо него `theme_outer`.

__Было:__

```javascript
// *.bemjson.js
[
    {block: 'link', url: 'https://ya.ru', text: 'Просто ссылка'},
    {block: 'link', mods: {outer: 'yes'}, url: 'https://example.com', text: 'Внешняя ссылка'},
    {block: 'link', mods: {pseudo: 'yes'}, text: 'Псевдоссылка'}
]
```

__Стало:__

```javascript
// *.bemjson.js
[
    {block: 'link', mods: {theme: 'normal'}, url: 'https://ya.ru', text: 'Просто ссылка'},
    {block: 'link', mods: {theme: 'outer'}, url: 'https://example.com', text: 'Внешняя ссылка'},
    {block: 'link', mods: {theme: 'pseudo', pseudo: 'yes'}, text: 'Псевдоссылка'}
]
```

БЭМ-событие `click` на `link_pseudo_yes` теперь генерируется синхронно по событию `keyup` для клавиши **Space**.
Если вам нужно, чтобы реакция на клик происходила в следующем тике, оберните логику внутри своего обработчика `click` в `afterCurrentEvent()`.

`link_pseudo_yes` больше не вызывает `e.preventDefault()` внутри обработчика DOM-события `click`. Переход по ссылке
предотвращается в обработчике `pointerclick`, но могут возникнуть проблемы с библиотекой `FastClick`.
Если вам на сервисе нужно использовать `islands` совместно с `FastClick`, перенесите
[эту логику](https://github.yandex-team.ru/lego/islands/blob/v4.13.0/common.blocks/link/_pseudo/link_pseudo_yes.js#L71-L74)
на проектный уровень.

Удален JS-параметр `origTabindex`, который использовался для хранения `tabindex` для ссылок с модификатором `disabled`.
Этот параметр приватный, но если по каким-то причинам вы использовали его на проекте, используйте вместо него параметр `_tabindex`.

Удалены стили, которые каскадно применялись к блоку `image` внутри `link_inner_yes`.
Для использования иконки внутри ссылки следует использовать поле `icon` или примиксовать `link__icon` к `image`.
Элемент `icon` стал выравниваться не по центру, а по базовой линии иконки.

<a name="link_pseudo_yes"></a>

#### [link_pseudo_yes](https://st.yandex-team.ru/ISL-2673)

Чтобы активировать псевдо-ссылки с клавиатуры, больше не проверяется активность клавиш-модификаторов (`Shift`, `Ctrl`,
`Alt`, `Meta/Super/Cmd`). БЭМ-событие `click` будет генерироваться даже при зажатых клавишах-модификаторах.

На уровне сервиса, при обработке события `click`, нужно проверять не была ли зажата клавиша-модификатор и в этом случае
отменять действие. Для проверки используйте поле `isModKey` в объекте данных БЭМ-события.

```javascript
this.findBlockInside({block: 'link', modName: 'pseudo', modVal: 'yes'}).on('click', function(e, data) {
    if (data.isModKey) {
        return;
    }
    // …
});
```
<a name="tabs"></a>

### [tabs](https://st.yandex-team.ru/ISL-2618)

Блок `tabs` с модификатором `control_buttons` передаёт свои модификаторы блоку `radio-button`. Так как теперь
модификатор `theme` для `radio-button` является [обязательным](#radio-button),
то для блока `tabs` с модификатором `control_buttons` следует явно установить модификатор `theme` и добавить в зависимости.

__Было:__

```javascript
// *.bemjson.js
({
    block: 'tabs',
    mods: {
        control: 'buttons',
        size: 'm'
    },
    content: [
        // …
    ]
})
```

__Стало:__

```javascript
// *.bemjson.js
({
    block: 'tabs',
    mods: {
        control: 'buttons',
        size: 'm',
        theme: 'normal'
    },
    content: [
        // …
    ]
})
```

<a name="i-ua"></a>

### i-ua

Часть JS-кода была вынесена из блока `i-ua` в элементы.

#### [i-ua__retina](https://st.yandex-team.ru/ISL-2245)

Шаблоны `i-ua__retina` добавляют на страницу JS-код, который выставляет на `<html>` класс `i-ua_retina_yes`
в момент загрузки страницы, если пиксельное соотношение ([pixel ratio](https://pepelsbey.net/pres/clear-and-sharp/#21))
больше единицы.
В JS-коде блока `i-ua` была дублирующая логика, которая выставляла на `<body>` класс `i-ua_hi-dpi_yes` и дополнительно
устанавливала на блок `i-ua` статические свойства `dpr` — числовое значение пиксельного соотношения,
и `hiDpi` — булев флаг выставляющийся при `dpr` > 1.

Эта логика из JS-кода блока была перенесена в элемент `retina`. Если вы на сервисе используете в JS-коде блоков
`BEM.blocks['i-ua'].hiDpi` или `BEM.blocks['i-ua'].dpr`, добавьте в зависимости элемент `i-ua__retina` на проектном уровне.

Класс `i-ua_hi-dpi_yes` больше не выставляется, вместо него следует использовать `i-ua_retina_yes`.

__Было:__

```javascript
// some-block.deps.js
({
    mustDeps: [
        {block: 'i-bem', elem: 'dom'},
        {block: 'i-ua'}
    ]
})
```

```css
/* some-block.css */
.i-ua_hi-dpi_yes .some-block {
    background-image: url(hires.png);
}
```

__Стало:__

```javascript
// some-block.deps.js
({
    mustDeps: [
        {block: 'i-bem', elem: 'dom'},
        {block: 'i-ua', elem: 'retina'}
    ]
})
```

```css
/* some-block.css */
.i-ua_retina_yes .some-block {
    background-image: url(hires.png);
}
```

#### [i-ua__orient](https://st.yandex-team.ru/ISL-2605)

Шаблоны `i-ua__orient` добавляют на страницу JS-код, который в момент загрузки страницы выставляет на `<html>`
класс `i-ua_orient_portrait` или `i-ua_orient_landscape`, в зависимости от ориентации экрана устройства.
В JS-коде блока `i-ua` была дублирующая логика, которая выставляла на `<body>` аналогичные классы и дополнительно
устанавливала на блок `i-ua` статические свойства `height` — высота страницы, `width` — ширина страницы
и `landscape` — флаг выставляющийся при `width` > `height`.

Эта логика была перенесена из блока в элемент `orient`. Если вы используете в JS-коде блоков
`BEM.blocks['i-ua'].height`, `BEM.blocks['i-ua'].width` или `BEM.blocks['i-ua'].landscape`,
добавьте в зависимости элемент `i-ua__orient`.

Модификатор `orient` у блока `i-ua` находящегося на элементе `<body>` больше не выставляется.
Используйте вместо него свойство `landscape` в статической секции: `BEM.blocks['i-ua'].landscape`.

__Было:__

```javascript
// some-block.deps.js
({
    mustDeps: [
        {block: 'i-bem', elem: 'dom'},
        {block: 'i-ua'}
    ]
})

// some-block.js
BEM.DOM.decl('some-block', {
    onSetMod: {
        js: {
            inited: function() {
                var orient = this.findBlockOutside('i-ua').getMod('orient');
            }
        }
    }
});
```

```css
/* some-block.css */
body.i-ua_orient_portrait .some-block {
    display: block;
}
```

__Стало:__

```javascript
// some-block.deps.js
({
    mustDeps: [
        {block: 'i-bem', elem: 'dom'},
        {block: 'i-ua', elem: 'orient'}
    ]
})


// some-block.js
BEM.DOM.decl('some-block', {
    onSetMod: {
        js: {
            inited: function() {
                var orient = BEM.blocks['i-ua'].landscape ? 'landscape' : 'portrait';
            }
        }
    }
});
```

```css
/* some-block.css */
.i-ua_orient_portrait .some-block {
    display: block;
}
```

<a name="i-request-animation-frame"></a>

### [i-request-animation-frame](https://st.yandex-team.ru/ISL-2500)

Блок `i-request-animation-frame` был удален. В нем содержались полифиллы для функций `requestAnimationFrame()` и `cancelAnimationFrame()`.
Функциональность блока была перенесена в элемент `request-animation-frame` блока `polyfill`.
Если вам нужна функциональность `i-request-animation-frame`, поправьте зависимости.

__Было:__

```javascript
// *.deps.js
({
    shouldDeps: [
        {block: 'i-request-animation-frame'}
    ]
})
```

__Стало:__

```javascript
// *.deps.js
({
    shouldDeps: [
        {block: 'polyfill', elem: 'request-animation-frame'}
    ]
})
```

<a name="logo"></a>

### [logo](https://st.yandex-team.ru/ISL-2562)

В блоке `logo` удален устаревший элемент `link`. Он реализовывал ссылку на логотипе, которая вела на главную страницу Яндекса.
Если вы применяли к нему какие-то стили или шаблоны, теперь вам нужно применять их непосредственно к блоку `logo` с модификатором `type_link`.

Удален устаревший модификатор `lang`, который больше не используется в `islands`.
Он содержал фиксированный набор логотипов для поддерживаемых языков (кириллический и латиницей).
Сейчас для создания логотипа может использоваться любое изображение произвольного размера.
Идентификатор картинки задается с помощью модификатора [`name`](https://github.yandex-team.ru/lego/islands/tree/v4.13.0/common.blocks/logo/_name).

Модификаторам `lang_ru` и `lang_en` соответствуют модификаторы `logo_name_ru-84x36` и `logo_name_en-84x36`.
Изображения были оптимизированы, поэтому тесты скриншотами могут показывать отличия в пределах пикселя.
Скриншоты нужно будет обновить.

В блоке было удалено устаревшее поле `alt`. Теперь, чтобы задать альтернативный текст для логотипа, используйте поле `text`.
В новой реализации текст не виден пользователю (text-indent: 100%) и предназначается для нужд SEO или программ экранного доступа.

__Было:__

```javascript
// *.bemjson.js
({
    block: 'logo',
    alt: 'Yandex',
    mods: { lang: 'en' },
    content: { elem: 'link', url: 'https://ya.ru/' }
})
```

__Стало:__

```javascript
// *.bemjson.js
({
    block: 'logo',
    text: 'Yandex',
    url: 'https://ya.ru/',
    mods: { type: 'link', name: 'en-84x36' }
})
```
<a name="tumbler"></a>

### [tumbler](https://st.yandex-team.ru/ISL-2508)

Модификатор `theme_normal` перестал автоматически устанавливаться в шаблонах.
Его нужно вручную указать в BEMJSON и добавить в зависимости, или перенести логику автоматической установки темы на проектный уровень.

В блоке `tumbler` были удалены следующие устаревшие методы:

* `.toggle()`, используйте вместо него `.toggleMod('checked', 'yes')`;
* `.uncheck()`, используйте вместо него `.delMod('checked')`;
* `.check()`, используйте вместо него `.setMod('checked', 'yes')`;
* `.isChecked()`, используйте вместо него `.hasMod('checked')`;
* `.isDisabled()`, используйте вместо него `.hasMod('disabled')`.

<a name="social-broker"></a>

### [social-broker](https://st.yandex-team.ru/ISL-2507)

В блоке `social-broker` были удалены следующие устаревшие статические методы:

* `start()` — запускал процесс авторизации на сервисах Яндекса. Теперь вместо него используйте метод `start()` экземпляра блока.
* `onSuccess()` и `onFailure()` — приватные методы, использовать их не следует. Теперь вместо них вызываются одноименные методы экземпляра блока.

__Было:__
```javascript
BEM.blocks['social-broker'].start();
```

__Стало:__
```javascript
BEM.create('social-broker').start();
```

<a name="dropdown2"></a>

### [dropdown2](https://st.yandex-team.ru/ISL-2496)

Шаблоны блока `dropdown2` пробрасывали модификатор `theme` на внутренний попап (блок `popup2`) и блок-переключатель
(`button2`, `button`, `link`). Это неудобно, в случаях когда попапу и переключателю нужно установить разные темы.

Теперь тема пробрасывается только блоку-переключателю. Для `popup2` по умолчанию устанавливается модификатор `theme_normal`.
Если есть необходимость передать тему для попапа отличающуюся от стандартной, ее можно задать через поле `popup`.

__Было:__

```javascript
// *.bemjson.js
({
    block: 'dropdown2',
    mods: {switcher: 'button2', size: 's', theme: 'custom'},
    switcher: 'Open',
    popup: 'Popup content'
})
```

__Стало:__

```javascript
// *.bemjson.js
({
    block: 'dropdown2',
    mods: {switcher: 'button2', size: 's', theme: 'custom'},
    switcher: 'Open',
    popup: {mods: {theme: 'custom'}, content: 'Popup content'}
})
```

<a name="b-statcounter"></a>

### [b-statcounter](https://st.yandex-team.ru/ISL-2488)

У блока `b-statcounter` удалены устаревшие элементы `services` и `statface`.

Элемент `services` позволял по ID сервиса из `i-global` получать код для счетчиков `metrika` и `gemius`.
Теперь код сервиса нужно передавать явно. Если вы использовали эту функциональность у себя на проекте,
найдите код своего счетчика [в шаблоне элемента services](https://github.yandex-team.ru/lego/islands/blob/v4.13.0/common.blocks/b-statcounter/__services/b-statcounter__services.bemhtml.js)
и подставьте его в BEMJSON.

__Было:__

```javascript
// *.bemjson.js
[{
    block: 'i-global',
    params: {'id': 'yaca'}
}, {
    block: 'b-statcounter',
    content: [
        {
            elem: 'metrika',
            elemMods: {type: 'js'}
        },
        {
            elem: 'gemius',
            elemMods: {type: 'js'},
            _country: 'ua'
        }
    ]
}]
```

__Стало:__

```javascript
// *.bemjson.js
({
    block: 'b-statcounter',
    content: [
        {
            elem: 'metrika',
            elemMods: {type: 'js'},
            counter: '722622'
        },
        {
            elem: 'gemius',
            elemMods: {type: 'js'},
            _country: 'ua',
            ua: '.FrlPTvzySxDTKT5eBSikpPaP32ip3uUOimQNx41b7n.27'
        }
    ]
})
```

Элемент `statface` содержал единственный модификатор `rstat`, который раньше использовался для нужд проекта
[antirobot](https://wiki.yandex-team.ru/jandekspoisk/sepe/antirobotonline/). Если вы его используете, перенесите
[код элемента](https://github.yandex-team.ru/lego/islands/blob/v4.13.0/common.blocks/b-statcounter/__statface/_type/b-statcounter__statface_type_rstat.js)
на свой проектный уровень.

<a name="i-common__string"></a>

### [i-common__string](https://st.yandex-team.ru/ISL-1142)

Из элемента `string` блока `i-common` удален статический метод `highlight()`.
Он был перенесен по месту использования в статическую секцию блока `b-autocomplete-item`.

Если метод нужен на вашем проекте, то вы можете скопировать
[его код](https://github.yandex-team.ru/lego/islands/blob/v4.13.0/common.blocks/i-common/__string/i-common__string.js#L64-L137)
на проектный уровень.

<a name="i-counter"></a>

### [i-counter](https://st.yandex-team.ru/ISL-2498)

Из блока `i-counter` удален устаревший метод `Lego.ch()`, который использовался для сбора статистики по шапке.
Если вам необходима эта функциональность, скопируйте
[код счетчика](https://github.yandex-team.ru/lego/islands/blob/v4.13.0/common.blocks/i-counter/i-counter.js#L129-L149)
на уровень проекта.

<a name="lang-switcher"></a>

### [lang-switcher](https://st.yandex-team.ru/ISL-2502)

Из блока `lang-switcher` была удалена логика определения языка пользовательского интерфейса по региону пользователя.
Она была временно скопирована сюда из блока `i-geodata`, удаленного еще в `islands` 4.0.
Теперь необходимо вместо кода региона явно передавать идентификатор языка `lang`.

__Было:__

```javascript
// *.bemjson.js
({
    block: 'lang-switcher',
    lang: {code: 'ru', name: 'Ru'},
    content: [
        {
            elem: 'lang',
            lang: {langCode: 'en', name: 'En'}
        }
    ]
})
```

__Стало:__

```javascript
// *.bemjson.js
({
    block: 'lang-switcher',
    lang: {lang: 'ru', name: 'Ru'},
    content: [
        {
            elem: 'lang',
            lang: {lang: 'en', name: 'En'}
        }
    ]
})
```

Блок больше не принимает JS-параметры `secret-key`, `tune` и `retpath`.
Вместо них используйте одноименные BEMJSON-поля. Обратите внимание, что поле `secret-key` переименовано в `secretKey`.

__Было:__

```js
// *.bemjson.js
({
    block: 'lang-switcher',
    js: {
      tune: 'https://tune.yandex.com.tr',
      retpath: 'https://example.yandex.com.tr',
      'secret-key': 'my-secret'
    }
    // …
})
```

__Стало:__

```js
// *.bemjson.js
({
    block: 'lang-switcher',
    tune: 'https://tune.yandex.com.tr',
    retpath: 'https://example.yandex.com.tr',
    secretKey: 'my-secret'
    // …
})
```

<a name="i-geolocation"></a>

### [i-geolocation](https://st.yandex-team.ru/ISL-2285)

В блоке `i-geolocation` изменились коды ошибок — уменьшились на 1.
Теперь они соответствуют спецификации [Geolocation API](https://www.w3.org/TR/geolocation-API/#position_error_interface).

Раньше, если браузер не поддерживал Geolocation API – возвращался код 1, а все стандартные коды ошибок были увеличены на 1.
Теперь единица не прибавляется, а для браузеров без поддержки API возвращается код ошибки 0.

Чтобы JS-код блока для обработки ошибок работал правильно, вам необходимо заменить проверки вида `if(data.error)` на `if('error' in data)`.

В крайнем случае можно вернуть логику по увеличению кода ошибки на уровень проекта:

```javascript
// i-geolocation.js
BEM.DOM.decl('i-geolocation', {}, {
    get: function(params, callback) {
        if(arguments.length === 1) {
            callback = params;
            params = {};
        }
        return this.__base(params, function(data) {
            if('error' in data) {
                data.error++;
            }
            callback(data);
        });
    }
})
```

<a name="b-page"></a>

### [b-page](https://st.yandex-team.ru/ISL-2487)

Удален модификатор `theme_social`, содержавший устаревшие стили. Если вы по какой-то причине ими пользуетесь, скопируйте
[стили](https://github.yandex-team.ru/lego/islands/blob/v4.13.0/desktop.blocks/b-page/_theme/b-page_theme_social.css) на проектный уровень.

Зависимость от элемента `link` перенесена на `touch`-уровень. При необходимости укажите ее явно в декларации сборки
или в зависимостях блока `b-page` на своем проектном уровне.

<a name="auth"></a>

### [auth](https://st.yandex-team.ru/ISL-2486)

Удалены устаревшие статические методы
* `_getRetpath()` в пользу метода прототипа `getRetpath()`;
* `_getPassportURL()` в пользу одноименного приватного метода прототипа;
* `_getRegisterURL()` в пользу метода прототипа `getRegisterURL()`;
* `_getRememberURL()` в пользу метода прототипа `getRememberURL()`.

Если вы использовали эти методы у себя на проекте, замените их методы прототипа блока `auth`:

__Было:__

```javascript
// *.js
var auth = BEM.blocks.auth,
    retpath = auth._getRetpath(),
    register = auth._getRegisterURL(),
    remember = auth._getRememberURL();
```

__Стало:__

```javascript
// *.js
var auth = this.findBlockInside('auth'),
    retpath = auth.getRetpath(),
    register = auth.getRegisterURL(),
    remember = auth.getRememberURL();
```

В блоке `auth` для реализации кнопок «Войти», напоминания пароля, регистрации
теперь используется блок `button2`, вместо `button`.

__Было:__

```javascript
// *.bemjson.js
({
    block: 'auth',
    content: [
        // …
        {
            elem: 'button',
            content: {
                block: 'button',
                type: 'submit',
                mods: {theme: 'action', size: 'm'},
                content: 'Войти'
            }
        },
        {
            elem: 'remember',
            content: {
                block: 'button',
                mods: {theme: 'normal', size: 's'},
                content: 'Напомнить пароль'
            }
        },
        {
            elem: 'register',
            content: {
                block: 'button',
                mods: {theme: 'normal', size: 's'},
                text: 'Регистрация'
            }
        }
    ]
})
```

__Стало:__

```javascript
// *.bemjson.js
({
    block: 'auth',
    content: [
        // …
        {
            elem: 'button',
            content: {
                block: 'button2',
                mods: {type: 'submit', theme: 'action', size: 'm'},
                tabindex: 103,
                text: 'Войти'
            }
        },
        {
            elem: 'remember',
            content: {
                block: 'button2',
                mods: {theme: 'normal', size: 's'},
                tabindex: 104,
                text: 'Напомнить пароль'
            }
        },
        {
            elem: 'register',
            content: {
                block: 'button2',
                mods: {theme: 'normal', size: 's'},
                tabindex: 105,
                text: 'Регистрация'
            }
        }
    ]
})
```

<a name="dropdown"></a>

### [dropdown](https://st.yandex-team.ru/ISL-2495)

Блок `dropdown` теперь не принимает параметр `switcherBlock`. Когда-то давно он использовался для того чтобы найти
на текущем DOM-элементе блок, на котором нужно слушать БЭМ-событие `click`. В `islands` 3.x была допущена регрессия:
подписку на БЭМ-событие заменили на подписку на DOM-событие `click`. В итоге, при передаче параметра, `dropdown`
искал на своем DOM-элементе блок с заданным именем и возвращал его DOM-элемент, который почти всегда совпадает с изначальным
(кроме гипотетических случаев когда другой блок «размазан» на несколько DOM-элементов).

Так как жалоб на эту регрессию за более чем два года не было, а рядом в библиотеке есть блок `dropdown2` с
более удобным API, было решено просто убрать этот параметр. Удалите параметр `switcherBlock`, если вы его используете.

<a name="slider"></a>

### [slider](https://st.yandex-team.ru/ISL-2033)

В блоке `slider` модификатор `animation` в значении `yes` теперь выставляется синхронно в конструкторе.

### share-dropdown

#### [Правка API](https://st.yandex-team.ru/ISL-2505)

В объект `params`, который принимают методы `updateLink()` и `updateLinks()`, можно было передать свойство `service` —
идентификатор сервиса, который отправляется в ручку `share.yandex.ru/go.xml`. Его назначение не вполне понятно, т.к.
идентификатор для каждой ссылки в шаблонах записывается в атрибут `data-service` и не должен динамически меняться.
Скорее всего, свойство было добавлено по ошибке.

Теперь это свойство игнорируется, идентификатор сервиса всегда извлекается из `data-service`.

#### [Обновление иконок](https://st.yandex-team.ru/ISL-2266)

В блоке `share-dropdown` были актуализированы иконки для социальных сетей и увеличен их размер с `16×16` до `18×18` px.

Поменялось API блока: модификаторы элемента `share-item` вида `facebook_16` изменены на `service_facebook`.

Необходимо поправить файлы зависимостей. Остальное блок сделает сам.

__Было:__

```javascript
// *.deps.js
({
    shouldDeps: [{
        block: 'share-dropdown',
        elems: {elem: 'share-item', mods: {
            facebook: '16',
            twitter: '16',
            vkontakte: '16'
        }}
    }]
})
```

__Стало:__

```javascript
// *.deps.js
({
    shouldDeps: [{
        block: 'share-dropdown',
        elems: {elem: 'share-item', mods: {
            service: [
                'facebook',
                'twitter',
                'vkontakte'
            ]
        }}
    }]
})
```

<a name="i-services"></a>

### [i-services](https://st.yandex-team.ru/ISL-2501)

В `BEMHTML`-шаблонах блока была логика, возвращающая пустую строку для элементов отличных от `name` и `url`.

Она считалась устаревшей и была удалена. Если вы использовали это поведение, добавьте на своем уровне:

```javascript
// i-services.bemhtml.js
block('i-services')
    .elem('*')
    .match(function() { return this.elem !== 'name' && this.elem !== 'url'; })
    .def()('');
```

### suggest2

Удаляется технология bemhtml в соответствии с islands.

<a name="suggest2-item"></a>

#### [suggest2-item](https://st.yandex-team.ru/ISL-2769)

БЭМ-Событие `leftclick` переименовано в `click` и теперь базируется на DOM-событии `pointerclick`
(ранее на `leftclick`).
Параметр события обёрнут в объект `{domEvent: e}`.

В БЭМ-событии `link-click` параметр `$e` переименован в `domEvent`
для консистентности с другим кодом библиотеки `islands`.

Кроме того, событие теперь так же базируется на `pointerclick`
(ранее на `click`).

__Было__:
```js
_onLeftclick: function(e) {
    var myTarget = e.target; // Использование оргинального DOM-события
    // …
},
_onLinkClick: function(e) {
    var myTarget = e.$e.target;
    // …
},
bindEvents: function(e) {
    BEM.blocks['suggest2-item']
        .on('leftclick', this._onLeftclick)
        .on('link-click', this._onLinkClick)
    // …
}
```

__Стало__:
```js
_onClick: function(e) {
    var myTarget = e.domEvent.target; // Использование оргинального DOM-события
    // …
},
_onLinkClick: function(e) {
    var myTarget = e.domEvent.target;
    // …
},
bindEvents: function(e) {
    BEM.blocks['suggest2-item']
        .on('click', this._onClick)
        .on('link-click', this._onLinkClick)
    // …
}
```

Внутренние БЭМ-события `_onTap` и `_tapHandler`
для консистентности с другими БЭМ-событиями, передающими оригинальные DOM-события в библиотеке `islands`,
переименованы в `_onItemClick` и в `_onClick` соответственно.

#### [suggest2-form](https://st.yandex-team.ru/ISL-2769)
Вместо блока `button` теперь используются `button2`

Событие `button-click` теперь передаёт jQuery.Event не напрямую, а в объекте по ключу `domEvent`.

### popup

Блок `popup` адаптирован к использованию с `popup2`:
  * `popup2` открытый внутри `popup` теперь не закрывается при клике внутри `popup2`
  * `popup` открытый внутри `popup2` теперь не закрывается при клике внутри `popup`

У `popup` был задан абсурдно большой `z-index` (32000). Из-за этого, `popup2` всегда показывался под `popup`.
Чтобы этого избежать, логика определения `z-index` была портирована из `popup2` в `popup`. Теперь `z-index` `popup`
определяется динамически и находится около 1000, если не задано иное.

Значение `z-index` у любого элемента, определённое на сервисе, теперь может превышать значение `z-index` у `popup`,
из-за чего будет происходить «проваливание» `popup` под другие элементы. Рекомендуется начать использовать
блок [z-index-group][], например:

```javascript
({
    block: 'example',
    mix: {block: 'z-index-group', mods: {level: 2}},
    content: [
        {block: 'button2', text: 'Anchor'},
        {block: 'popup', content: {elem: 'content', content: 'popup'}}
    ]
})
```

В примере, `popup` будет иметь `z-index` не менее 2000, поскольку находится внутри второго уровня `z-index-group`.
Все `popup`, вложенные внутрь первого, будут так же иметь `z-index` не менее 2000, но больше, чем у его «родителя».

 [z-index-group]: <https://lego.yandex-team.ru/libs/islands/v5.0.0/desktop/popup2/#Работа-со-слоями-z-index>

### tooltip

Блок `tooltip` переведён с `popup` на `popup2`.

`tooltip` получил следующее оформление и поведение из `popup2`:

1. Хвостик.
  1. Нельзя задать отступ хвостика.
  2. Хвостик не может быть полупрозрачным.
  3. Хвостик не показывается в IE8, IE9 (graceful degradation).
  4. В размере `xl` хвостик теперь сдвинут на `1px`.
2. `tooltip` становится на `1px` дальше от `owner` (в `popup2` отличается алгоритм вычисления отступов).
3. Немного меняется анимации открытия/закрытия.

## Удаленное

Список блоков элементов и модификаторов, которые были удалены из библиотеки:

- [arr](#arr)
- [b-tabbed-pane](#b-tabbed-pane)
- [i-common__clipboard](#i-common__clipboard)
- [i-hidden](#i-hidden)
- [i-jquery__leftclick](#i-jquery)
- [i-jquery__tap](#i-jquery)
- [i-pressed-controller](#i-pressed-controller)
- [service_hoverable_yes](#service_hoverable_yes)

### [i-pressed-controller](https://st.yandex-team.ru/ISL-2513)

Блок `i-pressed-controller` удален. Блок устанавливал класс `i-pressed-controller_pressed_yes` на touch-устройствах
по событию нажатия на DOM-элементе.

Если вы использовали этот блок, то используйте вместо него события [pointerpress] и [pointerrelease].
Не забудьте добавить зависимость от `pointerevents__pressrelease`, или скопируйте
[код блока](https://github.yandex-team.ru/lego/islands/tree/v4.13.0/touch.blocks/i-pressed-controller) на проектный уровень.

### [i-jquery](https://st.yandex-team.ru/ISL-2510)

В блоке `i-jquery` удалены устаревшие элементы:
* `leftclick` — генерировал событие `leftclick`;
* `tap` — генерировал событие `tap`.

Эти события перестали использоваться после внедрения событий [pointerevents] в `islands` 4.0.

Теперь вместо них нужно использовать событие [pointerclick], предварительно добавив зависимость от
элемента `pointerevents__click`.

__Было:__

```javascript
// myblock.deps.js
({
    mustDeps: [
        {block: 'i-jquery', elem: ['leftclick', 'tap']}
    ]
})

// myblock.js
BEM.DOM.decl('myblock', {}, {
    live: function() {
        this.liveBindTo('leftclick tap', function() {
            // …
        });
    }
});
```

__Стало:__

```javascript
// myblock.deps.js
({
    mustDeps: [
        {block: 'pointerevents', elem: 'click'}
    ]
})

// myblock.js
BEM.DOM.decl('myblock', {}, {
    live: function() {
        this.liveBindTo('pointerclick', function() {
            // …
        });
    }
})
```

### [i-common__clipboard](https://st.yandex-team.ru/ISL-2509)

Удален устаревший элемент `clipboard` блока `i-common`.
Если на вашем проекте необходима эта функциональность, лучше использовать сторонние библиотеки, например [clipboard.js](https://clipboardjs.com/).

### [b-tabbed-pane](https://st.yandex-team.ru/ISL-2489)

Удален устаревший блок `b-tabbed-pane`.

Вместо него используйте блок `tabs` совместно с `tabs-panes`.

Альтернативы `b-tabbed-pane_layout_vert` в библиотеке нет.
Чтобы получить вертикальное меню, рекомендуем доопределить стили блока `tabs-menu` как
в [примере](https://lego.yandex-team.ru/libs/islands/v4.13.0/desktop/tabs/examples/#10-control-menu-vert).
Также можно скопировать [код блока](https://github.yandex-team.ru/lego/islands/tree/v4.13.0/desktop.blocks/b-tabbed-pane) на проектный уровень.

### [i-hidden](https://st.yandex-team.ru/ISL-2499)

Блок `i-hidden` использовался для создания скрытого элемента.

Если вы использовали его у себя на проекте, замените микс с блоком на атрибут `style` со значением `display: none`, либо перенесите
[стили блока](https://github.yandex-team.ru/lego/islands/blob/v4.13.0/common.blocks/i-hidden/i-hidden.css) `i-hidden` на проектный уровень.

### [arr](https://st.yandex-team.ru/ISL-2511)

Удален блок `arr` с уровня `touch-phone`. Он содержал PNG-иконку в виде стрелочки белого цвета для устаревшей версии шапки,
которая не поддерживается в текущем дизайне портала.

Если вы используете блок в своем сервисе, скопируйте
[иконку](https://github.yandex-team.ru/lego/islands/blob/v4.13.0/touch-phone.blocks/arr/_theme/arr_theme.assets/arr_theme_white.png)
на свой проектный уровень в новый модификатор блока `icon` и используйте его для подключения стрелки.
Можно также скопировать [весь блок](https://github.yandex-team.ru/lego/islands/tree/v4.13.0/touch-phone.blocks/arr) на свой проектный уровень.

### [service_hoverable_yes](https://st.yandex-team.ru/ISL-2675)

Из блока `service` удален модификатор `hoverable`, который использовался для подсветки элементов
навигационной панели (блок `navigation`). Панель была удалена еще в `islands` 4.0, и модификатор больше не нужен.

Если вы используете этот модификатор на вашем проекте, скопируйте
[его стили](https://github.yandex-team.ru/lego/islands/tree/v4.13.0/desktop.blocks/service/_hoverable) на свой проектный уровень.

## Прочее

### [Проверка существования текущего блока в afterCurrentEvent](https://st.yandex-team.ru/ISL-1759)

Для всех блоков, использующих `afterCurrentEvent`, добавлена логика, проверяющая, что блок не был уничтожен в предыдущем тике.

### [Поддержка булевых HTML-атрибутов](https://st.yandex-team.ru/ISL-2549)

Все шаблоны `bh`/`bem-xjst` были переписаны так, чтобы значения булевых HTML-атрибутов не выставлялись, если они не обязательны.
Например вместо `disabled="disabled"` выводится просто `disabled`.
Это должно слегка уменьшить размер собранного HTML.

[pointerevents]: https://github.yandex-team.ru/lego/islands/blob/v4.13.0/releases/4.0.0-migration.md#pointer-events
[pointerclick]: https://github.yandex-team.ru/lego/islands/blob/v4.13.0/releases/4.0.0-migration.md#Событие-pointerclick
[pointerpress]: https://github.yandex-team.ru/lego/islands/blob/v4.13.0/releases/4.0.0-migration.md#События-pointerpresspointerrelease
[pointerrelease]: https://github.yandex-team.ru/lego/islands/blob/v4.13.0/releases/4.0.0-migration.md#События-pointerpresspointerrelease
