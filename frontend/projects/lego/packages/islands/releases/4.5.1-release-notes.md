# islands 4.5.1

<!-- ЧЕЛОВЕЧЕСКОЕ ВСТУПЛЕНИЕ -->

Изменения, вошедшие в релиз islands 4.5.1, разделены на группы:

* [минорные изменения](#Минорные-изменения) — задачи, в рамках которых произошло расширение API блоков;
* [исправлено и улучшено](#Исправлено-и-улучшено) — различные исправления, не затрагивающие API блоков;
* [дополнительно](#Дополнительно) — задачи, не касающиеся кода блоков (документация, инфраструктура и т.д.).

Все важные изменения подробно описаны [ниже](#Пояснения).

## Минорные изменения

| Заголовок                                                                           | Задача     | PR             |
| :---------------------------------------------------------------------------------- | :--------- | :------------- |
| [copyright: Добавить элемент dates](#ISL-2083)                                      | [ISL-2083] | [#959], [#963] |
| [i-bem: В элементе dom сделать возможным передачу строки в метод init()](#ISL-2315) | [ISL-2315] | [#953]         |
| [i-bem: Доопределять глобальную переменную BEM если она уже есть](#ISL-2097)        | [ISL-2097] | [#941]         |
| [i-bem__dom: Исправить поведение dropElemCache](#ISL-2269)                          | [ISL-2269] | [#945]         |
| [link: Реализовать возможность передавать произвольную бэм-сущность в поле text](#ISL-2322)     | [ISL-2322] | [#956]         |
| [share-dropdown: Починить работу блока в webview на android 5.0.1](#ISL-1862)                 | [ISL-1862] | [#942]         |

## Исправлено и улучшено

| Заголовок                                                        | Задача     | PR     |
| :--------------------------------------------------------------- | :--------- | :----- |
| arrow: Сократить количество примеров                             | [ISL-2177] | [#909] |
| button2: Навести порядок с зависимостями в инлайновых примерах   | [ISL-2303] | [#938] |
| copyright: Исправить баг после адаптирования к escapeContent     | [ISL-2324] | [#962] |
| i-request: Увеличить покрытие unit-тестами до 100%               | [ISL-2129] | [#915] |
| i-services: Обновить переводы                                    | [ISL-2343] | [#984] |
| [pointerfocus: Исправить работу на touch-устройствах](#ISL-2335) | [ISL-2335] | [#986] |
| [services-table: Заменить Словари на Телепрограмму](#ISL-2346)   | [ISL-2346] | [#987] |
| [slider: Увеличить покрытие unit-тестами до 100%](#ISL-1924)     | [ISL-1924] | [#940] |

## Дополнительно

| Заголовок                                                            | Задача     | PR     |
| :------------------------------------------------------------------- | :--------- | :----- |
| b-form: Подготовить к удалению                                       | [ISL-2224] | [#887] |
| [button2: Объявить стабильным](#ISL-2325)                            | [ISL-2325] | [#957] |
| [check-button__control: Исправить логику передачи value](#ISL-2121)  | [ISL-2121] | [#943] |
| [framebuster: Увеличить покрытие unit-тестами до 100%](#ISL-2128)    | [ISL-2128] | [#965] |
| [header2: Увеличить покрытие unit-тестами до 100%](#ISL-1911)        | [ISL-1911] | [#954] |
| [i-services: Подготовить к удалению зависимость от __uri](#ISL-2321) | [ISL-2321] | [#976] |
| link: Добавить новое поле icon                                       | [ISL-2311] | [#950] |
| link: Обновить документацию                                          | [ISL-2323] | [#970] |
| native-scroll: Написать документацию блока                           | [ISL-2295] | [#946] |

## Пояснения


<a name="ISL-2325"></a>
### [button2: Объявить стабильным][ISL-2325]

Блок `button2` объявлен стабильным.
Вместо блока `button` в дальнейшем рекомендуется использовать блок `button2`.

Документация и примеры к блоку `button2`: https://lego.yandex-team.ru/libs/islands/v4.x/desktop/button2/

<a name="ISL-2121"></a>
### [check-button__control: Исправить логику передачи value][ISL-2121]

Возможность передавать значение атрибута `value` контролу блока `check-button`
через поле `content` объявлена устаревшей и будет удалена в следующей мажорной версии islands 5.0.

Если в проектном коде вы используете эту возможность, пожалуйста, запланируйте
рефакторинг и перейдите на использование поля `value`.

Правильный способ задавать атрибут `value`:
```js
{
    block: 'check-button',
    mods: {theme: 'normal', size: 's'},
    value: 'value', // <---
    content: ...
}
```

<a name="ISL-2083"></a>
### [copyright: Добавить элемент dates][ISL-2083]

Теперь дата или диапазон дат внутри строки копирайта оборачивается в элемент `dates`.

<a name="ISL-2128"></a>
### [framebuster: Увеличить покрытие unit-тестами до 100%][ISL-2128]

В процессе увеличения покрытия unit-тестами, был поправлен белый список для `framebuster_type_yandex`:
теперь он дополнительно пропускает домен `yandex.ru` (раньше пропускались только домены третьего уровня).

<a name="ISL-1911"></a>
### [header2: Увеличить покрытие unit-тестами до 100%][ISL-1911]

При написании тестов был выполнен небольшой рефакторинг кода: теперь модификатор `header2__action_pressed_yes` удаляется в текущем тике, а не в следующем за событием `pointerrelease`.

<a name="ISL-2315"></a>
### [i-bem: В элементе dom сделать возможным передачу строки в метод init()][ISL-2315]

В методе `init` элемента `dom` добавлена возможность инициализации HTML-строк (`BEM.DOM.init`).

Теперь можно не оборачивать в `$` строку передаваемую в метод, когда DOM-дерево
инициализируется из результатов шаблонизации: `BEM.DOM.init(BEMHTML.apply(...))`.

<a name="ISL-2097"></a>
### [i-bem: Доопределять глобальную переменную BEM если она уже есть][ISL-2097]

Добавлена возможность сохранять данные, которые существовали в пространстве имен `БЭМ` до создания библиотекой файла `i-bem.js` и его исполнения.

Например, бывает удобно сохранять переводы в `BEM.I18N`, загружая их в отдельном бандле еще до всего основного кода.

<a name="ISL-2269"></a>
### [i-bem__dom: Исправить поведение dropElemCache][ISL-2269]

Перенос исправления алгоритма расчета ключа для внутреннего хранилища кэшированных элементов блока из bem-core: [bem/bem-core#1042](https://github.com/bem/bem-core/pull/1042/files).

Предыдущая версия метода генерации ключа включала в себя имя блока (`block__elem_mod_val` вместо `elem_mod_val`), что ломало обратную совместимость и в некоторых случаях удаляло `block_elem` вместо `block_elem_mod_`, в следствие чего избыточно очищался кэш для элемента без модификаторов.

<a name="ISL-2321"></a>
### [i-services: Подготовить к удалению зависимость от __uri][ISL-2321]

Зависимость `i-services` от элемента `uri` объявлена устаревшей и будет удалена в islands 5.0.

<a name="ISL-2322"></a>
### [link: Возможность передавать произвольную бэм-сущность в поле text][ISL-2322]

В блоке `link` немного усовершенствовалась обработка содержимого BEMJSON поля text.
Теперь, если передать объект в котором есть поле `block`, применятся шаблоны этого
блока, а элемент `link__inner` просто примиксуется.

Переданный объект (без поля `block`) считается расширением (extend) элемента `link__inner`.
```js
{
    block: 'link',
    url: 'https://ya.ru',
    text: {
        content: {
            block: 'i-bem',
            elem: 'i18n',
            keyset: 'keyset',
            key: 'key'
        }
    }
}
```

Результат:
```html
<a class="link" href="https://ya.ru">
    <span class="link__inner">key</span>
</a>
```

Переданный объект (с полем `block`) считается самостоятельной сущностью,
к которой элемент `link__inner` нужно просто примиксовать.

```js
{
    block: 'link',
    url: 'https://ya.ru',
    text: {
        block: 'block',
        elem: 'elem',
        content: 'text'
    }
}
```

Результат:
```html
<a class="link" href="https://ya.ru">
    <div class="block__elem link__inner">text</div>
</a>
```

<a name="ISL-2335"></a>
### [pointerfocus: Исправить работу на touch-устройствах][ISL-2335]

Мы обнаружили, что на многих touch-устройствах (все iOS и Android < 5.0) блок `pointerfocus` работает неверно, поэтому
иногда могла появляться фокус-рамка при клике на ссылки или другие получающие фокус блоки. Проблема возникала
из-за того, что в мобильных браузерах, имеющих задержку события `click` на 300ms, событие `focusin`, на которое
завязан блок `pointerfocus`, так же срабатывает гораздо позднее (~ через 350ms), чем в остальных браузерах.

<a name="ISL-2346"></a>
### [services-table: Заменить Словари на Телепрограмму][ISL-2346]

Сервис Словари заменен на сервис ТВ в services-table для пресета `ru`.

<a name="ISL-1862"></a>
### [share-dropdown: Починить работу блока в webview на android 5.0.1][ISL-1862]

Проблема заключалась в использовании ссылок вида:

```html
<a href='http://ya.ru'><img src='http://yastatic.net/yandex.png'>Яндекс</a>
```

В Webview на Android 5.0.1 при клике по картинке переход осуществляется по адресу картинки, а не по ссылке.
Решением может быть использование другого HTML-элемента с фоновой картинкой.

В процессе работы над задачей выяснилось, что использовать иконки в блоке `link` не очень удобно,
поэтому мы расширили API блока, а затем произвели рефакторинг блока `share-dropdown`, так,
чтобы элемент `<img>` больше не использовался.

В BEMJSON API блока `link` добавлено поле `icon`, предназначенное для более удобной вставки иконок.

Пример:

```js
{
    block: 'link',
    mods: {
        theme: 'normal'
    },
    url: 'https://yandex.ru',
    icon: {
        mods: {type: 'load'}
    },
    text: 'Ссылка с иконкой'
}
```

Результат:

```html
<a class="link link_theme_normal" tabindex="0" href="https://yandex.ru">
    <i class="icon icon_type_load link__icon" aria-hidden="true"></i>
    <span class="link__inner">Ссылка с иконкой</span>
</a>
```

Вы не ограничены использованием только блока `icon`.
Для вставки иконки можно использовать любой другой блок, например `country-flag`.

Для этого его нужно явно указать:

```js
{
    block: 'link',
    mods: {
        theme: 'normal'
    },
    url: 'https://yandex.ru',
    icon: {
        block: 'country-flag',
        mods: {s16: 'ru'}
    },
    text: 'Ссылка с флагом'
}
```

Результат:

```html
<a class="link link_theme_normal" tabindex="0" href="https://yandex.ru">
    <div class="country-flag country-flag_s16_ar link__icon"></div>
    <span class="link__inner">Ссылка с флагом</span>
</a>
```

<a name="ISL-1924"></a>
### [slider: Увеличить покрытие unit-тестами до 100%][ISL-1924]

В процессе увеличения покрытия unit-тестами, был найден и исправлен баг: при уничтожении блока slider, если
один из его инпутов был в фокусе, генерировалось исключение.



[ISL-2177]: https://st.yandex-team.ru/ISL-2177
[#909]: https://github.yandex-team.ru/lego/islands/pull/909
[ISL-2224]: https://st.yandex-team.ru/ISL-2224
[#887]: https://github.yandex-team.ru/lego/islands/pull/887
[ISL-2303]: https://st.yandex-team.ru/ISL-2303
[#938]: https://github.yandex-team.ru/lego/islands/pull/938
[ISL-2325]: https://st.yandex-team.ru/ISL-2325
[#957]: https://github.yandex-team.ru/lego/islands/pull/957
[ISL-2121]: https://st.yandex-team.ru/ISL-2121
[#943]: https://github.yandex-team.ru/lego/islands/pull/943
[ISL-2083]: https://st.yandex-team.ru/ISL-2083
[#959]: https://github.yandex-team.ru/lego/islands/pull/959
[#963]: https://github.yandex-team.ru/lego/islands/pull/963
[ISL-2324]: https://st.yandex-team.ru/ISL-2324
[#962]: https://github.yandex-team.ru/lego/islands/pull/962
[ISL-2128]: https://st.yandex-team.ru/ISL-2128
[#965]: https://github.yandex-team.ru/lego/islands/pull/965
[ISL-1911]: https://st.yandex-team.ru/ISL-1911
[#954]: https://github.yandex-team.ru/lego/islands/pull/954
[ISL-2315]: https://st.yandex-team.ru/ISL-2315
[#953]: https://github.yandex-team.ru/lego/islands/pull/953
[ISL-2097]: https://st.yandex-team.ru/ISL-2097
[#941]: https://github.yandex-team.ru/lego/islands/pull/941
[ISL-2269]: https://st.yandex-team.ru/ISL-2269
[#945]: https://github.yandex-team.ru/lego/islands/pull/945
[ISL-2129]: https://st.yandex-team.ru/ISL-2129
[#915]: https://github.yandex-team.ru/lego/islands/pull/915
[ISL-2343]: https://st.yandex-team.ru/ISL-2343
[#984]: https://github.yandex-team.ru/lego/islands/pull/984
[ISL-2321]: https://st.yandex-team.ru/ISL-2321
[#976]: https://github.yandex-team.ru/lego/islands/pull/976
[ISL-2322]: https://st.yandex-team.ru/ISL-2322
[#956]: https://github.yandex-team.ru/lego/islands/pull/956
[ISL-2311]: https://st.yandex-team.ru/ISL-2311
[#950]: https://github.yandex-team.ru/lego/islands/pull/950
[ISL-2323]: https://st.yandex-team.ru/ISL-2323
[#970]: https://github.yandex-team.ru/lego/islands/pull/970
[ISL-2295]: https://st.yandex-team.ru/ISL-2295
[#946]: https://github.yandex-team.ru/lego/islands/pull/946
[ISL-2335]: https://st.yandex-team.ru/ISL-2335
[#986]: https://github.yandex-team.ru/lego/islands/pull/986
[ISL-2346]: https://st.yandex-team.ru/ISL-2346
[#987]: https://github.yandex-team.ru/lego/islands/pull/987
[ISL-1862]: https://st.yandex-team.ru/ISL-1862
[#942]: https://github.yandex-team.ru/lego/islands/pull/942
[ISL-1924]: https://st.yandex-team.ru/ISL-1924
[#940]: https://github.yandex-team.ru/lego/islands/pull/940
