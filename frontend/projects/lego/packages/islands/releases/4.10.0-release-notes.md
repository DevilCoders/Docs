# islands 4.10.0

В этом релизе, помимо исправления багов и улучшения кодовой базы библиотеки, мы предусмотрели возможность отказа от Мультидоменной авторизации на сервисах в блоках `lang-switcher` и `i-update-session`.

Изменения, вошедшие в релиз islands 4.10.0, разделены на группы:

* [минорные изменения](#Минорные-изменения) — задачи, в рамках которых произошло расширение API блоков;
* [исправлено и улучшено](#Исправлено-и-улучшено) — различные исправления, не затрагивающие API блоков;
* [дополнительно](#Дополнительно) — задачи, не касающиеся кода блоков (документация, инфраструктура и т.д.).

Все важные изменения подробно описаны [ниже](#Пояснения).

## Минорные изменения

| Заголовок                                                                         | Задача     | PR      |
| :-------------------------------------------------------------------------------- | :--------- | :------ |
| [lang-switcher: Рефакторинг и подготовка к отказу от МДА](#ISL-2585)              | [ISL-2585] | [#1208] |
| [i-update-session: Подготовить к отказу от МДА](#ISL-2584)                        | [ISL-2584] | [#1199] |
| [i-font: Добавить Textbook New Light и Textbook New Bold](#ISL-2397)              | [ISL-2397] | [#1170] |
| [i-font: Улучшить отображение белого текста на чёрном фоне в Mac OS X](#ISL-2398) | [ISL-2398] | [#1180] |
| [input_theme_websearch: Добавить кнопку расширенного поиска](#ISL-2567)           | [ISL-2567] | [#1153] |
| [popup2: Добавить опциональный хвостик](#ISL-2282)                                | [ISL-2282] | [#1117] |

## Исправлено и улучшено

| Заголовок                                                      | Задача     | PR      |
| :------------------------------------------------------------- | :--------- | :------ |
| b-tabbed-pane, b-menu: BEMHTML-шаблоны не работают bem-xjst 2+ | [ISL-2592] | [#1171] |
| input_suggest_yes: Не уничтожается popup при уничтожении input | [ISL-2427] | [#1151] |
| link: Перенести всё про _hovered на desktop                    | [ISL-2522] | [#1164] |
| Перестать использовать this.prototype.method в секции live     | [ISL-2566] | [#1178] |

## Дополнительно

| Заголовок                                  | Задача     | PR      |
| :----------------------------------------- | :--------- | :------ |
| [polyfill: Объявить стабильным](#ISL-2600) | [ISL-2600] | [#1189] |

## Пояснения

<a name="ISL-2585"></a>
### [lang-switcher: Рефакторинг и подготовка к отказу от МДА][ISL-2585]

Блок `lang-switcher` был подготовлен к работе без MDA. В этом режиме все ссылки для переключения языка будут вести
в другие ручки, которые уже зависят от доменов. Чтобы включить этот режим, достаточно установить в BEMJSON-параметр
`disableMda` в значение `true`:

```js
{
    block: 'lang-switcher',
    disableMda: true
    /* ... */
}
```

Кроме этого, мы провели рефакторинг блока. В частности, была проведена подготовка к отказу от использования `i-global`.
Это означает, что начиная с этой версии библиотеки все параметры, необходимые для работы блока, нужно передавать
непосредственно в BEMJSON, а не надеяться на `i-global`:

```js
{
	block: 'lang-switcher',
	lang: {lang: 'ru', name: 'Ru'},

	/* Обязательные: */
	retpath: 'http://your-url.ru', /* URL возврата после смены языка */
	secretKey: 'secret-key', /* секретный ключ */
	tld: 'com.tr', /* Текущий домен верхнего уровня, с помощью которого строятся ссылки на смену языка */

	/* Опциональные: */
	tune: 'https://tune.yandex.com.tr', /* Адрес tune */
	setLangUrl: 'https://www.yandex.com.tr/portal/set/lang/', /* Адрес сервиса, устанавливающего язык (используется при отключении MDA) */

	disableMda: true
}
```

На данный момент все предыдущие способы конфигурации блока (через `i-global` и js-параметры) поддерживаются, но
будут удалены в одном из мажорных релизов. О чем мы вас дополнительно проинформируем.

Кроме этого, в JavaScript API был добавлен метод `.setRetpath()` который позволяет легко и просто обновить
GET-параметр `retpath` у всех ссылок в `lang-switcher`, ведущих на страницу смены языка. Это может быть полезно если у
вас SPA и при переходе на разные страницы вы хотите изменять `retpath`.

Логика, которая выставляет `retpath` из `window.location.href`, если он не указан любым другим способом, объявлена
**устаревшей**, и будет удалена в версии islands#5.0. Сейчас мы рекомендуем вам перейти на правильную установку
`retpath` - с помощью BEMJSON-параметра `retpath` и дальнейшее обновление его с помощью метода `.setRetpath()`, если необходимо.

<a name="ISL-2584"></a>
### [i-update-session: Подготовить к отказу от МДА][ISL-2584]

В связи с отказом от механизма мультидоменной авторизации на портале, понадобилось изменить
логику работы блока `i-update-session`. Теперь при наличии куки `mda` со значением `0`
по умолчанию будет использоваться ручка `${protocol}//passport.yandex.${tld}/auth/update/`.

#### Изменения в логике блока

- Добавлен статический метод `hasMda`, возвращающий `false` при наличии куки `mda` в значении `0`.
- Добавлены значения по умолчанию для `host` и `path` при наличии куки `mda` в значении `0` (их по прежнему можно переопределить в `getDefaultParams`).
- При отсутствии куки `mda` для `host` и `path` используются старые значения по умолчанию.
- Добавлена возможность конфигурировать параметры `host`, `tld` без использования `i-global`.
- Добавлена возможность конфигурировать `retpath`, по умолчанию `${protocol}//yandex.${tld}/favicon.ico`.


<a name="ISL-2397"></a>
### [i-font: Добавить Textbook New Light и Textbook New Bold][ISL-2397]

В блоке `i-font` появились два новых шрифта:
 * Textbook New Light (`i-font_face_textbook-new-light`)
 * Textbook New Bold (`i-font_face_textbook-new-bold`)

<a name="ISL-2398"></a>
### [i-font: Улучшить отображение белого текста на чёрном фоне в Mac OS X][ISL-2398]

В блоке `i-font` появился новый модификатор: `i-font_antialiased_yes`.

В Mac OS X есть нюансы сглаживания текста. По умолчанию используется subpixel‑antialiased
сглаживание шрифтов. Этот режим даёт наиболее чёткий результат при отображении чёрного текста на белом фоне.

Также существует режим _пиксельного_ (antialiased) сглаживания, который даёт лучший результат при отображении
белого текста на чёрном фоне. Для включения этого режима, используйте модификатор `i-font_antialiased_yes`.

Например,

```javascript
({
    block: 'article',
    mix: {block: 'i-font', mods: {face: 'textbook', antialiased: 'yes'}},
    content: 'Очень длинный белый текст на чёрном фоне.'
});
```

<a name="ISL-2567"></a>
### [input_theme_websearch: Добавить кнопку расширенного поиска][ISL-2567]

В блок `input` c модификатором `theme_websearch`, используемый в поисковой стрелке, теперь можно поместить кнопку
расширенных настроек.

![](http://jing.yandex-team.ru/files/incrop/input_theme_websearch__filter.png)

BEMJSON блока реализующего кнопку передаётся в поле `filter` блока `input`. Шаблоны, обрабатывающие это поле, реализованы
в необязательном элементе `input__filter`, который нужно добавить в зависимости. Кнопка помещается внутрь блоки `input`
и к ней примешивается `input__filter`. Шаблоны применяются только к `input` с модификатором `theme_websearch`.

В Лего поддерживается реализация кнопки, собранная с помощью `button2_theme_clear` и `icon_type_filter`:

```javascript
{
    block: 'input',
    mods: {size: 'ws-head', theme: 'websearch'},
    // ...
    filter: {
        block: 'button2',
        mods: {type: 'check', size: 'head', theme: 'clear'},
        attrs: {tabindex: -1},
        icon: {mods: {type: 'filter'}}
    }
}
```

Для её использования нужно подключить к сборке дополнительные зависимости:

```javascript
[
    {block: 'input', elem: 'filter'},
    {block: 'button2', elem: 'icon'},
    {block: 'icon', mods: {type: 'filter'}}
]
```

<a name="ISL-2600"></a>
### [polyfill: Объявить стабильным][ISL-2600]

Блок `polyfill` объявлен стабильным.

<a name="ISL-2282"></a>
### [popup2: Добавить опциональный хвостик][ISL-2282]

У блока `popup2` теперь появился долгожданный опциональный хвостик. Чтобы начать его использовать,
нужно подключить элемент `tail` и положить его в `content` попапа:


```js
{
    block: 'popup2',
    mods: {target: 'anchor', theme: 'normal'},
    content: [
        {elem: 'tail'},
        'Popup with tail'
    ]
}
```

Из грустного - хвостик не работает в IE8 и IE9, это цена за простую и гибкую реализацию. В этих браузерах попап будет
отображаться так же, как если бы хвостик не подключался.



[ISL-2592]: https://st.yandex-team.ru/ISL-2592
[#1171]: https://github.yandex-team.ru/lego/islands/pull/1171
[ISL-2397]: https://st.yandex-team.ru/ISL-2397
[#1170]: https://github.yandex-team.ru/lego/islands/pull/1170
[ISL-2398]: https://st.yandex-team.ru/ISL-2398
[#1180]: https://github.yandex-team.ru/lego/islands/pull/1180
[ISL-2427]: https://st.yandex-team.ru/ISL-2427
[#1151]: https://github.yandex-team.ru/lego/islands/pull/1151
[ISL-2567]: https://st.yandex-team.ru/ISL-2567
[#1153]: https://github.yandex-team.ru/lego/islands/pull/1153
[ISL-2522]: https://st.yandex-team.ru/ISL-2522
[#1164]: https://github.yandex-team.ru/lego/islands/pull/1164
[ISL-2600]: https://st.yandex-team.ru/ISL-2600
[#1189]: https://github.yandex-team.ru/lego/islands/pull/1189
[ISL-2282]: https://st.yandex-team.ru/ISL-2282
[#1117]: https://github.yandex-team.ru/lego/islands/pull/1117
[ISL-2566]: https://st.yandex-team.ru/ISL-2566
[#1178]: https://github.yandex-team.ru/lego/islands/pull/1178
[ISL-2584]: https://st.yandex-team.ru/ISL-2584
[#1199]: https://github.yandex-team.ru/lego/islands/pull/1199
[ISL-2585]: https://st.yandex-team.ru/ISL-2585
[#1208]: https://github.yandex-team.ru/lego/islands/pull/1208
