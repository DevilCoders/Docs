# islands-ci-helpers [![Dependency Status](http://david.lego-dev.dev.yandex-team.ru/lego/islands-ci-helpers.svg)](http://david.lego-dev.dev.yandex-team.ru/lego/islands-ci-helpers)

Это набор скриптов, позволяющий существенно упростить внедрение непрерывной интеграции в библиотеки блоков `Islands`.

<!-- TOC -->
- [Установка](#Установка)
- [Скрипты](#Скрипты)
  - [blocks-introspect](#blocks-introspect)
  - [check-coverage](#check-coverage)
  - [check-gap](#check-gap)
  - [publish-doc](#publish-doc)
  - [remove-doc](#remove-doc)
  - [set-task-components](#set-task-components)
  - [spellcheck-task-title](#spellcheck-task-title)
  - [validate-deps](#validate-deps)

<!-- TOC END -->

## Обновление зависимостей

Для обновления/добавления зависимостей необходимо выполнить следующие команды:

```bash
npm cache clean -f
npm install --force
```

package-lock.json обновится автоматически

## Установка

```bash
$ npm install git://github.yandex-team.ru/lego/islands-ci-helpers#<имя_ветки> --registry=http://npm.yandex-team.ru
```

## Скрипты

Все запускаемые скрипты находятся в папке [bin](https://github.yandex-team.ru/lego/islands-ci-helpers/tree/master/bin).

Краткую документацию по работе скрипта можно получить выполнив команду:

```bash
$ ./имя_скрипта --help
```

Более подробную документацию смотрите ниже.

**ЗАМЕЧАНИЯ!**

* Некоторые скрипты до записывают результат своего выполнения в JSON-файл. Его имя можно задать через переменную среды окружения `RESULT_FILE`, по умолчанию `results.json`.
* Для всех скриптов имя библиотеки (например: `islands`, `meccano`) и владелец библиотеки (например: `lego`, `tools`) извлекается из поля `repository.url` в `package.json`.
* Во всех именах веток и номерах PR в формате `pull/<номер_PR>` символ `/` заменяется на `-`.

### blocks-introspect

Собирает информацию об исходных файлах блока со всех уровней переопределения. Полученную информацию сохраняет в файлах `<имя_блока>.source-files.json` для каждого блока в папках с собранной документацией.

Также собирает список всех используемых примеров и сохраняет в файлы `<имя_блока>.examples-files.json` для каждого блока в папках с собранной документацией.

Эти данные будут использованы инструментом [bem-data-source](https://github.com/bem-site/bem-data-source)
для их дальнейшего отображения на [Лего-сайте](https://lego.yandex-team.ru/).

Интроспекция блоков осуществляется с помощью модуля [bem-blocks-introspect](https://www.npmjs.com/package/bem-blocks-introspect), который является зависимостью `islands-ci-helpers`.

**ЗАМЕЧАНИЯ!**

`bem-blocks-introspect` работает только с библиотеками, в которых блоки расположены в папках вида `*.blocks`.

Запуск:

```bash
$ ./bem-blocks-introspect # проверит все блоки в библиотеке
```

#### Пример

```bash
$ ./bem-blocks-introspect
```

### check-coverage

Проверят, что (после изменений в PR) процент покрытия кода тестами не уменьшился. Проверка осуществляется относительно последней успешной сборки целевой ветки.

Тесты | Папка с HTML-отчетом
---| ---
юнит-тесты | `./coverage`
gemini-тесты | `./gemini-coverage`
тесты на шаблоны | `./tmpl-coverage`

#### Опции

* `--tolerance`, `-t`: устанавливает погрешность в процентах, по умолчанию `0`. Если процент покрытия кода тестами упал более чем на указанное значение, то скрипт завершится с ошибкой.

#### Аргументы

* Номер PR в формате `pull/<номер_PR>`, обязательный аргумент.

После того как скрипт отработает, в `results.json` будет добавлена следующая информация:

```js
{
  "check-coverage": {
    "success": false, // true – процент покрытия тестами не упал, иначе false
    "data": {
      "unit": {
        "head": 90.01, // Процент покрытия тестами после изменений в PR
        "base": 90.01, // Процент покрытия тестами в целевой ветке при последней успешной сборке
        "diff": 0 // Разница между PR и целевой веткой (head - base = diff)
      },
      "gemini": {
        "head": 80.00,
        "base": 91.50,
        "diff": -11.50
      },
      "tmpl": {
        "head": 90.00,
        "base": 89.00,
        "diff": 1.00
      }
    }
  }
}
```

Если процент покрытия тестами упал, то скрипт  завершится с `exit_code !== 0`.

#### Пример

```bash
$ ./check-coverage --tolerance=0.01 pull/100500 # Проверит PR с номером 100500 с погрешностью в 0.01%
$ ./check-coverage -t 0 pull/100500
```

### check-gap

Создает комментарий в PR с информацией о том, на сколько тот отстает от базовой ветки. Если комментарий уже существует, то он обновляется.

В зависимости от переданного аргумента скрипт выполняет проверку всех PR в заданную базовую ветку **или** проверку заданного PR.


#### Аргументы

Стабильная ветка (`dev`,  `support/100500.x`, `release/1.2.3`) или PR в формате `pull/<номер_PR>`.

#### Пример

```bash
$ ./check-gap dev # проверит все PR в dev

$ ./check-gap pull/100500 # проверит PR с номером 100500
```

**ЗАМЕЧАНИЯ!**

* В комментариях про отставание содержится  HTML-комментарий `<!-- TEAM_CITY_GAP_COMMENT -->`.
* Чтобы избежать дублирования комментариев про отставание (например, при одновременном запуске скрипта для базовой ветки и PR), скрипт после завершения своей работы удалит все подобные комментарии, кроме первого.

### publish-doc

Отправляет собранную документацию и примеры в `mds-хранилище` при помощи [bem-data-source](https://github.com/bem-site/bem-data-source) для их дальнейшего отображения на [Лего-сайте](https://lego.yandex-team.ru/).

Скрипт можно запустить в двух модификациях:
* Отправка собранного PR или ветки (`pull/100500`, `dev`, `release/1.2.3`, `support/3.x`):
  * Данные отправляются в _testing_ `mds-хранилища`.
  * Отправляется только собранная документация.
* Отправка собранного стабильного тега (`v1.2.3`):
  * Данные отправляются в _production_ `mds-хранилища`.
  * Отправляется собранная документация и примеры.

#### Опции

* `--force`, `-f`: отключает проверку тегов и release веток (`release/X.Y.Z`). Переданная в качестве аргумента версия считается валидной, если она совпадает с той версией, которая указана в `package.json` библиотеки.

* `--log-level`, `-l`: флаг уровня вывода логов, может принимать значения: (`verbose`, `debug`, `info`, `warn`, `error`),  по умолчанию `debug`. Эта опция передается **bem-data-source**.

#### Аргументы

Ветка, тег или номер PR в формате `pull/<номер_PR>` для отправки документации, обязательный аргумент.

При публикации документации из PR в `results.json` будет добавлена следующая информация:

```json
{
  "publish-doc": {
    "success": true,
    "data": "<Ссылка на опубликованную документацию на Лего-сайте>"
  }
}
```

#### Пример

```bash
$ ./publish-doc dev # отправляет документацию для ветки `dev` в testing mds-хранилища
$ ./publish-doc v1.0.0 # отправляет документацию и примеры для тега `v1.0.0` в production mds-хранилища
$ ./publish-doc release/2.0.0 # отправляет документацию для ветки `release/2.0.0` в testing mds-хранилища
$ ./publish-doc pull/100500 # отправляет документацию для PR с номером `100500` в testing mds-хранилища
```

### remove-doc

Удаляет из _testing_-а `mds-хранилища` документацию для веток библиотек вида `release/<номер_версии>` (если такой ветки уже нет на `github`) и PR-ов библиотек вида `pull/<номер_PR>` (если PR с таким номером закрыт на `github`). Удаление осуществляется при помощи [bem-data-source](https://github.com/bem-site/bem-data-source).

#### Опции

* `--log-level`, `-l`: флаг уровня вывода в лог, может принимать значения: (`verbose`, `debug`, `info`, `warn`, `error`),  по умолчанию `debug`. Эта опция передается **bem-data-source**.
* `--dry-run`: тестовый режим работы скрипта. Из `mds-хранилища` не будут удалены ветки, результат выводится в консоль.

#### Аргументы

* Список библиотек в формате `<owner>/<name>`, обязательный аргумент.

#### Пример

```bash
$ ./remove-doc --dry-run islands islands-components
$ ./remove-doc islands
```

### set-task-components

Выставляет компоненты и проверяет правильность выставленных компонент в задаче из Стартрека.

В автосборке скрипт должен выполняться после скрипта [validate-pr](#validate-pr), который проверяет правильность выставления `id` задачи из Стартрека в заголовке PR.

Проверка пропускается:

* если в заголовке PR нет `id` задачи или он начинается с ключевого слова `TRIVIAL` (в консоль будет выведено сообщение об этом).
* если не удалось получить компоненты из Стартрека:
  * в заголовке указан `id` задачи, которая не существует в Стартреке
  * указан `id` задачи из очереди, к которой нет доступа у [робота](https://beta.wiki.yandex-team.ru/Lego/robots/), под которым проверка запускается (в консоль будет выведено сообщение об этом)
* если в Стартреке выставлена компонента `Инфраструктура`, `Changelog: Внутреннее`, `! infratest`, `! infraspeed` или `! infratools`.
* если задача не принадлежит очереди библиотеки.

Принцип работы:

* Проверка наличия обязательных компонент: `Changelog`.
* Выставление обязательных компонент: `# Блок`, `Платформа`, `Изменения: React`, `Изменения: I-BEM`, основываясь на измененных файлах в PR (например, на уровне `common` был изменен блок `button`, тогда в компонентах задачи будет выставлено: `# button`, `Платформа: Сommon`).

**ЗАМЕЧАНИЯ!**

* Если есть правки на уровне `common` и на каком-то другом, достаточно проставить только `Платформа: Common`. То же с `Платформа: Touch`, если есть правки на уровне `touch` и, например, на `touch-pad`, достаточно проставить только `Платформа: Touch`.
* Измененные файлы в папках `*.tests/**`, `*.examples/**` и `*.tmpl-specs/**` и файлы `**/*.spec.js` не учитываются при проверке.

Запуск:

```bash
$ ./set-task-components pull/<номер_PR>
```

Если в задаче из Стартрека будут отсутствовать обязательные компоненты, то `exit_code !== 0`, и в `results.json` будет добавлена следующая информация (например, если отсутствует компонента `Changelog`):

```json
{
  "set-task-components": {
    "succes": false,
    "data": ["Changelog"]
  }
}
```

#### Пример

```bash
$ ./set-task-components pull/100500 # проверит и выставит компоненты задачи в Стартреке, которая закреплена за PR с номером 100500
```

### spellcheck-task-title

Проверяет заголовок на ошибки в трекере.

Запуск:

```bash
$ ./spellcheck-task-title --pull-request=<PULL_REQUEST_NUMBER>
```

