## Работа с изображениями в библиотеках islands-*

* [Общие принципы](#Общие-принципы)
* [Fallback](#Fallback)
* [Особенности работы с изображениями](#Особенности-работы-с-изображениями)
	* [Android](#Android)
	* [Internet Explorer 8](#Internet-Explorer-8)
* [Оптимизация изображений](#Оптимизация-изображений)
	* [Растровые изображения](#Растровые-изображения)
	* [Векторные изображения](#Векторные-изображения)
* [Иконки типа glyph](#Иконки-типа-glyph)

### Общие принципы

В библиотеке islands мы работаем исключительно с иконками. Отсюда исходный формат у нас всегда SVG. Но так как не все браузеры корректно его поддерживают, для них необходимо делать [fallback](#fallback) на растровые изображения. Все изображения перед отправкой в репозитории библиотек `islands-*` нужно [оптимизировать](#Оптимизация-изображений).

Изображение должно быть вписано в холст без отступов.. Чтобы изображение можно было повторно использовать в различных местах и блоках, позиционирование и отступы для него задаются в CSS.

![padding](checkboxes.png)

###Fallback

Обратная совместимость поддерживается для браузеров с долей более 0.5% пользователей, полученных на основе [статистики Яндекса](bro) и данных [caniuse] – это IE 8 и Android 2.3.
Преобразуйте SVG в PNG с помощью векторного редактора, например [Sketch].
Созданные изображения необходимо [оптимизировать](#optimization).

Проверка поддержки браузером SVG выполняется в блоке [i-ua] библиотеки [islands-romochka].

Пример реализации:

```css
.attach__reset
{
    background-image: url(attach__reset.svg);
    background-size: contain;
}

.i-ua_inlinesvg_no .attach__reset
{
	background-image: url(attach__reset.png);
}
```

### Особенности работы с изображениями

#### Android

На всех Android версии <= 5.0, SVG-изображение будет размытым в нескольких случаях:

* если у содержащего его элемента  заданы  свойства `background-image: url(our_great.svg)` и не нулевое значение для `border`
* если изображение смещено с помощью свойства `background-position`

Устранить эту проблему  можно одним из приведенных ниже способом:

* задать для элемента `background-origin: border-box;`
* задать для элемента `background-repeat: no-repeat;`

![padding](checkbox-android.png)

#### Internet Explorer 8
Если изображение черно-белое, то его необходимо сохранить в палитре Grayscale. Это делается по двум причинам:

* В браузере IE8 для других палитр, при наложении фильтра прозрачности, изображение размоется.
* Сокращает вес изображения.

Проверить палитру картинки можно, например, с помощью утилиты [exiftool], [pngcheck] или встроенной в OS X `sips -g all path/to/file`.

![padding](ie8-grayscale.png)

### Оптимизация изображений

### Растровые изображения
Для оптимизации изображений в растровых форматах JPG и PNG используйте утилиты
[ImageOptim] и [ImageAlpha]. ImageOptim сжимает изображения без потери качества,
а при сжатии ImageAlpha часть информации теряется (например, количество цветов).
Поэтому общее правило гласит: сначала оптимизируем изображение при помощи
ImageAlpha, затем сжимаем то что получилось при помощи ImageOptim.

Рекомендуется сжимать файл изображения с помощью ImageOptim, пока он не перестанет уменьшаться в размерах.

### Векторные изображения
Для оптимизации изображений в формате SVG используйте утилиту [svgo]. В качестве
дополнительного инструмента можно использовать [SVG Cleaner][svg-cleaner].

Обязательно проверяйте изображение в браузере после автоматической оптимизации.
Во всех инструментах могут быть ошибки, svgo и SVG Cleaner — не исключение.

После автоматической оптимизации не лишним будет посмотреть на получившийся
исходник и провести ручную оптимизацию.

На что стоит обратить внимание:

* Атрибут `version` у тега `<svg>` можно удалить, если `SVG` не использует ничего,
  выходящего за рамки [SVG 1.0][svg-1.0] (см. [подробнее][svg-version]).
* Атрибуты `width` и `height` также можно удалить – предполагается управление размером блока из css
* Удалить тег `<defs>`, если внутри него находятся только объекты, которые не участвуют в создании изображения (см. [подробнее](http://www.w3.org/TR/SVG11/struct.html#Head)).
* Атрибуты `fill-rule` и `clip-rule` можно удалить, если они не влияют
  на результат отрисовки (см. подробнее про [fill-rule][svg-fill-rule]
  и [clip-rule][svg-clip-rule]).
* Нельзя пока использовать [svg-filters].
* Чтобы избавиться от дробных значений и сопутствующих им точек, можно применить трюк с увеличением `viewBox`:
  * выставляем атрибут `viewBox="0 0 {@width * 20} {@height * 20}"` ;
  * заворачиваем все содержимое картинки в `<g transform="scale(20)">`;
  * запускаем svgo, который пересчитывает все координаты.
* Количество десятичных знаков после точки можно сократить до двух, а в некоторых случаях до одного следующим образом:
   * после сокращения всех значений до двух символов после запятой, нужно автозаменой заменить числа, заканчивающиеся на 0,1,2,8,9 по схеме: все числа, в конце которых есть 0, 1 и 2 округляем в меньшую сторону; числа, в конце которых 8 и 9 - в большую. (Например: "35.61" -> "35.6", "72.80" -> "72.8", "24.28" -> "24.3"). Другие цифры окончания чисел нельзя округлять до одного знака после запятой, это ломает svg.
   * числа, которые содержат много нулей нужно оптимизировать не автозаменой, а отдельно каждое значение. Есть узкие места типа ".678.001.987". В данном случае убрать значение вообще нельзя, svg поломается. Его нужно преобразовать в ноль, чтобы получилось ".678.0.987". Если же ".001" идет в паре с целым числом, например "5.001", то здесь его можно  просто убирать -> "5".

### Иконки типа glyph
Позволяют вставлять на страницу inline svg. Это нужно в случаях, когда необходимо изменять цвет иконки.

Рекомендуется выставлять таким иконкам атрибуты:
* `widht="0"` и `height="0"` — позволяет предотвратить появление растянутой во весь экран иконки в момент, когда CSS не загружен (актуально для Firefox).
* `focusable="false"` —  позволяет предотвратить перевод фокуса на svg в IE11, что ломает [a11y](https://lego.yandex-team.ru/doc/guidelines/a11y/).

[ImageOptim]: http://imageoptim.com/
[ImageAlpha]: http://pngmini.com/
[svgo]: https://github.com/svg/svgo/
[svg-cleaner]: http://sourceforge.net/projects/svgcleaner/
[svg-1.0]: http://www.w3.org/TR/SVG10/
[svg-defs]: http://www.w3.org/TR/SVG11/struct.html#Head
[svg-version]: http://www.w3.org/TR/SVG11/struct.html#SVGElementVersionAttribute
[svg-fill-rule]: http://www.w3.org/TR/SVG11/painting.html#FillRuleProperty
[svg-clip-rule]: http://www.w3.org/TR/SVG11/masking.html#ClipRuleProperty
[svg-filters]: http://caniuse.com/#feat=svg-filters
[Sketch]: https://www.sketchapp.com/
[i-ua]: https://github.yandex-team.ru/lego/islands-romochka/tree/dev/common.blocks/i-ua/
[islands-romochka]: https://github.yandex-team.ru/lego/islands-romochka
[caniuse]: http://caniuse.com/#feat=svg
[exiftool]: http://en.wikipedia.org/wiki/ExifTool
[pngcheck]: http://www.libpng.org/pub/png/apps/pngcheck.html
[HiDPI]: http://en.wikipedia.org/wiki/Retina_Display
[bro]: http://bro.tools.yandex-team.ru/lego-portal/
