# Локализация в Лего

Многоязычность текстов в блоках Лего реализуется с помощью следующих средств:

* [Яндекс.Танкер] — технология и сервис для переводов.
* [tanker-kit] — утилита для взаимодействия с Танкером.
* [i18n] — технология сборки файлов с переводами для каждого необходимого языка.

Эти средства, в зависимости от региональных настроек, обеспечат:

* перевод простых текстовых строк;
* форматирование даты и время, числа и денежных единиц;
* перевод различных форм слов или фраз, зависящих от числа и др.

В документе описываются общие сведения, принцип работы и действия необходимые для получения переводов.

* [Быстрый старт](#quick-start)
* [Поддерживаемые локали](#lang)
* [Танкер](#tanker)
  * [Основные понятия](#tanker)
  * [Подключение сервиса к Танкеру](#tanker-start)
  * [Танкер и БЭМ](#tanker-bem)
* [Расположение переводов в файловой структуре](#fs)
* [tanker-kit](#tanker-kit)
  * [Отправка переводов в Танкер](#Tanker-in)
  * [Выгрузка готовых переводов](#Tanker-out)
* [Технология i18n](#i18n)
  * [Методы](#methods-i18n)
* [Локализационные ключи в коде блоков](#inblock)
  * [В шаблонах](#tamplates)
  * [В JavaScript](#js)
  * [В BEMJSON](#bemjson)

<a name="quick-start"></a>
## Быстрый старт

Чтобы получить готовые переводы из Танкера, нужно выполнить из корня проекта следующие действия:
>**NB** Сервис должен быть [подключен к Танкеру](#tanker-start).

* Установить локально утилиту [tanker-kit]:

```
npm i tanker-kit --save-dev --registry http://npm.yandex-team.ru
```

* Выгрузить готовые переводы проекта (для ключей со статусом перевода **approved**) из Танкера:

```
./node_modules/.bin/tanker pull
```
Также можно одновременно выгрузить готовые переводы и загрузить новые ключи (синхронизация переводов с Танкером):

```
./node_modules/.bin/tanker sync
```
* Сохранить полученные переводы (файлы `block.i18n/<lang>.js`) в репозиторий проекта, оформив отдельным коммитом. Файлы `block.i18n/<lang>.js` вручную не редактируются.

Список команд с кратким описанием: `./node_modules/.bin/tanker --help`

<a name="lang"></a>
## Поддерживаемые локали

Предусмотрены переводы на следующие языки:

* `ru` — русский (язык оригинала)
* `be` — белорусский
* `en` — английский
* `kk` — казахский
* `tr` — турецкий
* `tt` — татарский
* `uk` — украинский

<a name="tanker"></a>
## Танкер

[Яндекс.Танкер] — технология и сервис, предназначенные для интернационализации (сокращенно `i18n`) сервисов. Команда Танкера обеспечивает перевод информации, предоставленной сервисами на оригинальном языке. Исходные данные и полученные переводы сохраняются в Танкере и могут быть [выгружены](#pull) в любой момент времени.

### Основные понятия

* [Проект](https://doc.yandex-team.ru/Tanker/tech-dscr/concepts/projects.xml) — хранилище переводов текстов (наборов ключей) в Танкере только для одного сервиса на все необходимые языки.
* **Ключ проекта** — именованный объект для хранения перевода слова или фразы. Ключ также может содержать словоформы, зависящие от числа или рода ([статические](https://doc.yandex-team.ru/Tanker/tech-dscr/concepts/tr_keys.xml#static-keys) или [динамические](https://doc.yandex-team.ru/Tanker/tech-dscr/concepts/tr_keys.xml#dynamic-keys) ключи).
* **Кейсет** — группа ключей, объединенные согласно логике, принятой разработчиками
сервиса.
* **Контекст** — контекст ключа для переводчиков.
* **Токен** — идентификационный токен для роботов. Используется для доступа к [API Танкера] из скриптов, чтобы автоматизировать работу с переводами.

Ключи проектов могут иметь различные [статусы переводов](https://doc.yandex-team.ru/Tanker/tech-dscr/concepts/tr-statuses.xml), которые можно увидеть с помощью [веб-интерфейса Танкера](https://tanker.yandex-team.ru/).

<a name="tanker-start"></a>
### Подключение сервиса к Танкеру

Чтобы подключить сервис к Танкеру, нужно:

 * создать новый проект в Танкере, заполнив [форму](https://wiki.yandex-team.ru/portal/international/tanker#otpravitzajavkunasozdanieproektavtankere) (проекты Лего начинаются с префикса `lego-*`);
 * получить имя проекта;
 * указать нужные языки для перевода;
 * узнать токен для роботов (можно найти на странице проекта в Танкере).

Содержимое и структуру проекта в Танкере можно полностью сформировать с помощью [веб-интерфейса](https://tanker.yandex-team.ru/) пользователя или [tanker-kit] (рекомендуется). Также можно загрузить подготовленные файлы в любом из [поддерживаемых форматов](https://doc.yandex-team.ru/Tanker/api-reference/concepts/formats.xml) с помощью [API Танкера], через [веб-интерфейс](https://tanker.yandex-team.ru/). Выгрузка переводов доступна обоими способами.

<a name="tanker-bem"></a>
### Танкер и БЭМ

Исходные данные и переводы для каждой библиотеки Лего хранятся в отдельных проектах Танкера (например, [lego-islands](https://tanker.yandex-team.ru/?project=lego-islands&branch=master) и т. п.).

Локализация в Лего выполняется отдельно для каждой [БЭМ-сущности](https://ru.bem.info/method/key-concepts/#БЭМ-сущность), которой необходим перевод текстов. Для этого в проекте Танкера следует создать **кейсет**
для каждой локализуемой БЭМ-сущности: вручную через [веб-интерфейс](https://tanker.yandex-team.ru/) или автоматически с помощью [tanker-kit](https://github.yandex-team.ru/lego/tanker-kit/blob/dev/doc/overview.md#Отправка-в-Танкер) (рекомендуется).

Имя кейсета должно состоять из уровня переопределения и полного имени сущности в БЭМ-нотации, разделенных двоеточием `<уровень переопределения>:<имя БЭМ-сущности>`. Например:

    common.blocks:header__action_type_srv
    common.blocks:user_menu_auth
    desktop.blocks:lang-switcher

Кейсеты, относящиеся к определенной БЭМ-сущности, содержат ключи с исходными данными и готовые переводы на все [необходимые языки](#lang). Подробнее про [именование ключей в Танкере](https://doc.yandex-team.ru/Tanker/tech-dscr/concepts/tr_keys.xml).

<a name="fs"></a>
## Расположение переводов в файловой структуре

Переводы хранятся в файлах `<lang>.js` для всех [необходимых языков](#lang) (например, `ru.js`, `en.js`).

Файлы с переводами располагаются в поддиректории `<bem-entity>.i18n` локализуемой БЭМ-сущности, на одном уровне с другими файлами технологий.

```
block/
    block.css        # CSS-технология реализации БЭМ-сущности
    block.js
    block.bemhtml.js
    block.ru.md
    block.i18n/      # реализация БЭМ-сущности в технологии i18n
        ru.js        # файл с переводом на русский язык
        en.js        # файл с переводом на английский язык
        ...
```
Файлы перевода

**ru.js**

```
module.exports = {
    "block": {                      # кейсет
        "key1": "Выбрать файл",     # пара ключ : значение
        "key2": "файл не выбран"
    }
};
```

**en.js**

```
module.exports = {
    "block": {
        "key1": "Select file",
        "key2": "no file chosen"
    }
}
```
Подобное размещение файлов в файловой структуре проекта необходимо для сборки локализованных версий блоков c помощью [технологии i18n](#i18n).

Утилита [tanker-kit] автоматически выгружает переводы в файловую систему проекта, в виде пригодном для сборки (рекомендуется). Также можно самостоятельно создать нужные локализационные ключи с переводами в технологии `i18n` (`block.i18n/{ru,en,...}.js`) для всех необходимых языков на собственном проектном уровне, без использования Танкера (рекомендуется использовать только при локальной разработке, для проверки правильности работы).

## tanker-kit
[tanker-kit] — утилита, обеспечивающая взаимодействие с сервисом переводов [Танкер](https://doc.yandex-team.ru/Tanker/tech-dscr/concepts/tanker-description.xml) через [API Танкера]. Она помогает:

* найти и извлечь из исходных файлов блока все данные для перевода (локализационные ключи);
* подготовить их к загрузке в Танкер, в пригодном для него [JSON-формате](https://doc.yandex-team.ru/Tanker/api-reference/concepts/formats.xml#format-json);
* выгрузить готовые переводы в файловую структуру блока в виде, необходимом для технологии `i18n` (подробнее в разделе [Расположение в файловой структуре](#fs)).

Чтобы начать работу с Танкером с помощью `tanker-kit`, нужно из корня проекта (библиотеки) выполнить следующее:
>**NB** Убедитесь, что сервис [подключен к Танкеру](#Tanker-start).

* [Установить](https://github.yandex-team.ru/lego/tanker-kit/blob/dev/doc/overview.md#Установка) утилиту из [репозитория](https://github.yandex-team.ru/lego/tanker-kit.git) локально (рекомендуется).
* [Настроить](https://github.yandex-team.ru/lego/tanker-kit/blob/dev/doc/overview.md#Конфигурирование) ее в интерактивном режиме, указав основные параметры проекта (хранятся в [конфигурационном файле](https://github.yandex-team.ru/lego/tanker-kit/blob/dev/doc/overview.md#Конфигурирование) проекта `.tanker/config.js`, расположенном в корневом каталоге библиотеки):
  * название проекта в Танкере (например, `lego-*`);
  * токен для роботов (можно найти на странице проекта в Танкере);
  * набор консольных команд для поиска исходников (например, `find blocks-* -name *.priv.js`).
* Настроить проектный [resolver](https://github.yandex-team.ru/lego/tanker-kit/blob/dev/doc/overview.md#Резолвинг) с помощью файла `.tanker/resolver.js`, который необходим для уточнения и дополнения исходных данных, полученных автоматически при [парсинге](https://github.yandex-team.ru/lego/tanker-kit/blob/dev/doc/overview.md#Парсинг).
* Подготовить исходные данные к переводу и [загрузить](#Tanker-in) их в Танкер.
* [Выгрузить](#Tanker-out) готовые переводы из Танкера в файловую систему проекта.

>**NB** Утилиту можно использовать с настройками по умолчанию, содержащимися в [базовом конфиге](https://github.yandex-team.ru/lego/tanker-kit/blob/dev/cnf/base.json).

<a name="Tanker-in"></a>
### Отправка данных в Танкер

Отправить подготовленные данные в Танкер можно с помощью команды:
```
tanker push
```
Добавляются только новые ключи, уже существующие — не изменяются.

<a name="Tanker-out"></a>
### Выгрузка переводов из Танкера

Из Танкера всегда выгружаются все данные переводов проекта, так как у утилиты нет встроенных средств для фильтрации данных, которые нужно обновить в проекте. Выгрузка переводов выполняется только для тех сущностей, у которых уже есть представление в Танкере.

Выгрузить готовые переводы для ключей (статус перевода **approved**) можно с помощью команды:
```
tanker pull
```
Выгрузить свежие переводы из Танкера и одновременно загрузить новые ключи, после добавления в исходные файлы, можно с помощью команды синхронизации с Танкером:
```
tanker sync
```
При первом выполнении этой команды создаются русские ключи для языков: `ru`, `be`, `tt`, `kk`, `uk`. Для языков `tr` и `en` создается пустой ключ.

Если вы добавили новые ключи, изменили или удалили уже существующие, то необходимо синхронизировать переводы с Танкером. При добавлении новых ключей разработчик должен дождаться, пока переводчики и редакторы завершат работу над новыми ключами и переведут их в статус `approved`. Затем нужно запустить синхронизацию снова, чтобы выгрузить переводы.

> **NB** Команда `sync` **удаляет** переводы из файловой системы только в том случае, если **ключи не были найдены в исходном коде**. Из самого Танкера ничего не удаляется.

Команды `tanker pull --force` и `tanker sync` после успешной [раскладки данных по файловой системе](#fs) в виде файлов `block.i18n/<lang>.js`, обновят файл `paths.tankerRef`, тем самым зафиксировав новую ревизию переводов.

Полученные переводы **необходимо сохранить в виде коммита в репозиторий**. Ручная правка файлов вида `block.i18n/*.js` не производится.

Удобно подписаться на уведомления о готовности переводов в любом проекте, кейсете, ключе для любого языка:

```
tanker sync --task LEGO-1234
```

[Полный список команд tanker-kit с полезными опциями](https://github.yandex-team.ru/lego/tanker-kit/blob/dev/doc/overview.md#Консольный-интерфейс)

<a name="i18n"></a>
## Технология `i18n`

В `islands` получить необходимые файлы переводов можно выполнив сборку c помощью сборщика проектов [ENB]. Он использует набор технологий из пакета [enb-bem-i18n](https://github.com/enb/enb-bem-i18n/blob/master/README.md), для сборки готовых к использованию файлов с переводами, в основе которых лежит библиотека интернационализации, далее именуемая ядро [i18n].

`i18n` — технология сборки, обеспечивающая формирование общего бандла с переводами для каждого необходимого языка.

Пакет `enb-bem-i18n` поддерживает разные реализации ядра интернационализации для базовых библиотек: [bem-bl](https://ru.bem.info/libs/#bem-bl) — ядро `BEM.I18N`, `bem-core` — ядро `i18n`. В Лего используется *модификация* ядра `i18n` из базовой библиотеки `bem-bl`, влитой в `islands`. Ядро `i18n` расположено в элементе `i18n` блока `i-bem`.

В процессе сборки для всех локализуемых БЭМ-сущностей из файлов с переводами `<lang>.js` будут сформированы:

* `.keysets.<lang>.js` — промежуточные файлы, содержащие объединение исходных файлов `<lang>.js` в общий файл для каждого языка;
* `.lang.<lang>.js` - файлы, содержащие строки переводов, соответствующие запрошенным ключам для каждого языка.
* `.lang.all.js` — общий файл с переводам для всех необходимых языков.

Результатом работы технологии сборки `i18n` являются файлы с переводами, которые содержат также ядро `i18n` в виде функции `BEM.I18N` (для реализации в `bem-bl` и `islands`). При вызове она принимает ключ и отдает значение (строку) для конкретного языка. Доступна из шаблонов [BEMHTML](#tamplates), [BH](#templates) (в пространстве имен `bh.lib.i18n`) или клиентского [JavaScript-кода](#js).

**Важно!** Для получения ядра необходимо добавить mustDeps-зависимость блокам, которые используют `i18n`:

```
({
    mustDeps: { block: 'i-bem', elem: 'i18n' }
})
```

> Подробнее про сборку файлов интернационализации читайте в документации пакета [enb-bem-i18n]().

Сигнатура функция `BEM.I18N` : `BEM.I18N (scope:String, key:String, [params:Object]):String`

Входные параметры:

* **scope** — область видимости ключа. Обычно имя БЭМ-сущности.
* **key** — ключ, соответствующий значению для указанного языка.
* **params** — входные данные для функции (дополнительный параметр).
Параметризация значений позволяет задавать дополнительный параметр `params`, который будет обработан функцией и может повлиять на результат перевода. Например, в этом параметре может передаваться число от 1 до 12, при обработке которого результатом будет месяц, соответствующий указанному числу.

**Результат выполнения**: строка, содержащая перевод.

Задавать значения ключей можно не только как строку. Также возможность параметризации значений реализована через XML.

```javascript
{
    'scope-1': {
        key: 'val'
    },
    'scope-2': {
        key: 'Hello <i18n:param>who</i18n:param>!'
    }
}
```

<a name="methods-i18n"></a>
### Методы BEM.I18N

[Основные методы](https://github.yandex-team.ru/search-interfaces/frontend/blob/master/projects/lego/packages/islands/common.blocks/i-bem/__i18n/i-bem__i18n.i18n/core.js#L84) объекта `BEM.I18N`:

* [lang](#lang)
* [keyset](#keyset)
* [key](#key)

#### lang

Устанавливает/получает значение текущего языка.

```js
BEM.I18N.lang(sCode:String):String
```

Входные параметры:

* `sCode` — код языка.

```js
BEM.I18N.lang();      // Значение по умолчанию: 'ru'
BEM.I18N.lang('tr');  // Установили в 'tr'
BEM.I18N.lang();      // 'tr'
```

#### keyset

Устанавливает значение текущего кейсета в `name`.

```js
BEM.I18N.keyset(name:String|Object):BEM.I18N
```

Входные параметры:

* `{String|Object} name` — кейсет.
* `{Object} name` — кейсет.
* `{String} name.block` — кейсет.
* `{String} [name.elem]` —  кейсет.
* `{String} [name.modName]` —  кейсет.
* `{String} [name.modVal]` — кейсет.

```js
BEM.I18N.keyset('b-page__title');
BEM.I18N.keyset({
  block: 'b-page',
  elem: 'title'
});
```

#### key

Возвращает значение ключа `sName` текущего кейсета.

```js
BEM.I18N.key(sName:String, [oParams]:Object): String
```

Входные параметры:

* `sName` — название ключа.
* `oParams` — параметры ключа (значения по умолчанию, комментарий и контекст).


```js
BEM.I18N('copyright', 'Яндекс');

# Эквивалентно цепочке
BEM.I18N.keyset('copyright').key('Яндекс');
```

<a name="inblock"></a>
## Локализационные ключи в коде блоков

Функция `BEM.I18N` может использоваться в исходных кодах технологий блока основанных на JavaScript:

* [В шаблонах](#tamplates)
* [В JavaScript](#js)
* [в BEMJSON](#bemjson)

<a name="tamplates"></a>
### В шаблонах

После подключения `BEM.I18N` как сторонней библиотеки ее можно использовать:

* в BEMHTML-шаблонах с помощью функции `BEM.I18N()`;
* в BH — из пространства имен `bh.lib`.

> Подробнее о подключении сторонних библиотек смотрите в документации к пакетам [enb-bemxjst](https://ru.bem.info/tools/bem/enb-bemxjst/readme/#Подключение-сторонних-библиотек) и [enb-bh](https://ru.bem.info/tools/bem/enb-bh/readme/#Подключение-сторонних-библиотек).

**BEMHTML**

```js
block('copyright').elem('link')(
    content()(function() {
        return BEM.I18N('copyright', 'link');
    })
);
```

**BH**

```js
bh.match('copyright__link', function(ctx, json) {
    ctx.content(bh.lib.i18n('copyright', 'link'));
});
```

Задавать значения ключей можно как в виде строки, так и в виде параметризованного значения с помощью XML.

```js
{
    'scope-1': {
        key: 'val'
    },
    'scope-2': {
        key: 'Hello <i18n:param>who</i18n:param>!'
    }
}
```
<a name="js"></a>
### В JavaScript

Файлы могут подключаться как в Node.js, так и в браузере.

* В Node.js скомпилированный файл можно подключить как модуль в формате CommonJS.

```js
var i18n = require('bundle.lang.en.js'); // Путь до скомпилированного файла

i18n('scope', 'key'); // 'val'
```

* В браузере ядро `i18n` предоставляется в глобальную видимость в переменную `BEM.I18N`.

Пример получения строки копирайта в нужном формате в JavaScript-е блока с помощью метода `BEM.I18N`:

```js
BEM.I18N('copyright', 'link');
```

<a name="bemjson"></a>
### В BEMJSON

Чтобы локализовать текстовое сообщение в BEMJSON, используется вспомогательный элемент `i18n` блока [i-bem](https://github.yandex-team.ru/lego/islands/tree/dev/common.blocks/i-bem),
который внутри своего BEMHTML/BH-шаблона заменяется на результат вызова метода `BEM.I18N('block-name', 'no-file')` с переданными параметрами.

```js
{
    block: 'attach',
    mods: { size: 's' },
    content: [
        {
            block: 'button',
         	mods: { size: 's' },
         	mix: [{ block: 'attach', elem: 'button' }],
         	name:'customName',
         	content: { // локализованное сообщение на кнопке
                block: 'i-bem', elem: 'i18n', keyset: 'attach', key: 'button-text'
            }
        },
        {
            elem: 'holder',  // поле с локализованной информацией о выбранном файле
            content: {
                block: 'i-bem', elem: 'i18n', keyset: 'attach', key: 'no-file'
            }
        }
    ]
}
```

>**NB** Необходимо гарантировать наличие  в шаблонах реализации элемента `i-bem__i18n`, описав соответствующую mustDeps–зависимость в коде `deps.js` локализуемого блока.

```js
// attach.deps.js
({
     mustDeps: [
         { block: 'i-bem', elem: 'i18n' }
    ]
})
```

[tanker-kit]: https://github.yandex-team.ru/lego/tanker-kit/blob/dev/doc/overview.md
[API Танкера]: https://doc.yandex-team.ru/Tanker/api-reference/
[Яндекс.Танкер]:https://doc.yandex-team.ru/Tanker/tech-dscr/concepts/tanker-description.xml
[i18n]: https://github.com/enb-bem/enb-bem-i18n#Ядро-i18n
[ENB]: https://ru.bem.info/tools/bem/enb-bem/
