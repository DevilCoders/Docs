Инструкция по выпуску релизов библиотеки islands
----------------------------------------
- [Примечания](#Примечания)
- [Подготовка](#Подготовка)
- [Релизная ветка](#Релизная-ветка)
- [Ревью и тестирование](#Ревью-и-тестирование)
- [Выпуск релиз-кандидата](#Выпуск-релиз-кандидата)
- [Релиз](#Релиз)
- [Патчевые релизы](#Патчевые-релизы)
- [Портирование](#Портирование)
- [Анонс](#Анонс)

## Примечания

1. В этой инструкции описывается выпуск минорных и патчевых версий, а также хотфиксов.

1. Примеры приводятся для релиза в рамках мажорной версии `5.x`.
Для других мажорных версий не забудьте поменять заголовки задач, имя разработческой ветки и прочее.

1. Всю подготовку и осуществление релиза производит __один__ релиз-инженер.
Делегируются только задачи по регрессиям (если они возникнут).


## Подготовка

На этом этапе заводятся задачи и происходит планирование.

1. Заведите задачу «Выпустить релиз islands 5.x» в очереди [ISL](https://st.yandex-team.ru/ISL) - [пример такой задачи](https://st.yandex-team.ru/ISL-3613). В этой задаче будет вестись работа по обновлению версии `islands` на сервисах, в которых происходит внедрение.

1. Запланируйте задачу в следующий спринт.

1. Не позднее, чем за три дня предупредите тестировщика `Олю olga0321@ Молчанову` (или тому, кто будет тестировать релиз вместо нее) прогнозируемую дату начала тестирования.


## Релизная ветка

1. Возьмите задачу в работу.

1. Проверьте, что сборка `dev` «зеленая» и успешно собралась.

1. Переустановите зависимости, чтобы не использовать некорректные скрипты для выпуска релиза:
   <pre>
   rm -rf ./node_modules && npm i
   </pre>

1. Запустите утилиту [iver](https://github.yandex-team.ru/lego/iver) (также доступна в `npm`: `npm install @yandex-int/iver`):
    <pre>
    iver
    </pre>
    Она сформирует список задач, входящих в текущий релиз.

     - Скопируйте этот список и вставьте в корневую задачу по выпуску релиза. Трекер автоматически свяжет задачи между собой.

     Для каждой задачи в release-notes будет показана степень изменений (`MINOR`/`PATCH`/`EMPTY`).
     Эта информация берется из компоненты `Changelog`.

     - Если такой компоненты в какой-то из задач не окажется — `iver` не отработает и выведет соответствующее сообщение. В этом случае нужно зайти в каждую из таких задач и проставить недостающую компоненту `Changelog`.

     - Утилита не отработает и в случае, если при прошлом выпуске релиза не были удалены ненужные примечания к задачам из releases/notes/. Удалите их и запустите `iver` еще раз.

1. Выберите версию, которую будете релизить. Под "beta version" подразумевается версия release-candidate, которая выпускается до внедрения в сервисы (как правило, этот этап можно пропустить).
    <pre>
    Are you releasing beta version or stable? [B/S]
    </pre>

      - `iver` автоматически сгенерирует release-notes для текущего релиза, которые появятся в папке `/releases`;
      - предложит вам создать новую релизную ветку и переключиться на нее, если вы не сделали этого раньше;
      - предложит автоматически проставить компоненту "Исправлено в версиях" во всех задачах, входящих в текущий релиз. Это важно для тех, кто ждет появления задачи в релизе.
    <br>
1. Откройте `package.json` и проверьте, что версия в поле `version` автоматически заменилась на текущую при отработке `iver`. Если вы выпускаете release-candidate, проверьте наличие `-rc` в конце номера версии.
    <pre>
    "version": "5.x.x-rc"
    </pre>

1. Откройте сформированные примечания к релизу для `islands` и `lego-on-react` `/releases/5.x.x-release-notes.md`, `/releases/1.x.x-release-notes-react.md` проверьте правильно ли сформировался файл, напишите человеческое вступление, если необходимо. Удалите раздел «Мажорные изменения», если таковых не было, и ссылку на него.

     Обратите внимание:
     - Если комментарий к задаче полностью отражен в ее описании, вероятно, такой комментарий не нужен;
     - В некоторые примечания следует добавить скриншот, особенно если менялась верстка, добавлялись новые темы etc.

     К релизной ветке нельзя применять `rebase` и `force-push`; поэтому прежде чем коммитить и отправлять `release-notes` на ревью, можно сначала опубликовать их в виде комментария на `github`, чтобы потом не делать лишних коммитов с правками.

1. Сделайте коммит, который будет содержать изменения в `package.json` и новый файл с текущими release-notes.
    <pre>
    git add --all
    git commit -m 'v5.x.x'
    </pre>

1. Синхронизируйте файлы переводов с Танкером.
    <pre>
    tanker pull
    git commit -am 'Обновить переводы из Танкера'
    </pre>

1. Отправьте ветку в удаленный репозиторий
    <pre>
    git push -u origin release/x.y.z
    </pre>
    и отправьте pull request в разработческую ветку.

1. Начиная с этого момента, релизная ветка рассматривается как ветка разработки, все изменения вносятся через PR.
<br>
Статус сборки релизной ветки можно смотреть в [TeamCity].
<br>

## Ревью и тестирование

На этом этапе происходит ревью созданных PR, ручное тестирование в Лего и на сервисах.

1. Попросите коллег сделать ревью. Нужно проверить список изменений и примечания к релизу.

1. Позовите в ревью `godfreyd@` или другого технического писателя, чтобы он мог проверить примечания к релизу.

1. Внесите исправления по результатам ревью.

1. В данный момент ручное тестирование релиза происходит только на сервисах, поэтому ставить задачу на ручное тестирование примеров библиотеки не нужно.

1. Дождитесь успешной сборки pull request на стороне Лего. После этого создайте pull request с обновленной версией Islands репозиториях сервисов (на данный момент это Картинки, Видео и Серп, репозитории [fiji](https://github.yandex-team.ru/mm-interfaces/fiji), [web4](https://github.yandex-team.ru/serp/web4)) - для этого напишите в своем PR команду [/canary](https://github.yandex-team.ru/lego/islands/tree/dev/contribs).

1. Дождитесь успешного прохождения всех автотестов в инфраструктуре сервисов. Если автотесты не прошли — разберитесь в причинах, и самостоятельно или с помощью коллег устраните их. Начинать ручное тестирование без прохождения автотестов нельзя.
    - В `fiji` может упасть пульс из-за `console.assert`. Об оборачивании `console.assert`'ов можно прочесть [выше](#asserts).

1. После успешного прохождения автоматических тестов переведите задачу по выпуску релиза на сервисах в тестирование. Дождитесь результатов ручного тестирования. В случае обнаружения регрессий — устраните их самостоятельно или с помощью коллег. Если регрессий не обнаружено — можно смело выпускать `islands 5.x.x-rc` или `islands 5.x.x`.

## Выпуск релиз-кандидата

1. Перейдите в detached-режим  <pre>git checkout HEAD~0</pre>
1. Поставьте тег на последний коммит в detached-режиме. Тег должен строго соответствовать схеме v4.x.x-rc.
    <pre>
    git tag vX.Y.Z-rc
    git push origin vX.Y.Z-rc
    </pre>

1. Выполните команду `npm publish` для публикации выпущенного релиза в npm.

## Релиз

В случае успешного окончания ручного тестирования можно переходить к выпуску стабильной версии релиза.

1. Зайдите в [teamcity] и перепроверьте, что сборка для релизной ветки выпускаемой библиотеки успешно завершена. А лучше пересоберите релизную ветку еще раз, спустя все время, что заняло ручное тестирование.

1. Синхронизируйте локальную ветку с веткой в репозитории, если в нее были внесены изменения.

1. Поставьте тег и сделайте push. Тег должен строго соответствовать схеме `vX.Y.Z`.

      <pre>
      git tag vX.Y.Z
      git push origin vX.Y.Z
      </pre>

1. Выполните команду `npm publish` чтобы запушить новую версию в npm

1. Обновите версии зависимостей в `bower.json` на сервисах где происходит внедрение `islands`. Зависимости должны быть __строгими__.

1. Проверьте что тег успешно собрался в TeamCity/Sandbox и библиотеки появились на [тестовом сайте Лего].

1. Зайдите на https://lego-site-provider.legoprovider.dev.yandex-team.ru/ и нажмите на изображение глобуса в оранжевой базе. Это действие выкатит проставленный тег в боевую версию сайта Лего.

1. Для того чтобы на сайте появились корректные release-notes нужно выполнить действия согласно инструкции [инструкции](https://wiki.yandex-team.ru/users/bemer/fix-lego-notes/).

1. [Обновите песочницу по инструкции](https://github.yandex-team.ru/lego/brickbox#contributing).

1. Обновите Лего-сайт [по инструкции](https://github.yandex-team.ru/lego/lego-site#%D0%9E%D0%B1%D0%BD%D0%BE%D0%B2%D0%B8%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-%D0%BA%D0%BE%D0%BD%D1%82%D0%B5%D0%BD%D1%82%D0%B0)

## Релиз lego-on-react

1. Находясь в релизной ветке, выполните команду `npm run react-dist-version ${release}`. Эта команда изменит `dist-packages/lego-on-react/package.json`.

1. Перейдите в папку `dist-packages/lego-on-react` и запустите `npm publish`.

## Патчевые релизы

1. Находясь в релизной ветке, перенесите туда необходимые изменения с помощью `git cherry-pick`. Убедитесь, что задачам, выходящим в патчевый релиз, проставлены соответствующие компоненты (`CHANGELOG`, `ИЗМЕНЕНИЯ`). Этим задачам необходимы примечания (они должны лежать в папке `release/notes`) - для того, чтобы пользователи знали, что именно вошло в патчевую версию, а также для корректной работы `iver`.

1. Убедитесь, что в измененных файлах нет новых `console.assert` или новых `css`-переменных.

1. Запустите утилиту [iver](https://github.yandex-team.ru/lego/iver) - так же, как описано в пункте [Релизная ветка](#Релизная-ветка).

1. Сделайте коммит, который будет содержать изменения в package.json и новые файлы с release-notes.

1. Далее следуйте инструкциям из пункта [Релиз](#Релиз).


## Портирование

1. Портируйте все необходимые коммиты из релизной ветки в разработческую (или в несколько разработческих веток) через новый PR с помощью `git cherry-pick`:
      - обновите версию `islands`
      - обновите версию `lego-on-react`
      - портируйте новые примечания к релизам
      - удалите пояснения к выпущенным задачам.

1. Удалите релизную ветку, она больше не нужна.
    <pre>
    git push origin :release/X.Y.Z
    </pre>

1. Закройте задачу про выпуск версии данной библиотеки. В описании задачи должны быть ссылки на changelog и новый тег:

1. С помощью массового редактирования задач в Трекере (bulk change) в каждой задаче, вошедшей в релиз, напишите комментарий
`Задача вошла в релиз islands 5.x.x, проверьте, пожалуйста, что все работает корректно.`


## Анонс

1. Подготовьте черновик поста, отправьте его на вычитку в рассылку [lego-team]
(пример оформления текста можно посмотреть в [шаблоне поста для релиза](https://beta.wiki.yandex-team.ru/lego/process/release_post/)).

1. После того как актуальная документация появится на сайте lego.yandex-team.ru, опубликуйте пост в клубе [lego]. Проставьте посту тег «релиз».

![mission accomplished](https://jing.yandex-team.ru/files/karamadjong/2014-06-20_1112.png)

[iver]: https://github.yandex-team.ru/karamadjong/iver/
[isle]: https://github.yandex-team.ru/lego/isle/
[semver]: http://semver.org/
[changelogger]: https://github.yandex-team.ru/lego/changelogger/
[github]: https://github.yandex-team.ru/
[startrek]: https://startrek.yandex-team.ru/
[teamcity]: https://quigon.yandex.ru/project.html?projectId=Islands&tab=projectOverview
[lego-team]: https://ml.yandex-team.ru/lists/lego-team/
[lego]: http://clubs.at.yandex-team.ru/lego/
[lego-dev]: http://clubs.at.yandex-team.ru/lego-dev/
[lego-islands]: https://ml.yandex-team.ru/lists/lego-islands/
[тестовом сайте Лего]: https://legoa.test.yandex-team.ru/
