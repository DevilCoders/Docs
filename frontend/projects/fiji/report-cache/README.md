# Файловый кэш для `templar` && `fiji`

## Общая информация

### Быстросоветы:
* добавить в ключ кэша `query arg`, который по умолчанию отфильтровывается, — `&cache_whitelist=key1;key2`;
* также `cache_whitelist=` влияет на [список параметров](https://github.yandex-team.ru/mm-interfaces/fiji/blob/dev/.templar/plugins/cache-key.js#L8-L17), которые отправляют в запросе за данными к `perl-report`

Например, мы хотим добавить кэш для связанных видео, а по умолчанию фильтруются все параметры `related*` удаляются из ключа, то нужно добавить в URL теста параметр `cache_whitelist=related`. Тогда кэш будет создан для всех необходимых запросов теста, но все остальные тесты не будут класть в кэш ничего лишнего.

## Режимы работы
Файловый кэш имеет три режима работы:
* `read` [по умолчанию] — только чтение значений из файловый системы.
* `create` — создание _новых_ ключей. Используется для создания новых ключей и данных для них. Если ключ уже существует, то данные не будут обновлены.
* `write` — создание или обновление ключей. В этом режиме старые данные для ключа будут перезаписаны.

Изменить режим работы можно с помощью переменной окружения:  
```bash
templar$ templar start --cache-mode=read
templar$ templar start --cache-mode=create
```

## Когда создавать кэш?
Файловый кэш — необходимое условие для работы `gemini` и `e2e` тестов. Если вы пишете новый тест, обновляете старый — вы должны добавить/обновить кэш. Ключей, которые не используются в тестах **не должно быть** в кэше.

В общем случае создание/обновление кэша сводится к следующей последовательности действий:
* запустить `templar` в нужном режиме;
* запустить нужный тест или вручную добавить данные;
* закоммитить изменения.

Директория **data** с сохраннёными `JSON` данными имеет древовидную структуру, основанную на `pathname` и `query` **ключа** запроса. `pathname` преобразуется в дерево директорий, `query` — в имя файла.

Примеры:
Ключ `images/?param=value` сохранится в
```
images\
  param=value.json
```

Ключ `video/search?text=bmw&p=2` сохранится в

```
video\
  search\
    text=bmw&p=2
```

Как правило, для работы с этими файлами в терминале, приходится брать их названия в кавычки — `vim "text=bmw&p=2`.

### Я написал новый тест, что делать?
В первую очередь, рекомендуется прогнать тест в режиме `read` (по умолчанию), посмотреть какие URL дёргает браузер в процессе выполнения этого теста. Как только вы убедитесь, что всё в пределах нормы — читайте инструкцию ниже ;)

1. `fiji$ fiji e2e|gemini path/to/test.js`

Если кэша нет, тогда:
1. `fiji$ fiji e2e|gemini path/to/test --cache-mode=create`

### Я хочу обновить данные для конкретного теста
1. `fiji$ fiji e2e|gemini path/to/test.js --cache-mode=write`
1. `cd report-cache`
1. проверьте изменения и закомитьте их

**Важно**: так как в `fiji` данные кэша реиспользуются между тестами, проверьте, что ваши изменения не ломают ничего рядом.

### Я хочу удалить устаревшие данные
1. `cd report-cache`
1. `rm -rf нужные запросы`
1. проверьте изменения и закомитьте их

## Ручная работа с данными
Если же нужно сэмулировать какую-то поломку данных, граничный кейс, который сложно поймать на реальных данных — используйте `patch`.
Патчи применяются к данным (или стабам данных) в темпларе (для автотестов и локальной разработки) или во всех кроме production в коде для использования без темплара (см. `sakhalin/blocks-common/patch-data/patch-data.common`).

### Я хочу добавить данные для определённого URL под авторизацией
1. `fiji$ templar start --cache-mode=create --public`
1. откройте браузер в инкогнито по ссылке `*.rserp.qloud.yandex.ru`
1. авторизуйтесь под **тестовым** пользователем (для консистентности, и для безопасности ваших `cookies` ;))
```bash
login: morozovtest1
password: morozovtest2
```
1. перейдите на нужную страницу
1. проверьте изменения и закомитьте их

### Я хочу модифицировать данные
1. `vim report-cache/patch/filename.js`

Содержимое файла `filename.js`:
```js
var _ = require('lodash');
/**
 * Синхронный метод обработки данных
 * @param {Object} data - данные, полученные от report
 * @returns {Object}
 */
module.exports = function(data) {
    data.x = 'ololo';
    return data;
};
```
1. `open localhost/images/?patch=filename; localhost/video/?patch=filename`
1. `cd report-cache`
1. отсмотреть изменения и закоммитить их
1. `filename` — название файла без расширения `.js`

##
## Правила хорошего тона
* старайтесь использовать существующие запрос, если это возможно, чтобы напрасно не раздувать кэш;
* проверяйте, что вы не коммитите ничего лишнего в репозиторий;
* обращайте внимание на `ключ`, не содержится ли в нём каких-то лишних параметров, или они наоборот отсутствуют.
