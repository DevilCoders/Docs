# Поведение плеера при включенном антиадблоке(ААБ) и пререндере
Что такое ААБ и как он работает можно почитать на [wiki](https://nda.ya.ru/3UWc6k)

## Проблематика пререндера ролика с включенным ААБ
После похода в ААБ весь результат работы репорт-рендерера кодируется(все ссылки и т.д.),
в том числе и атрибут `src` у iframe'a песочницы.

Для прокидывания в песочницу ролика вместо query-параметров используется фрагмент(hash),
чтобы для следующего ролика песочница бралась из кеша.
Во время декодирования этой ссылки коллеги из ААБ удаляют из урла наш хеш в целях безопасности.
Таким образом при включенном пререндере и ААБ пользователь вместо плеера видит на странице пустую область.

## Решение
Для обхода этой проблемы мы отдельно в атрибут `aab-url` кладем ссылку на песочницу, а в атрибут `aab-fragment` кладем параметры для песочницы.
Таким образом параметры для песочницы после кодирования страницы не кодируются вместе с урлом.

Для того, чтобы параметры попали в урл песочницы, склейку закодированного урла и параметров мы производим инлайн скриптом во время построения DOM-дерева.

# Отображение страницы при включенном ААБ
При включенном ААБ для page-layout проставляется модификатор `async-visibility_pre`, который
прячет блок `page-layout`.
Показываем блок `page-layout` в бандле `async-visibility-post`.
У бандла `async-visibility-post`в урл добавляется query-параметр `check-xhr-working=1`.

## Зачем это сделано
Показывающий код директа загружает данные посредством xhr запроса.
Чтобы адблок не заблокировал этот запрос, ААБ этот запрос кодирует.
Так как только этот запрос закодирован на странице, то его довольно лего определить регулярками.
Поэтому нам необходимо закодировать еще один xhr запрос, который был бы не отличим от запроса за данными директа, при блокировке которого страница бы сломалась и не позволила бы выкатить эти правила для адблока.
Этим еще одним xhr запросом является запрос за контентом бандла `async-visibility-post`.
Чтобы этот файл регулярки ААБ нашли на странице, а он фризится при релизе, мы добавляем к нему query-параметр `check-xhr-working=1`.
