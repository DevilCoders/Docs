# UGC

Блок-опросник пользователей про удовлетворенность сервисом.

Для отображения блока на странице необходимо в контент добавить блок `ugc`, в который нужно передать параметр `data` - данные UGC-сценария.

Пример:

```js
BEMPRIV.json({
    block: 'ugc',
    mods: {
        theme: 'light'
    }
}, data, {
    data: ugcData
});
```

## UGC-сценарий

UGC-сценарий — это код на специальном json-языке, описывающий процесс опроса пользователя.

Формат сценария:

```json
{
    "params": {},
    "nodes": []
}
```

Пояснения:

* `params` — необязательные top-level параметры
* `nodes` — массив UGC-нод (обязательное поле)

## UGC-нода

UGC-нода — минимальная единица сценария, которая в ходе выполнения сценария меняет свое состояние.

Возможные состояния ноды:
* Неактивна
* Активна
* Разрешена

Описание переходов:
* Сначала все ноды неактивны и не имеют значений
* Нода становится активной, если у нее нет значения (falsy-значение) и свойство `when` истинно
* Нода становится разрешенной, если у нее появляется значение или есть свойство `done` и оно истинно
* Разрешенная нода не может снова стать активной

![Ugc-states](https://jing.yandex-team.ru/files/vttly/ugc-states.png)

**Логические выражения** в свойствах `when` и `done` вычисляются по правилам:
* `undefined` — истина (только для `when`)
* `"foo"` — истина, если нода с `id = "foo"` разрешена любым значением
* `{ op: "eq", node: "foo", value: "bar" }` — истина, если нода с `id = "foo"` разрешена со значением `"bar"`
* `{ op: "not", ops: [$A] }` — истина, если логическое выражение `$A` ложно
* `{ op: "and", ops: [$A, $B, ...] }` — истина, если логические выражения `$A`, `$B` и т.д. истинны
* `{ op: "or", ops: [$A, $B, ...] }` — истина, если хотя бы одно из логических выражений `$A`, `$B` и т.д. истинны

Логическое выражение для "пользователь является клиентом (нода `id = "is-client"`), но не поставил оценку (нода `id = "rating"`) и не написал отзыв (`id = "review"`)" может быть записано так:

```json
{
    "op": "and",
    "ops": [
        { "op": "eq", "node": "is-client", "value": "yes" },
        {
            "op": "not",
            "ops": [{
                "op": "or",
                "ops": ["rating", "review"]
            }]
        }
    ]
}
```

## UGC-компонент

Для рендеринга ноды и выполнения клиентской логики (клик в кнопку и т.д.) необходимо создать компонент и указать тип нод, для которых будет использоваться компонент.

Минимально компонент должен состоять из одного priv-блока. Пример:

```js
BEMPRIV.decl('ugc-success', {
    init: function() {
        this.content(this.params.node.question);
    }
});
```

Параметры, которые передаются в priv-блок:
* `ugcId` — id сценария, в котором используется компонент
* `node` — данные ugc ноды

Чтобы указать для каких тип нод будет использоваться компонент нужно добавить поле в объект BLOCKS_MAP в [ugc-node.priv.js](/sakhalin/blocks-common/ugc-node/ugc-node.priv.js), в котором ключ - тип ноды, значение - имя priv-блока компонента.

При взаимодействии с пользователем (клик в кнопку и т.д.) нужно отравить событие `resolve` в канал `ugc`, в котором передать id сценария (`ugcId`), id текущей ноды (`id`), результат взаимодействия (`value`). Пример:

```js
BEM.channel('ugc').trigger('resolve', {
    ugcId: 'ugc-982263623659',
    id: '/video-common/video-would-recommend',
    value: 'yes'
});
```
