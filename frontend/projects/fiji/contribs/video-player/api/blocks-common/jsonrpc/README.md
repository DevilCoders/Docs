# JSONRPC — класс для взаимодействия между окнами

Данный класс реализует одну из версий [JSON-RPC](https://ru.wikipedia.org/wiki/JSON-RPC).

## Пример использования

Допустим, что у нас есть страница `index.html`, содержащая фрейм `iframe.html`.

### Подготовка

На каждой странице нужно создать свой экземпляр класса, конструктор которого принимает объект опций со следующими полями:
1. `target: Window` — *обязательный*, ссылка на окно, с которым предполагается взаимодействие
2. `version: number` — оговоренная версия протокола данных для конкретного приложения; отсутствие версии расценивается как любая версия
3. `procedures: Record<string, Procedure>` — список зарегистрированных процедур

Обработчик `Procedure` всегда принимает три параметра:
- `params: Record<string, any>` — параметры вызова процедуры или пустой объект, если параметры отсутствуют
- `done: (result: Record<string, any>) => void` — функция, вызов которой означает нормальное выполнение процедуры
- `error: (error: IError) => void` — функция, вызов которой означает ошибочное выполнение процедуры

При несоответствии окна или версии обработчики вызываться не будут.

```js
// index.html
var rpcIndex = new JSONRPC({
    target: document.getElementsByTagName('iframe')[0].contentWindow,
    version: 1,
    procedures: {
        proc: function(data, done, error) {
            console.log(data); // { foo: 'bar' }

            done({ ok: true });
            // или
            error({ code: 502, message: 'some error' });
        }
    }
});
```

```js
// iframe.html
var rpcIFrame = new JSONRPC({
    target: window.parent,
    version: 1
});
```

### Взаимодействие

На странице `iframe.html` вызываем процедуру `proc` и передаём данные вторым параметром:
```js
// iframe.html
rpcIFrame.call('proc', { foo: 'bar' }, function(result) {
    console.log(result); // { ok: true }
}, function(error) {
    console.error(error); // или { code: 502, message: 'some error' }
});
```

## Методы

### Метод `call()`

Вызывает процедуру в удалённом окне.

Метод `call()` принимает следующие параметры:
- `procedure` — *обязательный*, имя события
- `params` — параметры вызова процедуры, всегда в виде объекта
- `doneCallback` — обработчик нормального выполнения процедуры на принимающей стороне
- `errorCallback` — обработчик ошибочного выполнения процедуры на принимающей стороне

## Особенности

### Один экземпляр — одно окно

Для одного целевого окна возможно создать только один экземпляр с определённой версией для взаимодействия. При попытке создать второй экземпляр без версии или с аналогичной версией на то же самое окно будет выброшена ошибка:

```js
new JSONRPC({
    version: 1,
    target: window
});
try {
    new JSONRPC({
        version: 1,
        target: window
    });
} catch (err) {
    console.log(err); // Error: This target with version 1 already registered in other instance
}
```

### Ошибка в процедуре

Каждый вызов процедуры оборачивается в `try..catch` и при возникновении непойманного исключения в работе процедуры будет вызван обработчик `error({ code: -32000, message: 'Error message' })`.

### Особенности вызова `done()` и `error()`

Нужно всегда обязательно вызывать либо `done()`, либо `error()`, иначе цикл вызова процедуры не будет считаться заверёшнным. Это приведёт к двум последствиям:
1. вызывающая сторона не получит результата выполнения процедуры
2. возникнет утечка памяти из-за неочистки обработчиков

Один и тот же обработчик не должен вызывать одновременно `done()` и `error()` — результат должен быть либо нормальным, либо ошибочным.

### Уничтожение экземпляра

При уничтожении экземпляра класса, нужно предварительно вызвать метод `destroy()`, чтобы отписаться от событий.

```js
rpc.destroy();
rpc = null;
```
