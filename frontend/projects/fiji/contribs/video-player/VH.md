Плеер видеохостинга Яндекса
===========================

## Методы вставки
1. Через js-api плеера: [дока](https://wiki.yandex-team.ru/video/sandbox/Vh-player-js-API/)
2. Через iframe: [дока](https://yandex.ru/support/video-hosting/embed-code.html)
3. Через iframe c api поверх postMessage: [пример](./vh-public-api/examples/player.example.html), [описание типов](./vh-public-api/build/types.d.ts)

## Параметры плеера

Передать параметры можно как get-аргументами в ссылке на плеер при вставке через iframe, так и в ключах queryObject
при создании плеера через js-api.

### Условные обозначения:
* __`*`__ - обязательные параметры;
* _`!`_ - параметры, использовать которые не рекомендуется;
* `<string>` - параметр может принимать любое значение данного типа;
* `1|0` - параметр принимает значение из данного перечисления;
* `[0, 100]` - параметр принимает любое значение из данного числового отрезка;
* `true` - параметр принимает только данное значение;
* *(default: 100)* - значение по умолчанию.

### Основные параметры:
* __`* from = <string>`__ - код сервиса, на котором вставлен плеер. Пример: `from=yavideo`
* __`* reqid = <string>`__ - id запроса за страницей сервиса, на которую вставлен плеер. Пример: `reqid=12345-sas1`
* `service = <string>` - id сервиса для запроса за лицензией для лицензионного контента в ОТТ. Может отличаться от from. Пример: `service=ya-video`
* `from_block = <string>` - код блока вёрстки, в который вставлен плеер. Используется как уточняющий параметр к `from`. Пример: `from_block=preview`
* `event_prefix = <string>` - префикс для postMessage-сообщений от плеера. Пример: `event_prefix=player-event.`
* `autoplay = 1|0` - *(default: 1)* включает автовоспроизведение видео в плеере при открытии страницы в браузере. Параметр
`autoplay` будет проигнорирован, если задан параметр `allow_muted`.
* `allow_muted = 1|0` - разрешает автовоспроизведение без звука. Параметр `allow_muted` имеет приоритет перед `autoplay`.
При использовании `allow_muted=0` автовоспроизведение произойдет только в случае, если оно возможно со звуком.
* `preload = 1|0` - *(default: 0)* включает или выключает предзагрузку потока видео при `autoplay=0`
* `mute = 1|0` - *(default: 0)* выключает или включает звук в плеере (на старте)
* `tv = 1` - отключает интерфейс плеера
* `loop = 1` - зацикливает воспроизведение видео
* `report = 1|0` - *(default: 1)* включает или выключает иконку формы для обратной связи в плеере
* `preview = 1|0` - *(default: 1)* включает или выключает отображение превью видео
* `preview_src = <string>` - позволяет задать собственный постер для видео
* `skin` - параметр, управляющий загрузкой скина, подробнее см. в [документации плеера](https://playerweb-ci.s3.mds.yandex.net/video-player-iframe-api/stands/master/docs-v2/interfaces/publicplayerapiloaderparams.html#loadskin). Передача параметра с типом `Function` возможна только при использовании вставки с помощью js-api.
* `force_unmute = 1|0` - *(default: 0)* включает отображение поверх плеера кнопки для включения звука в плеере
* `play_on_visible = [0, 1]|true|false` - число задает минимальную видимость плеера для воспроизведения контента (0 - любая, 1 - полная, 0.5 - половина и т.д.). `true` включает ограничение видимости в плеере с ограниченем по умолчанию. `false` отключает зависимость воспроизведения от видимости. По умолчанию, плеер со звуком играет всегда, плеер без звука играет только когда видим.
* `volume = [0, 100]` - *(default: 100)* громкость плеера на старте в процентах. Деактивируется параметром `mute=1`. Пример: `volume=50`
* `hidden = <string>` - список [контролов плеера](https://playerweb-ci.s3.mds.yandex.net/video-player-iframe-api/stands/master/docs-v2/enums/controlname.html), которые хочется скрыть. Пример: `hidden=startScreenPlay,play`
* `slow_connection = 1|0` - *(default: 0)* позволяет передать в песочницу и плеер информацию о медленном интернете
* `retpath = <string>` - позволяет задать url, куда вернётся пользователь после авторизации для выноса видео на станцию
* `ya_station = 1|0` - *(default: 1)* позволяет отключить кнопку выноса на станцию
* `share = 1|0` - *(default: 1)* позволяет отключить все способы поделиться видео

### Вывод мета-информации о ролике:
* `meta = none|always|start|ui` - *(default: none)* включает отображение мета-информации в скине плеера. Разные значения меняют видимость меты
* `m_duration = <number>` - *(default: 3)* время отображения меты со старта воспроизведения в секундах (только для режима `meta=start`)
* `m_title = <string>` - заголовок мета-информации. Пример: `m_title=Игра престолов`
* `m_desc = <string>` - текст под заголовком в мета-информации. Пример: `m_desc=Сезон 3 серия 5`

### Сохранение прогресса воспроизведения:
* `progress = 1|0` - *(default: 1)*  включает или выключает сессионное сохранение прогресса в плеере
* `start_position_confirmation = 1|0` - *(default: 0)* включает отображение экрана восстановления прогресса воспроизведения. Не работает с включённым автоплеем.
* _`! restore_playback_progress = 1|0`_ - *(default: 0)* включает локальное сохранение прогресса воспроизведения в плеере
* `remote_progress_saving = 1|0` - *(default: 0)* включает отправку информации о текущем прогрессе просмотра

### Брендирование:
* `branding_intro = 1|0` - *(default: 0)* включает интро Эфира
* `show_brand_play_button = 1|0` - *(default: 0)* показывать брендированную кнопку запуска воспроизведения

### Пропуск второстепенных фрагментов видео:
* `skippable_fragments = 1|0` - *(default: 1)* включает или выключает пропускаемые фрагменты в плеере

### Параметры настройки рекламы:
* `brand-safety-categories = <string>` - список категорий рекламы, которых можно показывать на данном типе контента. Пример: `brand-safety-categories=12,34,56`
* `subscribe_button = plain|colourful|with_subscribe_info|with_subscribe_label` - включает отображение кнопки "Показать без рекламы" в соответствующем дизайне
* _`! with_ad_insertion = true`_ - вызвать вставку рекламы серверной врезкой на уровне STRM
* _`! adConfig = <json>`_ - позволяет полностью переопределить конфиг рекламы в плеере. Использование параметра логируется плеером как warning
* _`! partner_id = <number>`_ - позволяет переопределить id площадки, которой будет перечисляться доход с рекламы. Использование параметра логируется плеером как warning
* _`! use_ad_session = 1|0`_ - позволяет отключить рекламную сессию
* _`! has_preroll =  1|0`_ - позволяет указать плееру, задан ли преролл на текущем видео

### Технические параметры:
* `test-id = <string>` - test-id сервиса, для проклейки экспериментов сервиса с логами STRM. Так же служит для ручного включения определённых экспериментальных выборок. `test-id=1` - включает дефолтную песочницу
* `distr_id = <string>` - id площадки для дистрибуции контента. Пример: `distr_id=partner123`
* `slots = <string>` - слоты экспериментов для проклейки с STRM-логами
* `counters = <json>` - включает логирование смотрения в плеере посредством [универсальных счётчиков смотрения Я.Видео](https://wiki.yandex-team.ru/video/sandbox/#logirovaniesmotrenijacherezpesochnicu)
* `stream_cms = 1|0` - отключает использование пакета ЭФира streamCms (Используется только Эфиром)
* `velocity_metrics_sampled = 1|0` - *(default: 0)* отключает выборочное логирование скоростных метрик в плеере
* _`! disable_update = 1|0`_ - отключает перезапрос данных и перезагрузку  плеера при протухании подписи/drm-конфига (Используется только Толокой)
* _`! externalFlags = <json>`_ - позволяет передать объект с набором флагов. Устарел, в будущем будет удалён, использовать не рекомендуется
* _`! sandbox_version = <string>`_ - зашивает определённую версию песочницы. Технический параметр
* _`! version = <string>`_ - зашивает определённую версию плеерного движка. Технический параметр
* _`! beta = true`_ - *(default: false)* включает загрузку скриптов плеерного движка с beta.yastatic.net. Технический параметр
* _`! mb_flags = <string>`_ - позволяет переопределить экспериментальные флаги. Технический параметр. Пример: `mb_flags=flag1=1;flag2=0`
* _`! use_friendly_frame = 1|0`_ - *(default: 0)* включает использование плеера Яндекса без iframe. Технический параметр
* _`! player_api_adapter = 1|0`_ - *(default: 1)* выключает использование адаптера ко второй версии плеерного движка. Технический параметр
* _`! live_offset = <number>`_ - меняет окно перемотки для прямого эфира
* _`! puid = <string>`_ - id паспортной сессии пользователя
* _`! api_host = <string>`_ - подменяет ручку для похода за данными
* _`! release_timeout = <number>`_ - подменяет время до начала трансляции. Технический параметр, предназначен для тестирования
* _`! background_color = <string>`_ - устанавливает фон под плеером при useFriendlyFrame==true (по-умолчанию, фон чёрный)
* _`! zen_preload = 1|0`_ - включает в плеере фиксы для ленты Дзена в режиме использования одного плеера с предзагрузкой
* _`! disable_postmessage_broadcast = 1|0`_ - отключает в плеере broadcast postMessage с targetOrigin == '*'

### Технические параметры для тестирования
* `test_mode = 1|0` - *(default: 0)* включает mock плеера
* `test_data = default|live|paid|avod|alive` - *(default: default)* определяет пресет данных для тестирования
* _`! scriptedEvents = <array>`_ - позволяет переопределить сценарий [событий](https://playerweb-ci.s3.mds.yandex.net/video-player-iframe-api/stands/master/docs-v2/interfaces/scriptedevent.html) для мока движка плеера

#### [Пресеты](https://a.yandex-team.ru/arc_vcs/frontend/projects/fiji/contribs/video-player/presets?rev=trunk):
1. `default` - vod контент без событий рекламы
2. `live` - live контент без событий рекламы
3. `paid` - данные с заглушкой для платного контента
4. `avod` - vod контент с событиями рекламы
5. `alive` - live контент с событиями рекламы

#### Как добавить новый пресет
1. Самостоятельно
   1. Добавить json файл в [папку с пресетами](https://a.yandex-team.ru/arc_vcs/frontend/projects/fiji/contribs/video-player/presets?rev=trunk) (в качестве примера можно взять любой доступный файл).
   2. Дописать пресет в [валидатор](https://a.yandex-team.ru/arc_vcs/frontend/projects/fiji/contribs/video-player/sandbox/blocks-yandex/vh-query-common/vh-query-common.vanilla.js?rev=trunk#L35).
   3. Поправить [юниты](https://a.yandex-team.ru/arc_vcs/frontend/projects/fiji/contribs/video-player/sandbox/blocks-yandex/vh-query-common/vh-query-common.test.js?rev=trunk#L471).
   4. Отправить в ревью (желательно добавить в ревьюеры разработчика из плеера/песочницы).
   5. Выпустить пакет песочницы и проверить, что пресет прокидывается корректно.
   6. После успешного прохождения ревью - влить в trunk.
   7. Создать тикет в плеер/песочницу для деплоя необходимого содержимого.
2. Создать тикет в плеер/песочницу с полным описанием нужного набора данных.


#### Пример сценария событий:
````json
[
    {
        "event": "StartStageChange",
        "data": {
            "startStage": "started"
        },
        "delay": 0
    },
    {
        "event": "ContentImpression",
        "data": {},
        "delay": 0
    },
    {
        "event": "PlayingStateChange",
        "data": {
            "playingState": "play",
            "playingStateReason": "Unknown"
        },
        "delay": 0
    },
    {
        "event": "PlayingStateChange",
        "data": {
            "playingState": "pause",
            "playingStateReason": "ExternalApi"
        },
        "delay": 5000
    },
    {
        "event": "PlayingStateChange",
        "data": {
            "playingState": "play",
            "playingStateReason": "ExternalApi"
        },
        "delay": 5000
    },
    {
        "event": "PlayingStateChange",
        "data": {
            "playingState": "end",
            "playingStateReason": "Unknown"
        },
        "delay": 5000
    }
]
````

## События плеера
* `inited` - готовность API плеера (можно дергать методы плеера)
* `error` - ошибка плеера
* `resourcesIdle` - плеер загрузил основные ресурсы и освободил сеть
* `sizeChange` - изменился контейнер плеера; данные события - объект с новыми размерами контейнера
  ```
  const dataSizeChangeType = {
    videoHeight: number,
    videoWidth: number,
    isAd: boolean
  };
  ```

### События воспроизведения
* `started` - начало воспроизведение видео
* `paused` - видео поставлено на паузу
* `resumed` - видео снято с паузы (продолжение воспроизведения)
* `ended` - конец воспроизведения видео
* `timeupdate` - изменение текущего времени воспроизведения; в качестве данных принимает объект
  ```
  const dataTimeUpdateType = {
    time: number,
    utcTime: number,
    watchedTime: number,
    duration: number
  }
  ```
* `contentImpression` - показ первого кадра
* `durationchange` - появилась новая информация о длине видео; в качестве данных отправляет
  ```
  {
    duration: number;
    ...
  }
  ```

### События рекламы
* `adShown` - показ рекламы (начало рекламы)
* `adEnd` - конец рекламы
* `adPodStart` - начало рекламного сюжета

### События прямых трансляций (ugc_live)
* `ViewersNumberChanged` - обновление количества зрителей ugc_live трансляции; в качестве данных принимает число зрителей
  ```
  {
    viewers: number;
    ...
  }
  ```

### События платного контента
* `svodSubscribe` - нажатие кнопки "Смотреть без рекламы"
* `placeholder:init` - показ заглушки платного контента
* `placeholder:pay` - нажатие на кнопку "Смотреть" (или аналогичную) заглушки платного контента

## Как посмотреть настройки плеера

### Просмотр параметров

Проверить с какими параметрами был построен плеер можно вызвав в консоли браузера (в скоупе плеера) код `Sandbox.instances[0].query`.
Аналогично, для проверки попадания плеера под влияние какого либо эксперимента достаточно вызвать код `Sandbox.instances[0].expFlags`.

![Показать параметры плеера](./docs/images/vh-get-params.png)

### Изменение параметров на проде

Для того чтобы наживую на проде проверить влияние определённого параметра плеера или экспериментального флага достаточно
вызвать следующий код:

```js
(({ params, query, expFlags }) => {
    // Поменять параметры плеера ВХ
    query.some_param = 'some_value';

    // Поменять экспериментальные флаги
    expFlags.some_flag = 1;

    query.mb_flags = expFlags.toString(';');
    params.queryConfig = query;
    Sandbox.init(params);
})(Sandbox.instances[0])
```

![Установить параметры плеера](./docs/images/vh-set-params.png)
