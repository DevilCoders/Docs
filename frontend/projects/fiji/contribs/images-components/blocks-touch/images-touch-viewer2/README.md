# images-touch-viewer2

Просмотрщик картинок для тач-устройств.

<a name="mods"></a>
### Модификаторы блока

| Модификатор | Значения | Способы установки | Описание |
| ----------- | -------- | ----------------- | -------- |
| `type` | `carousel` | `deps`, `BEMJSON` | Формирует просмотрщик из трёх блоков `viewer-item2` внутри `viewer-carousel2`. Это обычный просмотрщик. |
| `type` | `single` | `deps`, `BEMJSON` | Формирует просмотрщик из одного блока `viewer-item2`. Такой просмотрщик подходит для увеличения одной картинки. |
| `content` | `no` | `deps`, `BEMJSON` | Простой просмотрщик: картинка по центру, а внизу экрана панель с доменом и кнопками. <br><img src="https://jing.yandex-team.ru/files/tenorok/viewer2.png" height="300"> |
| `content` | `yes` | `deps`, `BEMJSON` | Просмотрщик со скроллом: картинка наверху и под ней дополнительные блоки. <br><img src="https://jing.yandex-team.ru/files/tenorok/viewer2_content1.png" height="300"> |
| `[content-cut]` | `half-cutted` | `deps`, `BEMJSON` | Просмотрщик со скроллом: картинка наверху и занимает 60% экрана и под ней дополнительные блоки. |
| `[content-switch]` | `true` | `js` | Переключает модификаторы `_content_yes|no` и `_image-top_normal|''` на лету, смотря на данные. |
| `[fullscreen-enable]` | `yes` | `deps`, `BEMJSON` | Сочетается только с `_content_yes`. Активирует возможность включения полноэкранного режима. |
| `[fullscreen-type]` | `single` | `BEMJSON` | Сочетается только с `fullscreen-enable`. Активирует режим отключения fullscreen при каждом листании. |
| `[clear-enable]` | `yes` | `deps`, `BEMJSON` | Активирует возможность скрывать всё, кроме картинки. |
| `[progress-enable]` | `yes` | `deps`, `BEMJSON` | Сочетается только с `_content_yes`. Добавляет спиннер. Используется при открытии просмотрщика по прямой ссылке на картинку. |
| `[title]` | `yes` | `deps`, `BEMJSON` | Добавляет тайтл просмотрщику. Не совместим с модификатором `_share-enable_yes`. |
| `[close]` | `yes` | `deps`, `BEMJSON` | Добавляет крестик закрытия просмотрщика. |
| `[back-on-close]` | `yes` | `deps`, `BEMJSON` | При закрытии просмотрщика крестиком, делать 1 переход назад по истории. |
| `[bottom-panel]` | `yes` | `BEMJSON` | Добавляет нижнюю панель для кастомного содержимого. |
| `[domain]` | `yes` | `deps`, `BEMJSON` | Добавляет домен в нижнюю панель.|
| `[cbir-button]` | `yes` | `deps`, `BEMJSON` | Добавляет кнопку Сибири в нижнюю панель.|
| `[cbir-button-new-tab]` | `yes` | `BEMJSON` | Ссылка Сибири открывается в новом окне. |
| `[behavioral-direct]` | `yes` | `BEMJSON` | Поведенческий директ при отсутсвии спецразмещенияю. |
| `[save]` | `yes` | `deps`, `BEMJSON` | Добавляет кнопку сохранения картинки в нижнюю панель. |
| `[close-swipe-enable]` | `yes` | `deps`, `BEMJSON` | Обрабатывает жест закрытия просмотрщика смахиванием. По умолчанию: жест не обрабатывается. |
| `[swipe-enable]` | `yes` | `deps`, `BEMJSON` | Обрабатывает жест листания карусели. По умолчанию: карусель листается только стрелочками. |
| `[scale-enable]` | `yes` | `deps`, `BEMJSON` | Обрабатывает жесты увеличения картинки двумя пальцами и двойным тапом. По умолчанию: картинка не увеличивается. |
| `[apps-api]` | `yes` | `deps`, `BEMJSON` | Добавляет вызовы Yandex App API при открытии и закрытии просмотрщика. |
| `[visible]` | `yes` | `JS` | Делает просмотрщик видимым. |
| `[nourl]` | `yes` | `BEMJSON` | Позволяет не пытаться грузить оригинал, если не пришел для него урл. (Остается картинка из тумбы) |
| `[templates]` | `loading` , `loaded` | `deps`, `BEMJSON` | Используется для управления стадиями загрузки шаблонов. `_loading` - загружается, `_loaded` - загружены. Сочетается с модификатором `_content_yes`. |
| `[collections]` |  `yes` | `BEMJSON` | Добавляет связанные коллекции. Сочетается с модификатором `_content_yes`. |
| `[controls-opacity]` | `yes` | `BEMJSON` | Увеличивает прозрачность крестика и панели с доменом по мере вертикального скролла. Сочетается с модификаторам `_content_no`. |

### Проектные модификаторы блока
| Модификатор | Значения | Способы установки | Описание |
| ----------- | -------- | ----------------- | -------- |
| `[share-enable]` | `yes` | `deps`, `BEMJSON` | Включает нативную поделяшку в мобильном приложении. Не совместим с модификатором `_title_yes`. |
| `[rim]` | `yes` | `BEMJSON` | Добавляет RIM-похожие. Сочетается с модификатором `_content_yes`. |
| `[related]` | `yes` | `BEMJSON` | Добавляет похожие. Сочетается с модификатором `_content_yes`. |
| `[context-overlay]` |  `yes` | `BEMJSON` | Добавляет оверлей в виде картинки с ссылкой на оригинал в src. Необходимо для решения проблемы скачивания картинок из контекстного меню. |
| `[panel-share]` |  `yes` | `deps`, `BEMJSON` | Добавляет кастомную поделяшку в нижнюю панель.  |
| `[panel-collections]` |  `yes` | `deps`, `BEMJSON` | Добавляет кнопку добавления в коллекции в нижнюю панель.  |
| `[tags]` | `true` | `deps`, `BEMJSON` | Добавляет в контент теги. |
| `[editor]` | `yes` | `BEMJSON` | Кнопка перехода в редактор | |

### Приватные модификаторы блока
| Модификатор | Значения | Способы установки | Описание |
| ----------- | -------- | ----------------- | -------- |
| `[fullscreen]` | `yes` | `image-touch-viewer2_fullscreen-enable_yes.deps.js`, `JS` | Включает полноэкранный режим. |
| `[clear]` | `yes` | `image-touch-viewer2_clear-enable_yes.deps.js`, `JS` | Скрывает всё, кроме картинки. |
| `[scaled]` | `yes` | `image-touch-viewer2_scale-enable_yes.deps.js` | Cообщает о том, что картинка увеличена. Скрывает все, кроме картинки. |
| `[gestures]` | `yes` | `image-touch-viewer2_close-swipe-enable_yes.deps.js, image-touch-viewer2_swipe-enable_yes.deps.js` | Псевдо-модификатор. В нем лежит общая функциональность жестов, нужна для модификаторов `swipe-enable` и `close-swipe-enable`. |

### Экспериментальные модификаторы блока
| Модификатор | Значения | Способы установки | Описание |
| ----------- | -------- | ----------------- | -------- |
| `[panel-wide]` | `yes` | `BEMJSON` | Включает планшетный вид панели с контролами: домен и контролы на одной строке в 2 колонки. |
| `[panel-wide-side]` | `yes` | `BEMJSON` | Для планшетного вида панели включает выравнивание элементов по краям колонок (чтобы с планшетов удобнее было нажимать на домен/кнопки). |
| `[image-top]` | `normal` | `BEMJSON` | Прибивает картинку к верху. | |

### Логика увеличения картинки

Логика увеличения картинки отличается в зависимости от вида просмотрщика и его текущего состояния.

**`_content_no + _scale-enable_yes`**: В обычном просмотрщике с включенной обработкой жестов увеличения картинки обрабатываются события `doubletap` и `pinch`, при возникновении которых добавляется модификатор `_clear_yes` и картинка увеличивается через инлайн-стили.

**`_content_yes + _scale-enable_yes`**: В просмотрщике со скроллом и включенной обработкой жестов увеличения картинки обрабатывается событие `doubletap`, при возникновении которого добавляется модификатор `_fullscreen_yes` и картинка увеличивается через инлайн-стили на фиксированную величину.

**`_content_yes + _scale-enable_yes + _fullscreen_yes`**: При нахождении в полноэкранном режиме просмотрщика со скроллом становится доступным жест `pinch`, при возникновении которого добавляется модификатор `_fullscreen_yes` и картинка увеличивается через инлайн-стили на произвольную величину.

### Проблема `preventDefault()` в Chrome 56

В Chrome начиная с 56 версии оптимизировали скорость отклика на скролл [путём ввода опции `passive` в `addEventListener()`](https://www.chromestatus.com/features/5093566007214080) ([подробности](https://developers.google.com/web/updates/2017/01/scrolling-intervention)).
При подписке на любые элементы, кроме `document` и `body`, эта опция устанавливается в `false` — это значит, что в обработчике есть возможность вызвать `preventDefault()`.

Подписка через `liveBindTo()` являтся делегированной и навешивает обработчик на `document`, внутри такого обработчика нет возможности вызывать `preventDefault()`, поэтому в тех случаях, когда такая возможность необходима, подписываемся через `bindTo()`.

В i-bem используется jQuery, где ещё нет возможности [передавать опции при подписке на события](https://github.com/jquery/jquery/issues/2871).
