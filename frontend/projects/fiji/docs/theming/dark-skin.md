# Тёмная тема

В сервисах Картинок и Видео поддержана темная тема на **тачах**. Эта документация о том, как она работает.

Всё, что описано ниже, работает и на других платформах. Однако, темная тема официально существует пока только на **тачах**. А на **десктопе** в данный момент она доступна под флагом `dark_theme_desktop=light|dark|cookie`.

## Принцип работы

Существует 3 **режима темы**:

- `light` светлая тема.
- `dark` темная тема.
- `system` тема как в системе.

**По-умолчанию:**

- В Поисковых Приложениях выставляется режим `system`. Разработчики ПП сделали так, чтобы `prefers-color-scheme` использовал не тему системы, а тему самого приложения.
- Для обычных браузеров используется режим темы в зависимости от значения куки `yp.skin`. `d` — `dark`, `l` — `light`, иначе `system`.

**Для тестирования** есть флаг:

- `dark_theme_touch` — включает темную тему в сервисах Картинки и Видео на тачах. В качестве значения можно задать любой из режимов работы темы.

Для проведения **эксперимента** есть флаг `dark_theme_touch_default_pref` — устанавливает тему, если пользователь в меню не выбрал конкретную.

## Цвета

Прежде, чем читать далее, рекомендую ознакомится со [сборкой и цветами fiji](./colors.md).
__Если ваша фича не меняется в зависимости от светлой и темной темы__, нужно пользоваться тем,
что написано в документации по цветам.

Чтобы поддерживать темизацию было несложно, существует 2 дополнительных набора переменных -
для [светлой](../../.config/postcss/variables/light.js) и [темной](../../.config/postcss/variables/dark.js) тем.

Каждая переменная из этого файла начинается на `--color-g-`, где `g` означает `global`. Ключи в светлой теме и темной
совпадают, таким образом, при переключении тем один набор переменных заменяется другим, и страницы перекрашиваются.

Для преобразования цветов используется всё тот же плагин `postcss-css-variables`, что и для обычных цветов,
поэтому записи в `scss` файлах идентичны:

```css
.Component {
    color: var(--color-g-text-primary);
}
```

лишь только названия переменных __семантичные__. Отсюда подобные группировки:

- `--color-g-bg-` — цвет фона
- `--color-g-text-` — цвет текста
- `--color-g-control-` — цвет элементов управления
- `--color-g-link` — цвет ссылок, гринурлов

а также цвета, характерные исключительно для наших сервисов: `--color-g-footer-bg`, `--color-g-cbir-viewer-bg-overflow` и т.д.

Записи такого вида в файлах стилей преображаются в следующий код:

```css
.Component {
    color: #000;
    color: var(--color-g-text-primary);
}
```

`color: #000;` — это фолбек значения переменой в светлой теме для тех браузеров, которые не поддерживают `var`.
Остальные же браузеры берут значения переменных в рантайме, таким образом в них возможно переключение темы
подменой переменных.

## Механика переключения темы

Прежде, чем говорить о механике работы, выделим ключевые слова:

- `skinMode` — **режим темы** `light`, `dark` или `system`.
- `skin` — **текущая тема** `light` либо `dark`. В случае `skinMode = system`, `skin` честно соответствует той теме, в которую мы разукрашиваю страницу.

__Во время сборки__ плагин `postcss-css-variables` оставляет все `--color-g-` переменные в несобранном виде.

__В рантайме__:

1. На сервере устанавливается переменная `data.skinMode` — текущая выбранная тема сервиса.
2. Если у пользователя явно выбрана тёмная тема (`skinMode = dark`), на `body` выставляется класс `i-ua_skin_dark`. Если `skinMode = system`, класс выстявляется в presearch в случае, если в системе темная тема.
3. В presearch пушатся переменные светлой темы на селектор `:root` и темной темы на селектор `.i-ua_skin_dark`.
4. В presearch определяются переменные `window.Ya.skin` и `window.Ya.skinMode`. Их можно использовать.
5. В presearch вставляется скрипт с обработчиками смены темы. Если `skinMode = system`, тогда подписываемся на событие
смена системной темы через `matchMedia.addEventListener`.

__Пользователь__ через бургер меню может поменять **режим темы** в любой момент, и страница моментально перекрасится. В ПП тему можно поменять в настройках приложения. Тема наших сервисов соответствует теме ПП. При сменен режима темы отправляется запрос, чтобы синхронизировать тему с Мордой.

В случае смены темы срабатывают обработчики в presearch.

Можно подписаться на событие смены **режима темы**:

```js
window.addEventListener('skin_mode_change', (event) => {
    event.detail // light, dark, system
}
```

и событие смены **текущей темы**:

```js
window.addEventListener('skin_change', (event) => {
    event.detail // light, dark
}
```

Последнее срабатывает даже тогда, когда `skinMode = system`, и изменилась тема самой системы.

Эти обработчики могут быть полезны в случае, если при смене темы или режима работы нужно перерисовать часть страницы. Рекламу, например.

## Нестандартные случаи

Возможны случаи, когда одной смены цветов недостаточно. Например, не существует нужно маппинга цветов из
светлой в темную тему, нужно убрать тень или сменить цвет иконки.

Для таких случаев есть селектор `.i-ua_skin_dark`.

Так, например, можно перекрасить иконку:

```css
.icon_burger {
    background-image: url("icon_burger.svg");

    .i-ua_skin_dark & {
        background-image: url("icon_burger_inverse.svg");
    }
}
```

А так цвет:

```css
$color-counter-bg: #027bf3;
$color-counter-bg-inverse: #56a8fc;

.FiltersPanel {
    &-SwitcherBadge {
        background-color: $color-counter-bg;

        .i-ua_skin_dark & {
            background-color: $color-counter-bg-inverse;
        }
    }
}
```

Для смены цветов в тёмной теме есть альтернативный вариант:

```css
.FiltersPanel {
    &-SwitcherBadge {
        --color-l-counter-bg: #027bf3;

        .i-ua_skin_dark & {
            --color-l-counter-bg: #56a8fc;
        }

        background-color: var(--color-l-counter-bg);
    }
}
```

Объявленная переменная должна начинаться с `--color-l-`, где `l` означает local.
Такие переменные обрабатываются особым образом, аналогично `--color-g-` переменным.
Плагин `postcss` превратит этот файл стилей в:

```css
.FiltersPanel {
    --color-l-counter-bg: #027bf3;
}
.i-ua_skin_dark .FiltersPanel {
    --color-l-counter-bg: #56a8fc;
}
.FiltersPanel-SwitcherBadge {
    background-color: #027bf3;
    background-color: var(--color-l-counter-bg);
}
```

Такой вариант объявления уникальных цветов, которые меняются в тёмной теме, предпочтителен,
если переменная используется в нескольких местах одного файла.

Однако, __если вам нужен свой маппинг цветов в нескольких фичах__, не стесняйтесь добавлять его к переменным.
Только называйте семантично. **Но учитывайте!** что все переменные едут в пресерч в каждый сервис,
поэтому добавляйте их с умом.

**Важно!** Не все браузеры поддерживают `var` переменные, поэтому необходимо, чтобы фолбек работал.
А работает он при определённом условии: только когда переменная `--color-l-` лежит внутри селектора,
или внутри его родителя. Покажу на примере:

```css
.FiltersPanel {
    --color-l-counter-bg: #027bf3;

    background-color: var(--color-l-counter-bg); /* Тут фолбек сработает */
    
    :after {
        background-color: var(--color-l-counter-bg);
        /*
         * Тут тоже сработает, ведь плагину postcss-a ясно, что это селектор
         * .FiltersPanel:after, то есть .FiltersPanel является родителем, а там есть эта переменная
         */
    }

    &-SwitcherBadge {
        background-color: var(--color-l-counter-bg);
        /*
         * А тут фолбек вернёт undefined, ведь мы находимся внутри селектора .FiltersPanel-SwitcherBadge
         * И селектор .FiltersPanel не является его родителем.
         */
    }

    /* Поэтому, если всё же хочется передать цвет в такой селектор, нужно написать так */
    .FiltersPanel-SwitcherBadge {
        background-color: var(--color-l-counter-bg);
    }
}
```

## Тестирование
В гриде заведены браузеры `desktop-chrome-dark` и `touch-phone-chrome-dark` в которых по умолчанию включается тёмная тема.

Для тёмной темы запускаются не все тесты, а только те которые помечены как `hermione.also.in('touch-phone-chrome-dark');`.

Пример:
```js
    hermione.also.in('touch-phone-chrome-dark');
    it('Внешний вид', async function() {
        await this.browser.goURL({
            page: 'search',
            query: {
                text: 'bmw x5',
            },
        });
    });
```
