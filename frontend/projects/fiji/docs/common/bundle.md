# Бандлы

> Всё нижеописанное относится к бандлированию i-bem (старый стек), и не относится к бандлам webpack (новый стек)

> Бандл — набор из необходимых зависимостей, которые обеспечивают работоспособность проекта, фичи или эксперимента.

### Как вынести функциональность в бандл

Чтобы вынести функциональность в бандл, необходимо создать для неё `bemdecl` и удалить из `deps` в проекте.
Всё что будет в `deps` проекта — удалится из бандла во время сборки, чтобы не было дублирования.

`Bemdecl` бандла кладём в `{service}/{platform}/pages/common/bundles/{bundle-name}/{bundle-name}.bemdecl.js`.

Вызвать `data.pushBundle('{bundle-name}')` в основном priv методе функциональности, которую выносим в бандл.

Проверить, что в клиентском `js` нет прямого взаимодействия с блоками бандла (`BEM.blocks`, подписки и т.д.). Организовывать взаимодействие с бандлами нужно через BEM.channel('{bundle-name}').

### Чеклист при создании бандла

* [ ] создан `bemdecl` для бандла
* [ ] в `deps` проекта нет подключенных блоков, которые нужны только в бандле
* [ ] в клиентском `js` проекта нет прямого взаимодействия с блоками бандла
* [ ] в основной priv-метод функциональности, которая выносится в бандл, добавлен вызов `data.pushBundle('{bundle-name}')`

### Как использовать async bundle

Если нужна асинхронная загрузка бандла, которая не стопит загрузку основного js:

#### Загрузка сразу после инициализации i-bem

Вызвать `data.pushBundleAsync('{bundle-name}', { onInit: true })` в основном priv методе функциональности, которую выносим в бандл.
Добавить {bundle-name} в .enb/bundlesConfig.js, иначе он не учавствует в сборке

#### Загрузка в произвольный момент времени на клиенте

Вызвать `data.pushBundleAsync('{bundle-name}')` (без второго аргумента) в основном priv методе функциональности, которую выносим в бандл.
Вызвать `BEM.blocks['i-bundle-async'].load('{bundle-name}')` в клиентском js.

`load` возвращает промис, можно подписаться на успешуню/провальную загрузку.

Блоки, которые приезжают в асинхронных бандлах, по-умолчанию являются ленивыми.

Для принудительной инициализации таких блоков необходимо подписаться на канал загрузки бандла.
`this.liveInitOnChannelEvent('bundle-loaded', '{bundle-name}')`
**Обратите внимание**, событие в канале будет вызвано после каждого запроса за бандллом (даже если он уже загружен).

Это позволит блоку самостоятельно подписаться на свою же успешную загрузку, что уменьшает количество необходимого кода в основном файле.
