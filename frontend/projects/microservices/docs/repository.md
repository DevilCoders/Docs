# Структура репозитория

В этом документе зафиксирована текущая файловая структура репозитория. Каждый контрибьютор должен чтить и соблюдать описанную структуру.

## Файловая структура

Ниже наглядно представлена и детально описана файловая структура этого репозитория.

```
ms/
├── .config/
│   └── env
├── docs
│   └── README.md
├── modules/
│   ├── github/
│   │   ├── index.js
│   │   └── utils.js
│   └── startrek/
│       └── index.js
├── services/
│   └── service/
├── Makefile
└── package.json
```

### Директория `.config`

#### `.config/env`

:bulb: Здесь хранятся **открытые** данные.

Общие для всех сервисов переменные окружения, которые сервис может импортировать во время запуска. Предполагается, что каждый сервис наследует все переменные окружения из файла `env` и доопределяет или переопределяет их в Qloud на уровне компонента или окружения.

Пример содержимого файла:

```shell
DEBUG=serp:*,sandbox-ci:*
```

> **Внимание**
>
> Модуль, используемый для доставки переменных из файла не поддерживает экспорты, поэтому в файле `env` не должно быть `export NAME=123`.

Пример получения переменных из `env` в вашем сервисе:

```js
require('dotenv').config({ path: '.config/env' });
```

#### `.config/env-secret`

:bulb: Здесь хранятся **секретные** данные.

:bulb: Файл предназначен только для локальной разработки, в продакшене НЕ используется в пользу [yav](https://yav.yandex-team.ru/secret/sec-01e0r09yh5whgmtegdhjt65n4v).

Для удобства созданы две вспомогательные цели:

  * `make encrypt` – шифрует файл `env-secret` с помощью предоставленного ключа.
  * `make decrypt` – дешифрует файл `env-secret.cast5` с помощью предоставленного ключа.

Ключ хранится [в Секретнице](https://yav.yandex-team.ru/secret/sec-01d80wnwn8mr5evsws5tcvt8gk). Удобно получить его можно так:

```
export SETTINGS_PASSWORD=$(ya vault get version sec-01d80wnwn8mr5evsws5tcvt8gk -o password)
```

### Директория `docs`

Директория, содержащая всю документацию, которая может понадобиться текущим и будущим контрибьюторам для разработки и поддержки любого сервиса в этом репозитории.

### Директория `modules`

Директория, содержащая код, который может использоваться в двух и более сервисах. Такой код должен иметь свою личную директорию и быть максимально структурированным.

Исключением является модуль `github`, в котором файл `utils.js` включает в себя все утилиты для работы с GitHub, исключая функции имеющие сайдэффект (для их тестирования нужен `proxyquire`) или включающую сложную логику, которая присуща только вашему сервису.

Если вы находите в соседних сервисах код, который можете переиспользовать – смело выносите его в эту директорию. Мы против дублирования кода.

### Директория `services`

Директория, содержащая все сервисы, находящиеся в этом репозитории. Структура этой директории имеет следующий вид:

```
service/
├── docs/
│   └── README.md
├── routes/
│   ├── github/
│   │   └── hook-name.js
│   └── sandbox/
│       └── hook-name.js
├── modules/
│   └── github/
│       └── utils.js
├── README.md
└── service.js
```

Общая концепция повторяет структуру репозитория. Краткое описание:

  * `docs` – Документация сервиса во всех подробностях.
  * `routes` – Директория, содержащая регистрируемые хуки и API текущего сервиса. Максимально группируйте по директориям.
  * `modules` – Директория, содержащая функции, дополняющие возможности общих модулей, находящихся в директории modules/ в корне этого репозитория. Если ваша функция используется только в вашем сервиса, то здесь ей самое место. В эту директорию не входит вспомогательный код, который требуется вашим хукам.
  * `README.md` – Общее описание сервиса и его API.
  * `service.js` – Файл, с которого должен начинаться ваш сервис. В этом файле регистрируются все хуки и API, которые поддерживаются сервисы. Для регистрации хуков можно использовать хелпер [`modules/webhook/index.js`](https://github.yandex-team.ru/mrmlnc/microservices/blob/preview/modules/webhook/index.js).

### Файл `Makefile`

Make-файл, содержащий цели для работы с сервисами. Среди целей вы сможете найти:

  * `docker-build` – строит новый Docker-образ на основе `.dockerfile`.
  * `docker-publish` – публикует образ в регистре.
  * `docker-run` – запускает собранный Docker-образа.

### Файл `package.json`

В этом файле описываются все шаги сборки и запуска каждого сервиса, а также их зависимости.
