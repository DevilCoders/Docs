# Сервис автоподсчета приоритета тикетов

## Что это и зачем?

Опыт внедрения в очереди [SERP](https://clubs.at.yandex-team.ru/serp/8366/).

В очередях трекера можно добавить через триггеры механизм автоматического выставления приоритета на основе веса задачи, который подсчитывается с учетом нескольких факторов.

Что даст автоматическое выставление приоритетов:

* консистентные критерии по приоритезации тикетов для всех проектов;
* корректность/прозрачность основных показателей качества (ZBP/SLA - особенно для сценариев повышения/понижения приоритета и веса тикета) на наших графиках и соответсвенно выполнение целей в командах (минимизируем "человеческий" фактор).

## Быстрый старт

1. [Создайте триггер](https://doc.yandex-team.ru/tracker/external/user/create-trigger.html) для своей очереди.
2. [Настройте триггер](https://doc.yandex-team.ru/tracker/external/user/set-condition.html) так, чтобы он срабатывал при изменение полей используемых при расчете приоритета.
3. В качестве действия выберите [HTTP-запрос](https://doc.yandex-team.ru/tracker/external/user/set-action.html#set-action__dlentry_nbq_nms_kgb)
    * Метод: `POST`.
    * URL: `https://assessors.si.yandex-team.ru/v1/tracker/calculate-priority`.
    * Auth type: NoAuth.
    * Content type: application/json.
    * Request body: (минимально необходимое тело запроса)

    ```json
    {
        "key": "{{issue.key}}",
        "fields": {
            "featureFactor": "{{issue.featureFactor}}",
            "browserFactor": "{{issue.browserFactor}}",
            "stageFactor": "{{issue.stageFactor}}",
            "experiment": "{{issue.experiment}}",
            "weight": "{{issue.weight}}",
            "customFactors": [
                {
                    "type": "map",
                    "field": "userFactor",
                    "value": "{{issue.userFactor}}"
                }
            ]
        },
        "config": { }
    }
    ```

4. Включить триггер.

> Сервис отвечает только за расчет веса и приоритета тикета. Запрет выставления приоритета руками. Автоматическая установка приоритета `critical` только что созданным тикетам, делается с помощью самого трекера овнерами очереди.


## Описание работы

1. Сервис принимает POST-запросы по адресу `https://assessors.si.yandex-team.ru/v1/tracker/calculate-priority`.

    В качестве тела запроса выступает JSON в формате:

    ```json
    {
        "key": "{{issue.key}}",
        "fields": {
            "featureFactor": "{{issue.featureFactor}}",
            "browserFactor": "{{issue.browserFactor}}",
            "stageFactor": "{{issue.stageFactor}}",
            "experiment": "{{issue.experiment}}",
            "weight": "{{issue.weight}}",
            "customFactors": [
                {
                    "type": "map",
                    "field": "userFactor",
                    "value": "{{issue.userFactor}}"
                }
            ]
        },
        "config": { }
    }
    ```

    * **key** — поле содержит ключ тикета, для которого надо посчитать приоритет.
    * **field.featureFactor** — поле содержит ссылку на stat—отчет, error-booster, либо число посетителей (если в конфигурации установлено `manual: true`).
    * **field.browserFactor** — поле содержит список названий одного из [разрешенных браузеров](#browser_factor).
    * **field.stageFactor** — поле содержит любое значение, либо `ABT`, в таком случае надо заполнить еще поле `experiment`,
    * **field.experiment** — поле содержит тикет эксперимента (например `EXPERIMENTS-48354`).
    * **field.weight** — текущее значение веса тикета.
    * **customFactors** — набор пользовательских факторов.

2. Сервис получил POST-запрос и начинается подсчет каждого фактора.

3. Подсчет **Feature Factor**:

    * Если ничего не указано используется коэффициент равный "1".
    * Если указано число посетителей и при этом включена [опция](#feature_factor) `manual: true`, то коэффициент вычисляется на основе интервалов соотношения посетители/коэффициент [заданных в конфигурации](#feature_factor).
    * Если указана ссылка на `stat` отчет и данный отчет описан в [конфигурации](#feature_factor), то он скачивается, извлекается значение из колонки, которое указано в конфигурации, и самой первой строки. Дальше вычисляется приоритет на основе интервала соотношения посетители/коэффициент.
    * Если указана ссылка на `error-booster`, то извлекается число ошибок, потому что один пользователь может получать одну и ту же ошибку несколько раз, а дальше вычисляется коэффициент с помощью интервалов.

4. Подсчет **Browser Factor**

    * Если ничего не указано используется коэффициент равный "1".
    * Если указаны названия [разрешенных браузеров](#browser_factor) через запятую, то для каждого браузера из Я.Метрики по указанным счетчикам извлекается их количество пользователей за сутки. Далее количества пользователей конвертируются в процент от суммы количества пользователей всех разрешенных браузеров. И на последнем этапе отбираются значения в процентах указанных браузеров, складываются и переводятся в коэффициент, путем деления процента на 100.
    * Если в **Feature Factor** была указана ссылка на **error-booster**, то данный фактор возвращает "1", так как в **error-booster** количество ошибок подсчитано с учетом платформы/браузера.

5. Подсчет **Stage Factor**

    * Если ничего не указано используется коэффициент равный "1".
    * Если указано значение "ABT", то требуется обязательно заполнить поле "experiment" тикетом на эксперимент. Далее сервис извлекает процент раскатки эксперимента и конвертирует его в коэффициент путем деления на 100.
    * Если указано значение "ABT", а поле "experiment" не заполнено, то коэффициент будет равен "1".
    * Если указано любое другое значение, то коэффициент будет равен "1".
    * Если в **Feature Factor** была указана ссылка на **error-booster**, то данный фактор возвращает "1", ошибки в **error-booster** собраны с продакшена.

6. Подсчет **Custom Factors**

   * Подсчитываются только те пользовательские факторы, чей `type` описан в [config.custom_factors](#custom_factors).
   * Если указан не описанный тип фактора, то будет ошибка.
   * Указывается массив пользовательских факторов.

   6.1 Подсчет **Map Custom Factor**

   * Если указан фактор с `type: 'map'` будет запущен его подсчет.
   * Если свойство `value` окажется пустым, то используется коэффициент равный "1".
   * Если указаны одно или несколько значений в `value`, то они конвертируются в коэффициенты определенные в [конфигурации](#custom_factor-map) и потом складываются между собой.

7. Полученные факторы используются на подсчета веса задачи по формуле:

    ```
    FeatureFactor x BrowserFactor x StageFactor x customFactor1 x customFactorN x 100 = weight
    ```

8. Полученный вес используется для вычисления приоритета с помощью интервалов соотношения вес/приоритета описанного в [конфигурации](#prioritites).

9. Вес и приоритет устанавливаются в тикете.

## Базовая конфигурация

Базовая конфигурация сервиса определена в [genisys](https://genisys.yandex-team.ru/rules/search-interfaces-microservices.assessors/default) и она используется по-умолчанию для всех пользователей сервиса.
Если у вас по каким-то причинам нет доступа к конфигурации обращайтесь, то его актуальная копия доступна [ниже](#Пользовательская-конфигурация) в свойстве `config`.

## Пользовательская конфигурация

Пользовательская конфигурация определяется в body POST-запроса обработчика триггера очереди в трекере и позволяет переопределить базовую конфигурацию на первом уровне вложенности.

То есть если вы хотите задать свои параметры для **feature factor**, то необходимо полностью заполнить все параметры, дополнить базовые параметры этого фактора не получится.

Пример пользовательской конфигурации в теле запроса:

```json
{
    "key": "SOMEKEY-1",
    "fields": { },
    "config": {
        "use_extended_feedback": true,
        "priorities": [
            {
                "min_weight": 60,
                "name": "critical"
            },
            {
                "min_weight": 20,
                "name": "normal"
            },
            {
                "min_weight": 0,
                "name": "minor"
            }
        ],
        "browser_factor": {
            "metrika": {
                "desktop_counter": "731962",
                "touch_counter": "22555771"
            },
            "allowed": {
            "desktop": [
                "Yandex Browser",
                "Google Chrome",
                "Opera",
                "Firefox",
                "Edge",
                "MSIE",
                "Safari"
            ],
            "touch": [
                "Yandex: mobile app",
                "Yandex Browser",
                "Chrome Mobile",
                "Mobile Safari",
                "Samsung Internet",
                "MIUI",
                "UCWEB",
                "Android Browser",
                "Opera Mobile",
                "Meizu Browser",
                "Яндекс.Браузер lite",
                "Opera Mini",
                "Google: mobile app"
            ]
            },
            "platform": {
            "Common": 100,
            "Desktop": 100,
            "Touch": 100,
            "Pad": 50
            }
        },
        "feature_factor": {
            "visitors_factors": [
            {
                "min_visitors": 1000000,
                "factor": 1
            },
            {
                "min_visitors": 500000,
                "factor": 0.9
            },
            {
                "min_visitors": 100000,
                "factor": 0.8
            },
            {
                "min_visitors": 50000,
                "factor": 0.7
            },
            {
                "min_visitors": 10000,
                "factor": 0.6
            },
            {
                "min_visitors": 0,
                "factor": 0.5
            }
            ]
        },
        "custom_factors": [
            {
                "type": "map",
                "field": "userFactor",
                "value": {
                    "пользователь не видит баг": 0.1,
                    "косметический дефект": 0.3,
                    "баг создает неудобства": 0.6,
                    "влияет на метрики продукта": 0.4
                }
            }
        ]
    }
}
```

### use_extended_feedback

В значение `true` включается расширенный вариант комментария с подробностями о том, как был вычислен приоритет.

### priorities

Параметр описывает соотношение интервалов весов и значений приоритета.
Необходимо указать в порядке убывания нижние пороговые значения весов для каждого приоритета:

```js
"priorities": [
    {
        "min_weight": 60,
        "name": "critical"
    },
    {
        "min_weight": 20,
        "name": "normal"
    },
    {
        "min_weight": 0,
        "name": "minor"
    }
]
```

Данная запись соответствует следующим неравенствам:

```
60 <= weight < infinity = critical
20 <= weight < 50 = normal
0 <= weight < 20 = minor
```

### feature_factor

Параметр описывает логику подсчета коэффициента **feature factor**.

Пример со всеми возможными параметрами:

```js
"feature_factor": {
    "manual": true,
    "sources": {
        "stat.yandex-team.ru/Yandex/Adhoc/Baobab/DashCTR_nile_v3": {
            "fields": [
                "shows"
            ]
        }
    },
    "visitors_factors": [
        {
            "min_visitors": 1000000,
            "factor": 1
        },
        {
            "min_visitors": 500000,
            "factor": 0.9
        },
        {
            "min_visitors": 100000,
            "factor": 0.8
        },
        {
            "min_visitors": 50000,
            "factor": 0.7
        },
        {
            "min_visitors": 10000,
            "factor": 0.6
        },
        {
            "min_visitors": 0,
            "factor": 0.5
        }
    ]
}
```

* **manual** — если `true`, то появляется возможность указывать количество посетителей руками прямо в поле **Feature Factor**. Используется только в тех случаях, когда у команды не все фичи покрыты счетчиками.
* **sources** — описание работы с источниками
    * В качестве ключа указывается `host` (`stat.yandex-team.ru`) + путь до отчета (`/Yandex/Adhoc/Baobab/DashCTR_nile_v3`). Поддерживается настройка только отчетов из `stat.yandex-team.ru`.
    * В качестве значения выступают параметры источника:
        * **fields** — список полей из которых необходимо извлечь значение, первое найденное поле в отчете будет использовано в качестве значения.
* **visitors_factors** — соотношение интервалов количества посетителей и значений коэффициента. Принцип работы такой же, как у [priorities](./priorities).

### browser_factor

Параметр описывает алгоритм подсчета коэффициента **Browser Factor**.

Пример со всеми возможными параметрами:

```js
"browser_factor": {
    "metrika": {
        "desktop_counter": "731962",
        "touch_counter": "22555771"
    },
    "allowed": {
        "desktop": [
            "Yandex Browser",
            "Google Chrome",
            "Opera",
            "Firefox",
            "Edge",
            "MSIE",
            "Safari"
        ],
        "touch": [
            "Yandex: mobile app",
            "Yandex Browser",
            "Chrome Mobile",
            "Mobile Safari",
            "Samsung Internet",
            "MIUI",
            "UCWEB",
            "Android Browser",
            "Opera Mobile",
            "Meizu Browser",
            "Яндекс.Браузер lite",
            "Opera Mini",
            "Google: mobile app"
        ]
    },
    "platform": {
        "Common": 100,
        "Desktop": 100,
        "Touch": 100,
        "Pad": 50
    }
}
```

У данного фактора нет гибкой и тонкой настройки, поэтому пока стоит с осторожностью здесь что-то менять.
У робота `yndx-robot-serp-bot` должен быть доступ на чтение к счетчикам.

* **metrika** — список счетчиков Я.Метрики и их названий
    * **desktop_counter** — идентификатор счетчика в Я.метрике для платформы `desktop`
    * **touch_counter** — идентификатор счетчика в Я.метрике для платформы `touch`
* **allowed** — список разрешенных браузеров, соответствующих браузерам в Я.Метрике, разделенный по платформам (названия браузеров в платформах пересекаться не должны):
    * **desktop** — список разрешенных браузеров для платформы `desktop`
    * **touch** — список разрешенных браузеров для платформы `touch`
* **platform** — абсолютные значения для платформ (`Common`, `Desktop`, `Touch`, `Pad`)

### custom_factors

Параметр отвечает за настройку пользовательских факторов, которые определены в [описание работы п 6](#Описание-работы).

Параметр принимает массив пользовательских факторов.

> Можно определить несколько факторов одного типа, но для разных `field`.

#### custom_factor map

```json
{
    "custom_factors": [
        {
            "type": "map",
            "field": "userFactor",
            "value": {
                "пользователь не видит баг": 0.1,
                "косметический дефект": 0.3,
                "баг создает неудобства": 0.6,
                "влияет на метрики продукта": 0.4
            }
        }
    ]
}
```

* **type** — тип фактора, в данном случае `map`.
* **field** — название поля в трекере (которое доступно через API).
* **value** — отношение значений пользовательских полей их коэффициентов заданных от 0 до 1.

