# Команды для работы с Merge Queue

> Документация приводится на примере проекта [serp/web4](https://github.yandex-team.ru/serp/web4).

Взаимодействие с сервисом реализуются через комментарии в пулл-реквесте. Ключевые строки, которые описаны ниже, должны находиться в самом начале комментария, без пробелов и переводов строк.

## `/merge`

![merge](../assets/merge.png)

Влить пулл-реквест.

Что произойдёт?

1. Сервис проверит, что все обязательные проверки на данный момент успешны.
<br>1.1 Список обязательных проверок можно посмотреть в файле [.merge-queue.json](https://github.yandex-team.ru/serp/web4/blob/dev/.merge-queue.json) в корне основной ветки проекта.
<br>1.2 Задача пулл-реквеста находится в нужном статусе, статусы для очередей задаются в конфиге MQ, в поле `startrekQueue`.
2. Если все обязательные проверки успешны, то ваш пулл-реквест будет поставлен в очередь на вливание.
3. Когда до вашего пулл-реквеста дойдёт очередь, будет выполнен ребейз по основной ветке и повторный запуск обязательных проверок, чтобы убедиться в том, что после ребейза ничего не сломалось.
4. Если обязательные проверки пройдут успешно, то ваш пулл-реквест будет автоматически влит в основную ветку.

Команду `/merge` следует воспринимать как реальное нажатие на кнопку **Merge** в пулл-реквесте, то есть ничего уже не изменить. Поэтому, прежде чем напечатать эту команду, убедитесь ещё раз, что все изменения сделанные в вашем пулл-реквесте актуальны. При допушивании каких-либо изменений после команды `/merge` ваш пулл-реквест не вольётся и упадёт с ошибкой, а также инвалидирует прогревочные кэши для остальных пулл-реквестов стоящих за вами в очереди на вливание. Кроме этого, вам опять придётся ждать пока выполнятся все обязательные проверки. Поэтому вместо того, чтобы что-то допушить лучше создать новый PR.

Почему мы прекращаем вливание пулл-реквеста при допушивании после команды `/merge`:

1. В MQ должны тестироваться только те пулл-реквесты в которых уже прошли все обязательные проверки. В случае допушивания мы имеем не протестированное состояние исходников. В итоге такой пулл-реквест мало того, что будет занимать очередь, так ещё и сфейлится на одной из проверок.
2. Допушивание инвалидирует кэши и замедляет всю очередь.
3. Кроме автоматического тестирования может сломаться также и процесс ручного, завязанного на конкретные изменения.

Релевантный тикет: [FEI-8303](https://st.yandex-team.ru/FEI-8303): _Запретить/уведомлять про допушивание в ветку_.

:warning: Ветка из вашего форка автоматически не удаляется ([FEI-2536](https://st.yandex-team.ru/FEI-2536)).

## `/stop_merge`

На случай когда все таки необходимо удалить пулл-реквест из очереди, существует команда `/stop_merge`. Если на момент выполнения команды задача существует только на уровне сервиса, но еще не создана в sandbox, задача будет успешно остановлена:
![merge](../assets/stop_merge_success.png)
Если на момент выполнения команды задача уже выполняется в sandbox, сервис не сможет ее остановить и предложит пользователю остановить задачу самостоятельно или с помощью дежурных:
![merge](../assets/stop_merge_failure.png)

**Важно помнить** - не стоит злоупотреблять остановкой задач, т.к. для после каждой остановленной задачи запускается перепрогрев кэшей для всех задач, которые были ниже в очереди, что существенно замедляет конвейер.