# pnpm

В infratest управление зависимостями осуществляется с помощью pnpm.

## Конфигурация

Основная конфигурация pnpm осуществляется с помощью корневых файлов [.npmrc](../.npmrc) и [pnpm-workspaces.yaml](../pnpm-workspace.yaml).

Важно учитывать следующие моменты:
- `.npmrc` в пакетах запрещены, pnpm всегда использует корневой `.npmrc` файл.
- `pnpm-workspaces.yaml` должен быть синхронизирован с `lerna.json`, пока она используется.

Особенности:
- `public-hoist-pattern` намеренно выставлен в пустое значение. По умолчанию pnpm разрешает хоистинг пакетов с тайпингами (`@types`).
- `save-workspace-protocol = false` нужен, чтобы при добавлении зависимостей через `pnpm add` не использовался workspace protocol. Это важно, пока в монорепе продолжает использоваться lerna.
- `store-dir` и `virtual-store-dir` вынесены за пределы рабочей копии. Это необходимо из-за бага arc на macOS – [FEI-21104](https://st.yandex-team.ru/FEI-21104).

## pnpmfile.js

[`pnpmfile.js`](../pnpmfile.js) используется для инъекции препроцессинга `package.json` файлов для pnpm.

TL;DR: препроцессинг необходим для использования workspace protocol без изменения `package.json` файлов, которые должны оставаться совместимыми с lerna и npm, пока они используются.

По умолчанию, pnpm для каждой зависимости в локфайле пишет не только версию, которую разрезолвил, но и "спек" версии – строку, которой её объявили в `package.json` зависимого пакета.

**Пример**

Локальный пакет `@yandex-int/foo` зависит от пакета `@yandex-int/bar`. Тогда часть локфайла может выглядеть следующим образом:

```
  packages/foo:
    dependencies:
      '@yandex-int/bar': 'link:../bar'
      yargs: 14.2.0
    specifiers:
      '@yandex-int/bar': '1.2.3'
      yargs: 14.2.0
```

Если меняется хоть одна из версий (в `dependencies` разрезолвилась другая версия или в `specifiers` объявление зависимости поменялось), pnpm потребует перегенерировать локфайл. Что и происходит при бампе версий. При использовании workspace protocol всё становится проще – зависимость объявляется как `workspace:*`, и её обновление не потребует перегенерации локфайла.

В infratest workspace protocol использоваться не может, так как трбуется (пока) одновременная работоспособность и pnpm и lerna. Поэтому используется следующий workaround для pnpm: если зависимость является внутренней и версия соответствует локальной, то её объявление переписывается на `workspace:*`.

