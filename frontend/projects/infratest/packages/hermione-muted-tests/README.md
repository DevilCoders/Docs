# hermione-muted-tests

Плагин [hermione](https://github.com/gemini-testing/hermione), отвечающий за `mute` тестов во время запуска.

## Установка

```bash
npm install @yandex-int/hermione-muted-tests --save --registry https://npm.yandex-team.ru
```

## Использование

### Формат файла со списком отключаемых тестов

```
[
  { fullName, browserId, reason, muted },
  ...
  { fullName, browserId, reason, muted },
]
```

, где:

* `fullName` **[String]** – полное название теста (выступает в роли идентификатора теста);
* `browserId` **[String]** – идентификатор браузера, в котором тест будет отключен;
* `reason` **[String]** – текст, который будет указан в качестве причины отключения;
* `muted` **[Boolean]** – флаг, определяющий является ли тест `muted`, если значение не указано, то тест считается `muted` по умолчанию.

### Логика работы плагина

При инициализации плагин считывает список отключенных тестов из внешнего файла и сразу после чтения тестов выполняет отключение тех тестов, которые по условиям являются отключенными (совпадение `fullName` и `browserId`, `muted` явно имеет значение `false`). Если тест помечен как `muted`, то он будет запущен, но при падении не свалит весь прогон тестов, а будет помечен как отключённый.

В случае, если задана переменная окружения `ISSUE_KEYS`, плагин **запустит** тесты, отключенные или помеченные как `muted` по указанным задачам, как обычные тесты.

Также плагин не мьютит тесты, для которых были изменены скриншоты _(*.png)_, дампы _(*.json.gz)_ или файлы самих тестов _(*.js или *.ts)_. Как определять файлы, которые относятся к тесту – по каким именно расширениям, или определенным идентификаторам в пути к файлу, – вы можете задать (переопределить) в конфиге плагина в разделе `testRelatedFiles`.

### Параметры

* `enabled` **[Boolean]** (необязательный, по умолчанию `true`) – отвечает за указание необходимости запуска плагина;
* `tool` **[String]** (необязательный, по умолчанию `hermione`) - отвечает за указание инструмента/вида тестов, для которых запускается плагин;
* `project` **[String]** (обязательный) – название проекта, для которого включается плагин;
* `branch` **[String]** (обязательный) – название основной ветки репозитория, в котором находится проект; если проект находится и в гитхабе, и в аркадии одновременно, то нужно указывать основную ветку в гитхабе;
* `stabilityIndex` **[Object]** (необязательный) – настройки для индекса стабильности тестов:
  * `excludeFromErrors` **[Array]** (необязательный) - массив паттернов для игнорирования частей ошибок, которые попадают в индекс стабильности. В случае указания в регулярном выражении [скобочных групп](https://learn.javascript.ru/regexp-groups), будут проигнорированы все найденные группы. Например, при указании следующего конфига:
  ```js
    ...
    excludeFromErrors: [
        /some-(error)/
    ],
    ...
  ```
    в ошибке вида `some-error very bad error` будут проигнорированы подстроки `some-error` и `error`.
  * `output` **[Object]** (необязательный) – настройки для создания индекса стабильности тестов:
    * `enabled` **[Boolean]** (необязательный, по умолчанию `true`) – отвечает за указание необходимости создания индекса стабильности;
    * `path` **[String]** (необязательный, по умолчанию `stability-index-output.sqlite`) – название файла для сохранения индекса стабильности;
    * `runId` **[Number]** (необязательный, по умолчанию `Date.now()`) – уникальный id запуска тестов (положительное целое число);
    * `context` **[String]** (необязательный, по умолчанию `dev`) – контекст запуска тестов.
  * `input` **[Object]** (необязательный) – настройки входящего индекса стабильности тестов:
    * `path` **[String]** (необязательный, по умолчанию `null`) – название файла для сохранения индекса стабильности.
* `autoMute` **[Object]** (необязательный) – настройки для автоматического mute плавающих тестов:
  * `enabled` **[Boolean]** (необязательный, по умолчанию `true`) – отвечает за указание необходимости включения/выключения автоматического mute;
  * `errorTimeThreshold` **[Number]** (необязательный, по умолчанию `0`) – отвечает за временное ограничение (в днях) списка ошибок во входящем индексе стабильности для определения плавающих тестов. `0` – учёт всех ошибок из входящего индекса стабильности без ограничения по времени, `1` – учёт всех ошибок за последний день и т. д;
  * `maxPerRun` **[Number]** (необязательный, по умолчанию `0`) – отвечает за ограничение количества автоматических mute-ов за один запуск. `0` – нет ограничения, `1` – не более одного автоматического mute за один запуск и т. д.
* `sortTestsByStability` **[Object]** (необязательный) – настройки для первоочередного запуска нестабильных тестов:
  * `enabled` **[Boolean]** (необязательный, по умолчанию `true`) – отвечает за указание необходимости включения/выключения первоочередного запуска нестабильных тестов;
* `isVCSAvailable` **[Boolean]** (необязательный, по умолчанию `true`) – указывает, доступна ли система контроля версий (`VCS` – `Version Control System`) в контексте выполнения плагина.
* `changedFilesPath` **[String]** (необязательный) - путь к файлу со списком измененных файлов. Испольуется для того, чтобы не делать автоматический mute для тестов, скриншоты, дампы или файлы которых были изменены.
* `testRelatedFiles` **[Object]** (необязательный) – настройки для фильтрации списка измененных файлов, позволяющие определить, есть ли среди измененных файлов файлы, относящиеся к конкретному тесту:
  * `extensions` **[Array]** (необязательный, по умолчанию `['png', 'json.gz', 'js', 'ts']`) – расширения файлов, которые могут относиться к тестам: `png` – скриншоты, `json.gz` – дампы, `js` / `ts` – файлы, в которых находятся сами тесты;
  * `ids` **[Array]** (необязательный, по умолчанию `[getTestTpid, getTestTpidWithFile, getTestFileName]`) – функции, которые принимают в качестве входного параметра конкретный тест, а возвращают идентификаторы (строки), наличие которых в путях файлов является признаком, что соответствующий файл относится к указанному тесту.

Все параметры могут быть переопределены через переменные среды окружения с префиксом `hermione_muted_tests_`, например, `hermione_muted_tests_auto_mute_enabled=true` или через опции `CLI` с префиксом `--muted-tests-`, например, `--muted-tests-auto-mute-enabled=true` (у параметров переопределенных через `CLI` приоритет выше, чем у параметров переопределенных через переменные среды окружения).

### Переменные окружения

* `ISSUE_KEYS` **[String]** (необязательный) – список идентификаторов задач со st.yandex-team.ru, разделённый запятыми.

### API

Плагин добавляет своё API в инстанс `hermione`, которое доступно через свойство `mutedTests` в других плагинах:

- `.isUnskipped(test)` – функция, которая проверяет включен ли заскипанный тест через переменную окружения `ISSUE_KEYS`
  ```js
  // реализация какого-то плагина
  module.exports = (hermione) => {
    hermione.on(hermione.events.AFTER_TESTS_READ, (collection) => {
        collection.eachTest((test) => {
            if (hermione.mutedTests.isUnskipped(test)) {
                // ...
            } else {
                // ...
            }
        });
    });
  };
  ```

### Подключение

Подключить плагин в конфигурационном файле:

```js
module.exports = {
    plugins: {
        '@yandex-int/hermione-muted-tests': {
            enabled: true,
            project: 'web4',
            tool: 'hermione',
            stabilityIndex: {
                output: {
                    enabled: true,
                    path: 'output-stability-index.sqlite',
                    runId: Date.now(),
                    context: 'dev'
                },
                input: {
                    path: 'input-stability-index.sqlite'
                }
            },
            autoMute: {
                enabled: true,
                errorTimeThreshold: 0,
                maxPerRun: 0
            }
        }
    }
};
```
