# apphost-service

Пакет, позволяющий упростить заведение нового сервиса под [AppHost](https://wiki.yandex-team.ru/apphost/) и [ReportRenderer](https://wiki.yandex-team.ru/search-interfaces/infra/report-renderer/).

## Мотивация

Заведение нового сервиса требует одних и тех же однотипных и несложных действий, которые можно выполнять автоматически. Именно это и делает данный инструмент.

## Что умеет утилита

Для заведения testing'а необходимо иметь: 

* upstream в балансере, который будет отвечать на запросы на хэндлер проекта и отправлять их на обработку
на нужный бэкэнд с Apphost HttpAdapter
* граф в админке Apphost, который будет использоваться HttpAdapter'ом для создания ответа на запрос
* тип ресурса в Sandbox'е для упаковки в него шаблонов

При локальном запуске на [kotik](https://github.yandex-team.ru/search-interfaces/infratest/tree/master/packages/kotik)
и поднятии беты для PR необходимо настроить загрузку графа из текущей версии кода сервиса, что позволяет проверять
новый граф в PR и даже локально.

Утилита умеет:

* заводить upstream в hamster.yandex.ru балансере
* создавать болванку графа для нового проекта
* загружать граф из файла, переданного команде
* создавать тип ресурса в Sandbox
* запрашивать необходимые для своей работы данные у пользователя

## Как использовать

Для работы утилиты необходим конфигурационный файл. Для его создания нужно запустить утилиту в папке с новым
проектом:

`npx apphost-service`

Для заполнения конфигурационного файла она использует ответы пользователя на заданные ею вопросы.

После того, как команда соберет все ответы, она выполнит установку [Archon](https://github.yandex-team.ru/search-interfaces/infratest/tree/master/packages/archon)
и спросит, нужно ли выполнить подготовку тестинга. 

Подготовка тестинга (команда `prepare-testing`) включает в себя все необходимые этапы, а по завершении она выдаст
рекомендации по тому, что нужно делать после того, как вся подготовка будет завершена.
Подробное описание этапов и дальнейших действий содержится в help'е команды (`npx archon prepare-testing --help`).

## Более формальная документация

### CLI

Включает одну команду `apphost-service`, которая позволяет создать основу для проекта. Необходимый минимум файлов
и конфигов, которые требуются для начала работы над проектом:

* конфигурационный файл для самого пакета
* конфигурационный файл для [Archon](https://github.yandex-team.ru/search-interfaces/infratest/tree/master/packages/archon)
* конфигурационный файл `.yproject` для настроек проекта
* Archon-команды

### Команды для Archon

#### generate-graph

Генерация конфигурации графа и сохранение его на файловой системе в директории `graphs`(по умолчанию в `testing.json`).

#### prepare-testing

Составная команда для настройки тестинга, которая включает в себя следующие этапы:

* генерация файла с графом на файловой системе (`generate-graph`),
* загрузка этого графа в админку (`upload-graph`),
* создание upstream в балансере (`update-upstream`),
* создание типа ресурса для упаковки в него шаблонов (`update-package`).

#### upload-graph

Загрузка конфигурации графа с файловой системы в https://apphost.n.yandex-team.ru (по умолчанию из `graphs/testing.json`).

#### update-package

Создание/обновление типа ресурса для Sandbox посредством авто-коммита в Arcadia.

#### update-upstream

Создание или обновление апстрим записи в балансере.

⚠️ Требует прав на создание апстримов в балансере. Сейчас права выданы на группу 
[Разработка](https://abc.yandex-team.ru/services/frontend/?scope=development) ABC-сервиса Монорепозиторий фронтенда.
