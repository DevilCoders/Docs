# Валидация
Валидация обеспечивает правильность заполнения YML согласно [схеме](./yaml-files.md) и соответствие между описанными в YML тестовыми сценариями и автоматизированными сценариями.

Валидация выполняется [командой validate](./cli.md#palmsync-validate), а также может быть выполнена программно при помощи [метода API validate](./api.md#validate).

Валидация делится на две части:
  * [Простая валидация сценариев](#Простая-валидация-сценариев)
  * [Валидация по авто-тестам](#Валидация-по-авто-тестам)

## Простая валидация сценариев

Данный тип валидации проверяет правильность синтаксиса и грамматики написанных yaml файлов.
Валидацию можно отключить с помощью опции [scenarios](./configuration.md#validtionOpts).

### Проверка "грамматики"

Валидатор проверяет значение поля в соответствие с [настройками в схеме](./configuration.md#schemeExtension.grammar).

Пример настройки "грамматики" поля:

```js
{
    name: 'tags',
    grammar: [
        {reference: 'no_assessors', mask: /no[_-]?a[cs]{1,2}ess?ors?/}
    ]
}
```

Пример неправильного файла, тег `no_acessors` попадает под маску описанную в схеме, но не совпадает с референсом.

```yaml
feature: Поисковая стрелка

specs:
  foo:
    - do: some-do

tags:
  - no_acessors
```

Пример ошибки:

```bash
a.testpalm.yml:
  - [specs] Поисковая стрелка foo:
    - Неверно определено значение типа 'no_acessors' для ключа: 'tags'. Ожидается 'no_assessors'
```

### Проверка на соответствие схеме

#### Проверка наличия неизвестных полей

Выполняется проверка на наличие незадокументированных полей, т.е. полей которые не описаны в схеме.

Пример неправильного файла (есть недокументированное поле `invalid`):

```yaml
feature: Поисковая стрелка

invalid: blabla

specs:
    foo: bar
```

Пример соответствующего сообщения об ошибке:

```bash
a.testpalm.yml:
  - неизвестная опция 'invalid'
```

#### Проверка наличия всех требуемых полей

Т.е. всех полей, которые помечены в [схеме](./yaml-files.md) как обязательные, например поле `feature`.

Пример неправильного файла (отсутствует поле `feature`):

```yaml
specs:
    foo: bar
```

Пример соответствующего сообщения об ошибке:

```bash
a.testpalm.yml:
  - Не указана обязательная опция 'feature'
```

#### Проверка на соответствие типов значений полей

Важным этапом валидации является проверка соответствия типов значений полей в файле тестового сценария.

Пример неправильного файла (значение поля `feature` указано массивом а не строкой):

```yaml
feature:
  - foo: bar

specs:
    foo: bar
```

Пример соответствующего сообщения об ошибке:

```bash
a.testpalm.yml:
  - Значение ключа 'feature' должно быть string.
```

### Проверка наличия файлов подключенных авто-тестов

Валидатор провряет, что все файлы указанные в поле [files](./yaml-files.md#files) существуют,

Пример неправильного файла, тег `no_acessors` попадает под маску описанную в схеме, но не совпадает с референсом.

```yaml
feature: Поисковая стрелка

files:
  - a.js
```

Пример ошибки:

```bash
a.testpalm.yml:
  - Файл 'a.js' не существует
```

### Проверка меток "label"

Валидатор проверяет, что [label](./yaml-files.md#label) не объявлен дважды в сценариях всего проекта.
В режиме [strictLabels](./configuration.md#strictLabels) валидатор проверяет, что [label](./yaml-files.md#label) не объявлен дважды в сценариях внутри одного файла.

Пример неправильных файлов, метка `test` в двух сценариях.

```yaml
feature: Поисковая стрелка

specs:
  foo:
    - label: some-label
  bar:
    - label: some-label

files:
  - a.js
```

Пример ошибки:

```bash
a.testpalm.yml:
  - Метка с названием "some-label" уже существует в файле a.testpalm.yml
```

### Проверка наличия дубликатов сценариев

Валидатор проверяет, что сценария имеет уникальное имя в рамках одного типа сценария.

Пример: сценария "Поисковая стрелка foo" встречается дважды в разных файлах под свойством `specs`.

```yaml
# a.testpalm.yml

feature: Поисковая стрелка

specs:
  foo:
    - do: some-do

files:
  - a.js
```

```yaml
# b.testpalm.yml

feature: Поисковая стрелка

specs:
  foo:
    - do: some-do

files:
  - b.js
```

Пример ошибки:

```bash
b.testpalm.yml:
  - [specs] Поисковая стрелка foo:
    - Обнаружено дублирование тестового сценария в файлах a.testpalm.yml

a.testpalm.yml:
  - [specs] Поисковая стрелка foo:
    - Обнаружено дублирование тестового сценария в файлах b.testpalm.yml
```

### Проверка наличия пробела после двоеточия в названиях шагов

Валидатор проверяет, что названия шага сценария разделяется двоеточием с последующим пробелом.

Пример не правильного сценария

```yaml
feature: Поисковая стрелка

specs:
  foo:
    - do: some-do
  bar:
    - do:some-do
    - assert: some-assert

files: []
```

```bash
a.testpalm.yml:
  - [specs] Поисковая стрелка foo:
    - Пропущен пробел после двоеточия: "do:some-do"
```

### Проверка контекста использования hermione-скриншотов

Валидатор проверяет, что hermione-скриншот используется в корректном контексте. Под корректном контекстом понимаются сценарии определённых типов. Прямо сейчас hermione-скриншоты поддерживаются в `specs` и `specs-integration`.

Пример некорректного использования:

```yaml
# file.testpalm.yml
feature: Поисковая стрелка

specs-honeypots:
  foo:
    - do: text
    - assert: some [state]
```

В сценариях типа `specs-honeypots` hermione-скриншоты не поддерживаются, поэтому будет выведена ошибка:

```bash
file.testpalm.yml
  - [specs-honeypots] Поисковая стрелка foo:
    - В тест-кейсах типа "specs-honeypots" не поддерживаются hermione-скриншоты.
Validation has been failed.
```

### Проверка формата ссылки на скриншот (опционально)

Валидатор включается автоматически, если включена выгрузка Jing-скриншотов в S3 ([s3MdsUpload](./configuration.md#s3MdsUpload), [s3MdsUploadJingScreenshots](./configuration.md#s3MdsUploadJingScreenshots)).

Валидатор проверяет, что ссылка на скриншот соответствует определенному формату. На данный момент разрешены лишь ссылки на скриншоты, расположенные на https://jing.yandex-team.ru.

Пример сценария с невалидной ссылкой на скриншот:

```yaml
# a.testpalm.yml
feature: Поисковая стрелка

specs:
  foo:
    - do: anything
    - screenshot: check [https://yadi.sk/screenshot]
```

```bash
a.testpalm.yml:
  - Невалидная ссылка на скриншот: https://yadi.sk/screenshot. Допускается использовать ссылки только на jing.
Validation has been failed.
```

### Проверка синтаксиса импортируемых групп шагов (опционально)

Данная валидация опциональна и включается с помощью опции в конфигурации [steps-group-syntax](./configuration.md#validationOpts).
По умолчанию отключена.

#### Проверка дублирования групп шагов

Валидатор проверяет наличие одинаковых идентификаторов групп шагов в разных импортированных файлах.

Пример, есть два файла с группами шагов, где повторяются индентификаторы:

```yml
# a.testpalm.steps.yml
Идентификатор шагов: #   ⃪ идентификатор группы шагов
    - do: В контекстном меню выберите “Удалить”
    - assert: Сообщение удаляется
```

```yml
# b.testpalm.steps.yml
Идентификатор шагов: #   ⃪ идентификатор группы шагов
    - do: В контекстном меню выберите “Удалить”
    - assert: Сообщение удаляется
```

```yml
# a.testpalm.yml
feature: Поисковая стрелка

import-steps:
    - a.testpalm.steps.yml
    - b.testpalm.steps.yml

specs:
    Свое сообщение:
        - attach: ["Идентификатор шагов"]
```

Пример ошибки:

```bash
a.testpalm.yml:
  - Обнаружено дублирование идентификаторов групп шагов "Идентификатор шагов" в файлах:
    - a.testpalm.steps.yml,
    - b.testpalm.steps.yml
```

#### Проверка несуществующих групп шагов

Валидатор проверяет существование используемых групп шагов.

Пример, указали не существующую группу шагов:

```yml
# a.testpalm.steps.yml
Идентификатор шагов: #   ⃪ идентификатор группы шагов
    - do: В контекстном меню выберите “Удалить”
    - assert: Сообщение удаляется
```

```yml
# a.testpalm.yml
feature: Поисковая стрелка

import-steps:
    - a.testpalm.steps.yml

specs:
    Свое сообщение:
        - attach: ["Неизвестная группа шагов"]
```

Пример ошибки:

```bash
a.testpalm.yml:
  - [specs] Поисковая стрелка foo:
    - Идентификатор группы шагов "Неизвестная группа шагов" не определён в импортированных группах:
      - a.testpalm.steps.yml
```

Пример, используется группа шагов, но файл с шагами не подключен:

```yml
# a.testpalm.steps.yml
Идентификатор шагов: #   ⃪ идентификатор группы шагов
    - do: В контекстном меню выберите “Удалить”
    - assert: Сообщение удаляется
```

```yml
# a.testpalm.yml
feature: Поисковая стрелка

specs:
    Свое сообщение:
        - attach: ["Неизвестная группа шагов"]
```

Пример ошибки:

```bash
a.testpalm.yml:
  - [specs] Поисковая стрелка foo:
    - Невозможно использовать идентификатор группы шагов "Идентификатор шагов" без указания "import-steps" в YAML-файле
```

### Проверка наличия поля tlds (опционально)

Валидатор проверяет, что у всех сценариев имеется поле [tlds](./yaml-files.md#tlds) и его значения соотвествует заданным в конфигурации в свойстве [requiredTlds](./configuration.md#requiredTlds).

Данная валидация опциональна и включается с помощью опции в конфигурации [required-tlds](./configuration.md#validationOpts)
По умолчанию отключена.

Пример сценария с отсутствующим полем `tlds`

```yaml
feature: Поисковая стрелка

specs:
  foo:
    - do: some-do
  bar:
    - tlds:
      - ru

files: []
```

Пример ошибки:

```bash
a.testpalm.yml:
  - [specs] Поисковая стрелка foo (desktop):
    - Значение свойства "tlds" должно быть: ru,by,ua,kz,uz,com.tr,fr,com.
        Текущее значение: undefined.
```

### Проверка наличия шагов и проверок (опционально)

Валидатор проверяет, что во всех сценариях имеется как минимум один шаг ("do") и как минимум одна проверка ("assert", "screenshot" или "spec"). Без этих инструкций тест не имеет смысла.

Данная валидация опциональна и включается с помощью опции в конфигурации [required-step-and-expect](./configuration.md#validationOpts).
По умолчанию отключена.

Пример сценария:

```yaml
feature: Поисковая стрелка

specs:
  foo:
    - do: some-do

files: []
```

Пример ошибки:

```bash
a.testpalm.yml:
  - [specs] Поисковая стрелка foo (desktop):
    - В тесткейсе отсутствуют действия с типами "assert", "screenshot" и "tech"
```

### Проверка наличия шага перед каждой группой проверок (опционально)

Валидатор проверяет, что во всех сценариях перед каждой группой проверок ("assert", "screenshot", "spec") задан шаг ("do"). Это нужно для корректного форматирования шагов с [expectation синтаксисом](./expectation-syntax.md).

Данная валидация опциональна и включается с помощью опции в конфигурации [required-step-before-expect](./configuration.md#validationOpts).
По умолчанию отключена.

Пример сценария:

```yaml
feature: Поисковая стрелка

specs:
  foo:
    - assert: some-assert

files: []
```

Пример ошибок:

```bash
a.testpalm.yml:
  - [specs] Поисковая стрелка foo (desktop):
    - Пропущено действие с ключом "do" перед действием "assert: some-assert"
```

### Проверка структуры сценария

Валидатор проверяет, что поля находятся в структуре `yml` только там, где им разрешено быть. 

Места сценария, в которых можно использовать поле - описываются в [схеме](yaml-files.md) и в [расширении схемы](configuration.md#schemeextension) параметром `scope` ([подробнее о параметре](configuration.md#schemeextensionscope)). 

Пример:

Описание некоторых полей из [стандартной схемы](../lib/config/common-scheme.js):

```js
[
  {
    name: 'do',
    format: formats.isString,
    scope: [TESTCASE, HOOK]
  },
  {
    name: 'experiment',
    required: false,
    meta: true,
    format: formats.isString,
    scope: [ROOT]
  },
  {
    name: 'type',
    required: false,
    meta: true,
    format: formats.isString,
    scope: [ROOT]
  }
];
```
Такой сценарий не пройдёт валидацию:
```yml
# в комментариях написан scope, в котором находится поле в сценарии
feature: Шапка

do: Используй поле do там, где нельзя # ROOT

specs:
  Группа Тестов:
    beforeEach:
      - do: anything before testcase
      - experiment: some-experiment=1 # HOOK
    type: Самые важные тесты # TESTGROUP
    foo:
      - do: anythig
      - assert: something
      - experiment: secret experement # TESTCASE
```

Пример ошибок (из сценария выше):
```sh
a.testpalm.yml:
  - Поле "do" не может находиться в корне файла.
  - [specs] Шапка Группа Тестов foo (desktop):
    - Поле "experiment" не может находиться в тест-кейсе.
  - [specs] Шапка Группа Тестов:
    - Поле "type" не может находиться в группе тестов.
    - Поле "experiment" не может находиться в хуке.
```


## Валидация по авто-тестам

Данный тип валидации проверяет соотвествие сценариев авто-тестам.
Валидацию можно отключить с помощью опции [tests](./configuration.md#validtionOpts).

### Проверка связанных Hermione и Hermione-e2e тестов

В файлах тестовых сценариев присутствует обязательное поле [files](./yaml-files.md#files), значением которого является
список файлов Hermione или Hermione-e2e тестов, относящихся к данному сценарию.

Данный этап валидации проверяет, что **все** тесты из **каждого** файла с тестами Hermione и Hermione-e2e
задекларированы в файле тестового сценария.

Допустим есть файл тестового сценария:
```yaml
feature: Поисковая стрелка

specs:
  beforeEach:
    - do: получить выдачу по запросу 'test'
    - screenshot: вид по умолчанию [search/with-text plain]
  Выполняется перезапрос с другим запросом:
    - do: установить в инпут значение 'testqz'
    - do: получить значение инпута
    - assert: запрос должен измениться
  Очистка 2-го инпута:
    - do: очистить инпут
    - assert: инпут очистился

specs-integration:
  beforeEach:
    - do: получить выдачу по запросу 'test'
  Выполняется перезапрос с другим запросом:
    - do: установить в инпут значение 'testqz'
    - do: получить значение инпута
    - assert: запрос должен измениться

files:
  - hermione/test-suites/common/arrow.hermione-e2e.js
  - hermione/test-suites/common/arrow.hermione.js
```

#### Проверка наличия Hermione, Hermione-e2e теста

В файле тестового сценария описано 3 теста:
* **specs** `Поисковая стрелка Выполняется перезапрос с другим запросом`
* **specs** `Поисковая стрелка Очистка 2-го инпута`
* **specs-integration** `Поисковая стрелка Выполняется перезапрос с другим запросом`

и указан соответствующий данному сценарию файл с Hermione-тестами `hermione/test-suites/common/arrow.hermione.js`

В файле есть содержимое вида:
```js
'use strict';

describe('Поисковая стрелка', function() {
    beforeEach(function() {
        ...
    });

    it('Очистка 1-го инпута', function() {
        ...
    });

    it('Выполняется перезапрос с другим запросом', function() {
        ...
    });
});
```

Т.е. из двух тестов в сценарии описан только `Поисковая стрелка Выполняется перезапрос с другим запросом`.

В таком случае, для неописанного теста будет получено сообщение об ошибке и предложен вариант наиболее похожего названия для теста из тестового сценария (используется [метрика Левeнштейна](https://ru.wikipedia.org/wiki/Расстояние_Левенштейна)):
```bash
features/touch-phone/news/news.hermione.js:
  - Тест "Поисковая стрелка Очистка 1-го инпута" не описан в файле features/common/arrow/arrow.testpalm.yml
	Возможно, вы имели в виду:
	 - Поисковая стрелка Очистка 2-го инпута
```

### Проверка наличия скриншота в Hermione, Hermione-e2e тестах

Валидатор проверяет, что у сценария в шаге [screenshot](./yaml-files.md#screenshot) указан существующий скриншот.

Пример сценария с указанием не существующего скриншота:

```yaml
feature: Поисковая стрелка

specs:
  foo:
    - do: some-do
    - screenshot: [some-screenshot]

files:
  - a.hermione.js
```

```js
// a.hermione.js

specs({
    feature: 'Поисковая стрелка',
}, () => {
  it('foo', function() {
      return this.browser
          .assertView('showcase', '.composite');
  });
});

```

```bash
a.testpalm.yml:
  - [specs] Поисковая стрелка foo (desktop):
    - Не найден скриншот для стэйта "some-screenshot" в авто-тесте.
```

### Проверка наличия существующего скриншота указанного c использованием метки label

Валидатор проверяет, что у сценария указан существующий скриншот с использование метки label.

Пример не правильного сценария:

```yaml
feature: Поисковая стрелка

specs:
  foo:
    - do: some-do
    - screenshot: [some-label >> some-screenshot]
  bar:
    - label: some-label

files:
  - a.hermione.js
```

```js
// a.hermione.js

specs({
    feature: 'Поисковая стрелка',
}, () => {
  it('bar', function() {
      return this.browser
          .assertView('showcase', '.composite');
  });
});

```

```bash
a.testpalm.yml:
  - [specs] Поисковая стрелка foo (desktop):
    - Не найден стэйт "some-screenshot" в метке "some-labels"
```

### Проверка существования метки указанной в label

Валидатор проверяет что в шаге `screenshot` используется существующая метка `label`.
В режиме [strictLabels](./configuration.md#strictLabels) валидатор проверяет, что метка объявлена в текущем файле или в файлах, указанных в поле `import-labels`.

Пример не правильного сценария:

```yaml
feature: Поисковая стрелка

specs:
  foo:
    - do: some-do
    - screenshot: [undefined-label >> some-screenshot]
  bar:
    - label: some-label

files:
  - a.hermione.js
```

```bash
a.testpalm.yml:
  - [specs] Поисковая стрелка foo (desktop):
    - неизвестная метка с названием "undefined-label". Пожалуйста, проверьте, описана ли данная метка.
```

### Проверка сценариев без авто-теста на отсутствие декларации метки

Валидатор ругается падает, если у тест-кейса задана метка, но для у него нет авто-теста. Метка нужна, чтобы затем ссылаться на скриншоты авто-тестов, поэтому у этих сценариев её объявлять нельзя.

Пример сценария с ошибкой:

```yaml
feature: Поисковая стрелка

specs:
  foo [manual]:
    - label: some-label
    - do: some-do

files: []
```

Пример ошибки:

```bash
a.testpalm.yml:
  - [specs] Поисковая стрелка foo [manual] (desktop):
    - В ручном тест-кейсе нельзя объявлять метку
```

### Проверка сценариев без авто-теста на наличие скриншота без метки (опционально)

Валидатор проверяет, что у сценариев без авто-теста указываются скриншоты только с меткой, так как собственного скриншота у него быть не может.

Данная валидация опциональна и включается с помощью опции в конфигурации [check-manual-scenario-screenshots](./configuration.md#validationOpts)
По умолчанию отключена.

Пример сценария с ошибкой:

```yaml
feature: Поисковая стрелка

specs:
  foo [manual]:
    - label: some-label
    - screenshot: [some-screenshot]

files: []
```

Пример ошибки:

```bash
a.testpalm.yml:
  - [specs] Поисковая стрелка foo [manual] (desktop):
    - В ручном тесткейсе нельзя использовать скриншоты авто-теста без метки
```

### Проверка наличия декларации всех файлов с авто-тестами в сценарияах

Валидатор проверяет, что все файлы, что подключены к сценарию через `files` существуют на файловой системе.

Пример не правильного сценария:

```yaml
feature: Поисковая стрелка

specs:
  foo:
    - do: some-do

files:
  - undefined.hermione.js
```

```bash
a.testpalm.yml:
  - Файл 'undefined.hermione.js' не существует
```

### Проверка наличия Automation ключа (опицонально)

Валидатор проверяет, что у сценариев без авто-теста объевлен ключ [automation](./yaml-files.md#automation) с ссылкой на тикет в трекере, где будет выполнена автоматизация сценария.

Данная валидация опциональна и включается с помощью опции в конфигурации [automation-syntax](./configuration.md#validationOpts)
По умолчанию отключена.

Пример сценария с отсутствующим ключем `automation`:

```yaml
feature: Поисковая стрелка

specs:
  foo:
    - do: some-do
  bar:
    - automation: TEST-123
    - do: some-do

files: []
```

Пример ошибки:

```bash
a.testpalm.yml:
  - [specs] Поисковая стрелка foo (desktop):
    - У тестового сценария отсутствует авто-тест, напишите его или добавьте ключ "automation" с задачей на автоматизацию
```
