# Структура файла с тестовыми сценариями для интеграции JS-тестов с TestPalm

Файл содержит описание тестовых сценариев для проверки конкретной функциональности проекта. Структура файла обеспечивает
удобную фиксацию и поддержку тестовых сценариев, а также импорт содержимого файла из репозитория проекта в [TestPalm](https://testpalm.yandex-team.ru).

* В качестве языка разметки используется [yaml](http://www.yaml.org/).
* Файлы проекта хранятся в директории `features` и внутри распределены по директориям с именами [платформ](#поддерживаемые-платформы), поддерживаемых сервисом.
* Формат названия файла `<name>.testpalm.yml`. Пример полного пути к файлу: `features/<platform>/<name>/<name>.testpalm.yml`.

В одном файле содержатся как тестовые сценарии для функциональных тестов вёрстки, так и для интеграционных тестов.

Функциональные тесты вёрстки – это тесты на дампах данных. Они не зависят от настоящих данных. Кроме того, имеют много вспомогательных функций, подменяющих некоторые части сервиса.

Интеграционные тесты – это тесты на "живых данных", то есть на полноценных ответах (читать "как в проде").

Код функциональных и интеграционных тестов при этом находится отдельных файлах:
* код функциональных тестов — в файле с расширением `.hermione.js` (`features/<platform>/<name>/<name>.hermione.js`).
* код интеграционных тестов — в файле с расширением `.hermione.e2e.js` (`features/<platform>/<name>/<name>.hermione.e2e.js`).

Сценарии функциональных и интеграционных тестов при этом находятся в отдельных свойствах в рамках одного YAML-файла:
* сценарии функциональных тестов — описываются в свойстве [specs](#specs);
* сценарии интеграционных тестов — описываются в свойстве [specs](#specs-integration);

> Все тестовые сценарии должны быть покрыты соответствующими авто-тестами, в противном случае тестовый сценарий должен быть отмечен меткой [automation](#automation).

## Плейсхолдеры

В синхронизируемых сценариях можно указывать плейсхолдеры (`{{PLACEHOLDER_NAME}}`). Они могут быть указаны в любом
строковом поле `yml`-файла. Для правильной синхронизации необходимо, чтобы в полном имени теста также был
плейсхолдер, так как название кейса должно быть уникальным для проекта.

Они будут раскрыты в соответствии с теми окружениями, которые указаны в конфигурации в разделе [`sets.yaml`](./configuration.md#sets) для
соответствующих файлу платформ (поле [`envs`](./configuration.md#setsenvs)). Если не указано ни одного окружения, для всех файлов будет использоваться текущее окружение.

Если переменная с таким именем отсутствует в окружении, то плейсхолдер будет заменён на пустую строку.

### Экранирование

Если есть необходимость использовать в тексте шагов тест-кейса пары фигурных скобок `{{...}}`, то скобки нужно экранировать, иначе этот блок текста будет воспринят palmsync'ом как плейсхолдер.

Нужно учитывать правила экранирования Markdown и YAML. В обоих языках экранирование выполняется с помощью символа `\`.

В Markdown можно экранировать символы `{` и `}`. Если написать `\{\{...\}\}`, то в отображении `\` не будет.

В YAML нельзя экранировать символы `{` и `}`. Экранированные последовательности интерпретируются только в строках, обрамлённых двойными кавычками. Если написать `"\{\{...\}\}"`, то будет синтаксическая ошибка. В этом случае можно экранировать каждый символ `\` перед скобкой.

Пример:
```yaml
specs:
  Тест:
    - do: введите {{PLACEHOLDER_NAME}} # PLACEHOLDER_NAME=some-name
    - do: введите \{\{TEXT\}\}
    - do: 'введите \{\{TEXT\}\}'
    - do: "введите \\{\\{TEXT\\}\\}"
```
В TestPalm будет отображаться так:

![placeholders-example](./images/placeholders-example.png)

В первом шаге из примера на место плейсхолдера подставилось значение из окружения. В остальных шагах скобки экранированы.

## Поддерживаемые платформы

Файлы с тестовыми сценариями раскладываются по директориям с именами платформ, для которых они написаны:

  * common
  * deskpad
  * desktop
  * touch-pad
  * touch-phone
  * searchapp

## Поля файла

В данном документе описываются **только общие поля**, которые актуальны для всех использующих Palmsync проектов.

Поля, специфичные для проекта, описываются в документации проекта.

### feature

**Обязательное**.

Имя тестируемой фичи. Участвует в формировании `title` тестового сценария в TestPalm.

### type

Тип фичи. При наличии участвует в формировании `title` тестового сценария в TestPalm.

Пример:
```yaml
feature: Маркет
type: clothes
```

### experiment

Эксперимент. При наличии участвует в формировании `title` тестового сценария в TestPalm.

Если указано поле `experiment`, но не указано поле `type`, то в качестве значения `type` будет использована строка `plain`.
Это необходимо для того, чтобы избежать коллизий при формировании `title`.
Также может сопровождаться опциональным [полем params.exp_flags](#paramsexpflags).

Пример:
```yaml
experiment: маленькое приложение в начале
params:
  exp_flags: show_bna_apps=1
```

### import-steps

Поле содержит ссылки на файлы, где описаны группы импортируемых шагов.
Подробнее в документации по [импортируемым шагам](./steps-group.md).

### import-labels

Поле содержит ссылки на файлы, где в сценариях указаны метки. Путь до файлов должен быть указан относительно корня проекта.
Подробнее в документации по [меткам](./labels.md).

### preconditions

Поле содержит строку, описывающее предварительные условия.

Это поле может быть использовано в корне файла, группе тестов, описании тест-кейса. Значение для каждого тесткейса устанавливается из ближайшего по уровню вложенности поля `preconditions`.

Пример:

```yaml
preconditions: | 
  Global
  multiline
  preconditions

specs:
  test-case-1:
    - do: do
    - assert: assert
  test-group:
    preconditions: Group preconditions
    test-case-2:
      - do: do
      - assert: assert
    test-case-3:
      - preconditions: Testcase preconditions
      - do: do
      - assert: assert
```

Значения поля `preconditions` для тесткейсов из примера:

* `test-case-1`
```
Global
multiline
preconditions
```

* `test-case-2`
```
Group preconditions
```

* `test-case-3`
```
Testcase preconditions
```

### Типы сценариев

#### specs

**Обязательно должно быть указано хотя бы одно из двух полей: [specs](#specs) или [specs-integration](#specs-integration)**.

Описание тестовых сценариев. Представляет собой древовидную структуру с неограниченным уровнем вложенности.

```yaml
specs:
  group-title: # группировка по group-title
    test-case-1: # Сценарий
      - do: do
      - assert: assert
    test-case-2: # Сценарий
      - do: do
      - assert: assert
```

Внутри каждой группы используются следующие ключи

* Заголовок сценария, группы (набора тестов или теста).
* [Хуки](#хуки).
* [Опциональные спецификаторы](#опциональные-спецификаторы).

В описании тест-кейса используются следующие ключи:
* [Шаги](#Шаги-сценария).
* [Опциональные спецификаторы](#опциональные-спецификаторы).

[Примеры сценариев](#Примеры-YML-файлов)

#### specs-integration

**Обязательно должно быть указано хотя бы одно из двух полей: [specs](#specs) или [specs-integration](#specs-integration)**.

Описание тестовых сценариев для интеграционных тестов. Структура и ключи полностью совпадают с полем [specs](#specs).

* Сценарии должны содержать только критичную функциональность, зависящую от реальных данных.
* Нельзя использовать ни [Вечные данные], ни `Замороженные данные`.
* Следует описывать проверки элементов, которые относительно стабильно появляются на выдаче. Например, в большинстве
случаев нельзя проверить контент элементов, он вариативен. Также не получится проверить дистрибуционные элементы, так
как они зависят от атома.

#### specs-honeypots

Описание тест-кейсов, которые могут быть использованы в качестве контрольных тест-кейсов (ханипотов) для асессоров или толокеров. Структура и ключи полностью совпадают с полем [specs](#specs).

* У таких тест-кейсов нет и не может быть автотестов.

### files

**Обязательное**.

Список файлов с тестами, в которых реализованы описанные сценарии. Путь к файлу с тестом следует указывать от корня проекта.
Он может располагаться на любом уровне вложенности и содержать маски.

Поле `files` служит отметкой об автоматизации теста. Если тест ещё не автоматизирован, то поле `files` может содержать специальное значение `TODO`:
```yaml
files: TODO # сценарий необходимо автоматизировать, но задач пока нет
...
files:
  - TODO: http://st.yandex-team.ru/SERPTOJS-29 # hermione
  - TODO: http://st.yandex-team.ru/SERPTOJS-30 # hermione-e2e
```

### Хуки
Хуки можно определить только рядом с описаниием тест-кейсов.

* `before` — шаги (только действия и/или проверки), которые будут выполнены единожды перед запуском первого теста в данном наборе.
* `beforeEach` — шаги (только действия и/или проверки), выполняемые перед каждым тестом в данном наборе тестов.
* `after` — шаги (только действия и/или проверки), которые будут выполнены единожды после запуска первого теста в данном наборе.
* `afterEach` — шаги (только действия и/или проверки), выполняемые после каждого теста в данном наборе тестов.

Пример использования хуков можно увидеть [тут](#Пример-файла).

В хуках разрешено использовать следующие шаги: `do`, `assert`, `tech`, `screenshot`, `assertMetrics`, `label`, `attach`.
Актуальный список можно найти [тут](../lib/constants/actions.js).

### Шаги сценария

#### do

Шаг действие.
Например, `- do: нажать кнопку 'Еще'`;

#### assert

Шаг проверка в виде сообщения.
Например, `- assert: видно только 3 сайтлинка`;

#### screenshot

Шаг проверка в виде скриншота.
Например, `- screenshot: имя_блока [<путь до скриншота в тесте>]`.

В квадратных скобках может быть указан:
  - название assertView стэйта hermione-теста (`[plain]`)
  - метка (label) на assertView стэйт любого hermione-теста в формате `[labelName >> stateName]` (`[somelabelName >> plain]`). [Подробнее](./labels.md)
  - метка `todo` позволяет пропустить валидацию и поиск скриншота при синхронизации e.g `some title [todo plain]`

Если скриншот указывается без описания, следует брать значение поля в кавычки: `- screenshot: '[<путь до скриншота>]'`, так как иначе поле будет распаршено как массив;

#### tech

Шаг проверка то же, что и `assert`, не для асессоров;

#### info

Служебная информация.
Например, `- info: использовать версию моки - 2.2.0`;

#### attach

Служебный ключ, который подключает [импортируемые шаги](./steps-group.md);

#### label

Служебный ключ–метка, которая может быть использована в шаге `screenshot`. [Подробнее](./labels.md);

#### assertMetrics

Служебный шаг проверка метрик, не для асессоров. Может иметь следующие значения:
  - `-` — означает, что в тесте не должно быть проверки метрик;
  - `*` — означает, что в тесте должна быть проверка метрик, неважно, каких;
  - список имён метрик — означает, что в тесте эти метрики должны быть проверены, например:

```(yaml)
- assertMetrics:
  - web.total_click_count
  - web.total_all_click
```

#### automation

Служебный ключ, содержит ключ тикета в Трекере, где будет выполнена автоматизация данного тест-кейса.

Тест-кейс является ручным до тех пор, пока не будет автоматизирован по указанному тикету.

Пример:

```yaml
specs:
  Неавтоматизированный тест:
    - automation: FEI-123
    - do: ...
```

### Опциональные спецификаторы

#### priority

Приоритет функциональности.

Допустимые значения:

- `high`
- `medium` (по умолчанию)
- `minor`

#### browsers

Список браузеров, поддерживаемых в сценарии. По умолчанию заполняется всеми браузерами из сета. Можно указывать одну
строку или массив строк, каждая из которых является либо названием браузера либо названием группы браузеров.

```yaml
browsers: android-opera-42-pad
```

или

```yaml
browsers:
    - android-opera-42-pad
    - searchapp
```

или

```yaml
browsers:
    - android-group
```

В примере выше `android-group` это алиас для группы браузеров, определённый в проектном конфиге Palmsync.

Кроме того, можно указать "все браузеры **из сета**, кроме". Очень полезно для убирания searchapp из тачевых тестов.

```yaml
browsers:
    notFor: searchapp
```

или

```yaml
browsers:
    notFor:
        - searchapp
        - android-opera-42-pad
```

или

```yaml
browsers:
    notFor:
        - android-group
```

> Чтобы группы браузеров и `notFor` заработали необходимо их включить в [конфигурации](./configuration.md#checkBrowsers).

В поле валидно указывать любые браузеры, актуальные для данного проекта.

> При формировании итогового тест-кейса значения поля `browsers`, указанные на разных уровнях, не объединяются.
> Всегда используется самое вложенное значение.

Допустим, для сета указаны браузеры `a`, `b`, `c`. Тогда:

```yaml
specs:
  Какой-то сьют:
    browsers:
      notFor: a
    Кейс 1:
      - browsers: [a, c]
      - assert: bla-bla
    Кейс 2:
      - assert: bla-bla
  Второй сьют:
    browsers:
      - a
      - b
    Третий сьют:
      Кейс 3:
        - assert: bla-bla
  Четвертый сьют:
    Кейс 4:
      - assert: bla-bla
```

Сформированные браузеры:
  * Кейс 1: [a, c], потому что такие браузеры указаны в кейсе
  * Кейс 2: [b, c], потому что у кейса не указаны браузеры, а у родителя это все браузеры сета (a, b, c) за исключением а
  * Кейс 3: [a, b], потому что у кейса не указаны браузеры, а у родителя указаны браузеры (a, b)
  * Кейс 4: [a, b, c], потому что браузеры не указаны для этого кейса или какого-то из его родительских сьютов => используются браузеры из сета.

#### tlds

Список доменов верхнего уровня, поддерживаемых в сценарии.
Если поле соответствует значению `- tlds: all`, то в тест-кейс будут подставлены все домены указанные в [requiredTlds](./configuration.md#requiredTlds).
Если нет возможности указать список доменов, но требуется добавить сценарий, то можно указать `- tlds: none`, тогда валидатор пропустит такой тест-кейс.

> **Правильно**
>
> ```yaml
> tlds: all
> tlds: none
> tlds: ['some-tlds', 'another-tlds']
> tlds:
>   - some-tlds
>   - another-tlds
> ```

> **Не правильно**
>
> ```yaml
> tlds: [all]
> tlds: [none]
> tlds: some-tlds,another-tlds
> ```

#### langs

Список языков, поддерживаемых в сценарии.

#### manager

Ответственный менеджер.

#### qa-engineer

Ответственный тестировщик.

#### tags

Теги для фильтрации в [TestPalm](https://testpalm.yandex-team.ru).

Тег или набор тегов может быть выставлен как для целого сьюта, так и для отдельных сьютов и даже тестов.

Пример:

```yml
tags: manual

specs:
  Какой-то сьют:
    tags: smoke
    Какой-то тест:
      - tags:
        - foo
        - bar
      - do: bla-bla
      - assert: bla-bla
```

При этом, при формировании итогового тест-кейса в значения его тегов попадут все теги соответствующего теста, его
родительского сьюта и т.д до корневого сьюта.

В данном примере результирующий набор тегов будет: `manual`, `smoke`, `foo`, `bar`.

#### params

В данном поле можно указать произвольные параметры, которые будут добавлены в атрибуты тестового сценария, само поле
`params` в атрибуты не попадёт. Может быть выставлен как для всего файла, так и для отдельных сьютов и даже тестов.

Для уменьшения вероятности опечатки - можно строго определить набор ключей, допустимых в `params`. Для этого существует параметр конфигурации [`paramsKeys`](./configuration.md#paramsKeys).

Пример:

```yml
params:
  exp_flags:
    - foo1
    - foo2
  some_key: foo

specs:
  Какой-то сьют:
    params:
      exp_flags: bar
    Какой-то тест:
      - params:
          some_key:
            - baz1
            - baz2
      - do: bla-bla
      - assert: bla-bla
```

При этом, при формировании итогового тест-кейса в атрибуты попадут все значения `params` соответствующего теста, его родительского сьюта и т.д. до корневого сьюта.

В данном примере в атрибуты тест-кейса попадут следующие поля:
`params.exp_flags: foo1, foo2, bar` и `params.some_key: foo, baz1, baz2`.

##### params.exp_flags

Список флагов, включающих эксперимент. Может состоять из одного или нескольких значений `exp_flags`.

Пример:

```yaml
experiment: включение конструктора
params:
  exp_flags:
    - force_constructor=1
    - constructor_adresa=1
```

#### aliases

Стандартный способ для `yml` уменьшить дублирование. Можно выделить общие проверки, а при написании сценариев сослаться на них.
Для лучшего понимания можно подглядывать в [небольшой пример](https://github.com/cyklo/Bukkit-OtherBlocks/wiki/Aliases-%28advanced-YAML-usage%29#simple-example) использования.

Алиасы поддерживаются только в хуках и тестах.

#### counter

Счётчик показа более-менее однозначно определяющий фичу, может быть указан как для всего файла, так и для отдельных сьютов или даже тестов.

Это поле необходимо в тех ямлах, в которых есть интеграционные тесты.

Пример:

```yaml
feature: Поисковая стрелка
type: Пустой запрос

counter: /foo/my/pretty/bar/suite

specs:
  Выполняется перезапрос с другим запросом:
    - do: получить выдачу по запросу ''
    - do: установить в инпут значение 'moscows'
    - counter: /foo/my/pretty/bar/test

```

При формировании итогового тест-кейса в поле `counter` выставляется значение в зависимости от приоритета: тест → родительский сьют → корневой сьют.
В данном примере в значение поля `counter` запишется `/foo/my/pretty/bar/test`.

#### description

Расширенное описание тестового сценария.

## Ограничения

Для описания тестовых сценариев есть несколько ограничений:

* Сценарий не может содержать на одном уровне вложенный сценарий и набор шагов/проверок (assert).
* Последовательность выполнения сценариев не гарантируется.
* В значениях полей файла не рекомендуется использовать символы `#` и `:`, так как они являются специальными в `yaml`.
Если они встречаются в строке, необходимо заключить всю строку в кавычки.

## Примеры YML-файлов

### Пример файла

```yaml
feature: БНО (конструктор)

specs:
  beforeEach:
    - do: получить выдачу по запросу 'райффайзенбанк'
    - assert: на выдаче есть сниппет БНО на конструкторе
  Развернуть все сайтлинки:
    - screenshot: БНО с 3-мя сайтлинками [short] // hermione-скриншот
    - assert: видно только 3 сайтлинка
    - assert: все дескрипшены скрыты
    - do: клик на кнопку 'еще'
    - screenshot: БНО с 6-ю сайтлинками [full] // hermione-скриншот
    - assert: видно 6 сайтлинков
    - assert: видно дескрипшены у всех 6 сайтлинков
  Свернуть все сайтлинки:
    - do: раскрыть все сайтлинки кликом на кнопку 'еще'
    - assert: видно 6 сайтлинков
    - assert: видно дескрипшены у всех 6 сайтлинков
    - do: клик на кнопку 'еще'
    - assert: видно только 3 сайтлинка
    - assert: все дескрипшены скрыты
  Инлайн-установка [manual]:
    - do: кликнуть в последнюю ссылку
    - assert: должна произойти инлайн-установка

files:
  - hermione/test-suites/touch-phone/bno/bno-constructor.hermione.js

manager:
  - sunny
```

### Пример файла с использованием экспериментальных флагов

```yaml
feature: Дистрибуция в саджесте

params:
  exp_flags:
    - suggest_distribution=1

specs:
  beforeEach:
    - do: получить выдачу по запросу 'тест'
    - do: кликнуть в инпут
    - assert: саджест открыт
  Для незалогиненных:
    Должен отсутствовать блок с дистрибуцией в саджесте:
      - assert: должен отсутствовать блок с дистрибуцией в саджесте
  Для залогиненных:
    Должен присутствовать блок с дистрибуцией в саджесте:
    - assert: должен присутствовать блок с дистрибуцией в саджесте
    - screenshot: в саджесте присутствует дистрибуция [plain]

files:
  - hermione/test-suites/touch-phone/suggest-tips/suggest-tips.hermione.js

priority:
  - high
```

### Пример файла с описанием интеграционных сценариев

```yaml
feature: Колдунщик 1орг

specs-integration:
  aliases:
    - &ПрисутствиеЭлементов
      - assert: должен появиться заголовок
      - assert: должна появиться карта
      - assert: должна появиться картинка рядом с картой
      - assert: должна появиться кнопка позвонить
      - assert: должна появиться кнопка маршрут
      - assert: должна появиться кнопка сайт
      - assert: должен появиться непустой блок с информацией об организации
      - assert: должен появиться непустой блок с рейтингом и отзывами
      - assert: должен появиться непустой блок с описанием организации
      - assert: должен появиться блок похожих мест
      - assert: должен появиться блок с ссылками в футере колдунщика

  beforeEach:
    - do: получить выдачу по запросу ‘ква-ква парк’
    - assert: на выдаче есть колдунщик 1org
  Проверяем вид на выдаче колдунщика 1орг:
    *ПрисутствиеЭлементов
  Ajax загрузка сайдблока с картой и минибейджом:
    - do: кликнуть по карте
    - assert: должен появиться сайдблок с картой и минибейджом
    - assert: должен появиться пин на карте
  Ajax загрузка сайдблока с расширенной карточкой:
    - do: кликнуть по заголовку
    - assert: должен появиться сайдблок с карточкой организации
    - *ПрисутствиеЭлементов

specs:
# Сценарии для hermione на дампах

files:
  - features/touch-phone/companies/companies-one.hermione.js
  - features/touch-phone/companies/companies-one.hermione.e2e.js
```
