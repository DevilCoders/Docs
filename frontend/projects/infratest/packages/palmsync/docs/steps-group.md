# Импортируемые группы шагов

## Описание

Импортируемые группы шагов позволяют упростить написание и поддержку тестовых сценариев в том случае,
если между тестовыми сценариями имеется набор общих шагов.
Импортируемые шаги должны быть описаны в виде плоского объект в файлах, имеющих расширение `*.testpalm.steps.yml`.

```yml
# path/to/file/groups-steps.testpalm.steps.yml
Тап по цитате:
    - do: Тапните по сообщению, которое вы цитировали
    - assert: Контекстное меню появляется

Контекстное меню, кнопка "удалить":
    - do: В контекстном меню выберите “Удалить”
    - assert: Сообщение удаляется
```

Для импортирования группы шагов в тестовый сценарий необходимо:

* Декларировать используемые файлы с группами шагов в `import-steps`;
* Импортировать требуемую группу шагов в тестовый сценарий, используя шаг типа `attach`, который представляет собой массив идентификаторов групп.

```yml
feature: Контекстное меню Удалить Свое сообщение Цитируемое

import-steps:
    - path/to/file/groups-steps.testpalm.steps.yml

specs:
    Some case:
        - attach: ["Тап по цитате", "Контекстное меню, кнопка \"удалить\""]
        - do: do something
        - assert: check something
```

При выгрузке тестовых сценариев в TestPalm, импортируемые группы шагов будут раскрыты в обычный набор шагов:

```yml
    - do: Тапните по сообщению, которое вы цитировали
    - assert: Контекстное меню появляется
    - do: В контекстном меню выберите “Удалить”
    - assert: Сообщение удаляется
    - do: do something
    - assert: check something
```

## Принцип работы импорта

Подключение необходимых файлов с группами шагов к обычному YAML файлу осуществляется с помощью ключа `import-steps`.

```yml
import-steps:
    - path/to/file1.testpalm.steps.yml
    - path/to/file2.testpalm.steps.yml
```

> Пути к файлам *.testpalm.steps.yml необходимо указывать относительно корня репозитория.

Далее Palmsync строит индекс по идентификаторам групп шагов из этих файлов. Если подключено несколько файлов, то индексы из разных файлов будут объединены в один. Если в двух импортируемых файлах найдены группы шагов с одинаковыми идентификаторами, то валидатор выдаст ошибку:

> Обнаружено дублирование идентификаторов групп шагов "Набор шагов 1" в файлах:
>    * path/to/file1.testpalm.steps.yml,
>    * path/to/file2.testpalm.steps.yml

Индекс с группами шагов строится индивидуально для каждого YAML файла.

После загрузки групп шагов в память, в тест-кейсах в шагах `attach` они будут доступны по идентификатору. В качестве идентификатора группы шагов выступает их заголовок:

```yml
# path/to/file1.testpalm.steps.yml
Контекстное меню, кнопка "удалить": #   ⃪ идентификатор группы шагов
    - do: В контекстном меню выберите “Удалить”
    - assert: Сообщение удаляется
```

Подключить шаги в тест-кейсе можно несколькими способами:

```yml
# Вариант 1
- attach: ["Контекстное меню, кнопка \"удалить\""]

# Вариант 2
- attach: ["Контекстное меню, кнопка \"удалить\"", "Тап по цитате"]

# Вариант 3
- attach:
    - Контекстное меню, кнопка "удалить"
    - Тап по цитате

# Вариант 4
- attach: Контекстное меню, кнопка "удалить"
```

Если в индексе не была найдена указанная группа шагов, то валидация выдаст ошибку:

> "Название тест-кейса": Идентификатор группы шагов "Набор шагов 1" не определён в импортированных группах:
>    * path/to/file1.testpalm.steps.yml,
>    * path/to/file2.testpalm.steps.yml

Если в сценарии отсутствует ключ `import-steps`, но в тест-кейсах есть шаги типа `attach`, то валидация выдаст ошибку:

> "Открытие чата по ссылке Открывается чат по ссылке (desktop)": Идентификатор группы шагов "Открытие чата по ссылке" не определён, у тест кейса отсутствует ключ "import-steps"

### Определение пути до скриншотов в шагах типа `screenshot`

В группах шагов поддерживается импорт шагов типа `screenshot`:

```yml
# path/to/file.testpalm.steps.yml
Сообщение удалилось:
    - screenshot: Проверить что сообщение удалилось [deleted]
```

Поиск скриншотов, связанных с hermione тестами, будет производиться относительно того `YAML`-файла, в котором используется шаг типа `attach`. Такое поведение обусловлено тем, что раскрытие шага типа `attach` происходит до того, как происходит выгрузка скриншотов.

Например есть 2 разных тест-кейса:

```yml
# path/to/file/context-menu/file.testpalm.yml
feature: Контекстное меню Удалить

import-steps:
    - path/to/file/groups-steps.testpalm.steps.yml

specs:
    Свое сообщение:
        - attach: ["Сообщение удалилось"]
```

```yml
# path/to/file/some-menu/file.testpalm.yml
feature: Какое-то меню Удалить

import-steps:
    - path/to/file/groups-steps.testpalm.steps.yml

specs:
    Свое сообщение:
        - attach: ["Сообщение удалилось"]
```

В `path/to/file/context-menu/file.testpalm.yml` скриншот `deleted` будет искаться в директории `path/to/file/context-menu/`.
В `path/to/file/some-menu/file.testpalm.yml` скриншот `deleted` будет искаться в директории `path/to/file/some-menu/`.

Шаги со скриншотами загруженными в хранилище `jing` импортируются как есть.

### Конфигурация Palmsync

По-умолчанию импорты отключены в Palmsync, но их можно включить через `.palmsync.conf.json` следующим образом:

```js
module.exports = {
    synchronizationOpts: {
        supportStepsGroup: true
    },
    stepsGroupPaths: ['features/**/*.testpalm.steps.yml'],
    validationOpts: {
        mode: ['steps-group-syntax']
    }
};
```

* `synchronizationOpts.supportStepsGroup` – включает поддержку импортов при синхронизации
* `stepsGroupPaths` – массив паттернов где palmsync будет искать файлы с группами шагов (без этого ничего не будет работать);
* `validationOpts.mode = ['steps-group-syntax']` – включает валидацию импортов. (Проверка на конфликт имен и доступность групп шагов);

> :warning: **Примечание**
>
> Если у вас в `.palmsync.conf.json` в `sets.yaml.{platform}.specs = [patterns]` паттерны заканчиваются на `*.yml`, то Palmsync будет пытаться прочитать файлы с группами шагов, как файлы со сценариями и Palmsync построит не правильные модели тест-кейсов, которые будут вызывать ошибки при синхронизации. Чтобы этого избежать необходимо явно указывать в паттернах, какие файлы нужны. Например для сценариев писать `*.testpalm.yml` для групп шагов `*.testpalm.steps.yml`.
