# hermione-auth-commands

Плагин для [hermione](https://github.com/gemini-testing/hermione), с командами авторизации/логаута из Паспорта. В качестве провайдера для генерации/реюза тестовых аккаунтов используется [TUS](https://wiki.yandex-team.ru/test-user-service/) через [`tus-client`](../tus-client).

Плагин разработан как часть решения проблемы авторизации при снятии дампов. Второй частью является еще один плагин - [`hermione-lifecycle-commands`](../hermione-lifecycle-commands), который позволяет запускать команды только в определенных режимах и фазах выполнения тестов, например, при снятии дампов. Для удобства оба плагина объединены в еще одном - [`hermione-auth-on-record-commands`](../hermione-auth-on-record-commands), специализирующемся на авторизации только при снятии дампов.

_Disclaimer_. При том, что существует техническая возможность использовать данный плагин независимо, например в е2е-тестах, ряд ограничений, допустимых для снятия дампов, таких как ограничение максимальной параллельности (см. опцию `size` команды [**authAny**](#authanylogingroup--lockfor--grouplockfor-size--groupsize-prefix--loginprefix-phone--true-multi--false-)), не позволяет на данный момент давать строгих гарантий на успешное использование в отличных от снятия дампов условиях (хотя при использовании команды [**auth**](#authlogin--prefix--loginprefix-phone--true-multi--false-) с ограниченным набором аккаунтов проблем быть не должно). Это объясняется текущими ограничениями TUS, который на данный момент не позволяет удалять вновь создаваемые аккаунты (поддержка такой функциональности в TUS запланирована).

### Установка

```bash
$ npm install @yandex-int/hermione-auth-commands --registry=http://npm.yandex-team.ru
```

### Конфигурация

Необходимо подключить плагин в конфиге `hermione`:

```js
module.exports = {
    // ...

    plugins: {
        '@yandex-int/hermione-auth-commands': {
            enabled: true,

            // tus_consumer. Обязательное поле.
            // Значение по умолчанию не определено.
            // Следует заводить своих консьюмеров для различных проектов.
            // Про флоу заведения и использования консьюмеров - [ниже](#tus_consumer).
            tus_consumer: 'fei-test',

            // Окружение Паспорта. Соответствие между значениями данной опции и окружениями
            //   следует смотреть здесь - https://wiki.yandex-team.ru/test-user-service/#env
            // По умолчанию "test", что соответствует окружению https://passport-test.yandex.ru
            env: 'test',

            // При создании новых тестовых аккаунтов TUS ожидает, что логины будут начинаться
            //   с "yandex-team-" или "yndx-".
            // Данная необязательная опция предназначена для избегания засилия таких префиксов
            //   при вызовах команд авторизации.
            // В случае неустановки данной опции соответствующие префиксы нужно будет указывать
            //   при вызове каждой команды авторизации.
            // В случае, если некоторый логин уже начинается с "yandex-team-" или "yndx-"
            //   данная опция игнорируется.
            // По умолчанию - пустая строка. Может быть переопределено при вызовых отдельных команд.
            //   через опцию `prefix`.
            loginPrefix: '',

            // Значение по умолчанию для количества аккаунтов в группе.
            // Используется при вызовах команды `authAny`.
            // Один из аккаунтов указаной группы будет заблокирован от использования в других тестах.
            // Значение следует выбирать соответствующим параллельности запускаемых тестов.
            // По умолчанию равно 1. Может быть переопределено в `authAny` через опцию `size`.
            groupSize: 1,

            // Значение по умолчанию для времени блокировки аккаунта из группы в секундах.
            // Используется при вызовах команды `authAny`.
            // Один из аккаунтов указанной группы будет заблокирован от использования в других
            //   тестах на указанное время.
            // Значение следует выбирать соответствующим таймаутам выполнения запускаемых тестов.
            // По умолчанию равно 0, что значит не блокировать никогда.
            // Может быть кастомизировано при вызовах `authAny` через опцию `lockFor`.
            groupLockFor: 0,

            // Логировать логин и пароль использованного для авторизации тестового аккаунта.
            // Может быть полезно для получения пароля от тестового аккаунта для
            //   целей дополнительной ручной настройки аккаунта.
            //
            // Альтернативным вариантом является использование команд show или list из tus-cli.
            //
            // Также данная опция конфигурации может быть установлена через переменную окружения
            //   `hermione_auth_commands_log_auth=true` или опцию `--auth-commands-log-auth=true`,
            //   для включения логирования в единичных запусках. Также одноименную опцию
            //   принимают команды authAny и auth.
            //
            // Не рекомендуется использовать эту опцию вне локальной разработки.
            // При этом, при использовании из другого плагина hermione-auth-on-record-commands
            //   включение данной опции позволяет логировать только при снятии или
            //   переснятии дампов.
            logAuth: false,

            // Различные опции, совпадающие с опциями @yandex-int/si.ci.requests
            //   будут применятся для всех запросов к TUS.
            requestOptions: {}
        }
    },
    // ...
};
```

Все опции можно установить в конфиге, передать опциями командной строки или передать в переменной окружения:
```bash
hermione --auth-commands-group-size=1
hermione_auth_commands_group_size=1 hermione
```

### Отладка

Для отладки можно установить переменную окружения `DEBUG=hermione-auth-commands*`

## Флоу использования плагина

#### tus_consumer

Предусловием использования плагина является создание нового TUS-консьюмера. Создать его можно воспользовавшись утилитой [**tus-cli**](../tus-cli#create-consumer)(подробности использования в readme утилиты).

Пользователь, создавший нового консьюмера, будет назначен администратором этого консьюмера в IDM для TUS. Администратору следует раздать доступы всем заинтересованным участникам соответствующего проекта, т.е. тем, кто будет запускать тесты с данным консьюмером. Предоставление доступа роботам не исключено, но в случае использования команд только для снятиям дампов (с помощью [`hermione-lifecycle-commands`](../hermione-lifecycle-commands)), роботам такой доступ не пригодится. Подробнее о консьюмерах и управлении ими можно почитать в [соответствующем разделе документации TUS](https://wiki.yandex-team.ru/test-user-service/#dostupiprivatnosttestovyxakkauntov).

После установки в конфигурации плагина обязательно следует указать вновь созданного консьюмера (`tus_consumer`). Использование кастомного консьюмера для различных проектов позволяет управлять разграничением доступа к вашим тестовым аккаунтам и делает возможным основные сценарии использования данного плагина (например, TUS не поддерживает _получение_ существующих тестовых аккаунтов без кастомного `tus_consumer`).

При необходимости допускается использование одного и того же консьюмера для набора связанных проектов, когда множество ответственных за эти проекты примерно совпадает и нет нужды дополнительно настраивать и разграничивать доступы.

#### Тестовые аккаунты

При первом вызове команды [**auth**](#authlogin--prefix--loginprefix-phone--true-multi--false-) с заданным `login` в контексте некоторого данного `tus_consumer` будет заведен тестовый аккаунт в соответствующем окружении Паспорта (определяется опцией конфигурации `env`) и информация о нем будет сохранена в TUS.

При авторизации тестового аккаунта информация о нем записывается в мета-поле `tus`, которую можно получить так:

```javascript
// auth - булевый признак авторизованности/залогаученности
const { login, uid, auth } = await this.browser.getMeta("tus");
```

_Обратите внимание, что пароль в мету не проставляется, чтобы не светиться в отчетах._

Также для получения информации об аккаунтах/группах аккаунтов (в т.ч. и паролей) или разблокировки аккаунтов может быть использована утилита [**tus-cli**](../tus-cli#поддерживаемые-команды).

##### Общие принципы использования тестовых аккаунтов

Если проверяемая в тесте функциональность не зависит от состояния авторизованного аккаунта, а лишь от самого факта авторизации, то такие тесты являются подходящими кандидатами для использования единого аккаунта без блокировок, т.е. для использования команды [**auth**](#authlogin--prefix--loginprefix-phone--true-multi--false-).
В случаях, когда в тестах проверяется специфичное состояние авторизованного аккаунта и количество браузеров, в которых выполняется тест больше одного, следует использовать команду [**authAny**](#authanylogingroup--lockfor--grouplockfor-size--groupsize-prefix--loginprefix-phone--true-multi--false-) с блокировкой каждого из аккаунтов группы на время теста. Насколько можно переиспользовать группы аккаунтов зависит от самих тестов, и если в каждом тесте проверяется уникальный кусочек состояния, непересекающийся с другими тестами, то одна такая группа может использоваться для всех подобных тестов. В случае пересечений может потребоваться заведение новых групп (т.е. указание отличающегося префикса для новой группы аккаунтов или отличающегося массива логинов при вызовах [**authAny**](#authanylogingroup--lockfor--grouplockfor-size--groupsize-prefix--loginprefix-phone--true-multi--false-)).

На данный момент к вопросу генерации тестовых аккаунтов следует подходить взвешенно и минимизировать число используемых в тестах аккаунтов, по возможности, поскольку пока что в TUS нет поддержки удаления тестовых аккаунтов (но она запланирована).

## Команды

#### `auth(login, { prefix = loginPrefix, phone = true, multi = false, tld })`

Принимает логин и авторизует тестовый аккаунт в Паспорте.

В случае отсутствия в TUS будет создан новый аккаунт с таким логином.

Логин должен начинаться с `yandex-team-` или `yndx-`. Для того, чтобы избежать необходимости дублировать префикс во всех командах авторизации, его можно указать в опции конфигурации `loginPrefix`. В случае, если указанный логин уже начинается с `yandex-team-` или `yndx-` опция конфигурации `loginPrefix` игнорируется, даже если установлена. Существует возможность переопрелить `loginPrefix` для отдельной команды с помощью опции `prefix`.

По умолчанию всем создаваемым при вызове данной команды аккаунтам будет присвоен одинаковый несуществующий номер телефона `+70000000007`. В случае необходимости получения аккаунта без номера телефона можно передать в команду опцию `phone` со значением `false`. Для привязки телефона к уже существующему тестовому аккаунту можно использовать [соответствующую команду **tus-cli**](../tus-cli#bind-phone--l-login--bind-phone--u-uid)

Метаинформация (логин, пароль, uid в TUS) об авторизованном аккаунте будет сохранена в мета-поле `tus` и доступна через `getMeta`.

Попытка вызвать **auth** при некотором уже авторизованном аккаунте завершится с ошибкой по умолчанию. Для мультиавторизации следует явно вызвать команду с опцией `multi` установленной в `true`.
Попытка вызвать **auth** для заблокированного (в терминах TUS) аккаунта завершится с ошибкой.

Параметр `tld` _(top-level domain)_ позволяет выполнять авторизацию на национальных доменах. Например, команда `auth('some-login', { tld: 'kz' })` для авторизации пойдет на сайт `https://passport.yandex.kz/...` _(если в переменной окружения Паспорта `env` в конфиге плагина указано `prod`)_. По умолчанию, `tld` считается равным `ru`.

Если авторизация проходила на национальном домене, то при логауте нужно тоже обязательно указать опцию `tld` с тем же самым национальным доменом, например `logout({ tld: 'kz' })`.

После авторизации следует явным образом перейти на необходимый в дальнейших шагах теста url, например, с помощью одноименной `hermione`/`wdio` команды `url`.

#### `authAny(loginGroup, { lockFor = groupLockFor, size = groupSize, prefix = loginPrefix, phone = true, multi = false, tld })`

Принимает префикс логина для группы или массив логинов, при необходимости создает и авторизует первый незаблокированный аккаунт группы в Паспорте. Каждому логину из группы проставляется сконфигурированный префикс.

Опции `lockFork` и `size` могут быть использованы для переопределения глобальных опций конфигурации `groupLockFor` и `groupSize` соответственно.
В случае, когда `loginGroup` - строка, `size` определяет количество аккаунтов, входящих в группу. Если `loginGroup` - массив, то размер группы определяется длиной массива, а `size` игнорируется.
`lockFor` определяет время блокировки очередного авторизованного аккаунта из группы.
При авторизации очередного аккаунта он блокируется от использования в других тестах на время `lockFor`.
В случае, если все `size` аккаунтов из группы оказались заблокированы, тест упадет с ошибкой.

Максимально возможное значение для `size` - 64.
Максимально возможное значения для `lockFor` - 3600.
По умолчанию равны значениям соответствующих опций из конфига плагина.

Конечные логины аккаунтов группы также должны начинаться с `yandex-team-` или `yndx-`. Глобальная опция `loginPrefix` также применяется для данной команды с возможностью переопределения через опцию `prefix` для отдельных команд.

Всем создаваемым при вызове данной команды аккаунтам по умолчанию будет присвоен одинаковый несуществующий номер телефона `+70000000007` В случае необходимости получения группы аккаунтов без номеров телефонов можно передать в команду опцию `phone` со значением `false`.

Метаинформация (логин, пароль, uid в TUS) об авторизованном аккаунте будет сохранена в мета-поле `tus` и доступна через getMeta.

Попытка вызвать **authAny** при некотором уже авторизованном аккаунте завершится с ошибкой по умолчанию. Для мультиавторизации следует явно вызвать команду с опцией `multi` установленной в `true`.

Параметр `tld` _(top-level domain)_ позволяет выполнять авторизацию на национальных доменах. Например, команда `authAny(loginGroup, { tld: 'by' })` для авторизации пойдет на сайт `https://passport.yandex.by/...` _(если в переменной окружения Паспорта `env` в конфиге плагина указано `prod`)_. По умолчанию, `tld` считается равным `ru`.

Если авторизация проходила на национальном домене, то при логауте нужно тоже обязательно указать опцию `tld` с тем же самым национальным доменом, например `logout({ tld: 'by' })`.

После авторизации следует явным образом перейти на необходимый в дальнейших шагах теста url, например, с помощью одноименной `hermione`/`wdio` команды `url`.

#### `logout({ tld } = {})`

Логаут из Паспорта ранее авторизованного аккаунта: `logout()`.

Попытка вызвать **logout** при отсутствии авторизованного аккаунта завершится с ошибкой.

Если авторизация осуществлялась на национальном домене, например, `lt`, то при логауте нужно обязательно указать тот же национальный домен в опции `tld`: `logout({ tld: 'lt' })`. По умолчанию, _top-level domain_ считается равным `ru`. Передавать пустой объект в команду `logout` при этом не нужно.

После выхода следует явным образом перейти на необходимый в дальнейших шагах теста url, например, с помощью одноименной `hermione`/`wdio` команды `url`.

#### `unlockAccount(forceTusMeta = null)`

Разблокировка ранее заблокированного с помощью [**authAny**](#authanylogingroup--lockfor--grouplockfor-size--groupsize-prefix--loginprefix-phone--true-multi--false-) аккаунта.

Может применяться как при наличии авторизованного аккаунта, так и при уже разлогиненном. Полезна, когда аккаунт уже не нужен в тесте, или при teardown'е теста, чтобы сделать аккаунт доступным для других тестов.

Разблокирует аккаунт ранее, чем это произошло бы с автоматической разблокировкой по истечении `lockFor`.

По умолчанию использует tus-мету, получаемую в момент вызова данной команды. При помощи опции `forceTusMeta` можно передать ранее полученную tus-мету. Необходимость такой опции объясняется тем, что в тесте может участвовать несколько аккаунтов, и, например, на момент окончания теста необходимо разблокировать несколько аккаунтов. Для этой цели данная опция используется, например, командой [**authAnyOnRecord**](../hermione-auth-on-record-commands#authanyonrecordlogingroup--lockfor--grouplockfor-size--groupsize-prefix--loginprefix-phone--true-multi--false-) плагина `hermione-auth-on-record-commands`.

#### `authorized(login, { prefix = loginPrefix, multi = false })`

Данная команда может использоваться в случаях, когда необходимо сообщить плагину об авторизации, осуществлявшейся не средствами команд плагина, а, например, накликиванием в интерфейсе. Данная команда не осуществляет реальную авторизацию, а лишь обновляет мета-поле `tus`. Также, в сценяриях мультиавторизации может быть использована для поддержки переключения между аккаунтами со стороны плагина.

Требования к `login` для данной опции совпадают с таковыми для команды [**auth**](#authlogin--prefix--loginprefix-phone--true-multi--false-): логин должен начинаться с `yandex-team-` или `yndx-`. Для того, чтобы избежать необходимости дублировать префикс во всех командах авторизации, его можно указать в опции конфигурации `loginPrefix`. В случае, если указанный логин уже начинается с `yandex-team-` или `yndx-` опция конфигурации `loginPrefix` игнорируется, даже если установлена. Существует возможность переопределить `loginPrefix` для отдельной команды с помощью опции `prefix`.

Попытка вызвать **authorized** при некотором уже авторизованном аккаунте завершится с ошибкой по умолчанию. Для мультиавторизации следует явно вызвать команду с опцией `multi` установленной в `true`.

#### `loggedOut()`

Данная команда может использоваться в случаях, когда необходимо сообщить плагину о логауте, осуществлявшемся не средствами команд плагина, а, например, накликиванием в интерфейсе. Данная команда не осуществляет реального логаута, а лишь обновляет мета-поле `tus`.

## Вспомогательная страница авторизации

_Данный раздел не предназначен для конечных пользователей и касается одной из деталей реализации плагина._

Для реализации авторизации тестовых аккаунтов в Паспорте используется вспомогательная страница в s3. Причина необходимости такой страницы - упрощение аутентификации, без необходимости учитывать и поддерживать детали реализации интерфейса Паспорта + страницы аутентификации разных окружений паспорта (прод, тест и внутренние) могут существенно отличаться по верстке между собой. Также такое решение является более универсальным, чем использование data-url'ов, которые не поддерживаются, например, в ie11.

Страница находится по адресу [https://zalogin-static.s3.mds.yandex.net/auth-page.html](https://zalogin-static.s3.mds.yandex.net/auth-page.html). Также она зафиксирована в [исходном коде](s3-auth-page.html). Бакет `zalogin-static` находится в квоте [abc Гермиона](https://abc.yandex-team.ru/services/hermione), обновление странички в бакете при наличии доступа осуществляется через [стандартный интерфейс s3](https://wiki.yandex-team.ru/mds/s3-api/s3-clients/#primery) или через [UI облака](https://yc.yandex-team.ru/folders/foo1a7e9mb11ded9lmvc/storage/buckets/zalogin-static)
