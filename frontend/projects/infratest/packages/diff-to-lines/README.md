# diff-to-lines

Инструмент для селективности.
 
Преобразует вывод git diff в набор lineRanges измененных файлов. 

Инструмент необходимо запускать в директории проекта, находящегося под контролем версий git.


```
npm install @yandex-int/diff-to-lines
```

```
const {diffToLineRanges} = require('@yandex-int/diff-to-lines');
cost SHA1 = '…'; // хеш комита_1
cost SHA2 = '…'; // хеш комита_2

console.log(diffToLineRanges(sha1, sha2));

// [
//     {
//        file: "path/to/file/one.js",
//        status: "M",
//        lineRanges: [[1, 2], [7, 8]]
//     }
// ]
```

## CLI

Пример работы:

```
$ cd web4

$ npx @yandex-int/diff-to-lines f21d845480946206f97608fb10ecc329839befec 38b552d201eeefe38239c3065792584a75c5af76 > out.json

$cat out.json
[{"file":"path/to/file/one.js",status:"M","lineRanges":[[0,0]]},{"file":"path/to/file/two.json",status:"M","lineRanges":[[1,8]]}]
```

Протестировано с git v2.15.0.

## API

Результатом работы инструмента является массив объектов с полями:

#### `file`: относительный путь до файла

#### `status`: статус изменения произошедшего с файлом. enum значений основан на `git diff`. см `man git-diff | grep 'Possible status letters' -A 30`


Возможные значения:

 * **D: удаление.** В селективности рассматриваем как полное изменение этого файла => нужно запустить все связанные тесты.
 * **R: переименование.** В селективности аналогично D.
 * **M: Модификация содержимого или битов доступа файла.** Самый ходовой случай для селективности => нужно запустить связанные с изменениями тесты.
 * **A: Добавление.** В селективности нас не интересует.
 * **C: Копирование файла.** В селективностии нас не интересует.
 * **T: Изменение типа файла.** В селективности не применимо.
 * **U: Файл в статусе unmerged в git.** В селективности не применимо.
 * **X: "unknown" тип.** В доке про гит написано что это баг, поэтому этот тул будет падать. В селективности не применимо.


#### `lineRanges`: массив диапазонов измененных строк файла

Каждый элемент массива `lineRanges` представляет собой `[ startLineNumber, endLineNumber ]`. Поле опциональное. Отсчет строк начинается с единицы. Диапазоны указаны «включительно», то есть `startLineNumber` это номер первой измененной строки ханка, а `endLineNumber` номер последней измененной строки ханка.

Если файл был добавлен, удален, скопирован или переименован, а его содержимое нетронуто, то поля `lineRanges` не будет, так как дифа по строкам нет, есть только дифф имени файла.

Если у файла изменен режим (например, изменены права доступа), то поля `lineRanges` не будет, так как дифа по строкам нет, есть только дифф по аттрибутам файла. 

В остальных случаях `lineRanges` будет описывать дифф содержимого.

## Тестирование

Для запуска тестов нужно использовать стандартную команду `npm test`. Особенность тестов состоит в том, что они исопльзуют данные находящиеся во внутреннем git-репозитории лежащем в `fixture/git-repo`. Commit messages используются в качестве имени теста, а соответствующий diff в качестве входных данных теста. Выходными данными являются результаты работы diff-to-lines. 

Чтобы поправить/дополнить тесты необходимо работать с внутренним репозиторием используя параметр `--git-dir=.git-fixture`. Для более подробного пояснения см. `man git`.

Пример:

```
$ cd fixture/git-repo
$ git --git-dir=.git-fixture log
```


## TODO

Постпроцессить lineRanges: `[[2,2],[3,3]]` -> `[[2,3]]` на основании того что строки 2 и 3 следуют непосредственно друг с другом.