# hermione-lifecycle-commands

Плагин для [hermione](https://github.com/gemini-testing/hermione), с командами-обертками, позволяющими ограничить выполнение оборачиваемых команд только в определенных режимах или фазах выполнения тестов.

Плагин разработан как вспомогательная часть решения проблемы авторизации при снятии дампов. Основной частью является еще один плагин - [`hermione-auth-commands`](../hermione-auth-commands), который предоставляет команды авторизации/логаута для Паспорта. При этом данный плагин может свободно использоваться самостоятельно. Для удобства оба плагина объединены в еще одном - [`hermione-auth-on-record-commands`](../hermione-auth-on-record-commands), специализирующемся на авторизации только при снятии дампов.

### Установка

```bash
$ npm install @yandex-int/hermione-lifecycle-commands --registry=http://npm.yandex-team.ru
```

### Конфигурация

Необходимо подключить плагин в конфиге `hermione`:

```js
module.exports = {
    // ...

    plugins: {
        '@yandex-int/hermione-lifecycle-commands': {
            enabled: true,
        }
    },
    // ...
};
```

Все опции можно установить в конфиге, передать опциями командной строки или передать в переменной окружения:
```bash
hermione --lifecycle-commands-enabled=false
hermione_lifecycle_commands_enabled=false hermione
```

## Команды

#### `onRecord(callback)`

Вызывает `callback` в случае выполнения тестов в режимах снятия эталонов - `write`(`save`) и `create`, а также при неустановленном режиме, т.е. на реальных данных без сохранения эталонов.

`callback` - функция без параметров, допускается асинхронная. Результат игнорируется.

##### Пример:

```javascript
it('should show some example', function () {
    return this.browser
        .onRecord(() => this.browser.auth("login")) // `auth` - команда из пакета hermione-auth-commands
        // do some tests
});
```

#### `onPlay(callback)`

Вызывает `callback` только в случае выполнения тестов в режиме `read`(`play`).

`callback` - функция без параметров, допускается асинхронная. Результат игнорируется.

#### `onTeardown(callback)`

Служит для регистрации шагов, которые будут выполнены после `afterEach` ближайшего родительского сьюта (с помощью команды [**teardown**](#teardown)).
Позволяет избавиться от необходимости оборачивать каждый тест в `describe` со своим `after`, в случае необходимости восстановления исходного состояния теста.

`callback` - функция без параметров, допускается асинхронная. Результат игнорируется.

#### `teardown()`

Выполняет ранее зарегистрированные с помощью [**onTeardown**](#onteardowncallback) коллбеки. Выполнение коллбеков происходит в порядке, обратном порядку их регистрации. В случае возникновения ошибки в одном из коллбеков, оставшиеся не будут вызваны, но будут удалены из стека.

Данная команда неявно регистрируется в `afterEach` родительского сьюта выполняемого теста, и будет выполнятся после уже существующих `afterEach` у родительского сьюта. При необходимости более раннего вызова, команду можно вызвать вручную в нужном месте иерархии сьютов:

```javascript
afterEach(async function () {
    await this.browser.teardown();
})
```
