# Castle

Утилита для запуска проверок в sandbox:
- hermione
- gemini
- blockstat
- palmsync validate
- memory leaks [TODO](https://st.yandex-team.ru/FEI-11009)
- pulse
- unit

Объем тестов в наше время достиг такого значения, что запускать их на ноутбуке разработчика очень долго, а порой совсем невозможно. Castle позволяет использовать существующую в sandbox инфраструктуру тестирования для запуска необходимых тестов.

## Установка и использование

```bash
npm i @yandex-int/castle --registry https://npm.yandex-team.ru
npx castle --help
npx castle run hermione --platform desktop
```
В корне проекта должен быть файл [конфигурации проекта](https://github.yandex-team.ru/search-interfaces/infratest/tree/master/packages/project-config). По ключу `paths` нужно указать путь до конфигурации castle.

Шаблон файла `.yproject` приведен в `example.yproject`.

Шаблон файла конфигурации с подробным описанием приведен в `example.castle.conf.js`.

## Принцип работы

Последний коммит из рабочей копии отправляется в github|arcanum. Для этого коммита запускается сборка, которая создает нужное окружение и порождает все заказанные тесты.

## Возможности
Отличия от сборки, которая запускается в рамках PR:
* не запускаются лишние типы проверок
* не происходит автоматический rebase - всегда тестируется то, что закоммитили
* можно задать список файлов и --grep
* можно ограничить список браузеров для тестирования
* можно запустить определенный набор тестов для проверки стабильности теста (погонятор)

## Вопросы и ответы

### Можно ли обойтись без сборки совсем и запускать только тесты?
Вопрос требует исследования: https://st.yandex-team.ru/FEI-11095

Запуск тестов в sandbox всегда выполняется на сборке, в которой статика раздается сторонними сервисами. На текущий момент неизвестно, будут ли стабильны и быстры запуски со статикой, раздаваемой templar'ом.

## Troubleshooting

1. Если возникают проблемы с git lfs, попробуйте рекомендации из [статьи](https://wiki.yandex-team.ru/search-interfaces/git-lfs/#grabliizvestnyeproblemy)
