# Старый клиент

## Использование

```js
const API = require('@yandex-int/testpalm-api');
const api = new API();

// массив тест-кейсов
const testcases = await api.getTestCases('my-project');
```

## Параметры запроса

Запросы, возвращающие список объектов, могут принимать дополнительные параметры:

* `skip` - количество пропущенных от начала объектов
* `limit` - максимальное количество возвращаемых объектов; лимит, равный `API.unlimited`, снимает ограничение на
количество возвращаемых объектов
* `includeFields` - список полей, которые нужно возвращать

Пример:
```js
const API = require('@yandex-int/testpalm-api');
const api = new API();

// массив объектов вида {id: 'id'}
const testcases = await api.getTestCases('my-project', {limit: API.unlimited, includeFields: ['id']});
```

## Параметры соединения

Параметры соединения могут быть заданы как аргумент конструктора класса `API`. В этом случае они будут использованы
для всех последующих вызовов API c помощью экземпляра созданного класса.

Пример:
```js
const API = require('@yandex-int/testpalm-api');

const api = new API({
    timeout: 5000,
    headers: {'Authorization': `OAuth ${TESTPALM_API_TOKEN}`}
});
```

Также, большинство методов класса `API` позволяет передавать особые параметры соединения для текущего вызова.
Эти параметры будут иметь более высокий приоритет над теми, которые были указаны при инициализации класса `API`.

Пример:
```js
api.getTestCases('my-project', {}, {timeout: 10000});
```

### Список параметров соединения

* `concurrency` - количество одновременно выполняемых запросов для операций множественного
добавления, обновления или удаления. По умолчанию равно `20`.
* `timeout` - максимально допустимое время выполнения запроса (в миллисекундах). По умолчанию равно `30000`.
* `retries` - максимальное количество повторных вызовов для запросов завершившихся с ошибками.
По умолчанию равно `5`.
* `protocol` - версия протокола (`http:`, `https:`). По умолчанию `https:`
* `hostname` - имя хоста. По умолчанию `testpalm.yandex-team.ru`.
* `headers` - заголовки запроса.
* `dry` - режим тестового запуска. Если значение данного параметра выставлено в `true`,
то, все запросы которые выполняют модификацию данных в сервисе testpalm, выполнены не будут. Вместо
них будут выведены соответствующие сообщения в консоль.
* `retryPostMethod` - ретраить POST-запросы. По умолчанию `true`.
* `retryPatchMethod` - ретраить PATCH-запросы. По умолчанию `true`.
* `apiPath` - путь до API на `hostname`.
* `apiVersion` - для работы с новым NodeJS API необходимо указать версию `2`. По умолчанию используется "старое" API (https://testpalm.yandex-team.ru/apidocs).
* `retryInvalidJson` –  реатрить не валидный JSON. По умолчанию `false`.
* `attemptsToRetryInvalidJson` – Кол-во попыток ретраев не валидного JSON. По умолчанию `4`.
* `delayForRetryInvalidJson` – Задержка между попытками получить валидный JSON. По умолчанию `15000` ms (15 секунд).

## Методы

##### `getProject`

Возвращает информацию о проекте.

Параметры:

* `project` - идентификатор проекта
* `connectionParams` - параметры соединения (необязательный параметр)

Пример:

```js
api.getProject('my-test-proj-123');
```

##### `addProject`

Добавляет новый проект.

Параметры:

* `content` - объект проекта
* `connectionParams` - параметры соединения (необязательный параметр)

Пример:

```js
api.addProject({
    id: 'my-test-proj-123',
    title: 'my test proj 123',
    organizationId: 'demo3'
});
```

##### `updateProject`

Обновляет существующий проект.

Параметры:

* `projectId` - идентификатор проекта
* `content` - объект проекта
* `connectionParams` - параметры соединения (необязательный параметр)

Пример:

```js
api.updateProject('my-test-proj-123', {
    id: 'my-test-proj-123',
    title: 'my test proj 123 [Closed]',
    organizationId: 'demo3'
});
```

##### `cloneProject`

Клонирует существующий проект.

Параметры:

* `projectId` - идентификатор проекта
* `newProjectId` - идентификатор создаваемого проекта
* `params` - параметры клонирования (необязательный параметр)
* `connectionParams` - параметры соединения (необязательный параметр)

Пример:

```js
api.cloneProject('my-test-proj-123', 'my-cloned-proj-123', {
    title: 'my test proj 123 (clone)',
    cloneTestcases: true,
    cloneTestRuns: false,
    cloneVersions: true,
};
```

##### `getTestCases`

Возвращает список тест-кейсов для указанного проекта.

Параметры:

* `projectId` - идентификатор проекта
* `queryParams` - [параметры запроса](#Параметры-запроса) (необязательный параметр)
* `connectionParams` - параметры соединения (необязательный параметр)

##### `previewTestCases`

Возвращает список тест-кейсов для указанного проекта в компактном формате. Возвращает поля `id`, `name`, `attributes`.
Не использует поле `includeFields` из параметров запроса.

Параметры:

* `projectId` - идентификатор проекта
* `queryParams` - [параметры запроса](#Параметры-запроса) (необязательный параметр)
* `connectionParams` - параметры соединения (необязательный параметр)

##### `updateDefinition`

Обновляет существующий `definition` для указанного проекта.

Параметры:

* `projectId` - идентификатор проекта
* `content` - объект `definition`
* `connectionParams` - параметры соединения (необязательный параметр)

##### `getDefinitions`

Возвращает список определений для указанного проекта.

Параметры:

* `projectId` - идентификатор проекта
* `queryParams` - [параметры запроса](#Параметры-запроса) (необязательный параметр)
* `connectionParams` - параметры соединения (необязательный параметр)

##### `getProfile`

Возвращает информацию о текущем профиле.

Параметры:

* `connectionParams` - параметры соединения (необязательный параметр)

##### `addTestCase`

Добавляет новый тест-кейс для указанного проекта.

Параметры:

* `projectId` - идентификатор проекта
* `content` - объект тест-кейса
* `connectionParams` - параметры соединения (необязательный параметр)

##### `getTestCase`

Получает единственный тест-кейс для заданного проекта.

Параметры:

* `projectId` - идентификатор проекта
* `testCaseId` - идентификатор тест-кейса
* `queryParams` - [параметры запроса](#Параметры-запроса) (необязательный параметр)
* `connectionParams` - параметры соединения (необязательный параметр)

##### `updateTestCase`

Обновляет существующий тест-кейс для указанного проекта.

Параметры:

* `projectId` - идентификатор проекта
* `content` - объект тест-кейса
* `connectionParams` - параметры соединения (необязательный параметр)

##### `deleteTestCase`

Удаляет существующий тест-кейс из указанного проекта.

Параметры:

* `projectId` - идентификатор проекта
* `content` - объект тест-кейса
* `connectionParams` - параметры соединения (необязательный параметр)

##### `bulkPushTestCases`

Добавляет новые или обновляет существующие тест-кейсы для указанного проекта.

Параметры:

* `projectId` - идентификатор проекта
* `testCases` - массив объектов тест-кейсов
* `connectionParams` - параметры соединения (необязательный параметр)

`connectionParams.chunkSize` параметр, определяющий сколько тест-кейсов будет выгружено за 1 запрос.
Значение по умолчанию: 200.

##### `bulkDeleteTestCases`

Удаляет тест-кейсы из указанного проекта.

Параметры:

* `projectId` - идентификатор проекта
* `testCases` - массив объектов тест-кейсов

##### `bulkDeleteTestCasesByIds`

Метод доступен только в новом (NodeJS) API TestPalm.

Удаляет тест-кейсы из указанного проекта.

Параметры:

* `projectId` - идентификатор проекта
* `testCases` - массив объектов тест-кейсов
* `connectionParams` - параметры соединения. Должна быть указана нужная версия API (`{apiVersion: 2}`)

##### `addTestCaseComment`

Отправляет комментарий для тест-кейса в тест-ране.

Параметры:

* `projectId` - идентификатор проекта
* `testRunId` - идентификатор тест-рана
* `testCaseId` - uuid тест-кейса
* `content` - описание комментария (поле `text` обязательно)
* `connectionParams` - параметры соединения (необязательный параметр)

##### `skipTestCase`

Устанавливает статус `skipped` для тест-кейса в тест-ране.

Параметры:

* `projectId` - идентификатор проекта
* `testRunId` - идентификатор тест-рана
* `testCaseId` - uuid тест-кейса
* `connectionParams` - параметры соединения (необязательный параметр)

##### `getTestSuite`

Возвращает информацию об указанном тест-сьюте.

Параметры:

* `projectId` - идентификатор проекта
* `testSuiteId` - идентификатор тест-сьюта
* `connectionParams` - параметры соединения (необязательный параметр)

##### `addTestRun`

Создаёт тест-ран для указанного проекта.

Параметры:

* `projectId` - идентификатор проекта
* `content` - объект тест-рана
* `connectionParams` - параметры соединения (необязательный параметр)

##### `addTestRunEx`

Метод для создания тест-ранов на основе переданного тест-рана.

В отличии от оригинального метода:

* Всегда возвращает массив созданных тест-ранов;
* Если переданы дополнительные окружения, то возвращает все созданные тест-раны;
* В TestPalm созданные тест-раны (при указании дополнительных окружений) будут считаться одним запуском, что даёт возможность пользоваться балк-раннерами.

Параметры:

* `projectId` - идентификатор проекта
* `content` - объект тест-рана
* `connectionParams` - параметры соединения (необязательный параметр)

Объект тест-рана полностью повторяет таковой в методе `addTestRun`.

##### `addTestRunWithImport`

Создаёт тест-ран для указанного проекта (импортирует тест-кейсы из проекта по переданному id).

Параметры:

* `projectId` - идентификатор проекта
* `content` - объект тест-рана
* `connectionParams` - параметры соединения (необязательный параметр)

Подробнее про создание тест-ранов в документации к [testpalm](https://wiki.yandex-team.ru/testpalm/testpalmdoc/run/).

Пример:

```js
api.addTestRunWithImport('my-test-proj-123', {
    title: 'My test run title',
    testGroups: [
        {
            testCases: [
                { testCase: { id: 13 }, "status": "CREATED" },
                { testCase: { id: 9 }, "status": "CREATED" },
                { testCase: { id: 10 }, "status": "CREATED" }
            ]
        }
    ]
});
```

##### `bulkAddTestRuns`

Массовое создание тест-ранов.

Параметры:

* `projectId` - идентификатор проекта
* `content` - массив объектов с описанием тест-ранов
* `connectionParams` - параметры соединения (необязательный параметр)

##### `updateTestRun`

Обновляет тест-ран для указанного проекта.

Параметры:

* `projectId` - идентификатор проекта
* `content` - объект тест-рана
* `connectionParams` - параметры соединения (необязательный параметр)

##### `deleteTestRun`

Удаляет тест-ран в указанном проекте.

Параметры:

* `projectId` - идентификатор проекта
* `content` - объект тест-рана
* `connectionParams` - параметры соединения (необязательный параметр)

##### `getTestRun`

Возвращает тест-ран по его идентификатору в указанном проекте.

* `projectId` - идентификатор проекта
* `testRunId` - идентификатор тест-рана
* `connectionParams` - параметры соединения (необязательный параметр)

##### `getTestRuns`

Возвращает список тест-ранов для указанного проекта.

Параметры:

* `projectId` - идентификатор проекта
* `queryParams` - [параметры запроса](#Параметры-запроса) (необязательный параметр)
* `connectionParams` - параметры соединения (необязательный параметр)

##### `skipTestRun`

Скипает указанный тест-ран.

Параметры:

* `projectId` - идентификатор проекта
* `testRunId` - идентификатор тест-рана
* `connectionParams` - параметры соединения (необязательный параметр)

##### `bulkSkipTestRuns`

Скипает набор тест-ранов.

Параметры:

* `projectId` - идентификатор проекта
* `testRunIds` - массив идентификаторов тест-ранов

##### `skipAllTestRuns`

Скипает все тест-раны для указанного проекта.

Параметры:

* `projectId` - идентификатор проекта

##### `addVersion`

Создаёт версию в указанном проекте.

Параметры:

* `projectId` - идентификатор проекта
* `content` - объект версии
* `connectionParams` - параметры соединения (необязательный параметр)

Подробнее про создание версий в документации к [testpalm](https://wiki.yandex-team.ru/testpalm/testpalmdoc/version/).

Пример:

```js
api.addVersion('my-test-proj-123', {
    id: 'my_version_id'
    title: 'My version title'
});
```
