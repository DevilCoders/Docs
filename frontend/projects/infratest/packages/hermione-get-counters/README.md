# hermione-get-counters

Плагин для [hermione], который обеспечивает возможность проверять счетчики и/или метрики в сервисах.
Подробнее почитать о плагинах можно в [документации][hermione-plugins].

## Установка

```bash
$ npm install @yandex-int/hermione-get-counters --registry=http://npm.yandex-team.ru
```

## Подключение

Подключение плагина делается через конфиг [hermione]. В примере конфига для всех параметров указаны значения по
умолчанию; если значения не нужно поменять для сервиса, то опции указывать не нужно.
Для templar-runner и kotik нужны разные конфигурации, т.к. по-разному запускается процесс [MetricsFetcher](https://a.yandex-team.ru/arc/trunk/arcadia/frontend/projects/infratest/packages/archon-metrics-fetcher).  

### Для templar-runner

```js
module.exports = {
    // ...

    plugins: {
        '@yandex-int/hermione-get-counters': {
            // Секция для описания логов, используемых для проверок счетчиков и метрик.
            logs: {
                // Секция для описания серверных логов (логов показа, blockstat, baobab).
                blockstat: {
                    // Необходим ли данный лог для проверок счетчиков и/или метрик
                    needed: true,
                    // Cписок названий файлов с blockstat и baobab логами, за которыми следит плагин.
                    // В именах файлов "{port}" заменяется на порт report-renderer'а.
                    fileNames: ['current-report-renderer_blockstat-{port}'],
                    // Имя поля, в которое нужно поместить blockstat/baobab для запроса к демону метрик.
                    daemonRequestName: 'blockstat'
                },
                // Секция для описания клиентских логов (redir).
                redir: {
                    // Необходим ли данный лог для проверок счетчиков и/или метрик
                    needed: true,
                    // Список названий файлов с redir-логами, за которыми следит плагин.
                    // В именах файлов "{port}" заменяется на порт clickdaemon'а.
                    fileNames: ['redir-{port}.log'],
                    // Имя поля, в которое нужно поместить redir для запроса к демону метрик.
                    daemonRequestName: 'redir'
                },
                reqans: {
                    // Необходим ли данный лог для проверок счетчиков и/или метрик
                    needed: false,
                    // Имя поля, в которое нужно поместить reqans для запроса к демону метрик.
                    // Например, для СЕРП это reqans, а для Картинок - imgreqans.
                    daemonRequestName: 'reqans'
                }
            },

            // Список обязательных для записи в клиентском (redir) логе параметров.
            // Отсутствие этих параметров свидетельствует о невалидности записи, и данная запись не включается в пул сработавших счётчиков.
            clientCounterRequiredFields: ['path', 'vars'],

            // Таймаут на запрос получения сработавших счетчиков из команды браузера к воркеру плагина в мс.
            getCountersTimeout: 5000,

            // Включить проверки метрик.
            enableGetMetrics: false,

            // Список логов, которые необходимы для расчета метрик сервиса.
            // blockstat: лог серверных счетчиков показа (baobab тоже обозначается как blockstat)
            // redir: лог клиентских счетчиков
            // reqans: логи конкретного запроса (и его ответа)
            metricsdaemonRequiredLogs: ['blockstat', 'redir', 'reqans'],

            // Таймаут на запрос получения рассчитанных метрик из команды браузера к воркеру плагина в мс.
            getMetricsTimeout: 20000,

            // Включить создание архива с запросом в демон метрик и логами демона метрик при несовпадении посчитанных метрик с ожидаемыми.
            // Этот архив нужен для отладки проблем на стороне разработчиков демона метрик и самих метрик.
            // Путь к архиву будет указан в тексте ошибки.
            prepareLogs: false,

            // Включить запись данных о выполненных в тестах проверках метрик.
            // Нужно для сбора статистики о проверках.
            // Заметно замедляет прогон.
            checkedMetricsEnable: false,

            // Путь к директории (относительно CWD), в которой необходимо создать отчет о выполненных проверках метрик.
            // В директории будет создан файл metrics.tsv с записями о проверках.
            checkedMetricsPath: 'hermione-report',

            // Добавлять дополнительную информацию об ошибке в метаинформацию отчета.
            addErrorDetails: false,

            // Перевести воркер плагина в режим отладки.
            inspect: false,

            // Порт для подключения отладчиком.
            inspectPort: 100600
        }
    },

    // ...
};
```

Также у плагина есть технические параметры, которые **не нужно** задавать при подключении в конфиге [hermione].
Они используются для настройки взаимодействия плагина с компонентами, которые требуются для его работы, но запускаются отдельно:

- `port` Порт, на котором поднимается плагин. По умолчанию вычисляется автоматически.
- `rendererPort` Порт, на котором поднят report-renderer.
- `rendererLogDir` Директория с логами report-renderer'а.
- `clickdaemonPort` Порт, на котором поднят clickdaemon.
- `clickdaemonLogDir` Директория с логами clickdaemon'а.
- `metricsdaemonPort` Порт, на котором поднят calc-metrics-daemon.
- `metricsdaemonLogDir` Директория с логами calc-metrics-daemon'а.

### Для kotik

```js
module.exports = {
    // ...

    plugins: {
        '@yandex-int/hermione-get-counters': {
            // Таймаут на запрос получения сработавших счетчиков из команды браузера к воркеру плагина в мс.
            getCountersTimeout: 5000,

            // Таймаут на запрос получения рассчитанных метрик из команды браузера к воркеру плагина в мс.
            getMetricsTimeout: 20000,

            // Добавлять дополнительную информацию об ошибке в метаинформацию отчета.
            addErrorDetails: false
        }
    },

    // ...
};
```

Плагин hermione-get-counters работает в связке с [MetricsFetcher](https://a.yandex-team.ru/arc/trunk/arcadia/frontend/projects/infratest/packages/archon-metrics-fetcher/README.md).
Необходимо его сконфигурировать отдельно.

Также у плагина есть технические параметры, которые **не нужно** задавать при подключении в конфиге [hermione].
Они используются для настройки взаимодействия плагина с archon компонентом `metrics-fetcher`:

* `metricsFetcherPort` Порт, на котором поднят MetricsFetcher.
* `metricsFetcherCheckedMetricsEnable` Включить запись данных о выполненных в тестах проверках метрик. 
  Нужно для сбора статистики о проверках. Заметно замедляет прогон.
* `metricsFetcherCheckedMetricsPath` Путь к директории (относительно CWD), в которой необходимо создать отчет о выполненных проверках метрик.
  В директории будет создан файл metrics.tsv с записями о проверках.

## Использование

Подключение плагина делает доступными команды для получения и проверки счетчиков.
Указание опции `enableGetMetrics: true` также делает доступными команды для получения и проверки метрик.

### Проверки счетчиков

#### getCounters(reqId)

Получение счетчиков по `reqId`.
Возвращаемое значение:

```
{
    client: [], // массив объектов со сработавшими клиентскими счетчиками; если не найдено - пустой
    server: {} // полная запись серверного счетчика в виде объекта; если не найдено - undefined
}
```

#### getAllCounters()

Получение счетчиков для всех запросов текущего запуска теста (то есть по текущему `testRunId`).
Возвращаемое значение:

```
{
    client: [], // массив объектов со сработавшими клиентскими счетчиками; если не найдено - пустой
    server: [] // массив объектов с записями о сработавших серверных счетчиках; если не найдено - пустой
}
```

#### assertCounters(reqId, {retryDelay, timeout}, validator)

Проверка соответствия счетчиков, сработавших для указанного `reqId`, критериям, заданным функцией `validator`.
Поскольку счетчики могут пополняться с течением времени, эта проверка реализована через поллинг с интервалом `retryDelay` и таймаутом `timeout`.

⚠️ Подбирайте значения для опций `retryDelay`, `timeout` с осторожностью, учитывая таймаут на выполнение всего теста.

### Проверки метрик

#### getMetrics(metrics)

Получение рассчитанных демоном значений метрик с учетом доехавших на данный момент логов.
Возвращаемое значение:

```
{ // Объект с именами метрик в качестве ключей и рассчитанными значениями в качестве значений
    "images.total_request_count": 1
}
```

#### checkMetrics(expectedMetrics, {initialDelay, retryDelay, timeout})

Проверка соответствия рассчитанных метрик ожидаемым значениям `expectedMetrics`.
Поскольку счетчики могут пополняться с течением времени, эта проверка реализована через поллинг с начальной задержкой `initialDelay`, интервалом `retryDelay` и таймаутом `timeout`.

⚠️ Подбирайте значения для опций `initialDelay`, `retryDelay`, `timeout` с осторожностью, учитывая таймаут на выполнение всего теста.

## Отладка

### Вывод ошибок парсинга счетчиков

Переменная окружения `DEBUG=metrics-fetcher*` включает вывод в консоль ошибок парсинга счетчиков, которые по умолчанию не выводятся.

### Добавление сработавших счетчиков в метаинформацию теста

Необходимо при настройке плагина указать `addErrorDetails: true` и убедиться, что в плагине `html-reporter` включена
опция `saveErrorDetails` (см. подробнее в [описании](https://github.com/gemini-testing/html-reporter/blob/master/README.md#usage) плагина).

### Получение запроса на расчет метрик и логов расчета при несовпадении метрик

Данная возможность включается при помощи переменной среды окружения `hermione_get_counters_prepare_logs=true`.
Путь к созданному архиву со всеми необходимыми для дебага данными будет указан в ошибке расхождения метрик.

## Как это работает

У плагина есть два режима: проверка только счетчиков (`enableGetMetrics: false`) и проверка счетчиков и метрик (`enableGetMetrics: true`).

Для работы проверок счетчиков плагин при старте начинает чтение логов [клиентских][counters-client] и [серверных][counters-server] счетчиков.

Для работы проверок метрик необходимо указать логи, которые нужны для расчета метрик сервиса, в опции `metricsdaemonRequiredLogs`
(по умолчанию это `blockstat`, `redir`, `reqans`).
Если для расчета метрик требуется `reqans` лог, то нужно настроить девсервер так, чтобы он получал в ответе источника данных `reqans` для данного запроса,
сохранял его в дампах, а также патчил его при чтении и отправлял его плагину через `ipbus`.

Все обнаруженные записи плагин немедленно складывает в свое внутреннее хранилище, причем для каждого типа записей есть отдельное хранилище в памяти.

Запуск команд для получения или проверки счетчиков собирает данные из хранилища записей для клиентских и серверных счетчиков,
после чего либо возвращает их, либо проверяет на соответствие ожиданиям.

В случае запуска команд для получения или проверки значений метрик, плагин собирает записи из всех требуемых хранилищ записей
(это определяется опцией плагина `metricsdaemonRequiredLogs`), формирует запрос к демону метрик и выполняет его.
В зависимости от команды результат расчета возвращается или проверяется.


[hermione]: https://doc.yandex-team.ru/si-infra/hermione/hermione.html
[hermione-plugins]: https://doc.yandex-team.ru/si-infra/hermione/hermione.html#plugins
[counters-client]: https://wiki.yandex-team.ru/Data/Logs/Redir/#obshhijjformat
[counters-server]: https://github.yandex-team.ru/search-interfaces/blockstat
