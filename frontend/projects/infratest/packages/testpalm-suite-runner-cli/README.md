# @yandex-int/si.ci.testpalm-suite-runner-cli

> `testpalm-suite-runner-cli` — консольная утилита (npm-пакет, Node.js) для создания и запуска тест-ранов в TestPalm из заранее сконфигурированных тест-сьютов с возможностью их предварительной валидации и условий запуска.

## Зависимости

* Node.js 8.6+
* npm

## Исходный код

* [CLI-утилита](https://a.yandex-team.ru/arc/trunk/arcadia/frontend/projects/ci/packages/testpalm-suite-runner-cli)
* [Пакет с API](https://a.yandex-team.ru/arc/trunk/arcadia/frontend/projects/ci/packages/testpalm-suite-runner)

## Установка

```bash
# Глобально
npm install -g @yandex-int/si.ci.testpalm-suite-runner-cli --registry=https://npm.yandex-team.ru

# текущий проект devDependencies
npm install -D @yandex-int/si.ci.testpalm-suite-runner-cli --registry=https://npm.yandex-team.ru
```

## Запуск

Для работы CLI-утилиты требуется [OAuth-токен для работы с TestPalm](https://wiki.yandex-team.ru/testpalm/testpalmdoc/api/) в переменной окружения `TESTPALM_OAUTH_TOKEN`.

### Запуск после установки

```bash
TESTPALM_OAUTH_TOKEN=token

testpalm-suite-runner assessors/release.json --project-id=serp-js
```

### Запуск без установки

В этом случае %%npx%% сначала установит утилиту и все её зависимости, а потом запустит её.

```bash
NPM_CONFIG_REGISTRY=https://npm.yandex-team.ru
TESTPALM_OAUTH_TOKEN=token

npx @yandex-int/si.ci.testpalm-suite-runner-cli assessors/release.json --project-id=serp-js
```

## Команды

### Команда по умолчанию

Создаёт тест-раны в TestPalm для каждой декларации тест-сьюта в конфиге.

Пример запуска команды с минимальным набором аргументов:

```console
npx @yandex-int/si.ci.testpalm-suite-runner-cli <путь до конфига> --project-id=serp-js
```

#### `project-id`

* Обязательный аргумент
* Тип: `string`
* Пример: `--project-id=serp-js`

Идентификатор проекта в TestPalm, в котором будут создаваться тест-раны.

#### `dry-run`

* Тип: `boolean`
* Пример: `--dry-run`
* Обратный флаг: `--no-dry-run`

Когда указан этот аргумент, тест-раны будут созданы, но раннер, указанный в поле `hitman_title` у каждого тест-сьюта, к ним применяться не будет.

#### `release-flags`

* Тип: `boolean`
* Пример: `--release-flags`
* Обратный флаг: `--no-release-flags`

Когда указан этот аргумент, из основной массы тест-сьютов в конфиге будут запущены лишь те, у которых есть поле [`release_exp_flags`](#release_exp_flags) имеет значение `true`.

#### `display-output`

* Тип: `boolean`
* Пример: `--display-output`
* Обратный флаг: `--no-display-output`

Когда указан этот аргумент, утилита, по завершению работы, выведет JSON в stdout, содержащий информацию о созданных тест-ранах.

### Команда валидации конфига (`validate`)

Запускает валидацию конфига:

* Формат JSON-файла
* Существование тест-сьюта в TestPalm
* Существование окружений в TestPalm (`settings → environments`)
* Существование раннера в TestPalm (`settings → runners`)

Пример запуска команды с минимальным набором аргументов:

```console
npx @yandex-int/si.ci.testpalm-suite-runner-cli validate <путь до конфига> --project-id=serp-js
```

#### `project-id`

* Обязательный аргумент
* Тип: `string`
* Пример: `--project-id=serp-js`

Идентификатор проекта в TestPalm, для которого будет осуществляться валидация конфига.

## Конфиг

Краткое описание общей структуры конфига:

```json5
{
  // Версия конфига.
  "version": 2,
  // Декларация условий, по которым могут запускаться тест-сьюты.
  // Это поле можно не указывать, если дополнительных условий не требуется.
  "conditions": [],
  // Декларация тест-сьютов.
  "suites": []
}
```

> :book: Комментарии в JSON утилитой не поддерживаются.

### Декларация тест-сьюта

Пример конфига для тест-сьюта с минимальным набором полей:

```json5
{
  "version": 2,
  "suites": [
    {
      "suite": "5cf8d7c4bb974572f739471d",
      "browsers": ["Adr_pp_6.45"],
      "platform": "desktop",
      "beta": "https://yandex.ru/search",
      "hitman_title": "United"
    }
  ]
}
```

#### `suite`

* Обязательное поле
* Тип: `string`
* Пример: `5cf8d7c4bb974572f739471d`

Идентификатор тест-сьюта в TestPalm.

#### `browsers`

* Обязательное поле
* Тип: `string[]`
* Пример: `["Adr_pp_6.45"]`

Браузеры (окружения в TestPalm), для которых требуется запустить тест-сьют.

#### `platform`

* Обязательное поле
* Тип: `desktop | touch | pad | tv | searchapp`
* Пример: `desktop`

Платформа, для которой требуется запустить тест-сьют.

#### `beta`

* Обязательное поле
* Тип: `string`
* Пример: `https://yandex.ru/search`

Ссылка на бета-стенд, которую в дальнейшем будут использовать асессоры/толокеры.

#### `hitman_title`

* Обязательное поле
* Тип: `string`
* Пример: `United`

Идентификатор раннера в TestPalm, который будет применён к созданному тест-рану из тест-сьюта.

#### `tags`

* Тип: `string[]`
* Пример: `["release"]`

Теги, которые будут добавлены в созданные тест-раны.

#### `control`

* Тип: `string`
* Пример: `https://yandex.ru/search`

Ссылка на стабильный-стенд, которую в дальнейшем будут использовать асессоры/толокеры в том случае, если требуется удостовериться, что проблема воспроизводится не только на бета-стенде.

#### `allowEmpty`

* Тип: `boolean`
* Пример: `true`

Если во время запуска тест-сьюта окажется, что он пустой, то будет брошена соответствующая ошибка. Это поле позволяет игнорировать ошибку для тех тест-сьютов, что иногда могут быть пустыми.

> :warning: Не рекомендуется добавлять это поле тест-сьютам, если на то нет весомых причин, например, если тест-сьют состоит из одних лишь заскипов, которые могут быть или не быть. В противном случае может получиться так, что тест-сьют стал пустым из-за проблем в TestPalm и вы об этом не узнаете.

#### `release_exp_flags`

* Тип: `boolean`
* Пример: `true`

Тест-сьюты, у которых указано это поле, будут участвовать в запуске, когда указан аргумент [`release-flags`](#release-flags). Если этого поля у тест-сьюта нет, то, в случае наличия аргумента `release-flags`, такой тест-сьют запускаться не будет. При этом, если аргумент `release-flags` не указан, но поле есть у тест-сьюта, то такой тест-сьют всё равно будет запущен.

#### `testsuite_properties`

* Тип: `object`
* Пример: `{ "hitman_set_ticket_tags": "en" }`

Поле предоставляет возможность добавить или переопределить `properties`, которые были заданы в тест-сьюте.

> :book: [Список](https://wiki.yandex-team.ru/search-interfaces/infra/assessors/create-launch) доступных параметров.

### Запуски по условиям

В некоторых случаях может потребоваться запускать тот или иной тест-сьют в зависимости от каких-то условий, например, времени суток, числа предстоящих выходных и рабочих дней и т.д.

Пример конфига с запуском тест-сьютов по условию:

```json5
{
  "version": 2,
  "conditions": [
    {
      "name": "closest_long_holidays",
      // Сегодня рабочий день и впереди 3 и более выходных дней
      "condition": "isTodayWorkday && closestHolidaysCount > 2"
    }
  ],
  "suites": [
    {
      // Тест-сьют будет запущен перед длинными выходными или сегодня рабочий день
      // и текущий час больше 0, но меньше 6
      "suite": "5cf8d7c4bb974572f739471d",
      "when": "closest_long_holidays || (isTodayWorkday && currentHour > 0 && currentHour < 6)"
    },
    {
      // Тест-сьют будет запущен безусловно (при каждом запуске утилиты)
      "suite": "5ac2428b309c1a8d992e536e"
    }
  ]
}
```

Поле `conditions` содержит декларации условий, которые в дальнейшем можно будет использовать в поле `when` у тест-сьюта. Стоит рассматривать это поле, как возможность один раз написать какое-то условие и ссылаться на него в нескольких тест-сьютах. При этом условие может быть дополнено прямо в поле `when` у тест-сьюта.

* Поле `name` — идентификатор условия, которое в дальнейшем будет использоваться в поле `when` у тест-сьюта.
* Поле `condition` — выражение на JavaScript с ограниченным набором доступных переменных. При этом можно использовать ранее объявленные условия, например, `is_tuesday` (объявлено пользователем) может быть использовано в других пользовательских условиях: `{ …, "conditions": "is_tuesday && isTodayWorkday" }`.

Поле `suites` содержит декларации тест-сьютов, которые будут запускаться в зависимости от правдивости условий, которые будут указаны в поле `when`. Если выражение в поле `when` правдиво, то тест-сьют будет запущен, иначе — пропущен. Если тест-сьют должен запускаться вне зависимости от условий, то поле `when` указывать не нужно.

* Поле `when` — выражение на JavaScript, в котором могут использоваться предустановленные переменные и переменные, объявленные в массиве `conditions`.

Доступные переменные для JS-выражения:

* `currentHour` (`number`) — текущий час, UTC;
* `currentDay` (`number`) — текущий день месяца;
* `currentWeekday` (`number`) — номер текущего дня недели;
* `currentMonth` (`number`) — номер текущего месяца;
* `isLastWorkdayBeforeHolidays` (`boolean`) — `true`, если это рабочий день перед выходными по календарю РФ;
* `isTodayHoliday` (`boolean`) — `true`, если текущий день нерабочий по календарю РФ;
* `isTodayWorkday` (`boolean`) — `true`, если текущий день рабочий по календарю РФ;
* `closestHolidaysCount` (`number`) — количество ближайших нерабочих дней по календарю РФ;
* `isFlagsRelease` (`boolean`) — `true`, если это релиз флагов (скрипт запущен с флагом `--release-flags=true`).

Доступные [логические операторы](https://learn.javascript.ru/logical-operators):

* `A && B` — значение `A` равно `true` и значение `B` равно `true`
* `A || B` — значение `A` или `B` равно `true`
* `(A && B) || C` — группировка условий;

Доступные [операторы сравнения](https://learn.javascript.ru/comparison):

* `A > B` — `A` больше `B`;
* `A >= B` — `A` больше или равно `B`;
* `A < B` — `A` меньше `B`;
* `A <= B` — `A` меньше или равно `B`;
* `A === B` — `A` равно `B`;

## Возможные ошибки

В ходе работы утилиты может возникнуть ошибка. Ниже примедён перечень основных ошибок:

* `INVALID_SUITE_FORMAT` — тест-сьют записан некорректно. Необходимо проверить формат согласно документации.
* `UNKNOWN_SUITE_ENVIRONMENTS` — тест-сьют содержит окружения, которых нет в проекте в TestPalm.
* `UNKNOWN_SUITE_RUNNER` — тест-сьют содержит раннер, которого нет в проекте в TestPalm.
* `TESTPALM_PROJECT_NOT_FOUND` — проект, указанный при запуске не найден в TestPalm.
* `TESTPALM_SUITE_NOT_FOUND` — декларация тест-сьюта ссылается на несуществующий тест-сьют в проекте в TestPalm.
* `TESTPALM_TESTRUN_CREATION_ERROR` — возникла ошибка во время создания тест-рана в TestPalm. Больше деталей можно найти в описании ошибки.
