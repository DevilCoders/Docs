# @yandex-int/nots-prebuilder

Инструмент для сборки и доставки пребилдов зависимостей с нативными аддонами с помощью fat-npm-пакетов.

## Сценарий использования
Предположим во время работы над пакетом вы хотите добавить зависимость (pnpm add <pkg-name> --save-exact)…
Если у этой зависимости, либо у её зависимостей, есть нативный аддон, то его необходимо скомпилировать (см https://nodejs.org/api/addons.html#building).

Компилировать при добавлении зависимости необходимо, чтобы обеспечить герметичность пакета, который использует аддоны. Это нужно, чтобы удовлетворить условие работы в условиях автосборки в аркадии.

## Контролируемая компиляция
Мы не можем полагаться на окружение пользователя, поэтому выносим компиляцию в контролируемое нами окружение. Для этого существует @yandex-int/nots-prebuilder-remote.

## Как пользоваться?

В будущем пребилдер будет вызываться под капотом запуска команды добавления зависимости. Но в настоящее время (пока нет frontend cli фасада) необходимо вызывать пребилдер вручную: команды prepare, и apply-lockfile, apply-addons.

## Принцип работы

#### Команда `prepare`

1) Сканирует pnpm-lock.yaml на предмет зависимостей с нативными аддонами.
2) Для каждой обнаруженной зависимости с аддоном запускается сборка пребилдов под все требуемые варианты `platform` / `arch` / `target`.
3) Зависимости с аддонами вместе с появившимися пребилдами публикуются под специальными именами и версиями в npm.
4) Мета-информация о пребилдах сохраняется в проекте (способ зависит от реализации).

#### Команда `apply-lockfile`

1) Из проекта извлекается мета-информация используемых пакетов-пребилдов.
2) Локфайл обновляется таким образом, чтобы вместо оригинальных пакетов использовались пакеты с пребилдами, соответствующие опциям `platform` / `arch` / `target`.

#### Команда `apply-addons`

1) Из проекта извлекается мета-информация используемых пакетов-пребилдов.
2) В `node_modules` проекта `.node`-файлы пребилдов, соответствующие опциям `platform` / `arch` / `target`, размещаются по путям, где их ожидает обнаружить js-обвязка пакета. 

## Пример использования

```bash
# cwd – директория проекта.
# 1) Установка зависимостей без запуска post-install скиптов, нативные аддоны не будут собраны.
$ pnpm i --ignore-scripts
# 2) Сборка и публикация пребилдов (можно выполнять при наличии локфайла).
$ npx @yandex-int/nots-prebuilder prepare --platform linux --platform darwin --arch x64 --target node@14.17.0 --target node@12.13.0
# 3) Подстановка пребилдов в локфайл.
$ npx @yandex-int/nots-prebuilder apply-lockfile
# 4) Скачивание пребилдов.
$ pnpm i --ignore-scripts
# 5) "Установка" пребилдов на свои места.
$ npx @yandex-int/nots-prebuilder apply-addons
```

## Куда обратиться в случае проблем/вопросов/предложений?
Пакет поддерживает контур [Базовые компоненты сборки](https://abc.yandex-team.ru/services/frontend_build_platform/). Лучше всего создавать тикет через форму [infraduty](https://forms.yandex-team.ru/surveys/17756/) — наш дежурный подхватит.


## Ограничения

1) Поддерживается только pnpm (реализация для npm возможна).
2) Пока нельзя собирать пакеты, не включающие в себя исходники.
3) "Очистка мусора" пока не учитывает мета-информацию. Её можно удалять, но тогда потребуется выполнять `prepare`.
