# Palmsync Serp Validators

Плагин для [@yandex-int/palmsync](https://github.yandex-team.ru/search-interfaces/infratest/tree/master/packages/palmsync) с СЕРП-специфичной валидацией тестовых сценариев.<br>
С возможностью конфигурировать работу валидации через `.palmsync.conf.js`.

# Подключение

1. Убедиться, что в проекте установлен `@yandex-int/palmsync >= 11.2.0`.
2. Установить плагин `npm install -D @yandex-int/palmsync-serp-validators`.
3. Включить плагин в настройках `.palmsync.conf.js` и настроить правила валидации:

```js
// .palmsync.conf.js

module.exports = {
    //... some palmsync configurations

    plugins: {
        validate: {
            "@yandex-int/palmsync-serp-validators": {
                enabled: true
                rules: [
                    {
                        type: 'forbid',
                        fields: ['feature', 'type'],
                        message: 'some text',
                        options: {
                            matchers: ['должен', 'фича']
                        }
                    },
                    {
                        type: 'forbid',
                        fields: ['feature', 'type'],
                        message: 'some text',
                        options: {
                            matchers: ['проверка']
                        }
                    },
                    {
                        type: 'no-includes',
                        fields: ['feature', 'type'],
                        message: 'some text'
                    },
                    {
                        type: 'no-includes',
                        fields: ['title', 'do'],
                        message: 'some text'
                    },
                    {
                        type: 'no-half-action',
                        message: 'some text'
                    }
                ]
            }
        }
    }
}
```
# Правила

Плагин поддерживает 4 вида валидации:

* [forbid](#forbid)
* [match](#match)
* [no-includes](#no-includes)
* [no-half-action](#no-half-action)

> В секции конфигурации плагина `rules` можно несколько раз писать правила для одного и того же типа валидации.

> Плагин агрегирует все ошибки из каждого валидатора и каждого правила, чтобы в конце выдать все возможные несоответствия.

## Forbid

Валидатор проверяет значение указанных полей на соответствие регулярным выражениям или на отсутствие запрещенных строк. При выявлении несоответствий выводится замечание.

### Пример правила

```js
{
    type: 'forbid',
    fields: ['feature', 'type'],
    message: 'Поле содержит запрещенное слово $matcher. Текущее значение поля $value.',
    options: {
        matchers: ['должен', 'фича', /какое-то регулярное выражение/]
    }
}
```

### Описание полей правила

#### type

* Обязательное
* Тип поля: `string`

Тип валидатора, для которого написано правило, в данном случае это "**forbid**".

#### fields

* Обязательное
* Тип поля: `Array<string>`

Список полей, которые необходимо проверять. [Cписок полей](#список-полей-тест-кейса).

#### options.matchers

* Обязательное
* Тип поля: `Array<string | RegExp>`

Список проверок, каждая из которых будет отдельно применена к каждому указанному полю.<br>
Проверки могут быть в виде строки или регулярного выражения.<br>
Поддерживается проверка с единственным значением и со множеством значений.

#### message

* Обязательное
* Тип поля: `string`

Шаблон замечания, которое будет показано пользователю при наличии ошибки.
Поддерживается интерполяция шаблона, доступные переменные:

* **field** — текущее поле.
* **value** — текущее значение поля.
* **matcher** — текущая проверка.
* **options.matchers** — список проверок.

## Match

Валидатор проверяет значение указанных полей на не соответствие регулярным выражениям или на наличие обязательных строк. При выявлении несоответствий выводится замечание.

### Пример правила

```js
{
    type: 'match',
    fields: ['feature', 'type'],
    message: 'В поле отсутствует обязательное слово $matcher. Текущее значение поля $value.',
    options: {
        matchers: ['какое-то слово', /какое-то регулярное выражение/]
    }
}
```

### Описание полей правила

#### type

* Обязательное
* Тип поля: `string`

Тип валидатора, для которого написано правило, в данном случае это "**match**".

#### fields

* Обязательное
* Тип поля: `Array<string>`

Список полей, которые необходимо проверять. [Cписок полей](#список-полей-тест-кейса).

#### options.matchers

* Обязательное
* Тип поля: `Array<string | RegExp>`

Список проверок, каждая из которых будет отдельно применена к каждому указанному полю.<br>
Проверки могут быть в виде строки или регулярного выражения.<br>
Поддерживается проверка с единственным значением и со множеством значений.

#### message

* Обязательное
* Тип поля: `string`

Шаблон замечания, которое будет показано пользователю при наличии ошибки.
Поддерживается интерполяция шаблона, доступные переменные:

* **field** — текущее поле.
* **value** — текущее значение поля.
* **matcher** — текущая проверка.
* **options.matchers** — список проверок.

## No-Includes

Валидатор проверяет, что указанные поля не являются частью друг друга.

### Пример правила

```js
{
    type: 'match',
    fields: ['feature', 'type'],
    message: 'Текст поля является частью пол "$next.field" ($next.value). Текущее значение "$current.value"'
}
```

### Описание полей правила

#### type

* Обязательное
* Тип поля: `string`

Тип валидатора, для которого написано правило, в данном случае это "**no-includes**".

#### fields

* Обязательное
* Тип поля: `Array<string>`

Список полей, которые необходимо проверять. [Cписок полей](#список-полей-тест-кейса).

#### message

* Обязательное
* Тип поля: `string`

Шаблон замечания, которое будет показано пользователю при наличии ошибки.
Поддерживается интерполяция шаблона, доступные переменные:

* **current.field** — текущее поле.
* **current.value** — текущее значение поля.
* **next.field** — поле в котором ищем вхождение текущего поля.
* **next.value** — значение поля в котором ищем вхождение текущего поля.


## No-Half-Action

Валидатор проверяет, что шаги тест-кейса не имеют висячих шагов `do`.
Висячий шаг `do` — это шаг, у которого отсутствует пара из ассерт шага (`assert`, `screenshot`).
Если тест-кейс содержит тег `no_assessors`, то допускаются в качестве пары служебные ассерты (`tech`).

### Пример правила

```js
{
    type: 'match',
    fields: ['feature', 'type'],
    message: 'Текст поля является частью поля "$next.field" ($next.value). Текущее значение "$current.value"'
}
```

### Описание полей правила

#### type

* Обязательное
* Тип поля: `string`

Тип валидатора, для которого написано правило, в данном случае это "**no-half-action**".

#### message

* Обязательное
* Тип поля: `string`

Шаблон замечания, которое будет показано пользователю при наличии ошибки.
Поддерживается интерполяция шаблона, доступные переменные:

* **value** — значение висячего шага `do`.


## Список полей тест-кейса

Доступные поля тест-кейса:
* **fullTitle** — полное название тест-кейса.
* **title** — название тест-кейса (без feature, type, experiments).
* **scenarioType** — тип сценария.
* **do** — все `do` шаги.
* **assert** — все `assert` шаги.
* **screenshot** — все `screenshot` шаги.
* **tech** — все `tech` шаги.
* **scenarioType** — тип сценария.

Плюс остальные основные поля тест-кейса.
Полный список доступен [тут](https://github.yandex-team.ru/search-interfaces/infratest/blob/master/packages/palmsync/lib/config/common-scheme.js#L5)
