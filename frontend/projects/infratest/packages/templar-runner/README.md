# templar-runner

**DEPRECATED: templar устарел, используйте [kotik](https://github.yandex-team.ru/search-interfaces/infratest/tree/master/packages/kotik).**

Плагин для [gemini](https://github.com/gemini-testing/gemini) и [hermione](https://github.com/gemini-testing/hermione/), предоставляющий возможность запускать тесты на [templar](https://github.yandex-team.ru/search-interfaces/infratest/tree/master/packages/templar).

## Установка

```bash
$ npm install @yandex-int/templar-runner --registry http://npm.yandex-team.ru
```

## Конфигурация

* **enabled** (optional) `Boolean` – включение/выключение плагина; по умолчанию плагин включен
* **suiteId** (optional) `String` – имя параметра в урлах тестов, предоствляющего id сьюта; `templar` будет использовать этот id для сохранения уникальных кэшей репорта для каждого теста
* **port** (optional) `Number` – порт для запуска `templar`-а; если не передан, то будет автоматически найден свободный
* **cacheMode** (optional) `String` – схема работы с кэшами репорта (если опция не указана, то запуск будет осуществляться на живых данных):
  * `read` – запуск тестов на сохраненных данных от репортах
  * `write` – запуск тестов с сохранением данных от репорта
  * `create` – запуск тестов с сохранением данных от репорта только для тех тестов, для которых кэша ещё нет<br>

  Опцию можно указывать не в конфиге, а через `CLI` при запуске тестов (опции `CLI` имеют больший приоритет, чем конфиг):

  * `--play` – `read`
  * `--save` – `write`
  * `--create` – `create`

* **cachePath** (optional) `String` – путь до файловых кэшей репорта
* **cacheAliases** (optional) `Object` – описание браузеров, которые при запуске тестов будут использовать сохраненные кэши репорта указанного другого браузера, например, запись
  ```js
  {
      ie10: 'ie11'
  }
  ```
  означает, что при запуске тестов в браузере `ie10` будут использоваться сохраненные кэши репорта для браузера `ie11`. Кроме того, в данном случае тесты для браузера `ie10` не будут выполняться при запуске тестов в режиме `write` (`--save`) или `create` (`--create`)
* **useCacheMap** (optional) `Boolean` – включение/выключение генерации файла с картой кешей. Используется для возможности хранения дампов рядом с тестом; по умолчанию генерация отключена
* **cacheMapFolder** (optional) `String` – имя папки, находящейся рядом с тестом, в которой будут храниться дампы для него; по умолчанию `test-data`
* **autoCacheClean** (optional) `Boolean` – включение/выключение автоматического удаления неиспользуемых дампов; по умолчанию чистка отключена

## Команды
* **dumps** [paths to tests] - команда для работы с дампами. Опции:
 * `--update` - опция для обновления дампов в тестах, у которых были изменены названия

### Переопределение конфигурации

Все параметры могут быть переопределены с помощью опций командной строки или переменных среды окружения. Порядок применения:

* значения из опций командной строки. Переопределяют значения из переменных среды окружения и конфигурационного файла
* значения из переменных среды окружения. Переопределяют только значения из конфигурационного файла
* значения из конфигурационного файла

Для того, чтобы переопределить значение из конфига с помощью CLI опции, необходимо преобразовать полный путь к опции в `--kebab-case` и добавить префикс `--templar-runner-`. Например, чтобы переопределить схему работы с кэшами репорта, нужно указать опцию так: `--templar-runner-cache-mode=write`.

А для того, чтобы переопределить значение с помощью переменной среды окружения, необходимо преобразовать полный путь к опции в `snake_case` и добавить префикс `templar_runner_`. Например: `templar_runner_cache_mode=write`.

## Переменные среды окружения

* `TEMPLAR_SILENT` - отключение вывода логов `templar`-а в `stderr`. `stderr` `templar`-а доступен при подписке на событие `templarStart` инструментов `gemini`/`hermione`.
* `DEBUG` – включение debug режима.
Пример: `DEBUG=templar-runner:*` – будет выводить в консоль все debug логи.
* `TEMPLAR_RUNNER_CACHE_CLEANER_CHECK_ALL` - Способ очистки неиспользуемых дампов (только при `cacheMode` `write` и `create`). При значении `true` выполняет проверку всех дампов в проекте на актуальность, в противном случае - только дампы, относящиеся к запущенным разработчиком тестам. В случае, если опция `useCacheMap` неактивна, данная переменная игнорируется и производится проверка актуальности всех дампов.

## Api

При загрузке плагин добавляет свойство `templarRunner` в инструмент (`gemini.templarRunner`, `hermione.templarRunner`), которое доступно другим плагинам и является API для взаимодействия с текущим плагином.

### templarRunner.events
`templarRunner` является инстансом `EventEmitter`-а. В свойстве `events` хранится набор событий, на которые можно подписаться.

* `events.TEMPLAR_START` – триггерится при запуске `templar`-а. Триггерится с одним аргументом – сабпроцессом, в котором запущен `templar`. Ждёт возвращаемые Promise перед продолжением.
* `events.TEMPLAR_BEFORE_END` - триггерится до остановки `templar`-а. Ждёт возвращаемые Promise перед завершением.
* `events.FAIL` - триггерится при возникновении любой ошибки, возникшей в процессе работы плагина (ошибка поднятия туннеля, ошибка `report-renderer`-а и т.д.). Триггерится с одним аргументом - собственно возникшей ошибкой.

### templarRunner.setEnv(name, value)
Позволяет добавить переменные среды окружения, которые будут доступны внутри процессов `templar`'а и `report-renderer`'а.

## Переопределение методов browser

`templar-runner` заменяет метод `url`, добавляя при запросах два query-параметра. В параметр с именем, переданным в `suiteId`, будет добавлено значение для обеспечения уникальности кешей репорта. Оно повторяется при повторном запуске теста.

В параметр `testRunId` будет добавлено значение, уникальное для каждого запуска теста. Все url, открытые в рамках одного запуска теста, будут иметь одинаковый `testRunId`. В тесте получить доступ к `testRunId` можно следующим образом:
```
this.browser.executionContext['testRunId']
```

## Использование

### gemini

Подключить плагин в конфигурационном файле:

```js
// ...

module.exports = {
    // ...

    system: {
        plugins: {
            '@yandex-int/templar-runner/gemini': {
                // конфигурация
            }
        }
    }
};
```

### hermione

Подключить плагин в конфигурационном файле:

```js
// ...

module.exports = {
    // ...

    plugins: {
        '@yandex-int/templar-runner/hermione': {
            // конфигурация
        }
    }
};
```

#### hermione.skipOnRealData([reason])

`templar-runner` добавляет хелпер `hermione.skipOnRealData()`, который может быть использован для отключения тестов при запуске на реальных данных:

```js
hermione.skipOnRealData('т.к. колдунщик, допустим, отключен');
it('this test should be skipped on real data', function() {
    // ...
});
```

Тест будет выключен при запуске на реальных данных (без опций `--save`, `--play` или `--create`) с соответствующим комментарием.
