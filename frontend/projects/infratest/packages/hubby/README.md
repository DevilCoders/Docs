# Hubby

Утилита для управления квотой браузеров в Sandbox для запуска Hermione.

## Установка

```bash
npm i @yandex-int/hubby --registry=https://npm.yandex-team.ru
```

## Использование через CLI

### start

Запуск квоты с браузерами и получение:
 * url, где доступна квота,
 * sandbox task id, для последующей остановки,
 * списка имен переменных окружения для каждого браузера.

Параметры запуска:

 * `hubbyConfigPath` — путь до проектного конфига для hubby. Здесь указываются браузеры, которые уже переведены на грид в Sandbox-е, а так же параметры квоты (ttl, time-to-start, etc).
 * `hermioneConfigPath` — путь до конфига гермионы. Нужен чтобы сопоставить браузеры в гриде с названиеями браузеров на проекте. Это необходимо знать, чтобы переопределять путь до endpoint-a для каждого браузера.
 * `hubbyOutputPath` — Название файла в рабочей директории, в который `hubby` запишет результаты работы. По умолчанию - `hubby.out.json`.
 * `buildId` — необязательный параметр, уникальный числовой идентификатор прогона. Используется для отслеживания потребления Sandbox-ресурсов.


Пример:
```
$ hubby start --hubbyConfigPath path/to/hubby-example.conf.js --hermioneConfigPath path/to/hermione.conf.js
```

Результат:
```
{"url":"http://[2a02:6b8:0:161b:225:90ff:771b:9102]:23388/wd/hub","taskId":"598271699,"envNames":["hermione_browsers_linux_firefox_grid_url"]}
```

То есть квота будет доступна по адресу `http://[2a02:6b8:0:161b:225:90ff:771b:9102]:23388/wd/hub`, а запущена она в задаче `https://sandbox.yandex-team.ru/task/598271699`.


### stop

Останов квоты по sandbox task id.

Пример:
```
$ hubby stop 123456
```

### run

Запусить квоту, затем запустить произвольную команду запуска Hermione и после остановить квоту.

Пример:
```
$ hubby run --hubbyConfigPath path/to/hubby-example.conf.js --hermioneConfigPath path/to/hermione.conf.js --hermioneRunCommand 'hermione run ... --play' --buildId 123456
```

Параметры запуска:

 * `hubbyConfigPath` — путь до проектного конфига для hubby. Здесь указываются браузеры, которые уже переведены на грид в Sandbox-е, а так же параметры квоты (ttl, time-to-start, etc).
 * `hermioneConfigPath` — путь до конфига гермионы. Нужен чтобы сопоставить браузеры в гриде с названиеями браузеров на проекте. Это необходимо знать, чтобы переопределять путь до endpoint-a для каждого браузера.
 * `hermioneRunCommand` — команда запуска Hermione в том виде, как она использовалась бы без Hubby.
 * `buildId` — необязательный параметр, уникальный числовой идентификатор прогона. Используется для отслеживания потребления Sandbox-ресурсов.

## Конфигурация

Конфигурационный файл содержит поля:

 * `sandboxOwner: string` — группа-овнер в Sandbox из под которой будет запущена квота. Используется для разграничения использования железных ресурсов sandbox-агентов.
 * `quotaTtl?: number` — время жизни квоты в секундах. По умолчанию: 3600. Используется для ограничения времени жизни квоты. Рекомендуется подобрать минимальное время когда тесты точно успеют пройти и квота не будет проставить, если штатного завершения на произойдёт по каким-либо причинам.
 * `tags?: Array<string>` — массив строк содержащих теги, которые будут добавлены к GGR-задаче в Sandbox-е. Используется для разметки и упрощения поиска однотипных квот (по проектам, по окружениям и тд).
 * `startTimeout?: number` — время ожидания старта квоты в секундах. По умолчанию: 300.
 * `platform?: string` — sandbox resource id, содержащий конфигурации платформ. Используется только для отладки новых конфигураций, в остальных случаях не нужен.
 * `ggr?: string` — sandbox resource id, содержащий GGR.
 * `sbr?: string` — sandbox resource id, содержащий sandbox-router.
 * `browsers: Array<Browser>` — список браузеров, которые необходимо поднять в квоте. Формат описания браузеров задекларирован ниже.

 ```typescript
type Browser = {
    name: string;    // имя браузера в формате desiredCapabilities из конфига Hermione
    version: string; // версия браузера в формате desiredCapabilities из конфига Hermione
    total?: number;   // кол-во сессий. По умолчанию 1
    image?: string;   // url до docker-образа или url до QEMU-образа (в случае виндовых браузеров). По умолчанию образ определяется на стороне GGR. Это поле нужно использовать только для тестирования кастомных образов.
}
```

## Отладка

Для отладки можно установить значения переменной окружения `DEBUG=hubby`.
