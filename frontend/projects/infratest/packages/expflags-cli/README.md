# expflags-cli

> `expflags-cli` — консольная утилита (npm-пакет, Node.js) для синхронизации декларации флагов с хранилищем флагов в AB.

## Содержание

* [Гайды по миграции на новые версии](./docs/migrations.md)

## Зависимости

* Node.js 8.6+
* npm

## Установка

```bash
# Глобально
npm install -g @yandex-int/si.ci.expflags-cli --registry=https://npm.yandex-team.ru

# текущий проект devDependencies
npm install -D @yandex-int/si.ci.expflags-cli --registry=https://npm.yandex-team.ru
```

## Запуск

Для запуска команд потребуются переменные окружения, содержащие токены для авторизации в API сервисов. Необходимые токены смотрите в описании к команде, используя команду `expflags-cli [command] --help`.

> :book: Читайте [FAQ](#faq) для того, чтобы узнать где получить токены.

### Запуск после установки

```bash
AB_EXPERIMENTS_TOKEN=token

expflags-cli upload ./expflags/*.json --dry-run
```

### Запуск без установки

В этом случае %%npx%% сначала установит утилиту и все её зависимости, а потом запустит её.

```bash
NPM_CONFIG_REGISTRY=https://npm.yandex-team.ru
TESTPALM_OAUTH_TOKEN=token

npx @yandex-int/si.ci.expflags-cli upload ./expflags/*.json --dry-run
```

## Команды

### Команда `upload`. Создание флагов

Команда запускает создание флагов, отсутствующих в хранилище флагов в AB. Подробнее о формате [деклараций флагов](#Декларация-флага).

#### Примеры

Пример запуска команды для создания флагов, имеющих JSON-декларации в директории `./expflags`:

```console
expflags-cli upload ./expflags/*.json --dry-run
```

Пример запуска команды для создания флагов, декларации которых хранятся в одном файле:

```console
expflags-cli upload ./service/expflags.flags.json --dry-run
```

#### Аргументы

* `--creator` — Логин автора, создаваемых флагов.
* `--common-flag` — Шаблон создаваемых флагов. Поддерживает все поля [деклараций флагов](#Декларация-флага).
* `--options` — Опции запуска команды.
  * `--options.validation.requireVteam` — Требовать наличия команды в поле `vteam`.
  * `--options.validation.validateValuesType` — Включает валидацию значений в поле `values`.
* `--dry-run` — Выполнять работу, но ничего не создавать в сервисах смежников (AB).

### Команда `update`. Обновление флагов

Команда запускает обновление флагов, данные о которых устарели в хранилище флагов в AB.

#### Примеры

Пример запуска команды для обновления флагов, имеющих JSON-декларации в директории `./expflags`:

```console
expflags-cli update ./expflags/*.json --dry-run
```

Пример запуска команды для обновления флагов, декларации которых хранятся в одном файле:

```console
expflags-cli update ./service/expflags.flags.json --dry-run
```

#### Аргументы

* `--creator` — Логин автора, создаваемых флагов.
* `--common-flag` — Шаблон создаваемых флагов. Поддерживает все поля [деклараций флагов](#Декларация-флага).
* `--options` — Опции запуска команды.
  * `--options.validation.requireVteam` — Требовать наличия команды в поле `vteam`.
  * `--options.validation.validateValuesType` — Включает валидацию значений в поле `values`.
* `--dry-run` — Выполнять работу, но ничего не создавать в сервисах смежников (AB).

### Команда `mark-as-removed-from-code`. Удаление флагов

Команда помечает переданные ей флаги как «удалённые из кода». Эту команду предлагается использовать взамен действия «депрекейт». Такой подход позволяет страховаться от переиспользования старых флагов. Флаг, помеченный «удалённым из кода» будет автоматически задепрекейчен автоматикой внутри AB, когда сработает их эвристика.

#### Примеры

Пример запуска команды, помечающий флаги с именами `flag_name_0` и `flag_name_1` (только для хэндлера `WEB`) «удалёнными из кода» для репозитория `web4`.

```console
expflags-cli mark-as-removed-from-code flag_name_0 flag_name_1 --source web4 --handler WEB --dry-run
```

#### Аргументы

* `--source` — Источник флага. Требуется для определения источника истины (место первичной декларации). Как правило, название репозитория.
* `--handler` — Хэндлер флага. Указывается, так как флаг с одним именем может присутствовать сразу в нескольких хэндлерах.
* `--dry-run` — Выполнять работу, но ничего не создавать в сервисах смежников (AB).

### Команда `search`. Поиск флагов

Команда поиска флагов в хранилище флагов сервиса AB.

#### Примеры

Пример запуска команды, выполняющей поиск флагов с тегом `expflags-cli` для репозитория `web4`. Результатом будет массив соответствующих флагов с полями `name` и `handler`.

```console
expflags-cli search --source web4 --tag expflags-cli --field name --field handler
```

#### Аргументы

* `--source` — Источник флага. Требуется для определения источника истины (место первичной декларации). Как правило, название репозитория.
* `--tag` — Тег флага. Позволяет получить флаги с конкретными значениями поля `tags`.
* `--field` — Определение списка полей, которые будут составлять результирующие флаги. Остальные поля будут удаляться.

### Команда `search-local`. Поиск флагов на FS

Команда поиска флагов на FS.

#### Примеры

Пример запуска команды, выполняющей поиск флагов с именем `flag_name` и хэндлером `WEB`. Результатом будет массив соответствующих флагов с полями `name` и `handler`.

```console
expflags-cli '*.json' --name flag_name --handler WEB --field name --field handler
```

#### Аргументы

* `--name` — Именя флагов для поиска, разделённые запятой.
* `--handler` — Хэндлер искомых флагов.
* `--exclude-manual` — Исключить `manual` флаги из результатов поиска.
* `--field` — Определение списка полей, которые будут составлять результирующие флаги. Остальные поля будут удаляться.

## Декларация флага

В качестве имени флага выступает название файла (случай [хранения деклараций в директории](#Декларация-флагов-в-директории)), либо ключ объекта (случай [хранения в файле множества деклараций](#Декларация-флагов-в-одном-файле)).

Ниже указана декларация флага с пояснениями по полям. Все указанные ниже поля участвуют при формировании флага, отправляемого в хранилище флагов в AB. Дополнительные поля, необходимые сервису **не участвуют в синхронизации**, но и не запрещены, чтобы иметь возможность хранить дополнительную информацию.

```json
{
  // Используется, как заголовок флага
  "description": "<description>",
  // Идентифицирует ответственных людей за флаг.
  "manager": "<value>" | ["<value>"],
  // Используется, как хэндлер флага.
  // Если указать несколько хэндлеров, то число созданных флагов будет равно их числу. Один флаг — один хэндлер.
  "handlers": ["handler"],
  // Используется, как источник флага.
  // Как правило, указывается через аргумент `--common-flag` и соответствует имени репозитория, в котором хранится декларация, либо имя сервиса (уникальное).
  "source": "<value>",
  // Используется, как тип значения флага.
  "validation_type": "<value>",
  // Необязательный. Идентифицирует сервисы, к которым относится флаг. Например, `images` или `video`.
  "service": "<value>" | ["<value>"],
  // Необязательный. Идентифицирует команды, к которым относится флаг. Например, `REPORT` или `YABS_PROXY`.
  "component": "<value>" | ["<value>"],
  // Необязательный, если не включена опция `requireVteam`. Идентифицируем команду, отвечающую за флаг.
  "vteam": "<value>" | ["<value>"],
  // Показывает, является ли функциональность под флагом зависимой от данных, которые так же включаются флагом.
  "dataDependent": true | false,
  // Необязательный. Показывает, что флаг системный и не участвует в экспериментах. По умолчанию `false`.
  "system": true | false,
  // Необязательный. Индикатор того, что флаг будет участвовать в валидации, но создания или обновления флага не будет.
  "manual": true | false
}
```

## Хранение деклараций флагов

Инструмент поддерживает два подхода к хранению флагов.

### Декларация флагов в директории

Один файл — один флаг.

Файловая структура:

```console
dir/
├── flag-0.json
└── flag-1.json
```

Содержимое флагов:

```json
{
  "key": <value>
}
```

### Декларация флагов в одном файле

Один файл — несколько флагов. Имя файла должно заканчиваться на `.flags.json`.

Содержимое флагов:

```json
{
  "flag-0": {
    "key": <value>
  },
  "flag-1": {
    "key": <value>
  }
}
```

## Валидаторы

* `FlagSourceRule` — проверяет, что флаг в сервисе имеет такой же источник в поле `source`, как и флаг в хранилище флагов в AB.
* `ManualFlagExistRule` — проверяет, что флаг, помеченный маркером `manual`, существует в хранилище флагов в AB.
* `RemoteFlagCreatorConflictRule` — проверяет, что флаг в сервисе может быть обновлён из под текущего робота.
* `ValuesTypeRule` — проверяет, что значения в поле `values` соответствуют типу, указанному в поле `validation_type`.
* `VTeamRule` — проверяет, что поле `vteam` имеет значение.

## FAQ

### Где получить токены?

* [OAuth-токен для работы с AB](https://wiki.yandex-team.ru/serp/experiments/adminka/api/) — `AB_EXPERIMENTS_TOKEN`

### Как определяется, что флаг устарел и его пора обновить?

Определение происходит при сравнении локальной декларации флага и его результата его создания в хранилище флагов в AB на основе заранее определённого набора полей. Если значение полей или их число расходится, то такой флаг считается устаревшим.

> 📖 Если значением поля является строка, то сравнение происходит после выполнения операции `.trim()`  над ней.

Список полей, участвующих в сравнении:

```js
name
title
owners
components
services
handler
source
validation_type
is_system
is_used_in_frontend
is_deprecated
backend_teams
```
