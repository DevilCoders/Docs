# Testid CLI

> `testid-cli` — консольная утилита (npm-пакет, Node.js) для работы с выборками (testid, экспериментами).

## Зависимости

* Node.js 8.6+
* npm

## Исходный код

* [CLI-утилита](https://a.yandex-team.ru/arc/trunk/arcadia/frontend/projects/ci/packages/testid-cli)

## Установка

```bash
# Глобально
npm install -g @yandex-int/si.ci.testid-cli --registry=https://npm.yandex-team.ru

# текущий проект devDependencies
npm install -D @yandex-int/si.ci.testid-cli --registry=https://npm.yandex-team.ru
```

## Запуск

Для запуска команд потребуются переменные окружения, содержащие токены для авторизации в API сервисов. Необходимые токены смотрите в описании к команде, используя команду `testid [command] --help`.

> :book: Читайте [FAQ](#faq) для того, чтобы узнать где получить токены.

### Запуск после установки

```bash
testid [command] [arguments]
```

### Запуск без установки

В этом случае `npx` сначала установит утилиту и все её зависимости, а потом запустит её.

```bash
NPM_CONFIG_REGISTRY=https://npm.yandex-team.ru

npx @yandex-int/si.ci.testid-cli [command] [arguments]
```

## Команды

### Команда `create-from-testpalm`. Создание выборок для флагов в TestPalm-проекте

Команда получает список всех флагов, указанных в параметрах тест-кейсов в TestPalm и создаёт для каждого из них выборку в AB, если ранее она не была заведена.

Выборки создаются только для тех флагов, что есть в хранилище флагов, причём сразу для всех хэндлеров.

#### Примеры

Пример запуска команды для проекта `serp-js`:

```console
testid create-from-testpalm serp-js robot-login
```

#### Поддерживаемые параметры в тест-кейсах

* `params.blenderViewType`
* `params.channelId`
* `params.exp_flags`
* `params.faf`
* `params.flags`
* `params.foreverdata`
* `params.kids`
* `params.patch`
* `params.promo`
* `params.rearr`
* `params.redev`
* `params.srcparams`
* `params.uri`
* `params.user_time`
* `params.wiz`
* `params.yandex_login`

#### Аргументы

* `--dry` — выполняет работу, но не создаёт выборки в AB.
* `--config` — путь до конфига, содержащего информацию о выборках. Подробнее в секции [«Конфиг»](#конфиг).
* `--set-condition-to-foreverdata` — добавляет в выборку условие срабатывания дампов от foreverdata. Дам будет применяться только при наличии в запросе текста `foreverdata`.
  * При создании выборок в них добавляется следующее условие `CONDITION: cgi.text eq 'foreverdata'`.
* `--handler` — позволяет задать хэндлер, с которым будет создаваться выборка. Может принимать путь, например, `MAIN.HELATH`.
* `--context` — позволяет задать контекст, с которым будет создаваться выборка. По умолчанию контекст `MAIN`.

#### Конфиг

```json5
{
  "mute": [
    // Замьютить флаг foreverdata, имеющий значение 1000
    {
      "name": "foreverdata",
      "value": "1000",
      "reason": "Создано несколько выборок"
    },
    // Замьютить флаг templar_enable_presearch
    {
      "name": "templar_enable_presearch",
      "reason": "Внутренний флаг",
      "issue": "ISSUE-1000"
    }
  ]
}
```

Массив `mute` содержит названия флагов, которые нужно пропускать, если они свалятся с ошибкой.

* Поле `name` является обязательным, содержит название флага.
* Поле `reason` и `issue` — не обязательны, содержат описание причины мьюта и ссылку на тикет соответственно.
* Поле `value` не обязательно, но если указано, то будут замьючены ошибки только для флагов с комбинацией `name` и `value`, остальные флаги будут пропущены. Если поле `value` не указано, будут замьючены все флаги с названием `name` вне зависимости от их значения.

### Команда `create`. Создание выборки из файла конфигурации

Команда создаёт выборку, используя конфигурацию из файла.

#### Примеры

Пример запуска команды для создания выборки из конфига, находящегося в файле `./config.json:

```console
testid create --config ./config.json
```

Пример запуска команды с обновлением выборки, если она уже существует:

```console
testid create --config ./config.json --update-if-changed
```

Пример запуска команды с ожиданием доступности выборки в продакшене на 0%:

```console
testid create --config ./config.json --await-deploy
```

Пример запуска команды с созданием ссылки на залипание для:

```console
testid create --config ./config.json --create-sticky-url
```

#### Аргументы

##### Общие

* `--config` — путь до конфигурационного файла.
* `--update-if-changed` — обновить выборку, если она уже существовала ранее.
* `--dry` —  выполнять работу, но ничего не создавать в сервисах смежников (AB, Ecoo).
* `--tag` — [тег](https://ab.yandex-team.ru/tag), который будет установлен выборке.

##### Ожидание деплоя

* `--await-deploy` —  дождаться выкладки выборки в продакшен.
* `--await-deploy-timeout` — время ожидания выкладки в продакшен в секундах.
* `--await-deploy-interval` — время в секундах между проверками статуса тест-кейса.

##### Ссылка на залипание

* `--create-sticky-url` — создавать ссылку на залипание для выборки.
* `--sticky-url-redirect-to` — URL, на который будет перенаправлять ссылка на залипание при успешном залипании.
* `--sticky-url-ttl` — время жизни куки в днях, устанавливаемой при залипании.
* `--sticky-url-ts` — время жизни ссылки на залипание в днях.
* `--sticky-url-append-testids` — выборки, которые будут подмешиваться в ссылку на залипание.

#### Конфиг

Конфиг построен на основе требований [AB API](https://wiki.yandex-team.ru/serp/experiments/adminka/api/). Подробнее про формат выборок можно почитать [тут](https://wiki.yandex-team.ru/serp/experiments/adminka/testidsformat/).

```json5
{
  // Заголовок создаваемой выборки.
  "title": "string",
  // Тип выборки.
  "type": "ABT",
  // Номер очереди. См. https://ab.yandex-team.ru/task/create
  "queue_id": 1,
  // Параметры, с которыми будет создана выборка.
  "params": [
    // Пример параметров для подмены источника шаблонов
    {
      "HANDLER": "REPORT",
      "CONTEXT": {
        "MAIN": {
          "WEB": {
            "srcrwr": {
              "TEMPLATES": "<fqdn беты>:<timeout на запрос>"
            }
          }
        }
      },
      // Должно совпадать со значением поля replace_token
      "TESTID": ["__PLACE_TEST_ID_HERE__"]
    }
  ],
  // Плейсхолдер, взамен которого будет вставлен идентификатор созданной выборки
  "replace_token": "__PLACE_TEST_ID_HERE__"
}
```

### Команда `search`. Поиск выборок по условиям

Команда выполняет поиск выборок по условиям.

#### Примеры

Пример запуска команды для поиска всех активных выборок:

```console
testid search
```

Пример запуска команды для поиска выборок по автору и тегу:

```console
testid search --author robot-serp-bot --tag crowdtest_exp_flag
```

Пример запуска команды для поиска выборок по автору и заголовку:

```console
testid search--author robot-serp-bot --title .+-pull-1010
```

#### Аргументы

* `--author` — поиск экспериментов по автору.
* `--status` — поиск экспериментов по статусу.
  * :book: Статус `active` не гарантирует, что выборка доступна в продакшене.
* `--tag` — поиск экспериментов по тегу.
* `--title` — регулярное выражение, используемое для поиска экспериментов по заголовку.
  * :book: Поиск выполняется после выгрузки экспериментов из AB API. Поиск может быть медленным, если не указывать дополнительные условия для фильтрации.
* `--json` — вывод результатов поиска в JSON-формате.

### Команда `archive`. Архивация выборок

Команда архивирует переданные ей выборки.

#### Примеры

Пример запуска команды для архивации одной выборки:

```console
testid archive --id 100
```

Пример запуска команды для архивации нескольких выборок:

```console
testid archive --id 100 --id 101
```

#### Аргументы

##### Общее

* `--dry-run` — вывести операции, которые будут вызваны, но не выполнять их.

##### Архивация

* `--id` — идентификатор архивируемой выборки. Можно указать несколько раз.

## FAQ

### У меня есть флаги с хэндлером `REPORT` и их не видит инструмент. Что делать?

Флаги с хэндлером `REPORT` больше не поддерживаются, потому что этот [хэндлер считается устаревшим](https://wiki.yandex-team.ru/serp/experiments/docs/report-webvideoimg/).

Нужно клонировать эти флаги с новым хэндлером для вашего сервиса (`WEB`, `IMAGES` или `VIDEO`).

### Где получить токены?

* [OAuth-токен для работы с AB](https://wiki.yandex-team.ru/serp/experiments/adminka/api/) — `AB_EXPERIMENTS_TOKEN`
* [OAuth-токен для работы с TestPalm](https://wiki.yandex-team.ru/testpalm/testpalmdoc/api/) — `TESTPALM_OAUTH_TOKEN`
* [OAuth-токен для работы с Ecoo, подходит доменный токен, например, от Трекера](https://wiki.yandex-team.ru/tools/support/startrek/api/tokenfortracker/) — `AB_ECOO_TOKEN`

### Что нужно, чтобы создать ссылку на залипание для пулл-реквеста?

Залипание в шаблонах пулл-реквеста подразумевает наличие выборки, выложенной в продакшен, с созданной ссылкой на залипание.

Для начала нужно написать конфиг для выборки. Смотрите секцию «конфиг» для команды `create`, чтобы узнать о формате конфига подробнее.

Затем можно запускать команду:

```console
testid create --config ./config.json \
--tag crowdtest_<название проекта> \
--await-deploy \
--create-sticky-url \
--sticky-url-redirect-to "https://yandex.ru/search"
```

### У нас динамический адрес беты при каждом деплое. Как быть?

Команда создания выборок из конфига (`create`) поддерживает аргумент `--update-if-changed`, который сигнализирует инструменту о том, что нужно обновить выборку, если изменились её параметры.

### Команда `create-from-testpalm` не поддерживает нужный мне параметр в тест-кейсе. Что делать?

Есть два варианта.

* Завести тикет в [INFRADUTY](https://st.yandex-team.ru/createTicket?queue=INFRADUTY).
* Написать адаптер самому, опираясь на уже существующие файлы в директории `./lib/flags-adapters`.

### Как архивировать выборки при закрытии пулл-реквеста?

Для начала нужно определить триггер для операции, которая будет выполняться после закрытия пулл-реквеста. Затем можно выполнить несколько команд из этого инструмента:

```bash
# Найдёт все выборки, созданные для пулл-реквеста с идентификатором <pr_number>
experiments="$(testid search --status active --author robot-frontend --title .+-pull-<pr_number> | tr '\n' ' ')"

# Отправит в архив все переданные выборки
testid archive --id $experiments
```
