# Графики

Исходный код графиков (чартов) инфраструктуры поисковых интерфейсов.

Все графики доступны на [дашборде][si-stat-dashboard].

[si-stat-dashboard]: https://stat.yandex-team.ru/Dashboards/products/SearchInterfaces

## Структура дерева исходников

```
charts
├── arcadia-frontend-infra // папка для всех новых дашбордов/графиков, имеющих отношение к инфраструктуре фронтенда
│   ├── common // какой-то общий код для всех дашбордов
│   ├── <dashboard1>
│   │   ├── common // общий код для dashboard1
│   │   ├── <tab1>
│   │   │   ├── common // общий код для таба tab1
│   │   │   ├── <selector>
│   │   │   ├── <chart1>
│   │   │   ├── ...
│   │   │   └── <chartN>
│   │   ├── ...
│   │   └── <tabN>
│   ├── ...
│   └── <dashboardN>
├── <other-charts1> // папка для графиков, не имеющих отношения к инфраструктуре фронтенда
├── ...
├── <other-chartsN>
└── SERP.infratest/SERP.infraspeed/modules // устаревшие графики, будут понемногу вычищаться
```

Замечания по именованию:
- selector в большинстве случаев всегда один на таб, по-этому может называться просто как `selector`
- графиков может быть несколько и здесь можно, наверное, в вырожденном случае называть `graph` (или `chart`)
- путь к графику в репозитории должен полностью дублировать путь в https://dash.yandex-team.ru/
  - например, `arcadia-frontend-infra` -> https://dash.yandex-team.ru/navigation/p4d8vh0py7fgm

## Добавление дашборда/графика

При добавлении любого дашборда или графика, в папке с ним обязательно должен находиться файл `meta.json`, имеющий следующую структуру:
```json
{
    "type": "dashboard",
    "id": "w5hrg7dmfd48s"
}
```
Допустимые значения `type`:
* `dashboard` - дашборд
* `graph_node` — график
* `table_node` — таблица
* `metric_node` — показатель
* `ymap_node` — карта
* `control_node` — селектор
* `markdown_node` — markdown виджет
* `module` — модуль

## Исходники графика
### Классика: один файл - одна вкладка
Внутри директории с чартом кладем файлы с названием табов. Один файл - один таб в терминах ChartEditor. Названия возможных табов для разных видов чартов можно посмотреть в константе `CHART_TYPES` в файле https://a.yandex-team.ru/arc/trunk/arcadia/frontend/projects/infratest/packages/charts-sync/constants.js

### Один файл - один чарт
Второй вариант подходит для чартов, в которых не используется ничего, кроме js-файлов.
По сути это надстройка над классикой, только нужные файлы генерируются в момент синхронизации. Важное замечание: `shared.json` не генерится, т.к. в такой схеме он просто не нужен.

Для того, чтобы заработал синк такого графика:
- в его `meta.json` файле нужно добавить поле `main` с указанием пути к основному файлу;
- основной файл должен экспортить объект с полями, именованными соответствующими табами (см. вариант "Классика" выше). Должны присутствовать все поля. Если какой-то tab вам не нужен, то это поле может содержать `{}` или `''`;
- все вызовы tab-специфичных функций (например, `ChartEditor.getLoadedData()` работает только на вкладке `js`, на остальных будет выдавать ошибку) должны быть завернуты в какие-нибудь функции/геттеры, т.к. код основного файла выгружается на каждый таб.

В процессе синхронизации в папке с таким чартом появится папка `build`, в которой будут лежать сгенерированные файлы табов.

### TypeScript
Скрипт синхронизации умеет компилить js из ts перед синком, так что можно смело писать графики на ts.

## Синхронизация чартов

Запустить в корне репозитория:

```shell
$ npm run upload # посинкать все графики
$ npm run upload -- SERP.infratest/mqfr-daily # посинкать только mqfr-daily
$ npm run upload -- SERP.infratest/mqfr-daily --to cody0/mqfr-daily # посинкать SERP.infratest/mqfr-daily в cody0/mqfr-daily
$ npm run upload -- arcadia-frontend-infra/cycle-time --to Users/cody0/cycle-time # посинкать все графики из arcadia-frontend-infra/cycle-time в папку cody0/cycle-time
```

В процессе синхронизации все require, кроме внешних модулей, инлайнятся прямо в код таба графика.
Внешние модули указываются в константе `EXTERNAL_MODULES` в файле https://a.yandex-team.ru/arc/trunk/arcadia/frontend/projects/infratest/packages/charts-sync/constants.js

## Debug
Для синхронизации графика в процессе разработки
1. Создаем новый график в своем нэймспэйсе (например, `cody0/mqfr-daily`). Можно клонировать существующий
2. Вносим изменения в оригинал (например, в `SERP.infratest/mqfr-daily`)
3. Синхронизируем изменения командой `$ npm run upload -- SERP.infratest/mqfr-daily --to Users/cody0/mqfr-daily`
4. Открываем editor с графиком в браузере, обновляем страницу, жмем Предпросмотр. Например, https://charts.yandex-team.ru/editor/cody0/mqfr-daily

## TODO

* выгрузка чартов
* CLI опцию для отключения публикации (`is_release=false`)
* перед загрузкой проверять, что есть изменения
* полные ссылки на исходный в GH в баннер
* скачивание графиков
