# SI/CI scripts

SI/CI — __Search Interfaces Continuous Integration__

Содержимое этой директории включает в себя всевозможные скрипты, используемые в CI и MQ, и публикуется как sandbox-ресурс [SANDBOX_CI_SCRIPTS].
Публикация ресурса происходит в двух случаях:
 - В ревью-реквесте ресурс публикуется с атрибутом `released: testing`.  В таком случае ресурс предназначен для тестирования: им не будут пользоваться продовые  задачи, но можно подключить его в задачу вручную. См. [тестирование]. 
 - При пуше в `master` ресурс публикуется с атрибутом `released: stable`. После публикации в `stable` ресурс начинает по умолчанию использоваться в сборках и MQ.

## Сборка ресурса
Сборка ресурса происходит через `pnpm`. Коротко суть сборки можно описать так:
1. Собирается сервис `@yandex-int/si.ci.scripts` и его зависимости, которые есть в монорепо.
1. Делается селективная копия монорепозитория, в которую входят только затронутые пакеты. В копию входят сторы `pnpm`.
1. В верхний слой копии выводятся симлинки `services/ci-scripts/{bash,script}`.
1. Результат архивируется в `tar` и публикуется.

## Места использования ресурса

TODO

## Разработка

См. [разработка в infratest].

## Тестирование

При создании ревью-реквеста запустится джоба "Публикация скриптов", в которой создастся ресурс `SANDBOX_CI_SCRIPTS`. 
В этот ресурс попадут папки `bash` и `script` с установленными зависимостями. 

Все зависимости, которые находятся в монорепо, должны линковаться напрямую. 
То есть, например, если сделать изменения в пакете `@yandex-int/si.ci.arc-checkout` и отправить ревью-реквест с ними, то изменения должны попасть в ресурс `SANDBOX_CI_SCRIPTS`, который будет собран в этом ревью-реквесте.

Чтобы протестировать сделанные в ресурсе изменения, нужно в тестируемом sandbox-таске:
 1. Выставить `False` в поле `Download last build resource(scripts_last_resource)`.
 1. Указать `id` собранного в ревью-реквесте ресурса `SANDBOX_CI_SCRIPTS` в поле `CI Scripts resource (scripts_resource)`.

[разработка в infratest]: ../../README.md#разработка
[тестирование]: #тестирование
[SANDBOX_CI_SCRIPTS]: https://sandbox.yandex-team.ru/resources?type=SANDBOX_CI_SCRIPTS
