# Sandbox Hugin

[Sandbox Hugin](https://sandbox-hugin.si.yandex-team.ru) – сервис для оценки утизизации квоты Sandbox.

## Использование

Сервис имеет два кейса использования:

- оценка утилизации квоты задачами различных типов,
- оценка утилизации ресурсов хоста отдельными задачами.

### Оценка утилизации квоты задачами

На главной странице сервиса требуется указать владельцев квоты и диапазон дат, опционально можно также указать теги задач для выборки.

Результаты представлены таблицей, в которой для каждого типа задач дается оценка по времени выполнения и потреблению CPU. Оценка даётся по 80, 95 и 99 квантилям для возможности учесть частотную характеристику. По умолчанию, результаты ранжированы по величине потребляемой квоты, от большего к меньшему.

Для поиска узких мест важно понимать, [как считается квота в Sandbox](https://wiki.yandex-team.ru/sandbox/quotas/). В простом случае следует оптимизировать два показателя – потребление CPU и время выполнения (т.е. `kill_timeout`) задачи. Типовые проблемы подсвечиваются в результатах маркером ⚠️:

- **Время выполнения задач на 99 квантиле больше времени на 80 квантиле в 1.5 раза**. Множитель подобран эмпирически, но в общем случае проблема заключается либо в ненастроенном `kill_timeout` и зависающих задачах, либо в широком разбросе времени выполнения, что требует отдельной оптимизации и, возможно, настройки параметров задачи под условия запуска.
- **Потребление CPU на 99 квантиле менее 50%**. Половина ядер не задействована в задаче, требования можно безопасно снижать и по возможности запускать задачу на [мультислотах](https://wiki.yandex-team.ru/sandbox/clients/#client-tags-multislot).
- **Потребление CPU на 95 квантиле более 90%**. Требуется либо поднять требования по CPU, либо оптимизировать задачу.
- **Потребление CPU на 99 квантиле более 100%** Специальный случай – задачи, запускаемые на мультислотах. Они могут утилизировать более 100% требований если хост, на котором выполняется задача, не загружен. Следует проверить, что потребление ресурсов процессами задачи вписываются в требования.

Рекомендации по проблемам нужно валидировать, сервис ещё маленький, может ошибаться.

Для каждого типа задачи также доступен профиль нагрузки – для его просмотра нужно кликнуть на тип задачи (первый столбец). Профиль строится на основе 5-секундных отчетов, которые выгружаются в CH кластер sandboxclickhouse, но с дополнительной обработкой: для каждой минуты выполнения по всем задачам в выборке считаются свои показатели на 80, 95 и 99 перцентилях.

Для более детальной оценки нужно смотреть происходящее в отдельных задачах. Для выборки самых "долгих" задач имеет смысл покрутить фильтр "Время выполнения" и выставить значения 80-100.

### Оценка утилизации ресурсов хоста отдельными задачами

Под сглаженным профилем нагрузки есть секция, в которой отображаются ID задач с наибольшим пиковым потреблением CPU. Они кликабельны – по клику будет загружен atop из задачи и отображен в виде графиков, с раскладкой по процессам. Из удобств:

- клик на графиках задачи сортирует процессы по значениям схожих или влияющих метрик в приблизительно тот же момент времени;
- Cmd + Click на легенде скроет остальные графики;
- Cmd + Click на ID задачи откроет её Sandbox-страницу в новом табе.

Доступные метрики хоста:

- CPU: user, system, io wait. В процентах отображают относительную долю тиков CPU, потраченных в user space, kernel space, и в ожидании IO, соответственно.
- RAM: RAM, RAM page cache. Resident set size и page cache, соответственно.
- Disk IO avg: В процентах отображает среднее время, потраченное всеми sd устройствами.

По процессам метрики немного отличаются:

- CPU user / system.
- RAM RSS / VMS (virtual memory size).
- Read / write speed в KB (kilobytes) / sec.
- Threads total / running.
- Major page faults.

> По умолчанию, процессы сортируются по интегральному потреблению CPU, от большего к меньшему.
> При сортировке по метрике `CPU` процессы сортируются по сумме `CPU user` и `CPU system`.
> При сортировке по метрике `CPU iowait` и `Disk IO avg` процессы сортируются по сумме `Read` и `Write`.

Визуализатор atop также доступен для произвольной задачи по ссылке (см. ограничения):

```
https://sandbox-hugin.si.yandex-team.ru/task/{taskId}/inspect
```

## Требования и ограничения

- Группировка джоб Trendbox CI в настоящее время сильно неточная, так как по значительной части задач отсутствует статистика в `trendbox_steps_profiler` (порядка 20%).
- Оценка утилизации дается только по первой фазе выполнения задачи.
- Данные, на которых считается общая статистика по типам задач, – метрики из CH кластера sandboxclickhouse – могут быть неполными. При точечной проверке отсутствовали данные по 2-5% задач в различные дни.
- Для возможности инспекции задачи, в контейнере задачи должен быть atop, лог которого должен быть сохранён в ресурс `TASK_LOGS`. Поддерживается только одна версия – 2.4, интервал у снепшотов должен быть 10 секунд. Владелец ресурса `TASK_LOGS` должен добавить доступ на чтение роботу `robot-serp-bot`.
- Нет отдельной разметки задач, запускаемых на мультислотах.
- Не учитываются требования и утилизацию дискового пространства.
