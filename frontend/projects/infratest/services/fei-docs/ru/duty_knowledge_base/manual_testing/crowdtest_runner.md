# Crowdtest Runner

## Как понять, что асессор действительно залип?

В нашей схеме раздачи заданий асессорам у каждой ссылки на залипание есть Query-параметр `userid`, в котором указан уникальный хэш для каждого тест-кейса в раздаче.

Используя этот хэш можно посмотреть, что асессор действительно переходил по ссылке на залипание, используя сервис ecoo, который, собственно и отвечает за залипание.

```
https://ecoo.n.yandex.ru/logs/?userid=<hash>
```

Сервис отдаёт JSON, в котором написано время перехода по ссылке на залипание, устройство и множество других параметров, которые характеризуют устройство того, кто сделал переход по ссылке.

## Как понять, что асессор получил функциональность при залипании?

Для начала нужно завладеть `Yandex-UID`. Вариант «попросить асессора» не рассматривается, поэтому ищем интересующую нас ссылку на залипание и извлекаем из неё значение Query-параметра `userid`.

Получаем информацию о переходе асессора по ссылке на залипание с помощью сервиса ecoo:

```
https://ecoo.n.yandex.ru/logs/?userid=<hash>
```

Сервис отдаёт JSON. Ищем интересующий нас переход по ссылке на залипание. Можно ориентироваться по полю `timestamp`, если интересует какое-то конкретное время. Извлекаем значение поля `X-Yandex-ICookie` интересующей записи. Это и есть `uid` запроса. Дальше работаем с ним.

Переходим к сервису [Session Manager](https://sema.n.yandex-team.ru/) и делаем «быстрый поиск по yuid». В поле `yuid` нужно указать полученный `uid` запроса, добавив вначале `y`. Не забываем указать дату в поле `День`, за которую нужно получить сессию. Дату можно узнать из поля `timestamp`. Нажимаем кнопку «Поиск» и смотрим на котика. Когда поиск завершается, нажимаем на кнопку «Сохранить в мои сессии».

Откроется страница, на которой можно посмотреть метрики сессии асессора, если интересно. Нас интересует кнопка «Full {JSON}» — нажимаем. Открывается огромный JSON, в котором написано всё, что происходило в сессии пользователя.

Как правило, интересовать может:

* Получение `ReqId` для анализа запросов через [SeTrace](https://setrace.yandex-team.ru/ui/).
* Получение `FullRequest` для анализа полных запросов, которые триггерил пользователь.
  * Например, так можно узнать `SuggestReqId`.
* Получение `TestInfo`, в котором перечислены все выборки, в который участвовал пользователь.

Узнать можно многое, включая текст запросов, картинки и выдачу, которые отдавались пользователю.

## Как посмотреть логи?

Логи доступны в Yandex Deploy в [окружении](https://deploy.yandex-team.ru/stages/crowdtest_runner_stable). В окружении находятся два компонента:

1. [`client`](https://a.yandex-team.ru/arc_vcs/frontend/services/crowdtest-runner-client) — отвечает за отображение формы.
2. [`api`](https://a.yandex-team.ru/arc_vcs/frontend/services/crowdtest-runner) — отвечает за работу с данными (получение, формирование, создание). Этот компонент взаимодействует с БД и TestPalm.

Как правило, если ошибки и возникают, то их поиск нужно осуществлять для компонента `api`. Для этого достаточно перейти к логам компонента и выполнить поиск по идентификатору запроса, используя принятый в Yandex Deploy синтаксис.

Если нужны исторические логи и их нет в «быстром доступе», то Yandex Deploy предложит поискать их с помощью YQL-операции.

Пример запроса, который позволяет найти информацию по тому, что происходило с запросом, имеющий идентификатор `<request>` за 4 декабря 2020 года.

```sql
SELECT *
FROM arnold.`logs/deploy-logs/1d/2020-12-04`
WHERE
    `stage` = 'crowdtest_runner_stable' AND
    `message` LIKE "%<request>%"
ORDER BY `timestamp` ASC;
```
