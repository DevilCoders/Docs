# Проверки счётчиков и метрик. Устройство

Плагин [hermione-get-counters](https://doc.yandex-team.ru/si-infra/hermione/hermione_plaginy/hermione-get-counters.html)
реализует команды для проверки:

- серверных (`blockstat`, `baobab`) счётчиков
- клиентских (`redir`) счётчиков
- метрик качества, основанных на этих счётчиках

## Проверки счётчиков

При вызове команд проверки счётчиков из кода тестов плагин обращается к полученным из логов записям сработавших
счётчиков для данного запуска теста. Записи считываются постоянно с момента старта плагина.

Запись серверных счетчиков осуществляется `report-renderer` в логи в папке `~/.yandex-int/logs/rr`,
запись клиентских счетчиков - локально поднятым `clickdaemon` а логи в папку `~/.yandex-int/logs/clickdaemon`.

### Кликдемон

Для каждого собираемого релиза кликдемона собирается соответствующие версии кликдемона для linux и darwin, а также ресурс
с ключами кликдемона, использующимися для разделения счетчиков по топикам. Процесс [обновления версии кликдемона](https://st.yandex-team.ru/FEI-20641)
в сервисах находится в разработке.

## Проверки метрик

При вызове команд проверки метрик плагин собирает записи обо всех сработавшихся для теста счётчиках, необходимые
логи и делает запрос на расчёт метрик в демон метрик `calc_metrics_daemon`. Для неудачных запросов логгируются тела
запросов и пишутся логи самого демона метрик в папке `~/.yandex-int/logs/calc-metrics-daemon`.
Демон метрик - это упакованный в виде http-сервера код расчета метрик. Он был специально реализован для локальных проверок метрик.

На настоящий момент проверки метрик поддержаны в следующих проектах:

- web4
- images
- video

### Демон метрик

Для каждого собираемого релиза кода метрик собирается соответствующая версия демона метрик под linux и darwin.
При релизе кода метрик в продакшен запускается процесс [обновления версии демона метрик](https://st.yandex-team.ru/FEI-17442)
в сервисах. За отставанием от продакшена можно следить по [графику](https://datalens.yandex-team.ru/preview/bj7rqm4wc16g6-metrics-daemon-lags).
Также, настроено оповещение в INFRADUTY при отставании, превышающем 14 дней.
