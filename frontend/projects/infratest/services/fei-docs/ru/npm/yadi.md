# Yadi

npm всегда проверяет пакеты по [банлисту](https://yadi.yandex-team.ru/db/blacklist.json) Yadi.

Это приводит к тому, что:

1. При попытке установить забаненный пакет npm падает с ошибкой `ETARGET`. К сожалению, npm-клиенты не позволяют сделать ошибки более человекопонятными, поэтому причины ошибки `ETARGET` имеет смысл дополнительно валидировать (см. FAQ).
2. При попытке установить зависимости по локфайлу npm падает с ошибкой `410 Gone`. К сожалению, npm-клиенты игнорируют тело ответа, поэтому подробности и причины бана следует либо руками искать в банлисте, либо выполнить дополнительную проверку (см. FAQ).

Если вам нужно что-то срочно забанить, вы можете написать в чат [Безопасность фронтенда](https://t.me/+gZm7UwhIi2Y1Y2Qy).
Предварительно следует ознакомиться с [соглашением по содержимому npm.yandex-team.ru](https://clubs.at.yandex-team.ru/devtools-frontend/522).

## FAQ

### Что делать, если мне очень нужен забаненный пакет?

Если это ваша прямая зависимость, то попробуйте использовать последнюю доступную версию. Если вам нужна именно забаненная версия, то вы можете её форкнуть, починить и временно переключиться.

Если это ваша транзитивная зависимость, то можно попробовать "поднять" зависимость в манифест проекта. Это заставит npm-клиент резолвить нужную вам версию. В примере ниже `@yandex-int/express-tvm@7.0.0` зависит от `es5-ext@^0.10.0`, но `es5-ext@0.10.51` забанена. В манифесте вашего проекта нужно указать версию `es5-ext` ниже забаненной (но следует учитывать, что это будет работать пока где-то в зависимостях не потребуется `es5-ext@^0.11.0`):

```json
{
  "dependencies": {
    "es5-ext": "0.10.50",
    "@yandex-int/express-tvm": "7.0.0"
  }
}
```

Некоторые пакетные менеджеры позволяют переопределять версии транзитивных зависимостей (здесь также есть ограничение на дальнейшее обновление зависимостей):
- [npm@8.3.0](https://docs.npmjs.com/cli/v8/configuring-npm/package-json#overrides).
- [yarn](https://classic.yarnpkg.com/en/docs/selective-version-resolutions/)
- [pnpm](https://github.com/pnpm/pnpm.github.io/blob/main/docs/package_json.md#pnpmoverrides)

### Как убедиться, что конкретная версия пакета точно попала в бан?

Выполнить http-запрос вида `https://npm.yandex-team.ru/{packageName}/-/{packageNameWithoutScope}-{packageVersion}.tgz`.
Пример:

```bash
$ curl https://npm.yandex-team.ru/event-source-polyfill/-/event-source-polyfill-1.0.26.tgz
> {"error":"Package event-source-polyfill@1.0.26 is banned. Affected versions: >=1.0.26. Reason: VULNMANAGEMENT-5"}
```

### Пакета нет в бан листе, но npm отдает 410 ошибку, что делать?

npm перечитывает банлист каждые 15 минут, при этом метаданные забаненных пакетов также кешируются на 15 минут.
Следует убедиться, что после разбана прошло 30 минут и повторить попытку. При этом возможны кратковременные флапы, так как период синка банлиста не синхронизируется между подами npm.
