# FAQ

## Есть ли ограничения на размер пакета?
Максимальный размер пакета при публикации равен 50 мегабайтам.
Размер пишет в логи npm-cli при паблише:

```bash
npm notice package size:  45.3 MB
npm notice unpacked size: 45.5 MB
```

Можно заметить, что у нас в настройках стоит лимит в 70 мегабайт. Однако, при отправке пакета npm-cli кодирует тарбол в base64, из-за чего размер тела запроса возрастает приблизительно на 30%.

## Что делать, если отсутствует версия внешнего пакета?
1. Убедиться, что нужная версия пакета не находится в [карантине](https://doc.yandex-team.ru/si-infra/npm/quarantine.html).
2. Убедиться, что нужная версия пакета не попала в [бан](https://doc.yandex-team.ru/si-infra/npm/yadi.html).
3. Убедиться, что с момента публикации/карантина/разбана версии прошло 15 минут. Именно с таким интервалом мы фетчим мету и новые версии.
4. Очистить кеш npm-клиента (`npm cache clear -f`).
5. Если ничего не помогло – написать нам через [форму поддержки](https://wiki.yandex-team.ru/npm/support).

## При установке зависимостей npm падает с ошибкой 410 Gone
Вы используете забаненую версию пакета. Подробнее в [документации](https://doc.yandex-team.ru/si-infra/npm/yadi.html).

## На запросы метадаты и тарболов приходит ответ 302 со ссылкой на s3, это нормально?
Да, это нормально. Разбор метадаты на стороне сервера тратит ресурсы, а необходимости в этом нет.
Так же, как и проксирование тарболов через сервер. Поэтому verdaccio при возможности отдаёт 302 код и
предлагает клиенту самому сходить в s3 за всеми нужными данными.
Новые версии npm в логах пишут ссылку на s3 с кодом 200 – это нормально. На самом деле, они просто не показывают 302 код ответа и исходный url.

## Что делать, если `npm login` завершается с ошибкой?
Для аутентификации необходимо использовать логин со стафа и [OAuth-токен](https://oauth.yandex-team.ru/authorize?response_type=token&client_id=f8aaf2afb26446ee99a7fab5e92057a5) в качестве пароля.

## Что делать, если `npm publish` возвращается с ошибкой?
Проверьте, что:
- publish идет во внутренний репозиторий,
- во внешнем репозитории пакета с таким именем нет,
- пользователь есть в списке овнеров.

## Что делать, если `npm unpublish` возвращается с ошибкой?
Так и задумано. Все, что было опубликовано, навсегда остается в `npm`.
Неверно опубликованный пакет нужно объявить `deprecated` (команда `npm deprecate`).

## Доступ для аутстафферов
Чтобы у аутстафферов появился доступ к `npm.yandex-team.ru` (на самом деле – к MDS), нужно добавить в `.npmrc` строку с особым `user-agent`:
`user-agent=npm/6.2.0 (external user verdaccio yandex canary)`

## Завести новый скоуп
1. Чтобы завести новый скоуп, нужно опубликовать в нём пакет. Например, я хочу создать скоуп "@yandexxx-test" и опубликовать пакет с именем "dummy". В package.json пакета dummy я указываю `"name": "@yandexxx-test/dummy"` и публикую пакет.
2. Подождать 5-10 минут (столько занимает синхронизация с IDM).
3. После того, как скоуп появится в IDM, [нужно запросить роль owner-а для этого скоупа](https://doc.yandex-team.ru/si-infra/npm/idm.html#prava-na-skoupy). Подтверждением занимается команда npm (в рабочее время).
4. Если при публикации происходит ошибка – написать нам через [форму поддержки](https://wiki.yandex-team.ru/npm/support). Для экономии времени можно сразу приложить вывод команды `npm config ls` и вывод упавшей команды с `--loglevel silly`.

## Не сработала команда `npm owners add`
Специфика npm-клиента заключается в том, что он отправляет на сервер не нового овнера, а список всех овнеров. Из-за этого может возникнуть ситуация, что новый овнер был добавлен, а npm прочитал пакет из кеша (эта проблема воспроизводится и во внешнем репозитории). Рекомендуется добавлять овнеров с параметром `--cache=/tmp/npm_cache_$(date +"%s")`, таким образом заставляя npm читать из репозитория.

## Как мне самому проверить актуальную метадату?
Актуальную версию метаданных всегда можно проверить, перейдя по ссылке вида `https://npm.yandex-team.ru/{название_пакета}`.
В поле `versions` представлены существующие версии, в поле `maintainers` - список разработчиков, у которых есть доступ на запись.

## У нас есть `_not_found_` в лок-файлах, что с этим делать?
Предыдущий npm таким образом помечал внешние пакеты, которые не смог синхронизировать. Такой URL не является валидным,
но мы поддерживаем его для обратной совместимости.
Если вы заметили подобную запись в своих лок-файлах, то лучше перегенерить лок-файл автоматически, либо вручную починить эти url в них.

Пример:
```
http://npm.yandex-team.ru/_not_found/https://registry.npmjs.org/caniuse-api/-/caniuse-api-3.0.0.tgz
```
надо заменить на
```
http://npm.yandex-team.ru/caniuse-api/-/caniuse-api-3.0.0.tgz
```

## Не работает `npm deprecate`, что делать?
npm-cli не умеет работать с сообщениями на русском, напишите сообщение на английском или на транслите.

## Что делать в любой другой непонятной ситуации?
Отправьте обращение в [форму поддержки](https://wiki.yandex-team.ru/npm/support/) и предоставьте нам максимум информации для воспроизведения проблемы.
Полезными будут:

- Логи (с `--loglevel silly`)
- Логины
- Время
- Всё, что вы посчитаете важным
