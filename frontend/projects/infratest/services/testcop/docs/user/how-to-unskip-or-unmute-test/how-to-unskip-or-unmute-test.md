# Как расскипать или размьютить тест?

## Введение

Прежде чем расскипать или размьютить тест, необходимо убедиться, что тест стабилен. Чаще всего, это означает, что тест сначала нужно починить. В редких случаях можно обойтись без изменений в коде, если нестабильность теста была вызвана проблемами с внешним окружением и эти проблемы исчезли, или были решены другими службами.

## Как убедиться, что тест стабилен?

### Локально

Для начала можно запустить тест локально. Чтобы при локальном запуске ваш тест не был пропущен как заскипанный (исключен из прогона), воспользуйтесь любым из ниже указанных вариантов:

- Если вы используете *git* и планируете чинить тест, то создайте ветку с именем, в котором будет присутствовать тикет заскипа.

  *Например, ваша локальная ветка может выглядеть так: `login.SERP-98674.foo`. Тогда при запуске тестов все тесты, которые были заскипаны на тикет SERP-98674, будут запущены. Формат названия локальной ветки не имеет значения, главное – чтобы в названии фигурировала соответствующая задача из Стартрека.*

- Воспользуйтесь переменной окружения `ISSUE_KEYS`, указав в ней перед запуском теста тикет заскипа. Если вы чините сразу несколько тестов, которые были заскипаны на разные тикеты, и хотите запустить их одновременно, то, устанавливая значение переменной, перечисляйте тикеты через запятую.

  *Например, при запуске тестов с установленной переменной окружения `ISSUE_KEYS=SERP-98674,SERP-93463` запустятся, помимо остальных тестов, все тесты, отключенные по задачам SERP-98674 и SERP-93463.*

Однако у этих вариантов есть один недостаток: запускаются не только заскипанные тесты, но и все остальные тоже. Это приводит к лишнему ожиданию. Чтобы сэкономить время, можно добавить опцию гермионы `--grep` и перечислить в ней все тесты, которые были заскипаны в соответствующих тикетах. Но это долго и неудобно: можно легко ошибиться, забыть указать какой-то тест, итоговая команда получается длинной и нечитабельной:

*Например:*

`ISSUE_KEYS=SERP-98674,SERP-93463,SERP-98739 npx hermione --grep "Hotels / Одна организация в правой колонке / Блок «Похожие отели» Проверка блока похожих отелей|Hotels / Одна организация / Бейджи в офферах Внешний вид с двумя бейджами в правой колонке"`

Поэтому, если вы хотите запустить *только* заскипанные тесты:

- Используйте опцию гермионы `--unskip-only <тикет-заскипа>`. Можно перечислить сразу несколько тикетов заскипа, через запятую без пробела.

  *Например:*

  `npx hermione --unskip-only SERP-98674,SERP-93463,SERP-98739`

Данный вариант ещё хорош тем, что к запуску гермионы вы можете добавить опцию `--repeat <число повторений>` и прогнать все заскипанные тесты большое число раз за один запуск.

### В конвейере

Чтобы прогнать заскипанные тесты в конвейере, вы можете либо воспользоваться специальным инструментом [castle][castle], либо сделать пулл- или ревью-реквест в гитхаб или аркадию. В последнем случае убедитесь, что в названии вашей ветки присутствуют все необходимые тикеты заскипа.

Данный способ хорош тем, что заскипанные тесты будут запускаться не изолированно, а в рамках всеобщего запуска, то есть вместе с остальными тестами в вашем проекте. Это может оказаться важным, так как иногда нестабильность тестов бывает вызвана кросс-влиянием прогона других тестов.

Локально же ресурсов вашего компьютера может не хватить на запуск всех тестов.

*Например, в web4 – почти 30 тысяч тестов. Если попытаться запустить их все локально, то можно не дождаться окончания прогона всех тестов. И даже запуск тестов в отдельных браузерах не улучшит ситуацию: тестов все равно будет слишком много.*

## Как расскипать или размьютить тест?

Любой тест можно расскипать или размьютить вручную.

Для этого:

- откройте [главную страницу][testcop] Тесткопа;

- выберите свой проект;

- нажмите на ссылку с интересующим вас инструментом тестирования *(hermione/hermione-e2e)* в разделе *Skips pages:*

  ![скриншот: главная страница Тесткопа](https://jing.yandex-team.ru/files/robot-testcop/testcop.doc.user.how-to-unskip-or-unmute-test.testcop-main-page.png)

- вы увидите на экране список заскипов и мьютов в вашем проекте для данного инструмента:

  ![скриншот: список заскипов и мьютов](https://jing.yandex-team.ru/files/robot-testcop/testcop.doc.user.how-to-unskip-or-unmute-test.testcop-skipped-tests.png)

- используйте, при необходимости, фильтры вверху экрана, указав, например, конкретный тикет заскипа, браузер или имя теста *(не обязательно полностью),* чтобы уменьшить объем выводимой информации:

  ![скриншот: отфильтрованный список заскипов](https://jing.yandex-team.ru/files/robot-testcop/testcop.doc.user.how-to-unskip-or-unmute-test.testcop-filter-skipped-tests.png)

- выберите заскипанные (замьюченные) тесты, которые вы хотите включить, нажав напротив них кнопку **Enable**; если вы хотите включить сразу все тесты из отображаемого списка, то используйте общую кнопку **Enable** под списком;

  ![скриншот: включить заскипанные тесты](https://jing.yandex-team.ru/files/robot-testcop/testcop.doc.user.how-to-unskip-or-unmute-test.testcop-enable-tests.png)

- нажмите кнопку **Submit**;

- появится диалоговое окно со списком тестов, которые вы планируете включить;

  ![скриншот: окно с требованием подтверждения](https://jing.yandex-team.ru/files/robot-testcop/testcop.doc.user.how-to-unskip-or-unmute-test.testcop-confirm-enable-tests.png)

- убедитесь, что в списке нет лишних тестов; если вы ошиблись, то нажмите кнопку **No**, чтобы отменить процедуру включения тестов;

- если перечислены именно те тесты, которые вы и планировали включить, то нажмите кнопку **Yes**;

- дождитесь уведомления о том, что создана sandbox-задача для публикации нового скип-листа.

## Авто-расскип тестов

Для удобства разработки сервис может настроить себе авто-расскип тестов в CI при их починке.

При этом сценарий будет выглядеть следующим образом:

1. Создается PR в рамках тикета на починку сломанного теста, в PR'е данный тест автоматически исключается из заскипов
и прогоняется.
2. Разработчик убеждается в том, что тест стабилен.
3. PR с фиксом теста вливается.
4. При влитии починенный тест автоматически расскипывается, публикуется новый список с заскипанными (и замьюченными)
тестами для вашего проекта, уже без тех тестов, что вы починили.
5. При следующем запуске тестов – в конвейере или на локальной машине у разработчика – заскипанные тесты, которые были
исправлены, начнут запускаться.

Как это можно настроить:

- **Запуск заскипанных тестов в PR'ах на починку:** при запуске hermione нужно задать переменную окружения `ISSUE_KEYS`
– ключи тикетов, которые были созданы при заскипе тестов. Это можно сделать, например, получив ключи тикетов по ID
PR'a, с помощью пакета `@yandex-int/si.ci.issue-keys-cli`:
```bash
ISSUE_KEYS=$$( \
    [[ -n "$(PR_NUMBER)" ]] && \
    npx issue-keys get --arc --pr-branch=review/$(PR_NUMBER) \
)
```
- **Автоматический расскип исправленных тестов при влитии:** на этапе влития необходимо включить тесты с помощью пакета
`@yandex-int/testcop-cli`:
```bash
npx testcop-cli enable \
    --projects "<your project name>" \
    --branch "<your branch, e.g. dev>" \
    --mergeCommitTitle "$$(arc log -n 1 --format {title})"
```

[testcop]: https://testcop.si.yandex-team.ru/
[castle]: https://a.yandex-team.ru/arc/trunk/arcadia/frontend/projects/infratest/packages/castle
