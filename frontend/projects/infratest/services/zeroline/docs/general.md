## Принцип работы

Сервис получает хук с информацией об источнике. Источником может быть тикет в Трекере или задача в Sandbox. Затем парсит всё, до чего может дотянуться из источника, и матчит логи и другие ресурсы на известные проблемы. Когда проблема найдена, сервис отправляет фидбек: в тикет в трекере или табличку в кликхаусе.

Сам сервис занимается только работой с исходными входными ресурсами. Для разбора найденного и применения правил используется [Coroner](../../packages/coroner).

### HTTP API v1

#### `POST /api/v1/investigate`
Принимает в качестве источника startrek-тикет и другие источники (sourceRefs), анализирует, и возвращает фидбек в исходный тикет в виде комментария, выставления статуса, назначения исполнителя и т.п.
Body:

```typescript
{
    issueKey: string,
    sourceRefs?: {
        type: string,
        value: string
    }[]
}
```

Возможные статусы: 200, 422.

#### `POST /api/v1/report-task-status`

Принимает в качестве источника sandbox-таску и дополнительные параметры, записывает статус завершения задачи в табличку `task_statuses`, анализирует, и результаты анализа записывает в `task_resolutions`.
Таблицы `task_statuses` и `task_resolutions` необходимы для метрики infra fail rate.

Body:

```typescript
{
    task_id: string;
    build_id: string;
    task_type: string;
    project: string;
    build_context: string;
    status: string;
    duration: string;
    date_time?: string;
    resolutions?: Array<string>;
    parent_id?: string;
}
```

Возможные статусы: 200, 422.

### Coroner: источники, анализаторы и правила резолюции

Общий принцип работы Coroner:
- На вход передаются ссылки на источники информации о сборке / PR (id задачи в Sandbox, номер пулл-реквеста etc) – то, что Zeroline смог распарсить из тикета.
- С помощью анализаторов из источников извлекаются различные признаки (знакомые ошибки в логах, факты, указывающие на человеческий фактор и прочее).
- На основе извлеченных признаков и правил определяются резолюции, описывающие проблему и ответственных. Резолюция может включать в себя действия, которые будут выполнены Zeroline (`assign`, `setCause`, `close`, etc.), если подходит только одно правило.
