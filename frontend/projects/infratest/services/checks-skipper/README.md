# checks-skipper

Сервис для мьюта обязательных проверок. На данный момент работает только в ручном режиме и возвращает замьюченные проверки, которые заданы в переменной среды окружения.

## Мьют проверок

### Для разработчиков интерфейсов
Если вы считаете, что проверка нестабильна и ее следует замьютить, необходимо:
1. Собрать не менее 5 задач, в которых эта проверка упала с однотипными ошибками. Упавшие задачи должны быть запущены на разных хэшах и в разных пулл-реквестах - 5 упавших задач в одном пулл-реквесте не подойдет, т.к. высока вероятность, что падения связаны с изменениями в пулл-реквесте.
2. Завести тикет через [infraduty-форму](https://wiki.yandex-team.ru/infraduty/form) с запросом на мьют проверки. В тикете необходимо указать список задач из п.1.

### Для разработчиков инфраструктуры
На данный момент мьют работает для обязательных проверок `Hermione`, `Unit` и `testpalm validate`. Для того, чтобы замьютить проверку, в [приложении checks-skipper](https://deploy.yandex-team.ru/stages/checks-skipper) необходимо добавить проверку в переменную среды окружения `MUTES_CONFIG`. При обновлении переменной `MUTES_CONFIG` в Ydeploy необходимо указать INFRADUTY-тикет, в рамках которого мьютится проверка.
Значения проверок задаются в том формате, в котором они заданы в скриптах проекта. Для `search-interfaces-frontend` это: `Hermione - ci:hermione`, `Unit - ci:unit`, `Testpalm validate - ci:testpalm:validate`. Например, таким образом можно замьютить unit-тесты в проекте `moebius`:
``` json
{
    "search-interfaces/frontend": {
        "@yandex-int/moebius-lab": ["ci:unit"]
    }
}
```
После мьюта проверки следует завести ответственным за сервис тикет на починку.

## Включение проверок
### Для разработчиков интерфейсов
Если вы считаете, что стабилизировали проверку и ее следует включить, необходимо:
1. Собрать не менее 5 задач, в которых проверка успешно проходит.
2. Завести тикет через [infraduty-форму](https://wiki.yandex-team.ru/infraduty/form) с запросом на включение проверки. В тикете необходимо указать список задач из п.1.

### Для разработчиков инфраструктуры
После починки проверки необходимо удалить ее из переменной `MUTES_CONFIG`. Сделать это может ответственный сервиса или дежурный инфраструктуры. При обновлении переменной `MUTES_CONFIG` в Ydeploy необходимо указать тикет, в рамках которого включается проверка.

## HTTP API v1

### `GET /api/v1/checks/mutes`
Получает на вход проект и возвращает объект с замьюченными проверками для переданного проекта. Объект берется из переменной среды окружения `MUTES_CONFIG`, которая должна быть задана в формате:
```js
{
    <project>: {
        <service>: [<muted-check>]
    }
}
```

Body:
```
{
    owner: 'search-interfaces',
    repo: 'frontend'
}
```

Возможные статусы: 200, 422, 500.

### `POST /api/v1/checks/fail`

Принимает информацию об упавшей проверке и отправляет о ней фидбек в vcs.

Body:
```
{
    owner: 'search-interfaces',
    repo: 'frontend',
    prNumber,
    checkTitle: this.name
}
```


Возможные статусы: 200, 422, 500.

## Разработка

```sh
npm i
```

Запуск сервера:

```sh
npm run dev
```

## Публикация новой версии

После влития пулл-реквеста выполнить на актуальной ветке master:
```
npm run up
cd services/checks-skipper
npm run docker-publish
```

## Развертывание

[Окружение](https://deploy.yandex-team.ru/stage/checks-skipper). Образ – `registry.yandex.net/search-interfaces/checks-skipper`.

Необходимые переменные окружения:
```sh
MUTES_CONFIG
GITHUB_API_TOKEN
ARCANUM_API_OAUTH_TOKEN
```
