# Написание YML-сценариев
## Оформление заголовков, степов, кейсов:

- Разбиваем пустой строкой все поля верхнего уровня кроме `feature`, `type` и `experiment`.
- Все параметры и флаги, которые недоступны внешним пользователям, необходимо выносить в блок `params`.

```
feature: Голосовой поиск
type: Головой ввод
experiment: Дефекты речи

params:
  exp_flags:
    - value=1
    - value=2
```

- Все текстовые названия в полях `feature`, `type`, `experiment` и тест-кейсы в `specs` пишем с **большой** буквы.
- В директивах `do`, `assert`, `screenshot`, `tech` пишем всё с **маленькой** буквы.
- Неправильно писать ` - assert: проверить ссылку`. Подобные проверки необходимо разносить на действие и ожидаемый результат.

```
- do: нажать на ссылку "Картинки" в табах сервисов
- assert: открылся сервис Яндекс.Картинки
```

- Не дробим кейсы ради отдельных атомарных проверок. В одном кейсе может быть несколько `assert` и `screenshot` проверок.
- Для указания на подготовительные действия используем `beforeEach`. Шаги из этого блока будут подставляться в начало каждого кейса группы тестов, аналогично с beforeEach в mocha.
- Помните что конструкция типа:

```
- do: действие
- assert: результат 1
- assert: результат 2
- assert: результат 3
```

в заданиях для асессоров преобразуется в

```
- do: действие
- assert: результат 1
```

```
- do: действие
- assert: результат 2
```

```
- do: действие
- assert: результат 3
```

Учитывайте это при написании последовательных спек!
- Если вы хотите, чтобы после действия были проверены подряд несколько утверждений, используйте конструкцию подобного вида:

```
- do: в поисковой стрелке отчистить поле ввода
- do: нажать кнопку "Найти"
- assert:
        в поисковой строке осталось пустое поле ввода,
        на странице сообщение "Задан пустой поисковый запрос",
        результаты поиска отсутствуют
```

* Если вы **НЕ хотите**, чтобы какой-то кейс **попал в задания асессорам**, достаточно добавить ему `tags: no_assessors` (можно добавлять теги отдельным кейсам). Такие кейсы при портации будут в TestPalm помечаться тегом `no_assessors` и они будут автоматически исключаться при запуске на асессорах.
* Если же вы наоборот хотите, чтобы весь ямл или отдельные кейсы попадали **только к асессорам**, помечайте их тегом `for_assessors`. Такие кейсы не будут попадать в ручные раны, сформированные в рамках формального тестирования
* Если функциональность входит в состав смоука (наиболее критичная), помечайте ее **двумя тегами** `[smoke, smoke_extended]`, если фича входит еще и в состав расширенного смоука (фича, пропустив баг в которой, получим критикал в проде), то помечаем тегом `[smoke_extended]`.

## Скриншоты, ссылки, счетчики

- По договорённостям **квадратные скобки** – это ссылки на скриншоты, лежащие либо в репозитории, либо в Jing. Будьте внимательны! Для всех пояснений в ямлах только круглые скобки!
- По возможности максимальное количество шагов сопровождать скриншотами. Так асессорам проще понимать правильную ли картину они видят.
- Для счётчиков и их параметров, а так же других технических проверок, например проверки значений cookie, вместо `assert` используем `tech`. Такие проверки не попадают в сценарии асессоров. Все пары do-tech будут автоматически исключаться из заданий асессорам.
- Пишем без частей URL страниц и флагов в заголовках тест-кейсов:
    1. Вместо "перейти по адресу `/search/touch/`", пишем "перейти на главную страницу сервиса".
    1. Вместо "перейти по адресу `/search/?text=bmw&lr=2`" пишем "перейти по запросу bmw". Список флагов со значениями уже указан в директиве `flags`.
- В файле должен содержаться счетчик (поле `counter`) который используется в фиче. На основе данных со счетчиков будет формироваться ссылка на выдачу с фичей.

## Домены

Поле tlds должно располагаться в верхней части yml-файла, потому что сам файл может быть очень длинным и чтобы найти эту информацию нужно будет скролить до конца файла.

Если доменов несколько, то пишем в виде массива:

```
tlds: [ru, by, kz, ua]
```

Если домен один, то пишем в строку:

```
tlds: ru
```

## Смысловое наполнение и вложенность

- Не используем в основном названии фичи сокращения доступные узкому кругу лиц. Пишем спеки так, чтобы понял любой человек, а не только ты и члены твоей команды.
- Не используем слово **Эксперимент** в названии эксперимента, и слово **Фича** в названии фичи. Стараемся давать название, из которого сразу понятен контекст.
- Пишем без лишней вложенности в `specs` без необходимости. **Максимально возможная вложенность - 3**.
- Если какой-то отдельный кейс или весь файл актуален только для узкого круга браузеров или устройств, то это необходимо указать через `browsers` или `platform` и они будут автоматически исключаться из запусков в неактуальных для них окружениях.

## Отступы и расположение полей

- YML-файл начинается с полей `feature`, `type` и `experiment` (не всегда указываются). Перед ними нет отступа.
- Перед командой `specs` также нет отступа.
- Одна табуляция (отступ) от края ставится перед `beforeEach`. Содержание `beforeEach` находится на расстоянии одной табуляции от самой команды (равнозначно - две табуляции от края)
- Название кейса должно быть на уровне `beforeEach`. Соответственно, содержание кейса - одна табуляция от названия кейса, или две табуляции от края.
- В нижней части YML-файла должны находиться поля `v-team`, `tags`, `counter`. Пишем их без отступа от края документа.

```
v-team: UniAnswer

counter: /snippet/booking-rating

tags: reviewed
```

- Тестовый сценарий может содержать не только названия кейсов, но и вложенные кейсы. Тогда вложенный кейс будет находиться в одной табуляции от основного (или две табуляции от края), содержание вложенного кейса - одна табуляция от него (или три табуляции от края).

```
specs:
  Проверка зависимых блоков:
    Подстановка исправленного запроса в pager:
      - do: получить выдачу по запросу `ktnj` и перейти на пятую страницу выдачи через пейджер
      - assert: ссылки на страницы по номерам (3, 4, 6, 7) в пагинаторе должны иметь параметр `text` = `лето`
```

## Используемые поля

Обязательные поля:
- `feature` - человеко-понятное название фичи.
- `specs` или `specs-integration` - описание тест-кейсов.
- `files` - список файлов c hermione тестами.

Необязательные поля:
- `aliases` - список алиасов с шагами.
- `description` - краткое описание фичи. Будет доступно в задаче в TestPalm.
- `type` - одна из разновидностей фичи.
- `experiment` - название эксперимента.
- `flags` - список флагов, необходимых для работы эксперимента.
- `tlds` - домены, для которого предназначен YML.
- `langs` - cписок языков, поддерживаемых в сценарии.
- `tags` - список тегов.
- `browsers` - cписок браузеров, поддерживаемых в сценарии. По умолчанию заполняется всеми браузерами из сета.

Поля, которые выставляются автоматически:

- `platform` - платформа, для которой предназначен данный тест-кейс.

### Особенности использования полей

Более подробно про поля можно прочитать в [документации](https://a.yandex-team.ru/arc_vcs/frontend/projects/infratest/packages/palmsync#поля-файла).

**type**

Поле `type` используется в случаях, когда есть несколько разновидностей фичи.

**Пример:** в сервисе поиска есть фича **Опечаточник**.
Опечаточник имеет много разновидностей: синтаксическая ошибка, автозамена, антизеркальный и т.д.
Поведение этих модификаций различается, поэтому следует описать эти несколько типов в отдельных файлах.

Опишем особенности работы опечаточника при синтаксической ошибке:

```
feature: Опечатка и Ко
type: Синтаксическая ошибка

specs:
  Обязательные проверки:
    - do: получить выдачу по запросу '№-'
    - assert: на странице присутствует сообщение о синтаксической ошибке, других результатов поисковой выдачи нет
```

Опишем особенности работы опечаточника при автозамене:

```

feature: Опечатка и Ко
type: Автозамена исправлена опечатка

specs:
  Поиск по опечатке:
    - do: Получить выдачу по запросу 'молако'
    - assert: На странице присутствует сообщение об исправлении опечатки
```

**experiment**

Эксперимент. При наличии участвует в формировании `id` тестового сценария в TestPalm.

```
experiment: маленькое приложение в начале

params:
  exp_flags: show_bna_apps=1
```

**params**

Если нужно указать несколько флагов, делаем это в виде списка:

```
params:
  exp_flags:
    - flag=1
    - flag=2
```

Если флаг один, пишем так же, как и несколько:

```
params:
  exp_flags:
    - images_auto_wizard=1
```

Писать значение флага не обязательно, если оно равно 1 (значение по-умолчанию).
В данном поле можно указать произвольные параметры, которые будут добавлены в атрибуты тестового сценария, само поле `params` в атрибуты не попадет. Поле `params` может быть выставлено как для всего файла, так и для отдельных сьютов и даже тестов.

```
params:
  exp_flags:
    - foo1
    - foo2
  some_key: foo

specs:
  Какой-то сьют:
    - params:
        exp_flags: bar
    - Какой-то тест:
      - params:
          some_key:
            - baz1
            - baz2
      - do: bla-bla
      - assert: bla-bla
 ```

**aliases**

Используется для описания шагов, которые повторяются в нескольких тест-кейсах.

Для этого сразу после основных полей `feature`, `type`, `experiment` указываем поле `aliases`:

```
feature: Адресный сниппет
type: Много точек

aliases:
  - &checkLinks
    - assert: проверка наличия счетчика
    - assert: в ссылке есть source параметр
    - assert: в ссылке есть sll параметр
```

И затем используем его в `specs`:

```
specs:
    Проверка параметров в ссылке:
      - do: получить выдачу по запросу 'окна пластиковые'
      - assert: должен появиться адресный сниппет 'Много точек'
      - *checkLinks
```

**specs**

Описание тестовых сценариев. Обязательно должно содержать как минимум 1 вложенный сценарий.

```
specs:
    Проверка параметров в ссылке:
      - do: получить выдачу по запросу 'окна пластиковые'
      - assert: должен появиться адресный сниппет 'Много точек'
```

В случае отсутствия вложенных сценариев palmsync будет валиться на валидации hermione тестов.

**specs-integration**

Описание тестовых сценариев для интеграционных тестов. Структура и ключи полностью совпадают с полем `specs`.

* Сценарии должны содержать только критичную функциональность, зависящую от реальных данных.
* Нельзя использовать ни `Вечные данные`, ни `Замороженные данные`.
* Следует описывать проверки элементов, которые относительно стабильно появляются на выдаче. Например, в большинстве
случаев нельзя проверить контент элементов, он вариативен. Также не получится проверить дистрибуционные элементы, так
как они зависят от атома.


**files**

Для указания нескольких файлов используем список:

```
files:
    - features/deskpad/adapter-maps/coordinates.hermione.js
```

Если все проверки ручные, то указываем пустой массив и проставляем [manual] в названии:

```
files: []
```

Если проверки планируется автоматизировать в одной из задач, используем пустой массив и комментарии:

```
files: []
  # https://st.yandex-team.ru/SERP-1234 - hermione
```

**browsers**

Список браузеров, поддерживаемых в сценарии. По умолчанию заполняется всеми браузерами из сета.

```
browsers:
  notFor:
    - desktop-ie11
    - desktop-edge
```

**counter**

Счетчик показа более-менее однозначно определяющий фичу, может быть указан как для всего файла, так и для отдельных сьютов или даже тестов.

Это поле необходимо в тех ямлах, в которых есть интеграционные тесты.

## Структура файлов и папок
При написании тестов соблюдаем конвенцию именования файлов и папок, а так же внутреннюю структуру файлов.

### Структура папок
Тестовые сценарии хранятся в папке [features](https://a.yandex-team.ru/arc_vcs/frontend/projects/web4/features) в корне репозитория.

Структура этой папки следующая:

```
features/
        common
        deskpad
        desktop
        searchapp
        searchapp-pad
        touch-phone
```

Если какого-то уровня нет, его нужно создать.

При описании новой фичи необходимо:
1. Создать папку с кратким названием фичи для нужной платформы.
1. Создать файл с таким же названием в корне этой папки с расширением `.testpalm.yml`.
1. При наличии экспериментов создать папку exp и в ней класть файлы с описанием экспериментов.

### Имена файлов

Формат названия файла: `feature-name-short-desc.testpalm.yml`.

1. В названии файла обязательно указывается название фичи и краткое описание его содержания.
1. Используется kebab-case.

Пример файловой структуры папки с фичей:

```
    related/
            related.testpalm.yml <- основная функциональность связанных
            related-carousel.testpalm.yml <- тип Карусель
            related-grid.testpal.yml <- тип Сетка
            exp/
                related-double-thumbs.testpalm.yml <- эксперимент с двойными тумбами
                related-rectangular-thumbs.testpalm.yml <- эксперимент с прямогольными тумбами
                related-carousel-without-arrow.testpalm.yml <- эксперимент с отсутствующими стрелками в карусели связанных
```

Аналогичным образом называем папки и файлы hermione, относящиеся к фиче.

## Валидация

Валидация правильности заполнения файлов с тестовыми сценариями и их синхронизация выполняются инструментом "Palmsync" (конфиг для проекта [.palmsync.conf.js](../../.palmsync.conf.js)).
Подробнее о структуре конфигурационного файла можно прочитать в [документации Palmsync](https://a.yandex-team.ru/arc_vcs/frontend/projects/infratest/packages/palmsync#Конфигурация-с-помощью-файла-palmsyncconfjs).

> palmsync validate "foo.testpalm.yml" "foo.hermione.js" --skip=tests
