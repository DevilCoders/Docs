# Библиотеки

Для организации проектных библиотек/хелперов организовано единое место — директория [src/lib](../src/lib).

Документация на библиотеки:

- [GlobalContext](../src/lib/GlobalContext/README.md)
- [CSP](../src/lib/csp/README.md)
- [Mds](../src/lib/mds/README.md)

## FAQ

- [Как писать библиотечный код](#Как-писать-библиотечный-код)
- [Надо ли писать тесты](#Надо-ли-писать-тесты)
- [Надо ли писать документацию](#Надо-ли-писать-документацию)
- [Как раскладывать код по уровням](#Как-раскладывать-код-по-уровням)
- [Как подключать библиотеку в проект](#Как-подключать-библиотеку-в-проект)

### Как писать библиотечный код?

Библиотечный код должен быть отчуждаемым и не зависеть от других частей проекта (компоненты, адаптеры, другие библиотеки, типы проекта). Основная технология реализации — TypeScript. Если есть реализация на JavaScript и нет прямо сейчас времени ее переписывать, обязательно:
1. Написать `index.d.ts`
2. Запланировать честное переписывание на TypeScript

### Надо ли писать тесты?

Код библиотек должен быть покрыт юнит-тестами:

```diff
src/lib/
  ├── MyLib/ — папка библиотеки
+ |   ├── index.test.ts
  |   └── index.ts — реализация библиотеки
```

```ts
import { assert } from 'chai';
import { describe, it } from 'mocha';
import { MyLib } from '.';

describe('MyLib', () => {
    // Тест
});
```

### Надо ли писать документацию?

Если библиотека делает что-то нетривиальное, то написание `README.md`-файла и добавление на него в начало данного md-файла обязательно.
Пример тривиальной библиотеки — это библиотека из одной функции. Для такой библиотеки достаточно комментариев в коде.

<details>
<summary>Скелет документации библиотеки</summary>

```md
# MyLib

Краткое описание библиотеки и сфера применения.

## Реализация

Описание ключевых особенностей реализации, если такие имеются.

## Использование

Разбор примера использования компонента.

## FAQ

### Один стандартный вопрос про компонент?

### Какой-то другой стандартный вопрос?
```
</details>

### Как раскладывать код по уровням?

Если реализация библиотеки отличается для разных платформ, то вместо одного файла можно написать несколько — по одному файлу на каждый [уровень переопределения](../README.md), на котором есть различия:

```diff
src/lib/
  ├── MyLib/ — папка библиотеки
  |   ├── index.test.ts
- |   └── index.ts
+ │   ├── index@common.ts— общий код
+ │   ├── index@desktop.ts — код для платформы "desktop"
+ │   └── index@touch-phone.ts — код для платформы "touch-phone"
```

Связи между реализациями с разных уровней осуществляется через механизм наследования или композицию, в зависимости от того, как организован код библиотеки.

### Как подключать библиотеку в проект?

Способ подключения библиотечного кода в проекте зависит от того, в каком месте этот код планируется использовать.

- если код подключается в TypeScript-адаптерах или React-компонентах, то достаточно использовать обычный `import`
- если код нужно использовать в priv-адаптерах или блоках Конструктора, то библиотеку можно подключить как часть [GlobalContext-а](../src/lib/GlobalContext) или через `RequestCtx`, куда донести код из настройки Табурета в `pages-*/search/renderer.js` или напрямую в [template-runner-е](../src/lib/taburet/packages/template-runner/index.ts)
- если код нужно использовать в i-bem-коде блоков Конструктора, то единственный способ подключения — это `borschik:include:` скомпилированного TypeScript-ом файла из `.build/src/lib/**`
