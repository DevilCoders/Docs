# CSP

## Важно!
Если вы хотите корректно проверить политики, то обязательно нужно проверять под https.

## Реализация в Серпе
Политики формируются из объекта с двумя методами meta и header
```
{
    // Метод meta, формирует политики для передачи через мета-тег
    meta(params) {
        return {
            'script-src': '',
            'style-src'
        };
    },

    // Метод header, формирует политики для передачи через заголовок Content-Security-Policy
    header(params): {},
}
```

Конфиги находятся в файлах csp.js в папках `web4/src/lib/csp/policies-data{.dev}.js`, для работы с политиками в серверных шаблонах, существует объект RequestCtx.CSP, который реализован в `web4/src/lib/csp/index.js`

Кастомные правила для конкретного домена расширяют существующие в общем наборе правила. Если каких-то директив нет в общих, то они не добавляются в результирующую политику.

b-page__csp из Лего не используем, потому что хотим все правила для политики держать в едином конфиге, который со временем хочется использовать в RR.

Яндексовые хосты добавляем к большинству *-src политик, потому что кейсов 100500. Например:
- открытие видео в колдуне трансляции открывает сначала jsredir-ссылку, которая потом редиректит и встраивает видео;
- колдунщики, саджесты, апи карт, что угодно ещё ходит в произвольные хосты на tld/ru/net/st с разными поддоменами типа *.storage.yandex.net;
- хосты счетчиков на ru;
- некоторые колдуны используют что-нибудь из yandex.st/lego, например, муз. колдун;
- хосты для рекламы и прочей дистрибуции (an.yandex.ru, awaps.yandex.ru, awaps.yandex.net)
