# CSS константы

## Зачем?

Если коротко – быстро перекрашивать СЕРП, иметь единые цвета и типографику по всему сервису, избегать ситуаций, когда у нас есть 6 разных оттенков желтого.

A также:

* Использование единых константных значений для CSS во всех блоках серпа
* Гибкая настройка и переиспользование стилей
* Переопределение по платформам и размерам экранов
* Проведение экспериментов с изменением стилей в онлайн-режиме с гарантированным изменением всех мест, где используется константа, без использования костылей и 100500 !import.
* Простой перенос результатов онлайн-экспериментов (напр. сниппетных угаров) в продакшен.

## Как это работает?

В основе подхода лежит использование [CSS Custom Properties](https://developer.mozilla.org/en-US/docs/Web/CSS/Using_CSS_variables). Это связано с тем, что нативные CSS переменные предоставляют гибкий способ переопределения в runtime режиме. Для изменение стилей достаточно добавить на страницу переменные с новыми значениями без необходимости пересборки, тем более что собирать `CSS` файлы "на лету" в `Production` нельзя, поэтому вариант с использованием `Stylus` переменных не подходит.

CSS Константы применяются/раскрываются при сборке CSS (по-умолчанию css переменные отключены)

### 1. Сборка
После сборки и обработки `Stylus` парсером CSS/Stylus файлов в собранный файл "подклеивается" файл с константами, собранными для всех уровней, относящихся к этой платформе (desktop, touch-pad, touch-phone). Уровни берутся из `.enb/helpers/level-patterns.js` по названию платформы.

После этого файл обрабатывается с помощью [post-css-vars](https://gitlab.yandex-team.ru/search-interfaces/post-css-vars), который раскрывает константы в CSS код.

Было:
```
.header
{
    color: var(--color-red);
}
```

Стало:
```
.header
{
    color: #ff0;
}
```

Этот плагин был выбран из-за активного отклика автора и поддержки переопределения констант внутри @media выражений, что решает нам задачу переопределения по размерам экрана.

**Важно!**
Для возможности проведения онлайн экспериментов в коде намеренно оставляется исходный вариант строки с использованием константы.

#### Где хранятся константы?
Константы хранятся в специальном блоке **css-const**.
```
web4/
  blocks-common/
    css-const
      __common
        css-const__common.css
      __media
        css-const__media.css
```
Внутри блок содержит папку `__common` с общими для всех размеров экрана константами и папку `__media` – в которой содержатся переопределения констант для различных размеров экрана. Такое явное разделение было сделано из-за особенностей поведения `CSS Custom Properties`. Если ниже будет переопределено значение константы, которая была использована внутри выражения @media – переопределение по размеру экрана перестанет действовать – поэтому нам нужно в явном виде расположить @media так, чтобы этот код находился ниже.

Пример:
```css
:root {
    --color-link: #ff0;
}

@media screen and (max-width: 800px)
{
    :root
    {
        --color-link: #ccc;
    }
}

/* Эта константа будет иметь больший вес */
:root
{
    --color-link: #fff;
}
```

На выходе получится, что ссылка будет белого цвета всегда, даже на экране менее 800px.

### 2. Доопределение по платформам
Для того, чтобы изменить значение константы только для одной из платформ, добавьте новое значение для константы в блок css-const на нужном уровне.

**Важно!**
1. Создайте при необходимости блок **css-const** на нужном для вас уровне переопределения.
2. Ожидается, что блок с константами должен находиться на первом уровне переопределения:
```
web4/
  block-common/
    css-const/
      ...
  blocks-deskpad/
    css-const/
  blocks-dekstop/
    css-const/
  blocks-touch/
    css-const/
  blocks-touch-pad/
    css-const/
  blocks-touch-phone/
```

### 3. Проведение онлайн-экспериментов

Переменные можно включить флагом `&exp_flags=css_const_exp`.
Тогда будет приезжать такой код:
```
.typo_text_m {
    font-size: 13px;
}
...
:root {
    ...
    --text-m: 13px;
    ...
}
...
.typo_text_m[class] {
    font-size: 13px;
    font-size: var(--text-m);
}
```

Эксперименты можно проводить на любом устройстве/браузере с поддержкой CSS Custom Properties (http://caniuse.com/#feat=css-variables).
Для переопределения константы нужно передать значение для констант через `expFlags`.
Флаг, отвечающий за эксперименты с константами, называется ``css_const_exp``.

#### Схема переопределения:

```
exp_flags=css_const_exp={ "имя константы" : "значение константы", ... }
exp_flags=css_const_exp={ "media": "@media query", "styles": { "имя константы" : "значение константы", ...} }
```

- **имя константы** – точное имя константы из блока `css-const` без начальных дефисов (например color-link)
- **@media модификатор** – корректная media query
- **значение константы** - строка (например 16px)

**Например:**

```json
{
    "text-s": "12px",
    "text-m": "14px",
    "text-l": "16px"
}
```

```json
[{
   "media": "(min-width: 360px)",
   "styles": {
       "text-s": "14px",
       "text-m": "16px",
       "text-l": "18px",
   }
}, {
       "text-s": "12px",
       "text-m": "14px",
       "text-l": "16px"
}]
```

##### @media выражения для флага css-const
Так как в css переопределение @media работает очень плохо и скорее всего то, что вы хотите не заработает :),
переопределение по ширине экрана лучше организовывать каскадными правилами по принципу пирамиды:

```
.block-link
{
    color: yellow;
}

@media (min-width:300px)
{
    .block-link
    {
        color: red;
    }
}

@media (min-width:400px)
{
    .block-link
    {
        color: green;
    }
}

@media (min-width:500px)
{
    .block-link
    {
        color: blue;
    }
}
```

Тогда их будет удобно переопределять как показано в примере выше.

**P.S.** Если у вас есть вопросы или предложения – обращайтесь в контур `Beauty`.

Знатоки: [Александр Карпов](https://staff.yandex-team.ru/kukuruku) [Серафим Четверухин](https://staff.yandex-team.ru/chetverukhin)
