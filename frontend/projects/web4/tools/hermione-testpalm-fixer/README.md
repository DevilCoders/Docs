# hermione-testpalm-fixer

Скрипт для автоматического исправления testpalm и hermione тестов:
- исправляет yml-файлы
- исправляет hermione.js-файлы
- исправляет hermione.e2e.js-файлы
- исправляет metrics.js-файлы
- перемещает дампы и скриншоты gz- и png-файлы

## Установка

В корне проекта установите зависимости:
```
npm run deps
```

## Использование

Запускайте из корня проекта:
```
node tools/hermione-testpalm-fixer
```

### Опции

- `--path` (default: `'**/*.testpalm.yml'`) — путь до файла или директории , по которым находятся yml-файлы (можно использовать маски [fast-glob](https://github.com/mrmlnc/fast-glob#pattern-syntax): `*`, `**`, `!`, но тогда путь должен быть в кавычках `--path '*.yml'`)
- `--size` (default: `100`) — размер чанков, для итеративной работы с файлами
- `--soft` (default: `false`) — режим переименования дампов и скриншотов без удаления оригиналов
- `--verbose` (default: `false`) — выведет список найденных yml-файлов по маске
- `-n` (default: `false`) — тихий режим, ничего не перезаписывает

### Трансформаторы

Источник: https://wiki.yandex-team.ru/users/dakhetov/Specifikacija-yml-fajjlov/Specifiuacija-yml-fajjlov-2

| Номер | Имя файла | Описание |
|---|---|---|
| spec_2 | `'no-unexpected-test'` | Название кейса должно быть лаконичным. Оно не должно содержать слов, подчеркивающих назначение самих тест-кейсов, например: проверка, корректность и так далее. |
| spec_4 | `'capitalized-feature'` | Название фичи должно начинаться с большой буквы. |
| spec_5 | `'capitalized-type'` | Название типа фичи должно начинаться с большой буквы. |
| spec_7 | `'capitalized-test'` | Название тест-кейса должно начинаться с большой буквы. Исключая случаи со специальными словами. |
| spec_10, spec_11, - | `'no-unexpected-feature'` | <ul><li>В названии фичи не может содержаться цель тестирования. К примеру, Проверка корректности</li><li>В названии фичи не должно встречаться слово функциональность. Не используем слово Эксперимент в названии эксперимента, и слово Фича в названии фичи. Стараемся давать название, из которого сразу понятен контекст</li><li>Название фичи должно быть включено в разрешенный список</li><ul> |
| spec_13 | `'capitalized-step'` | Все -do: -assert должны быть с маленькой буквы. |
| - | `'no-unexpected-tags'` | Тег должен быть включен в разрешенный список. |
| - | `'no-unexpected-files'` | В files должны быть только пути файлов тестов или TODO. |

### Добавление новых трансформаторов

Работа с testpalm и hermione файлами происходит независимо.
Все трасформаторы лежат в директории `transforms`. Не забудьте добавить новый трансформатор в `transforms/index.js`.
В трасформаторы передаётся распарсенные yml `data` и `ast` соответсвенно для testpalm и hermione.

Для работы с `ast` можно воспользоваться пакетом [jscodeshift](https://github.com/facebook/jscodeshift). 

Пример:

```js
// spec_7: Название тест-кейса должно начинаться с большой буквы. Исключая случаи со специальными словами.
const replace = (value) => _.upperFirst(value);

module.exports = {
    testpalm: (data) => {
        const traverse = (node) => {
            if (node && _.isObject(node) && !_.isArray(node)) {
                Object.keys(node).forEach(key => {
                    if (!YML_IGNORE_KEYS.includes(key)) {
                        const newKey = replace(key);

                        if (key !== newKey) {
                            node[newKey] = node[key];
                            delete node[key];
                        }

                        traverse(node[newKey]);
                    }
                })
            }
        }
        
        YML_SPECS_TYPE_KEYS.forEach(key => traverse(data[key]));

        return data;
    },
    hermione: (ast) => {
        ast
            .find(j.CallExpression)
            .filter(path => CALLEE_NAMES.includes(_.get(path, 'node.callee.name')))
            .forEach(path => {
                const node = _.get(path, 'node.arguments.0');

                if (node && node.type === 'Literal') {
                    const value = _.get(node, 'value');

                    if (value) {
                        _.set(node, 'value', replace(value));
                    }
                }
            });
        
        return ast;
    }
};
```

Правила применяются последовательно, поэтому не забывайте в обработчиках возвращать `data` и `ast`.
Если `data` и `ast` не изменили, файлы не будут перезаписаны.

В `data` могут находиться служебные поля:
- `%%COMMENT\d%%` — элемент массива или свойство объекта, нужно для восстановления комментариев
- `%%REFS%%` — массив со списком ссылок на алиасы, нужен для восстановления оригинальных имен алиасов
Если они вам не нужны для трансвормации, добавьте игнорирование всех полей с `%%`.

### Словари

В директории `dictionaries` лежат словари для работы с данными:
- `feature-dictionary` — словарь дубликатов названий фичей
- `special-word-dictionary` — список специальных слов, которые не должны меняться
- `tag-dictionary` — словарь дубликатов тегов
- `word-dictionary` — словарь дубликатов слов и фраз

Словари дубликатов имеют следующую структуру:
```js
{
    'Оригинальное значение': [
        'Дубликат 1'
        'Дубликат 2'
    ]
}
```
Все *Дубликаты* будут заменены на *Оригинальное значение*.

Если вы хотите переименовать какие-то тесты по какому-то паттерну, воспользуйтесь одним или несколькими словарями.

### Работа с дампами и скриншотами

Работа с дампами и скриншотами в трасформаторах не предусмотрена, она запускается автоматически, если изменились названия тестов.

Будьте внимательны, старые дампы и скриншоты удаляются. Чтобы этого не произошло, используйте опцию `--soft`.
