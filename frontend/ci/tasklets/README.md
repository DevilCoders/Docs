# Тасклеты фронтенда

В данной директории расположены [тасклеты](https://wiki.yandex-team.ru/sandbox/tasklets/) для запуска различных фронтендерских проверок в [CI](https://docs.yandex-team.ru/ci/). Если необходимого вам тасклета в этой директории нет, то, возможно, вашу задачу может решить тасклет общего назначения [run_command](https://a.yandex-team.ru/arc/trunk/arcadia/ci/tasklet/registry/common/misc/run_command).

## Список доступных тасклетов:

* `hermione` - тасклет для запуска [hermione](https://github.com/gemini-testing/hermione)-тестов. Подробнее [тут](https://a.yandex-team.ru/arc/trunk/arcadia/frontend/ci/tasklets/hermione).

## Разработка тасклетов

### Принципы организации кода

- код, который не специфичен для одного тасклета (например, маунт аркадии, получение секрета из yav и т.д.) и может быть использован в других тасклетах, желательно выносить в папку [common](https://a.yandex-team.ru/arc/trunk/arcadia/frontend/ci/tasklets/common). В данной папке находятся миксины, менеджеры, базовые таски, утилиты, т.е. какой-то общий код (подробнее о каждом читайте [тут](https://a.yandex-team.ru/arc/trunk/arcadia/frontend/ci/tasklets/common));
- большинство тасклетов следует наследовать от одной из базовых тасок, например от [BaseTask](https://a.yandex-team.ru/arc/trunk/arcadia/frontend/ci/tasklets/common/task/base.py);
- protobuf-сообщения, которые могут быть использованы в нескольких тасклетах, должны быть описаны в папке [common/proto](https://a.yandex-team.ru/arc/trunk/arcadia/frontend/ci/tasklets/common/proto). Такая практика так же полезна для использования одинаковых типов сообщений в `input` и `output` тасклетов. Это позволяет в обоих тасклетах использовать один тип сообщения определенного на `common` уровне и при его изменении не возникнет коллизий;
- в случае, когда необходимо как-то обработать `output` одного тасклета перед передачей в `input` другого, у нас есть 2 варианта решения:
  - использование [выражений CI](https://docs.yandex-team.ru/ci/expression) (так же стоит прочитать следующую главу про "Дополнительные возможности выражений") прямо в a.yaml;
  - реализовать логику в коде тасклета.

  Предпочтение стоит отдавать первому варианту, так как он более универсальный, но при этом он накладывает на пользователя необходимость знать [JMESPath](https://jmespath.org/) выражения.
- все пользовательские `input` поля стоит указывать в общем отдельном поле (например, `config`). Это необходимо для того, чтобы не приходилось все опциональные поля задавать явно в `a.yaml`, иначе валидация схемы в CI будет падать;
- если вашему тасклету необходимо определенное количество ресурсов или специфичное окружение, то стоит в тасклете указать метод `setup_requirements` с минимальными дефолтными требованиями для его запуска;
- для упрощения тестирования тасклетов внутри каждого из них стоит создавать папку `examples` с необходимыми `input` данными тасклета (например, `run_example.json`) и баш-скрипта для его запуска (например `run_example.sh`).

### Сборка тасклета (бинарного файла)

> **⚠ WARNING**: Сборка тасклета работает только на Linux машинках. Подробнее [тут](https://docs.yandex-team.ru/ci/job-tasklet).

Для сборки тасклета необходимо перейти в директорию с его исходниками - `cd frontend/ci/tasklets/hermione` и затем запустить сборку - `ya make`.

### Запуск тасклета

Перед запуском тасклета его необходимо собрать с помощью `ya make`. Для запуска тасклета можно использовать свою машинку в [QYP](https://docs.yandex-team.ru/qyp/).

#### Запуск в sandbox

Данный способ является самым надежным так как позволяет протестировать работу тасклета в боевых условиях. За запуск в `sandbox` отвечает флаг - `--sandbox-tasklet`. Пример запуска:
```
cd <tasklet_binary_folder>
<tasklet_binary> run <tasklet_name> --input '{...}' --sandbox-tasklet
```

#### Локальный запуск

Существует 2 варианта запуска локально:
- локальный запуск в тестовом режиме с флагом `--test`. В этом случае вместо использования реальных сервисов (например, [yav](https://yav.yandex-team.ru/) для похода за секретами) будут подставляться моки. Пример запуска:
```
cd <tasklet_binary_folder>
<tasklet_binary> run <tasklet_name> --input '{...}' --test
```
- полноценный локальный запуск с флагом `--local`. В этом случае тасклет исполнится локально на запущенной машинке и выполнит реальные походы во все используемые сервисы. Пример запуска:
```
cd <tasklet_binary_folder>
<tasklet_binary> run <tasklet_name> --input '{...}' --local
```

Локальный запуск тасклета с использованием API sandbox таски (`sdk2.Task.current`) работать не будет. Подробнее в [этом тикете](https://st.yandex-team.ru/DEVTOOLSSUPPORT-16769).

### Тестирование тасклетов

Нашими тасклетами будут пользоваться большое количество frontend-сервисов. Поэтому крайне важно, чтобы мы не выкатывали в прод тасклеты с багами. Соответственно необходимо их тщательно тестировать. Есть 2 варианта, как их можно протестировать:
- в CI (предпочтительный вариант)
- локально

#### Тестирование в CI

Для каждого тасклета в файле `a.yaml` необходимо описать одну или несколько `job`, которые будут проверять корректность работы тасклета. Проверки необходимо запускать на каждое изменение тасклета и они должны быть обязательными. Это позволит избежать кейсов, когда в прод выкатывается нерабочая версия тасклета.

Пример реализации появится после - https://st.yandex-team.ru/FEI-24903.

#### Локальное тестирование

Запуски необходимо выполнять максимально приближенно к боевым условиям, т.е. в sandbox. Перед релизом тасклета желательно запустить все примеры из папки `examples` вашего тасклета, все они должны выполниться успешно.

### Релиз тасклета

На данный момент зарелизить тасклет можно только локально с linux машинки. Выполнить релиз с помощью flow в CI пока нет возможности (подробнее в [этом тикете](https://st.yandex-team.ru/DEVTOOLSSUPPORT-16914)).

#### Ручной релиз

Порядок действий:
- переходим в папку с тасклетом, который необходимо зарелизить, и выполняем следующую команду:
```
cd <tasklet_binary_folder>
ya make > /dev/null && <tasklet_binary> sb-upload --sb-schema
```
- при завершении тасклета в логе консоли будет содержаться ссылка на `MDS_UPLOAD` таск и на бинарный ресурс (результат сборки тасклета). В логах выглядит примерно так:
```
Uploading task #<TASK_ID> created: https://sandbox.yandex-team.ru/task/<TASK_ID>
Tasks resource has uploaded: https://sandbox.yandex-team.ru/resource/<RESOURCE_ID>
```
- открываем ссылку на `MDS_UPLOAD` таск и нажимаем кнопку `Release` (справа сверху). Это установит время жизни ресурса бесконечным, иначе ресурс будет удален через две недели (в случае не использования другими тасками).

### Обновление версии ресурса в CI реестре

Для каждого тасклета в [реестре CI](https://docs.yandex-team.ru/ci/jobs) существует `yaml`-файл с описанием тасклета. Именно из этих описаний CI получает информацию о всех тасклетах. Чтобы CI узнал о новой версии тасклета и начал ее использовать во всех job-ах пользователей необходимо указать версию зарелиженного ресурса в поле `versions.stable`. Подробнее [тут](https://docs.yandex-team.ru/ci/job-advanced).

## Ссылки на полезные материалы

- [Тасклеты, основная документация](https://wiki.yandex-team.ru/sandbox/tasklets/)
- [Тасклеты 2.0](https://wiki.yandex-team.ru/sandbox/tasklets/roadmap/)
- [Доступные методы в тасклете на python](https://a.yandex-team.ru/arc/trunk/arcadia/tasklet/runtime/python/base.py?rev=r7138303#L59)
- [Исходники тасклетов](https://a.yandex-team.ru/arc/trunk/arcadia/tasklet)
- [ArcadiaCI](https://docs.yandex-team.ru/ci/)
- [Sandbox, документация](https://docs.yandex-team.ru/sandbox/)
