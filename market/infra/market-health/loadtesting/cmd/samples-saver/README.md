# Что это

Утилита для сохранения потока сообщений из топиков логброкера в соответствии с выбранным подмножеством конфигов
логшаттера. В процессе нагрузочного тестирования здоровья маркета предполагается использовать реальные данные, которые
присылают сервисы через логброкер, чтобы нагрузка была бы реалистичной. При этом от тестирования к тестированию могут
интересовать данные, которые льются в рамках различных конфигов, потому что нам может быть интересно посмотреть, как
будет реагировать здоровье маркета на рост потока данных от того или иного сервиса маркета (разным сервисам
соответствует разное подмножество конфигов). Поэтому необходимо иметь утилиту, которую можно периодически запускать
для получения данных по выбранному для готовящихся стрельб подмножеству конфигов.

# Как собрать

Находясь в примонтированном образе Аркадии в текущей папке (в которой находится данный README) выполнить команду:

```
ya make
```

Т.е. всё стандартно для Аркадии.
После выполнения сборки появится символическая ссылка `samples-saver` на исполнимый файл, который можно
запускать.

# Что необходимо сделать перед запуском

Нужен OAuth токен для API Health.UI, про получение которого можно прочитать
[тут](https://wiki.yandex-team.ru/market/development/health/health-ui/#avtorizacija). Его необходимо будет записать
в переменную окружения `MARKET_HEALTH_OAUTH_TOKEN`. Т.е. выполнить в консоли вот такую команду:

```bash
export MARKET_HEALTH_OAUTH_TOKEN=значение_токена
```

Также нужен OAuth токен для API логброкера, про получение которого можно почитать
[тут](https://logbroker.yandex-team.ru/docs/concepts/security#oauth). Его необходимо будет записать в переменную
окружения `LOGBROKER_TOKEN`, т.е. выполнить в консоли вот такую команду:

```bash
export LOGBROKER_TOKEN=значение_токена
```

Также необходимо иметь доступы для своего пользователя со стаффа на чтение топика из логброкера и на чтение от имени
используемого читателя логброкера (по умолчанию это `market-health-logshatter/prestable`).

Например, если хочется иметь возмоность читать из топика `market-health-dev/other` (в случае другого топика нужно будет
подставить в команду соответствующее название), то нужно выполнить такую команду (там нужно подставить свой логин
на стаффе):

```bash
ya tool logbroker -s logbroker permissions grant -y --permissions ReadTopic --path market-health-dev/other --subject свой_логин_на_стаффе@staff
```

Для получения возможности читать с помощью нужного читателя логброкера, должны быть также запрошены соответствующие
права (в команду нужно подставить свой логин со стаффа и, возможно, выбрать другого читателя, если по каким-то причинам
читатель `market-health-logshatter/prestable`, используемый по умолчанию, не подходит):

```bash
ya tool logbroker -s logbroker permissions grant --subject свой_логин_на_стаффе@staff --path market-health-logshatter/prestable --permissions ReadAsConsumer
```

# Как запустить

Утилита вычитывает из стандартного потока ввода построчно имена конфигов, по которым будет происходить чтение данных
из логброкера.

Обязательные параметры командной строки:

1. `env`. Допустимые значения: `testing` или `production`. Этот параметр определяет, в какой балансировщик будет ходить
   утилита для получения активных версий конфигов логшаттера с заданными именами, переданными в стандартном потоке
   ввода. В случае указания значения `testing` утилита будет использовать
   балансировщик https://health-testing.market.yandex-team.ru, а в случае указания значения
   `production` утилита будет использовать балансировщик https://health.market.yandex-team.ru.

Необязательные параметры командной строки:

1. `consumer`. Имя читателя логброкера, который используется для чтения данных. Значение по
   умолчанию `market-health-logshatter/prestable`.
2. `ammo_out`. Определяет путь к файлу в формате json lines (см. подробнее про json lines файлы
   на сайте https://jsonlines.org/), в который будет происходить сохранение потока сообщений, вычитываемых из
   логброкера и удовлетворяющих условиям из используемых конфигов логшаттера. Значение по умолчанию `ammo.jsonl`.
3. `custom_writers_options_out`. Определяет путь к записываемому в формате json (тут всё классически, стандартный json)
   файлу с необходимыми параметрами писателей, которые будут позднее нужны для осуществления стрельбы набранными
   сообщениями. Значение по умолчанию `writers.json`.
4. `msg_buf_size`. Определяет максимальную длину очереди сообщений на запись на диск, используемую внутри утилиты. Можно
   как-то поиграть с этим для того, чтобы влиять на потребляемую память, если будет такая необходимость. Значение по
   умолчанию 100.
5. `max_msg_count`. Максимальное колиество сообщений, которое будет записано в результирующий файл с патронами. После
   достижения этого количество утилита записи штатно останавливается. Если значение равно 0, то ограничения по
   количеству записанных сообщений в результирующий файл нет и остановить утилиту надо с помощью Ctrl+C. Значение по
   умолчанию 0.

Пусть, например, в файле `configs.txt` выписаны названия конфигов, по которым нужно выполнить чтение данных. В таком
случае запуск утилиты для работы с тестовым балансировщиком health-ui при использовании параметров по умолчанию мог бы
выглядеть вот так:

```bash
cat configs.txt | ./samples-saver -env testing
```

Остановка утилиты происходит по нажатию Ctrl+C (т.е. с помощью отправки приложению сигнала `SIGINT`). После получения
сигнала утилита штатным образом выключает чтение из логброкера, дочитывает все необходимые сообщения, завершает запись
на диск и только после этого завершается сама.