# Что это

Утилита для заливки предварительно сохранённого потока входных сообщений (с помощью утилиты [samples-saver](
https://a.yandex-team.ru/arc_vcs/market/infra/market-health/loadtesting/cmd/samples-saver/README.md)) в топик
логброкера, который вычитывает логшаттер во время нагрузочного тестирования. Создана на основе [pandora](
https://github.com/yandex/pandora). Соответственно, поддерживает возможности пандоры по конфигурированию длительности
стрельб и их интенсивности.

# Как собрать

Находясь в примонтированном образе Аркадии в текущей папке (в которой находится данный README) выполнить команду:

```
ya make
```

Т.е. всё стандартно для Аркадии.
После выполнения сборки появится символическая ссылка `logbroker-gun` на исполнимый файл, который можно
запускать.

# Что необходимо сделать перед запуском

Нужен OAuth токен для API логброкера, про получение которого можно почитать
[тут](https://logbroker.yandex-team.ru/docs/concepts/security#oauth). Его необходимо будет записать в переменную
окружения `LOGBROKER_TOKEN`, т.е. выполнить в консоли вот такую команду:

```bash
export LOGBROKER_TOKEN=значение_токена
```

Также необходимо иметь доступ для своего staff-пользователя на запись данных в топик, который будет использоваться при
нагрузочном тестировании. Для этого необходимо выполнить команду вида:

```bash
ya tool logbroker permissions grant --subject ${STAFF_LOGIN}@staff --path /market-health-stable/loadtesting --permissions WriteTopic
```

Вместо переменной `${STAFF_LOGIN}` нужно подставить свой логин на стаффе. Путь к топику
`/market-health-stable/loadtesting` также можно поменять, если по каким-то причинам для нагрузочного тестирования
используется другой топик.

Перед запуском `logbroker-gun` необходимо собрать патроны с помощью утилиты [samples-saver](
https://a.yandex-team.ru/arc_vcs/market/infra/market-health/loadtesting/cmd/samples-saver/README.md). Пример того, что
получается после работы `samples-saver`, представлен в файлах [ammo.jsonl](ammo.jsonl) и [writers.json](writers.json).

Также перед запуском утилиты `logbroker-gun` необходимо подготовить конфигурационный файл. Пример конфигурационного
файла можно посмотреть в [load.yaml](load.yaml). В основном все секции этого конфигурационного файла стандартны для
[пандоры](https://github.com/yandex/pandora) и их описание стоит смотреть в её документации. Если что-то не понятно, то
можно обращаться в чат [Yandex-Tank & Lunapark Support](https://t.me/+P7MZPuPR-6kN4K6P). Специфичной для утилиты
`logbroker-gun` является секция по конфигурированию пушки. Там нужно указать следующие параметры:
1. `topic`. Топик логброкера, в который будут заливаться сообщения при обстреле. Скорее всего нужно указать
   `/market-health-stable/loadtesting`, но при необходимости использовать другой топик можно поменять.
2. `database`. База данных логброкера. Скорее всего надо указать `/Root`. См. подробнее в [справке логброкера](
   https://logbroker.yandex-team.ru/docs/concepts/clusters_and_installations#installations_list)
3. `customWriterOptionsFile`. Файл с описанием писателей (в смысле клиентов логброкера в терминологии golang sdk, см.
   подробнее [тут](https://logbroker.yandex-team.ru/docs/interfaces/sdk/go#writer))

# Как запустить

Утилиту `logbroker-gun` необходимо запускать так, чтобы в её рабочей папке был бы файл `load.yaml` с необходимой
конфигурацией (в соответствии с описанием выше). Приложение завершается либо штатно после выполнения программы стрельб в
соответствии с заданными параметрами rps либо экстренно при получении сигнала SIGINT (Ctrl+C).

Необязательные параметры командной строки:
1. `max_writer_init_concurrency`. Максимальное количество писателей, которые инициализируются параллельно. Чем это
   значение больше, тем, в теории, должна быстрее проходить инициализация пушки. Но это только в том случае, если бы
   ресурсы логброкера были безграничны. А поскольку это не так, то приходится ограничивать максимальное количество
   параллельно инициализирующихся писателей, чтобы не получать при инициализации `rpc error: code = Unavailable`.
   Значение по умолчанию 10.
