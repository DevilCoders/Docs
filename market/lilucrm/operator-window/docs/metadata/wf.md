# Жизненный цикл

Жизненный цикл объектов позволяет изменять статус объектов, а так же настраивать граф возможных переходов между
статусами объекта. Тривиальным примером жизненного цикла объекта является статусная модель элементов справочника,
который имеет статусы активный и архивный: активные элементы справочника доступны для выбора в интерфейсе, а архивные
нет.

Жизненный цикл настраивается независимо для каждого метакласса объектов и наследуется по иерархии метаклассов.
 [wf.xsd](https://a.yandex-team.ru/arc_vcs/market/lilucrm/jmf/logic_wf/src/main/resources/xsd/wf.xsd) описывает
 возможные параметры конфигурации жизненного цикла.

Пример:
```xml
    <w:workflow metaclass="contact">
        <w:statuses initial="active">
            <w:status code="active">
                <w:title>
                    <c:value>Активный</c:value>
                </w:title>
            </w:status>
            <w:status code="archived" archived="true">
                <w:title>
                    <c:value>Архивный</c:value>
                </w:title>
            </w:status>
        </w:statuses>
        <w:transitions>
            <w:transition from="active" to="archived">
                <w:title>
                    <c:value>архивировать</c:value>
                </w:title>
            </w:transition>
            <w:transition from="archived" to="active">
                <w:title>
                    <c:value>извлечь из архива</c:value>
                </w:title>
            </w:transition>
        </w:transitions>
    </w:workflow>
```

Жизненный цикл объектов описывается тремя атрибутами бизнес-объекта:
- **status** - код текущего статуса
- **startStatusTime** - время перехода в текущий статус
- **archived** - признак архивности бизнес-объекта. Имеет значение true если текущий статус является архивным. Этот 
 атрибут используется для партиционирования таблиц, а так же эффективных выборок из базы данных (при усовии наличия
 необходимых индексов).

У объектов с жизненным циклом появляется возможность указывать обязательность заполнения атрибуа при изменении 
 статуса бизнес-объекта. Например, у сотрудника обязательно необходимо заполнять атрибут login только если он 
 неархивный (извлекается из архива или создается).

Пример:
```xml
    <w:workflow metaclass="employee">
        <w:statuses initial="active">
            <w:status code="active">
                <w:title>
                    <c:value>Активный</c:value>
                </w:title>
                <w:attributes>
                    <w:attribute code="login" preCondition="REQUIRE"/>
                </w:attributes>
            </w:status>
...
        </w:statuses>
    </w:workflow>
```
В этом примере мы указываем, что необходимо проверить обязательность атрибута при переходе в статус active.
 Проверка заполненности атрибута будет осуществляться на бэкенде при любом изменении статуса, а пользователю в
 интерфейсе при изменении статуса будет показана форма с предложением указать значение атрибута. Обязательность атрибута
 можно указывать не только при входе в статус, но и при выходе из статуса, например, у обращения при выходе из статуса
 в работе необходимо указать тему обращения (условие входа в статус задается с помощью preCondition, а выхода
 postCondition).

Условия заполнения атрибута входа и выхода из статуса могут быть:
- NONE - не требуется проверять значение атрибута (используется по умолчанию);
- OFFER - пользователю на форме смены статуса будет предложено заполнить значение атрибута, но пользователь может
 оставить значение атрибута пустым;
- REQUIRE - будет предложено пользователю заполнить значение атрибута на форме сменыны статуса, и это значение
 обязательно (если атрибут не будет указан пользователем и не будет заполнен триггером, то сервер не даст изменить
 статус объекта);
- FORCE_REQUIRE - по смыслу тоже самое, что и REQUIRE, но в интерфейсе будет показана форма с предложением указать
 значение атрибута при добавлении комментария (например, операторы изменяют статус тикета когда добавлют комментарий).
 
Помимо обязательности заполнения значения атрибута можно указать необходимость добавления комментария при смене статуса
 объекта. Это делается при помощи псевдо атрибута @comment. 
Пример:
```xml
...
<w:status>
  ...
  <w:attributes code="active">
    <w:attribute code="@comment" preCondition="REQUIRE"/>
  </w:attributes>
</w:status>
...
```

При изменении статуса объекта можно дополнительно настроить действия на вход и выход в статус. По сути это аналог
 триггеров, но выполняются непосредственно до смены статуса (действия на выход из статус) или сразу же после (деиствия
 на вход в статус). Триггеры же выполняются после смены статуса и выполнения действия на вход и выход в статус.
Пример:
```xml
...
<w:status code="active">
  ...
  <w:preActions>
    <w:handler id="doSomeone">
      <w:scriptCode>scriptCodeFromScriptStorage</w:scriptCode>
    </w:handler>
  </w:preActions>
</w:status>
...
```
В этом примере указано, что при входе в статус active необходимо выполнить скрипт c кодом scriptCodeFromScriptStorage.

