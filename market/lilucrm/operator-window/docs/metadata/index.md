# Метаинформация

Примером метаинформациии является [information_schema](https://www.postgresql.org/docs/13/information-schema.html) в 
реляционных базах данных. При работе с реляционной БД мы вносим изменения в information_schema при помощи 
[DDL](https://www.postgresql.org/docs/13/ddl.html) операции, а БД на основании information_schema определяет способ
хранения информации и ее состав. 

Каждому бизнес-объекту Единого окна соответствует **метакласс**, которые описывает все атрибуты бизнес-объекта, правила
хранения объектов метакласса и другие особенности поведения бизнес-объекта.

Метаклассы расширяют друг друга, что очень напоминает наследование в ООП, но каждый метакласс может расширять не более
одного метакласса (как организовано наследование в java).

Метаклассы бывают трех типов:
1. абстрактный - требуется для выноса общего поведения множества объектов;
1. класс - описывает уже конкретные бизнес-сущности. В свою очередь может быть типизированным или нет.
1. тип - описывает типы классов.

При этом абстрактный метакласс может расширять только абстрактный метакласс; класс может расширять только абстрактный
метакласс, а тип может расширять только классы или другой тип.

![Пример иерархии метаклассов](entityHierarchy.png "Пример иерархии метаклассов")

В корне дерева метаклассов лежит абстрактный метакласс **entity**, описывающий атрибуты присущие всем бизнес-объектам
в системе: **gid** и **metaclass**. **gid** - это глобальный в рамках системы идентификатор объекта. По нему всегда
можно однозначно определить бизнес-объект. Так же у любого бизнес-объекта можно узнать метакласс.

**bo** - это основной бизнес объект в системе. Метакласс, как и entity, является абстрактным. Его предназначение
определить общую логику работы с бизнес-объектами. Например, все бизнес-объекты метаклассов расширяющих **bo** 
будут храниьтся в нашей БД, иметь атрибут creationTime, который автоматически будет заполняться временем создания
бизнес-объекта. Так же для всех бизнес-объектов будет вестись история изменения объекта: в отдельную таблицу будет
записывать кто, когда и какие атрибуты бизнес-объекта менял, какие у атрибутов были значения и какие стали.

Метаклассы **employee** и **ou** расширяют метакласс **bo**, и обладают всеми свойствами **bo**, но это уже не
абстрактные метаклассы, и они описывают конкретные бизнес-объекты. Для этих метаклассов, в отличие от bo в БД
будут созданы таблицы для хранения бизнес-объектов. Для метакласса employee будет создана таблица **tbl_employee**,
а для метакласса ou таблица **tbl_ou**. Для всех атрибутов определенных в метаклассе **employee**, а та же определенных
в абстрактных метаклассах, которые расширяет метакласс employee, будут созданы колонки в таблице tbl_employee
совпадающие с кодом атрибута. Если рассматривать иерархию метаклассов с точки зрения хранения бизнес-объектов в 
БД, то абстрактный метакласс описывает [MappedSuperclass](https://docs.jboss.org/hibernate/orm/5.4/userguide/html_single/Hibernate_User_Guide.html#entity-inheritance-mapped-superclass),
Класс - корень иерархии бизнес-объектов со способом отображение [Single table](https://docs.jboss.org/hibernate/orm/5.4/userguide/html_single/Hibernate_User_Guide.html#entity-inheritance-single-table),
а Тип - это разновидность бизнес-объектов Класса, которые хрант все свои атрибуты в той же таблице, что и Класс, который
он расширяет.

XSD схема конфигурации метаклассов описана в [metaclass.xsd](https://a.yandex-team.ru/arc_vcs/market/lilucrm/jmf/metadata/src/main/resources/xsd/metaclass.xsd),
а XSD схема описания основных типов атрибутов в [default_attribute_types.xsd](https://a.yandex-team.ru/arc_vcs/market/lilucrm/jmf/attributes/src/main/resources/xsd/default_attribute_types.xsd)

## Пример описания метакласса

```xml
<m:metaclass abstract="true">
    <m:fqn>entity</m:fqn>
    <m:title>
        <c:value>Корневой метакласс</c:value>
    </m:title>
    <m:interfaces>
        <m:interface>ru.yandex.market.jmf.entity.Entity</m:interface>
    </m:interfaces>
    <m:attributes>
        <m:attribute editable="false">
            <m:code>gid</m:code>
            <m:title>
                <c:value>Идентификатор объекта</c:value>
            </m:title>
            <m:type code="string"/>
        </m:attribute>
        <m:attribute editable="false" required="true">
            <m:code>metaclass</m:code>
            <m:title>
                <c:value>Метакласс</c:value>
            </m:title>
            <m:type code="metaclass"/>
        </m:attribute>
    </m:attributes>
</m:metaclass>
```

Здесь:
1. interface  - java-интерфейс, который реализуют объекты этого метакласса. Интерфейс является опциональным параметром
и нужен для упрощения работы с бизнес-объектами с логикой реализованной в java-коде.
1. так же описаны два атрибута gid строкового типа и metaclass возвращающий метакласс текущего бизнес-объекта.
