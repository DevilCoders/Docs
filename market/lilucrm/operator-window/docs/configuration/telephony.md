# Телефония
В качестве провайдера телефонии используется **Voximplant**

# Доступы
**Админ-панель**: [страница](https://manage.voximplant.com/auth/subuser/yamarket)
**Логин/Пароль**: [страница](https://yav.yandex-team.ru/secret/sec-01e6k8rvbwp89gqwzknyb2kh20/explore/versions)

# Заведение нового номера и бренда
1. Купить новый номер (тестовый или продовый) можно [по ссылке](https://manage.voximplant.com/numbers/my_numbers)
2. Купленный номер нужно привязать к тестовому или продовому приложению. Для этого нужно:
    - зайти на страницу приложений внутри [админ-панели вокса](https://manage.voximplant.com/applications)
    - выбрать нужное приложение и на странице приложения выбрать пункт "Номера" в левом меню 
    - на вкладке "Доступные" должен быть созданный в п.1 номер с возможностью привязать его к текущему выбранному приложению
    - выбрать правило production (для продовых звонков)
3. Завести новый бренд в системе. В нем указать номер из п.1 как входящий и/или исходящий номер
4. Настроить роутинг в [groovy-скрипте](https://a.yandex-team.ru/arc_vcs/market/lilucrm/operator-window/src/main/resources/scripts/voximplantCreateTicket.groovy) для нового бренда и по аналогии завести тригер для создания тикета (или воспользоваться существующими).
5. Создать папку с файлами для IVR для нового бренда (см. раздел про IVR)

_Опционально_: может потребоваться новый метакласс для тикета. Завести можно по [аналогии с задачей](https://st.yandex-team.ru/OCRM-6107)

# Доп. настройки
1. В карточке пользователя в полях Линии и Очереди должны быть выбраны значения, связанные с телефонией 
2. У пользователя в профиле должна быть галочка "Требуется учетная запись телефонии"
3. В браузере должны быть выданы разрешения на использование микрофона и показ нотификаций
4. У пользователя должны быть настроены права на соответствующие объекты (очереди, линии, тикеты)

# Как выполнить тестовый звонок
1. Позвонить на номер +7 (499) 938-43-62 (или, если звонок с рабочего телефона, 98(499)938-43-62)
2. Ввести добавочный номер. Например: 
    - 699-102-803 (Покупки)
    - 699-100-063 (Покупки с IVR перед разговором)

# Внесение правок в сценарий телефонии
Лучше всего прочитать [на вики](https://wiki.yandex-team.ru/market/development/operator-window/voximplant-test/#algoritmobnovlenijascenarijatelefonii)

_Примечание:_ В сценарии есть блок с номерами телефонов для брендов (внутри const store). Вносить номера в этот блок для нужного бренда придется самостоятельно
```
phones: {
        beru: {
            prod: ['74999384454'],
            preprod: ['699102285'],
            dev: ['699102803'],
        },
        super_chek: {
            prod: ['74999384491'],
            preprod: ['699102289'],
            dev: ['699102135'],
        }
    }
```

# Роутинг звонков между тестовыми стенами
1. Зайти в админ-панель (см. пункт Доступы выше)
2. Выбрать там необходимое приложение
3. В разделе сценариев создать новый сценарий или изменить уже существующий:
    - указать нужные номера для брендов
    - указать API-сервер в константе store, параметр host
    ```
    https://api-external.ow.tst.vs.market.yandex.net - 1ый тестинг 
    https://api-external.ow2.tst.vs.market.yandex.net - 2ой тестинг
    ``` 
    ```
    const store = {
        log_url: '',
        env: env,
    ...
        host:
            env !== 'dev'
                ? 'https://api-external.ow.vs.market.yandex.net'
                : 'https://api-external.ow2.tst.vs.market.yandex.net',
        applicationName: env !== 'dev' ? 'prod' : 'test',
    ...
    }
    ```
    - сохранить правки
    
4. Перейти в раздел Роутинг
5. Создать новое правило роутинга или изменить существующее
    - указать имя
    - указать добавочный номер
    - выбрать сценарий, который будет применяться к этому номеру
    - сохранить правки
6. Проверить работу правила через пукнт "Тест правил". Убедиться, что по введенному добавочному применяется указанный выше скрипт.
Примечание: в списке правил роутинга их приоритет можно изменить drag&drop, просто перетащив правило выше

# IVR
Все аудио проигрываемые пользователю находятся в S3-MDS. 

Бакет на [yc.yandex-team.ru](https://yc.yandex-team.ru): [market-operator-window-storage](https://yc.yandex-team.ru/folders/foo97hhci4pr8bcqsncv/storage/bucket/market-operator-window-storage)
Для доступа к бакету нужна роль `S3-MDS Окно оператора LiluCRM (OCRM) / Service account role / Admin`. Запросить ее нужно через IDM. 

- файлы для IVR конкретного бренда лежат по пути `telephony_audio/<brand-code>`, где `<brand-code>` - код бренда.
- файлы внутри папок доступны по url вида `https://market-operator-window-storage.s3.yandex.net/telephony_audio/beru/repeat.mp3`, где beru - код бренда, repeat.mp3 - имя файла 

При заведении нового бренда, для которого нужен IVR, нужно завести для него свою папку в бакете (имя = код бренда) и скопировать туда mp3 файлы (из любой другой папки). Если этого не сделать - пользователь будет просто слышать тишину

### Если файл нужно заменить: 
Вариант 1: удалить старый файл из папки бренда(ов) и положить на его место новый с тем же именем.
Вариант 2: залить в папки новый файл. В скрипте телефонии исправить нужное имя файла на новое.
