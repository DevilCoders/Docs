# Акции

**Акция** - набор действий над множеством [идентификаторов пользователя](offline_segmentator.md#identifikatory-polzovatelya). Исходное множество идентификаторов получается путем вычисления сегмента. В одной акции может быть предусмотрено несколько вариантов, каждый из которых включает в себя собственную последовательность шагов. Логика разделения идентификаторов аналогична используемой в промо-рассылках. При прохождении через акцию каждый идентификатор обладает произвольным набором переменных, который может меняться в процессе прохождения шагов.

**Шаг акции** - атомарный этап в порядке действий, предусмотренным вариантом акции. Каждый шаг имеет вход (исходный набор идентификаторов и переменных, связанных с ними) и выход (результирующий набор идентификаторов и переменных, связанных с ними). Шаги соединяются друг с другом таким образом что на вход каждого шага подается выход предыдущего. Логически шаги устроены таким образом что они ничего не знают как о шагах, стоящих до них, так и о шагах после. Шаги бывают разных типов каждый из которых отличается логикой работы и набором настроек. В процессе работы каждый шаг может (в зависимости от его типа):
* Изменять множество идентификаторов, пришедших к нему на вход. Таким образом, на выходе шага либо могут добавиться новые идентификаторы (на данный момент шагов, добавляющих идентификаторы нет _2020-12-17_), либо будет отфильтрована часть тех что была на входе. В теории допускается то что множества идентификаторов на входе и выходе шага вообще не будут пересекаться.
* Изменять значения переменных, связанных с любым идентификатором

## Типы шагов

### Фильтрация по условиям

Проверяет идентификаторы, пришедшие на вход, на соответствие заданным условиям. Идентификаторы, не удовлетворяющие условиям, не попадают на выход. Изменений в связанные переменные при этом не вносится.

Условия фильтрации бывают разных типов, каждый со своими настройками:
* **Есть мобильное приложение** - оставляет только те идентификаторы для которых можно вычислить устройство на котором установлено определенное приложение. Вычисление устройств при этом происходит по той же логике по которой это делает соответствующий шаг отправки. Это условие полезно применять если, например, нужно начислить бонусы только тому кого можно потом оповестить через push-сообщение.
* **Есть подписка на email-рассылки** - оставляет только те идентификаторы для которых можно вычислить email с определенной подпиской, указанной в настройках условия. Вычисление при этом происходит по той же логике по которой это делает соответствующий шаг отправки. Это условие полезно применять если, например, нужно начислить бонусы только тому кого можно потом оповестить через email.

### Дедубликация по Крипте

Проверяет идентификаторы, пришедшие на вход, на принадлежность одному и тому же пользователю по данным крипты и mCRM. При этом на выход попадает только по одному идентификатору для каждого пользователя. При выборе идентификатора, который следует оставить, puid'ам отдается предпочтение. Т. е. в случае если если будет установлено что несколько yuid'ов и один puid, пришедших на вход шага, принадлежат одному и тому же человеку, на выход попадет именно puid. Шаг не вносит изменений в переменные.

### Отправка email-сообщений

Отправляет email-сообщения, используя шаблон, указанный в настройках шага. Выход шага всегда аналогичен его входу. Перед отправкой происходит вычисление адресов. Логика вычисления при этом зависит от типа идентификатора:
* `PUID` - используется логика аналогичная [используемой в сегментаторе](offline_segmentator.md#passport-ids-handling). Берутся только паспортные адреса.
* `YUID` - для поиска email используется [склейка](offline_segmentator.md#linking). Для каждого yuid выбирается адрес, находящийся с ним в одном графе. При этом берутся адреса не только по прямым связям.

Найденные адреса проверяются на наличие подписки, выбранной в настройках шага. Эта же подписка используется для генерации ссылки на отписку.

{% note warning %}

Как упоминалось выше, шаги устроены таким образом что они ничего не знают о шагах, стоящих перед ними. Поэтому вычисление адресов для отправки происходит без оглядки на сегментатор и в итоге могут быть получены адреса, противоречащие условиям сегментации. Т. е., если у нас в сегменте проверяется одна подписка, в рассылке из акции указывается другая, то письма могут получить те, кто по условиям сегмента был не должен. Для того чтобы исключить из акции идентификаторы с адресами на которые по каким-то причинам нельзя отправлять письма нужно использовать шаг **Фильтрация по условиям**.

{% endnote %}

### Отправка push-сообщений

Отправляет push-сообщения, используя шаблон, указанный в настройках шага. Выход шага всегда аналогичен его входу. Перед отправкой происходит вычисление устройств. Логика вычисления при этом зависит от типа идентификатора:
* `PUID` - используется логика аналогичная [используемой в сегментаторе](offline_segmentator.md#passport-ids-handling).
* `YUID` - для поиска устройств используется [склейка](offline_segmentator.md#linking). Для каждого yuid выбирается устройство, находящиеся с ним в одном графе.

{% note warning %}

Как упоминалось выше, шаги устроены таким образом что они ничего не знают о шагах, стоящих перед ними. Поэтому вычисление устройств на которые будут отправлены оповещения происходит без оглядки на сегментатор и в итоге могут быть получены устройства, противоречащие условиям сегментации. Для того чтобы исключить из акции идентификаторы с устройствами на которые по каким-то причинам нельзя отправлять уведомления нужно использовать шаг **Фильтрация по условиям**.

{% endnote %}
