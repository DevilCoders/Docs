# Offline-сегментатор

## Ключевые понятия

**Офлайн-сегментатор** - система, предназначенная для поиска множества _идентификаторов пользователей_, удовлетворяющих определенному _сегменту_ при выбранном _режиме склейки_.

**Сегмент** - набор _условий сегментации_, между которыми заданы определенные логические отношения (`и` , `или` , `и не`). Условия могут объединяться в группы, которые так же будут иметь логические отношения с другими группами/условиями. Идентификатор пользователя попадает в сегмент только в том случае если он удовлетфоряет итоговому логическому выражению, составленных из условий.

**Условие сегментации** - атомарная часть сегмента, задающая критерий которым должны удовлетворять идентификаторы пользователей. Каждое условие может работать только с идентификаторами определенных типов для которых можно однозначно определить подходит идентификатор под условие или нет.

### Идентификаторы пользователя

**Идентификатор пользователя** - некоторая строка или число однозначно идентифицирующая пользователя в определенном контексте. Идентификаторы бывают разных типов:
* `PUID` - учетная запись пользователя в яндексе (в Паспорте). Является самым удобным идентификатором для отслеживания действий залогиненых пользователей.
* `YUID` - специальная браузерная кука, которой которой обладает каждый пользователь, использующий любой сервис яндекса через браузер. По сути идентифицирует отдельный браузер. Поскольку такие идентификаторы выдаются каждому пользователю, ими удобно пользоваться для отслеживания незалогиненых пользователей. Важно учитывать, что одним браузером могут пользоваться несколько человек - например, супруги. Или один человек может очистить cookies в браузере и иметь уже другой YUID.
* `EMAIL` - email адрес пользователя.
* `UUID` - идентификатор установки мобильного приложения. У каждого устройства он уникален. Удобно использовать для отслеживания пользователя через мобильное приложения. Используется как идентификатор для вычисления device-id который, в свою очередь, используется для отправки push-уведомлений. При переустановке приложения изменится UUID.

{% note warning %}

Идентификатор пользователя - это не сам пользователь (в смысле отдельного человека). Одному человеку может принадлежать множество идентификаторов разных типов. У него может быть несколько почтовых ящиков, браузеров, мобильных устройств с приложением и даже яндексовых учеток. Сегментатор строит сегменты не из пользователей а из **их идентификаторов**.

{% endnote %}

### Склейка идентификаторов {#linking}

Часто бывают случаи когда из сегмента, состоящего из условий, определяющих принадлежность одного типа идентификаторов, нужно получить идентфикаторы другого типа. Пример: есть сегмент состоящий из единственного условия "Сегмент крипты" (работает по YUID). На него нужно отправить email-рассылку (т. е. нужен сегмент идентификаторов типа EMAIL). Про адреса заданное условие ничего не знает. В таком случае сегментатор использует возможность использовать _склейку идентификаторов_.

**Склейка идентификаторов** - данные, указывающие на принадлежность нескольких разных идентификаторов одному живому пользователю. В процессе использования сервиса пользователем его различные идентификаторы могут быть замечены вместе. В таком случае делается вывод что они могут принадлежать одному человеку. Информация о связи пары идентификаторов сохраняется. Со временем, идентификаторы обрастают связями и для каждого живого пользователя образуется граф идентификаторов.

При вычислении сегмента из примера будут найдены yuid'ы, принадлежащие заданным сегментам крипты и затем с помошью склейки будут найдены email-адреса пользователей которым принадлежат найденные yuid'ы.

{% note alert %}

Cклейка носит вероятностный характер. Это значит что если разные идентификаторы получили связь между собой это не обязательно значит что они принадлежат одному человеку. Классическим примером такого случая может быть семья у которой есть один общий десктопный компьютер. Таким образом в одном и том же браузере могут периодически использоваться разные учетки и есть вероятность того что они сольются в одного пользователя хотя на самом деле принадлежат разным людям.

{% endnote %}

{% note warning %}

Как будет видно на иллюстрациях ниже, по склейкам в сегмент добавляются только идентификаторы типы которых отличаются от тех с которыми работает условие. Т. е. если речь идет например об условии _"Обладатели подписки Яндекс.Плюс"_ (работает по PUID) то в результате будут **только те PUID'ы которые вернуло условие**.

{% endnote %}

Для того чтобы лучше удовлетворять потребностям в разных кейсах, сегментатор умеет работать с тремя режимами склейки:

* **Без склейки** - как следует из названия, склейка никак не используется. Обеспечивает максимальную точность сегментирования: в сегмент попадут только те идентификаторы которые удовлетворяют каждому условию сегментации. В таком режиме нельзя построить сегмент из идентификаторов любого типа. Доступные типы зависят от условий, которые присутствуют в сегменте.
* **Прямые связи** - при использовании склейки используются только непосредственные связи между идентификаторами. Это значит что в сегмент попадут только идентификаторы которые когда-то были замечены вместе с идентфикаторами, которые действительно удовлетворяют условиям. В примере на картинке, в случае если `PUID-1` напрямую удовлетворяет условию сегментации, в сегмент дополнительно подтянутся `EMAIL-3` и `YUID-1`.

![](../images/direct_links.png =300x300)

* **Все связи** - при использовании склейки используются все связи, которые удалось обнаружить (в т. ч. опосредованные). В случае если, например, для рассылки требуется максимальный охват но при этом высоких требований к точности у неё нет лучше всего при расчете сегмента использовать этот режим.

![](../images/all_links.png =300x300)

### Особенности работы с паспортными учетками {#passport-ids-handling}

Сегментатор предоставлять возможность получения идентификаторов разного типа из PUID без применения склейки. Например из сегмента "Обладатели подписки Яндекс.Плюс, подписанные на рекламу" можно получить email'ы для рассылки без использования склейки, не смотря на то что первое условие работает исключительно по PUID а второе по EMAIL.

Для каждого типа вычисление происходит по своей логике:

* `EMAIL`. Для каждой учетки берется email из её настроек на Маркете. В случае если пользоваль ничего не настраивал берется паспортный email (его тоже может не быть). Вычисление email'ов производися только для учеток из под которых проводилась подписка.
* `UUID`. Для каждой учетки выполняется поиск приложения в котором она залогинена на данный _момент_.

{% note info %}

При вычислении сегмента возможно только вычисление PUID в EMAIL или из PUID в UUID. Обратного перехода пока не предусмотрено.

{% endnote %}

## Порядок вычисления сегмента

При вычислении каждого сегмента процесс проходит через несколько этапов.

### 1. Вычисление идентификаторов удовлетворяющих условиям

На этом этапе для каждого условия в сегменте вычисляется множество идентификаторов пользователя которые ему удовлетворяют. В это множество попадают идентификаторы только тех типов, которые поддерживаются конкретным условием.

### 2. Применение склейки

Для каждого условия берется множество идентификаторов, полученное на предыдущем этапе, и к нему добавляются идентификаторы, связанные с исходными, связями, соответствующими выбранному [режиму склейки](#linking). В случае если в качестве режима склейки установлего "Без связей", этот этап пропускается.

### 3. Работа с паспортными идентификаторами (PUID)

Для каждого условия берется множество идентификаторов, полученных на предыдущем шаге, из него выбираются puid'ы и для каждого из них выполняется поиск соответствующих uuid'ов и email'ов (логика по которой выполняется поиск описана [выше](#passport-ids-handling). Найденные идентификаторы добавляются к общему множеству. При этом для каждого идентификатора, запоминается puid из которого он был вычислен. Это нужно для того чтобы на следующем этапе не путать email, вычисленный из одного puid'а с тем же email'ом, вычисленным из другого puid'а (при пересечении они не должны приниматься за один email).

### 4. Вычисление финального результата

Берутся множества идентификаторов, вычисленные на предыдущих шагах, после чего они начинают объединяться и пересекаться друг с другом согласно отношениям между условиями, заданных в конфигерации сегмента. Получившееся множество является построенным сегментом.

## Примеры расчета сегментов

### Расчет сегмента без склеек

Построение сегмента email'ов. В случае если используются только условия, работающие по EMAIL или PUID такой сегмент можно построить без использования склеек.

![](../images/example_diagrams_2.png)

### Расчет сегмента с прямыми связями

Построение сегмента email'ов. Сегмент для простоты состоит из одного условия, работающего с YUID. При этом система знает о двух пользователях у каждого из которых сложился собственный граф идентификаторов.

![](../images/example_diagrams.png)
