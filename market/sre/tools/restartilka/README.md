# restartilka
Сервис для самостоятельного рестарта приложений разработчиками

##Решаемая задача:
Что бы разработчики могли сами перепускать свой сервис и снимать тред дамп, когда надо

##Требования к системе:
1. перепускать может, только авторизованный пользователь
2. сценарий перезапуска задан заранее и отревьювен админами
3. сервисы перепускаются последовательно, по машинно 
4. любой перезапуск логируется на удалённый сервер
5. любой перезапуск должен содержать причину/описание зачем это делается

##Возможные способы решения:
1. кондуктор
2. **отдельное приложение(допустим на джанге) с веб-мордой**
3. специальный шелл на сервере
4. в телеграмме через бота

---

##Логика работы:
###Работа с фронтендом
0. *DISCLAIMER: следующие пункты поменяют свою логику, после выполнения этого тикета https://st.yandex-team.ru/CONDUCTOR-1639*
1. Открываем https://dukeartem01ed.yandex-team.ru/
2. Заполняем форму: 
	1. В название сервиса вводим сервис из кондуктора(c.yandex-team.ru/service/), например nginx
	2. В группу машин указываем группу из кондуктора, например market_front-testing (дырки сейчас есть, только до тестинга, для продакшена скорее всего джанга упадёт)
	3. branch сейчас не на что не влияет, но будет, когда выполнится тикет выше
	4. оставляем любой коммент
3. На следующей странице можем проверить, что из кондуктора пришло всё верно, если хотим выполнить не на всех машинах снимаем нужные галочки, после нажимаем зелёную кнопку
4. При данных параметрах мы получим ответ 403, потому что на клиентах не установлены нужные скрипты(речь о них пойдёт ниже)

###Что происходит за сценой:
1. После того, как мы послали запрос через форму, django пойдёт по каждой из указанных машин на порт 3131, там его будет ждать [restart-task.py](https://github.yandex-team.ru/dukeartem/restartilka/blob/master/scripts/restart-task.py), который проверит токен(расскладывается из секретных датасорсов фронтенду и клиентским скриптам) и создаст в заданном каталоге файл %service%.task. 
2. На клиентской машине по крону вызывается [cron-restart-task.py](https://github.yandex-team.ru/dukeartem/restartilka/blob/master/scripts/cron-restart-task.py), который смотрит есть ли для него файлы %service%.task и если есть идёт с ними в кондуктор в ручку (https://c.yandex-team.ru/api/generator/kmeaw.service?name=nginx) и возвращает скрипт для исполнения. 
3. Приводит этот скрипт в выполняемый вид, исполняет, грохает задачу

---

##Зависимости
```apt-get install python-pip python-dev python-setuptools libxml2-dev libxml2-utils libxslt1-dev ipdb libmysqlclient-dev python-kazoo```

```pip install --disable-pip-version-check -i https://pypi.yandex-team.ru/simple/ -r requirements.txt```

```pip install mysql-python```

```(for dev) pip install --disable-pip-version-check -i https://pypi.yandex-team.ru/simple/ ipdb```

##Дырки
###Продакшен
```blackbox.yandex-team.ru 80,443```
```staff-api.yandex-team.ru 80,443```
```st.yandex-team.ru 80,443```
```%market_zookeeper-stable-general 2181```
###Тестинг
```%market_zookeeper-testing-general 2181```
```staff-api.test.yandex-team.ru 80,443```
```st-test.yandex-team.ru 80,443```

----

##Будующие хочушки:
1. CONDUCTOR-1639 переделать на автоматическое получение группы по имени пакет, ветки и проекту
2. привести админку в порядок:
	1. добавить в админку статистику по перезапускам
	2. сделать нормальные поля в админке
3. включить проверки на клиентских скриптах:
	1. тега - ~~машина/группа~~ и пакет
	2. ~~существование пакета~~
4. добавить сборку через сендбокс
5. ~~перенести креденшелы соединения с базой фронта в датасорсы~~
6. добавить отсылку в здоровье
7. ~~заменить везде id на pk (из-за того, что id встроенная переменная)~~
8. ~~сделать поддержку #package# в шаблонах скрипта рестарта~~
9. ~~сделать проверку существования /etc/datasources/restartilka.py в postinst и ломать его без этого файла~~
10. ~~Сделать мониторинг для сервиса(простую ручку /ping) можно по аналогии с тулзовой~~
11. Сделать хоть какие-то тесты