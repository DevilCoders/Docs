# Deploy Preparer #

## Назначение ##

**Deploy Preparer** - это небольшая утилита, которая по описанию в yaml-файле создает директории, линки, генерит конфигурационные файлы из шаблона.

Он крайне простой и имеет минимум функциональности.

## Пример использования ##
```shell script
# Получение справки
./bin/dpreparer --help

# Создание нового манифеста из шаблона
./dpreparer new-manifest -p "${path_to_new_manifest}"

# Запуск манифеста
./dpreparer manifest execute
```
## Формат yaml манифеста ##

Полную схему yaml-манифеста можно найти в файле [lib/schemes/schemes.py](lib/schemes/schemes.py)

Рассмотрим небольшой пример:
```yaml
- name: application
  dirs:
    - name: /tmp/dpreparer/test1
      mode: 700
    - name: /tmp/dpreparer/test2
      mode: 777
  links:
    - name: /tmp/dpreparer/test3
      target: /tmp/dpreparer/test1
  files:
    - name: /tmp/dpreparer/test4.lock
      mode: 600
  split_secrets:
    - name: /app/market-secrets/secret.json

- name: additional
  templater:
    source: examples/templates
    destination: /tmp/dpreparer/out_templates
  dirs:
    - name: /tmp/dpreparer/test4
    - name: /tmp/dpreparer/test5
  links:
    - name: /tmp/dpreparer/test6
      target: /tmp/dpreparer/test4
  certificate:
    name: selfsigned
    path: /etc/ssl/
    years: 10
    key_len: 2048
    split: True
    subject:
      country: RU
      locality: Moscow
      organization: Yandex LLC
      organizational_unit: ITO

- include:
    - manifest: /tmp/path_to/manifest.yml
```

Данный манифест включает два блока: `application` и `additional`. Имена блокам можно задавать на свое усмотрение.

Каждый блок включает в себя одну или несколько секций. Секций может и совсем не быть, ошибки это не вызовет. Всего разных секций в одном блоке может быть три: `dirs`, `links`, `templater`.

### Секции dirs, links и files ###

Секции `dirs`, `links` и `files` описывают какие директории или файлы и с какими правами необходимо создать.

Параметры секции задаются в списке.

Общие параметры:
* **name** - (обязательный) путь до директории или файла. Если промежуточных директорий не существует, dpreparer их создаст.
* **state** - (опциональный) целевое состояние файла или директории. `present` для создания, `absent` для удаления и `clean` для очистки.
Для каталогов очистка рекурсивно удаляет все файлы внутри него, оставляя сам каталог, для файлов - стирает из содержимое, для симлинков - удаляет симлинк и создает на его месте пустой файл.
Значение по умолчанию `present`.
* **mode** - (опциональный) права на директорию или файл, например `755`.
* **owner** - (опциональный) владелец директории или файла, например `www-data`.
* **group** - (опциональный) группа владелец директории или файла, например `www-data`.

Особые параметры:
* **content** - (опциональный, только для `files`) содержимое файла, который будет создан.
Если файл уже существует, содержимое не будет изменено.
* **target** - (обязательный, только для `links`) путь, куда ссылка должна указывать.

### Секция templater ###

Секция `templater` описывает, откуда брать шаблоны для генерации и куда складывать результат.

При этом права доступа будут скопированы от шаблона, на основе которого генерится итоговый файл.

Допустимые параметры:
* **source** - (обязательный) путь до директории с шаблонами.
* **destination** - (обязательный) путь до директории, куда шаблоны будут складываться.

При генерации файлов будет в точности воспроизведена структура директорий с шаблонами из параметра **source**. Но есть нюансы. Если в директории нет ни одного файла с шаблоном - она будет опущена.

### Секция certificate ###

Секция `certificate` создает самоподписной сертификат, который можно использовать в nginx для шифрования соединения.

Допустимые параметры:
* **name** - (обязательный) - Имя файла сертификата и ключа без расширения. Например, `selfsigned`.
* **path** - (обязательный) - Путь к каталогу, в который стоит положить файл(ы) с сертификатом и ключом.
* **years** - Количество лет, в течение которых сертификат будет действителен. По умолчанию `10`.
* **key_len** - Длина ключа. Может быть только 1024, 2048 или 4096. По умолчанию `2048`.
* **split** - Разделять ли ключ и сертификат по отдельным файлам (.key и .pem)
или объединить их в один (.crt). По умолчанию `True`.
* **subject** - Значения, которыми заполнять поле Subject сертификата. По умолчанию следующие значения:
  * **country** - Страна. По умолчанию `RU`.
  * **locality** - Город. По умолчанию `Moscow`.
  * **organization** - Организация. По умолчанию `Yandex LLC`.
  * **organizational_unit** - Подразделение. По умолчанию `ITO`.

### Секция split_secrets ###

Секция `split_secrets` принимает на вход имя файла с [мультисекретом Y.Deploy в формате JSON](https://deploy.yandex-team.ru/docs/concepts/pod/podagentpayload/resources/staticresource#multisecret)
и разделяет его на отдельные файлы по имени ключа секрета, [как в Nanny](https://wiki.yandex-team.ru/runtime-cloud/nanny/secrets/#deliver-as-file).

Допустимые параметры:
* **name** - (обязательный) - Имя файла c мультисекретом Y.Deploy.
* **parent_path** - (опциональный) путь, по которому сохранять файлы. По умолчанию - каталог, содержащий файл c мультисекретом Y.Deploy.
* **mode** - (опциональный) права на директорию или файл, например `755`. По умолчанию, 600.
