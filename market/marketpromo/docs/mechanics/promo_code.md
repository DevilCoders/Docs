# Промокод (promo-code, MARKET_COUPON, MARKET_PROMOCODE)
1. [Общее описание механики](#general)
2. [Реферальные промокоды](#ref)

## Описание { #general }
Возможность получить рублёвую или процентную скидку на товар, выполнив условия промокода и введя его в корзине.

Промокод на товар
![image](https://jing.yandex-team.ru/files/eandreyf/2022-04-14_15-19-12.png)

Промокод с ограничением по сумме
![image](https://jing.yandex-team.ru/files/eandreyf/2022-04-14_15-19-40.png)

Промокод на подборку
![image](https://jing.yandex-team.ru/files/eandreyf/2022-04-14_15-20-09.png)

{% include [design](../_includes/design.md) %}

### Способы заведения
1. Описание акции [через ки](../create/ciface.md), 1Р/3Р ассортимент [через лоялти](../create/loyalty/promo_code.md)
FBY✅️ FBS✅️ DBS✅️ Экспресс✅️
2. Описание акции [через ки](../create/ciface.md), 3Р ассортимент партнёр самостоятельно заводит [через ПИ](../create/pi.md)
FBY✅️ FBS✅️ DBS✅️ Экспресс✅️
3. Партнёр может самостоятельно завести акцию в ПИ
FBY✅️ FBS✅️ DBS✅️ Экспресс✅️
4. Маркетинговые акции за наш счёт на 1Р/3Р ассортимент [через лоялти](../create/loyalty/promo_code.md)
FBY✅️ FBS✅️ DBS✅️ Экспресс✅️

### Места отображения
1. На товар: все сниппеты и места выдачи (виджеты/выдачи/карточка/корзина). По настройке можно скрыть с фронта
2. Ограничение по сумме: карточка/корзина (по настройке можно скрыть с фронта)

### Применение промокода
Чтобы применить промокод в корзине, нужно сначала его скопировать в карточке товара. Затем необходимо перейти в корзину и вставить скопированный промокод в поле для ввода промокода.

### Настройки акции
1. **Бюджет**. Акция может бюджетироваться. При достижении расходов по акции определённого уровня, она автоматически отключается и пропадает с карточек товаров
2. **Скрыть промокод с Карточки модели (КМ)**. При установке этой галки промокод будет скрыт с КМ и для него невозможно будет создать лендинг по id акции. Промокод будет применяться в корзине
2. _Другие интерфейснонезависимые вещи..._

## Реферальные промокоды
Акция под эти промокоды была заведена один раз, сейчас она работает и другие заводить не нужно
[Акции в лоялти](https://admin.market-loyalty.market.yandex-team.ru/promos/1?term=реф)

Каждому залогиненному пользователю доступен экран реферальной программы, где он может получить промокод для друга и условия его использования.
Этот промокод не может применить сам пользователь.
Промокод дает фиксированную скидку в рублях на заказа, а приглашенному начисляются баллы плюса.

В механике участвуют два человека: реферер (тот, кто поделился промокодом) и реферал (тот, кто им воспользовался).
Рефереру каждый день выдается промокод, который действует N дней (сейчас 30).
Промокоды берутся из общего пула промокодов и выдаются пользователям повторно при их освобождении.
При оформлении заказа с реферальным промокодов создается отложенное начисление баллов кешбека для реферера, которое исполняется после получения заказа.

## Технические детали
`MARKET_COUPON` - старая архитектура промокодов. Используется, когда нужны генерируемые промокоды. В основном, это сорри-промокоды и реферальные промокоды.

`MARKET_PROMOCODE` - актуальная архитекутра промокодов. Есть привязка к пользователю, есть интеграция с антифродом. Используем её по дефолту

## FAQ
### Почему промокод на 500р, а реальная скидка 502р
При покупке нескольких товаров со скидкой по промокоду мы должны скидку равномерно распределить по товарам.
В результате может оказаться дробная стоимость товара, мы округляем до целого в пользу пользователя.

**Пример**
Товар стоит 100р.
В корзине 2 товара.
Промокод на 3р.

На каждый товар приходится скидка 1.5р, цена после скидки 98.5р, округляем в пользу пользователя, получаем 98р.

Итого, в корзине 2 товара по 98р, общая скидка 4р, хотя промокод на 3р.
