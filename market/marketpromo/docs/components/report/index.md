# Репорт

## Диагностика

Отладочная информация по оферу: [otrace](http://active.idxapi.vs.market.yandex.net:29334/v1/otrace)

Там же можно найти ссылки на выдачу репорта

Общая диагностическая информация по оферу [doctor](https://doctor.market.yandex-team.ru/offer-diagnostic)

## Доступные фильтры для фронта
Репорт поддерживает несколько специализированных параметров для поиска по акциям

1. `shop-promo-id` - получить все товары по акции
Универсальный лендинг, где можно посмотреть товары по любой акции
https://market.yandex.ru/special/promo-universal-test?shopPromoId=5061776_605PGPXB
2. `parentPromoId` - получить все товары по акциям, привязанным к родительской акции

## Учёт промо в байбокс
https://wiki.yandex-team.ru/users/ilya-brodskiy/buybox/#uchetpromo

## Привязка промо к каждому оферу
Порядок обработки промо на офере:
1. Получение общего списка акций доступных на офере из индекса
2. Для каждой акций - проверка всех условий срабатывания акции (дата/время, ч/б списки, прямые и обратные эксперименты, комплектность и др.)
3. Сортировка оставшихся акций по приоритету
4. Применение матрицы совместимости мульти-промо
4. Для сложных типов акций (подарок, комплект) перед финальной выдачей репорт дозапрашивает данные о вторичных офферах

## Передача информации между базовым и метой
Для передачи используется protobuf.
Формат описан в `OfferPromoInfo` https://a.yandex-team.ru/arcadia/market/report/proto/MarketSearch.proto?#L2924

## Динамики промо
### Кеш вторичных оферов { #secondary-cache }
В сложных промо (подарок-за-покупку, комплекты) присутствует связь между офферами (осн.товар - подарок).
Однако, репорт обрабатывает каждый оффер по-отдельности.
Для того чтобы при обработке осн.оффера можно было учесть его участие в промо с подароком - нужно знать доступность оффера-подарка.
Для решения проблемы используется кэш вторичных офферов.
Репорт через [спец.ручка](http://rw.vs.market.yandex.net/yandsearch?place=collect_promo_secondary_items&pp=18&regset=0&rids=0&rgb=blue) отдаёт [список](https://paste.yandex-team.ru/1478691) доступных вторичных офферов в виде feed_id -> [offer_id].
Индексатор раз в 5 минут запрашивает эти данные с репорта и, если были изменения, записывает данные вторички в файл и раскладывает его как динамик `promo_secondaries.mmap`.
Таким образом репорт знает примерную (с точностью ~5…10 минут) доступность вторичных офферов.
Кеш используется для учёта промо в байбоксе и при выборе промо (некомплектные промо сразу отбрасываются, что даёт возможность сработать другим промо на оффере).

### Чёрные и белые списки
Данные промо едут с поколением индекса, потому их обновление - долгое, порядка 3-4 часов.
Для более быстрого реагирования, а также для синхронизации данных между репортом и лоялти внедрены механизмы чёрных и белых списков.
Данные едут динамиком `loyalty_delivery_discount.pbuf.sn` от лоялти (**время доезда около 10 минут**) по схеме: loyalty ->(раз в минуту в TMS-задаче)-> MDS -> market access -> report.

**Белый список** - содержит ключи промо, преднанзначен для гарантии того что промо уже есть в лоялти и готово к обработке. Без присутствия в белом списке промо не работает.

**Чёрный список** - содержит пары feed_id + offer_id (уникальный ключ оффера), предназначен для быстрого отключения конкретных товарных позиций в промо. Сейчас не используется

### Графики
[Мониторинги здоровься динамиков](https://juggler.yandex-team.ru/project/market-promo/aggregate?host=market-main-report&service=market_promo_dynamics_health&project=market-promo)

## Флаги и эксперименты промо
* `promo_enable_by_shop_promo_id`, `promo_enable_by_anaplan_id` - флаги включения заранее отключенного промо через прямой эксп. по shop-promo-id и anaplan-promo-id соответственно (можно указывать несколько, через запятую)
* `block_shop_promo_id` - флаг обратного экспа для отключения промо по shop-promo-id (можно указывать несколько, через запятую `block_shop_promo_id=L96831,removed_gift,pricedrop_gift`)
* `market_promo_datetime` - задаёт время для контроля временных рамок промо, используется для тестирования промо которые ещё не начались (пример: `market_promo_datetime=20211201T000000+03`)
* `promo_price_in_buybox` - флаг учёта коэффициентов при розыгрыше ББ
* `market_promo_blue_cashback` - включает промо тип "кэшбек"
* `market_promo_blue_cheapest_as_gift_4` - включает промо типа "2=3" с кол-вом товаров больше 3х
* `market_promo_blue_direct_discount` - включает промо типа "прямая скидка"
* `promo_bbb_blue_flash`, `promo_bbb_blue_set`, `promo_bbb_cheapest_as_gift`, `promo_bbb_generic_bundle` - коэффициенты умножения веса оффера при розыгрыше ББ, соотв. для каждого типа промо
* `market_promo_spread_discount_count`, `market_promo_spread_discount_receipt`
* `market_promo_enable_generic_bundle_in_product_offers`
* `personal_promo_enabled`
* `personal_promo_direct_discount_enabled`
* `enable_fast_promo_matcher` - применение быстропромо (привязка акций к офферу)
* `enable_fast_promo_landing` - лендинги быстропромо (эмуляция через комбинацию литералов)
* `enable_fast_promo_new_promos` - разрешает работу быстропромо для новых акций (которых ещё нет в индексе), по-умолчанию выключено

### Передача флагов репорту с фронта
1. склеиваем параметры репорта символом "точка с запятой".
То есть
`
market_promo_datetime=20211201T000000+03
promo_enable_by_shop_promo_id=#9501
`
превращаем в `market_promo_datetime=20211201T000000+03;promo_enable_by_shop_promo_id=#9501`
2. Эту строчку URL-encodим, например тут https://www.urlencoder.org/
Получаем строчку
`market_promo_datetime%3D20211201T000000%2B03%3Bpromo_enable_by_shop_promo_id%3D%239501`
3. Дописываем в начале `rearr-factors=`, получаем
`rearr-factors=market_promo_datetime%3D20211201T000000%2B03%3Bpromo_enable_by_shop_promo_id%3D%239501`
4. Теперь добавляем это к урлу маркета (после знака вопроса) и открываем в браузере:
`https://market.yandex.ru/?rearr-factors=market_promo_datetime%3D20211201T000000%2B03%3Bpromo_enable_by_shop_promo_id%3D%239501`
5. Переходим на любую страницу и проверяем в кнопке Я -> Е, что выставились верные rearr-параметры (пишутся в сером блоке), там же можно очистить их

