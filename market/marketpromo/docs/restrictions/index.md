# Общие ограничения по работе акций

## Проверка на честность
1. Скидка должна составлять минимум 5% или 500р
2. Скидка не может быть больше 95% - для цен через прайс. Для скидки через акцию верхнего ограничения нет, т.к. могут быть распродажи дедстока/скоропорта, где готовы дать реальную скидку в 99%
3. Цена по акции не может быть выше, чем цена без акции

## Мультиакционность на карточке
Общие принципы применения мультиакционности для отображения **НА КАРТОЧКЕ**
1. Берём акцию из ПИ, если есть
2. Берём акцию с приоритетным типом
3. Берём акция с наибольшим приоритетом внутри акции
4. Берём акцию из приоритетного источника
5. Если ещё есть выбор акции, то выберется случайная
6. Проверям, совместима ли она с уже выбранными акциями. Если нет, то ищем следующую акцию, начиная с п.1
7. Применяем условия акции
8. Если уже нашли 4 акции, то останавливаемся, если нет, то ищем следующую, начиная с п.1

Исключение: несколько акций кешбека может суммироваться, [описание правила](index.md#cashback)

[Порядок применения на репорте](https://a.yandex-team.ru/arc_vcs/market/report/library/relevance/promo.cpp?rev=r9361577#L734)

### Приоритеты источников
1. Партнёрский интерфейс
2. Анаплан
3. Категорийный интерфейс (TODO)
4. Трекерный робот
5. Лоялти
6. ДЦО

### Приоритеты типов
[Приоритеты на репорте](https://a.yandex-team.ru/arc_vcs/market/report/library/global/promo/promo.cpp)

#|
||**Тип акции**| **Приоритет**||
||Вместе дешевле (доп товар)    | 1 ||
||Товар+подарок (доп товар)     | 2 ||
||Кешбэк                        | 3 ||
||Флеш скидка                   | 4 ||
||Прямая скидка                 | 5 ||
||Промокод                      | 6 ||
||Самый дешевый в подарок       | 7 ||
||Товар + подарок*              | 8 ||
||Прогрессирующая скидка        | 9 ||
||Вместе дешевле*               | 10 ||
||Price Drop                    | 11 ||
|#

`*` Для товар + подарок и вместе дешевле в приоритете участвует основной и дополнительный товар

### Приоритет внутри акции
Задаётся через поле `same_type_priority` в protobuf. Чем значение больше, тем приоритет выше

### Правила суммирования кешбека { #cashback }
Детально можно почитать на [вики](https://wiki.yandex-team.ru/non-adv-promotion/upravlenie-kjeshbekom-nabroski-po-resheniju/arxitektura-na-lojalti/?from=%2Fusers%2Fakustareva%2Fupravlenie-kjeshbekom-nabroski-po-resheniju%2Farxitektura-na-lojalti%2F#raschetpovyshennogokeshbjekavsxemespartnerskimiakcijami)

Для кешбека есть возможность суммирования партнёрского и маркетного кешбека.
Например, партнёр даёт повышенный кешбек 2% на товар и маркет даёт 5% кешбека, в результате пользователь получает 7% кешбека.
Данное суммирование работает только для кешбечной акции.

### Таблица совместимости акций
[Таблица совместимых акций шарепоинт](https://yandexteam-my.sharepoint.com/:x:/g/personal/eandreyf_yandex-team_ru/EW6lQ7RNWL1JitKms-rFXSwB4-bn1kIOjt_GV0SmiKGcmg?e=gCfvaA)
Если акции нет в таблице, значит они не совместимы

[Пересечения на репорте](https://a.yandex-team.ru/arc_vcs/market/report/library/relevance/promo.cpp?rev=r9361577#L745)

### Примеры

**Пример 1**
Мы завели промокод 20% на MSKU, партнёр завёл промокод 10% на своё SSKU в этом MSKU.
На SSKU партнёра мы покажем акцию партнёра, на остальных - акцию маркета

**Пример 2**
Товар A - основной товар в акции товар+подарок
Товар B - подарок - той же акции
На товары А и B завели флеш акцию.
Флеш акция применится на основной товар, но не применится на подарок, т.к. флеш выше по приоритету чем акция товар+подарок, но ниже, чем приоритет доп товара в акции товар+подарок.
Это сделано с целью упрощения ситуации в корзине, когда на основной товар флеш не действует, а на подарок действует.

## Мультиакционность в корзине
Детали расчёта скидки на [лоялти](../components/loyalty.md#calc)

### Промокоды в корзине
На каждый товар может примениться только один обычный промокод + сорри промокод (генерируемый маркетинговый промокод).

**Кейс1:**
1. Товар А, товар В
2. Промокод XXX на 100р действует на товар А и В, промокод YYY на 200р действует на товар В
3. Применили промокод XXX. Он применился на А и В, **скидка 100р**
4. Применили промокод YYY. Так как промокод XXX и YYY действуют одновременно на товар В, то промокод ХХХ отбросится
будет действовать только YYY, **скидка 200р**

**Кейс2:**
1. Товар А, товар В
2. **Сорри** промокод ХХХ на 100р действует на товар А и В, промокод YYY на 200р действует на товар В
3. Применили промокод ХХХ. Он прмменился на А и В, **скидка 100р**
4. Применили промокод YYY. Так как XXX - сорри промокод, то он складывается с YYY, **скидка 300р**

Данное утверждение верно для промокодов на первый заказ,
т.е. не может примениться два промокода на первый заказ на один и тот же товар.

Так же верно для реферальных промокодов - он может суммироваться, только с сорри промокодом.

Тикеты на разработку:
1. https://st.yandex-team.ru/MARKETDISCOUNT-5855
2. https://st.yandex-team.ru/MARKETDISCOUNT-8221
