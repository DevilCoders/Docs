# Пример использования асинхронного движка натянутого на Shiny
## Описание
Данный пример демонстрирует использование асинхронного движка натянутого поверх [Shiny HTTP server](https://wiki.yandex-team.ru/market/report/infra/shinyhttp).   
Настройки сервера задаются через файл конфигурации, в котором указываются необходимые для работы сервера параметры:
1) **Port**: порт на котором запускать сервер
2) **Type**: тип сервера который будет использоваться для обработки запросов, по дефолту установлен [http-server](https://a.yandex-team.ru/arc_vcs/market/library/shiny/server/http). В качестве параметра можно указать [YT_SERVER](https://a.yandex-team.ru/arc_vcs/market/library/shiny/server/http/impl/yt).
3) **ListenThreads**: количество прослушиваемых потоков, по дефолту равно количеству CPU.
## Функциональность
Имплементирован пример использования хэндлеров(ручек) с синхронизацией запросов через mutex и yt-евые примитивы.


**Запустить сервис**:               
```./async -c cfg.json```         
**Сделать запрос**:     
```
localhost:<port>/sync/unsynchronized - запрос без синхронизации
localhost:<port>/sync/mutex          - запрос с синхронизацией через mutex
localhost:<port>/sync/yt             - запрос c синхронизацией через yt примитивы синхронизации
localhost:<port>/print               - запрос возвращающий результат счетчика, обновление которого происходит при обработке запросов
```
## Тестирование(бенчмаркинг)
Тестирование проводилось с помощью AB тестирования на машине dev-rep01wd.market.yandex.net с релизной сборкой.    
```
ya make -r
```

**Параметры конфигурации**:
```
Core {
    Server {
        Port: 2508,
        Type: YT_SERVER,
        ListenThreads: 8
    }
}

```

**Скрипт тестирования:**
```
ab -c N -n 100000 http://localhost:2508/print > /dev/null 2>&1
ab -c N -n 100000 http://localhost:2508/print > /dev/null 2>&1
ab -c N -n 100000 http://localhost:2508/print > /dev/null 2>&1
ab -c N -n 500000 http://localhost:2508/print
```
где N - количество одновременно подаваемых запросов (смотрите далее)

**Результаты**:     
YT_SERVER
```
Тест 1:
N = 4
Запросов сделано: 500.000
Общее время выполнения теста: 123 сек
95% перцентиль: 2 мс
99% перцентиль: 3 мс

Тест 2:
N = 8
Запросов сделано: 500.000
Общее время выполнения теста: 69 сек
95% перцентиль: 2 мс
99% перцентиль: 4 мс

Тест 3:
N = 16
Запросов сделано: 500.000
Общее время выполнения теста: 42 сек
95% перцентиль: 2 мс
99% перцентиль: 3 мс
```

HTTP_SERVER
```
Тест 1:
N = 4
Запросов сделано: 500.000
Общее время выполнения теста: 30 сек
95% перцентиль: <1 мс
99% перцентиль: 2 мс

Тест 2:
N = 8
Запросов сделано: 500.000
Общее время выполнения теста: 29 сек
95% перцентиль: 1 мс
99% перцентиль: 2 мс

Тест 3:
N = 16
Запросов сделано: 500.000
Общее время выполнения теста: 28 сек
95% перцентиль: 1 мс
99% перцентиль: 2 мс
```
