# delivery_report_parser

Пакет содержит скриты по обработке отчетов служб доставки, 
состоит из двух частей:
1. (Запускается `parse_xls.py`) Очистка сырых отчетов в форматах `xls` или `csv` от header'ов, footer'ов, лишних строк в середине таблиц отчетов и выделения заголовков таблиц.
2. (Запускается `assemble_db.py`) Сведение разнородных таблиц отчетов в единый формат, приведение различных колонок к единым названиям (у каждой СД свои названия для одних и тех же типов данных), базовая очистка данных (приведение форматов чисел), заполнение пропусков для id заказов (где возможно), вычитанием НДС (где необходимо).
   
Дополнительный скрипт `src/utils/unicode_normalization.py` NFC-нормализует unicode символы. Нормализация необходима,поскольку при копировании файлов отчетов СД из Яндекс.Диска символы "й" в названиях папок оказываются записаны двумя code point, а в мэппингах, в которых мы определяем названия СД используется "й", записанная одним code point.

Мэппинги для определения соответствий исходных названий файлов и листов в файлах типам отчетов, исходных названий колонок стандартизированным названиям и др. содержатся в `src/settings/mappings.py`. Конфиг, которым задается структура папок, параметры очистки исходных отчетов и др. содержится в `src/settings/configs.py`.

#### Пример запуска программы
```bash
python -m src.utils.unicode_normalization
python run.py parse -m Апрель Май -d DPD Стриж
python run.py assemble -o 20190620-final-db.pkl
```
Этот код:
- выполнит нормализацию названий файлов в папке по-умолчанию (`files/`)
- обработает исходные файлы отчетов для за Апрель и Май для служб DPD и Стриж в папке с исходными отчетами по-умолчанию (`files/source/`) 
- соберет единую таблицу из всех отчетов, которые находятся в папках `files/parsed/` и сохранит получившийся pandas.DataFrame в файл `files/final/20190620-final-db.pkl` методом pandas.to_pickle.
