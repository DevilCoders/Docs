# Особенности архитектуры

Далее описаны ряд нюансов архитектуры приложения, как они были выбраны и почему.

## MVVM

Мы используем MVVM (Model-View-ViewModel). Вся бизнес логика находится во ViewModel, все функции и
состояния хранятся в ней, View отвечает исключительно за отображение текущего состояния стейта
экрана (передаем экземпляр ViewModel во View). Model или Fragment в андройде связывает текущий View
с экземпляром ViewModel, а так же связывается с другими Fragment'ами при необходимости. При
необходимости передавать состояние от одного фрагмента в другой, используется либо паттерн
Observable, либо объект передаётся через savedStateHandle

## Тесты

Для каждого экрана мы стараемся писать тесты. UI тесты пока не применяются, зато максимально
стремимся покрыть ViewModel-и. Тест кейсы просим расписать тестировщиков параллельно с разработкой.
В идеале покрывать unit тестами каждую часть функционала

## Сетевой уровень

Мы разделяем объекты приходящие при ответе с бэкенда и объекты, которые используются в остальной
части приложения. В ответ на запрос мы ожидаем Dto, где все поля опциональны и являются примитивами
или коллекцией примитивов, а потом маппим Dto на внутренние объекты, валидируя и трансформируя их
при необходимости (например в enum)

## DI

Мы полностью перешли на Hilt, прочитать про него можно [тут](https://dagger.dev/hilt/)
Коротко: для каждого фрагмента, использующего DI пишем `@AndroidEntryPoint`, для каждой ViewModel
-- `@ViewModelInject`

## Бизнес-логика

Для многих экранов мы сейчас используем state machine. Подробнее можно
почитать [тут](./implementation.md)

## Разделение по сборкам

Если перейти в Project View, то можно увидеть в `app/src` много разных папок: main, debug, qa,
camera, tsd etc Когда gradle собирает проект он мерджит только необходимые папки для apk файла. Для
примера в сборку tsdDebug попадет только папки main, tsd и debug.

Если перейти в Android View (кликнуть на project в левом верхнем углу и поменять на android), то ide
автоматически скроет папки не относящиеся к текущему build variant. Будет видна только папка main,
tsd, debug и test

Мы стараемся всё логику работы приложения делать общей для всех сборок, делая зависищими от вида
сборки файлы (например ScannerFragment) только для нативных вещей как доступ к камере или включение
фонарика

Ресурсы разносим по сборкам тоже. Не стоит добавлять ресурсы в main, если они используются только в
конкретной сборке

## Общая архитектура приложения

Приложение имеет древовидную структуру по соответсвующим папкам

```bash
└── sortingcenter
│   ├── analytics -- аналитика и метрика приложения, отправляется в отдельном потоке
│   ├── api -- методы, дергающие ручки бэкенда и интерсепторы для запросов
│   ├── arch -- расширения встроенных типов и собственные функции для упрощения кода
│   │   ├── common -- общие функции для папки arch
│   │   ├── ext -- расширения классов собственными функциями
│   │   ├── kotlin -- собственные классы на котлине
│   │   ├── logs -- собственный logger
│   │   ├── types -- алиасы для собственных типов
│   │   ├── validation -- правила валидации различных условий
│   ├── constants -- файлы с константами приложения
│   ├── data -- слой с описанием классов, принимаемых с бэкенда и маппингом их в классы vo
│   ├── di -- настройка подключения модулей и автогенерации кода
│   ├── functional -- хэлперы в функциональном стиле
│   ├── repository -- репозитории, дергающие api
│   ├── ui -- (Fragment + ViewModel)
│   │   ├── common -- общие компоненты для переиспользования на разных экранах
│   ├── util -- вспомогательные функции
│   └── vo -- внутренние классы, которыми оперирует приложение
```
