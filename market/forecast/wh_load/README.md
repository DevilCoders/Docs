# Инфра для прогноза нагрузки на склад (логистическую единицу)

## Запуск

Для обучения:
```
# FAIR predict 
./scripts/run_train.sh
# BASE ptrain
./scripts/run_train_base.sh
```

Для ежедневного обновления прогнозов:
```
# FAIR predict 
./scripts/run_predict.sh 
# BASE predict
./scripts/run_predict_base.sh
```

## Описание проекта

Проект для обучения, сравнения и применения 3-х типов моделей – BASE, ANAPLAN, FAIR.
  - BASE – прогноз продаж по ключу `subkey` на основе исторических продаж 
    В качестве `subkey` можно взять листовую категорию `hid` или категорию 2-го уровня `hid_2`
    или `hid_msku_5` – группа msku внутри листовой категории.
  - ANAPLAN – прогноз средних значений скидок для каждой msku по запланированным promo_id's, 
    которые есть в таблицах anaplan-а.
  - FAIR – двухшаговый прогноз, который сначала применяет прогноз от модели ANAPLAN для каждой `msku`, 
    потом агрегирует прогнозируемые скидки по ключу `subkey`, полученные агрегаты использует 
    как фичи для итогового прогноза продаж по ключу `subkey`.
    
Проект построен как самодостаточный код, в котором есть возможность запускать графы 
  - обучения, 
  - валидации (сравнения моделей, выявление лучших)
  - прогноза
Графы берут исходные сырые данные из регулярных таблиц на YT и кладут результат на YT (сами обученные модели и прогнозы).
Используются таблицы:
  - `//home/market/production/mstat/analyst/regular/cubes_vertica/fact_new_order_item_dict_flattened`
  - `//home/market/production/mstat/dictionaries/stock_sku/1d`
  - `//home/market/production/mstat/analyst/regular/cubes_vertica/dim_ssku_flattened`
  - `//home/market/production/mstat/dictionaries/anaplan/export_operational_promo_csv/1d`
  - `//home/market/production/mstat/dictionaries/anaplan/export_promolimit_csv/1d`
  - `//home/market/production/mstat/dwh/detail/link_promo_offer`

В модели **BASE** есть важные подварианты:
  - при обучении и тестировании на прошлых датах можно использовать фактические средние скидки 
    за таргетный период; это зависит от `feature_set`, если в имени `feature_set` нет суффикса 
    `no_future`, то полученный прогноз будет нечестным 
    (его в жизни невозможно использовать для будущего, если, конечно, кто-то не подставит в dataset
    предполагаемые скидки по каждому `subkey`).
     - Варианты без `no_future` дают оптимистичную оценку того, какое будет качество прогноза, когда мы
       научимся очень хорошо прогнозировать средние скидки в будущем.
         - И здесь есть важный вариант, когда мы в прогнозе пред применением выставляем
           в фичах некоторые значения скидок, которые соответствуют минимальному фону без ПРОМО;
           Сейчас это делается выставлением future-фичей в 90%-квантильные значения 
           (в сторону маленьких скидок);
           Так получается прогноз **BASE_NO_PROMO** – cм. метод TrainBaseModelTask::do_no_promo_predict
     - Варианты с `no_future` показывают, какого качества можно достичь, если ничего не знать 
       о будущих скидок
       
Модель **FAIR** является целевой – она должна достичь хорошего качества при максимально точной 
и полной информации о будущих промо в таблицах anaplan. В будущем можно переделать на любые другие таблицы,
в которых будет информация о promo_id: даты проведения, тип промо и размер, ассортимент промо, 
условия на срабатывание промо, факты наличия промоушена на главных экранах, в телевизоре, наружней рекламы. 

## Структура файлов

Для понимания модели BASE нужно посмотреть файлы
  - `lib/data_preparation/sql/build_base_dataset.sql` – файл с YQL кодом для получения датасета для BASE; 
    в нём используется стандартная библиотека forecast_utils/utils/sql/counters_lib.sql, а именно,
    subquery, генерирующий поток данных о продажах по заданному ключу (например, warehouse + msku) 
    с инфой про цены, скидки, OOS и др. Эта библиотека поддерживается и гарантируется работоспособность 
    это библиотеки, актуальность используемых таблиц и полей;
  - `lib/data_preparation/build_base_dataset_task.py` – нирвановская таска, которая запускает YQL выше;
  - `lib/data_preparation/train_base_model_task.py` – нирвановская таска, способная выполнять задачи обучения, 
    валидации (сравнения разных прогнозов) и прогноза на заданные даты;
  - `lib/cli_base.py` – файл с конфигурацией моделей для обучения, сравнения и применения

Структура графов для обучения, сравнения и ппрогноза задана в `lib/graph.py`.
Доступны такие графы (команды):
- **validate** – сравнение моделей заданного типа с заданным subkey (опции `--model_type`, `--subkey`),
  `model_type` – `base`, `analan`, или `fair`, `subkey` – `hid`, `hid_2`, или `hid_msku_5`; 
  также есть опция `--target`, 
  чтобы задать колонку, которую нужно прогнозировать; есть такие варианты:
    - ANAPLAN
        - `avg_discount` – среднее значение скидки
        - `avg_sq_discount` – среднее значение квадрата скидки
        - `discount10_items_ratio` – доля продаж со скидкой > 10%
        - `target_d2` = `[avg_discount, discount10_items_ratio]`
        - `target_d3` = `[avg_discount, discount10_items_ratio, avg_sq_discount]`
    -  BASE или FAIR:
        - `r_target_d1_items` – продажи в один день
        - `vec_target_d14_shift_items` – тензорный таргет размерности 14, продажи за 14 дней
- **train** – обучение ANAPLAN и FAIR моделей в одном графе
- **predict** – применение FAIR модели с предварительным применением ANAPLAN модели в одном графе
- **train_base** – обучение BASE модели
- **train_predict** – применение BASE модели 
