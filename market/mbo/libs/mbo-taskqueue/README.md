Task queue
=====

Реализации очереди на Postgresql.
Среди особенностей:
- Распределенная вставка и обработка задач
- Быстрое получение нового события из очереди (от 30мс на небольших очередях до 2с на больших).
- При падении обработки задачи происходит ретрай. Ретрай можно настраивать.
- События в очереди - это pojo. Обработка событий - это класс, написаный на языке джава. Хранение pojo в БД осуществляется в json.
- Автоматический сбор метрик в соломон. Пример дашборда: https://grafana.yandex-team.ru/d/Y_r_FJonk/taskqueue?orgId=1&from=1640241778890&to=1640245378890&refresh=1m

Существует 2 реализации:
- TaskQueueExecutor
- UnsafeTaskQueueExecutor

**TaskQueueExecutor**
Основная реализация очереди. Каждое событие гарантировано подхватывается только одним обработчиком. Гарантия обеспечивается путем конструкции
```postgresql
select * from task_queue
order by create_time
limit 1
for update
skip locked
```
Если приложение в процессе обработки умирает, то событие переподхватывается другим свободным обработчиком.
Обработчик хорошо подходит, если у вас несколько десятков-сотен тысяч событий в день.

!!TODO!! Также существует возможность захватить лок.

**UnsafeTaskQueueExecutor**
Еще одна реализация очереди. Каждое событие гарантировано подхватывается только одним обработчиком
```postgresql
-- get next task to process
select * from task_queue where state = 'ACTIVE'
order by create_time
limit 1
for update
skip locked;

-- mark as in progress
update task_queue
    set state = 'IN_PROGRESS'
where id = :id
and state = 'ACTIVE'
```
Если приложение в процессе обработки умирает, то событие зависает в статусе IN_PROGRESS на N минут.
По прошествии N минут очередь автоматически подхватит зависшие задачи и заново начнет их обработку.
Обработчик хорошо подходит, если у вас больше несколько десятков-сотен тысяч событий в день (TODO определить верхнюю таблицу)
и вам не принципиально потерять иногда событие.

Релизы
--------
Катается отдельным пайплайном:  https://teamcity.yandex-team.ru/buildConfiguration/Market_Mbo_MboTaskqueueRelease



