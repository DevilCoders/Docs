# Какие бывают SSKU

## Синий и белый маркет

Миллионы лет назад, когда динозавры ещё не стали нефтью, а рептилоиды только начинали строительство пирамид, на Маркете ничего нельзя было купить. Это был просто агрегатор, перенаправляющий пользователей на страницы магазинов. Такой "старый" Маркет называют белым. Показываемые на нём чисто рекламные офферы — тоже белые.

Затем появился Беру.ру, в котором появились продаваемые офферы. Этот Маркет и все офферы в нём назвали "синими".

Сейчас Маркет объединился в Покупки, и цветовая дифференциация офферов несколько утратила актуальность, однако терминология по-прежнему используется. МДМ преимущественно работает с синими офферами, т.к. они реально продаются, и за них Маркет несёт ответственность в той или иной степени. Однако некоторые варианты размещения белых офферов тоже проходят через МДМ.

## Бизнес-оффер { #business_offer }

Каждый партнёр Маркета имеет целочисленный `business_id`. Это уникальный идентификатор всего поставщика безотносительно конкретных условий размещения его товаров.

При заведении конкретного товара партнёр указывает для него строковый ID. Это может быть произвольная строка за исключением пробелов и ряда спецсимволов. Такой идентификатор товара называют `shop_sku`. Получаем, что уникальным идентификатором товара на Маркете будет служить пара `(business_id, shop_sku)`.

{% note info "Shop SKU" %}

Строковый `shop_sku` должен быть уникален в пределах ассортимента одного поставщика, однако не в пределах Маркета. Именно поэтому одного `shop_sku` без `business_id` недостаточно для формирования первичного ключа оффера.

{% endnote %}

**Проблематика**

Предположим теперь, что наш партнёр желает продавать один и тот же оффер различными способами.

* Использовать Маркет как рекламную площадку
* Использовать Маркет для оформления покупки, но сбор и отправку заказа делать самостоятельно
* Использовать логистику и склады Маркета на полную катушку (например, для регионов, где у партнёра может не быть своих логистических мощностей и складов)

В таком случае 95% свойств товара вообще никак не будут затронуты, и только остальные 5% будут реально описывать специфику конкретной модели размещения. Например, при использовании мощностей Яндекса партнёр будет указывать логистические атрибуты и календарь поставок на оффере.

{% cut "Пара слов о моделях размещения" %}

Традиционно модели размещения кодируют аббревиатурами. Вот некоторые актуальные модели работы с Маркетом из документации для партнёров:

![Модели размещения](../../_images/business_offer_1.png)

Это неполный список. Например, здесь не хватает модели ADV - чисто белые рекламные офферы, как на старом Маркете.

{% endcut %}

Такие модели размещения называют *сервисами*. Это логическое разбиение, однако в реальном мире одному *сервису* иногда может соответствовать либо конкретный физический магазин партнёра, либо какое-то региональное отделение юрлица. То есть, грубо говоря, под одним единым *бизнесом* может быть несколько "подпоставщиков" - *сервисов*. Поставщик сам решает, насколько он хочет детализировать разбиение самого себя на подпоставщиков и будет ли это разбиение логическим или географическим.

Сервисам присваивается уникальный целочисленный `service_id`, который чаще называют `supplier_id`. Выходит, что каждый партнёр Маркета представляет собой строго двухъярусное дерево, где под одним `business_id` сидят один или несколько `service_id`.

В МДМ оно так и хранится:

```sql

> select id, name, business_id, supplier_type from mdm.supplier where 655450 in (business_id, id);

+-------+---------------+-----------+-------------+
|id     |name           |business_id|supplier_type|
+-------+---------------+-----------+-------------+
|19065  |avto-podarok.ru|655450     |MARKET_SHOP  |
|1244343|avto-podarok.ru|655450     |MARKET_SHOP  |
|1244849|avto-podarok.ru|655450     |MARKET_SHOP  |
|1095880|Авто-Подарок   |655450     |THIRD_PARTY  |
|655450 |avto-podarok.ru|NULL       |BUSINESS     |
+-------+---------------+-----------+-------------+

-- Под бизнесом 655450 находится четыре сервиса,
-- связанных с родителем через колонку business_id.
```

{% note warning %}

Каждая команда Маркета считает своим священным долгом назвать *сервисный* IDшник как-то по-особенному. Помимо `supplier_id` вы можете встретить такие вариации: `service_id`, `partner_id`, `shop_id`.

{% endnote %}

**Бизнес-оффер**

Бизнес-оффер — это двухъярусный оффер, построенный по `business_id` и всем `service_id` партнёра. Обычно в БДшках оно хранится либо как-то построчечно:

supplier_id | shop_sku | data
:---|:---|:---
19065 (сервис) | "avtokreslo-super-9000" | НДС: 18%, дни поставок: пн, ср, пт
1244343 (сервис) | "avtokreslo-super-9000" | квант поставки: 4
1244849 (сервис)| "avtokreslo-super-9000" | НДС: 20%, дни поставок: вт, чт
1095880 (сервис)| "avtokreslo-super-9000" | квант поставки: 3, дни поставок: сб, вс
655450 (бизнес)| "avtokreslo-super-9000" | страна: Китай, ВГХ: 20/60/30см 4кг, гарантия: 2 года

либо в едином иерархичном объекте:

```json
{
    "business_id": 655450,
    "shop_sku": "avtokreslo-super-9000",
    "basic_part": {
        "country": "Китай",
        "weight_dimensions": {
            "width": 20,
            "length": 60,
            "height": 30,
            "weight": 4
        },
        "warranty": { "time": 2, "unit": "YEAR" }

    },
    "service_parts": [
        {
            "service_id": 19065,
            "VAT": 18,
            "delivery_schedule": ["пн", "ср", "пт"]
        },
        {
            "service_id": 1244343,
            // и так далее
        }
        ...
    ]
}
```

К сожалению, в МДМе встречаются оба варианта с кучей хаков и трансформаций между ними. Постепенно приходим ко второму формату.

{% note tip %}

Обратите внимание, что в примерах выше данные по сервисным ID отличаются от тех, что записаны по бизнес-ключу. Ради этого всё и задумывалось! Теперь мы можем в одной строчке (или в одной `basic_part`) описать те самые 95% свойств товара, которые никак не зависят от модели размещения, а оставшиеся детали конкретных условий продажи засунуть в сервисы.

{% endnote %}

Данные, которые никак не зависят от модели размещения, называют *базовой частью* или *бизнес-частью* оффера. Таких данных большинство. Например, весогабариты или страна производства утюга ну совсем никак не поменяются, вози мы их со своих складов или со кладов поставщика.

Информация, которая специфична для конкретной модели размещения, называется *сервисной частью* оффера. Так, ставка НДС может варьироваться от условий продажи (особенно касается предоплаты), равно как и настройки поставок.

В примерах выше можно увидеть, что *базовая часть* либо пишется в тело оффера, либо в строку таблицы по основному `(business_id, shop_sku)`, а *сервисная часть* пишется по `service_id`.

**Так что в итоге Primary Key для оффера?**

Для тех систем Маркета, что поддерживают всю эту радость с бизнесами, это составной ключ `(business_id, shop_sku)`. Для всех остальных сервисы живут как бы по отдельности, и один бизнес-оффер у них может распасться на группу будто бы независимых офферов, идентифицируемых по `(service_id, shop_sku)`. Поскольку МДМ работает и с новомодными, и с легаси-потребителями, мы поддерживаем оба варианта. Во многих местах доступа к БД мы умеем работать и по правильным бизнес-ключам, и по коллекциям сервисных ключей.

В коде ключ описывается классом [ShopSkuKey](https://a.yandex-team.ru/arc/trunk/arcadia/market/mbo/mbo-category/mboc-base/src/main/java/ru/yandex/market/mboc/common/offers/model/ShopSkuKey.java).

## 1P и 3P { #parties }

Поговорим об иной классификации партнёров и офферов, которая вообще не связана с бизнесами и сервисами.

* REAL-партнёр - это поставщик, передающий товары под ответственность Маркета, после чего мы такие товары реализуем от своего имени. Продавцом для них числится Яндекс.Маркет, и мы несём полную юридическую ответственность.

  *Таких товаров меньшинство, на текущий момент < 10% ассортимента.*

* 1P (First Party) - поставщик, от лица которого продаются товары REAL-поставщиков. Внимательный читатель должен заметить, что выше уже было сказано, что такие товары продаются от лица Маркета. Всё так, поэтому в природе существует только один 1Р-партнёр - это сам Маркет. В продакшене у него фиксированный ID, равный `924574` (бизнес) или `465852` (сервис). Он так и называется:

  ```sql
  > select id, name, supplier_type from mdm.supplier where id = 465852;

  +------+-------------+-------------+-----------+
  |id    |name         |supplier_type|business_id|
  +------+-------------+-------------+-----------+
  |465852|Яндекс.Маркет|FIRST_PARTY  |924574     |
  +------+-------------+-------------+-----------+

  ```
* 3Р (Third Party) - поставщик, использующий мощности маркетплейса для своих нужд, но продающий товары от своего имени. Почти все товары Маркета продаются именно такими партнёрами.

3P не особо интересен, а вот REAL и 1P непосредственно связаны. Поскольку в большинстве случаев в бизнес-логике не интересно, кто перепродал Маркету товары, весь 1Р-ассортимент кодируется по 1Р поставщику, а не по конкретным REAL-ам. В МДМе в том числе. Таким образом, мы можем идентифицировать 1Р товар в виде привычной пары `(924574, "000109.игрушк-чёрн-Hasbro")`.

Но что если всё-таки потребуется понять, какой REAL перепродал Маркету этот товар? Для этого у всех 1Ршек в `shop_sku` есть специальный префикс. В данном примере он равен `000109`. Это дополнительное уникально поле для REAL-партнёров. По нему мы можем найти изначального продавца:

```sql
> select id, name, supplier_type, business_id, real_supplier_id
  from mdm.supplier where real_supplier_id = '000109';

+------+---------------------+-------------+-----------+----------------+
|id    |name                 |supplier_type|business_id|real_supplier_id|
+------+---------------------+-------------+-----------+----------------+
|532503|ООО "КОМПАНИЯ "АГОРА"|REAL_SUPPLIER|NULL       |000109          |
+------+---------------------+-------------+-----------+----------------+

```

Попался! Обратите внимание, что у него свой REAL-тип и нет ссылки на бизнеса. Это норма, так как REAL-поставщики живут "в сторонке" и связь с бизнесом происходит через общемаркетного 1Р-партнёра.

Таким образом, оффер `(532503, "игрушк-чёрн-Hasbro")` и `(924574, "000109.игрушк-чёрн-Hasbro")` есмь одно и то же, просто записанное в разных форматах. В МДМе всегда используется второй формат через 1Р-поставщика за исключением крайне редких случаев коммуникации с соседями, кто требует REAL-формат.

Конвертёр форматов в [коде](https://a.yandex-team.ru/arc/trunk/arcadia/market/mbo/mbo-category/mboc-base/src/main/java/ru/yandex/market/mbo/mdm/common/masterdata/services/SupplierConverterServiceImpl.java).
