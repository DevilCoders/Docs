# Маппинги

Маппинги связывают MSKU и SSKU, а в качестве бонуса хранят в себе и категорию.

- Представляет собой кортеж `(business_id, shop_sku, msku_id, category_id)`
- Мастер-система — [Категорийный Интерфейс](https://cm-testing.market.yandex-team.ru)
- Могут динамично меняться. Если вчера SSKU была связана с одной MSKU, то нет гарантии, что она не будет перепривязана к другой карточке завтра.
- Первичный ключ маппинга — это `(business_id, shop_sku)`. Таким образом, на одну SSKU всегда приходится не более одного маппинга.

## Качество

С точки зрения МДМ маппинги бывают двух видов по уровню надёжности.

**Suggested**

Маппинг, полученный автоматическими процессами. Не очень надёжный, но может стать таковым после проверки человеком или после матчинга по надёжным параметрам (например, по штрихкоду). Suggested-маппинги чаще всего могут использоваться в DBS-офферах.

{% note info "В процессах" %}

- При варке SSKU suggest-ы разрешены. Ибо если на оффер нашёлся suggest-маппинг, то в МДМе точно нет approved-а на этот оффер, и такой маппинг лучше, чем никакой.

- При варке MSKU suggest-ы запрещены *кроме случаев, когда на этой MSKU нет approved-а в принципе*. Другими словами, если под MSKU есть хоть один качественный approved-маппинг на SSKU, то всех "грязных" детей отбрасываем.

- А вот если качественных нет и все дети "грязные", то ничего не поделать, берём все садджесты и грязно варим MSKU по ним, ибо ничего лучше у нас нет.

{% endnote %}

**Approved**

Надёжный маппинг. Полноценно участвует во всех варках SSKU и MSKU в обе стороны.

## В коде

[Репозиторий](https://a.yandex-team.ru/arc/trunk/arcadia/market/mbo/mbo-category/mbo-mdm-common/src/main/java/ru/yandex/market/mbo/mdm/common/masterdata/repository/MappingsCacheRepositoryImpl.java), [сервис импорта](https://a.yandex-team.ru/arc/trunk/arcadia/market/mbo/mbo-category/mbo-mdm-common/src/main/java/ru/yandex/market/mbo/mdm/common/service/mapping/MappingsUpdateService.java). Маппинги поступают в МДМ из ЕОХ, расположены они в [UnitedOffer.proto](https://a.yandex-team.ru/arc/trunk/arcadia/market/idx/datacamp/proto/offer/UnitedOffer.proto) в базовой части в полях сообщения [OfferMapping](https://a.yandex-team.ru/arc/trunk/arcadia/market/idx/datacamp/proto/offer/OfferMapping.proto). Из поля `approved` мы читаем надёжные маппинги, а если таковых нет, то читаем suggest-ы из поля `uc_mapping`.

Таблица: `mdm.mappings_cache`

Исторически маппинги хранятся в МДМ и по сервисным ключам, и по базовым. Так сложилось из-за того, что работать мы с ними начали задолго до появления бизнес-офферов. Сейчас же, чтобы избежать проблем с неконсистентностью ключей, рекомендуется в коде использовать [MdmBestMappingsProvider](https://a.yandex-team.ru/arc/trunk/arcadia/market/mbo/mbo-category/mbo-mdm-common/src/main/java/ru/yandex/market/mbo/mdm/common/service/mapping/MdmBestMappingsProvider.java).

## Версионирование

У маппинга есть ряд полей, задающих версии. Для определения, какой маппинг более свежий, последовательно сравниваются следующие поля, пока не найдётся первая неравная по значению пара версий: `version_timestamp`, `update_stamp`, `modified_timestamp`.

Чуть более подробно:

- `version_timestamp` - актуальное поле версии. В идеале хотелось бы избавиться от остальных и оставить только это.
- `update_stamp` - legacy поле, фактически означающее время отправки маппинга из Категорийного Интерфейса в Yt. Сейчас такой механизм обмена маппингами не используется, и поле обычно содержит копию обычной версии.
- `modified_timestamp` - это вообще не версия, а просто время апдейта маппинга в базе МДМ. Используется для версионирования только в крайних случаях, когда по всем остальным критериям маппинги совпали.
- `mboc_timestamp` - версия маппинга от Категорийного Интерфейса. Это служебная информация, и по сути она должна совпадать с основной версией. Не используется в компараторах.
- `eox_timestamp` - версия маппинга от ЕОХ. Это служебная информация, которую в ЕОХ передаёт Категорийный Интерфейс, а потому она фактически должна совпадать с основной версией. Не используется в компараторах.


{% note info "Приоритетное сравнение" %}

В некоторых ситуациях возникает потребность выбрать "лучший" маппинг из двух. В этом случае лучшим считается approved-маппинг по сравнению с suggested, а если их надёжность совпадает, то происходит сравнение по версиям.

{% endnote %}
