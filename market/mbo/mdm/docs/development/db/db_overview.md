# Обзор хранилищ

В МДМ используются два основных хранилища данных - Yt и PostgreSQL.

{% note info "Возможно вы искали" %}

[Подключение к PostgreSQL с локальной машины](db_connect.md)

[SQL-интерфейс для Yt](https://yql.yandex-team.ru/)

{% endnote %}

## Yt

Yt - сервис распределенного хранения и обработки данных с поддержкой модели MapReduce, распределенной файловой системой и NoSQL key-value базой данных.

[Документация](https://yt.yandex-team.ru/docs/)

Геораспределённость достигается засчёт использования нескольких датацентров, каждый из которых традиционно вмещает в себя выделенный *кластер Yt*. Существуют также независимые от дата-центров мета-кластера (аналог primary или master), через которые мы контроллируем репликацию.

Реплицированность - опциональное свойство. Некоторые некритичные данные могут жить в одном экземпляре на одном ДЦ-зависимом *кластере*.

{% note info "Про кластеры" %}

Вообще, кластеров в Yt десятки. Часть из них ДЦ-зависимые, часть - меты. Помимо этого критерия и сугубо географической привязки к ДЦ, они могут отличаться по приоритету вычислительных ресурсов, по контуру (тестовые беты или боевые продовые), по гарантиям доступности и многими другими деталями. Подробнее о внутреннем устройстве Yt можно почитать [тут](https://yt.yandex-team.ru/docs/overview/clusters).

{% endnote %}

{% note info "Именование" %}

Исторически кластеры именуют в честь великих учёных или видных интеллектуальных деятелей. Поэтому в обиходе вы можете услышать фразы в духе: "Переложи вот это на Хан" - это будет означать, что какие-либо данные просят поинсертить в табличку на кластере [Hahn](https://yt.yandex-team.ru/hahn).

{% endnote %}

Сама репликация бывает, условно, "умная" и "ручная".

### Умная репликация

Строится она примерно так:

* Заводится псевдотаблица на мета-кластере (аналог master/primary в других БД). Псевдо - потому что она хоть и выглядит как таблица, но фактически не будет содержать данных, а лишь описывает схему.
* На ДЦ-зависимых кластерах-репликах заводятся таблички-реплики. Схема должна быть в точности одинаковой и совпадать со схемой псевдотаблицы.
* На мета-кластере через специальные атрибуты мы цепляем реплики к псевдотаблице
* Дальнейшие чтение и запись осуществляются строго через мета-кластер путём походов в псевдотаблицу как в master.

**Пример**

Псевдотабличка [на мета-кластере](https://yt.yandex-team.ru/markov/navigation?offsetMode=key&path=//home/market/production/mdm/storage/msku_gold); [первая](https://yt.yandex-team.ru/arnold/navigation?offsetMode=key&path=//home/market/production/mdm/storage/msku_gold) реплика и [вторая](https://yt.yandex-team.ru/hahn/navigation?offsetMode=key&path=//home/market/production/mdm/storage/msku_gold) реплика. Можно увидеть, что схемы таблиц абсолютно идентичны.

Такой подход используется для боевых таблиц, активно используемых в повседневных продакшен-процессах.


### Ручная репликация

Просто инсертим данные сперва на один, кластер, потом на другой. Обычно так делается для статических таблиц вроде исторических суточных слепков, которые генерятся background-процессами и просто по завершении копируются с одного кластера на другой.

### Интерфейсы

**В коде**

В коде обычно используются java-клиенты от разработчиков Yt, иногда дополнительно обёрнутые в ~~костыли~~ хелперы.

* Создаём [бины](https://a.yandex-team.ru/arc/trunk/arcadia/market/mbo/mdm/mdm-storage-api/src/main/java/ru/yandex/market/mdm/storage/config/MdmStorageYtConfig.kt) с подключением к нужным кластерам
* Работаем с навигационным деревом через `yt.cypress().<...>`
* Либо с самими табличками через `yt.tables().<...>`

**Для человеков**

У каждого кластера есть свой фронтенд. Строится так: `https://yt.yandex-team.ru/имя_кластера`. Например, кластер Марков: [https://yt.yandex-team.ru/markov](https://yt.yandex-team.ru/markov).

**Ещё более для человеков**

Поверх Yt работает специальный интерфейс выполнения запросов, который называется YQL. Он позволяет писать полноценные select-ы и insert-ы на базе таблиц в Yt. Очень удобно, но работает довольно долго, т.к. трансформирует ваш SQL в пачку не всегда оптимальных MapReduce-джоб.

[Интерфейс](https://yql.yandex-team.ru)

[Документация](https://yql.yandex-team.ru/docs/yt/)

{% note warning "Нюанс" %}

Важно понимать, что Yt и YQL - это две большие разницы. Yt - это сама база данных со всеми низлежащими железными потрохами. YQL - это высокоуровневый интерфейс выполнения sql-подобных запросов над этими потрохами. YQL может жить без Yt (например, поверх Clickhouse), а Yt в свою очередь полностью функционален без YQL. Обе компоненты разрабатываются и поддерживаются совершенно разными командами.

{% endnote %}

**Консоль**

Для ценителей прекрасного есть встроенный в утилиту Ya консольный клиент Yt. Вызывается он через `ya tool yt <ваша команда>`, а множество примеров в документации как раз описывается через этот клиент.

## PostgreSQL

Обычный Postgres 12, управляемый платформой Yandex Cloud. Центр управления полётами находится здесь:

* [Дев](https://yc.yandex-team.ru/folders/foohmq8ndf4kcdd7k28k/managed-postgresql/cluster/mdb1qq4cqjiecv1bk3u6?section=overview)
* [Тестинг](https://yc.yandex-team.ru/folders/foohmq8ndf4kcdd7k28k/managed-postgresql/cluster/mdb0nnas8j19ahd9r89o?section=overview)
* [Прод](https://yc.yandex-team.ru/folders/foohmq8ndf4kcdd7k28k/managed-postgresql/cluster/mdbqmf8rmaoqqc1e5j2h?section=overview)

Веб-интерфейса для запросов как такового нет, поэтому обычно используем DataGrip или соответствующие модули в IDE.

Документация [раз](https://docs.yandex-team.ru/cloud/managed-postgresql/), [два](https://www.postgresql.org/docs/), [три](https://www.google.com/).

Подробнее про [реплики в PG](replication.md).
