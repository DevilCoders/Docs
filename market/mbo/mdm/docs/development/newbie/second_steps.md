# МДМ и его место в Маркете

Что вообще такое МДМ можно почитать [тут](../../contour/business_domain/definition.md). Там МДМ описан с точки зрения внешнего не-разработчика.

*TL;DR:* Наш сервис получает из разных источников особые наборы данных, влияющие на жизненный цикл и условия реализации товаров. Мы из этих данных выбираем наилучшие и раздаём другим компонентам Маркета.

На основании этих данных Маркет принимает решение, показывать ли товар на выдаче, каким образом осуществлять логистику, что следует коммуницировать партнёру и не протух ли товар в принципе.

## Примеры мастер-данных

Зайдём издалека и сперва разберёмся с предметной областью. Для конкретики приведём примеры реально обрабатываемых нами данных.

* Страна производства
* Сертификаты соответствия, паспорта безопасности химической продукции и прочие документы
* Весогабаритные характеристики (ВГХ).

  *Это одни из самых важных мастер-данных. От них зависят условия продажи, стоимость доставки, логистика и хранение на складах, скрытие или показ товара на "витрине", биллинг поставщиков и многое другое.*
* Сроки годности, гарантии и службы. Остаточные сроки годности (ОСГ).

  *С обычными сроками годности всё понятно, а вот ОСГ позволяют задавать пороги годности товара для приёма на склад от поставщика или для продажи конечному потребителю. Например, мы можем запретить продавать продукты, у которых срок годности исчерпан на 70% или более. Тем самым мы защищаемся от риска, что товар протухнет по дороге к потребителю.*
* Логистические атрибуты — квант поставки, календарь поставок, многоместность, спайки и другое.
* Карготипы

  *Это булевые атрибуты, обычно маркирующие особое свойство товара, что влияет на его жизненный цикл в Маркете. Примеры карготипов — "пахучий", "тяжеловесный и крупногабаритный", "бытовая химия", "интим-товар" и подобные, их около 50 штук и регулярно добавляются новые. Благодаря карготипам мы можем разметить здоровенный эротический дрын флажками "крупногабарит" и "интим-товар", и это позволит Маркету обрабатывать его по особой логике — возить крупными фурами и не продавать несовершеннолетним.*

## Уровни хранения

Окей, мы примерно представляем, какими могут быть мастер-данные. А как они хранятся? Что такое "товар"? Как вообще всё это организовано?

### Категория {#category}

Самый общий и самый "высокий" уровень представления данных в Маркете — это товарная категория. По сути это очень похоже на то, что можно увидеть в каком-нибудь каталоге на фронте Маркета или любого другого магазина.

![Категории](../../_images/second_steps_1.png "Категории")

* Мастер-системой по категориям является [Market BackOffice](https://mbo.market.yandex-team.ru) (MBO).

    {% note info "MBO" %}

    Это такая система управления контентом Маркета (одна из). Там можно прямо руками проставить какие-нибудь атрибуты товарам. Например, "Наличие Bluetooth" на зубную пасту. Но лучше не надо. И помимо самих товаров, МВО как раз хранит и дерево категорий, в которых эти товары размещаются.

    {% endnote %}

* МДМ тоже умеет работать с категориями. Обычно на них задаются какие-то общие грубые настройки. Например, мы можем на всей категории указать атрибут "нет срока годности". Это может быть удобно, чтобы случайно не проставить срок годности на наручные часы или сетку-рабицу. МДМ получает список категорий от МВО раз в несколько часов.
* В МДМе есть [интерфейс](https://mdm-testing.market.yandex-team.ru/arm/34657/) для работы с категориями.
* Первичным ключом категории во всём Маркете является `category_id (uint32)` или реже `hid` (устаревшая терминология МВО). ID для категорий генерит МВО при создании.

### MSKU {#msku}

Под категориями лежат карточки товаров. Их называют MSKU, и представляют они собой сферическое в вакууме идеальное описание товара. Модель товара, если угодно. Когда вы открываете товар на Маркете, вы видите преимущественно MSKUшные данные.

* MSKU - это идеальное описание товара. Так, факт наличия Bluetooth, срок годности или диагональ экрана — это то, что вполне может храниться на MSKUшках. А вот условия размещения на Маркете, поставщик, ставка НДС - неподходящие для этого уровня данные, так как не являются свойством самого товара (скажем, телефона).
* МДМ работает с MSKU и регулярно обогащает их мастер-данными. Многие компоненты Маркета как раз принимают результат работы МДМ в виде обогащённых MSKU-карточек.
* МДМ редко отдаёт эти карточки кому-либо напрямую — все апдейты сохраняются в МВО (т.к. именно МВО мастер система для MSKU), а уже МВО раздаёт карточки потребителям.
* [Интерфейс MSKU](https://mdm-testing.market.yandex-team.ru/mdm/msku) в МДМ. Можно нажать на "Случайные MSKU" и потрогать живые модельки.
* Первичным ключом MSKU во всём Маркете является `msku_id (uint64)` или реже `model_id` в старой терминологии МВО. Как и с категориями, ID для карточек выдаёт МВО при их заведении.

### SSKU

И, наконец, куда-то же должны складываться те самые страшные ставки НДС, логистические атрибуты и свойства продажи. Такие данные хранятся на уровне SSKU. Вообще, это довольно грязный уровень, и здесь могут храниться и те атрибуты, что должны по-хорошему быть в MSKU. Отчасти работа МДМ заключается в нормализации данных, чтобы MSKUшные данные перекладывались туда с SSKU, либо чтобы они на обоих уровнях хотя бы совпадали.

* Поставщики (партнёры) Маркета работают именно с SSKUшками, в том числе и заводят их.
* Практически все данные изначально задаются именно на этом уровне. Чаще всего самими же поставщиками.
* В ходе вычислений в МДМ данные могут перебегать с уровня SSKU на MSKU и обратно.
* Синоним слова SSKU - "оффер". Во многих командах SSKUшки называют именно офферами.
* Под одной MSKU может быть много офферов, но у оффера всегда не более одной вышестоящей MSKU. Таким образом структура `Категория -> MSKU -> SSKU` - это дерево.
* Мастер-системой по SSKU является Единое Офферное Хранилище (ЕОХ)
* [Интерфейс SSKU](https://mdm-testing.market.yandex-team.ru/mdm/ssku/) в МДМ. Можно нажать на "Случайные SSKU" и потрогать живые офферы.
* Первичным ключом SSKU во всём Маркете является пара `supplier_id (uint32)` и `shop_sku (string)`.

### Маппинги (привязки) {#mappings}

Связь MSKU и категории зашита в саму MSKUшку - она не может существовать вне категорий. В некоторых системах даже в качестве ключа MSKU используется пара `(category_id, msku_id)`, хотя это избыточно.

А вот связь SSKU и MSKU далеко не так прочна. По факту, когда партнёр заводит SSKUшку, она не принадлежит никакой MSKU и существует в вакууме. Затем, пройдя ряд сложных преобразований, SSKU может "помапиться" на карточку. Если такая связь появляется, то мы считаем, что у оффера появился *маппинг* и теперь он связан с MSKU.

* Мастер-системой по маппингам является [Категорийный Интерфейс](https://cm-testing.market.yandex-team.ru). Именно он их генерит и раздаёт остальным.
* Маппинги бывают разной степени надёжности. МДМ умеет работать полноценно с approved маппингами, которые проверены человеком или надёжным алгоритмом связывания карточки и оффера. Ещё МДМ ограниченно поддерживает suggest-маппинги для товаров определённого типа. Это маппинги от менее надёжной автоматики.
* Маппинги подвижны и могут запросто перемапить оффер из-под одной MSKU под другую. Такое особенно часто происходит на этапе классификации товара, когда, к примеру, чехол для айфона смапился на карточку айфона в категории смартфонов. И только потом человек исправляет ошибку, и маппинг меняется на вообще другой товар уже в категории чехлов.

[Подробнее](../../contour/business_domain/mappings.md)

## Драгоценные металлы

Итак, мы разобрались, какие бывают данные и как они организованы. Попробуем детализировать, что же именно мы с ними делаем.

### Серебро {#silver}

В терминологии МДМ *серебром* называются "сырые" входные данные, которые мы можем получать из разных мест:

* Замеры со складов
* Ручной ввод в UI МВО или МДМ
* Данные от партнёра (поставщика товара)
* Загрузка ассортимента из Категорийного Интерфейса

Такие данные не обязаны быть корректными и вообще адекватными. Тем не менее, мы сохраняем их as is. У нас вполне нормальна ситуация, когда поставщик указывает весогабариты, по плотности соответствующие нейтронной звезде, либо же страну производства "Кетай".

Серебро почти всегда приходит к нам на самом низком уровне SSKU. Серебро от разных источников имеет разный приоритет. К примеру, точный замер габаритов со склада гораздо ценнее данных от партнёра, которые нередко вбивают от балды.

{% note info "То серебро, и это серебро, но есть нюанс" %}

В целом мы нередко называем серебром вообще любые входные данные для какого-либо алгоритма. По факту в коде так оно обычно и есть, выражается в виде реализации интерфейса [SilverItem](https://a.yandex-team.ru/arc/trunk/arcadia/market/mbo/mbo-category/mbo-mdm-common/src/main/java/ru/yandex/market/mbo/mdm/common/masterdata/model/golden/SilverItem.java). Так, категорийные настройки тоже выступают как часть входного серебра для алгоритмов.

{% endnote %}

### Золото {#gold}

В результате компоновки серебряных данных мы по определённым алгоритмам и эвристикам выбираем наилучшие на наш взгляд данные. Затем компонуем их в итоговый объект и называем получившийся результат *золотой записью*. Или просто золотом

{% note info %}

Компоновка может варьироваться от простейшего "отсортируй по дате и возьми самое свежее" до каких-то хитрых манипуляций с весогабаритами, где мы вычисляем геометрическое среднее и ищем наиболее близкие варианты из входных данных с учётом приоритетов, версий, таймштампов и фазы луны.

{% endnote %}

Золото у нас бывает на уровнях MSKU и SSKU, причём *нередко золото одного уровня является серебром при вычислении другого*. Полученные золотые записи мы отправляем различным потребителям:

* МВО — туда сохраняем обогащённые золотые MSKU. А оттуда они через множество промежуточных пунктов попадают на выдачу.
* IRIS/WMS/Fulfillment - на склады отправляем оба уровня различными транспортами. Там мастер-данные используются для хранения, приёмки и транспортировки товаров.
* ERP/Axapta - учётная система для особых товаров Маркета, туда тоже отдаём оба уровня в экзотических форматах. Эта система в основном использует золото для корректной регистрации товаров в различных гос. реестрах и соблюдения различных бюрократических процедур.
* Indexer - опосредовано получает золото обоих уровней и толкает дальше до фронта Маркета
* MBI/Партнёрский интерфейс — получает резолюцию по серебру и золоту, чтобы можно было отобразить партнёру его косяки и попросить не продавать нейтронные звёзды.

{% note info %}

[Подробнее про золото и серебро](../../contour/business_domain/silver_and_gold.md)

{% endnote %}

## Соседи

Итак, мы примерно представляем, какие данные МДМ обрабатывает, как они организованы, и что в общих чертах МДМ с ними делает. Наконец, мы можем попробовать соединить всё это воедино в виде схемки.

![Соседи](../../_images/second_steps_2.png "Соседи")

## Обзор интеграций

Существует несколько различных интеграций между МДМ и соседними компонентами Маркета.

**Proto API**

Обычное http-API, представляющее собой эндпоинт на стороне приложения, принимающий http-запрос с телом в формате Google Protobuf.

{% note info %}

Исторически в Яндексе эндпоинты почему-то называют "ручками". Таким образом, фраза "дёрнуть ручку" означает сходить в APIшку какого-либо сервиса.

{% endnote %}

Кто ходит в наши ручки:

* Категорийный интерфейс (КИ) валидирует сырые мастер-данные, которые вводят категорийные менеджеры для ряда товаров. Search-метод из этого же сервиса используется складами при создании поставок (проксируется через КИ).

  [Proto](https://a.yandex-team.ru/arc/trunk/arcadia/market/proto/content/mdm/MasterData.proto)
  [Java](https://a.yandex-team.ru/arc/trunk/arcadia/market/mbo/mbo-category/mbo-mdm/src/main/java/ru/yandex/market/mdm/app/proto/MasterDataServiceImpl.java)

* WMS (Warehouse Management - склады) передают нам из своей админки сроки годности и флажки применимости сроков годности.

  [Proto](https://a.yandex-team.ru/arc/trunk/arcadia/market/proto/content/mdm/MdmShelfLife.proto)
  [Java](https://a.yandex-team.ru/arc/trunk/arcadia/market/mbo/mbo-category/mbo-mdm-common/src/main/java/ru/yandex/market/mbo/mdm/common/masterdata/services/msku/MdmShelfLifeServiceImpl.java)

* MBI - мегакомпонента, включающая в себя биллинг партнёров, сам Партнёрский Интерфейс (фронтенд, куда поставщики вносят свои товары для продажи) и много чего ещё. Нам они передают информацию о поставщиках, а также осуществляют миграции магазинов между их универсальными бизнес-идентификаторами.

  [Proto](https://a.yandex-team.ru/arc/trunk/arcadia/market/mbi/proto/BusinessMigration.proto)
  [Java](https://a.yandex-team.ru/arc/trunk/arcadia/market/mbo/mbo-category/mbo-mdm-common/src/main/java/ru/yandex/market/mbo/mdm/common/service/MdmBusinessMigrationServiceImpl.java)

* MBI (снова) - а ещё они заводят у нас документы и сертификаты, а потом связывают их с офферами.

  [Proto](https://a.yandex-team.ru/arc/trunk/arcadia/market/proto/content/mdm/MdmDocument.proto)
  [Java](https://a.yandex-team.ru/arc/trunk/arcadia/market/mbo/mbo-category/mbo-mdm-common/src/main/java/ru/yandex/market/mboc/app/proto/mdm/SupplierDocumentServiceImpl.java)

А в какие ходим мы:

* МВО Card API - мы ходим в МВО для [получения](https://market-proto-ui.vs.market.yandex.net/s/ru.yandex.market.mbo.http.ModelStorageService/find_models) и сохранения ([proto](https://a.yandex-team.ru/arc/trunk/arcadia/market/proto/content/mbo/ModelCardApi.proto), [java](https://github.yandex-team.ru/market-java/mbo/blob/master/mbo-card-api/src/main/java/ru/yandex/market/mbo/db/modelstorage/http/ModelCardMdmApiServiceImpl.java)) MSKU.


**Logbroker**

[Логброкер](https://logbroker.yandex-team.ru/docs/) - это местное изделие, несколько напоминающее kafka или Amazon SQS, но со своими особенностями. Хорошо подходит для потоковой асинхронной передачи больших объёмов данных между сервисами. Это стандарт де-факто для таких задач, когда не требуется синхронность взаимодействия, которую может гарантировать proto API. С кем мы так общаемся:

* Единое офферное хранилище (ЕОХ) - от него получаем cеребро, туда же отвечаем золотом по SSKU. Дополнительно вычитываем оттуда маппинги, которые туда заботливо складывает КИ. Таким образом, в ЕОХ хранится исчерпывающая информация про оффер.
* MBI - загребаем информацию о партнёрах.
* IRIS - это сервис для общения со складами и фулфиллментом Маркета. Нам он передаёт собранные со складов весогабариты и сроки годности (серебро), а мы возвращаем золото, в котором чаще всего лежат те же весогабариты, остаточные сроки годности и правила обработки особых маркированных товаров.

**Эзотерика**

Есть ещё ряд нестандартизированных интеграций:

* ПБД Аксапты — промежуточная БД между внутримаркетной секретной учётной системой и внешним миром, то бишь нами. Представляет собой обыкновенную MsSQL базу, в которую мы периодически записыаваем обновления, а Аксапта их оттуда вычитывает. Работает однонаправленно.
* Yt/YQL - в некоторых задачах мы просто-напросто дампим кучу данных в табличку в Yt, откуда потребители массово их зачитывают. Наоборот, когда читаем мы, тоже бывает. Таким образом мы считываем цены и ВГХ (запасной способ, основной через Логброкер), а от нас потребляют в больших количествах дампы золотых записей по SSKU.
* Http API без фиксированного протокола — то есть ручки без Proto. Их с десяток, в основном это дебажная или вспомогательная интеграция, собранная на коленке.

## Подрезюмируем

- МДМ занимается хранением и обработкой особых свойств товаров, называемых мастер-данными.
- Примеры мастер-данных — это весогабариты, карготипы, страны производства, документы.
- Хранение и обработка возможна на нескольких уровнях: категория, идеализированные карточки (MSKU) и офферы (SSKU). Ещё есть сущности-связки — это маппинги, опционально связывающие SSKU и MSKU.
- То, что приходит в МДМ в виде сырых данных, мы называем серебром.
- Обработанное серебро превращается в наилучшую запись о товаре — золото.
- МДМ обменивается золотом и серебром с десятком различных сервисов внутри Маркета, используя Proto-APIшки и Логброкер, реже — уникальные интеграции.
