# Первые шаги

Подготовим рабочую среду и проделаем путь от чистого ноута до первого коммита.

[Пропустить воду, сразу к делу](#setup)

## Из чего состоит рабочее окружение

В повседневной разработке мы юзаем следующий инструментарий.

**Arcadia**

Это общеяндексовая система контроля версий, представляющая собой *монорепозиторий*. То есть в отличие от Git, где традиционно на каждый проект создаётся свой репозиторий, а зависимости резолвятся либо библиотеками, либо сабмодулями, в Аркадии весь Яндекс — это и есть один большой проект. В одном пулл-реквесте вы спокойно можете проапдейтить файлик в Маркете, почесать протобуфину в Такси и поковырять конфиги в Геопоиске. Делать так, конечно же, не стоит, но техническая возможность есть. У Аркадии есть фронтэнд — [Арканум](https://a.yandex-team.ru/arc/trunk/arcadia).

**Arc**

Инструмент, позволяющий работать с Аркадией. Представляет собой консольную утилиту, чрезвычайно похожую на `git`. Помимо непосредственного контроля версий, осуществляет частичное копирование используемых участков монорепозитория на локальную машинку в виде виртуальной файловой системы. Другими словами, чтобы к вам на ноут не скопировался весь Яндекс, Arc забирает с сервера только реально используемые файлы по мере обращения к ним.

**Ya (make)**

Система сборки. Это Maven/Gradle, CMake, Pip и что угодно ещё в одном флаконе. Позволяет одним универсальным синтаксисом описывать зависимости и параметры билда любых проектов в Яндексе на поддерживаемых языках. Помимо прочего содержит в себе множество других утилит - Sandbox, Yt, компиляторы языков (!) и многое-многое другое. Это практически операционная система ~~которой не хватает хорошей системы сборки~~.

**IDEA**

В принципе, нет жёсткого ограничения на IDE, но это стандарт де-факто в Маркете. Для неё написаны плагины для Arc, которыми пользуется большинство.

## Стенды

В МДМе всего три стенда

- [Production](https://mdm.market.yandex-team.ru)
- [Testing](https://mdm-testing.market.yandex-team.ru)
- Локальный или development

  *Строго говоря, между локальным и dev-окружением есть разница. Локальное — это запуск с рабочего ноута на локалхосте. Дев — это запуск на разработческом дев-сервере. Однако второй способ мы редко используем, так как сложностей много, а разницы почти никакой. Проще один раз настроить локальный запуск и жмякать зелёный треугольник в IDE, чем каждый раз деплоить код, бросать тоннели для отладки и работать через ssh на деве. Однако БД в деве у нас общая на всех - и для тех, кто стартует с ноута, и для тех, кто с сервера.*

{% note info %}

В деве и тестинге просьба не оставлять немытой посуду. Если что-то разломали в процессе работы, то нужно потом вернуть в рабочее состояние. Если планируете какие-либо деструктивные действия в тестинге, просьба маякнуть об этом в чат, так как кто-то другой тоже может проверять свои изменения в тестинге.

{% endnote %}

## Настройка окружения { #setup }

**Шаг 1: IDE**

1. Устанавливаем IDEA Ultimate с официального сайта JetBrains.
2. Активируем лицензию с помощью сервера лицензий `https://keys.yandex-team.ru/jetbrains`.
3. Help -> Edit Custom VM options, в открывшемся конфиге увеличиваем прожор памяти для Идеи:
    ```
    -Xms1250m
    -Xmx2500m
    ```
**Шаг 2: SSH, Arc, Ya**

1. Настраиваем [SSH](https://wiki.yandex-team.ru/security/ssh/#instrukciiponastrojjkessh-klientov).
2. Устанавливаем Arc и Ya по инструкции [Starter Guide](https://docs.yandex-team.ru/devtools/intro/quick-start-guide). В том числе устанавливаем arc-плагин для IDEA.
3. Для удобства настоятельно рекомендуется прописать в ваш `.bashrc`, `.zshenv` или `.bash_profile` путь до смонтированной Аркадии и алиас для ya. Например, так:
    ```shell
    export ARCADIA_ROOT="/your/path/to/mounted/arcadia"
    alias ya="$ARCADIA_ROOT/ya"
    ```
4. Туда же прописать креденшиалы для доступа к датасорцам наших приложений из локального окружения. Для этого потребуется стащить пароль командой `ssh aida.yandex.ru "sudo cat /etc/confd/confd.toml"` (поле password), альтернативно - спросить у коллег. И прописать в вашем `.bashrc`, `.profile`, `.zshenv` или `.bash_profile`:
    ```shell
    export ETCD_USERNAME=datasources_read_all
    export ETCD_PASSWORD=<сюда пропишите полученный пароль>
    ```
5. Поставить openjdk-11 и пополнить список сертификатов по шагам 1 и 2 вот [тут](https://wiki.yandex-team.ru/security/ssl/sslclientfix/#vjava). Важно: у вас в системе может оказаться несколько java (например, одна встроенная в IDEA, другая — общесистемная) - нужно либо повторить это для всех, либо раскопировать проапдейченный файлик `.cacerts`  по остальным джавам.
6. *[Опционально]* Можно сразу прописать в `.bashrc`, `.zshenv`, `.profile` или `.bash_profile` дополнительные настройки, например, `export MDM_TEST_TIMEOUT_SEC="9223372036854775806"` - это позволит не обрубать тесты по таймауту при локальном запуске, что очень полезно для ручного дебага. Также можно сразу [настроить тулы](../practices/tools.md) в этих же файлах, ибо рано или поздно это всё равно придётся сделать.
7. Перезагрузиться

**Шаг 3: Настраиваем проект МДМ**

1. В смонтированном репозитории перейти в папку с нашим проектом `cd $ARCADIA_ROOT/arcadia/market/mbo/mbo-category`
2. Сгенерить проект для IDEA. Для этого можно запустить команду `ya ide idea --separate-tests-modules --with-content-root-modules --local --yt-store --iml-in-project-root --ascetic --directory-based -lr ~/IdeaProjects/$(basename $(pwd)) . ../libs`, но лучше даблчекнуть скрипт `bin/create-idea-project-with-libs.sh` в проекте — там может находиться более актуальный вариант команды.
   В конце сборки в консоли вам предложат использовать Checkstyle XML - соглашайтесь. Скачайте его и добавьте в IDEA (Ctrl+Alt+S -> Code Style).
3. Открыть полученный проект, указать jdk11 (Ctrl+Shift+Alt+S -> Project SDK)
4. В настройках IDEA (Ctrl + Alt + S) в разделе `File | Settings | Build, Execution, Deployment | Compiler` в поле `Shared build process VM options` прописать `-Djps.track.ap.dependencies=false`.
5. В настройках IDEA (Ctrl + Alt + S) в разделе `File | Settings | Build, Execution, Deployment | Compiler | Java Compiler` в поле `Additional command line parameters` передаём `-parameters`.
6. Ищем класс `MdmApplication`. Слева Идея должна предложить создать Run Configuration для запуска приложения (зелёный треугольничек напротив `main`). Создаём и оставляем всё по дефолту, прописываем лишь VM Options:
    ```shell
    -Dlog4j.configurationFile=mbo-mdm/src/main/conf/local/log4j2-test.xml
    -Dlogging.config=mbo-mdm/src/main/conf/local/log4j2-test.xml
    -Dconfigs.path=mbo-mdm/src/main/properties.d
    ```
    и указываем Working Dir в папку mbo-category.
7. Запускаем. Если в логах запуска пробежала надпись `Started MdmApplication`, значит, всё прошло успешно и приложение стартовало. При этом там может быть много каких-то исключений в логах — это нормально.

Готово!

{% note info "Известные проблемы" %}

{% cut "Kotlin: Not enough information to infer type variable T" %}

Данная ошибка IDEA чаще всего сигнализирует о том, что у вас стоит устарешвая версия плагина Kotlin. Для исправления:
* Открываем настройки / preferences IDEA.
* Заходим в раздел Languages & Frameworks
* Выбираем Kotlin
* Выбираем версию и обновляем

{% endcut %}

{% endnote %}

## Первый коммит

В МДМ у нас continuous delivery без ручного тестирования, релизы катаются в полуавтоматическом режиме. Чтобы запушить свои изменения в коде, проделываем такие упражнения:

1. В IDEA с установленным arc-плагином создаём новую ветку — жмём справа внизу на trunk -> New Branch. Ветку проще всего назвать по ID тикета, например, MARKETMDM-12345.
2. В IDEA жмём Alt+9, выделяем все файлы, которые хотим закоммитить. Right click -> Commit.
3. В теле коммита указываем ID тикета, под которым работаем и описание на английском. Например, `MARKETMDM-12345 Fix npe in document proto api`.
4. Push & Create PR
5. IDEA должна выдать ссылку на Арканум, где можно назначить ревьювера и после этого нажать Publish.
6. После разбора замечаний по ревью, докоммичивания фиксов и получения Ship-а в пулл-реквесте, можно нажать на Merge -> Auto Merge в Аркануме, и тикет будет смёржен.
7. Выкладка изменений в тестинг и прод происходит созданием релиза [здесь](https://tsum.yandex-team.ru/pipe/projects/mbo/delivery-dashboard/mbo-mdm-app-arc)

## Настройка Большого МДМ

Что такое Большой МДМ можно почитать [тут](mdm_internals.md#old_new_mdm).

1. Подготовка Mdm Ui.

    - Находим  `ru.yandex.market.mdm.ui.MdmUi`
    - Запускаем треугольником в IDEA (неважно, сработает или нет)
    - Идём в Run Configurations и сохраняем этот запуск, как новую конфигурацию.
    - Указываем Working Directory `$ARCADIA_ROOT/market/mbo/mdm`
    - Теперь должно запускаться и работать.
2. В точности аналогично для `ru.yandex.market.mdm.metadata.MdmMetadataApplication`.
3. В точности аналогично для `ru.yandex.market.mdm.service.MdmServiceApiApplication`.
4. В точности аналогично для `ru.yandex.market.mdm.storage.MdmStorageApiApplication`.
5. Подготовка фронта:

    - Создаём новую Run-конфигурацию с типом `npm`.
    - Указываем путь до `package.json`, например: `$ARCADIA_ROOT/market/mbo/mdm/mdm-ui/src/frontend/package.json` (если путь не сработал, замените на абсолютный путь в то же место)
    - В Command указываем `start`
    - Снизу в Before Launch добавляем плюсиком _Run External Tool_, как на картинке ![Запуск Ya make перед сборкой фронта](../../_images/first_steps_1.png)
    - А потом ещё одну добавляем, как на этой картинке ![Подкладывание дефиниций](../../_images/first_steps_2.png)
    - Затем там же в Before Launch добавляем плюсиком _Run npm script_. В нём прописываем Command `ci` и тот же путь до `package.json`. Порядок запуска этих трёх before-команд важен.
    - Запускаем — должен собраться фронт и открыть дев-страничку на локалхосте.
6. А теперь сделаем запуск этого всего по клику. В Run Configurations создаём новое с типом Compound. Добавляем созданные в пунктах 1-5 конфигурации и готово.

{% note tip "Локальный UI" %}

По умолчанию для удобства работы фронтенд-разработчиков собранный локально UI смотрит на живой тестинг МДМ. Чтобы переключить его на ваш локальный бэк, пропишите в файле `market/mbo/mdm/mdm-ui/src/frontend/.env.local.sample` хост и порт вашего приложения MdmUi. Обычно это

```
PROXY_HOST=http://localhost
PORT=8084
```

{% endnote %}

## Что делать дальше?

Выпытать у ментора первую задачку и пробовать сделать её! Ещё можно настроить подключение к PostgreSQL [по инструкции](../db/db_connect.md#postgres) или ознакомиться с [устройством МДМ](mdm_internals.md).
