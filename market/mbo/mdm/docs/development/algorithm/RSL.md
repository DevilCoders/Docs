# ОСГ
ОСГ - остаточный срок годности. Он представляет собой временные пороги, после которых товар можно или нельзя погружать к нам на складское хранение, а также отгружать для продажи. Это защищает нас от хранения товара, который нам привезли уже вот-вот протухшим, либо же от продажи такого несвежего старичка потребителю.

Когда говорят про ОСГ, обычно имеют в виду одну из двух вещей:
- Правила ОСГ или пороги ОСГ - это верхнеуровневая разметка, которая заливается [эксельками в МДМ](https://mdm.market.yandex-team.ru/mdm/period-of-remaining-shelf-life) и служит основой для варки конкретных значений в SSKU.
- Эффективные ОСГ или ОСГ на SSKU - конкретно вычисленные значения ОСГ, хранящиеся на уровне *сервиса* в SSKU. Вычисления *эффективных ОСГ* пользуются *правилами ОСГ*. Результат виден в редакторе SSKU в соответствующих read-only полях.

## Правила

Формально, ОСГ - это четыре циферки. Обычно в коде и различных интеграциях они обозначаются подобным образом:
- Days In - порог в днях "на вход", то есть на приём товара к нам на склад
- Days Out - порог в днях "на выход", то есть отгрузки со склада покупателю
- Percents In - порог в процентах от общего срока годности товара "на вход"
- Percents Out - аналогично, но "на выход"

"Так, а почему на вход и на выход по два порога - в днях и процентах?" - спросите вы. Дело в том, что для некоторых контрактов удобнее зафиксировать пороги прямо в днях, а для других - в процентах, если контракт подразумевает продажу совсем уж разношёрстных товаров. В случае конфликта порогов в днях и процентах будут выбраны наиболее мягкие для партнёра ограничения. То есть, сравниваем `Days` и `Percents * общий_СГ` и выбираем меньшее число.

{% note info %}

При работе с порогами ОСГ все дни отсчитываются в формате "сколько товару осталось жить", а не "какой у товара возраст". К слову, эти вычисления не производятся в МДМ - мы лишь предоставляем четыре числа. Непосредственное использование этих порогов происходит в WMS.

{% endnote %}

**Пример**

Рассмотрим следующие правила ОСГ:

Days In | Days Out | Percents In | Percents Out
---:|---:|---:|---:|
20 | 8 | 80% | 20%

Будем применять эти правила к молоку с общим сроком годности `30 дней`. Для начала переведём проценты в дни, используя общий СГ молока. Получим 24 дня на вход и 6 дней на выход соответственно.

Days In | Days Out |
---:|---:|
20 | 8 |
24 | 6 |

По правилу выбора наименьших порогов получаем итоговый комплект из двух чисел: `20 in, 6 out` (в днях). Теперь, используя эти пороги, мы можем описать, что будет происходить с конкретными коробками этого молока на складе.

Сколько осталось молоку | Что с ней можно сделать | Пояснение
:---|:---|:---
22 дня | Погрузить на хранение, отгрузить на продажу | 22 дня выше порога `20 in`, т.е. молоко аж на два дня свежее, чем нужно. Однозначно берём!|
20 дней | Погрузить на хранение, отгрузить на продажу | 20 дней равны порогу `20 in`. Пороги всегда включительны, потому такое молоко принимаем. Но завтра мы его бы не приняли!|
15 дней | Отгрузить на продажу | Молоко уже прожило полжизни. Брать такое на склад рискованно. А вот если оно уже там лежит, то самое время его отгрузить и продать.|
6 дней | Отгрузить на продажу | Это последний день, когда мы можем отгрузить молоко покупателю и не бояться, что оно протухнет по дороге. Out-пороги тоже инклюзивные.|
2 дня | Утилизировать | Такое молоко нельзя даже продавать, так как оно может приехать покупателю протухшим.|

{% note warning %}

Логически следует, что порог `in` всегда должен быть выше порога `out`. Однако МДМ по историческим причинам такого требования не накладывает и никак это не проверяет. Будьте внимательны при заполнении правил ОСГ.

{% endnote %}

## Уровни

**Уровень поставщика**

Источником для задания ОСГ является *договор с поставщиком*. У подавляющего большинства наших партнёров этот договор одинаковый, однако есть многочисленные исключения, которые Дата-стюарды МДМ задают вручную.

**Глобальный уровень**

Те самые общие правила, одинаковые для большинства партнёров, мы так и называем - уровень GLOBAL.

**Legacy-уровни**

Ранее в МДМ также поддерживалось заданее ОСГ на уровне категорий, MSKU и SSKU. Однако сейчас от этой практики отошли в пользу поставщиковой разметки. Тем не менее, техническая возможность пользоваться этими уровнями осталась, на странице [заливок экселек](https://mdm.market.yandex-team.ru/mdm/period-of-remaining-shelf-life) такой уровень называется DEFAULT.

**1Р и 3Р**

Поставщиковые контракты сильно детализированы:
- Для 3Р партнёров они детализированы до сервисов, то есть до конкретных моделей размещения
- Для 1Р партнёров они детализированы до REAL-поставщиков

Таким образом правила ОСГ - одно из немногих мест в МДМ, где в первичном ключе фигурируют сервисные или REAL-поставщики.

**Продовольственные товары и категории**

Разметка также детализируется по карготипу продовольственных товаров `cargoType750`. Помимо этого, может быть указана конкретная категория, на которую распространяются данные правила ОСГ этого партнёра.

**Ограничения**

ОСГ не может быть у товаров, у которых в принципе нет срока годности, поэтому варка ОСГ в МДМ учитывает и сам срок годности, и флажок его наличия на MSKU `expir_date`. Если СГ пуст или флаг установлен в false, то эффективные ОСГ на SSKU под такой MSKU записаны не будут.

Также у ОСГ есть "дата активации", начиная с которых эти правила начинают действовать. Дата может указывать в прошлое, тогда правило автоматически считается актуальным и активным. Дата может указывать и в будущее, тогда наши периодические процессы учтут эту разметку по наступлении заданного дня. На один и тот же уровень может быть задано несколько правил ОСГ с разными датами. В таком случае они не должны будут пересекаться, и в каждый момент времени будет действовать только один комплект правил, являющийся актуальным на текущю дату.

{% note tip "Первичный ключ" %}

В самом общем виде первичный ключ *правила ОСГ* выглядит как жирненький кортеж:

```sql
(
    service_supplier_id, --uint32
    real_supplier_id,    --string
    category_id,         --uint32
    cargo_type_750,      --bool
    activation_ts        --timestamp
)
```

{% endnote %}

**Интервальные правила**

На практике правила ОСГ часто задаются не просто как комплект из четырёх чисел, а как маппинг интервалов общего СГ на комплекты дней/процентов.

Предположим, что мы сотрудничаем с поставщиком произвольной еды. В этом случае может возникнуть проблема, что чатсь товаров хранится годами, а часть - неделю. Частично проблему можно решить процентными порогами, но даже они не всегда удобны. Именно для этого и указывается интервальный маппинг. Запись в эксельке с правилами схематично могла бы выглядеть так:

Общий СГ от | Общий СГ до | Days In | Days Out
---:|---:|---:|---:|
|| 14 дней |10 | 3 |
| 14 дней | 2 мес |10 | 5 |
|2 мес | 1 год|30 | 10 |
|1 год | |60 | 15 |

Тогда тушёнка от этого поставщика, у которой срок годности три года, не будет принята на склад, если ей осталось меньше 60 дней. Это долгохранимый продукт без высокого спроса, и брать тушёнку, которой осталось два месяца - себе дороже. И наоборот, у двухнедельного молока пороги совсем другие, там счёт идёт на единицы дней.


## Эффективные ОСГ

А в чём, собственно, заключается само вычисление на SSKU?

1. Забор MSKU для проверки общего срока годности и `expir_date`
2. Забор поставщиковых, категорийных и прочих правил
3. Расстановка правил по временной шкале с использованием даты активации
4. Выбор актуально действующих на SSKU правил по карготипу продовольственных товаров, категории и сервисного ID партнёра
5. Выбор конкретного комплекта из списка интервальных правил с использованием MSKUшного общего срока годности

Результат вычислений записывается посервисно в таблицу `mdm.reference_item`.

## Интеграции

Основной потребитель ОСГ - это складская система, то бишь WMS. Они могут получать от нас ОСГ аж тремя способами:

- Отправка `reference_item` через Логброкер в IRIS, [в коде](https://a.yandex-team.ru/arcadia/market/mbo/mbo-category/mbo-mdm-common/src/main/java/ru/yandex/market/mbo/mdm/common/service/queue/UploadReferenceItemsToLogbrokerService.java)
- Чтение `reference_item` из [суточных слепков](https://yt.yandex-team.ru/hahn/navigation?path=//home/market/production/mdm/dictionaries/reference_item/1d) (скорее всего она не участвует в продакшен-процессах по ОСГ, но это популярная табличка для аналитики)
- Чтение по сервисному ключу SSKU через контентные ручки Категорийного Интерфейса, которые в свою очередь ходят в нашу ручку [MasterDataService.searchSskuMasterData](https://a.yandex-team.ru/arcadia/market/mbo/mbo-category/mbo-mdm/src/main/java/ru/yandex/market/mdm/app/proto/MasterDataServiceImpl.java?rev=r9569554#L188)

WMS получает от MDM строго четыре числа — два порога в днях и два в процентах. Если комплект неполный, то это ненормальная ситуация, и в таком случае на стороне WMS возможны ошибки или использование их внутренних значений по умолчанию. Дата активации правил ОСГ используется только для внутренних нужд MDM и потребителям не отдаётся.

## Управление ОСГ
В MDM UI есть раздел [Остаточный срок годности](https://mdm.market.yandex-team.ru/mdm/period-of-remaining-shelf-life). В данном разделе можно:
- подготовить настройки ОСГ для скачивания (требуется роль VIEWER)
- скачать подготовленные настройки ОСГ (требуется роль VIEWER)
- импортировать правила ОСГ (требуется роль VIEWER, а также MDM_UI_OPERATOR или MDM_UI_ADMIN)

Сделать это можно для:
- THIRD_PARTY - 3p поставщиков
- FIRST_PARTY - 1p поставщиков
- GLOBAL - для всех поставщиков
- DEFAULT - хард настройки негибких ОСГ на категорию/мскю/сскю

## Импорт ОСГ файлом
### Примеры файлов
[FIRST_PARTY](https://jing.yandex-team.ru/files/mar4eli/supplier-rsl-import.xlsx)

### Алгоритм обработки файла
1. в MDM UI на странице [Остаточный срок годности](https://mdm.market.yandex-team.ru/mdm/period-of-remaining-shelf-life) загружается файл
2. Обработка файла идёт в классе [SupplierRslExcelImportService](https://a.yandex-team.ru/arc/trunk/arcadia/market/mbo/mbo-category/mbo-mdm-common/src/main/java/ru/yandex/market/mbo/mdm/common/rsl/SupplierRslExcelImportService.java?rev=r9462321#L42)
3. По результатам обработки файла формируется [RslDiff](https://a.yandex-team.ru/arc/trunk/arcadia/market/mbo/mbo-category/mbo-mdm-common/src/main/java/ru/yandex/market/mbo/mdm/common/masterdata/model/rsl/RslDiff.java?rev=r9463440#L8) и записи в таблицу `mdm.supplier_rsl`. В `rslDiff` заносятся 3p и 1p поставщики. Для 1p поставщиков так же сохранен real supplier id для фильтрации изменившихся ssku, иначе бы мы добавляли постоянно весь 1p ассортимент.
4. `RslDiff` передаётся в таску [RslToGoldenRecordTask](https://a.yandex-team.ru/arc/trunk/arcadia/market/mbo/mbo-category/mbo-mdm-common/src/main/java/ru/yandex/market/mbo/mdm/common/masterdata/model/rsl/RslToGoldenRecordTask.java?rev=r9463450#L8) для обработки изменений.
5. Таска обрабатывается в [RslToGoldenRecordTaskHandler](https://a.yandex-team.ru/arc/trunk/arcadia/market/mbo/mbo-category/mbo-mdm-common/src/main/java/ru/yandex/market/mbo/mdm/common/masterdata/services/rsl/RslToGoldenRecordTaskHandler.java?rev=r9463452#L13). Для этого с помощью [SskuRslServiceImpl::findEffectivelyAffectedOffers()](https://a.yandex-team.ru/arc/trunk/arcadia/market/mbo/mbo-category/mbo-mdm-common/src/main/java/ru/yandex/market/mbo/mdm/common/masterdata/services/rsl/SskuRslServiceImpl.java?rev=r9463459#L43) достаётся список всех SSKU, подверженных изменениям, и они отправляются на пересчёт.


### Джоба обработки отложенных изменений ОСГ
В файле импорта можно указать даты действия ОСГ. Если дата действия в будущем, то при загрузке файла изменение не будет применено.

Чтобы изменения применились, есть tms [ProcessSendToGoldRecalculationSskusWithActivatedRslExecutor](https://a.yandex-team.ru/arc/trunk/arcadia/market/mbo/mbo-category/mbo-mdm-tms/src/main/java/ru/yandex/market/mbo/mdm/tms/executors/ProcessSendToGoldRecalculationSskusWithActivatedRslExecutor.java?rev=r9463486#L44). Tms по крону ходит в таблицу `mdm.supplier_rsl`, достаёт записи изменений ОСГ, которые необходимо применить, и добавлять SSKU / MSKU на пересчёт.

У данной tms есть рубильник в `mdm.storage_key_value`. Значение рубильника хранится в коде в параметре `MdmProperties.RSL_GOLD_QUEUEING_ENABLED`.

Помимо рубильника, в `mdm.storage_key_value`  хранится и дата последнего запуска tms - `rslJobPreviousFireDate`.

{% note warning %}

Если `rslJobPreviousFireDate` выставлен неверно или джоба давно не запускалась, есть опасность добавить почти весь маркет на пересчёт. Перед включением джобы **обязательно** проверьте его значение.

p.s. На момент написания статьи `mdm.storage_key_value` `rslJobPreviousFireDate` равен "2022-01-28", т.е. уже отстаёт на более, чем 4 месяца.

{% endnote %}


## Дополнительные материалы
[Пайплайны ОСГ и как их чинить](https://wiki.yandex-team.ru/market/mdm/howto/pajjplajjny-osg--kak-chinit-i-kuda-smotret/)
[Регламент по работе с ОСГ (бизнес процессы)](https://wiki.yandex-team.ru/users/speranskiyn/kartochka-sg/#4.2.upravlenieosg)
