# Карготипы ЧЗ

Честный знак представлен в мдм тремя карготипами

## Как хранится

Каждый из карготипов - это параметр уровня *MSKU*

### В конструкторе

- [Маркировка обязательна для всех поставок (новых и старых) aka __*cis-required*__ aka __*cargoType980*__](https://mdm.market.yandex-team.ru/constructor/mdm-entity-type/215906716/221506875)
- [Маркировка обязательна только для новых поставок aka __*cis-distinct*__ aka __*cargoType985*__](https://mdm.market.yandex-team.ru/constructor/mdm-entity-type/215906716/221506869)
- [Маркировка необязательна aka __*cis-optional*__ aka __*cargoType990*__](https://mdm.market.yandex-team.ru/constructor/mdm-entity-type/215906716/221506863)


### В БД

{% note tip "Я мимокрокодил, просто скажите, откуда мне селектить ЧЗ в Yt!" %}

В этом случае рекомендуем брать ЧЗ с MSKU по версии МВО, см. чуточку ниже.

{% endnote %}

- MSKU по версии МДМ ([Yt](https://yt.yandex-team.ru/hahn/navigation?offsetMode=key&path=//home/market/production/mdm/storage/msku_gold), [пример в YQL](https://yql.yandex-team.ru/Operations/Ys6tSslwvT0n8WYW0VlIV-TpcbxLZUO-DqQVgA7JWVo=)). Это внутренняя таблица МДМ и показывать её смежникам категорически не рекомендуется. Однако внутри МДМ по ней могут гоняться сверки, так как в ней в отличие от МВО есть типы источников.
- MSKU по версии МВО, можно использовать в своих процессах. Если собираетесь плотно подсесть на это дело, то, пожалуйста, уведомите службу МВО о том, что вы становитесь потребителем этой таблицы. Таблица в [Yt](https://yt.yandex-team.ru/hahn/navigation?path=//home/market/production/mbo/export/recent/models/sku), [пример в YQL](https://yql.yandex-team.ru/Operations/Ys6udq5ODyV7CUN9v5r1aYHWShyyhwu3nN3Euj0JcuU=).


### В докторе и UI

В Докторе параметры ЧЗ доступны на вкладке `MDM` по следующим `xslName`, равным `cargoType980`, `cargoType985` и `cargoType990`


## Откуда приходит

Вообще говоря, честный знак к нам ниоткуда не приходит, а группа связанных с этим понятием карготипов рассчитывается на основании уже имеющихся знаний о категории *MSKU*.

Однако, оператор мдм имеет полномочия изменить уже рассчитанные карготипы своими руками или средствами авторазметки. В таком случае операторские изменения будут храниться на *MSKU* с `source_type == MDM_OPERATOR` или `source_type == MDM_ADMIN` в зависимости от режима сохранения. При этом в качестве `source_id` будет храниться staff-логин оператора.

## От чего зависит

Карготипы ЧЗ рассчитываются на основании:
- знаний о категории, которые берутся из [категорийных настроек](https://mdm.market.yandex-team.ru/mdm/category-param-values)
- [префикса ТН ВЭД](hs_ccc_prefix.md)
- [дерева ТН ВЭД](https://mdm.market.yandex-team.ru/mdm/tnved-categories)

В категорийных настройках хранятся знания о префиксе ТН ВЭД. Чтобы понять, какие следует ожидать значения для параметров, достаточно посмотреть в графу __*Честный знак*__, корня с сответствующим префиксом.

## На что влияет

- [CisHandleMode](hs_cis_handle_mode.md)

## Как вычисляется
Вычисление карготипов происходит при пост процессинге золотых блоков мску. Алгоритм примерно следующий:
1) Из категорийных настроек вычитывается префикс ТН ВЭД
2) По префиксу определяется узел дерева ТН ВЭД, который ему соотвествует. Из дерева вычитывются все характеристики узла
3) Данные о разметке уже хранятся на узле, надо их просто взять. Мы и берем - так получается новое золотое значение
4) Новое вычисленное золотое значение вступает в борьбу с уже имющимся. Борьба может идти в 3 этапа:
    1) в первом выживает тот, кто был установлен вручную
    2) если нет победителя, во втором выживает тот, приоритет чьего источника выше в мдм
    3) если  до сих пор нет победителя, приоритет отдается самому свежему значению


## Валидации

Не валидируется

## Куда отдаётся
- В МВО на уровне MSKU, что затем уезжает в Датакэмп и Индексатор
- В erp по ключам замапленных на *MSKU* 1р *SSKU*
