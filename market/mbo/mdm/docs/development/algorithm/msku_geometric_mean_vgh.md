Алгоритм находится в `SskuToMskuGoldenItemService`.

# Входные данные
1. Текущее золотые ВГХ msku
2. Золотые ВГХ связанных ssku
3. Категорийные настройки КГТ

ВГХ поставляются в `DimensionsBlock`-ах, а настройки КГТ в `GoldComputationContext`.

# Алгоритм
1. Среди блоков с ssku выбираем те, чей источник изменений  имеет наивысший приоритет. Остальные отбрасываем.

    {% cut "Подробнее про приоритет источников" %}

    Дефолтные приоритеты источников определены в [MasterDataSourceType](https://a.yandex-team.ru/arc_vcs/market/mbo/mbo-category/mbo-mdm-common/src/main/java/ru/yandex/market/mbo/mdm/common/masterdata/model/golden/MasterDataSourceType.java) (чем меньше `defaultPriority`, тем больше приоритет). Именно они используются в этом алгоритме, с учетом апгрейда источника `SUPPLIER` до `WAREHOUSE` для всех данных, полученных после 23.10.2020. [Подробнее в MBO-27725](https://st.yandex-team.ru/MBO-27725)

    {% endcut %}

2. У оставшихся блоков высчитываем средний геометрический вес, а также среднюю геометрическую сумму размеров (длина + ширина + высота).

    {% cut "Метод рассчета среднего геометрического" %}

    Среднее геометрическое считаем по формуле:
    $mean = e^{\frac{1}{n}\sum{\ln{a_i}}}$

    {% endcut %}

3. Из оставшихся после шага 1 выбираем блоки, имеющие наименьшее отклонение от средних величин, высчитанных на предидущем шаге.

    {% cut "Подробнее" %}

   Для каждого блока считаем отклонение от средних по формуле:
   $$diff = max(reldiff(\textit{meanWeigth},\textit{blockWeight}),reldiff(\textit{meanDimensionsSum},\textit{blockDimensionsSum}))$$

   Где:
   * `meanWeight`, `meanDimensionsSum` - средний геометрический вес и сумма размеров соответственно, высчитанные в пункте 2
   * `blockWeight`, `blockDimensionsSum` - вес и сумма блока
   * `reldiff` - относительная разница
     
     $reldiff(a,b) = \frac{max(a, b)}{min(a, b)}$

    {% endcut %}

4. Из выбранных на предыдущем шаге берем самый приоритетные по соответствию категорийной настройке КГТ (учитываются и КГТ30, и КГТ20).

    {% cut "Что такое приоритет блока по соответствию КГТ?" %}
   
   * Учитываются и override-ы, и значения на категории (всё задаётся в МБО)
   * Чем больше приоритет - тем приоритетнее блок.
   * Изначально у всех блоков приоритет 0.
   * Если блок соответствует категорийной настройки heavyGood20 его приоритет увеличивается на 1.
   * Если блок соответствует категорийной настройки heavyGood30 его приоритет увеличивается на 2.
   * Соответственно, максимальный приоритет равен 3, он достигается, когда блок соответствует обеим настройкам.
   
    {% endcut %}

5. Среди оставшихся блоков выбираем самый новый.
6. Если итоговый блок отличается от текущего золота незначительно, оставляем текущее золото, иначе выбранный блок становится новым золотом. При этом если найти итоговый блок не удалось - старое золото исчезнет.
   
   {% cut "Подробнее" %}

   В текущей реализации два неотрицательных числа  `a` и `b` отличаются незначительно, если $min(a, b) * 1.1 >= max(a,b)$.

   Два `DimensionBlock`-а отличаются незначительно, если все их соответствующие параметры (длина, ширина, высота, вес) отличаются незначительно.

   {% endcut %}

# Ссылки
[Статья на вики](https://wiki.yandex-team.ru/market/mdm/howto/algo/closest-to-geometric-mean-algo/)
