# Вычисление срока годности

Срок годности (СГ) в МДМ представляет собой пару вида `число` + `единица измерения` и опционально комментарий. Например, `12 дней` с комментарием `Хранить в сухом прохладном месте`. Единицу измерения ещё иногда называют словом "юнит" или `unit` и она может принимать одно из значений: `часы`, `дни`, `недели`, `месяцы`, `годы` или `не ограничен`.

Срок годности, содержащий только число и единицу измерения, вполне может быть валидным. Срок годности, состоящий лишь из одного комментария в большинстве случаев будет считаться с точки зрения валидаторов некорректным.

Помимо этой стандартной тройки атрибутов результатом работы МДМ также может быть флажок, требующий скрывать СГ при отображении MSKU на фронте Маркета.

## Как хранится

Срок годности - атрибут уровней MSKU и *базовой части* SSKU.

**В конструкторе**

- [Серебро SSKU](https://mdm.market.yandex-team.ru/constructor/mdm-entity-type/884303947/884336948/37387/37434/37057/37157/35430)
- [Золото SSKU до наследования](https://mdm.market.yandex-team.ru/constructor/mdm-entity-type/884195943/3549740075/37347/4337630145/35430)
- [Золото SSKU после наследования](https://mdm.market.yandex-team.ru/constructor/mdm-entity-type/884195943/3549740075/37347/37309/37057/37157/35430)
- В MSKU конструктор сконфигурирован на старый лад в плоском виде, поэтому там атрибуты СГ живут отдельно без группировки:
  - [Значение](https://mdm.market.yandex-team.ru/constructor/mdm-entity-type/215906716/221506719)
  - [Единица измерения](https://mdm.market.yandex-team.ru/constructor/mdm-entity-type/215906716/221506722)
  - [Комментарий](https://mdm.market.yandex-team.ru/constructor/mdm-entity-type/215906716/221506743)

**Сами значения в БД МДМ**

{% note tip "Я мимокрокодил, просто скажите, откуда мне селектить СГ в Yt!" %}

В этом случае рекомендуем брать СГ с *MSKU по версии МВО*, см. чуточку ниже.

{% endnote %}

- Серебро SSKU ([Yt](https://yt.yandex-team.ru/hahn/navigation?offsetMode=key&path=//home/market/production/mdm/storage/ssku_silver), [пример в YQL](https://yql.yandex-team.ru/Operations/Ysbn-9JwbCKncRdn07QaMKzE4Dxvx17CGIBCSJ6cNpI=))
- MSKU по версии МДМ ([Yt](https://yt.yandex-team.ru/hahn/navigation?offsetMode=key&path=//home/market/production/mdm/storage/msku_gold), [пример в YQL](https://yql.yandex-team.ru/Operations/Ysgd765OD3SByRQMQQjNfC_7b4PVYdKRibTlJZ3VA4g=)). Это внутренняя таблица МДМ и показывать её смежникам категорически не рекомендуется. Однако внутри МДМ по ней могут гоняться сверки, так как в ней в отличие от МВО есть типы источников.
- MSKU по версии МВО, можно использовать в своих процессах. Если собираетесь плотно подсесть на это дело, то, пожалуйста, уведомите службу МВО о том, что вы становитесь потребителем этой таблицы. Таблица в [Yt](https://yt.yandex-team.ru/hahn/navigation?path=//home/market/production/mbo/export/recent/models/sku), [пример в YQL](https://yql.yandex-team.ru/Operations/Ysb-RgVK8LV5DiLQlcHv_ppQP2TVA2s03QxzxPaSph8=).

{% note warning "Золото SSKU" %}

Для золота SSKU пока нет надёжной таблички с финальными СГ. Из-за сложного алгоритма наследования целевые СГ хранятся в "промежуточном золоте", которое существует только в PostgreSQL. Для разового пользования можно извлекать финальные СГ прямо из таблицы [ЕОХ](https://yt.yandex-team.ru/hahn/navigation?offsetMode=key&path=//home/market/production/indexer/datacamp/united/basic_offers) по полю `master_data.shelf_life`.

{% endnote %}

**В докторе и UI**

В Докторе параметры СГ доступны на вкладке `MDM` по `xslName`, равным `LifeShelf`, `ShelfLife_Unit` и `ShelfLife_Comment`. В нём, а также в редакторе SSKU отображаются промежуточные СГ до наследования.

## Откуда приходит

Для СГ существует несколько потенциальных источников, *все они сохраняются в серебро SSKU и только туда*, чтобы потом принять участие в варке по приоритетам.

1. Операторские изменения на MSKU или SSKU. Такие изменения в зависимости от режима сохранения будут иметь `source_type == MDM_OPERATOR` или `source_type == MDM_ADMIN`. При этом `source_id` будет равен staff-логину оператора.
2. Складские изменения через стандартный пайплайн доставки MEASUREMENT-ов по Логброкеру от IRIS. В таких случаях `source_type == MEASUREMENT`, а `source_id` будет равен ID склада, откуда пришёл этот СГ. Если ID склада не указан или невалидный, то мы всё равно сохраним информацию, но она отвалится при варке СГ по приоритетам.
3. Складские ручные изменения из админки WMS. Это legacy-интеграция через синхронную прото-ручку `MdmShelfLifeService` и значения оттуда всегда приходят с логином складского оператора вместо ID склада. В МДМ с такими не работаем, поэтому для протокола сохраняем в серебро, но игнорируем в процессах. Такие замеры будут иметь тип `MDM_DEFAULT`.
4. Партнёрские данные из ПИ или КИ. Они приходят к нам строго через стандартную интеграцию с ЕОХ. Такие данные будут иметь `source_type = SUPPLIER` и `source_id = DATACAMP`. Иногда старое серебро может иметь устаревший формат `source_id` и в нём вместо `DATACAMP` будет дублироваться строкой ID самого партнёра или его сервиса.

## От чего зависит

Вычисление СГ зависит от категорийных настроек в МДМ.

- Настройка *"Применимы сроки годности"* принимает одно из трёх значений: `не применим`, `обязателен` или `не обязателен`. Если на категории установлено значение `обязателен`, то валидатор будет ругаться на отсутствие СГ, если его нет.
- Та же настройка *"Применимы сроки годности"* умеет спускаться на MSKU и превращается там в булевый атрибут `expir_date`, он же "Применимость СГ" или кратко ПСГ. При генерации вердиктов МДМ смотрит, что если этот флаг на соответствующей MSKU равен `false` (т.е. СГ не нужен), то и партнёра ругать за отсутствие СГ не стоит.
- Категорийные пороги сверху и снизу на величину СГ. Если СГ не попадает в этот коридор, то валидатор посчитает такое значение некорректным.
- Настройка *"Разрешить неограниченный срок годности"* разрешает или запрещает особую единицу измерения СГ - `не ограничен`. Эта настройка участвует в валидациях, только если помимо неё также заданы лимиты. В противном случае она проигнорируется!

## Валидации

Можно условно выделить два этапа, на которых валидируется срок годности. Это этап проверки серебра SSKU и шаг генерации вердиктов. Последний отличается от проверки серебра тем, что дополнительно проверяет флаг `expir_date` на MSKU и не делает скрытия по отсутствию СГ, если флага нет или он установлен в `false`. В остальных же случаях проверка одинаковая и придерживается следующей канвы.

- Значение СГ проверяется на наличие.
  - Если оно есть, продолжаем.
  - Если его нет, а в категории обязателен СГ, то заканчиваем валидацию с ошибкой отсутствующего значения `mboc.error.excel-value-is-required`.
  - Если его нет, но в категории и не требуется, то заканчиваем валидацию без ошибок.
- Значение СГ проверяется на юнит `не ограничен`.
  - Если юнит любой другой, продолжаем.
  - Если юнит как раз равен `не ограничен`, а в данной категории такие запрещены настройкой, то продолжаем валидацию с ошибкой значения вне диапазона `mboc.error.excel-value-not-in-range`.
  - Если юнит `не ограничен` и в данной категории такое допускается, то продолжаем валидацию без ошибок.
- Числовое значение с юнитом проверяется на категорийные пороги. Если их нет, то используются стандартные от 3 дней до 10 лет с разрешённым неограниченным сроком. При непопадании значения в границы генерится ошибка на выход за пределы диапазона `mboc.error.excel-value-not-in-range`.
- Проверяется комментарий (если он есть).
  - Если длина комментария превышает 250 символов, то валидация продолжается с ошибкой превышения длины `mboc.error.md-too-long-comment`.
  - Если комментарий не удовлетворяет регулярному выражению `^[\s0-9A-Za-zА-ЯЁа-яё.,;()-–—?!'"«»&%/°№]*$` (то есть содержит что-то *помимо* букв, цифр, пробелов и фиксированного набора разрешённых спецсимволов `.,;()-?!'"«»&%/°`), то валидация продолжается с ошибкой некорректных символов `mboc.error.md-comment-has-invalid-characters`.

{% note warning %}

Комментарий и числовое значение СГ проверяются в совокупности. Так, даже если число адекватное и удовлетворяет порогам, то при наличии невалидного комментария всё равно отбросится весь блок СГ (и наоборот).

{% endnote %}

В коде за валидацию СГ отвечает небольшой функциональный кусочек - `ShelfLifeBlockValidator`. Вызов валидации происходит в варке золота в методе `SskuGoldenMasterDataCalculationHelper#filterMasterData` - это та самая предварительная проверка перед проваркой. Ещё один вызов происходит при генерации вердиктов в конце варки SSKU, по сути этому посвящён целый кусочек пайплайна, выделенный в сервис `SskuVerdictProcessor`.

## На что влияет

Срок годности оказывает прямое влияние на вычисление [ОСГ](RSL.md). В этом случае алгоритм варки остаточных сроков годности смотрит на MSKU и по её сроку годности выбирает подходящее интервальное правило.

Для многих категорий СГ прорастает через MSKU на фронт Маркета. За то, в какой секции на странице товара будет отображаться эта информация (и будет ли вообще), отвечает "Шаблон для карточки" в [товарном дереве МВО](https://mbo.market.yandex-team.ru/gwt/?common=-1&deleted=-1&hidden=0&important=-1&itemsPerPage=20&mandatoryForSignature=-1&page=1&service=0&strict=-1&tab=PARAMETERS&through=-1&useForGuru=-1&useForGurulight=-1#tovarTree/hyperId=16128362/knowledges) на вкладке "Знания". Там в разделе "Характеристики" должна быть размечена секция под отображение сроков годности.

## Как вычисляется

Срок годности - это группа наследуемых через MSKU атрибутов, чем-то близкая по способу варки к ВГХ. С высоты птичьего полёта пайплайн можно описать так:

1. СГ приходит из различных источников и сохраняется к нам в серебро SSKU.
2. При варке SSKU происходит выбор наилучшей комбинации СГ от самого доверенного источника.
3. Такой наилучший в рамках одной SSKU набор СГ сохраняется в промежуточное золото как *промежуточный* СГ. Ещё такой СГ называется *СГ до наследования*.
4. Происходит варка MSKU, связанной с SSKU маппингом. В качестве входных данных она использует СГ до наследования из промежуточного SSKU-золота, посчитанный на шаге 3.
5. Выбрав наилучший СГ, MSKU сохраняет его в себя.
6. Происходит повторная варка теперь уже всех SSKU под этой MSKU. Теперь SSKU помимо обычного серебра видит и СГ на MSKU. Такой СГ конвертируется в SSKU-формат и называется *СГ после наследования*, он же *финальный*.
7. Такой финальный СГ и есть желаемый результат. Он записывается в промежуточное золото и оттуда будет раздаваться наружу потребителям.

А теперь попробуем детализировать алгоритмы варки, то есть попробуем разобраться, что значит "наилучшая комбинация СГ".

![Подробности](../../_images/shelf_life_1.jpg)

**Алгоритм варки промежуточных СГ (до наследования)**

Точка входа: `SskuGoldenMasterDataCalculationHelper#calculateGoldenMasterData`.

1. Собираем блоки СГ `ShelfLifeBlock` ото всех источников в один мешочек. Разбивкой серебра на блоки занимается `SupplierToBusinessSplitter`.
2. Проходим в код варки - это `MasterDataGoldenItemService`. В нём происходит выбор наилучшего блока по следующим правилам (`ShelfLifeBlockCalculationStrategies`).
      - Оставляем только те блоки, у которых `source_type` равен любому из: `MDM_ADMIN, MEASUREMENT, MBO_OPERATOR, SUPPLIER, MDM_OPERATOR, TOOL, DBS, MDM_DEFAULT`.
      - Если среди блоков есть `MEASUREMENT`-блоки, то среди них оставляем только те, у которых в `source_id` указан ID склада, у которого положительный приоритет. Список складов редактируется в [АРМе](https://mdm.market.yandex-team.ru/arm/1042432961/) и прогружается в кэшик в старый МДМ. На блоки других типов дополнительные ограничения не накладываются.
      - Среди оставшихся блоков выбирается те, у которых `source_type` имеет наивысший приоритет. Приоритеты (чем больше чиселка, тем приоритетнее источник):

        Источник | Приоритет
        :--- |:---
        MDM_ADMIN| 100
        MEASUREMENT| 90
        MBO_OPERATOR| 60
        SUPPLIER| 50
        MDM_OPERATOR| 50
        TOOL| 50
        DBS| 25
        MDM_DEFAULT| 10

      - Среди оставшихся блоков с одинаковым источником выбираем тот, у которого наивысший приоритет склада (если это `MEASUREMENT`-блоки), либо же самый свежий таймштамп обновления `updatedTs`, если получилось равенство по всем остальным признакам.
3. Полученный наилучший блок сохраняется в качестве результата до наследования в промежуточное золото. При этом используется специальная группа атрибутов, чтобы потом не законфликтовать с тем же СГ, но уже спущенным с MSKU.

**Алгоритм варки в MSKU**

Точка входа - `MskuCalculatingProcessorImpl#calculateGoldenItems`, а сама варка происходит в `MskuGoldenItemService`.

Подход не отличается почти ничем, но есть нюанс. Если в MSKU уже есть существующий СГ и его источник - `MDM_ADMIN`, `MDM_OPERATOR` или `MBO_OPERATOR`, то он добавляется в общий мешок блоков. А далее этот мешок (с человеческим существующим блоком или без оного) варится ровно по тем же правилам, что и для SSKU выше.

**Алгоритм варки финальных СГ (после наследования)**

С точки зрения не-разработчика алгоритма наследования как такового и нет - просто берём значения с MSKU и считаем их итоговым результатом для наших SSKU.

Для разработчика точка входа: `SskuGoldenMasterDataCalculationHelper#calculateGoldenMasterData` (опять).

Сразу после варки промежуточных СГ происходит попытка спустить СГ с MSKU. Для этого сервис `ShelfLifeLiteForceInheritanceService` просто-напросто перекладывает MSKU-данные в SSKUшные атрибуты. Обратите внимание, что сразу при прогрузке MSKU в `MskuParamValuesForSskuLoaderImpl` на параметры уже расставляется тип `MSKU_INHERIT`, поэтому даже `source_type` на данном шаге адаптировать не придётся. Такой `source_type = MSKU_INHERIT` позволяет удобно отделить значения после наследования от промежуточных.

## Куда отдаётся

- Через логброкер в ЕОХ
- Через ручку (нашу и контентные в КИ) для КИ и складов `MasterDataService#searchSskuMasterData`
- Выгрузки [master_data](https://yt.yandex-team.ru/hahn/navigation?path=//home/market/production/mdm/dictionaries/master_data/1d) (только СГ до наследования!)
- В МВО на уровне MSKU, что затем уезжает в Датакэмп и Индексатор
