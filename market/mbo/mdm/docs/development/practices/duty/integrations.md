# Интеграции: как что-то куда-то "подопнуть"

Нередко во время дежурства или интеграционного тестирования новых фичей возникает необходимость что-то куда-то запульнуть руками. Либо же наоборот, повторно импортировать к нам данные от соседей в обход основного автоматического пайплайна. Рассмотрим популярные практики.

{% note tip "Доктор" %}

Чтобы узнать актуальное состояние SSKU с точки зрения различных подсистем Маркета (КИ, МДМ, Хранилище и т.д.) можно использовать [Доктор](https://doctor.market.yandex-team.ru/offer-diagnostic). Чаще всего мы там смотрим:

- Золото SSKU
- Связанную с ней MSKU
- Вердикты: наши сырые на вкладке `MDM` и "отрендеренные" на вкладке `EOX`
- Суточная статистика по нашим очередям
- Серебро SSKU, причём на нашей вкладке можно увидеть, что мы фактически прочитали от ЕОХ, а на вкладке самого `EOX` - оригинал
- Категорийные настройки, повлиявшие на SSKU
- Полезные ссылки на популярные YQL и страницы в сервисах

{% endnote %}

{% note warning %}

Осторожно! Все ссылки здесь ведут на прод-страницы с реальными данными. Просьба переходить по ссылкам и пользоваться инструментами вдумчиво, указывая нужные вам корректные ID сущностей, с которыми вы работаете. Перед вызовом команды или URL-а для ручек обязательно перепроверьте все аргументы.

{% endnote %}


## Переотправить SSKU в Хранилище

На [странице очередей](https://mdm.market.yandex-team.ru/bmdm/queue-data) выбрать `SSKU в ЕОХ`, заполнить SSKU-шаблон и загрузить. Ограничение — порядка 5 тысяч строк за раз. В шаблоне указывать строго бизнес ключи.

**Как проверить**

Можно проверить отправленные офферы в [Докторе](https://doctor.market.yandex-team.ru/offer-diagnostic). Как только оффер доходит до ЕОХ, изменения почти в реальном времени освежаются на вкладке `ЕОХ` внизу в JSON-версии оффера. Чтобы понять, куда смотреть в этой Json, уточните, какие именно атрибуты интересуют пострадавшую сторону. Затем посмотрите в нашу конверсию прото-формата [MdmToDatacampConverter](https://a.yandex-team.ru/arcadia/market/mbo/mbo-category/mbo-mdm-common/src/main/java/ru/yandex/market/mbo/mdm/common/masterdata/services/param/MdmToDatacampConverter.java) и посмотрите, куда записывается нужный кусочек информации.

## Переотправить SSKU в ERP (Axapta)

На [странице очередей](https://mdm.market.yandex-team.ru/bmdm/queue-data) выбрать `SSKU в AXAPT`, заполнить SSKU-шаблон и загрузить. Ограничение — порядка 5 тысяч строк за раз. В шаблоне указывать строго бизнес ключи.

**Как проверить**

Нужно подключиться к ПБД — промежуточной базе данных, через которую ERP общается с внешним миром, то бишь и с нами в том числе. Альтернативно — спросить у пострадавшей стороны, пришли ли данные.

{% cut "Подключение к ПБД в проде" %}

![Настройки](../../../_images/integrations_1.png)

- Драйвер: `Microsoft SQL Server`
- Host: `orion-db.ld.yandex.ru`
- Port: `1433`
- Database: `YM_Dax2012_Int`
- URL: `jdbc:sqlserver://orion-db.ld.yandex.ru:1433;database=YM_Dax2012_Int;`

Пароль можно посмотреть в [секретнице](https://yav.yandex-team.ru/secret/sec-01fx5kh5g71v6hdd3njqnp07j9/explore/versions) по проперте `mbo.erp.pbd.jdbc.password`. Возможно потребуется отдельно запросить доступ на чтение.

{% endcut %}

</br>

Если выбрали вариант самостоятельной проверки, то целевая таблица зависит от тех данных, что вас попросили отправить.

- Сертификаты и документы попадают в таблицу `MBOCertificateIN`
- ВГХ, ТН ВЭДы, Честный ЗНАК, GTIN-ы и Vetis GUID-ы инсертятся в табличку `MBOSKUMasterDataIN`
- Логистические атрибуты (кванты поставки, "моки", календарь поставок, кол-во товаров в упаковке, минимальная партия) - в таблицу `MBOSSKU_Supply`

## Переотправить SSKU в IRIS/WMS

На [странице очередей](https://mdm.market.yandex-team.ru/bmdm/queue-data) выбрать `SSKU в IRIS`, заполнить SSKU-шаблон и загрузить. Ограничение — порядка 5 тысяч строк за раз. В шаблоне указывать сервисные ключи, но возможно сработают и бизнес-ключи.

IRIS служит буферным сервисом для транслирования данных от контентной службы Маркета в склады (WMS). Поэтому, когда просят отправить SSKU в WMS, то почти наверняка имеется в виду именно отправка в IRIS. Однако, пожалуйста, уточните, о каких именно атрибутах SSKU идёт речь. Часть важных атрибутов (например, GTIN-ы) отправляется другим транспортом и проходит через Хранилище, поэтому отправку в IRIS можно продублировать и перепосылкой этих же офферов в Хранилище, чтоб наверняка.

**Как проверить**

К сожаленью, никак, кроме как спросить у коллег, долетели ли до них данные.

## Переотправить MSKU в Хранилище {#msku_dc}

На странице [поиска MSKU](https://mdm.market.yandex-team.ru/mdm/msku) введите через пробел без запятых нужные вам ID MSKU и нажмите "Применить фильтр", чтобы получилось примерно вот [так](https://mdm.market.yandex-team.ru/mdm/msku?mskuIdsSearchText=138726396%20455643499%20660177721). После того, как MSKU-шки нашлись и отобразились в таблице ниже, нажмите кнопку "Освежить в MBO".

Эта процедура поднимает фиктивную версию на этих карточках и сохраняет это изменение в мастер-систему по MSKU, то бишь в MBO. У них при каждом обновлении карточки происходит её автоматическая переотправка в Хранилище. Это может происходить с небольшой задержкой в несколько минут.

**Как проверить**

1. Убеждаемся, что в МВО фиктивная версия реально поднялась. Для этого идём в [редактор карточки](https://mbo.market.yandex-team.ru/gwt/#modelEditor/entity-id=209711017) (не забудьте перейти на свою MSKU!) и смотрим, что заполнен параметр "Версия ручной синхронизации (МДМ)" (`xslName == 'mdm_force_sync_version', id = 23090590`). При этом он должен был только что обновиться и инкрементироваться.
2. Идём в [стейт Хранилища по MSKU](https://yt.yandex-team.ru/hahn/navigation?path=//home/market/production/indexer/datacamp/msku/msku) и смотрим, освежились ли там данные. Если искать через YQL, то возможна задержка в 5-25 минут.

## Переотправить MSKU в MBO

На [странице очередей](https://mdm.market.yandex-team.ru/bmdm/queue-data) выбрать `MSKU в MBO`, заполнить MSKU-шаблон и загрузить. Ограничение — порядка 5 тысяч строк за раз.

**Как проверить**

Смотрим в [редакторе карточки](https://mbo.market.yandex-team.ru/gwt/#modelEditor/entity-id=209711017) для вашей MSKU, дошли ли изменения.

{% note info "Синхронное сохранение" %}

Интерфейс [редактирования MSKU](https://mdm.market.yandex-team.ru/mdm/msku/352274001) в МДМ уже из коробки синхронно сохраняет карточки в МВО. Вполне возможно, что ваша задача лучше решается именно через непосредственное ручное синхронное редактирование из нашего UI, нежели отправкой через очереди.

{% endnote %}

## Освежить/отправить MSKU для WMS

WMS может брать MSKU-шные данные от нас как минимум двумя путями. Обязательно уточните у коллег, по какой из интеграций у них проблемы!

**Асинхронная доставка данных через хранилище**

Это стандартный пайплайн MDM -> MBO -> Хранилище -> IRIS -> WMS. Если вас попросили переотправить данные, бегающие по этому пайплайну, то просто проделайте [отправку MSKU в Хранилище](#msku_dc).

**Синхронная API через контентные ручки**

Это прото-ручка в КИ, которая служит неким супер-сборщиком всеобъемлющей информации про оффер и MSKU. Её интерфейс можно пощупать в [ProtoUI](https://market-proto-ui.vs.market.yandex.net/s/ru.yandex.market.mboc.http.DeliveryParams/search_fulfilment_ssku_params). Она read-only, поэтому можете смело указать нужный SSKU (да, она работает по SSKU, но внутри мапится на MSKU и юзает много MSKU-данных) и подёргать. Если там возвращаются некорректные MSKU-атрибуты, то:

1. Отредактируйте их или доставьте их в MBO любым из способов из этой документации;
2. Если это не помогло или данные в MBO уже корректные, то обратитесь в [поддержку Контента](https://t.me/+BLtdh-aFrLFhZjcy) за помощью в синхронизации этой MSKU в КИ.

Иногда вместо ручки `DeliveryParams/search_fulfilment_ssku_params` WMS использует `MboMappingsService/search_approved_mappings*` - это всё примерно про одно и то же, алгоритм действий аналогичный.

## Перезапросить SSKU из Хранилища

### Точечно

На странице [поиска SSKU](https://mdm.market.yandex-team.ru/mdm/ssku) введите через запятые пары `business_id shop_sku` и нажмите "Применить фильтр", чтобы получилось примерно вот [так](https://mdm.market.yandex-team.ru/mdm/ssku/?searchString=476004%2013600-DVRTKN04%2C%20481045%20МС-00064887%2C%20476004%2013600-DVRTKN08). После того, как SSKU-шки нашлись и отобразились в таблице ниже, нажмите кнопку "Сделать хорошо".

Эта процедура скачивает офферы из ЕОХ через синхронную API и прогоняет полный процесс импорта.

### Массово

Используем специальный инструмент Хранилища. Для этого следует подготовить специальную табличку в Yt с ключиками офферов, а затем указать Хранилищу через спецручку, что нужно переотправить эти офферы к нам.

[Инструкция](https://docs.yandex-team.ru/market-datacamp/components/routines/admin#post-/send_to_subscriber)

Рекомендации:

- Имеет смысл указывать `sync = false`, чтобы не словить пятисотку от таймаута ручки.
- Ручка выводит очень подробный лог. Если у вас что-то не получилось, почти наверняка в этом логе будет полезная подсказка. Если не легчает, то можно обратиться за помощью в команду Хранилища.
- Схема Yt-таблицы должна быть абсолютно точной, как указано у них в документации, включая сортировку колонок, тип int (например, с int32 для `business_id` не сработает) и имена колонок.
- Пример запуска cURL-ом: `curl -k -X POST "https://datacamp-admin.white.vs.market.yandex.net/send_to_subscriber?subscriber=MDM_SUBSCRIBER&proxy=hahn&table_path=//home/market/development/mdm/util/resync_offers_eox"`. Ключик `-k` помогает избежать ругани cURL-а на непроверенные сертификаты.
- Будьте осторожны - у APIшки нет защиты от дурака от слова "совсем". Если ошибиться таблицей или выбрать неудачные омегажирные офферы, то ЕОХ их нам смело отправит, а мы загнёмся. Поэтому обязательно оцените объёмы и перепроверьте аргументы в URL-е.

**Как проверить (для обоих способов)**

Смотрим в [Докторе](https://doctor.market.yandex-team.ru/offer-diagnostic), что серебро обновилось.

## Перезапросить маппинги из КИ

На странице [поиска MSKU](https://mdm.market.yandex-team.ru/mdm/msku) введите через пробел без запятых нужные вам ID MSKU и нажмите "Применить фильтр", чтобы получилось примерно вот [так](https://mdm.market.yandex-team.ru/mdm/msku?mskuIdsSearchText=138726396%20455643499%20660177721). После того, как MSKU-шки нашлись и отобразились в таблице ниже, нажмите кнопку "Импорт маппингов".

**Как проверить**

Зайдите на нужную MSKU в [редакторе](https://mdm.market.yandex-team.ru/mdm/msku/138726396) и справа в меню выберите пункт "Список SSKU на текущей MSKU". Этот список формируется как раз по маппингам. Если импорт прошёл успешно, вы увидите корректный список сматченных офферов.
