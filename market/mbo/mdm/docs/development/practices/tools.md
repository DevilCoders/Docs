# Запуск тулов в МДМ

Тулами (tools) мы называем небольшие исполняемые кусочки кода, которыми разово чиним какую-то проблему с данными или же просто используем как отладочную функциональность. Обычно тулы пишутся как самостоятельная `public static void main()` функция в отдельном классе, а чтобы иметь возможность подключиться к БДшкам и API, используется специальный контекст, помогающий из коробки завести коннекты к ним.

## Предварительная настройка

В файлах `.bash_profile`, `.profile`, `.zshenv` или `.bashrc` пропишите

```
export MDM_PG_USERNAME="ваш read-only логин от БД"
export MDM_PG_PASSWORD="ваш пароль от БД"
export MDM_PG_PASSWORD_TEST="ваш пароль от тестинговой БД"
```

Логин от тестинговой БД не нужен, так как мы используем один общий на всех. Логин и пароль от дев-БД вообще захардкожены, т.к. не являются секретом. Посмотреть ставки, явки и пароли для прода можно [здесь](../db/db_connect.md).

Чтобы переменные окружения подхватились, перезагрузитесь или сделайте logout + login. Чтобы проверить, что всё настроено корректно, запустите `CopySkvToDevTool` - всё должно заработать по зелёному треугольничку в IDEA.

## Существующие инструменты

- `CopyBusinessOfferToDevTool` - позволяет скопировать один бизнес-оффер со всеми потрохами с прод-окружения на дев. Под потрохами подразумевается: бизнес-группа поставщиков, существующее золото и серебро, маппинги и связанная MSKU, вердикты и категорийные настройки. Это пригождается, когда нужно локально воспроизвести багу на конкретном живом оффере, не меняя его в продакшене.
- `DowngradeDatacampVersionTool` - тула читает ключи офферов из файла в формате `supplierId_shopSku` (через нижнее подчёркивание) и понижает им версию от ЕОХ. Это бывает полезно, чтобы перезапросить некорректно импортированные данные, т.к. в противном случае из-за равенства версий мы проигнорируем повторный импорт.
- `PrintIntermediateGoldForMskuTool` - pretty-print промежуточного золота из бинарного формата в человекочитаемый. Нужно на переходный период, пока мы храним такое золото в виде байтов в PostgreSQL.
- `CopySkvToDevTool` - копирование всех [настроек SKV](skv.md) из прода в дев. Полезно для восстановления консистентности между окружениями, чтобы было возможно воспроизводить баги из прода локально.

## Как написать свою

Все тулы мы размещаем в папке [mbo-mdm/src/main/java/ru/yandex/market/mdm/app/tool](https://a.yandex-team.ru/arcadia/market/mbo/mbo-category/mbo-mdm/src/main/java/ru/yandex/market/mdm/app/tool).

Создайте новый класс примерно такого вида:

```java
@SuppressWarnings("checkstyle:all")
public class XxxTool { // Просьба соблюдать naming convention и указывать `Tool` в конце имени

    public static void main(String[] args) {
        ToolContext context = ToolContext.productionContext();

        // <Ваша логика здесь>

        // Используйте `context` для доступа к production-таблицам и классам.

        // Вы можете работать с тестингом и девом, просто используя ToolContext.developmentContext() или
        // ToolContext.testingContext() соответственно. Причём можно создать два разных контекста для
        // переливки данных из одного окружения в другое.
    }
}
```

{% note warning %}

Если по какой-то причине вы явно указываете у себя в туле личные пароли или токены от тестинга или прода, обязательно стирайте их перед коммитом! Иначе СИБ нас справедливо заругает и попросит перевыпустить скомпрометированные креденшиалы, а это лишняя работа. Все чувствительные данные должны жить только в секретнице и не должны передаваться по почте, Телеграму или через ПРы.

{% endnote %}
