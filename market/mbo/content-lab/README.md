# Модули Лаборатории Контента

Сборку и выкладку компонентов content-lab-api, content-lab-ui и content-lab-tms производится через релизную машину ЦУМе: https://tsum.yandex-team.ru/pipe/projects/mbo/delivery-dashboard/content-lab-arc

Запуск происходит автоматически при обнаружении новых коммитов в транке.

Выкладка в тестинг происходит автоматически, в прод по кнопке.

## Разработка

Разработка перенесена в Аркадию. Файлы, связанные со сборкой при помощи gradle будут позже удалены. Поддерживать их в актуальном состоянии не требуется.

### Открыть проект в IDEA:
```bash
cd ~/Projects/arc/arcadia
ya ide idea --with-content-root-modules --local --iml-in-project-root --directory-based --project-root ~/.arc-idea/content-lab market/mbo/content-lab market/mbo/content-lab/content-lab-ui/src/frontend-static/npm-run market/mbo/arcadia_node market/mbo/content-lab/content-lab-ui/src/frontend
idea ~/.arc-idea/content-lab # Команду idea можно сгенерировать IDEA -> TOOLS -> IDE Scripting Console
```

### Запустить __все__ тесты, проверку чекстайла, проверку класспаса
```bash
ya make -ttt
```

#### Как разрабатывать на java в аркадии
Правила разработки описаны здесь: https://wiki.yandex-team.ru/yatool/java/

#### Как разрабатывать на фронте в аркадии
Фронт вообще никак не поддержан в аркадии, поэтому мы изобрели полностью свою систему сборки.
**Важные моменты**
1. Node.js необходимо самотоятельно скачивать из интернета и класть в хранилище файлов (сендбокс или MDS)
2. Node_modules тоже необходимо самостоятельно создавать и класть в хранилище файлов (сендбокс или MDS)

Связано с техническими ограничениями сборки: сборка не может ходить в сеть за данными.

Чтобы облегчить эти 2 процесса были написаны скрипты:
1. Обновление версии node.js: market/mbo/arcadia_node
2. Обновление node_modules: market/mbo/content-lab/content-lab-ui/src/frontend-node-and-modules/node_and_modules_in_jar/node_modules_update.sh

**Очень важно! При изменении внешних зависимостей npm нужно обновить node_modules для аркадии по скрипту №2**  
При вызове любого из 2х скриптов будет обновлены файлы в vcs. Их нужно закоммитить.

Связть node & node_modules прописана вот тут: market/mbo/content-lab/content-lab-ui/src/frontend-node-and-modules/node_and_modules_in_jar/ya.make

## content-lab-ui

UI модуль предоставляет пользовательский интерфейс, реализованный на TypeScript/react/redux. Для взаимодействия с бэкендом используются REST сервисы (удобно посмотреть и попробовать по ссылке <clab-ui-address>/swagger-ui.html).

В UI работают в основном сотрудники Лаборатории Контента. Он позволяет:
1. Кладовщику принять товары во входящем перемещении, собрать, запланировать и отправить исходящее перемещение.
2. Ассистенту собрать товары на телеги, ассистировать фотографу, трекать местонахождение телеги в пайплайне обработки а также разобрать телегу перед обратной отправкой.
3. Фотографу просмотреть инструкцию по фотографированию конкретного товара
4. Ретушеру проверить отретушированные фото (валидируется размер и число фото локально + проходят валидации в MBO)
5. Редактору заполнить характеристики товара.
6. Проверяющему опубликовать карточку товара, либо вернуть с комментарием фотографу, ретушеру или редактору.
7. Администратору произвести необходимые покатегорийные настройки (число фото, тарифы, инструкции, тип товара), задать список типов товара, просмотреть и выгрузить статистику биллинга, запланировать входящие перемещения в Лабораторию а также просматривать данные о статусе входящих/исходящих перемещений и всех товаров, когда-либо планируемых/прошедших ЛК.
8. Также администратор может просматривать аудит и детали биллинга всех сотрудников, а сотрудники только свои аудит и биллинг.

В тестинг/прод окружениях аутентификация пользователя производится при помощи внутреннего passport.yandex-team.ru.

В дев окружении имя пользователя задается переменной ${contentlab.passport.debug-user}. По умолчанию это ${user.name} - то есть пользователь, который используется в ОС.

Для настройки прав доступа в проде используется https://idm.yandex-team.ru - система 'Лаборатория Контента'. В тестинге вместо прод инстанса IDM используется тестовый - https://idm.test.yandex-team.ru. Система та же.

В дев окружении пользователя необходимо добавить вручную в таблицу content_lab.clab_user. Для полного доступа дать роль 'ADMIN'.

## content-lab-tms

TMS запускает ряд периодических джоб, которые решают следующие задачи:
1. Получение от MBOC списка товаров, запланированных для обработки в Лабе
2. Отправка в MBOC текущего статуса обработки товара в Лабе
3. Обогащение товаров данными от MBO/MBOC/SS/IRIS
4. Обновление списка категорий из MBO
5. Заливка сырых и обработанных фото в S3 MDS
6. Заливка обработанных фото в Аватарницу
7. Подсчет биллинга
8. Подсчет статстик производства
9. Очистка ненужных данных с NAS
10. Управление перемещенияни в/из Лабы черех Axapta

К TMS можно подключиться по telnet на порту 8023

## content-lab-api

API компонент используется для предоставления API внешним сервисам. На данный момент используется для:

1. Предоставления FF-API, чтобы ЛК была доступна внешним компонентам как любой другой склад.
2. Предоставление IDM API, для управления правами доступа из IDM.

# Локальный запуск

**Общее**

1. Настраиваем etcd. Для этого задаем следующие переменные окружения:

```bash
export ETCD_ENDPOINTS=https://etcd01ht.market.yandex.net:3379;https://etcd02ht.market.yandex.net:3379;https://etcd03ht.market.yandex.net:3379
export ETCD_USERNAME=datasources_read_all
export ETCD_PASSWORD="<password>"
```

, где `<password>` (и, если надо, username) нужно взять из конфигов confd с дев машинки. Например, с помощью такой команды: `ssh aida "sudo cat /etc/confd/confd.toml"`.

2. Для получения доступа ко всему функционалу следует добавить пользователя в таблицу content_lab.clab_user с ролью ADMIN в дев базу content_production_development

**При помощи ya.make**
1. В папке с сервисом выполняем `ya make && ./bin/<component_name>-local-start.sh`
Пример: `ya make && ./bin/content-lab-ui-local-start.sh`

Приложение запуститься локально с теми же настройками, что и в продакшен/тестинг среде.  
Если в пропертях указан debug.port, то приложение запуститься на этом порту. Далее к нему можно приконнектиться через `remote` конфигурацию.

**Из Idea**
1. Создаем конфигурацию Spring Boot для запуска main класса
2. В Environment variables вставляем `PROPERTIES_DIR=<absolute-path-to-project>/<module>/src/main/properties.d`
3. В Use classpath of module выбираем `content-lab-*`. Внимание! модуль не должен быть content-lab-*-main. Только общий!

Пример:
![pic](https://jing.yandex-team.ru/files/anmalysh/idea64_MjYF27JLY4.png)

## Дополнительная информация для frontend-разработчиков (и не только)

1. Для запуска фронтовой части проекта, нам понадобятся два сервера - один будет отдавать приложение, второй - данные для него. С первым приложением все просто: оно находится в каталоге `./content-lab-ui/src/frontend`, устанавливается командой `npm install` и собирается командой `npm start`. Асинхронные вызовы с фронтовой части проксируются на порт 8080, на котором должно быть поднято бэкенд-приложение `content-lab-ui`
2. Для его запуска нужно выполнить команду `./gradlew :content-lab-ui:run`, но перед этим нужно настроить окружение. Для этого нам нужно настроить etcd, как описано выше. Эти конфиги нужно добавить в ~/.bashrc или ~/.bash_profile. Кроме этого, к ним у себя я добавил инструкцию `export _JAVA_OPTIONS="-Djava.net.preferIPv6Addresses=true"`, чтобы мы ходили по ipv6.
3. Если при подключении к удаленным хостам с Мака будут проблемы, но при этом хосты будут доступны через telnet, а отключение awdl0 `sudo ifconfig awdl0 down` не поможет, тогда можно воспользоваться инструкциями из этого треда (https://snaury.at.yandex-team.ru/50)
   Мне помогло `cd /Library/Java/JavaVirtualMachines/*.jdk/Contents/Home/jre/lib`, затем

```
sudo otool -tv -p _setDefaultScopeID libnet.dylib \
  | awk '/cmpl.*\$0x0/ {print $1}' \
  | sudo python -c 'exec """
with open("libnet.dylib", "r+b") as fd:
    fd.seek(int(raw_input(), 16) + 5)
    fd.write(chr(235))
"""'
```

4. Нам также нужно обновить сертификат для java, для этого выкачиваем его `curl https://crls.yandex.net/YandexInternalRootCA.crt > YandexInternalRootCA.crt` и применяем `sudo keytool -keystore $(/usr/libexec/java_home)/jre/lib/security/cacerts -keypass changeit -storepass changeit -importcert -alias yandexinternalrootca -file YandexInternalRootCA.crt` (JDK < 10) или `sudo keytool -keystore $(/usr/libexec/java_home)/lib/security/cacerts -keypass changeit -storepass changeit -importcert -alias yandexinternalrootca -file YandexInternalRootCA.crt` (JDK 10+)
5. После этого нужно запустить компонент локально (см. главу Локальный запуск). В каталоге фронтенда нужно запустить `npm start` соответственно.

# Доступ к NAS

NAS Лаборатории Контента доступен для внешних клиентов по протоколу WebDav. Для аутентификации используется TLS Client Auth.

Тестовый инстанс NAS: https://contentlab-nas-testing.market.yandex.net:444

Прод инстанс NAS: https://contentlab-nas.market.yandex.net:444

Так как NAS находится во внешней сети, ему нельзя дать яндексовый FQDN. Соответственно, для подключения неободимо в hosts файл добавить строку:
```
81.23.3.167         contentlab-nas.market.yandex.net
```

Для аутентификации необходимо использовать кейсторы:

для тестинга: https://yav.yandex-team.ru/secret/sec-01dem9ghm7ka5byjpngdbfaytr/explore/versions

Для прода: https://yav.yandex-team.ru/edit/secret/sec-01demc5fsara4415ajw2592pbh/explore/versions

Настраивается доступ по разному на разных ОС, но общий путь такой:
1) Импортируем кейстор в хранилище сертификатов.
2) Подключаемся к сетевому диску, указываем NAS URL, выбираем требуемый сертификат из списка.

На NAS есть 2 основные папки - inprogress и processed. В первой находятся фотки, которые в данный момент создаются/ретушируются. Во второй уже снятые или отретушированные фото.

# Процессы в Лабе

Есть 2 основных процесса:

## Перемещение товаров в/из лаборатории.
 
Он состоит из следующего:
1. Входящее перемещение собирается и планируется в интерфейсе Администратора на вкладке "Планируемые перемещения". Исходящее перемещение собирается и планируется на вкладке Кладовщика. Как только оно запланировано, оно также появляется на вкладке Администратора в "Планируемых перемещениях".
2. После того как перемещение запланировано, TMS джоба movementControlExecutor отправляет данные о перемещении в Axapta. Оттуда же она получает статус по запланированным перемещениям. 
3. В проде перемещение в Аксапте продвигается автоматически. В тестинге нужно это делать вручную в интерфейсе Аксапты + на соответствующих складах, и это очень нетривиально. Описать этот процесс практически невозможно - если нужно эту часть будет тестировать, проще идти к соответствующим командам (Axapta/FF) и просить их помочь с тестированием. Вот примерный список действий в интерфейсе Axapta: https://paste.yandex-team.ru/750966.
4. При входящем перемещении, в какой то момент создастся поставка на склад ЛК (придет запрос createInbound по FF-API) и перемещение появится у Кладовщика. После приемки пемещениения мы отдадим соответствующий статус по FF-API и перемещение завершится в Axapta - мы получим от нее соответствующий статус и завершим планируемое перемещение.
При исходящем перемещении довольно быстро должно создаться изъятие в ЛК - соответственно перемещение Кладовщика перейдет в статус "Отправка". После чего его можно отправить. Также Аксапта создаст Поставку на склад назначения, там товар должны принять и после этого планируемое перемещение также завершается.

## Обработка товаров внутри Лабы:

1. Все начинается с появления входящего перемещения в интерфейсе Кладовщика. Чтобы не возиться с Аксаптой и планированием перемещений, можно вручную дернуть ручку API с необходимыми товарами по адресу <content-lab-api-url>/query-gateway. POST запрос должен содержать следующее: https://paste.yandex-team.ru/750943 (vendorId == supplierId, article == supplierSkuId). Пример содержит 2 товара, можно добавить сколько нужно. SSKU ID нужно выбирать правильно - чтобы товар был в тестовом MBOC и имел валидный маппинг на СКЮ в тестовом MBO. Также, в идеале у товара должны быть ШК в тестовом Stock Storage, но это не обязтельно - можно принять вручную с любым ШК. Также в запросе желательно поменять inboundId - он отображается в таблице перемещений. Дополнительно, если товары подойдут любые, есть джоба в TMS - createFakeInboundExecutor, которая сама создаст входящее перемещение с некоторым количеством товаров.
2. После того как перемещение создано, нужно обогатить товары вызовом джобы fetchMboDataExecutor в TMS. Если все ок в интерфейсе появится тайтл и другие данные о товаре. Если нет - появится ошибка напротив товара.
3. В интерфейсе кладовщика нужно найти перемещение, зайти в него и принять товар. Если у товара нет ШК - можно принять вручную задав ШК.
4. В интерфейсе ассистента нужно создать телегу и добавить в нее товар при помощи ШК, использованного при приемке. Когда необходимый товар добавлен в телегу нужно отправить ее дальше на фотографирование.
5. Далее нужно создать на тестовом NAS в inprogress папку со штрихкодом товара, положить сырые фотки (CR2) в папку Capture а обработанные (JPEG) в папку Output. Проще всего взять фотки из processed папки для какого то обработанного товара - иерархия внутри папки со ШК одинаковая. Также на тестовом NAS лежит скрипт inprogress/do_photo.sh, который делает примерно то же самое - запускается как `sh do_photo.sh <barcode1> <barcode2>`
6. В интерфейсе телеги ассистента завершаем фотографирование товара. Товар появляется на вкладке ретушера.
7. В интерфейсе ретушера берем товар в работу. Завершаем ретуширование.
8. После того как вся телега прошла фотографирование - телега отправляется на редактирование. Телега появляется в интерфейсе редактора.
9. Редактор берет в работу товар в телеге, заполняет параметры/картинки после чего завершает редактирование. Также можно просто сохранить изменения локально чтобы завершить редактирование позже.
10. В интерфейсе проверяющего товар виден уже после фотографирования, но только сейчас он может опубликовать товар.
11. После редактирования всех товаров из телеги она отправляется на разборку. Ассистент выкладывает товар из телеги на склад.
12. Дальше кладовщик может создать исходящее перемещение, добавить туда обработанный товар со склада и запланировать перемещение. Дальнейшее описано в предыдущей главе. Также для тестирования можно вручную отправить запрос в API подобный этому: https://paste.yandex-team.ru/750941 (vendorId == supplierId, article == supplierSkuId).

# Troubleshooting

В целом проблемы в ЛК довольно просто дебажить. Если что то случается на проде - всегда можно натравить локальный компонент на прод базу/mbo и практически все отдебажить.
Основной поток проблем в данный момент - проблемы с перемещениями в/из лабы.

Перемещение может полностью упасть и мы не получим изъятие/поставку. В этом случае нужно открывать тикет на Axapta (MARKETERP) с указанием идентификаторов перемещения (всех доступных) со вкладки планируемых перемещений.

Также в изъятии/поставке может прийти меньше товаров чем запрашивали. Особенно это большая проблема для обратных перемещений. В основном проблема заключается в том что товар уже пробовали переместить вручную и он где то зафризился (тоесть тупо либо Axapta либо FF считают что у нас нет товара для отправки).

Проверить фризы товара в FF можно через YQL подобным запросом https://yql.yandex-team.ru/Operations/XRVN4Z9LngbHx5VdtgVqt-wT5aaEiNulO8sppXgTev8=

Если в FF фризов нет - необходимо создать тикет в MARKETERP c идентификаторами перемещения и ssku id тех товаров, которые не пришли в изъятии. Если есть фризы в FF - вероятно висит изъятие (тоесть у нас в интерфейсе есть исходящее перемещение). Можно отменить исходящее перемещение и тогда фризы уйдут, но надо при этом понимать что данные о перемещении также почистили в Аксапте. Если изятия нет - нужно делать тикет в DELIVERY либо идти в чат FF Hotline.

# Полезные ссылки

Мониторинги: https://juggler.yandex-team.ru/dashboards/contentlab

Графики технические: https://nda.ya.ru/3UZdZ8

Nanny: https://nanny.yandex-team.ru/ui/#/services/dashboards/catalog/market_content_lab_all/

ЦУМ: https://tsum.yandex-team.ru/pipe/projects/mbo/delivery-dashboard/content-lab

Графики PGAAS: https://paste.yandex-team.ru/687175

Графики KPI: https://stat.yandex-team.ru/Market/Content/Clab

Исходники NAS: https://a.yandex-team.ru/arc/trunk/arcadia/contrib/nginx/modules/nginx-dav-ext-module

Рассказ про Лабу: https://moderator.video.yandex-team.ru/m/film-info?service=video-nda&n=5669

Презентация: https://wiki.yandex-team.ru/Market/Sluzhba-rarabotki-kontenta/Vstrechi-sluzhby/.files/contentlab-1.pptx

Секреты:

robot-mrk-clab-test: https://yav.yandex-team.ru/secret/sec-01dea0zy5zjcwgtanedr1bf07f/explore/versions

robot-mrk-clab-dev: https://yav.yandex-team.ru/secret/sec-01dea0sjh8bgxwj9ne7x0dykxh/explore/versions

robot-mrk-clab-prod: https://yav.yandex-team.ru/secret/sec-01dea17exk86re6wz4nbx8nhe9/explore/versions

content-lab-nas-testing: https://yav.yandex-team.ru/secret/sec-01dem9ghm7ka5byjpngdbfaytr/explore/versions

content-lab-nas-prod: https://yav.yandex-team.ru/secret/sec-01demc5fsara4415ajw2592pbh/explore/versions

content-lab-dev-secrets: https://yav.yandex-team.ru/secret/sec-01dem94gj4ex4dddzw39yj0zff/explore/versions
