Интеграционные тесты, которые запускаются на реальной БД
---
Запуск на реальном ORACLE из-за того, что нет возможности полноценно эмулировать ORACLE.
Также для корректного запуска в sandbox тесты перенесены в LARGE.
Раньше хотели переложить в интеграционные тесты mbo-core, но сейчас нет необходимости, так как ya make строит валидные графы изменений и в случае если где-то зацепит функциональные тесты, то функциональные тесты запустятся.

#### Конфигурация YA
Для того чтобы запустить тесты, которые ходят по сети, тесты должны иметь size = LARGE и доп теги: ya:fat и ya:external.
ya:external уведомляет CI о том, что тест ходит по сетке во внешнюю сеть.
ya:fat дополнительно помечает тест, что он LARGE.
Помимо этого для запуска тестов необходим токен, подтягивание токена настраивается в ya.make с помощью макроса REQUIREMENTS.

#### Конфигурация a.yaml
В a.yaml сделаны дополнительные настройки, во-первых, для запуска тестов необходим mbo.jdbc.yql.token так как при запуске контекста мы пытаемся сходить в yql с помощью CHYT и зачитать данные.
Для получения токена я его дополнительно переложил в sandbox [Sandbox vault](https://sandbox.yandex-team.ru/admin/vault) можно найти по названию: "dev.mbo.yql.jdbc.token".
Также задан идентификатор секрет, создавался руками для пользователя robot-mbo-ci sec-01g3brs40shxa0h2fbj73hqcd4, он необходимо для того, чтобы корректно запускать CI от нужного робота имеющего доступ к токену.

#### Как все устроено
- перед запуском тестов создаются пустые схемы в [БД большого тестинга](https://nda.ya.ru/t/uGzURvTO4ANo9c)
- далее накатываются liquibase скрипты для инициализации БД пустыми таблицами
- потом выполняются сами тесты
- каждый тест обернут в транзакцию (аннотация @Transactional) в конце теста транзакция откатывается
- после выполнения тестов, схемы очищаются и удаляются

Тесты можно запускать параллельно. Для предотвращения создания одинаковых схем используется мастер-таблица в отдельной мастер-схеме, которая оркестрирует выданными схемами.

#### Как разработывать локально
- Запуск тестов с помощью команды, если вдруг падает из-за отсутствия yql.token либо etcd перепройтись по пунктам из корневого [README](../README.md#локальный-запуск-автотестов-через-ya-make)
```bash
ya make -ttt
```
- При локальной разработке тестовые схемы переиспользуются (для ускорения инициализации тестов). Если хочется при запуске каждый раз чистый запуск, то нужно установить переменную:
```bash
export MBO_REUSE_TEST_SCHEMAS=false
```

#### Чуть больше особенностей
- Все тесты **должны использовать одинаковый спринговый контекст**! Чтобы спринг переиспользовал его и не создавал кучу схем на одного пользователя.
- Так как имена схем выдаются динамически, то **нельзя явно указывать название схемы** в sql скриптах.

### FAQ
**Q:** Что же делать, если использовать межсхемные скрипты необходимо?  
**A:** В первую очередь нужно понять, можно ли скрипт переписать на джава сервис? Если да, переписываем.
Если переписать не получается, то можно использовать подстановку параметров в liquibase.  
**Важно** В настоящий момент site_catalog имеет связи на другие схемы, поэтому если нужно добавить таблицу с межсхемными связями, то лучше добавить ее туда.
Ни в коем случае не добавлять в схему market_content, иначе схемы циклически начнут зависеть друг от друга и мы не сможем поднимать оракл для тестов.

Пример. Пусть надо ставить в одну таблицу данные из другой:
```$sql
INSERT INTO ng_category_operation_tarif (SELECT DISTINCT GURU_CATEGORY_ID
                FROM ${market_content}.category
                WHERE GURU_CATEGORY_ID IS NOT NULL);
```
А в файле category.sql надо прописать:
```$sql
GRANT SELECT ON category TO ${site_catalog};
```

Для задания foreign key на таблицу из другой схемы:
```$sql
GRANT REFERENCES ON category TO ${market_content_draft};
```
