# Исходники для работы с ora2pg на виртуалке

##Как попасть на виртуалку:
    ssh mb-try-out-02.sas.yp-c.yandex.net
В случае отсутствия доступа запросить права у [@lena-san](https://staff.yandex-team.ru/lena-san) 
##Как пользоваться:
###ora2pg
На виртуалке есть ora2pg, которая настраивается путем правок конфига.\
Конфиг следующий всем пожеланиям по [конвертации типов](https://wiki.yandex-team.ru/users/sulim/howto/oracle-to-pg/konvertacija-tipov-oracle-postgres) это: [ora2pg.conf](ora2pg.conf). \
Человек, которому необходимо достать ddl должен поправить доступы к БД в конфиге(ORACLE_DSN, ORACLE_USER, ORACLE_PWD) \
и, если нужно, поправить конфиг ora2pg.
###Python постпроцессор
Далее, нужно настроить постпроцессор [postprocessor.py](postprocessor.py). \
Это питоновский скрипт который читает построчно файл, который сгенерила ora2pg и правит их, если это необходимо.  Для добавления правил обработки можно использовать dict, где ключ - regexp, которому подходит строка, а значение - функция от двух аргументов: \
первый - текущая строка, второй - search регекспа по строке (можно использовать для захвата каких-нибудь групп в regexp и замены их в итоговой строке). В этом методе строка каким-нибудь образом обрабатывается (запись в файл тоже лежит на этом методе). \
Если строка подошла под какой-нибудь regexp, то дальше проход не идет. Поэтому более общие проверки лучше добавлять в конец.
###Запуск ora2pg + постпроцессор
В той же директории есть sh скрипт, в котором проставляются необходимые переменные окружения (для работы ora2pg), создается директория output (ora2pg сам не умеет создавать) и запускается ora2pg с постпроцессором с нужными флагами.
    
    ora2pg -c ora2pg.conf -t TABLE --no_header -b ~/output && python3 ./postprocessor.py ~/output/

* -c -> указываем путь до конфига ora2pg
* -t -> type работы ora2pg. Про различные типы работы можно почитать в официальной [документации](https://ora2pg.darold.net/documentation.html)
*  --no_header -> по умолчанию ora2pg пишет в верх файла хедер о том, что файл заполнен с его помощью
* -b -> указываем путь до папки, куда сохранить результат работы. Этот же путь нужно указать постпроцессору как единственный аргумент для правильной работы

###Результат
Результат работы постпроцессора - changelog.xml с расставленными в порядке зависимостей таблицами и расписанные lqb миграции таблиц с правильными типами данных для колонок, индексами, fk/pk/constraint'ами. Их можно просто скачать себе по ssh (scp) и использовать.
