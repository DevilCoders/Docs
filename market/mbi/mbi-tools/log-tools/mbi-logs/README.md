mbi-logs
================

[Скачать](https://a.yandex-team.ru/api/tree/blob/trunk/arcadia/market/mbi/mbi-tools/log-tools/mbi-logs/mbi-logs)

Залезает на logview и выгрепывает кусок лога из логов partner-api или mbi-partner по времени.

Основные команды:

 * `partner-api-logview`
 * `mbi-partner-logview`

Эти команды работают схожим образом. Ниже описана их работа на примере `partner-api-logview`.

Так как лог partner-api слишком большой мы не можем грепать его непосредственно,
чтобы решить эту проблемму я написал скрипт, который
ищет в логе нужное время (бинарным поиском).
Этот скрипт работает за приемлемое время (несколько секунд).
Он запускается с локальной машины разработчика следующим образом:

````
    $ mbi-logs partner-api-logview <host на котором работает partner-api> @<timestamp запроса>
````

или

````
    $ mbi-logs partner-api-logview <host на котором работает partner-api> <время запроса>
````

Например:

````
    $ mbi-logs partner-api-logview gravicapa04v.market.yandex.net @1507253694 
    $ mbi-logs partner-api-logview gravicapa01v.market.yandex.net 2017-10-06T08:32:00
````

В результате скрипт залезет на logview и выведет кусок лога, начинающийся по времени

 * с <timestamp запроса> - 1 секунда и
 * по <timestamp запроса> + 1 минута 

Скприпт грепает логи с точностью до 1 килобайта, т. е. обрезание происходит по границе килобайтов.

Более подробно [зачем это всё нужно](https://wiki.yandex-team.ru/users/sviperll/partner-api-log-grep/)


Более низкоуровневые команды
-----------------------------

Можно grep'ать произвольные логи на локальной машине, для этого есть команда: `extract-time-range`, которая
вызывается следующим образом:

````
    $ mbi-logs extract-time-range <имя файла> <дата-время-от> <дата-время-по>
````

Например

````
    $ mbi-logs extract-time-range /mnt/remote-log-rfs/mbi01e.market.yandex.net/corba/mbi-billing.log 2017-10-06T08:31:00 2017-10-06T08:32:00
````

### Выполнение на удалённой машине ###

Любую команду можно выполнить на удалённой машине, куда есть доступ по SSH. Скрип скопирует себя туда и запустит.
Для этого служит команда `remote`, которая вызывает следующим образом:

````
    $ mbi-logs remote <host> <команда для запуска> ...
````

Например

````
    $ mbi-logs remote logview.market.yandex.net extract-time-range /mnt/remote-log-rfs/mbi01e.market.yandex.net/corba/mbi-billing.log 2017-10-06T08:31:00 2017-10-06T08:32:00
````


### Имя хоста ###

Имя хоста в данном случае - это имя, которое понимает SSH, если у вас в SSH настроены какие-то alias'ы, то можно писать их:

````
    $ mbi-logs remote logview extract-time-range /mnt/remote-log-rfs/mbi01e.market.yandex.net/corba/mbi-billing.log 2017-10-06T08:31:00 2017-10-06T08:32:00
````

Так как у нас имя хоста часто резолвится динамически, чтобы балансировать нагрузку и ведёт на разные физические машины.
То скрипт первым делам соединяется с хостом и запрашивает на этом хосте локальный hostname, примерно вот так:

````
    $ host $(hostname) | head -n 1 | awk '{print $1}'
````

Это делается всегда и работает для logview и public, возможно нужна какая-то опция, чтобы отключать это поведение, но пока ничего подобного нет.

### Формат логов ###

В данный момент скрипт жёстко завязан на то, что дата-время в логе всегда пишется в самом начале строки в виде:

````
    [YYYY-mm-dd HH:MM:SS.sss] ...
````

Это работает для partner-api и mbi-partner и какжется для большинства логов в MBI.

Возможно это тоже можно как-то кастомизировать, но пока ничего подобного нет.
