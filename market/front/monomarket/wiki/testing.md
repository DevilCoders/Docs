Тесты
=====

Локальные тесты
--------------

С локальными тестами всё плюс-минус стандартно и просто. Однако есть несколько вещей специфичных для конкретной реализации данной монорепы:

  - некоторые пакеты треуют сборки перед тестированием (это происходит автоматически с кешированием результатов)
  - для запуска проверок флоу рекомендуется использовать обёртку flow-check, т.к. сам по себе флоу не всегда справляется с изменениями зависимостей
  - для запуска одних скриптов из других следует использовать `yarn run`, а не `npm run` - второй вариант в некоторых случаях может не сработать и в любом случае пишет очень много всякого мусора в консоль.

Сами тесты пишутся в привычной манере - в секции `scripts` заводим скрипт `test`, который запускает все стадии тестирования. Отдельные стадии пишем с в `scripts` под названиями `test:<stage>`

Для запуска тестов можно использовать команды:

  - `yammy test <pkgs...>` - который запустит тесты во всех указанных пакетах (по-умолчанию вообще во всех где настроены тесты). Доводит тесты до конца даже если есть упавшие, пишет саммари о том в каких пакетах тесты упали
  - `yammy test-only <pkg> <testNames...>` - который выполнит все тесты из указанного списка `testNames` вида `test:<testName>` для пакета `pkg`. Падение одного из тестов никак не влияет на выполнение остальных. Перед запуском тестов выполняется сборка пакета, если не указана переменная окружения `CI` или `NO_AUTO_BUILD`
  - `yammy run <pkg> <script>` - универсальная команда для запуска любых скриптов. Позволяет передавать допольнительные аргументы после `--`
  - `yammy each <script> <pkgs...>` - запускает указанный скрипт во всех указанных пакетах (по-умолчанию во всех где он есть). Исполнение будет остановлено после первого же упавшего скрипта.

Автотесты
--------
Для того, чтобы в CI запускать какие-либо тесты, их нужно правильно прописать в секции `scripts`. Существует 3 стадии тестирования:

  - `bootstrap` - тесты запускающиеся сразу после установки `node_modules` в репозитории.
  - `build` - тесты запускающиеся после того как были собраны все необходимые пакеты
  - `deploy` - тесты запускающиеся после того как было развёрнуто окружение для автотестов

В секции `scripts` тесты прописываются в соответствии с этими стадиями - `ci:test:<stage>:<name>`, где `stage` - это стадия тестирования, а `name` - название теста. Для минимальной настройки достаточно просто написать скрипт, который будет завершатья успехом/ошибкой в зависимости от успешности тестов. Но для удобства дальнейшего изучения ошибок, следует позаботиться об отчётах о тестировании. Для этого отчёт необходимо положить в директорию `$REPORT_DIR` под названием `index.(html|htm|md)`, `report.(html|htm|md|txt)` или `stdout.txt`. Для ещё большего удобства рекомендуется также сформировать некий саммари - это минимальный сниппет отчёта с описанием того сколько тестов прошло успешно, сколько упало и т.д. (можно добавлять и другую информацию - формат свободный). Этот саммари является `html` сниппетом который будет вставлен непосредственно в интерфейс сендбокса. Его следует положить в файл `$REPORT_DIR/summary.html`

Для наиболее популярных инструментов уже есть готовые обёртки, которые правильно раскладывают файлы с отчётами и summary:

  - **eslint**: `eslint-ci`, живёт в пакете `@yandex-market/eslinter`
  - **jest**: `jest-ci`, живёт в пакете `@yandex-market/jest`
  - **flow**: `flow-ci`, живёт в пакете `@yandex-market/flow`

Также для CI тестов можно применять различные специальные настройки/надстройки. Для этого в package.json в секции config можно прописать настройки того как будут запускаться отдельные ci-тесты:

```(json)
{
   "config": {
      "test": {
         "ci:test:deploy:hermione": {
            "title": "Интеграционные тесты",
            "task": "MARKET_FRONT_YAMMY_TEST_HERMIONE",
            "env": {
               "CUSTOM_ENV_VAR": "value"
            },
            "params": {
               "selenium": "http://some-selenium-grid-url",
               "report_name": "allure.html"
            }
         }
      }
   }
}
```

Все поля в этом конфиге (и сам конфиг) являются опциональными.

  - поле title будет отображаться в github-проверках и описании sandbox-тасок 
  - поле task позволяет переопределить тип sandbox-таски в котором будет запускаться тест
  - поле env позволяет описать дополнительные переменные окружения, которые будут переданы в таску
  - поле params позволяет описать дополнительные параметры с которыми будет запущена сама sandbox-таска. В частности параметр report_name указывает в каком файле искать отчёт о тестировании.
