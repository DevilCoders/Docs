FAQ
===

Как обновить node_modules?
----------------------------------------

Есть 2 сценария обновления node_modules:

- `yammy up` - в 99% случаев вам нужен именно этот метод. Эту команду стоит выполнять каждый раз как вы переключаете ветки.
- `yammy install` - это более низкоуровневая команда. Её стоит использовать только если вы вручную редактировали зависимости в package.json'ах и хотите установить свежие зависимости и обновить yarn.lock

У меня сломался прекоммит/вообще весь yammy
----------------------------------------

В зависимости от тяжести полученых травм `yammy` можно починить либо командой `yammy up`, либо если это не помогает, то выполнить инициализацию снуля `yarn run bootstrap`. Если второй вариант не помогает - стоит обратиться в чат саппорта фронтовой инфры.

На логрусе иногда ломается установка пакетов из-за ошибок sky-copier (пишет Permission denied). Для лечения этой проблемы нужно выставить переменную окружения `NO_SKY=1`

В прекоммите yammy хочет чтобы я заполнил какой-то publish.json
----------------------------------------

Это специальный файл, в котором нужно прописать какой тип версионирования будет у изменений в каждом из изменённых пакетов. Это нужно чтобы можно было гранулярно рассталять минорные/мажорные изменения в разных пакетах (например мажорное изменение в каком-нибудь логгере от которого зависит мандрел, для самого мандрела может быть как мажорным изменением, так и минорным или даже патчем).

После корректного заполнения `publish.json` будут созданы файлы `release.md` в которые нужно прописать описание текущих изменений. Из этих файлов при мёрже формируется `changelog.md` с описанием того в какой версии какие изменения были сделаны.

В случае если вы просто поправили документацию и не хотите публиковать из-за этого новую версию пакета, то можно поставить в качестве правила версионирования `skip`.

Чтобы заставить yammy проверить/сгенерировать эти файлы без необходимости коммитить можно просто вызвать `yammy validate`.

Не стоит забывать про уровни абстракции и изоляцию пакетов. Если вы делаете какое-то изменение в зависимой библиотеке, чтобы в целевом пакете добавить какую-то фичу - не надо писать описание этой фичи в `release.md` библиотеки - там нужно описать, что именно и как изменилось в самой библиотеке, как будто целевого пакета вообще не существует.

Также не нужно специально писать в `release.md` о том, что вы делаете обновление какой-либо зависимости из монорепы - это будет прописано автоматически при формировании ченжлога.

Yammy отслеживает изменения в пакетах через анализ гит-лога, а не через дифф. Это значит, что если вы сделаете какие-либо изменения в пакета, а затем в другом коммите их полностью откатите, для yammy это будет 2 изменения, и он потребует заполнение `publish.json` и `release.md`. Такое поведение заложено умышленно, т.к. оно максимально близко отражает механизм оптимизации сборки. Если вы хотите откатить изменения в пакете сделанные в ветке, следует изменить напрямую коммит в котором они были сделаны, а не делать второй коммит.

Запуск скриптов проекта
----------------------------------------

Например, вы хотите запустить `npm run debug:dashboards` из проекта графаны. Просто так это не выйдет, потому что часть зависимость установлены на верхнем уровне.
Правильно это делать через через `yarn run`, а лучше через `yammy run` - например, `yammy run grafana debug:dashboards`.
Если вы находитесь в папке проекта то будет работать алиас me - например, `yammy run me debug:dashboards`.

Как сделать локальную сборку пакета?
----------------------------------------

```bash
yammy build <pkg> [deep|deps|alone]
```

Есть 3 режима сборки пакета:

- deep - собирает пакет и все его зависимости. Для первой сборки после чекаута это лучший вариант
- deps - собирает только зависимости пакета. Подходит для случаев, когда собранные зависимости нужны для тестов типа eslint.
- alone - режим по-умолчанию. Собирает только сам пакет. Хорошо подходит для случая когда уже все зависимости собраны и нужно только пересобрать изменения в самом пакете.

Команда build кеширует результат сборки. При сборке из того же состояния репозитория ничего пересобираться не будет. Для инвалидации кеша сборки есть 3 метода:

- отредактировать/удалить файл `.build-hash.json`
- вызвать команду `yammy invalidate <pkgs...>`
- вызвать команду `yammy invalidate-only <buildNames...>` для инвалидации конкретных билдов (вида `build:<buildName>`) пакета
- выставить переменную окружения `YAMMY_INVALIDATE` - значения `1` и `all` инвалидируют все кеши. Также можно напрямую указать название пакета кеш которого требуется инвалидировать (только одного пакета).

Теперь `yammy build deep` будет автоматически вызываться при запуске команд `yammy run`, `yammy each`, `yammy test`. Это поведение можно отключить выставив переменную окруженя `YAMMY_NO_AUTOBUILD=1`

Как запустить тесты пакета
----------------------------------------

Есть 2 метода как можно запускать тесты:

- `yammy test <pkgs...>` - запускает сценарий test во всех перечисленных пакетах (если вообще не передавать список пакетов, запустит тесты всех пакетов).
- `yammy run <pkg> test` - более низкоуровневый метод. Позволяет например запустить не весь пакет тестов а скажем только `test:eslint`. Плюс к тому этот метод позволяет передавать дополнительные аргументы, например: `yammy run @yandex-market/yammy test:eslint -- --fix`. Запустит тесты eslint в пакете yammy с ключём `--fix`.

Как узнать информацию о пакетах в репозитории
----------------------------------------

Для этого существует 3 команды:

  - `yammy status` (или просто `yammy` без аргументов). Выводит сводную информацию о том в каких директориях какие пакеты находятся, какие у них версии и что с этими пакетами можно сделать. Вторая колонка содержит информацию о статусе изменений в пакете. Зелёная галочка означает что изменений нет. Красная звёздочка означает, что в данной директории есть изменения, которые ещё незакоммичены. Жёлтая звёдочка означает, что есть незакоммиченные изменения во влияющих на артефакт сборки зависимостях. Буква `A` - означает, что незакоммиченых изменений нет, но в текущей ветке есть коммиты, которые влияют на артефакт сборки этого пакета. Буква `T` означает, что незакоммиченных изменений нет, коммитов влияющих на артефакт сборки тоже, но есть какие-то изменения которые требуют запуска тестов (например обновление самой библиотеки тестов)
  - `yammy list [<pkgs...>]` - выводит подробную информацию о пакетах с описанием (поле description из package.json), а также списком пакетов, которые являются зависимостями и для которых данных пакет является зависимостью.
  - `yammy packages [<all|build|generated|generator|npm>]` - выводит простой список названий пакетов. По-умолчанию выводит названия всех пакетов. В зависимости от аргумента фильтрует вывод:
    - `build` - пакеты для которых настроена сборка
    - `generated` - мета-пакеты, которые генерируются из других пакетов (генераторов)
    - `generator` - пакеты-генераторы, которые при сборке генерируют другие пакеты
    - `npm` - пакеты для которых настроена публикация в npm

Как установить/удалить npm пакет/связь между пакетами монорепы
----------------------------------------

Для всех манипуляций с пакетами стоит использовать специальные команды yammy:

  - `yammy add <pkg> <npm package name> [dev|optional|peer]` - для установки npm пакетов
  - `yammy remove <pkg> <npm package name>` - для удаления npm пакетов
  - `yammy link <pkg> <dependancy pkg> [dev|optional|peer]` - для установки связи между пакетами монорепы. добавит в pkg зависимость от пакета dependancy pkg.
  - `yammy unlink <pkg> <dependancy pkg>` - для удаления связи между пакетами

Как опубликовать дев-версию библиотеки?
----------------------------------------

Нужно сделать ПР и дождаться когда в нём запустится пайплайн сборки (см. статусы проверок). В этом пайплайне будет кубик `publish`, который по-умолчанию отключен гендальфом. Его нужно запустить вручную (по кнопке плей или убрав гендальфа). После того как кубик отработает - в сендбокс-таске которая к нему привязана будет сгенерирован отчёт о том какие версии каких пакетов были опубликованы. Это настоящие npm версии (не ветки/теги в гите). 

Мне в CI нужны продовые нод-модули, где их взять?
----------------------------------------

Продовые нод-модули собираются автоматически во время стадии build. Чтобы не ломать сценарии тестов, сборки и прочего они лежат отдельно в директории node_modules-prod. Во время публикации npm пакета эта директория прячется автоматически, её не нужно добавлять в `.npmignore`

Я хочу локально протестировать CI сценарий, что для этого нужно?
----------------------------------------

  - Для всех CI сценариев необходимо выставлять переменную окружения `CI=1`
  - Для сценариев тестов необходимо выставить переменную окружения `REPORT_DIR` - в эту директорию будут писаться отчёты о тестировании.
  - Для сценариев публикации необходимо выставить переменную окружения `DIST_DIR` - в эту директорию ваш скрипт должен положить артефакт
  - Если требуется работать с локальным сендбоксом нужно выставить переменную окружения `SANDBOX_HOST` и прописать в ней хост сендбокса (с портом и протоколом)
  - Мета-информация для сборки генерируется командой `yammy ci meta`
  - Протестировать сборку можно командой `yammy ci build <pkg>` - стоит учитывать, что при этом зависимости собраны не будут - их необходимо собрать самостоятельно этой же командой

Мне нужно срочно в прод
----------------------------------------

Бывают случаи когда, промедление смерти подобно и хочется как можно скорее выкатить в прод свежую версию. Для того чтобы пропустить все проверки и отправить ПР в мастер в пайплайне сделан специальный кубик Evergreen. При запуске он делает все проверки зелёными. Не стоит его использовать без реально крайней необходимости.

Чтобы воспользоваться этим кубиком нужно сделать следующее:

1. Убедиться что не запущены никакие тесты, сборка или кубик jail. Если они запущены - то нужно их остановить и дождаться остановки (когда кубик придёт в состояние остановки).
2. Снять гендальфа с кубика Evergreen
3. Добавить гендальфов на кубики test bootstrap, build и jail.

Если вдруг после успешной работы кубика Evergreen вы передумали и решили, что проверки всё-таки нужны, то следует вернуть гендальфа на Evergreen, убрать лишних гендальфов и перезапустить сборку пайплайна с кубика Plan.
