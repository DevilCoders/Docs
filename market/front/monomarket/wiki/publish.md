Публикация пакетов
================

Есть 2 типа публикации пакетов - публикация npm и всё остальное.

Публикацию npm настраивать не обязательно, достаточно не ставить `{private: true}` в package.json. При публикации в npm
будет вызвана команда `npm publish` в корне пакета. Перед этим в `package.json` будут внесены актуальные версии соседних
пакетов. Запрещено писать pre-скрипты для этого сценария. Вся сборка и подготовка к публикации должна происходить в
build сценарии. В npm должно быть опубликовано ровно то, что получается в репозитории в после запуска сборки (если она
есть). Для кейсов типа mandrel, где в npm публикуется директория dist, а не корень пакета нужно использовать
пакеты-генераторы, об этом написано в соответсвующем разделе. Если нужно исключить какие-то файлы из итогового пакета,
используйте .npm-ignore и другие настройки npm, которые можно почитать в документации по npm.

Дев-версии npm пакетов публикуются в npm с тегом dev и имеют версию `0.0.0-<hash>`, где хеш это верхний коммит изменений
артефакта пакета.

Для остальных типов публикации нужно добавить в scripts скрипт вида `ci:publish:<publish-name>`,
например `ci:publish:app` или `ci:publish:assests`. Для дополнительных настроек в package.json в
секцию `config.publish[<publish-short-name>]` нужно добавить конфиг публикации. Например:

```(json)
{
   "config": {
      "publish": {
         "app": {
            "title": "Пакет приложения",
            "task": "MARKET_FRONT_YAMMY_PUBLISH_RESOURCE",
            "env": {
               "CUSTOM_ENV_VAR": "value"
            },
            "params": {
               "resource_type": "MARKET_FRONT_WHITE_DESKTOP_APP"
            }
         },
         "assets": {
            "title": "Статика",
            "task": "MARKET_FRONT_YAMMY_PUBLISH_S3",
            "env": {
               "CUSTOM_ENV_VAR": "value"
            },
            "params": {
               "s3_bucket": "white-desktop"
            }
         }
      }
   }
}
```

Значения полей аналогичны полям для конфига тестов.

Кроме этого есть специальное поле `skipPr` - это флаг указывающий, что данный артефакт не нужно публиковать для PR'ов. 

Сама команда в секции scripts должна положить все необходимые файлы в директорию указанную в переменной
окружения `$DIST_DIR`. Крайне не рекомендуется делать какую-либо сборку на этом этапе. Для этого следует использовать
build-скрипт. Идеальный сценарий publish-скрипта выглядит как-то так: `mv ./dist/* $DIST_DIR/`

Публикация Sandbox-артефакта
--------------------------

Для публикации Sandbox артефактов, которые затем используются для деплоя приложения в RTC следует использовать таску `MARKET_FRONT_YAMMY_PUBLISH_RESOURCE`. В конфиге нужно также указать имя класса публикуемого ресурса. Наример

```
"config": {
  "publish": {
    "app": {
      "title": "Пакет приложения",
      "task": "MARKET_FRONT_YAMMY_PUBLISH_RESOURCE",
      "params": {
        "resource_type": "MARKET_BILLING_ADMIN_FRONT_APP"
      }
    }
  }
}
```

Публикация статики в s3
---------------------

Для публикации статики в s3, необходимо использовать таску `MARKET_FRONT_YAMMY_PUBLISH_S_3`. В качестве параметров нужно передать название бакета и название префикса. Например:

```
"config": {
  "static": {
    "title": "Статика в s3",
    "task": "MARKET_FRONT_YAMMY_PUBLISH_S_3",
    "skipPr": true, // в PR'ах не стоит публиковать статику, в мультитестингах она грузится локально
    "params": {
      "s3_bucket": "market-static",
      "s3_prefix": "billing-admin"
    }
  }
}
```
