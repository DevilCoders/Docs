# B2B Front API

Источник данных для мобильных приложений Партнерского интерфейса

## Подготовка проекта и запуск приложения

Заходим на любой Логрус, выполняем [начальную настройку](https://github.yandex-team.ru/market/monomarket/blob/master/wiki/start.md).
Примонтируйте Аркадию, чтобы использовать `ya tool`. Аркадию перед отключением от Логруса рекомендуется отмонтировать.
Yammy в первый раз придется установить глобально (в инструкции про это есть).
Обратите внимание, что правильный пакет называется `@yandex-market/yammy` и установить его нужно из внутреннего
(яндексового) `npm`

Далее вам нужно развернуть рабочую копию. Для этого вызываем ` make_wc -p monomarket`, выбираем имя
и ждём завершения работы скриптов подготовки монорепозитория. Далее, переходите в созданную директорию
и запустите в ней команду настройки Yammy `yammy up`, затем соберите проект командой `yammy build b2b-fapi deep`
и наконец запустите приложение `yammy start b2b-fapi`.

После старта приложения, в консоли вы увидите адрес по которому будет доступна ваша рабочая копия.

## Разработка

Вам нужно запустить приложение на Логрусе командой `yammy start b2b-fapi`и выбрать каким образом вы будете собирать исходные файлы.

**Есть два способа сборки измененных файлов:**

1. собирать локально и загружать собранные файлы на дев-сервер
2. загружать только исходники, а вся сборка будет на Логрусе

И тот и другой способ требует настройки синхронизации файлов с Логрусом, тут выбор за вами, самый надежный `lsync`.  
Для настройки `lsync` можно воспользоваться [инструкцией](https://wiki.yandex-team.ru/market/frontend/dev-environment/#vneshnijjdemonlsyncd).

Для загрузки собранных файлов достаточно синхронизировать директорию `lib/apps/b2b-fapi/lib`, вариант с исходными файлами
требует синхронизации директории `lib/apps/b2b-fapi/app`.

Для запуска команды сборки и отслеживания изменений с последующей пересборкой выполните команду `yammy build-only b2b-fapi watch`
(на локальном компьютере или на Логрусе зависит от выбранного способа разработки)

В монорепозитории запрещено запускать одной командой и старт сервера и отслеживание измененных файлов с последующей
пересборкой, поэтому команды разделены и вам предстоит запустить их либо параллельными процессами в виртуальных терминалах (tmux, screen),
либо любым другом удобным для вас способом.

**Часто используемые команды**

- Скачать, установить и собрать все зависимости `yammy up`
- Запуск http-сервера: `yammy start b2b-fapi`
- Сборка и отслеживание изменений `yammy build-only b2b-fapi watch`
- Полная сборка проекта со всеми зависимостями `yammy build b2b-fapi deep`
- Примонтировать Аркадию `arc mount -m ~/arcadia -S ~/store`
- Сборка только приложения, без сваггера `YAMMY_BUILD=flow,typescript yammy build mandrel `

### Написание ручек

В проекте реализовано подобие [RPC](https://ru.wikipedia.org/wiki/Удалённый_вызов_процедур) (удаленные резолверы, по-нашему)
, в роутер новые ручки добавлять не нужно, но обработчики нужно хранить в директории `lib/apps/b2b-fapi/app/handlers`.
Там создаете папку, в названии должно присутствовать действие и сущность, примеры: `createBusiness`, `getOrdersList`,
это же название вы будете использовать при вызове ваших ручек. В этой директории создайте папку с версией вашей ручки,
если вы создаете новую, пишите `v1`.

В папке с версией пишете реализацию. Дефолтный `createHandler` написан для случаев когда ручка возвращает
нормализованный ответ, поэтому даже если ваша ручка возвращает что-то простое, ответ нужно завернуть в объект
с полями `result` и `collections`, если ручка возвращает ошибку, ответом должен быть объект с полем `error`

**Пример реализации ручки в файле** `~app/handlers/registration/v1/index.ts`

```js
import {createHandler} from '@yandex-market/mandrel/handler';
import BaseError from '@yandex-market/error';

import type {V1} from '~/app/handlers';
import {inspect, ValidationError} from '~/app/utils/validator';

import CONSTRAINTS from './constaints';

class SomeRegistrationError extends BaseError {}

// параметры вызова ручки
type Params = {id: number};
// значение поля result
type Result = string;
// коллекция (если ее нет или не должно быть, нужно вернуть пустой объект)
type Collections = {};

export default createHandler<V1, Params, Result, Collections, Error>(async (ctx, params) => {
    const errors = inspect(params, CONSTRAINTS);

    if (errors) {
        return {
            error: new ValidationError(errors),
        };
    }
    
    try {
        const result = await someFunctionWhichReturnString(params);

        return {
            result,
            collections: {},
        };

    } catch (error) {
        return {
            error: new SomeRegistrationError(error.toString()),
        };
    }
}, ['OAUTH'], {
    name: 'registration', // имя будет в логах
});
```

Такая ручка будет доступа для запросов по пути `/api/v1?name=registration`

### Правила работы с ветками

Ветка обязательно должна содержать название тикета из Стартрека, на это есть валидация и ваш пулл-реквест не пройдет проверок
если тикета нет.

В самом монорепозитории используется MQ для слияния пулл-реквестов. MQ всегда ребейзит, а не мержит, поэтому даже не пытайтесь
подлить мастер в свою ветку мержом, потом будете страдать.

### Отладочные токены
Для разработки мы используем отладочные токены. Они доступны в [Секретнице](https://yav.yandex-team.ru/secret/sec-01fe1b3a2mqgxzehkm2e4t5606/explore/versions)

#### Завести новый отладочный токен
Залогиньтесь пользователем для которого нужен отладочный токен и перейдите по ссылке ниже

https://oauth.yandex.ru/authorize?response_type=token&client_id=0dde0477a7f9452a97bf172c98652257

Полученный токен сохраните в секрет [tokens_b2b-fapi_development](https://yav.yandex-team.ru/secret/sec-01fe1b3a2mqgxzehkm2e4t5606/explore/versions), 
в качестве ключа используйте логин пользователя для которого сгенерировали токен.

### Локальный запуск тестов
В тестах поднимается полностью замоканная приложенька. Если вы ни разу не собирали приложение, его нужно сначала собрать и только потом запускать тесты. 
Если что-то меняете в коде и хотите еще раз прогнать тесты, вам нужно пересобрать приложение. Самый просто способ запустить вотчер и пусть следит за изменными файлами.

### Как пользоваться Yammy

`yammy --help` вам в помощь или [вики](https://github.yandex-team.ru/market/monomarket/tree/master/wiki) в самом репозитории
