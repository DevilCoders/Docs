# market/nginx2/market_front_unified_corpsite_nginx2
    
## Common properties

  * **Owner:** `marketfrontend`
  * **Table:** `nginx2`

## Splits

```json
{
    "service_corpsite": "multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' )",
    "code": "arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)])",
    "buckets_ttlb": "if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms))))",
    "buckets_req_time": "if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms))))",
    "buckets_handshake": "if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms)))",
    "buckets_bytes_send": "if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent))))",
    "dc": "multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' )",
    "host": "host",
    "requester": "multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\\\)|MSRBOT \\\\(http://research\\\\.microsoft\\\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\\\.com|Refer\\\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in')",
    "robot": "replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\\\)|MSRBOT \\\\(http://research\\\\.microsoft\\\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\\\.com|Refer\\\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '')",
    "resource-type": "if(dynamic = 0 or page_id = '', 'static', 'dynamic')",
    "page": "replaceAll(page_id, ':', '_')",
    "resolver": "replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_')"
}
```

## Filters

```json
[
    "environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service'",
    "environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != ''",
    "environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != ''",
    "environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')",
    "environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id != ''",
    "environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')"
]
```

## Resulting metrics

  * [`market-front-unified.nginx2.v2.${service_corpsite}.dc.page.splits.${dc}.${page}.${code}.metrics.bytes_send.quantiles`](#177341c415541bca151b5de992013786)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.dc.page.splits.${dc}.${page}.${code}.metrics.handshake.quantiles`](#2b713a801600ab46826aa49ff7004970)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.dc.page.splits.${dc}.${page}.${code}.metrics.req_time.quantiles`](#2826f1bd99628fd41eeec4b66795aa3c)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.dc.page.splits.${dc}.${page}.${code}.metrics.rps`](#17d3d7aebc204eb83aa4531792a288c5)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.dc.page.splits.${dc}.${page}.${code}.metrics.ttlb.quantiles`](#10169b78309ea4cc1c17168c7828f085)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.bytes_send.quantiles`](#af5a6fcef379bb6d740d689b710656fc)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.handshake.quantiles`](#6f4c45f63eebb110fcfbd457d7844829)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.req_time.quantiles`](#be01bece4dd426dfb1ab667a17d80f31)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.rps`](#1ee4ce841237bdfcd20814461ec2a299)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.ttlb.quantiles`](#c3c03b63cafb9985bd561b1e6578f676)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.dc.splits.${dc}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}`](#8fec3bbdb6557e53d73617ab47b373ca)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.dc.splits.${dc}.${code}.metrics.bytes_send.quantiles`](#078450f52bc0193494b9f846b92083d0)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.dc.splits.${dc}.${code}.metrics.handshake.buckets.${buckets_handshake}`](#f41b3add9af49a479812fd73c101a0b7)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.dc.splits.${dc}.${code}.metrics.handshake.quantiles`](#916867e107395739a4b4f0508b32f19c)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.dc.splits.${dc}.${code}.metrics.req_time.buckets.${buckets_req_time}`](#8944c0db1985290fedeaca41ed4cdc42)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.dc.splits.${dc}.${code}.metrics.req_time.quantiles`](#1b41b26f1d81075e9368754fbae236c6)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.dc.splits.${dc}.${code}.metrics.rps`](#d30cc53c575a3b1a35f1b1ad2b78d757)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.dc.splits.${dc}.${code}.metrics.ttlb.buckets.${buckets_ttlb}`](#f0715aa4ebf1cf6dd6a2807095ff3ca6)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.dc.splits.${dc}.${code}.metrics.ttlb.quantiles`](#1b5fa6aa6300b59f25cc06efb949626e)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.host.page.splits.${host}.${page}.${code}.metrics.bytes_send.quantiles`](#c15bf151c32c5ff7911ef0d76c443284)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.host.page.splits.${host}.${page}.${code}.metrics.handshake.quantiles`](#20b9f4eb7eee8e4d823b400f14535c5d)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.host.page.splits.${host}.${page}.${code}.metrics.req_time.quantiles`](#ba8f86b42f732de352b89580d88def3f)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.host.page.splits.${host}.${page}.${code}.metrics.rps`](#e3324f9157f4085e87594bf8f963e016)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.host.page.splits.${host}.${page}.${code}.metrics.ttlb.quantiles`](#4ad624d09941cd975033f253f8baa266)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.host.resolver.splits.${host}.${resolver}.${code}.metrics.bytes_send.quantiles`](#4759e3d4cc3a07464271b8136cdb266e)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.host.resolver.splits.${host}.${resolver}.${code}.metrics.handshake.quantiles`](#174d870307e8e9c868e1a26a9261a3c2)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.host.resolver.splits.${host}.${resolver}.${code}.metrics.req_time.quantiles`](#f52ff019ea40ffbd74e3acb3f6e8a5fb)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.host.resolver.splits.${host}.${resolver}.${code}.metrics.rps`](#cb60567ac058ca9d09f83002540690f8)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.host.resolver.splits.${host}.${resolver}.${code}.metrics.ttlb.quantiles`](#ad0b40ef0d447347c29a0cdac4188e03)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.host.splits.${host}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}`](#3d32d7c4c902321bc959906c07962d0d)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.host.splits.${host}.${code}.metrics.bytes_send.quantiles`](#41318e45dba2a785f0232d1a64066ab9)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.host.splits.${host}.${code}.metrics.handshake.buckets.${buckets_handshake}`](#9bb3051e265ec8e5bf90d608c19cdb22)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.host.splits.${host}.${code}.metrics.handshake.quantiles`](#ccf8f502479f60c05825cf4732bbf3ae)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.host.splits.${host}.${code}.metrics.req_time.buckets.${buckets_req_time}`](#7ef0b8d13f15bec1153b1dc4561df44d)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.host.splits.${host}.${code}.metrics.req_time.quantiles`](#c7a83ff0bc3dda1a148ac8c76aff518c)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.host.splits.${host}.${code}.metrics.rps`](#91883f863d38c4fb9c5d010edd73bca2)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.host.splits.${host}.${code}.metrics.ttlb.buckets.${buckets_ttlb}`](#05e52eb5f4b7340b6b144cd279a5b551)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.host.splits.${host}.${code}.metrics.ttlb.quantiles`](#5c5076f016b22645283865220afb8fac)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.page.splits.${page}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}`](#2bce49581cdf3c82caf228fcc66b33f6)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.page.splits.${page}.${code}.metrics.bytes_send.quantiles`](#68518487ae730e81e2a26c0ce5508bfc)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.page.splits.${page}.${code}.metrics.handshake.buckets.${buckets_handshake}`](#2da0c72a73d769ae7586db678b0c2811)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.page.splits.${page}.${code}.metrics.handshake.quantiles`](#bb829d8afb2cbf9687db4f0403b31a6b)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.page.splits.${page}.${code}.metrics.req_time.buckets.${buckets_req_time}`](#5eab6932eea2aaf925cd925aa145ef73)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.page.splits.${page}.${code}.metrics.req_time.quantiles`](#78c03ec2f57fa4e86cd5179e8b4f18ee)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.page.splits.${page}.${code}.metrics.rps`](#fbbea39774821921d3b084020666f1cb)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.page.splits.${page}.${code}.metrics.ttlb.buckets.${buckets_ttlb}`](#fb780b2aa99e1e140bea247ca2bb2295)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.page.splits.${page}.${code}.metrics.ttlb.quantiles`](#08aa136a40de3f780b01a95a9f9f7bde)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.requester.dc.splits.${requester}.${dc}.${code}.metrics.bytes_send.quantiles`](#0c7ac3c91f54f9e7761699643b404c03)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.requester.dc.splits.${requester}.${dc}.${code}.metrics.handshake.quantiles`](#3297d67dd9118f85a3ec736c5a513ec7)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.requester.dc.splits.${requester}.${dc}.${code}.metrics.req_time.quantiles`](#9d886205c7a40589bf58cfe664ec350f)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.requester.dc.splits.${requester}.${dc}.${code}.metrics.rps`](#7ae54c0f5b5cb21e2a18eaa906f35ce5)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.requester.dc.splits.${requester}.${dc}.${code}.metrics.ttlb.quantiles`](#06c2dc2f915e04e821585346e10df00e)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.requester.host.splits.${requester}.${host}.${code}.metrics.bytes_send.quantiles`](#d06a4eeec5d1729f0ce3fa6288488c75)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.requester.host.splits.${requester}.${host}.${code}.metrics.handshake.quantiles`](#c0dfe2452b30a3fec352b213330efe24)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.requester.host.splits.${requester}.${host}.${code}.metrics.req_time.quantiles`](#b44d61891c1542c480cdb39be2f8225b)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.requester.host.splits.${requester}.${host}.${code}.metrics.rps`](#0ec04c6f18e02d501435ef3fdaa7b0e5)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.requester.host.splits.${requester}.${host}.${code}.metrics.ttlb.quantiles`](#903ccbcd6dcc3c2f2c61c585c9e82684)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.requester.page.splits.${requester}.${page}.${code}.metrics.bytes_send.quantiles`](#c68e06399c234714c8525d2e1dbbfdf9)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.requester.page.splits.${requester}.${page}.${code}.metrics.handshake.quantiles`](#9f4f83223ce435789608327dfa66ccf7)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.requester.page.splits.${requester}.${page}.${code}.metrics.req_time.quantiles`](#b1796a6cdcc8d2fb802facde65c42963)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.requester.page.splits.${requester}.${page}.${code}.metrics.rps`](#32680a20235d710f29e63883e80e1872)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.requester.page.splits.${requester}.${page}.${code}.metrics.ttlb.quantiles`](#5ea1fd55399ac2c0f85d523b82e9e85a)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.bytes_send.quantiles`](#d13a2bb50e4406e0d7159f4d6de22e55)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.handshake.quantiles`](#9a38c5e00c1cdc1983d138129725d5c9)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.req_time.quantiles`](#a204e845312916ed3fa1a03a6c9d7f66)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.rps`](#6b86b948a81be2eca190fae11a98af5c)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.ttlb.quantiles`](#3cbddd0ed975792a6d80004f19eeffce)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.bytes_send.quantiles`](#d44789e22a119dc3207ccec5f93476f9)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.handshake.quantiles`](#777749909f203285a2a1bc363cbde90e)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.req_time.quantiles`](#6f8290e605726eddda6123b869f5ef34)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.rps`](#cbfb5e74b03d1a0e86a60d80aae6ae46)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.ttlb.quantiles`](#a563b9073e2dd279464bda8c3b9515a7)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.requester.splits.${requester}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}`](#4a050ff685fcd8a5027cfc57e448e995)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.requester.splits.${requester}.${code}.metrics.bytes_send.quantiles`](#03dfcd0e22ec422b5ca36134c3077ff5)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.requester.splits.${requester}.${code}.metrics.handshake.buckets.${buckets_handshake}`](#1a58d55b2ee17c8ce3ec12cda0c9d68a)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.requester.splits.${requester}.${code}.metrics.handshake.quantiles`](#9c2f840f8b4252b9fbaa6933c03446a6)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.requester.splits.${requester}.${code}.metrics.req_time.buckets.${buckets_req_time}`](#1ca221703a5d1e4e693a9de74b4fbc70)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.requester.splits.${requester}.${code}.metrics.req_time.quantiles`](#219ff08497d45abd4c1099a378fd3608)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.requester.splits.${requester}.${code}.metrics.rps`](#a9dd95674766a901b6c7cb6717d775a9)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.requester.splits.${requester}.${code}.metrics.ttlb.buckets.${buckets_ttlb}`](#9c6f2978a7aa2159bb1bcd900c7f0ecb)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.requester.splits.${requester}.${code}.metrics.ttlb.quantiles`](#fb3528d8b5baab773b0cad67f6b8a1a4)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.resolver.splits.${resolver}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}`](#1948c2fbf4b685c9fae66c2edc35f124)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.resolver.splits.${resolver}.${code}.metrics.bytes_send.quantiles`](#2974e188ea702d9141ff99762b40beae)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.resolver.splits.${resolver}.${code}.metrics.handshake.buckets.${buckets_handshake}`](#7f33181aa490ae283b9f11f9181f552c)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.resolver.splits.${resolver}.${code}.metrics.handshake.quantiles`](#9d40c45435994d80dfcd93d2e6d6a3e6)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.resolver.splits.${resolver}.${code}.metrics.req_time.buckets.${buckets_req_time}`](#918733509f9cb270c9fa92400fe3bca2)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.resolver.splits.${resolver}.${code}.metrics.req_time.quantiles`](#53e91f59908a69e0a63fa5fca1f76e72)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.resolver.splits.${resolver}.${code}.metrics.rps`](#ebc07c2c3207c420b7f074c2724ac46c)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.resolver.splits.${resolver}.${code}.metrics.ttlb.buckets.${buckets_ttlb}`](#cc8cec4ad7776edca7e0c3d54412641a)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.resolver.splits.${resolver}.${code}.metrics.ttlb.quantiles`](#678d2ae4960b890b46e9e72692b759fd)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.resourceType.splits.${resource-type}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}`](#1e8baa99d9ad7fab7c85073c2ae21629)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.resourceType.splits.${resource-type}.${code}.metrics.bytes_send.quantiles`](#fae17af292cede9bd7a462f8509f8b9d)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.resourceType.splits.${resource-type}.${code}.metrics.handshake.buckets.${buckets_handshake}`](#7d2eeed7be77c1c04ad31293e826dafe)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.resourceType.splits.${resource-type}.${code}.metrics.handshake.quantiles`](#b9ed7333a7b18f7040d686496c1357af)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.resourceType.splits.${resource-type}.${code}.metrics.req_time.buckets.${buckets_req_time}`](#19d72004b18b5caa5f7d6e2b2feb6bda)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.resourceType.splits.${resource-type}.${code}.metrics.req_time.quantiles`](#5a3d66385a8b9dcacc9c93be2a1ca2d8)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.resourceType.splits.${resource-type}.${code}.metrics.rps`](#91a510c933cdb133ed00e1818162d312)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.resourceType.splits.${resource-type}.${code}.metrics.ttlb.buckets.${buckets_ttlb}`](#3e7204fe8a8d9db04c8ed7ef6c4ddaf0)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.resourceType.splits.${resource-type}.${code}.metrics.ttlb.quantiles`](#6e011d630efeb53b28eb8ed8e079741d)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.robot.dc.splits.${robot}.${dc}.${code}.metrics.bytes_send.quantiles`](#421e4b8a2b758306ee806677d113e455)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.robot.dc.splits.${robot}.${dc}.${code}.metrics.handshake.quantiles`](#8f533ac25dd838b7658efb79fa3a8e8f)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.robot.dc.splits.${robot}.${dc}.${code}.metrics.req_time.quantiles`](#f7a65001ce45c5b362b24bc9e6d3db5f)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.robot.dc.splits.${robot}.${dc}.${code}.metrics.rps`](#800b1796e0be9da8f41d432714cb81e5)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.robot.dc.splits.${robot}.${dc}.${code}.metrics.ttlb.quantiles`](#ef2244c585765700dd2849cab354d791)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.robot.host.splits.${robot}.${host}.${code}.metrics.bytes_send.quantiles`](#5621c0a980f5c4e881413a414d03310b)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.robot.host.splits.${robot}.${host}.${code}.metrics.handshake.quantiles`](#32e17bb9212fe5801637fdfccc4554c7)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.robot.host.splits.${robot}.${host}.${code}.metrics.req_time.quantiles`](#83921fc68bf698853b4ef11cd036c47f)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.robot.host.splits.${robot}.${host}.${code}.metrics.rps`](#884383c9942c432b32964061ddc90ebb)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.robot.host.splits.${robot}.${host}.${code}.metrics.ttlb.quantiles`](#99b6ae738f845e08143e328b6e0ec0e9)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.robot.page.splits.${robot}.${page}.${code}.metrics.bytes_send.quantiles`](#b98a7357e37f1ecbef22c47065ecca7b)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.robot.page.splits.${robot}.${page}.${code}.metrics.handshake.quantiles`](#ae1256f734b534df15ed89dc077ec9cf)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.robot.page.splits.${robot}.${page}.${code}.metrics.req_time.quantiles`](#4fc7d3e78b87a1229bc8a99355dc977f)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.robot.page.splits.${robot}.${page}.${code}.metrics.rps`](#8c8f3b09fd0c061466e61b4a86361a25)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.robot.page.splits.${robot}.${page}.${code}.metrics.ttlb.quantiles`](#013f856a998c0f2d19f3f0d5a230e73f)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.bytes_send.quantiles`](#d265be9201e27f737a42cc2a9f56f644)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.handshake.quantiles`](#49fb7c90d622d95cbc86e47ed6576509)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.req_time.quantiles`](#d578a9f52078c8b7745835cadda9a3b8)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.rps`](#01c2209dcbf22deaadb65bc881e907d0)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.ttlb.quantiles`](#d200e5b6cb949c39073b27ac05bf9606)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.bytes_send.quantiles`](#01220d5f251e5977d2504b16d5f7ede5)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.handshake.quantiles`](#62c65d99e6f3175e4916b7943977c940)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.req_time.quantiles`](#2630d4a62de8949d2e391910f040c722)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.rps`](#d6d9fbd493b00a99368667f13c04c3e8)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.ttlb.quantiles`](#d86f91a6f321b8e48d7948d4edc6f11a)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.robot.splits.${robot}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}`](#592a61e92c24a4d05c6c6fc79800d04e)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.robot.splits.${robot}.${code}.metrics.bytes_send.quantiles`](#75a78d0b835808ab0053b83cebc87963)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.robot.splits.${robot}.${code}.metrics.handshake.buckets.${buckets_handshake}`](#b23e62ef357f6f965f5bd05199831dcb)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.robot.splits.${robot}.${code}.metrics.handshake.quantiles`](#807fd8825ea565bacda517127f69131e)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.robot.splits.${robot}.${code}.metrics.req_time.buckets.${buckets_req_time}`](#443425046b13a2acb3a1d84c9ebe6d4a)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.robot.splits.${robot}.${code}.metrics.req_time.quantiles`](#013c9804eba015e1df4d8d0e9e4dda3a)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.robot.splits.${robot}.${code}.metrics.rps`](#be96b1a4aa930c47c498a7c1284d062c)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.robot.splits.${robot}.${code}.metrics.ttlb.buckets.${buckets_ttlb}`](#9da9b2284eb0bffc5c29d512226070bf)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.robot.splits.${robot}.${code}.metrics.ttlb.quantiles`](#710f8c338eb6cd16dc8cb3b69dc1b93d)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.total.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}`](#1cb93d660edd41a408c18cd6bac1e256)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.total.${code}.metrics.bytes_send.quantiles`](#f231e3fc23a35acc14d674199cb0c925)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.total.${code}.metrics.handshake.buckets.${buckets_handshake}`](#1a0800a8871a182536dc7181d28abd5a)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.total.${code}.metrics.handshake.quantiles`](#19b68ed816157db328869ba8ac421df4)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.total.${code}.metrics.req_time.buckets.${buckets_req_time}`](#9f1cc2d43aceb18c23cff1fc60bfc30e)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.total.${code}.metrics.req_time.quantiles`](#45edf5e1e805c1af99524518ee2524b4)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.total.${code}.metrics.rps`](#ac825d6016c9394e399784ad0ab453c3)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.total.${code}.metrics.ttlb.buckets.${buckets_ttlb}`](#f32330ffe08e574060c1c24fca8806f5)
  * [`market-front-unified.nginx2.v2.${service_corpsite}.total.${code}.metrics.ttlb.quantiles`](#3d2c39297e47c8c59ce0b06501b06115)

## Metrics

#### <a id='ac825d6016c9394e399784ad0ab453c3'></a>market-front-unified.nginx2.v2.${service_corpsite}.total.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.total.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.total.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='f32330ffe08e574060c1c24fca8806f5'></a>market-front-unified.nginx2.v2.${service_corpsite}.total.${code}.metrics.ttlb.buckets.${buckets_ttlb}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_ttlb%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    code,
    buckets_ttlb

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.total.%24%7Bcode%7D.metrics.ttlb.buckets.%24%7Bbuckets_ttlb%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_ttlb%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.total.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        code,
        buckets_ttlb
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='9f1cc2d43aceb18c23cff1fc60bfc30e'></a>market-front-unified.nginx2.v2.${service_corpsite}.total.${code}.metrics.req_time.buckets.${buckets_req_time}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_req_time%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    code,
    buckets_req_time

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.total.%24%7Bcode%7D.metrics.req_time.buckets.%24%7Bbuckets_req_time%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_req_time%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.total.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        code,
        buckets_req_time
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='1a0800a8871a182536dc7181d28abd5a'></a>market-front-unified.nginx2.v2.${service_corpsite}.total.${code}.metrics.handshake.buckets.${buckets_handshake}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_handshake%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    code,
    buckets_handshake

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.total.%24%7Bcode%7D.metrics.handshake.buckets.%24%7Bbuckets_handshake%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_handshake%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.total.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        code,
        buckets_handshake
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='1cb93d660edd41a408c18cd6bac1e256'></a>market-front-unified.nginx2.v2.${service_corpsite}.total.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_bytes_send%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    code,
    buckets_bytes_send

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.total.%24%7Bcode%7D.metrics.bytes_send.buckets.%24%7Bbuckets_bytes_send%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_bytes_send%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.total.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        code,
        buckets_bytes_send
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='d30cc53c575a3b1a35f1b1ad2b78d757'></a>market-front-unified.nginx2.v2.${service_corpsite}.dc.splits.${dc}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.dc.splits.%24%7Bdc%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.dc.splits.${dc}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='f0715aa4ebf1cf6dd6a2807095ff3ca6'></a>market-front-unified.nginx2.v2.${service_corpsite}.dc.splits.${dc}.${code}.metrics.ttlb.buckets.${buckets_ttlb}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_ttlb%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    dc,
    code,
    buckets_ttlb

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.dc.splits.%24%7Bdc%7D.%24%7Bcode%7D.metrics.ttlb.buckets.%24%7Bbuckets_ttlb%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_ttlb%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.dc.splits.${dc}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        dc,
        code,
        buckets_ttlb
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='8944c0db1985290fedeaca41ed4cdc42'></a>market-front-unified.nginx2.v2.${service_corpsite}.dc.splits.${dc}.${code}.metrics.req_time.buckets.${buckets_req_time}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_req_time%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    dc,
    code,
    buckets_req_time

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.dc.splits.%24%7Bdc%7D.%24%7Bcode%7D.metrics.req_time.buckets.%24%7Bbuckets_req_time%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_req_time%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.dc.splits.${dc}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        dc,
        code,
        buckets_req_time
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='f41b3add9af49a479812fd73c101a0b7'></a>market-front-unified.nginx2.v2.${service_corpsite}.dc.splits.${dc}.${code}.metrics.handshake.buckets.${buckets_handshake}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_handshake%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    dc,
    code,
    buckets_handshake

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.dc.splits.%24%7Bdc%7D.%24%7Bcode%7D.metrics.handshake.buckets.%24%7Bbuckets_handshake%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_handshake%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.dc.splits.${dc}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        dc,
        code,
        buckets_handshake
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='8fec3bbdb6557e53d73617ab47b373ca'></a>market-front-unified.nginx2.v2.${service_corpsite}.dc.splits.${dc}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_bytes_send%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    dc,
    code,
    buckets_bytes_send

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.dc.splits.%24%7Bdc%7D.%24%7Bcode%7D.metrics.bytes_send.buckets.%24%7Bbuckets_bytes_send%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_bytes_send%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.dc.splits.${dc}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        dc,
        code,
        buckets_bytes_send
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='91883f863d38c4fb9c5d010edd73bca2'></a>market-front-unified.nginx2.v2.${service_corpsite}.host.splits.${host}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.host.splits.%24%7Bhost%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.host.splits.${host}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='05e52eb5f4b7340b6b144cd279a5b551'></a>market-front-unified.nginx2.v2.${service_corpsite}.host.splits.${host}.${code}.metrics.ttlb.buckets.${buckets_ttlb}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_ttlb%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    host,
    code,
    buckets_ttlb

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.host.splits.%24%7Bhost%7D.%24%7Bcode%7D.metrics.ttlb.buckets.%24%7Bbuckets_ttlb%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_ttlb%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.host.splits.${host}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        host,
        code,
        buckets_ttlb
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='7ef0b8d13f15bec1153b1dc4561df44d'></a>market-front-unified.nginx2.v2.${service_corpsite}.host.splits.${host}.${code}.metrics.req_time.buckets.${buckets_req_time}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_req_time%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    host,
    code,
    buckets_req_time

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.host.splits.%24%7Bhost%7D.%24%7Bcode%7D.metrics.req_time.buckets.%24%7Bbuckets_req_time%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_req_time%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.host.splits.${host}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        host,
        code,
        buckets_req_time
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='9bb3051e265ec8e5bf90d608c19cdb22'></a>market-front-unified.nginx2.v2.${service_corpsite}.host.splits.${host}.${code}.metrics.handshake.buckets.${buckets_handshake}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_handshake%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    host,
    code,
    buckets_handshake

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.host.splits.%24%7Bhost%7D.%24%7Bcode%7D.metrics.handshake.buckets.%24%7Bbuckets_handshake%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_handshake%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.host.splits.${host}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        host,
        code,
        buckets_handshake
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='3d32d7c4c902321bc959906c07962d0d'></a>market-front-unified.nginx2.v2.${service_corpsite}.host.splits.${host}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_bytes_send%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    host,
    code,
    buckets_bytes_send

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.host.splits.%24%7Bhost%7D.%24%7Bcode%7D.metrics.bytes_send.buckets.%24%7Bbuckets_bytes_send%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_bytes_send%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.host.splits.${host}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        host,
        code,
        buckets_bytes_send
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='a9dd95674766a901b6c7cb6717d775a9'></a>market-front-unified.nginx2.v2.${service_corpsite}.requester.splits.${requester}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    requester,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.requester.splits.%24%7Brequester%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.requester.splits.${requester}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        requester,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='9c6f2978a7aa2159bb1bcd900c7f0ecb'></a>market-front-unified.nginx2.v2.${service_corpsite}.requester.splits.${requester}.${code}.metrics.ttlb.buckets.${buckets_ttlb}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_ttlb%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    requester,
    code,
    buckets_ttlb

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.requester.splits.%24%7Brequester%7D.%24%7Bcode%7D.metrics.ttlb.buckets.%24%7Bbuckets_ttlb%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_ttlb%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.requester.splits.${requester}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        requester,
        code,
        buckets_ttlb
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='1ca221703a5d1e4e693a9de74b4fbc70'></a>market-front-unified.nginx2.v2.${service_corpsite}.requester.splits.${requester}.${code}.metrics.req_time.buckets.${buckets_req_time}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_req_time%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    requester,
    code,
    buckets_req_time

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.requester.splits.%24%7Brequester%7D.%24%7Bcode%7D.metrics.req_time.buckets.%24%7Bbuckets_req_time%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_req_time%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.requester.splits.${requester}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        requester,
        code,
        buckets_req_time
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='1a58d55b2ee17c8ce3ec12cda0c9d68a'></a>market-front-unified.nginx2.v2.${service_corpsite}.requester.splits.${requester}.${code}.metrics.handshake.buckets.${buckets_handshake}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_handshake%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    requester,
    code,
    buckets_handshake

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.requester.splits.%24%7Brequester%7D.%24%7Bcode%7D.metrics.handshake.buckets.%24%7Bbuckets_handshake%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_handshake%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.requester.splits.${requester}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        requester,
        code,
        buckets_handshake
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='4a050ff685fcd8a5027cfc57e448e995'></a>market-front-unified.nginx2.v2.${service_corpsite}.requester.splits.${requester}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_bytes_send%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    requester,
    code,
    buckets_bytes_send

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.requester.splits.%24%7Brequester%7D.%24%7Bcode%7D.metrics.bytes_send.buckets.%24%7Bbuckets_bytes_send%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_bytes_send%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.requester.splits.${requester}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        requester,
        code,
        buckets_bytes_send
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='91a510c933cdb133ed00e1818162d312'></a>market-front-unified.nginx2.v2.${service_corpsite}.resourceType.splits.${resource-type}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.resourceType.splits.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.resourceType.splits.${resource-type}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='3e7204fe8a8d9db04c8ed7ef6c4ddaf0'></a>market-front-unified.nginx2.v2.${service_corpsite}.resourceType.splits.${resource-type}.${code}.metrics.ttlb.buckets.${buckets_ttlb}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_ttlb%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    resource_type,
    code,
    buckets_ttlb

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.resourceType.splits.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.ttlb.buckets.%24%7Bbuckets_ttlb%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_ttlb%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.resourceType.splits.${resource-type}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        resource_type,
        code,
        buckets_ttlb
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='19d72004b18b5caa5f7d6e2b2feb6bda'></a>market-front-unified.nginx2.v2.${service_corpsite}.resourceType.splits.${resource-type}.${code}.metrics.req_time.buckets.${buckets_req_time}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_req_time%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    resource_type,
    code,
    buckets_req_time

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.resourceType.splits.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.req_time.buckets.%24%7Bbuckets_req_time%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_req_time%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.resourceType.splits.${resource-type}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        resource_type,
        code,
        buckets_req_time
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='7d2eeed7be77c1c04ad31293e826dafe'></a>market-front-unified.nginx2.v2.${service_corpsite}.resourceType.splits.${resource-type}.${code}.metrics.handshake.buckets.${buckets_handshake}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_handshake%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    resource_type,
    code,
    buckets_handshake

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.resourceType.splits.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.handshake.buckets.%24%7Bbuckets_handshake%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_handshake%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.resourceType.splits.${resource-type}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        resource_type,
        code,
        buckets_handshake
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='1e8baa99d9ad7fab7c85073c2ae21629'></a>market-front-unified.nginx2.v2.${service_corpsite}.resourceType.splits.${resource-type}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_bytes_send%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    resource_type,
    code,
    buckets_bytes_send

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.resourceType.splits.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.bytes_send.buckets.%24%7Bbuckets_bytes_send%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_bytes_send%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.resourceType.splits.${resource-type}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        resource_type,
        code,
        buckets_bytes_send
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='7ae54c0f5b5cb21e2a18eaa906f35ce5'></a>market-front-unified.nginx2.v2.${service_corpsite}.requester.dc.splits.${requester}.${dc}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    requester,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.requester.dc.splits.%24%7Brequester%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.requester.dc.splits.${requester}.${dc}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        requester,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='0ec04c6f18e02d501435ef3fdaa7b0e5'></a>market-front-unified.nginx2.v2.${service_corpsite}.requester.host.splits.${requester}.${host}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    requester,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.requester.host.splits.%24%7Brequester%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.requester.host.splits.${requester}.${host}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        requester,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='cbfb5e74b03d1a0e86a60d80aae6ae46'></a>market-front-unified.nginx2.v2.${service_corpsite}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    requester,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.requester.resourceType.splits.%24%7Brequester%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        requester,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='be96b1a4aa930c47c498a7c1284d062c'></a>market-front-unified.nginx2.v2.${service_corpsite}.robot.splits.${robot}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    robot,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.robot.splits.%24%7Brobot%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.robot.splits.${robot}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        robot,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='9da9b2284eb0bffc5c29d512226070bf'></a>market-front-unified.nginx2.v2.${service_corpsite}.robot.splits.${robot}.${code}.metrics.ttlb.buckets.${buckets_ttlb}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_ttlb%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    robot,
    code,
    buckets_ttlb

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.robot.splits.%24%7Brobot%7D.%24%7Bcode%7D.metrics.ttlb.buckets.%24%7Bbuckets_ttlb%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_ttlb%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.robot.splits.${robot}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        robot,
        code,
        buckets_ttlb
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='443425046b13a2acb3a1d84c9ebe6d4a'></a>market-front-unified.nginx2.v2.${service_corpsite}.robot.splits.${robot}.${code}.metrics.req_time.buckets.${buckets_req_time}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_req_time%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    robot,
    code,
    buckets_req_time

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.robot.splits.%24%7Brobot%7D.%24%7Bcode%7D.metrics.req_time.buckets.%24%7Bbuckets_req_time%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_req_time%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.robot.splits.${robot}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        robot,
        code,
        buckets_req_time
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='b23e62ef357f6f965f5bd05199831dcb'></a>market-front-unified.nginx2.v2.${service_corpsite}.robot.splits.${robot}.${code}.metrics.handshake.buckets.${buckets_handshake}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_handshake%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    robot,
    code,
    buckets_handshake

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.robot.splits.%24%7Brobot%7D.%24%7Bcode%7D.metrics.handshake.buckets.%24%7Bbuckets_handshake%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_handshake%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.robot.splits.${robot}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        robot,
        code,
        buckets_handshake
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='592a61e92c24a4d05c6c6fc79800d04e'></a>market-front-unified.nginx2.v2.${service_corpsite}.robot.splits.${robot}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_bytes_send%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    robot,
    code,
    buckets_bytes_send

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.robot.splits.%24%7Brobot%7D.%24%7Bcode%7D.metrics.bytes_send.buckets.%24%7Bbuckets_bytes_send%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_bytes_send%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.robot.splits.${robot}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        robot,
        code,
        buckets_bytes_send
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='800b1796e0be9da8f41d432714cb81e5'></a>market-front-unified.nginx2.v2.${service_corpsite}.robot.dc.splits.${robot}.${dc}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    robot,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.robot.dc.splits.%24%7Brobot%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.robot.dc.splits.${robot}.${dc}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        robot,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='884383c9942c432b32964061ddc90ebb'></a>market-front-unified.nginx2.v2.${service_corpsite}.robot.host.splits.${robot}.${host}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    robot,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.robot.host.splits.%24%7Brobot%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.robot.host.splits.${robot}.${host}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        robot,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='d6d9fbd493b00a99368667f13c04c3e8'></a>market-front-unified.nginx2.v2.${service_corpsite}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    robot,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.robot.resourceType.splits.%24%7Brobot%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        robot,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='fbbea39774821921d3b084020666f1cb'></a>market-front-unified.nginx2.v2.${service_corpsite}.page.splits.${page}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.page.splits.%24%7Bpage%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.page.splits.${page}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='fb780b2aa99e1e140bea247ca2bb2295'></a>market-front-unified.nginx2.v2.${service_corpsite}.page.splits.${page}.${code}.metrics.ttlb.buckets.${buckets_ttlb}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_ttlb%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    page,
    code,
    buckets_ttlb

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.page.splits.%24%7Bpage%7D.%24%7Bcode%7D.metrics.ttlb.buckets.%24%7Bbuckets_ttlb%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_ttlb%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.page.splits.${page}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        page,
        code,
        buckets_ttlb
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='5eab6932eea2aaf925cd925aa145ef73'></a>market-front-unified.nginx2.v2.${service_corpsite}.page.splits.${page}.${code}.metrics.req_time.buckets.${buckets_req_time}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_req_time%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    page,
    code,
    buckets_req_time

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.page.splits.%24%7Bpage%7D.%24%7Bcode%7D.metrics.req_time.buckets.%24%7Bbuckets_req_time%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_req_time%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.page.splits.${page}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        page,
        code,
        buckets_req_time
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='2da0c72a73d769ae7586db678b0c2811'></a>market-front-unified.nginx2.v2.${service_corpsite}.page.splits.${page}.${code}.metrics.handshake.buckets.${buckets_handshake}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_handshake%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    page,
    code,
    buckets_handshake

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.page.splits.%24%7Bpage%7D.%24%7Bcode%7D.metrics.handshake.buckets.%24%7Bbuckets_handshake%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_handshake%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.page.splits.${page}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        page,
        code,
        buckets_handshake
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='2bce49581cdf3c82caf228fcc66b33f6'></a>market-front-unified.nginx2.v2.${service_corpsite}.page.splits.${page}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_bytes_send%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    page,
    code,
    buckets_bytes_send

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.page.splits.%24%7Bpage%7D.%24%7Bcode%7D.metrics.bytes_send.buckets.%24%7Bbuckets_bytes_send%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_bytes_send%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.page.splits.${page}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        page,
        code,
        buckets_bytes_send
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='17d3d7aebc204eb83aa4531792a288c5'></a>market-front-unified.nginx2.v2.${service_corpsite}.dc.page.splits.${dc}.${page}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    dc,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.dc.page.splits.%24%7Bdc%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.dc.page.splits.${dc}.${page}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        dc,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='e3324f9157f4085e87594bf8f963e016'></a>market-front-unified.nginx2.v2.${service_corpsite}.host.page.splits.${host}.${page}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20host%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    host,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    host as host,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.host.page.splits.%24%7Bhost%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.host.page.splits.${host}.${page}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        host,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        host as host,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='32680a20235d710f29e63883e80e1872'></a>market-front-unified.nginx2.v2.${service_corpsite}.requester.page.splits.${requester}.${page}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    requester,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.requester.page.splits.%24%7Brequester%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.requester.page.splits.${requester}.${page}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        requester,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='ebc07c2c3207c420b7f074c2724ac46c'></a>market-front-unified.nginx2.v2.${service_corpsite}.resolver.splits.${resolver}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.resolver.splits.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.resolver.splits.${resolver}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='cc8cec4ad7776edca7e0c3d54412641a'></a>market-front-unified.nginx2.v2.${service_corpsite}.resolver.splits.${resolver}.${code}.metrics.ttlb.buckets.${buckets_ttlb}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_ttlb%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    resolver,
    code,
    buckets_ttlb

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.resolver.splits.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.ttlb.buckets.%24%7Bbuckets_ttlb%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_ttlb%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.resolver.splits.${resolver}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        resolver,
        code,
        buckets_ttlb
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='918733509f9cb270c9fa92400fe3bca2'></a>market-front-unified.nginx2.v2.${service_corpsite}.resolver.splits.${resolver}.${code}.metrics.req_time.buckets.${buckets_req_time}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_req_time%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    resolver,
    code,
    buckets_req_time

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.resolver.splits.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.req_time.buckets.%24%7Bbuckets_req_time%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_req_time%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.resolver.splits.${resolver}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        resolver,
        code,
        buckets_req_time
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='7f33181aa490ae283b9f11f9181f552c'></a>market-front-unified.nginx2.v2.${service_corpsite}.resolver.splits.${resolver}.${code}.metrics.handshake.buckets.${buckets_handshake}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_handshake%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    resolver,
    code,
    buckets_handshake

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.resolver.splits.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.handshake.buckets.%24%7Bbuckets_handshake%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_handshake%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.resolver.splits.${resolver}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        resolver,
        code,
        buckets_handshake
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='1948c2fbf4b685c9fae66c2edc35f124'></a>market-front-unified.nginx2.v2.${service_corpsite}.resolver.splits.${resolver}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_bytes_send%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    resolver,
    code,
    buckets_bytes_send

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.resolver.splits.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.bytes_send.buckets.%24%7Bbuckets_bytes_send%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_bytes_send%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.resolver.splits.${resolver}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        resolver,
        code,
        buckets_bytes_send
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='1ee4ce841237bdfcd20814461ec2a299'></a>market-front-unified.nginx2.v2.${service_corpsite}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    dc,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.dc.resolver.splits.%24%7Bdc%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        dc,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='cb60567ac058ca9d09f83002540690f8'></a>market-front-unified.nginx2.v2.${service_corpsite}.host.resolver.splits.${host}.${resolver}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20host%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    host,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    host as host,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.host.resolver.splits.%24%7Bhost%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.host.resolver.splits.${host}.${resolver}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        host,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        host as host,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='6b86b948a81be2eca190fae11a98af5c'></a>market-front-unified.nginx2.v2.${service_corpsite}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    requester,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.requester.resolver.splits.%24%7Brequester%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        requester,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='8c8f3b09fd0c061466e61b4a86361a25'></a>market-front-unified.nginx2.v2.${service_corpsite}.robot.page.splits.${robot}.${page}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    robot,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.robot.page.splits.%24%7Brobot%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.robot.page.splits.${robot}.${page}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        robot,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='01c2209dcbf22deaadb65bc881e907d0'></a>market-front-unified.nginx2.v2.${service_corpsite}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_corpsite,
    robot,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.robot.resolver.splits.%24%7Brobot%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_corpsite,
        robot,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='3d2c39297e47c8c59ce0b06501b06115'></a>market-front-unified.nginx2.v2.${service_corpsite}.total.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
    service_corpsite,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.total.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.total.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
        service_corpsite,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='1b5fa6aa6300b59f25cc06efb949626e'></a>market-front-unified.nginx2.v2.${service_corpsite}.dc.splits.${dc}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
    service_corpsite,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.dc.splits.%24%7Bdc%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.dc.splits.${dc}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
        service_corpsite,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='5c5076f016b22645283865220afb8fac'></a>market-front-unified.nginx2.v2.${service_corpsite}.host.splits.${host}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
    service_corpsite,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.host.splits.%24%7Bhost%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.host.splits.${host}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
        service_corpsite,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='fb3528d8b5baab773b0cad67f6b8a1a4'></a>market-front-unified.nginx2.v2.${service_corpsite}.requester.splits.${requester}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
    service_corpsite,
    requester,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.requester.splits.%24%7Brequester%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.requester.splits.${requester}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
        service_corpsite,
        requester,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='6e011d630efeb53b28eb8ed8e079741d'></a>market-front-unified.nginx2.v2.${service_corpsite}.resourceType.splits.${resource-type}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
    service_corpsite,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.resourceType.splits.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.resourceType.splits.${resource-type}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
        service_corpsite,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='06c2dc2f915e04e821585346e10df00e'></a>market-front-unified.nginx2.v2.${service_corpsite}.requester.dc.splits.${requester}.${dc}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
    service_corpsite,
    requester,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.requester.dc.splits.%24%7Brequester%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.requester.dc.splits.${requester}.${dc}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
        service_corpsite,
        requester,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='903ccbcd6dcc3c2f2c61c585c9e82684'></a>market-front-unified.nginx2.v2.${service_corpsite}.requester.host.splits.${requester}.${host}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
    service_corpsite,
    requester,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.requester.host.splits.%24%7Brequester%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.requester.host.splits.${requester}.${host}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
        service_corpsite,
        requester,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='a563b9073e2dd279464bda8c3b9515a7'></a>market-front-unified.nginx2.v2.${service_corpsite}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
    service_corpsite,
    requester,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.requester.resourceType.splits.%24%7Brequester%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
        service_corpsite,
        requester,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='710f8c338eb6cd16dc8cb3b69dc1b93d'></a>market-front-unified.nginx2.v2.${service_corpsite}.robot.splits.${robot}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0,
    service_corpsite,
    robot,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.robot.splits.%24%7Brobot%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.robot.splits.${robot}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0,
        service_corpsite,
        robot,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='ef2244c585765700dd2849cab354d791'></a>market-front-unified.nginx2.v2.${service_corpsite}.robot.dc.splits.${robot}.${dc}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0,
    service_corpsite,
    robot,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.robot.dc.splits.%24%7Brobot%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.robot.dc.splits.${robot}.${dc}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0,
        service_corpsite,
        robot,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='99b6ae738f845e08143e328b6e0ec0e9'></a>market-front-unified.nginx2.v2.${service_corpsite}.robot.host.splits.${robot}.${host}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0,
    service_corpsite,
    robot,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.robot.host.splits.%24%7Brobot%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.robot.host.splits.${robot}.${host}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0,
        service_corpsite,
        robot,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='d86f91a6f321b8e48d7948d4edc6f11a'></a>market-front-unified.nginx2.v2.${service_corpsite}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0,
    service_corpsite,
    robot,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.robot.resourceType.splits.%24%7Brobot%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0,
        service_corpsite,
        robot,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='08aa136a40de3f780b01a95a9f9f7bde'></a>market-front-unified.nginx2.v2.${service_corpsite}.page.splits.${page}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0,
    service_corpsite,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.page.splits.%24%7Bpage%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.page.splits.${page}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0,
        service_corpsite,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='10169b78309ea4cc1c17168c7828f085'></a>market-front-unified.nginx2.v2.${service_corpsite}.dc.page.splits.${dc}.${page}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0,
    service_corpsite,
    dc,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.dc.page.splits.%24%7Bdc%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.dc.page.splits.${dc}.${page}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0,
        service_corpsite,
        dc,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='4ad624d09941cd975033f253f8baa266'></a>market-front-unified.nginx2.v2.${service_corpsite}.host.page.splits.${host}.${page}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20host%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0,
    service_corpsite,
    host,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    host as host,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.host.page.splits.%24%7Bhost%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.host.page.splits.${host}.${page}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0,
        service_corpsite,
        host,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        host as host,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='5ea1fd55399ac2c0f85d523b82e9e85a'></a>market-front-unified.nginx2.v2.${service_corpsite}.requester.page.splits.${requester}.${page}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0,
    service_corpsite,
    requester,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.requester.page.splits.%24%7Brequester%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.requester.page.splits.${requester}.${page}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0,
        service_corpsite,
        requester,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='678d2ae4960b890b46e9e72692b759fd'></a>market-front-unified.nginx2.v2.${service_corpsite}.resolver.splits.${resolver}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_corpsite,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.resolver.splits.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.resolver.splits.${resolver}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_corpsite,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='c3c03b63cafb9985bd561b1e6578f676'></a>market-front-unified.nginx2.v2.${service_corpsite}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_corpsite,
    dc,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.dc.resolver.splits.%24%7Bdc%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_corpsite,
        dc,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='ad0b40ef0d447347c29a0cdac4188e03'></a>market-front-unified.nginx2.v2.${service_corpsite}.host.resolver.splits.${host}.${resolver}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20host%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_corpsite,
    host,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    host as host,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.host.resolver.splits.%24%7Bhost%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.host.resolver.splits.${host}.${resolver}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_corpsite,
        host,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        host as host,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='3cbddd0ed975792a6d80004f19eeffce'></a>market-front-unified.nginx2.v2.${service_corpsite}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_corpsite,
    requester,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.requester.resolver.splits.%24%7Brequester%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_corpsite,
        requester,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='013f856a998c0f2d19f3f0d5a230e73f'></a>market-front-unified.nginx2.v2.${service_corpsite}.robot.page.splits.${robot}.${page}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id != '') as value_0,
    service_corpsite,
    robot,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.robot.page.splits.%24%7Brobot%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.robot.page.splits.${robot}.${page}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id != '') as value_0,
        service_corpsite,
        robot,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='d200e5b6cb949c39073b27ac05bf9606'></a>market-front-unified.nginx2.v2.${service_corpsite}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_corpsite,
    robot,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.robot.resolver.splits.%24%7Brobot%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_corpsite,
        robot,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='45edf5e1e805c1af99524518ee2524b4'></a>market-front-unified.nginx2.v2.${service_corpsite}.total.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
    service_corpsite,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.total.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.total.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
        service_corpsite,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='1b41b26f1d81075e9368754fbae236c6'></a>market-front-unified.nginx2.v2.${service_corpsite}.dc.splits.${dc}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
    service_corpsite,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.dc.splits.%24%7Bdc%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.dc.splits.${dc}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
        service_corpsite,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='c7a83ff0bc3dda1a148ac8c76aff518c'></a>market-front-unified.nginx2.v2.${service_corpsite}.host.splits.${host}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
    service_corpsite,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.host.splits.%24%7Bhost%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.host.splits.${host}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
        service_corpsite,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='219ff08497d45abd4c1099a378fd3608'></a>market-front-unified.nginx2.v2.${service_corpsite}.requester.splits.${requester}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
    service_corpsite,
    requester,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.requester.splits.%24%7Brequester%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.requester.splits.${requester}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
        service_corpsite,
        requester,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='5a3d66385a8b9dcacc9c93be2a1ca2d8'></a>market-front-unified.nginx2.v2.${service_corpsite}.resourceType.splits.${resource-type}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
    service_corpsite,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.resourceType.splits.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.resourceType.splits.${resource-type}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
        service_corpsite,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='9d886205c7a40589bf58cfe664ec350f'></a>market-front-unified.nginx2.v2.${service_corpsite}.requester.dc.splits.${requester}.${dc}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
    service_corpsite,
    requester,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.requester.dc.splits.%24%7Brequester%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.requester.dc.splits.${requester}.${dc}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
        service_corpsite,
        requester,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='b44d61891c1542c480cdb39be2f8225b'></a>market-front-unified.nginx2.v2.${service_corpsite}.requester.host.splits.${requester}.${host}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
    service_corpsite,
    requester,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.requester.host.splits.%24%7Brequester%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.requester.host.splits.${requester}.${host}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
        service_corpsite,
        requester,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='6f8290e605726eddda6123b869f5ef34'></a>market-front-unified.nginx2.v2.${service_corpsite}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
    service_corpsite,
    requester,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.requester.resourceType.splits.%24%7Brequester%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
        service_corpsite,
        requester,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='013c9804eba015e1df4d8d0e9e4dda3a'></a>market-front-unified.nginx2.v2.${service_corpsite}.robot.splits.${robot}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0,
    service_corpsite,
    robot,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.robot.splits.%24%7Brobot%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.robot.splits.${robot}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0,
        service_corpsite,
        robot,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='f7a65001ce45c5b362b24bc9e6d3db5f'></a>market-front-unified.nginx2.v2.${service_corpsite}.robot.dc.splits.${robot}.${dc}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0,
    service_corpsite,
    robot,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.robot.dc.splits.%24%7Brobot%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.robot.dc.splits.${robot}.${dc}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0,
        service_corpsite,
        robot,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='83921fc68bf698853b4ef11cd036c47f'></a>market-front-unified.nginx2.v2.${service_corpsite}.robot.host.splits.${robot}.${host}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0,
    service_corpsite,
    robot,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.robot.host.splits.%24%7Brobot%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.robot.host.splits.${robot}.${host}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0,
        service_corpsite,
        robot,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='2630d4a62de8949d2e391910f040c722'></a>market-front-unified.nginx2.v2.${service_corpsite}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0,
    service_corpsite,
    robot,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.robot.resourceType.splits.%24%7Brobot%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0,
        service_corpsite,
        robot,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='78c03ec2f57fa4e86cd5179e8b4f18ee'></a>market-front-unified.nginx2.v2.${service_corpsite}.page.splits.${page}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0,
    service_corpsite,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.page.splits.%24%7Bpage%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.page.splits.${page}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0,
        service_corpsite,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='2826f1bd99628fd41eeec4b66795aa3c'></a>market-front-unified.nginx2.v2.${service_corpsite}.dc.page.splits.${dc}.${page}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0,
    service_corpsite,
    dc,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.dc.page.splits.%24%7Bdc%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.dc.page.splits.${dc}.${page}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0,
        service_corpsite,
        dc,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='ba8f86b42f732de352b89580d88def3f'></a>market-front-unified.nginx2.v2.${service_corpsite}.host.page.splits.${host}.${page}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20host%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0,
    service_corpsite,
    host,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    host as host,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.host.page.splits.%24%7Bhost%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.host.page.splits.${host}.${page}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0,
        service_corpsite,
        host,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        host as host,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='b1796a6cdcc8d2fb802facde65c42963'></a>market-front-unified.nginx2.v2.${service_corpsite}.requester.page.splits.${requester}.${page}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0,
    service_corpsite,
    requester,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.requester.page.splits.%24%7Brequester%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.requester.page.splits.${requester}.${page}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0,
        service_corpsite,
        requester,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='53e91f59908a69e0a63fa5fca1f76e72'></a>market-front-unified.nginx2.v2.${service_corpsite}.resolver.splits.${resolver}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_corpsite,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.resolver.splits.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.resolver.splits.${resolver}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_corpsite,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='be01bece4dd426dfb1ab667a17d80f31'></a>market-front-unified.nginx2.v2.${service_corpsite}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_corpsite,
    dc,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.dc.resolver.splits.%24%7Bdc%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_corpsite,
        dc,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='f52ff019ea40ffbd74e3acb3f6e8a5fb'></a>market-front-unified.nginx2.v2.${service_corpsite}.host.resolver.splits.${host}.${resolver}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20host%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_corpsite,
    host,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    host as host,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.host.resolver.splits.%24%7Bhost%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.host.resolver.splits.${host}.${resolver}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_corpsite,
        host,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        host as host,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='a204e845312916ed3fa1a03a6c9d7f66'></a>market-front-unified.nginx2.v2.${service_corpsite}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_corpsite,
    requester,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.requester.resolver.splits.%24%7Brequester%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_corpsite,
        requester,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='4fc7d3e78b87a1229bc8a99355dc977f'></a>market-front-unified.nginx2.v2.${service_corpsite}.robot.page.splits.${robot}.${page}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id != '') as value_0,
    service_corpsite,
    robot,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.robot.page.splits.%24%7Brobot%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.robot.page.splits.${robot}.${page}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id != '') as value_0,
        service_corpsite,
        robot,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='d578a9f52078c8b7745835cadda9a3b8'></a>market-front-unified.nginx2.v2.${service_corpsite}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_corpsite,
    robot,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.robot.resolver.splits.%24%7Brobot%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_corpsite,
        robot,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='19b68ed816157db328869ba8ac421df4'></a>market-front-unified.nginx2.v2.${service_corpsite}.total.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
    service_corpsite,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.total.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.total.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
        service_corpsite,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='916867e107395739a4b4f0508b32f19c'></a>market-front-unified.nginx2.v2.${service_corpsite}.dc.splits.${dc}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
    service_corpsite,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.dc.splits.%24%7Bdc%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.dc.splits.${dc}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
        service_corpsite,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='ccf8f502479f60c05825cf4732bbf3ae'></a>market-front-unified.nginx2.v2.${service_corpsite}.host.splits.${host}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
    service_corpsite,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.host.splits.%24%7Bhost%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.host.splits.${host}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
        service_corpsite,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='9c2f840f8b4252b9fbaa6933c03446a6'></a>market-front-unified.nginx2.v2.${service_corpsite}.requester.splits.${requester}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
    service_corpsite,
    requester,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.requester.splits.%24%7Brequester%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.requester.splits.${requester}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
        service_corpsite,
        requester,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='b9ed7333a7b18f7040d686496c1357af'></a>market-front-unified.nginx2.v2.${service_corpsite}.resourceType.splits.${resource-type}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
    service_corpsite,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.resourceType.splits.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.resourceType.splits.${resource-type}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
        service_corpsite,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='3297d67dd9118f85a3ec736c5a513ec7'></a>market-front-unified.nginx2.v2.${service_corpsite}.requester.dc.splits.${requester}.${dc}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
    service_corpsite,
    requester,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.requester.dc.splits.%24%7Brequester%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.requester.dc.splits.${requester}.${dc}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
        service_corpsite,
        requester,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='c0dfe2452b30a3fec352b213330efe24'></a>market-front-unified.nginx2.v2.${service_corpsite}.requester.host.splits.${requester}.${host}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
    service_corpsite,
    requester,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.requester.host.splits.%24%7Brequester%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.requester.host.splits.${requester}.${host}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
        service_corpsite,
        requester,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='777749909f203285a2a1bc363cbde90e'></a>market-front-unified.nginx2.v2.${service_corpsite}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
    service_corpsite,
    requester,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.requester.resourceType.splits.%24%7Brequester%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
        service_corpsite,
        requester,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='807fd8825ea565bacda517127f69131e'></a>market-front-unified.nginx2.v2.${service_corpsite}.robot.splits.${robot}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0,
    service_corpsite,
    robot,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.robot.splits.%24%7Brobot%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.robot.splits.${robot}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0,
        service_corpsite,
        robot,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='8f533ac25dd838b7658efb79fa3a8e8f'></a>market-front-unified.nginx2.v2.${service_corpsite}.robot.dc.splits.${robot}.${dc}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0,
    service_corpsite,
    robot,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.robot.dc.splits.%24%7Brobot%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.robot.dc.splits.${robot}.${dc}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0,
        service_corpsite,
        robot,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='32e17bb9212fe5801637fdfccc4554c7'></a>market-front-unified.nginx2.v2.${service_corpsite}.robot.host.splits.${robot}.${host}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0,
    service_corpsite,
    robot,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.robot.host.splits.%24%7Brobot%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.robot.host.splits.${robot}.${host}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0,
        service_corpsite,
        robot,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='62c65d99e6f3175e4916b7943977c940'></a>market-front-unified.nginx2.v2.${service_corpsite}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0,
    service_corpsite,
    robot,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.robot.resourceType.splits.%24%7Brobot%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0,
        service_corpsite,
        robot,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='bb829d8afb2cbf9687db4f0403b31a6b'></a>market-front-unified.nginx2.v2.${service_corpsite}.page.splits.${page}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0,
    service_corpsite,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.page.splits.%24%7Bpage%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.page.splits.${page}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0,
        service_corpsite,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='2b713a801600ab46826aa49ff7004970'></a>market-front-unified.nginx2.v2.${service_corpsite}.dc.page.splits.${dc}.${page}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0,
    service_corpsite,
    dc,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.dc.page.splits.%24%7Bdc%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.dc.page.splits.${dc}.${page}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0,
        service_corpsite,
        dc,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='20b9f4eb7eee8e4d823b400f14535c5d'></a>market-front-unified.nginx2.v2.${service_corpsite}.host.page.splits.${host}.${page}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20host%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0,
    service_corpsite,
    host,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    host as host,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.host.page.splits.%24%7Bhost%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.host.page.splits.${host}.${page}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0,
        service_corpsite,
        host,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        host as host,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='9f4f83223ce435789608327dfa66ccf7'></a>market-front-unified.nginx2.v2.${service_corpsite}.requester.page.splits.${requester}.${page}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0,
    service_corpsite,
    requester,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.requester.page.splits.%24%7Brequester%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.requester.page.splits.${requester}.${page}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0,
        service_corpsite,
        requester,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='9d40c45435994d80dfcd93d2e6d6a3e6'></a>market-front-unified.nginx2.v2.${service_corpsite}.resolver.splits.${resolver}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_corpsite,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.resolver.splits.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.resolver.splits.${resolver}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_corpsite,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='6f4c45f63eebb110fcfbd457d7844829'></a>market-front-unified.nginx2.v2.${service_corpsite}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_corpsite,
    dc,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.dc.resolver.splits.%24%7Bdc%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_corpsite,
        dc,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='174d870307e8e9c868e1a26a9261a3c2'></a>market-front-unified.nginx2.v2.${service_corpsite}.host.resolver.splits.${host}.${resolver}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20host%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_corpsite,
    host,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    host as host,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.host.resolver.splits.%24%7Bhost%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.host.resolver.splits.${host}.${resolver}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_corpsite,
        host,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        host as host,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='9a38c5e00c1cdc1983d138129725d5c9'></a>market-front-unified.nginx2.v2.${service_corpsite}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_corpsite,
    requester,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.requester.resolver.splits.%24%7Brequester%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_corpsite,
        requester,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='ae1256f734b534df15ed89dc077ec9cf'></a>market-front-unified.nginx2.v2.${service_corpsite}.robot.page.splits.${robot}.${page}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id != '') as value_0,
    service_corpsite,
    robot,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.robot.page.splits.%24%7Brobot%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.robot.page.splits.${robot}.${page}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id != '') as value_0,
        service_corpsite,
        robot,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='49fb7c90d622d95cbc86e47ed6576509'></a>market-front-unified.nginx2.v2.${service_corpsite}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_corpsite,
    robot,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.robot.resolver.splits.%24%7Brobot%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_corpsite,
        robot,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='f231e3fc23a35acc14d674199cb0c925'></a>market-front-unified.nginx2.v2.${service_corpsite}.total.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
    service_corpsite,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.total.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.total.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
        service_corpsite,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='078450f52bc0193494b9f846b92083d0'></a>market-front-unified.nginx2.v2.${service_corpsite}.dc.splits.${dc}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
    service_corpsite,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.dc.splits.%24%7Bdc%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.dc.splits.${dc}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
        service_corpsite,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='41318e45dba2a785f0232d1a64066ab9'></a>market-front-unified.nginx2.v2.${service_corpsite}.host.splits.${host}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
    service_corpsite,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.host.splits.%24%7Bhost%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.host.splits.${host}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
        service_corpsite,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='03dfcd0e22ec422b5ca36134c3077ff5'></a>market-front-unified.nginx2.v2.${service_corpsite}.requester.splits.${requester}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
    service_corpsite,
    requester,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.requester.splits.%24%7Brequester%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.requester.splits.${requester}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
        service_corpsite,
        requester,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='fae17af292cede9bd7a462f8509f8b9d'></a>market-front-unified.nginx2.v2.${service_corpsite}.resourceType.splits.${resource-type}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
    service_corpsite,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.resourceType.splits.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.resourceType.splits.${resource-type}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
        service_corpsite,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='0c7ac3c91f54f9e7761699643b404c03'></a>market-front-unified.nginx2.v2.${service_corpsite}.requester.dc.splits.${requester}.${dc}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
    service_corpsite,
    requester,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.requester.dc.splits.%24%7Brequester%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.requester.dc.splits.${requester}.${dc}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
        service_corpsite,
        requester,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='d06a4eeec5d1729f0ce3fa6288488c75'></a>market-front-unified.nginx2.v2.${service_corpsite}.requester.host.splits.${requester}.${host}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
    service_corpsite,
    requester,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.requester.host.splits.%24%7Brequester%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.requester.host.splits.${requester}.${host}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
        service_corpsite,
        requester,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='d44789e22a119dc3207ccec5f93476f9'></a>market-front-unified.nginx2.v2.${service_corpsite}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
    service_corpsite,
    requester,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.requester.resourceType.splits.%24%7Brequester%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0,
        service_corpsite,
        requester,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='75a78d0b835808ab0053b83cebc87963'></a>market-front-unified.nginx2.v2.${service_corpsite}.robot.splits.${robot}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0,
    service_corpsite,
    robot,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.robot.splits.%24%7Brobot%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.robot.splits.${robot}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0,
        service_corpsite,
        robot,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='421e4b8a2b758306ee806677d113e455'></a>market-front-unified.nginx2.v2.${service_corpsite}.robot.dc.splits.${robot}.${dc}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0,
    service_corpsite,
    robot,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.robot.dc.splits.%24%7Brobot%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.robot.dc.splits.${robot}.${dc}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0,
        service_corpsite,
        robot,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='5621c0a980f5c4e881413a414d03310b'></a>market-front-unified.nginx2.v2.${service_corpsite}.robot.host.splits.${robot}.${host}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0,
    service_corpsite,
    robot,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.robot.host.splits.%24%7Brobot%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.robot.host.splits.${robot}.${host}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0,
        service_corpsite,
        robot,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='01220d5f251e5977d2504b16d5f7ede5'></a>market-front-unified.nginx2.v2.${service_corpsite}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0,
    service_corpsite,
    robot,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.robot.resourceType.splits.%24%7Brobot%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0,
        service_corpsite,
        robot,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='68518487ae730e81e2a26c0ce5508bfc'></a>market-front-unified.nginx2.v2.${service_corpsite}.page.splits.${page}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0,
    service_corpsite,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.page.splits.%24%7Bpage%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.page.splits.${page}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0,
        service_corpsite,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='177341c415541bca151b5de992013786'></a>market-front-unified.nginx2.v2.${service_corpsite}.dc.page.splits.${dc}.${page}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0,
    service_corpsite,
    dc,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.dc.page.splits.%24%7Bdc%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.dc.page.splits.${dc}.${page}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0,
        service_corpsite,
        dc,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='c15bf151c32c5ff7911ef0d76c443284'></a>market-front-unified.nginx2.v2.${service_corpsite}.host.page.splits.${host}.${page}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20host%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0,
    service_corpsite,
    host,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    host as host,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.host.page.splits.%24%7Bhost%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.host.page.splits.${host}.${page}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0,
        service_corpsite,
        host,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        host as host,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='c68e06399c234714c8525d2e1dbbfdf9'></a>market-front-unified.nginx2.v2.${service_corpsite}.requester.page.splits.${requester}.${page}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0,
    service_corpsite,
    requester,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.requester.page.splits.%24%7Brequester%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.requester.page.splits.${requester}.${page}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0,
        service_corpsite,
        requester,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='2974e188ea702d9141ff99762b40beae'></a>market-front-unified.nginx2.v2.${service_corpsite}.resolver.splits.${resolver}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_corpsite,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.resolver.splits.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.resolver.splits.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_corpsite,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='af5a6fcef379bb6d740d689b710656fc'></a>market-front-unified.nginx2.v2.${service_corpsite}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_corpsite,
    dc,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.dc.resolver.splits.%24%7Bdc%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_corpsite,
        dc,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='4759e3d4cc3a07464271b8136cdb266e'></a>market-front-unified.nginx2.v2.${service_corpsite}.host.resolver.splits.${host}.${resolver}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20host%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_corpsite,
    host,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    host as host,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.host.resolver.splits.%24%7Bhost%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.host.resolver.splits.${host}.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_corpsite,
        host,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        host as host,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='d13a2bb50e4406e0d7159f4d6de22e55'></a>market-front-unified.nginx2.v2.${service_corpsite}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_corpsite,
    requester,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.requester.resolver.splits.%24%7Brequester%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_corpsite,
        requester,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='b98a7357e37f1ecbef22c47065ecca7b'></a>market-front-unified.nginx2.v2.${service_corpsite}.robot.page.splits.${robot}.${page}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id != '') as value_0,
    service_corpsite,
    robot,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.robot.page.splits.%24%7Brobot%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.robot.page.splits.${robot}.${page}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id != '') as value_0,
        service_corpsite,
        robot,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='d265be9201e27f737a42cc2a9f56f644'></a>market-front-unified.nginx2.v2.${service_corpsite}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_corpsite%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_corpsite,
    robot,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_corpsite%7D.robot.resolver.splits.%24%7Brobot%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_corpsite%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'yandexmarketgroup.ru'%2C%20'corpsite_desktop'%20%2C%20'undefined_service'%20)%20as%20service_corpsite%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_corpsite}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_corpsite,
        robot,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```


## Overall Diagnostics

### Portion #1

```SQL
SELECT * FROM (
    SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.total.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.total.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, code, buckets_ttlb FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.total.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, code, buckets_req_time FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.total.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, code, buckets_handshake FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.total.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, code, buckets_bytes_send FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.dc.splits.${dc}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.dc.splits.${dc}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, dc, code, buckets_ttlb FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.dc.splits.${dc}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, dc, code, buckets_req_time FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.dc.splits.${dc}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, dc, code, buckets_handshake FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.dc.splits.${dc}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, dc, code, buckets_bytes_send FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.host.splits.${host}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.host.splits.${host}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, host, code, buckets_ttlb FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.host.splits.${host}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, host, code, buckets_req_time FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.host.splits.${host}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, host, code, buckets_handshake FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.host.splits.${host}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, host, code, buckets_bytes_send FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.requester.splits.${requester}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, requester, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.requester.splits.${requester}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, requester, code, buckets_ttlb FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.requester.splits.${requester}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, requester, code, buckets_req_time FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.requester.splits.${requester}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, requester, code, buckets_handshake FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.requester.splits.${requester}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, requester, code, buckets_bytes_send FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
) ORDER BY cnt DESC
```
### Portion #2

```SQL
SELECT * FROM (
    SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.resourceType.splits.${resource-type}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.resourceType.splits.${resource-type}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, resource_type, code, buckets_ttlb FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.resourceType.splits.${resource-type}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, resource_type, code, buckets_req_time FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.resourceType.splits.${resource-type}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, resource_type, code, buckets_handshake FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.resourceType.splits.${resource-type}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, resource_type, code, buckets_bytes_send FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.requester.dc.splits.${requester}.${dc}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, requester, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.requester.host.splits.${requester}.${host}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, requester, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, requester, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.robot.splits.${robot}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, robot, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.robot.splits.${robot}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, robot, code, buckets_ttlb FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.robot.splits.${robot}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, robot, code, buckets_req_time FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.robot.splits.${robot}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, robot, code, buckets_handshake FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.robot.splits.${robot}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, robot, code, buckets_bytes_send FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.robot.dc.splits.${robot}.${dc}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, robot, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.robot.host.splits.${robot}.${host}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, robot, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, robot, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.page.splits.${page}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.page.splits.${page}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, page, code, buckets_ttlb FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.page.splits.${page}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, page, code, buckets_req_time FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.page.splits.${page}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, page, code, buckets_handshake FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
) ORDER BY cnt DESC
```
### Portion #3

```SQL
SELECT * FROM (
    SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.page.splits.${page}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, page, code, buckets_bytes_send FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.dc.page.splits.${dc}.${page}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, dc, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.host.page.splits.${host}.${page}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, host, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, host as host, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.requester.page.splits.${requester}.${page}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, requester, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.resolver.splits.${resolver}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.resolver.splits.${resolver}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, resolver, code, buckets_ttlb FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.resolver.splits.${resolver}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, resolver, code, buckets_req_time FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.resolver.splits.${resolver}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, resolver, code, buckets_handshake FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.resolver.splits.${resolver}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, resolver, code, buckets_bytes_send FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, dc, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.host.resolver.splits.${host}.${resolver}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, host, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, host as host, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, requester, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.robot.page.splits.${robot}.${page}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, robot, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_corpsite, robot, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.total.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0, service_corpsite, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.dc.splits.${dc}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0, service_corpsite, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.host.splits.${host}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0, service_corpsite, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.requester.splits.${requester}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0, service_corpsite, requester, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.resourceType.splits.${resource-type}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0, service_corpsite, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.requester.dc.splits.${requester}.${dc}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0, service_corpsite, requester, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
) ORDER BY cnt DESC
```
### Portion #4

```SQL
SELECT * FROM (
    SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.requester.host.splits.${requester}.${host}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0, service_corpsite, requester, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0, service_corpsite, requester, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.robot.splits.${robot}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0, service_corpsite, robot, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.robot.dc.splits.${robot}.${dc}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0, service_corpsite, robot, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.robot.host.splits.${robot}.${host}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0, service_corpsite, robot, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0, service_corpsite, robot, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.page.splits.${page}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0, service_corpsite, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.dc.page.splits.${dc}.${page}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0, service_corpsite, dc, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.host.page.splits.${host}.${page}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0, service_corpsite, host, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, host as host, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.requester.page.splits.${requester}.${page}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0, service_corpsite, requester, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.resolver.splits.${resolver}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_corpsite, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_corpsite, dc, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.host.resolver.splits.${host}.${resolver}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_corpsite, host, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, host as host, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_corpsite, requester, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.robot.page.splits.${robot}.${page}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id != '') as value_0, service_corpsite, robot, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_corpsite, robot, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.total.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0, service_corpsite, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.dc.splits.${dc}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0, service_corpsite, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.host.splits.${host}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0, service_corpsite, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.requester.splits.${requester}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0, service_corpsite, requester, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
) ORDER BY cnt DESC
```
### Portion #5

```SQL
SELECT * FROM (
    SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.resourceType.splits.${resource-type}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0, service_corpsite, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.requester.dc.splits.${requester}.${dc}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0, service_corpsite, requester, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.requester.host.splits.${requester}.${host}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0, service_corpsite, requester, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0, service_corpsite, requester, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.robot.splits.${robot}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0, service_corpsite, robot, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.robot.dc.splits.${robot}.${dc}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0, service_corpsite, robot, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.robot.host.splits.${robot}.${host}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0, service_corpsite, robot, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0, service_corpsite, robot, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.page.splits.${page}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0, service_corpsite, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.dc.page.splits.${dc}.${page}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0, service_corpsite, dc, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.host.page.splits.${host}.${page}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0, service_corpsite, host, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, host as host, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.requester.page.splits.${requester}.${page}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0, service_corpsite, requester, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.resolver.splits.${resolver}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_corpsite, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_corpsite, dc, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.host.resolver.splits.${host}.${resolver}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_corpsite, host, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, host as host, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_corpsite, requester, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.robot.page.splits.${robot}.${page}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id != '') as value_0, service_corpsite, robot, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_corpsite, robot, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.total.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0, service_corpsite, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.dc.splits.${dc}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0, service_corpsite, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
) ORDER BY cnt DESC
```
### Portion #6

```SQL
SELECT * FROM (
    SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.host.splits.${host}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0, service_corpsite, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.requester.splits.${requester}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0, service_corpsite, requester, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.resourceType.splits.${resource-type}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0, service_corpsite, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.requester.dc.splits.${requester}.${dc}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0, service_corpsite, requester, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.requester.host.splits.${requester}.${host}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0, service_corpsite, requester, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0, service_corpsite, requester, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.robot.splits.${robot}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0, service_corpsite, robot, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.robot.dc.splits.${robot}.${dc}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0, service_corpsite, robot, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.robot.host.splits.${robot}.${host}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0, service_corpsite, robot, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0, service_corpsite, robot, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.page.splits.${page}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0, service_corpsite, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.dc.page.splits.${dc}.${page}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0, service_corpsite, dc, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.host.page.splits.${host}.${page}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0, service_corpsite, host, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, host as host, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.requester.page.splits.${requester}.${page}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0, service_corpsite, requester, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.resolver.splits.${resolver}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_corpsite, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_corpsite, dc, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.host.resolver.splits.${host}.${resolver}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_corpsite, host, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, host as host, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_corpsite, requester, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.robot.page.splits.${robot}.${page}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id != '') as value_0, service_corpsite, robot, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_corpsite, robot, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
) ORDER BY cnt DESC
```
### Portion #7

```SQL
SELECT * FROM (
    SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.total.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0, service_corpsite, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.dc.splits.${dc}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0, service_corpsite, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.host.splits.${host}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0, service_corpsite, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.requester.splits.${requester}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0, service_corpsite, requester, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.resourceType.splits.${resource-type}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0, service_corpsite, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.requester.dc.splits.${requester}.${dc}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0, service_corpsite, requester, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.requester.host.splits.${requester}.${host}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0, service_corpsite, requester, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') as value_0, service_corpsite, requester, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.robot.splits.${robot}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0, service_corpsite, robot, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.robot.dc.splits.${robot}.${dc}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0, service_corpsite, robot, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.robot.host.splits.${robot}.${host}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0, service_corpsite, robot, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') as value_0, service_corpsite, robot, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.page.splits.${page}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0, service_corpsite, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.dc.page.splits.${dc}.${page}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0, service_corpsite, dc, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.host.page.splits.${host}.${page}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0, service_corpsite, host, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, host as host, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.requester.page.splits.${requester}.${page}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') as value_0, service_corpsite, requester, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.resolver.splits.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_corpsite, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_corpsite, dc, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.host.resolver.splits.${host}.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_corpsite, host, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, host as host, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_corpsite, requester, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
) ORDER BY cnt DESC
```
### Portion #8

```SQL
SELECT * FROM (
    SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.robot.page.splits.${robot}.${page}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id != '') as value_0, service_corpsite, robot, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_corpsite}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_corpsite, robot, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_corpsite != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'yandexmarketgroup.ru', 'corpsite_desktop' , 'undefined_service' ) as service_corpsite, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
) ORDER BY cnt DESC
```

