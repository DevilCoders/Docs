# market/nginx2/market_front_unified_b2b_fapi_nginx2
    
## Common properties

  * **Owner:** `marketfrontend`
  * **Table:** `nginx2`

## Splits

```json
{
    "service_b2b_fapi": "multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' )",
    "code": "arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)])",
    "buckets_ttlb": "if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms))))",
    "buckets_req_time": "if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms))))",
    "buckets_handshake": "if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms)))",
    "buckets_bytes_send": "if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent))))",
    "dc": "multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' )",
    "host": "host",
    "requester": "multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\\\)|MSRBOT \\\\(http://research\\\\.microsoft\\\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\\\.com|Refer\\\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in')",
    "robot": "replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\\\)|MSRBOT \\\\(http://research\\\\.microsoft\\\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\\\.com|Refer\\\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '')",
    "resource-type": "if(dynamic = 0 or page_id = '', 'static', 'dynamic')",
    "page": "replaceAll(page_id, ':', '_')",
    "resolver": "replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_')"
}
```

## Filters

```json
[
    "environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service'",
    "environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != ''",
    "environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != ''",
    "environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')",
    "environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id != ''",
    "environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')"
]
```

## Resulting metrics

  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.page.splits.${dc}.${page}.${code}.metrics.bytes_send.quantiles`](#599710b3dbefe8c17847a36b2441eea5)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.page.splits.${dc}.${page}.${code}.metrics.handshake.quantiles`](#9b52f6e64849e9b5560d542a0976269a)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.page.splits.${dc}.${page}.${code}.metrics.req_time.quantiles`](#e7b3bdae64e0c3d7e27d13cf232900af)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.page.splits.${dc}.${page}.${code}.metrics.rps`](#4fdec6c58d9605495167175aa9cffceb)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.page.splits.${dc}.${page}.${code}.metrics.ttlb.quantiles`](#b6ef8174f40900c5518654dac1e8aba3)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.bytes_send.quantiles`](#e45bb241b593cac63a864068af4dcdb8)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.handshake.quantiles`](#b4a774016681a2f3cebd54431a00380d)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.req_time.quantiles`](#47aad79f5c5ef303baafee0f28dedaa4)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.rps`](#7abcfff928f6837a96e937ebbe4cb7f3)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.ttlb.quantiles`](#fab47c5363da579cb49a08cb176a5cdc)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.splits.${dc}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}`](#47791622b00278f90094992bf5530014)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.splits.${dc}.${code}.metrics.bytes_send.quantiles`](#d7eb50c0842b1509ba7bbf3aeb5c06f9)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.splits.${dc}.${code}.metrics.handshake.buckets.${buckets_handshake}`](#a37b4e9ac95f979d05beba3d441e40d2)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.splits.${dc}.${code}.metrics.handshake.quantiles`](#639c280e852f0986888c7c5f81706e2a)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.splits.${dc}.${code}.metrics.req_time.buckets.${buckets_req_time}`](#72da6853d8c63bf376621ec6fd7c82dc)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.splits.${dc}.${code}.metrics.req_time.quantiles`](#132dd939b5bef01012dd3cfc8f35861e)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.splits.${dc}.${code}.metrics.rps`](#715b75ee2e195dea58342467c50fc0fa)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.splits.${dc}.${code}.metrics.ttlb.buckets.${buckets_ttlb}`](#7110cbbf2d61e687c55c7997541585f2)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.splits.${dc}.${code}.metrics.ttlb.quantiles`](#f94ae9fca43e9180ddf5f0be141d1899)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.host.page.splits.${host}.${page}.${code}.metrics.bytes_send.quantiles`](#434da0727a0c89b998731f287d6954ee)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.host.page.splits.${host}.${page}.${code}.metrics.handshake.quantiles`](#f438ad8316373922030b2d82f2db49ef)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.host.page.splits.${host}.${page}.${code}.metrics.req_time.quantiles`](#4ae4764c66887f1f8e5646d3413949e9)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.host.page.splits.${host}.${page}.${code}.metrics.rps`](#3b819503ee25a530a7f5f14f8e39dd6e)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.host.page.splits.${host}.${page}.${code}.metrics.ttlb.quantiles`](#cd5815c8f1d490054795b656e07bb5f3)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.host.resolver.splits.${host}.${resolver}.${code}.metrics.bytes_send.quantiles`](#962123c89e7b4493514663ecddc1756b)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.host.resolver.splits.${host}.${resolver}.${code}.metrics.handshake.quantiles`](#38dd9324b9de37bc76a2f5ea48867e37)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.host.resolver.splits.${host}.${resolver}.${code}.metrics.req_time.quantiles`](#7be717f0e9aedf7efc423f3c666b7f82)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.host.resolver.splits.${host}.${resolver}.${code}.metrics.rps`](#a7c848ad061b428c236f25acf06b966f)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.host.resolver.splits.${host}.${resolver}.${code}.metrics.ttlb.quantiles`](#252fd923b6c718ed62d5c791e2d4bd10)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.host.splits.${host}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}`](#7dab60dde742b148f0db289aa2c46ed5)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.host.splits.${host}.${code}.metrics.bytes_send.quantiles`](#5194fb70c19375a618f782ed4761c0bc)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.host.splits.${host}.${code}.metrics.handshake.buckets.${buckets_handshake}`](#fdc2fd4bff120f42652814d8b02414f9)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.host.splits.${host}.${code}.metrics.handshake.quantiles`](#ad175b6fa085b6bbc096853cd6f8c343)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.host.splits.${host}.${code}.metrics.req_time.buckets.${buckets_req_time}`](#e6047e93f232b82c438da6a9621deebc)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.host.splits.${host}.${code}.metrics.req_time.quantiles`](#09a2c51e5c6a84be8042f0b33af67f2f)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.host.splits.${host}.${code}.metrics.rps`](#e836d86c0067c13cf6cd22c0fd9f6a4b)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.host.splits.${host}.${code}.metrics.ttlb.buckets.${buckets_ttlb}`](#91f145e60d41ec65f089dd4ed12adb8d)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.host.splits.${host}.${code}.metrics.ttlb.quantiles`](#9a0ded3a25df21a03665a6226dabcc2e)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.page.splits.${page}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}`](#bf535f2f7c402a509c58c6443ff82b0d)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.page.splits.${page}.${code}.metrics.bytes_send.quantiles`](#41400547a12e544ba8a09e50c4a24df4)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.page.splits.${page}.${code}.metrics.handshake.buckets.${buckets_handshake}`](#9d4a44aa73f6075cdab11eb99d3ad71b)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.page.splits.${page}.${code}.metrics.handshake.quantiles`](#c232aa39b224dc34deadffc8d9060ddf)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.page.splits.${page}.${code}.metrics.req_time.buckets.${buckets_req_time}`](#1db3a8e50e30f1770d5a8302b41109b9)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.page.splits.${page}.${code}.metrics.req_time.quantiles`](#e4a3d2fce775d22ad0f8ecd0579b76ec)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.page.splits.${page}.${code}.metrics.rps`](#45557b2ebe50bf00f745d7d13c5e2999)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.page.splits.${page}.${code}.metrics.ttlb.buckets.${buckets_ttlb}`](#77eec70142a20e5f1191163bea674dab)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.page.splits.${page}.${code}.metrics.ttlb.quantiles`](#efc3006c731eebf4d79734e089c8923c)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.dc.splits.${requester}.${dc}.${code}.metrics.bytes_send.quantiles`](#11f9ef23a50a0236e06fa5695cc51387)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.dc.splits.${requester}.${dc}.${code}.metrics.handshake.quantiles`](#d11f006bfe9b7ba662d791056a4ec719)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.dc.splits.${requester}.${dc}.${code}.metrics.req_time.quantiles`](#c09f18d4fcf946a4c6e193a92c23833d)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.dc.splits.${requester}.${dc}.${code}.metrics.rps`](#b76d0c293a0d481e17b7e94f90125bc9)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.dc.splits.${requester}.${dc}.${code}.metrics.ttlb.quantiles`](#3f6b6af44a5bc3a53e56c64669829d3c)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.host.splits.${requester}.${host}.${code}.metrics.bytes_send.quantiles`](#0ea726b582b2e3231a32ecd34ff62091)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.host.splits.${requester}.${host}.${code}.metrics.handshake.quantiles`](#caa6b5f734ffa48c4d1d95e389133217)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.host.splits.${requester}.${host}.${code}.metrics.req_time.quantiles`](#e224fa0c3e5e5835ce2bd964136bd4b8)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.host.splits.${requester}.${host}.${code}.metrics.rps`](#46f633f185ac6d36e06757d54331741e)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.host.splits.${requester}.${host}.${code}.metrics.ttlb.quantiles`](#8c5c8ecc67a124d18bd5ae062f6fd5af)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.page.splits.${requester}.${page}.${code}.metrics.bytes_send.quantiles`](#a15ff7397849bea6f603c727de90552e)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.page.splits.${requester}.${page}.${code}.metrics.handshake.quantiles`](#263d7bc07c25fe5f35705d14e85dfcf9)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.page.splits.${requester}.${page}.${code}.metrics.req_time.quantiles`](#f56fd20f8f1dd3916a0aad20cd51b3da)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.page.splits.${requester}.${page}.${code}.metrics.rps`](#af12b583223185e2d0b8e654b6ad2ecc)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.page.splits.${requester}.${page}.${code}.metrics.ttlb.quantiles`](#b18f23047f3ba08f976d32d9084c04be)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.bytes_send.quantiles`](#e5db9badcb5db5278cf89f959c07ee8d)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.handshake.quantiles`](#3307535bb7032f19abc9cd3c7bb200f9)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.req_time.quantiles`](#392ec5b04d713778b4e264acf4c400e3)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.rps`](#98f7db77ae0ef9319be04a30bf656d9e)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.ttlb.quantiles`](#327c772b28e7847c9176ae5462f2e0c3)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.bytes_send.quantiles`](#284321e392696fa7fa0140145719bc1a)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.handshake.quantiles`](#ba6ef6ebe8294c810132006e0cbf843b)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.req_time.quantiles`](#6b35558baa379023d36bf48953c20cc9)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.rps`](#e777b0f11d8c2bd82f595fca65a6db03)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.ttlb.quantiles`](#167c1ea63e0c10194ed684eed01efaf8)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.splits.${requester}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}`](#fe24987cb97b605fd8252a51e240576d)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.splits.${requester}.${code}.metrics.bytes_send.quantiles`](#1ea165e11b6635283e71926deb209142)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.splits.${requester}.${code}.metrics.handshake.buckets.${buckets_handshake}`](#faececb576dc70e1c86e07691f0e83dc)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.splits.${requester}.${code}.metrics.handshake.quantiles`](#785b74e4db13f7e9cfde7e2b594a6160)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.splits.${requester}.${code}.metrics.req_time.buckets.${buckets_req_time}`](#1e238edb136d6bfd07c3c898754063a0)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.splits.${requester}.${code}.metrics.req_time.quantiles`](#8213810b2e8b292c02689ae7c843c2b5)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.splits.${requester}.${code}.metrics.rps`](#ba3ee150465fc47fabf03190a8ba5e6e)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.splits.${requester}.${code}.metrics.ttlb.buckets.${buckets_ttlb}`](#bc50a44a03c85258ced1fb821245f396)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.splits.${requester}.${code}.metrics.ttlb.quantiles`](#a442b5b4f323afe1284ca335bd949250)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.resolver.splits.${resolver}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}`](#3d165cbb1731b7052395be760735005c)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.resolver.splits.${resolver}.${code}.metrics.bytes_send.quantiles`](#48f446670e62fb3e9ea5c5d8a63ef8a0)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.resolver.splits.${resolver}.${code}.metrics.handshake.buckets.${buckets_handshake}`](#5654709021e0276b9b272b5422525956)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.resolver.splits.${resolver}.${code}.metrics.handshake.quantiles`](#8837a3aa237f160498ed22fcae190fad)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.resolver.splits.${resolver}.${code}.metrics.req_time.buckets.${buckets_req_time}`](#6912486c621762f452f7357a05c07717)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.resolver.splits.${resolver}.${code}.metrics.req_time.quantiles`](#fae6a3e5f15ff2a9ebc7588287fdc787)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.resolver.splits.${resolver}.${code}.metrics.rps`](#f48b02fe1c84b7c8c32b62d1e531ee6a)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.resolver.splits.${resolver}.${code}.metrics.ttlb.buckets.${buckets_ttlb}`](#0b190655df44630497a85a4d8a3258d2)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.resolver.splits.${resolver}.${code}.metrics.ttlb.quantiles`](#37829ca9785d1ada3496630331275d08)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.resourceType.splits.${resource-type}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}`](#b8a71ca456b202a1730ed5c922b82776)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.resourceType.splits.${resource-type}.${code}.metrics.bytes_send.quantiles`](#d60f08dd55f00ca415d8aa8c61376db0)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.resourceType.splits.${resource-type}.${code}.metrics.handshake.buckets.${buckets_handshake}`](#974ad84f1bf7d78e5876f86dc9e5a66a)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.resourceType.splits.${resource-type}.${code}.metrics.handshake.quantiles`](#da086de050e34a48c18b06620a3bfdaf)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.resourceType.splits.${resource-type}.${code}.metrics.req_time.buckets.${buckets_req_time}`](#50ee7de4faff2d914ec15ffd0fb1c894)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.resourceType.splits.${resource-type}.${code}.metrics.req_time.quantiles`](#3ed1011886c831aa79536d0d97659ca5)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.resourceType.splits.${resource-type}.${code}.metrics.rps`](#7dccc86bce67c96871a730d4bfe5b83e)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.resourceType.splits.${resource-type}.${code}.metrics.ttlb.buckets.${buckets_ttlb}`](#8113e69bf9a4c7d9b9119f450628e2b9)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.resourceType.splits.${resource-type}.${code}.metrics.ttlb.quantiles`](#158aecb38d4db21e734439b5acdd390d)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.dc.splits.${robot}.${dc}.${code}.metrics.bytes_send.quantiles`](#10014b99cbdec722de4f033e67c9a038)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.dc.splits.${robot}.${dc}.${code}.metrics.handshake.quantiles`](#4822061a5a922ea6b47c3bcd76e1260d)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.dc.splits.${robot}.${dc}.${code}.metrics.req_time.quantiles`](#f53f9c693ddc376a62062e7a97748b7e)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.dc.splits.${robot}.${dc}.${code}.metrics.rps`](#3db46b7465675b2ba6486cfed57ea850)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.dc.splits.${robot}.${dc}.${code}.metrics.ttlb.quantiles`](#5316ed5fd696675689ac148a883376c1)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.host.splits.${robot}.${host}.${code}.metrics.bytes_send.quantiles`](#7806c3797210e2ca85a106e1f08a7ede)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.host.splits.${robot}.${host}.${code}.metrics.handshake.quantiles`](#f1bc4fc30e6a10178212eb3822df67df)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.host.splits.${robot}.${host}.${code}.metrics.req_time.quantiles`](#93e19a7822b8284217673520cae0888f)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.host.splits.${robot}.${host}.${code}.metrics.rps`](#c5cb16593df6223fc797f12411b8bd64)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.host.splits.${robot}.${host}.${code}.metrics.ttlb.quantiles`](#f5aa277f919a7cd13926163336649548)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.page.splits.${robot}.${page}.${code}.metrics.bytes_send.quantiles`](#b7de8eb0929e4b59bdebc5577f3fb854)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.page.splits.${robot}.${page}.${code}.metrics.handshake.quantiles`](#d56db093966ca35d3958f49cf76218d5)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.page.splits.${robot}.${page}.${code}.metrics.req_time.quantiles`](#e3de3a63831a38ba0d97c76fcc4546a7)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.page.splits.${robot}.${page}.${code}.metrics.rps`](#5b756dc64a9a799d68c04ba85bdcf8c8)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.page.splits.${robot}.${page}.${code}.metrics.ttlb.quantiles`](#4ba7b265a3b37b539b383bf8e45a7480)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.bytes_send.quantiles`](#bb94edcd8d47c0a43966f1e1446b8595)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.handshake.quantiles`](#c18f01c8877548775efb91c5bacd66f2)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.req_time.quantiles`](#b3c343face2c11f1c6e30723983ebbb8)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.rps`](#ebcac1e25dfd5eca41b62b80bd3e3cf2)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.ttlb.quantiles`](#b181723df070a08ae67de02c4ed2b182)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.bytes_send.quantiles`](#12fe49158d08abb36455f57424627fdf)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.handshake.quantiles`](#9eada12da983e6a5247b6a99efd5b1c3)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.req_time.quantiles`](#d0ca6daaecb4f7ac2bfbdb555ad7efb8)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.rps`](#7ccb0baf109ca6a76f3147677d8fc6f1)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.ttlb.quantiles`](#c7a80e7016df08de513e1d6c60285b78)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.splits.${robot}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}`](#5820541071552c5d826f4298c0f8f417)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.splits.${robot}.${code}.metrics.bytes_send.quantiles`](#7f8ac0082606a186b4e76ac1bd0b3e55)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.splits.${robot}.${code}.metrics.handshake.buckets.${buckets_handshake}`](#3e0a687947953baa71678d0d5a64c1aa)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.splits.${robot}.${code}.metrics.handshake.quantiles`](#aef3b40160f4c35495954e145974a870)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.splits.${robot}.${code}.metrics.req_time.buckets.${buckets_req_time}`](#6ee973a3c4f43e9e36cc2c01467f9efb)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.splits.${robot}.${code}.metrics.req_time.quantiles`](#89bdb55dee66fed935a090e305fb0119)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.splits.${robot}.${code}.metrics.rps`](#bbd394120837b98962f33b85f1ff21e3)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.splits.${robot}.${code}.metrics.ttlb.buckets.${buckets_ttlb}`](#167dd8809cf41686145b3125c26d286c)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.splits.${robot}.${code}.metrics.ttlb.quantiles`](#734ebb279ea8e959c349e554a262254e)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.total.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}`](#75dd225b2cd8f10722ca75c8a0b16684)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.total.${code}.metrics.bytes_send.quantiles`](#6718735d3b5bb0be651ccaf627d849c6)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.total.${code}.metrics.handshake.buckets.${buckets_handshake}`](#4da7553f15a2456f077bc8ee22bf0f86)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.total.${code}.metrics.handshake.quantiles`](#c44f45da0783140a3cb2a2cdaf048cc8)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.total.${code}.metrics.req_time.buckets.${buckets_req_time}`](#ee544829585b88b4f12e4f993781b59b)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.total.${code}.metrics.req_time.quantiles`](#7f5ad8b8548999df58f49a58d6a44a9a)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.total.${code}.metrics.rps`](#63eaef9ffb2e62755491cc5224fad331)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.total.${code}.metrics.ttlb.buckets.${buckets_ttlb}`](#a1aefc1d4b824073d55d136031c11020)
  * [`market-front-unified.nginx2.v2.${service_b2b_fapi}.total.${code}.metrics.ttlb.quantiles`](#bc7eb37d607ab3b8f2ec7f24aef3a4bf)

## Metrics

#### <a id='63eaef9ffb2e62755491cc5224fad331'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.total.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.total.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.total.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='a1aefc1d4b824073d55d136031c11020'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.total.${code}.metrics.ttlb.buckets.${buckets_ttlb}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_ttlb%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    code,
    buckets_ttlb

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.total.%24%7Bcode%7D.metrics.ttlb.buckets.%24%7Bbuckets_ttlb%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_ttlb%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.total.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        code,
        buckets_ttlb
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='ee544829585b88b4f12e4f993781b59b'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.total.${code}.metrics.req_time.buckets.${buckets_req_time}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_req_time%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    code,
    buckets_req_time

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.total.%24%7Bcode%7D.metrics.req_time.buckets.%24%7Bbuckets_req_time%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_req_time%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.total.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        code,
        buckets_req_time
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='4da7553f15a2456f077bc8ee22bf0f86'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.total.${code}.metrics.handshake.buckets.${buckets_handshake}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_handshake%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    code,
    buckets_handshake

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.total.%24%7Bcode%7D.metrics.handshake.buckets.%24%7Bbuckets_handshake%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_handshake%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.total.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        code,
        buckets_handshake
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='75dd225b2cd8f10722ca75c8a0b16684'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.total.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_bytes_send%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    code,
    buckets_bytes_send

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.total.%24%7Bcode%7D.metrics.bytes_send.buckets.%24%7Bbuckets_bytes_send%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_bytes_send%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.total.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        code,
        buckets_bytes_send
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='715b75ee2e195dea58342467c50fc0fa'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.splits.${dc}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.dc.splits.%24%7Bdc%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.splits.${dc}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='7110cbbf2d61e687c55c7997541585f2'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.splits.${dc}.${code}.metrics.ttlb.buckets.${buckets_ttlb}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_ttlb%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    dc,
    code,
    buckets_ttlb

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.dc.splits.%24%7Bdc%7D.%24%7Bcode%7D.metrics.ttlb.buckets.%24%7Bbuckets_ttlb%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_ttlb%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.splits.${dc}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        dc,
        code,
        buckets_ttlb
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='72da6853d8c63bf376621ec6fd7c82dc'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.splits.${dc}.${code}.metrics.req_time.buckets.${buckets_req_time}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_req_time%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    dc,
    code,
    buckets_req_time

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.dc.splits.%24%7Bdc%7D.%24%7Bcode%7D.metrics.req_time.buckets.%24%7Bbuckets_req_time%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_req_time%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.splits.${dc}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        dc,
        code,
        buckets_req_time
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='a37b4e9ac95f979d05beba3d441e40d2'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.splits.${dc}.${code}.metrics.handshake.buckets.${buckets_handshake}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_handshake%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    dc,
    code,
    buckets_handshake

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.dc.splits.%24%7Bdc%7D.%24%7Bcode%7D.metrics.handshake.buckets.%24%7Bbuckets_handshake%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_handshake%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.splits.${dc}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        dc,
        code,
        buckets_handshake
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='47791622b00278f90094992bf5530014'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.splits.${dc}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_bytes_send%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    dc,
    code,
    buckets_bytes_send

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.dc.splits.%24%7Bdc%7D.%24%7Bcode%7D.metrics.bytes_send.buckets.%24%7Bbuckets_bytes_send%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_bytes_send%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.splits.${dc}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        dc,
        code,
        buckets_bytes_send
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='e836d86c0067c13cf6cd22c0fd9f6a4b'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.host.splits.${host}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.host.splits.%24%7Bhost%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.host.splits.${host}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='91f145e60d41ec65f089dd4ed12adb8d'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.host.splits.${host}.${code}.metrics.ttlb.buckets.${buckets_ttlb}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_ttlb%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    host,
    code,
    buckets_ttlb

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.host.splits.%24%7Bhost%7D.%24%7Bcode%7D.metrics.ttlb.buckets.%24%7Bbuckets_ttlb%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_ttlb%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.host.splits.${host}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        host,
        code,
        buckets_ttlb
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='e6047e93f232b82c438da6a9621deebc'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.host.splits.${host}.${code}.metrics.req_time.buckets.${buckets_req_time}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_req_time%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    host,
    code,
    buckets_req_time

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.host.splits.%24%7Bhost%7D.%24%7Bcode%7D.metrics.req_time.buckets.%24%7Bbuckets_req_time%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_req_time%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.host.splits.${host}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        host,
        code,
        buckets_req_time
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='fdc2fd4bff120f42652814d8b02414f9'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.host.splits.${host}.${code}.metrics.handshake.buckets.${buckets_handshake}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_handshake%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    host,
    code,
    buckets_handshake

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.host.splits.%24%7Bhost%7D.%24%7Bcode%7D.metrics.handshake.buckets.%24%7Bbuckets_handshake%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_handshake%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.host.splits.${host}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        host,
        code,
        buckets_handshake
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='7dab60dde742b148f0db289aa2c46ed5'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.host.splits.${host}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_bytes_send%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    host,
    code,
    buckets_bytes_send

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.host.splits.%24%7Bhost%7D.%24%7Bcode%7D.metrics.bytes_send.buckets.%24%7Bbuckets_bytes_send%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_bytes_send%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.host.splits.${host}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        host,
        code,
        buckets_bytes_send
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='ba3ee150465fc47fabf03190a8ba5e6e'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.splits.${requester}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    requester,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.requester.splits.%24%7Brequester%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.splits.${requester}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        requester,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='bc50a44a03c85258ced1fb821245f396'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.splits.${requester}.${code}.metrics.ttlb.buckets.${buckets_ttlb}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_ttlb%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    requester,
    code,
    buckets_ttlb

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.requester.splits.%24%7Brequester%7D.%24%7Bcode%7D.metrics.ttlb.buckets.%24%7Bbuckets_ttlb%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_ttlb%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.splits.${requester}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        requester,
        code,
        buckets_ttlb
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='1e238edb136d6bfd07c3c898754063a0'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.splits.${requester}.${code}.metrics.req_time.buckets.${buckets_req_time}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_req_time%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    requester,
    code,
    buckets_req_time

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.requester.splits.%24%7Brequester%7D.%24%7Bcode%7D.metrics.req_time.buckets.%24%7Bbuckets_req_time%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_req_time%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.splits.${requester}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        requester,
        code,
        buckets_req_time
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='faececb576dc70e1c86e07691f0e83dc'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.splits.${requester}.${code}.metrics.handshake.buckets.${buckets_handshake}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_handshake%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    requester,
    code,
    buckets_handshake

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.requester.splits.%24%7Brequester%7D.%24%7Bcode%7D.metrics.handshake.buckets.%24%7Bbuckets_handshake%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_handshake%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.splits.${requester}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        requester,
        code,
        buckets_handshake
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='fe24987cb97b605fd8252a51e240576d'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.splits.${requester}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_bytes_send%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    requester,
    code,
    buckets_bytes_send

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.requester.splits.%24%7Brequester%7D.%24%7Bcode%7D.metrics.bytes_send.buckets.%24%7Bbuckets_bytes_send%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_bytes_send%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.splits.${requester}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        requester,
        code,
        buckets_bytes_send
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='7dccc86bce67c96871a730d4bfe5b83e'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.resourceType.splits.${resource-type}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.resourceType.splits.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.resourceType.splits.${resource-type}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='8113e69bf9a4c7d9b9119f450628e2b9'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.resourceType.splits.${resource-type}.${code}.metrics.ttlb.buckets.${buckets_ttlb}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_ttlb%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    resource_type,
    code,
    buckets_ttlb

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.resourceType.splits.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.ttlb.buckets.%24%7Bbuckets_ttlb%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_ttlb%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.resourceType.splits.${resource-type}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        resource_type,
        code,
        buckets_ttlb
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='50ee7de4faff2d914ec15ffd0fb1c894'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.resourceType.splits.${resource-type}.${code}.metrics.req_time.buckets.${buckets_req_time}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_req_time%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    resource_type,
    code,
    buckets_req_time

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.resourceType.splits.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.req_time.buckets.%24%7Bbuckets_req_time%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_req_time%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.resourceType.splits.${resource-type}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        resource_type,
        code,
        buckets_req_time
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='974ad84f1bf7d78e5876f86dc9e5a66a'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.resourceType.splits.${resource-type}.${code}.metrics.handshake.buckets.${buckets_handshake}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_handshake%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    resource_type,
    code,
    buckets_handshake

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.resourceType.splits.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.handshake.buckets.%24%7Bbuckets_handshake%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_handshake%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.resourceType.splits.${resource-type}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        resource_type,
        code,
        buckets_handshake
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='b8a71ca456b202a1730ed5c922b82776'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.resourceType.splits.${resource-type}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_bytes_send%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    resource_type,
    code,
    buckets_bytes_send

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.resourceType.splits.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.bytes_send.buckets.%24%7Bbuckets_bytes_send%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_bytes_send%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.resourceType.splits.${resource-type}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        resource_type,
        code,
        buckets_bytes_send
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='b76d0c293a0d481e17b7e94f90125bc9'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.dc.splits.${requester}.${dc}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    requester,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.requester.dc.splits.%24%7Brequester%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.dc.splits.${requester}.${dc}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        requester,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='46f633f185ac6d36e06757d54331741e'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.host.splits.${requester}.${host}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    requester,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.requester.host.splits.%24%7Brequester%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.host.splits.${requester}.${host}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        requester,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='e777b0f11d8c2bd82f595fca65a6db03'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    requester,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.requester.resourceType.splits.%24%7Brequester%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        requester,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='bbd394120837b98962f33b85f1ff21e3'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.splits.${robot}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    robot,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.robot.splits.%24%7Brobot%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.splits.${robot}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        robot,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='167dd8809cf41686145b3125c26d286c'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.splits.${robot}.${code}.metrics.ttlb.buckets.${buckets_ttlb}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_ttlb%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    robot,
    code,
    buckets_ttlb

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.robot.splits.%24%7Brobot%7D.%24%7Bcode%7D.metrics.ttlb.buckets.%24%7Bbuckets_ttlb%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_ttlb%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.splits.${robot}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        robot,
        code,
        buckets_ttlb
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='6ee973a3c4f43e9e36cc2c01467f9efb'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.splits.${robot}.${code}.metrics.req_time.buckets.${buckets_req_time}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_req_time%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    robot,
    code,
    buckets_req_time

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.robot.splits.%24%7Brobot%7D.%24%7Bcode%7D.metrics.req_time.buckets.%24%7Bbuckets_req_time%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_req_time%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.splits.${robot}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        robot,
        code,
        buckets_req_time
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='3e0a687947953baa71678d0d5a64c1aa'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.splits.${robot}.${code}.metrics.handshake.buckets.${buckets_handshake}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_handshake%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    robot,
    code,
    buckets_handshake

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.robot.splits.%24%7Brobot%7D.%24%7Bcode%7D.metrics.handshake.buckets.%24%7Bbuckets_handshake%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_handshake%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.splits.${robot}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        robot,
        code,
        buckets_handshake
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='5820541071552c5d826f4298c0f8f417'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.splits.${robot}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_bytes_send%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    robot,
    code,
    buckets_bytes_send

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.robot.splits.%24%7Brobot%7D.%24%7Bcode%7D.metrics.bytes_send.buckets.%24%7Bbuckets_bytes_send%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_bytes_send%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.splits.${robot}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        robot,
        code,
        buckets_bytes_send
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='3db46b7465675b2ba6486cfed57ea850'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.dc.splits.${robot}.${dc}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    robot,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.robot.dc.splits.%24%7Brobot%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.dc.splits.${robot}.${dc}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        robot,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='c5cb16593df6223fc797f12411b8bd64'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.host.splits.${robot}.${host}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    robot,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.robot.host.splits.%24%7Brobot%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.host.splits.${robot}.${host}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        robot,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='7ccb0baf109ca6a76f3147677d8fc6f1'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    robot,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.robot.resourceType.splits.%24%7Brobot%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        robot,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='45557b2ebe50bf00f745d7d13c5e2999'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.page.splits.${page}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.page.splits.%24%7Bpage%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.page.splits.${page}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='77eec70142a20e5f1191163bea674dab'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.page.splits.${page}.${code}.metrics.ttlb.buckets.${buckets_ttlb}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_ttlb%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    page,
    code,
    buckets_ttlb

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.page.splits.%24%7Bpage%7D.%24%7Bcode%7D.metrics.ttlb.buckets.%24%7Bbuckets_ttlb%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_ttlb%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.page.splits.${page}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        page,
        code,
        buckets_ttlb
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='1db3a8e50e30f1770d5a8302b41109b9'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.page.splits.${page}.${code}.metrics.req_time.buckets.${buckets_req_time}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_req_time%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    page,
    code,
    buckets_req_time

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.page.splits.%24%7Bpage%7D.%24%7Bcode%7D.metrics.req_time.buckets.%24%7Bbuckets_req_time%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_req_time%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.page.splits.${page}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        page,
        code,
        buckets_req_time
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='9d4a44aa73f6075cdab11eb99d3ad71b'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.page.splits.${page}.${code}.metrics.handshake.buckets.${buckets_handshake}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_handshake%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    page,
    code,
    buckets_handshake

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.page.splits.%24%7Bpage%7D.%24%7Bcode%7D.metrics.handshake.buckets.%24%7Bbuckets_handshake%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_handshake%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.page.splits.${page}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        page,
        code,
        buckets_handshake
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='bf535f2f7c402a509c58c6443ff82b0d'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.page.splits.${page}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_bytes_send%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    page,
    code,
    buckets_bytes_send

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.page.splits.%24%7Bpage%7D.%24%7Bcode%7D.metrics.bytes_send.buckets.%24%7Bbuckets_bytes_send%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_bytes_send%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.page.splits.${page}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        page,
        code,
        buckets_bytes_send
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='4fdec6c58d9605495167175aa9cffceb'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.page.splits.${dc}.${page}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    dc,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.dc.page.splits.%24%7Bdc%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.page.splits.${dc}.${page}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        dc,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='3b819503ee25a530a7f5f14f8e39dd6e'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.host.page.splits.${host}.${page}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20host%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    host,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    host as host,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.host.page.splits.%24%7Bhost%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.host.page.splits.${host}.${page}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        host,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        host as host,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='af12b583223185e2d0b8e654b6ad2ecc'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.page.splits.${requester}.${page}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    requester,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.requester.page.splits.%24%7Brequester%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.page.splits.${requester}.${page}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        requester,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='f48b02fe1c84b7c8c32b62d1e531ee6a'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.resolver.splits.${resolver}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.resolver.splits.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.resolver.splits.${resolver}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='0b190655df44630497a85a4d8a3258d2'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.resolver.splits.${resolver}.${code}.metrics.ttlb.buckets.${buckets_ttlb}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_ttlb%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    resolver,
    code,
    buckets_ttlb

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.resolver.splits.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.ttlb.buckets.%24%7Bbuckets_ttlb%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_ttlb%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.resolver.splits.${resolver}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        resolver,
        code,
        buckets_ttlb
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='6912486c621762f452f7357a05c07717'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.resolver.splits.${resolver}.${code}.metrics.req_time.buckets.${buckets_req_time}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_req_time%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    resolver,
    code,
    buckets_req_time

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.resolver.splits.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.req_time.buckets.%24%7Bbuckets_req_time%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_req_time%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.resolver.splits.${resolver}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        resolver,
        code,
        buckets_req_time
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='5654709021e0276b9b272b5422525956'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.resolver.splits.${resolver}.${code}.metrics.handshake.buckets.${buckets_handshake}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_handshake%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    resolver,
    code,
    buckets_handshake

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.resolver.splits.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.handshake.buckets.%24%7Bbuckets_handshake%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_handshake%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.resolver.splits.${resolver}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        resolver,
        code,
        buckets_handshake
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='3d165cbb1731b7052395be760735005c'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.resolver.splits.${resolver}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_bytes_send%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    resolver,
    code,
    buckets_bytes_send

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.resolver.splits.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.bytes_send.buckets.%24%7Bbuckets_bytes_send%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_bytes_send%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.resolver.splits.${resolver}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        resolver,
        code,
        buckets_bytes_send
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='7abcfff928f6837a96e937ebbe4cb7f3'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    dc,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.dc.resolver.splits.%24%7Bdc%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        dc,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='a7c848ad061b428c236f25acf06b966f'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.host.resolver.splits.${host}.${resolver}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20host%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    host,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    host as host,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.host.resolver.splits.%24%7Bhost%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.host.resolver.splits.${host}.${resolver}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        host,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        host as host,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='98f7db77ae0ef9319be04a30bf656d9e'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    requester,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.requester.resolver.splits.%24%7Brequester%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        requester,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='5b756dc64a9a799d68c04ba85bdcf8c8'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.page.splits.${robot}.${page}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    robot,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.robot.page.splits.%24%7Brobot%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.page.splits.${robot}.${page}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        robot,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='ebcac1e25dfd5eca41b62b80bd3e3cf2'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_b2b_fapi,
    robot,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.robot.resolver.splits.%24%7Brobot%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_b2b_fapi,
        robot,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='bc7eb37d607ab3b8f2ec7f24aef3a4bf'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.total.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
    service_b2b_fapi,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.total.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.total.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
        service_b2b_fapi,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='f94ae9fca43e9180ddf5f0be141d1899'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.splits.${dc}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
    service_b2b_fapi,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.dc.splits.%24%7Bdc%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.splits.${dc}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
        service_b2b_fapi,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='9a0ded3a25df21a03665a6226dabcc2e'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.host.splits.${host}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
    service_b2b_fapi,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.host.splits.%24%7Bhost%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.host.splits.${host}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
        service_b2b_fapi,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='a442b5b4f323afe1284ca335bd949250'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.splits.${requester}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
    service_b2b_fapi,
    requester,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.requester.splits.%24%7Brequester%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.splits.${requester}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
        service_b2b_fapi,
        requester,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='158aecb38d4db21e734439b5acdd390d'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.resourceType.splits.${resource-type}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
    service_b2b_fapi,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.resourceType.splits.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.resourceType.splits.${resource-type}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
        service_b2b_fapi,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='3f6b6af44a5bc3a53e56c64669829d3c'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.dc.splits.${requester}.${dc}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
    service_b2b_fapi,
    requester,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.requester.dc.splits.%24%7Brequester%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.dc.splits.${requester}.${dc}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
        service_b2b_fapi,
        requester,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='8c5c8ecc67a124d18bd5ae062f6fd5af'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.host.splits.${requester}.${host}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
    service_b2b_fapi,
    requester,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.requester.host.splits.%24%7Brequester%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.host.splits.${requester}.${host}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
        service_b2b_fapi,
        requester,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='167c1ea63e0c10194ed684eed01efaf8'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
    service_b2b_fapi,
    requester,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.requester.resourceType.splits.%24%7Brequester%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
        service_b2b_fapi,
        requester,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='734ebb279ea8e959c349e554a262254e'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.splits.${robot}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0,
    service_b2b_fapi,
    robot,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.robot.splits.%24%7Brobot%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.splits.${robot}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0,
        service_b2b_fapi,
        robot,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='5316ed5fd696675689ac148a883376c1'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.dc.splits.${robot}.${dc}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0,
    service_b2b_fapi,
    robot,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.robot.dc.splits.%24%7Brobot%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.dc.splits.${robot}.${dc}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0,
        service_b2b_fapi,
        robot,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='f5aa277f919a7cd13926163336649548'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.host.splits.${robot}.${host}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0,
    service_b2b_fapi,
    robot,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.robot.host.splits.%24%7Brobot%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.host.splits.${robot}.${host}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0,
        service_b2b_fapi,
        robot,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='c7a80e7016df08de513e1d6c60285b78'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0,
    service_b2b_fapi,
    robot,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.robot.resourceType.splits.%24%7Brobot%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0,
        service_b2b_fapi,
        robot,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='efc3006c731eebf4d79734e089c8923c'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.page.splits.${page}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0,
    service_b2b_fapi,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.page.splits.%24%7Bpage%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.page.splits.${page}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0,
        service_b2b_fapi,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='b6ef8174f40900c5518654dac1e8aba3'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.page.splits.${dc}.${page}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0,
    service_b2b_fapi,
    dc,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.dc.page.splits.%24%7Bdc%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.page.splits.${dc}.${page}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0,
        service_b2b_fapi,
        dc,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='cd5815c8f1d490054795b656e07bb5f3'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.host.page.splits.${host}.${page}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20host%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0,
    service_b2b_fapi,
    host,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    host as host,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.host.page.splits.%24%7Bhost%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.host.page.splits.${host}.${page}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0,
        service_b2b_fapi,
        host,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        host as host,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='b18f23047f3ba08f976d32d9084c04be'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.page.splits.${requester}.${page}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0,
    service_b2b_fapi,
    requester,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.requester.page.splits.%24%7Brequester%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.page.splits.${requester}.${page}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0,
        service_b2b_fapi,
        requester,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='37829ca9785d1ada3496630331275d08'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.resolver.splits.${resolver}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_b2b_fapi,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.resolver.splits.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.resolver.splits.${resolver}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_b2b_fapi,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='fab47c5363da579cb49a08cb176a5cdc'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_b2b_fapi,
    dc,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.dc.resolver.splits.%24%7Bdc%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_b2b_fapi,
        dc,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='252fd923b6c718ed62d5c791e2d4bd10'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.host.resolver.splits.${host}.${resolver}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20host%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_b2b_fapi,
    host,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    host as host,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.host.resolver.splits.%24%7Bhost%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.host.resolver.splits.${host}.${resolver}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_b2b_fapi,
        host,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        host as host,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='327c772b28e7847c9176ae5462f2e0c3'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_b2b_fapi,
    requester,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.requester.resolver.splits.%24%7Brequester%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_b2b_fapi,
        requester,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='4ba7b265a3b37b539b383bf8e45a7480'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.page.splits.${robot}.${page}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id != '') as value_0,
    service_b2b_fapi,
    robot,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.robot.page.splits.%24%7Brobot%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.page.splits.${robot}.${page}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id != '') as value_0,
        service_b2b_fapi,
        robot,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='b181723df070a08ae67de02c4ed2b182'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_b2b_fapi,
    robot,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.robot.resolver.splits.%24%7Brobot%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_b2b_fapi,
        robot,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='7f5ad8b8548999df58f49a58d6a44a9a'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.total.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
    service_b2b_fapi,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.total.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.total.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
        service_b2b_fapi,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='132dd939b5bef01012dd3cfc8f35861e'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.splits.${dc}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
    service_b2b_fapi,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.dc.splits.%24%7Bdc%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.splits.${dc}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
        service_b2b_fapi,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='09a2c51e5c6a84be8042f0b33af67f2f'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.host.splits.${host}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
    service_b2b_fapi,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.host.splits.%24%7Bhost%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.host.splits.${host}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
        service_b2b_fapi,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='8213810b2e8b292c02689ae7c843c2b5'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.splits.${requester}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
    service_b2b_fapi,
    requester,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.requester.splits.%24%7Brequester%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.splits.${requester}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
        service_b2b_fapi,
        requester,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='3ed1011886c831aa79536d0d97659ca5'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.resourceType.splits.${resource-type}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
    service_b2b_fapi,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.resourceType.splits.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.resourceType.splits.${resource-type}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
        service_b2b_fapi,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='c09f18d4fcf946a4c6e193a92c23833d'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.dc.splits.${requester}.${dc}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
    service_b2b_fapi,
    requester,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.requester.dc.splits.%24%7Brequester%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.dc.splits.${requester}.${dc}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
        service_b2b_fapi,
        requester,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='e224fa0c3e5e5835ce2bd964136bd4b8'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.host.splits.${requester}.${host}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
    service_b2b_fapi,
    requester,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.requester.host.splits.%24%7Brequester%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.host.splits.${requester}.${host}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
        service_b2b_fapi,
        requester,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='6b35558baa379023d36bf48953c20cc9'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
    service_b2b_fapi,
    requester,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.requester.resourceType.splits.%24%7Brequester%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
        service_b2b_fapi,
        requester,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='89bdb55dee66fed935a090e305fb0119'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.splits.${robot}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0,
    service_b2b_fapi,
    robot,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.robot.splits.%24%7Brobot%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.splits.${robot}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0,
        service_b2b_fapi,
        robot,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='f53f9c693ddc376a62062e7a97748b7e'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.dc.splits.${robot}.${dc}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0,
    service_b2b_fapi,
    robot,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.robot.dc.splits.%24%7Brobot%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.dc.splits.${robot}.${dc}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0,
        service_b2b_fapi,
        robot,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='93e19a7822b8284217673520cae0888f'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.host.splits.${robot}.${host}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0,
    service_b2b_fapi,
    robot,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.robot.host.splits.%24%7Brobot%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.host.splits.${robot}.${host}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0,
        service_b2b_fapi,
        robot,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='d0ca6daaecb4f7ac2bfbdb555ad7efb8'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0,
    service_b2b_fapi,
    robot,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.robot.resourceType.splits.%24%7Brobot%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0,
        service_b2b_fapi,
        robot,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='e4a3d2fce775d22ad0f8ecd0579b76ec'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.page.splits.${page}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0,
    service_b2b_fapi,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.page.splits.%24%7Bpage%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.page.splits.${page}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0,
        service_b2b_fapi,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='e7b3bdae64e0c3d7e27d13cf232900af'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.page.splits.${dc}.${page}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0,
    service_b2b_fapi,
    dc,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.dc.page.splits.%24%7Bdc%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.page.splits.${dc}.${page}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0,
        service_b2b_fapi,
        dc,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='4ae4764c66887f1f8e5646d3413949e9'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.host.page.splits.${host}.${page}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20host%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0,
    service_b2b_fapi,
    host,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    host as host,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.host.page.splits.%24%7Bhost%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.host.page.splits.${host}.${page}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0,
        service_b2b_fapi,
        host,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        host as host,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='f56fd20f8f1dd3916a0aad20cd51b3da'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.page.splits.${requester}.${page}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0,
    service_b2b_fapi,
    requester,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.requester.page.splits.%24%7Brequester%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.page.splits.${requester}.${page}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0,
        service_b2b_fapi,
        requester,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='fae6a3e5f15ff2a9ebc7588287fdc787'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.resolver.splits.${resolver}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_b2b_fapi,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.resolver.splits.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.resolver.splits.${resolver}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_b2b_fapi,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='47aad79f5c5ef303baafee0f28dedaa4'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_b2b_fapi,
    dc,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.dc.resolver.splits.%24%7Bdc%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_b2b_fapi,
        dc,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='7be717f0e9aedf7efc423f3c666b7f82'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.host.resolver.splits.${host}.${resolver}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20host%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_b2b_fapi,
    host,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    host as host,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.host.resolver.splits.%24%7Bhost%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.host.resolver.splits.${host}.${resolver}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_b2b_fapi,
        host,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        host as host,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='392ec5b04d713778b4e264acf4c400e3'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_b2b_fapi,
    requester,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.requester.resolver.splits.%24%7Brequester%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_b2b_fapi,
        requester,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='e3de3a63831a38ba0d97c76fcc4546a7'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.page.splits.${robot}.${page}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id != '') as value_0,
    service_b2b_fapi,
    robot,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.robot.page.splits.%24%7Brobot%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.page.splits.${robot}.${page}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id != '') as value_0,
        service_b2b_fapi,
        robot,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='b3c343face2c11f1c6e30723983ebbb8'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_b2b_fapi,
    robot,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.robot.resolver.splits.%24%7Brobot%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_b2b_fapi,
        robot,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='c44f45da0783140a3cb2a2cdaf048cc8'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.total.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
    service_b2b_fapi,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.total.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.total.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
        service_b2b_fapi,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='639c280e852f0986888c7c5f81706e2a'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.splits.${dc}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
    service_b2b_fapi,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.dc.splits.%24%7Bdc%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.splits.${dc}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
        service_b2b_fapi,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='ad175b6fa085b6bbc096853cd6f8c343'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.host.splits.${host}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
    service_b2b_fapi,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.host.splits.%24%7Bhost%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.host.splits.${host}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
        service_b2b_fapi,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='785b74e4db13f7e9cfde7e2b594a6160'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.splits.${requester}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
    service_b2b_fapi,
    requester,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.requester.splits.%24%7Brequester%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.splits.${requester}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
        service_b2b_fapi,
        requester,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='da086de050e34a48c18b06620a3bfdaf'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.resourceType.splits.${resource-type}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
    service_b2b_fapi,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.resourceType.splits.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.resourceType.splits.${resource-type}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
        service_b2b_fapi,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='d11f006bfe9b7ba662d791056a4ec719'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.dc.splits.${requester}.${dc}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
    service_b2b_fapi,
    requester,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.requester.dc.splits.%24%7Brequester%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.dc.splits.${requester}.${dc}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
        service_b2b_fapi,
        requester,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='caa6b5f734ffa48c4d1d95e389133217'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.host.splits.${requester}.${host}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
    service_b2b_fapi,
    requester,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.requester.host.splits.%24%7Brequester%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.host.splits.${requester}.${host}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
        service_b2b_fapi,
        requester,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='ba6ef6ebe8294c810132006e0cbf843b'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
    service_b2b_fapi,
    requester,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.requester.resourceType.splits.%24%7Brequester%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
        service_b2b_fapi,
        requester,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='aef3b40160f4c35495954e145974a870'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.splits.${robot}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0,
    service_b2b_fapi,
    robot,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.robot.splits.%24%7Brobot%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.splits.${robot}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0,
        service_b2b_fapi,
        robot,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='4822061a5a922ea6b47c3bcd76e1260d'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.dc.splits.${robot}.${dc}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0,
    service_b2b_fapi,
    robot,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.robot.dc.splits.%24%7Brobot%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.dc.splits.${robot}.${dc}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0,
        service_b2b_fapi,
        robot,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='f1bc4fc30e6a10178212eb3822df67df'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.host.splits.${robot}.${host}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0,
    service_b2b_fapi,
    robot,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.robot.host.splits.%24%7Brobot%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.host.splits.${robot}.${host}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0,
        service_b2b_fapi,
        robot,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='9eada12da983e6a5247b6a99efd5b1c3'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0,
    service_b2b_fapi,
    robot,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.robot.resourceType.splits.%24%7Brobot%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0,
        service_b2b_fapi,
        robot,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='c232aa39b224dc34deadffc8d9060ddf'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.page.splits.${page}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0,
    service_b2b_fapi,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.page.splits.%24%7Bpage%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.page.splits.${page}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0,
        service_b2b_fapi,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='9b52f6e64849e9b5560d542a0976269a'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.page.splits.${dc}.${page}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0,
    service_b2b_fapi,
    dc,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.dc.page.splits.%24%7Bdc%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.page.splits.${dc}.${page}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0,
        service_b2b_fapi,
        dc,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='f438ad8316373922030b2d82f2db49ef'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.host.page.splits.${host}.${page}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20host%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0,
    service_b2b_fapi,
    host,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    host as host,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.host.page.splits.%24%7Bhost%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.host.page.splits.${host}.${page}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0,
        service_b2b_fapi,
        host,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        host as host,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='263d7bc07c25fe5f35705d14e85dfcf9'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.page.splits.${requester}.${page}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0,
    service_b2b_fapi,
    requester,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.requester.page.splits.%24%7Brequester%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.page.splits.${requester}.${page}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0,
        service_b2b_fapi,
        requester,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='8837a3aa237f160498ed22fcae190fad'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.resolver.splits.${resolver}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_b2b_fapi,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.resolver.splits.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.resolver.splits.${resolver}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_b2b_fapi,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='b4a774016681a2f3cebd54431a00380d'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_b2b_fapi,
    dc,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.dc.resolver.splits.%24%7Bdc%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_b2b_fapi,
        dc,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='38dd9324b9de37bc76a2f5ea48867e37'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.host.resolver.splits.${host}.${resolver}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20host%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_b2b_fapi,
    host,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    host as host,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.host.resolver.splits.%24%7Bhost%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.host.resolver.splits.${host}.${resolver}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_b2b_fapi,
        host,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        host as host,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='3307535bb7032f19abc9cd3c7bb200f9'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_b2b_fapi,
    requester,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.requester.resolver.splits.%24%7Brequester%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_b2b_fapi,
        requester,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='d56db093966ca35d3958f49cf76218d5'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.page.splits.${robot}.${page}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id != '') as value_0,
    service_b2b_fapi,
    robot,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.robot.page.splits.%24%7Brobot%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.page.splits.${robot}.${page}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id != '') as value_0,
        service_b2b_fapi,
        robot,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='c18f01c8877548775efb91c5bacd66f2'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_b2b_fapi,
    robot,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.robot.resolver.splits.%24%7Brobot%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_b2b_fapi,
        robot,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='6718735d3b5bb0be651ccaf627d849c6'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.total.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
    service_b2b_fapi,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.total.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.total.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
        service_b2b_fapi,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='d7eb50c0842b1509ba7bbf3aeb5c06f9'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.splits.${dc}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
    service_b2b_fapi,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.dc.splits.%24%7Bdc%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.splits.${dc}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
        service_b2b_fapi,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='5194fb70c19375a618f782ed4761c0bc'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.host.splits.${host}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
    service_b2b_fapi,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.host.splits.%24%7Bhost%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.host.splits.${host}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
        service_b2b_fapi,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='1ea165e11b6635283e71926deb209142'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.splits.${requester}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
    service_b2b_fapi,
    requester,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.requester.splits.%24%7Brequester%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.splits.${requester}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
        service_b2b_fapi,
        requester,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='d60f08dd55f00ca415d8aa8c61376db0'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.resourceType.splits.${resource-type}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
    service_b2b_fapi,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.resourceType.splits.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.resourceType.splits.${resource-type}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
        service_b2b_fapi,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='11f9ef23a50a0236e06fa5695cc51387'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.dc.splits.${requester}.${dc}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
    service_b2b_fapi,
    requester,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.requester.dc.splits.%24%7Brequester%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.dc.splits.${requester}.${dc}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
        service_b2b_fapi,
        requester,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='0ea726b582b2e3231a32ecd34ff62091'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.host.splits.${requester}.${host}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
    service_b2b_fapi,
    requester,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.requester.host.splits.%24%7Brequester%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.host.splits.${requester}.${host}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
        service_b2b_fapi,
        requester,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='284321e392696fa7fa0140145719bc1a'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
    service_b2b_fapi,
    requester,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.requester.resourceType.splits.%24%7Brequester%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0,
        service_b2b_fapi,
        requester,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='7f8ac0082606a186b4e76ac1bd0b3e55'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.splits.${robot}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0,
    service_b2b_fapi,
    robot,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.robot.splits.%24%7Brobot%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.splits.${robot}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0,
        service_b2b_fapi,
        robot,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='10014b99cbdec722de4f033e67c9a038'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.dc.splits.${robot}.${dc}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0,
    service_b2b_fapi,
    robot,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.robot.dc.splits.%24%7Brobot%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.dc.splits.${robot}.${dc}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0,
        service_b2b_fapi,
        robot,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='7806c3797210e2ca85a106e1f08a7ede'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.host.splits.${robot}.${host}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0,
    service_b2b_fapi,
    robot,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.robot.host.splits.%24%7Brobot%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.host.splits.${robot}.${host}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0,
        service_b2b_fapi,
        robot,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='12fe49158d08abb36455f57424627fdf'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0,
    service_b2b_fapi,
    robot,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.robot.resourceType.splits.%24%7Brobot%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0,
        service_b2b_fapi,
        robot,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='41400547a12e544ba8a09e50c4a24df4'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.page.splits.${page}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0,
    service_b2b_fapi,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.page.splits.%24%7Bpage%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.page.splits.${page}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0,
        service_b2b_fapi,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='599710b3dbefe8c17847a36b2441eea5'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.page.splits.${dc}.${page}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0,
    service_b2b_fapi,
    dc,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.dc.page.splits.%24%7Bdc%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.page.splits.${dc}.${page}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0,
        service_b2b_fapi,
        dc,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='434da0727a0c89b998731f287d6954ee'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.host.page.splits.${host}.${page}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20host%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0,
    service_b2b_fapi,
    host,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    host as host,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.host.page.splits.%24%7Bhost%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.host.page.splits.${host}.${page}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0,
        service_b2b_fapi,
        host,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        host as host,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='a15ff7397849bea6f603c727de90552e'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.page.splits.${requester}.${page}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0,
    service_b2b_fapi,
    requester,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.requester.page.splits.%24%7Brequester%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.page.splits.${requester}.${page}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0,
        service_b2b_fapi,
        requester,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='48f446670e62fb3e9ea5c5d8a63ef8a0'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.resolver.splits.${resolver}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_b2b_fapi,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.resolver.splits.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.resolver.splits.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_b2b_fapi,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='e45bb241b593cac63a864068af4dcdb8'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_b2b_fapi,
    dc,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.dc.resolver.splits.%24%7Bdc%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_b2b_fapi,
        dc,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='962123c89e7b4493514663ecddc1756b'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.host.resolver.splits.${host}.${resolver}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20host%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_b2b_fapi,
    host,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    host as host,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.host.resolver.splits.%24%7Bhost%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.host.resolver.splits.${host}.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_b2b_fapi,
        host,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        host as host,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='e5db9badcb5db5278cf89f959c07ee8d'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_b2b_fapi,
    requester,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.requester.resolver.splits.%24%7Brequester%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_b2b_fapi,
        requester,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='b7de8eb0929e4b59bdebc5577f3fb854'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.page.splits.${robot}.${page}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id != '') as value_0,
    service_b2b_fapi,
    robot,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.robot.page.splits.%24%7Brobot%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.page.splits.${robot}.${page}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id != '') as value_0,
        service_b2b_fapi,
        robot,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='bb94edcd8d47c0a43966f1e1446b8595'></a>market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_b2b_fapi,
    robot,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_b2b_fapi%7D.robot.resolver.splits.%24%7Brobot%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_b2b_fapi%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'b2b-fapi.vs.market.yandex.ru'%2C%20'b2b_fapi'%20%2C%20'undefined_service'%20)%20as%20service_b2b_fapi%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_b2b_fapi,
        robot,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```


## Overall Diagnostics

### Portion #1

```SQL
SELECT * FROM (
    SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.total.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.total.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, code, buckets_ttlb FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.total.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, code, buckets_req_time FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.total.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, code, buckets_handshake FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.total.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, code, buckets_bytes_send FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.splits.${dc}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.splits.${dc}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, dc, code, buckets_ttlb FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.splits.${dc}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, dc, code, buckets_req_time FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.splits.${dc}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, dc, code, buckets_handshake FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.splits.${dc}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, dc, code, buckets_bytes_send FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.host.splits.${host}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.host.splits.${host}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, host, code, buckets_ttlb FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.host.splits.${host}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, host, code, buckets_req_time FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.host.splits.${host}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, host, code, buckets_handshake FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.host.splits.${host}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, host, code, buckets_bytes_send FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.splits.${requester}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, requester, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.splits.${requester}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, requester, code, buckets_ttlb FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.splits.${requester}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, requester, code, buckets_req_time FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.splits.${requester}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, requester, code, buckets_handshake FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.splits.${requester}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, requester, code, buckets_bytes_send FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
) ORDER BY cnt DESC
```
### Portion #2

```SQL
SELECT * FROM (
    SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.resourceType.splits.${resource-type}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.resourceType.splits.${resource-type}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, resource_type, code, buckets_ttlb FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.resourceType.splits.${resource-type}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, resource_type, code, buckets_req_time FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.resourceType.splits.${resource-type}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, resource_type, code, buckets_handshake FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.resourceType.splits.${resource-type}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, resource_type, code, buckets_bytes_send FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.dc.splits.${requester}.${dc}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, requester, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.host.splits.${requester}.${host}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, requester, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, requester, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.splits.${robot}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, robot, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.splits.${robot}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, robot, code, buckets_ttlb FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.splits.${robot}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, robot, code, buckets_req_time FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.splits.${robot}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, robot, code, buckets_handshake FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.splits.${robot}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, robot, code, buckets_bytes_send FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.dc.splits.${robot}.${dc}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, robot, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.host.splits.${robot}.${host}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, robot, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, robot, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.page.splits.${page}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.page.splits.${page}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, page, code, buckets_ttlb FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.page.splits.${page}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, page, code, buckets_req_time FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.page.splits.${page}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, page, code, buckets_handshake FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
) ORDER BY cnt DESC
```
### Portion #3

```SQL
SELECT * FROM (
    SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.page.splits.${page}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, page, code, buckets_bytes_send FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.page.splits.${dc}.${page}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, dc, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.host.page.splits.${host}.${page}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, host, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, host as host, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.page.splits.${requester}.${page}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, requester, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.resolver.splits.${resolver}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.resolver.splits.${resolver}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, resolver, code, buckets_ttlb FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.resolver.splits.${resolver}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, resolver, code, buckets_req_time FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.resolver.splits.${resolver}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, resolver, code, buckets_handshake FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.resolver.splits.${resolver}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, resolver, code, buckets_bytes_send FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, dc, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.host.resolver.splits.${host}.${resolver}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, host, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, host as host, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, requester, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.page.splits.${robot}.${page}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, robot, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_b2b_fapi, robot, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.total.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0, service_b2b_fapi, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.splits.${dc}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0, service_b2b_fapi, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.host.splits.${host}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0, service_b2b_fapi, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.splits.${requester}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0, service_b2b_fapi, requester, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.resourceType.splits.${resource-type}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0, service_b2b_fapi, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.dc.splits.${requester}.${dc}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0, service_b2b_fapi, requester, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
) ORDER BY cnt DESC
```
### Portion #4

```SQL
SELECT * FROM (
    SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.host.splits.${requester}.${host}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0, service_b2b_fapi, requester, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0, service_b2b_fapi, requester, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.splits.${robot}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0, service_b2b_fapi, robot, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.dc.splits.${robot}.${dc}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0, service_b2b_fapi, robot, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.host.splits.${robot}.${host}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0, service_b2b_fapi, robot, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0, service_b2b_fapi, robot, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.page.splits.${page}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0, service_b2b_fapi, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.page.splits.${dc}.${page}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0, service_b2b_fapi, dc, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.host.page.splits.${host}.${page}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0, service_b2b_fapi, host, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, host as host, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.page.splits.${requester}.${page}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0, service_b2b_fapi, requester, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.resolver.splits.${resolver}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_b2b_fapi, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_b2b_fapi, dc, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.host.resolver.splits.${host}.${resolver}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_b2b_fapi, host, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, host as host, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_b2b_fapi, requester, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.page.splits.${robot}.${page}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id != '') as value_0, service_b2b_fapi, robot, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_b2b_fapi, robot, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.total.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0, service_b2b_fapi, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.splits.${dc}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0, service_b2b_fapi, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.host.splits.${host}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0, service_b2b_fapi, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.splits.${requester}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0, service_b2b_fapi, requester, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
) ORDER BY cnt DESC
```
### Portion #5

```SQL
SELECT * FROM (
    SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.resourceType.splits.${resource-type}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0, service_b2b_fapi, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.dc.splits.${requester}.${dc}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0, service_b2b_fapi, requester, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.host.splits.${requester}.${host}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0, service_b2b_fapi, requester, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0, service_b2b_fapi, requester, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.splits.${robot}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0, service_b2b_fapi, robot, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.dc.splits.${robot}.${dc}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0, service_b2b_fapi, robot, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.host.splits.${robot}.${host}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0, service_b2b_fapi, robot, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0, service_b2b_fapi, robot, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.page.splits.${page}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0, service_b2b_fapi, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.page.splits.${dc}.${page}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0, service_b2b_fapi, dc, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.host.page.splits.${host}.${page}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0, service_b2b_fapi, host, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, host as host, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.page.splits.${requester}.${page}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0, service_b2b_fapi, requester, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.resolver.splits.${resolver}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_b2b_fapi, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_b2b_fapi, dc, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.host.resolver.splits.${host}.${resolver}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_b2b_fapi, host, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, host as host, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_b2b_fapi, requester, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.page.splits.${robot}.${page}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id != '') as value_0, service_b2b_fapi, robot, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_b2b_fapi, robot, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.total.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0, service_b2b_fapi, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.splits.${dc}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0, service_b2b_fapi, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
) ORDER BY cnt DESC
```
### Portion #6

```SQL
SELECT * FROM (
    SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.host.splits.${host}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0, service_b2b_fapi, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.splits.${requester}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0, service_b2b_fapi, requester, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.resourceType.splits.${resource-type}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0, service_b2b_fapi, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.dc.splits.${requester}.${dc}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0, service_b2b_fapi, requester, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.host.splits.${requester}.${host}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0, service_b2b_fapi, requester, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0, service_b2b_fapi, requester, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.splits.${robot}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0, service_b2b_fapi, robot, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.dc.splits.${robot}.${dc}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0, service_b2b_fapi, robot, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.host.splits.${robot}.${host}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0, service_b2b_fapi, robot, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0, service_b2b_fapi, robot, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.page.splits.${page}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0, service_b2b_fapi, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.page.splits.${dc}.${page}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0, service_b2b_fapi, dc, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.host.page.splits.${host}.${page}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0, service_b2b_fapi, host, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, host as host, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.page.splits.${requester}.${page}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0, service_b2b_fapi, requester, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.resolver.splits.${resolver}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_b2b_fapi, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_b2b_fapi, dc, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.host.resolver.splits.${host}.${resolver}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_b2b_fapi, host, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, host as host, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_b2b_fapi, requester, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.page.splits.${robot}.${page}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id != '') as value_0, service_b2b_fapi, robot, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_b2b_fapi, robot, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
) ORDER BY cnt DESC
```
### Portion #7

```SQL
SELECT * FROM (
    SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.total.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0, service_b2b_fapi, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.splits.${dc}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0, service_b2b_fapi, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.host.splits.${host}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0, service_b2b_fapi, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.splits.${requester}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0, service_b2b_fapi, requester, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.resourceType.splits.${resource-type}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0, service_b2b_fapi, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.dc.splits.${requester}.${dc}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0, service_b2b_fapi, requester, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.host.splits.${requester}.${host}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0, service_b2b_fapi, requester, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') as value_0, service_b2b_fapi, requester, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.splits.${robot}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0, service_b2b_fapi, robot, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.dc.splits.${robot}.${dc}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0, service_b2b_fapi, robot, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.host.splits.${robot}.${host}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0, service_b2b_fapi, robot, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') as value_0, service_b2b_fapi, robot, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.page.splits.${page}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0, service_b2b_fapi, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.page.splits.${dc}.${page}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0, service_b2b_fapi, dc, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.host.page.splits.${host}.${page}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0, service_b2b_fapi, host, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, host as host, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.page.splits.${requester}.${page}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') as value_0, service_b2b_fapi, requester, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.resolver.splits.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_b2b_fapi, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_b2b_fapi, dc, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.host.resolver.splits.${host}.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_b2b_fapi, host, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, host as host, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_b2b_fapi, requester, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
) ORDER BY cnt DESC
```
### Portion #8

```SQL
SELECT * FROM (
    SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.page.splits.${robot}.${page}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id != '') as value_0, service_b2b_fapi, robot, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_b2b_fapi}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_b2b_fapi, robot, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_b2b_fapi != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'b2b-fapi.vs.market.yandex.ru', 'b2b_fapi' , 'undefined_service' ) as service_b2b_fapi, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
) ORDER BY cnt DESC
```

