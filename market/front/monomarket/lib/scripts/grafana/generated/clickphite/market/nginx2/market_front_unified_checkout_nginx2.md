# market/nginx2/market_front_unified_checkout_nginx2
    
## Common properties

  * **Owner:** `marketfrontend`
  * **Table:** `nginx2`

## Splits

```json
{
    "service_checkout": "multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' )",
    "code": "arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)])",
    "buckets_ttlb": "if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms))))",
    "buckets_req_time": "if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms))))",
    "buckets_handshake": "if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms)))",
    "buckets_bytes_send": "if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent))))",
    "dc": "multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' )",
    "host": "host",
    "requester": "multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\\\)|MSRBOT \\\\(http://research\\\\.microsoft\\\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\\\.com|Refer\\\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in')",
    "robot": "replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\\\)|MSRBOT \\\\(http://research\\\\.microsoft\\\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\\\.com|Refer\\\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '')",
    "resource-type": "if(dynamic = 0 or page_id = '', 'static', 'dynamic')",
    "page": "replaceAll(page_id, ':', '_')",
    "resolver": "replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_')"
}
```

## Filters

```json
[
    "environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service'",
    "environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != ''",
    "environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != ''",
    "environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')",
    "environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id != ''",
    "environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')"
]
```

## Resulting metrics

  * [`market-front-unified.nginx2.v2.${service_checkout}.dc.page.splits.${dc}.${page}.${code}.metrics.bytes_send.quantiles`](#f98403b3bb971f0bf34006c5de14afcd)
  * [`market-front-unified.nginx2.v2.${service_checkout}.dc.page.splits.${dc}.${page}.${code}.metrics.handshake.quantiles`](#c7ae46259f505e702a4d6b53c234fa38)
  * [`market-front-unified.nginx2.v2.${service_checkout}.dc.page.splits.${dc}.${page}.${code}.metrics.req_time.quantiles`](#01a2661f6b32cf72771b3ff3bc74ebb6)
  * [`market-front-unified.nginx2.v2.${service_checkout}.dc.page.splits.${dc}.${page}.${code}.metrics.rps`](#0c3ff0d7bdf75a886b6117b5b929ebfe)
  * [`market-front-unified.nginx2.v2.${service_checkout}.dc.page.splits.${dc}.${page}.${code}.metrics.ttlb.quantiles`](#57b0defe1a6e896f5ed89d9bf49bed4d)
  * [`market-front-unified.nginx2.v2.${service_checkout}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.bytes_send.quantiles`](#76b4e918e651709d76fbb09484b010e8)
  * [`market-front-unified.nginx2.v2.${service_checkout}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.handshake.quantiles`](#49f5f61a1f46a93aca6fdfe39b0a2b05)
  * [`market-front-unified.nginx2.v2.${service_checkout}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.req_time.quantiles`](#48c8a8b26b051b8d2090c69a2438145c)
  * [`market-front-unified.nginx2.v2.${service_checkout}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.rps`](#321831f86d12486a93ae6f01e7b94cfc)
  * [`market-front-unified.nginx2.v2.${service_checkout}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.ttlb.quantiles`](#445c44c68cd742d37cf1d7233ae98836)
  * [`market-front-unified.nginx2.v2.${service_checkout}.dc.splits.${dc}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}`](#959d8c25c35869b302edcfabf746228f)
  * [`market-front-unified.nginx2.v2.${service_checkout}.dc.splits.${dc}.${code}.metrics.bytes_send.quantiles`](#54202ba83c22ac8a4fb5cd29dc7cdcb5)
  * [`market-front-unified.nginx2.v2.${service_checkout}.dc.splits.${dc}.${code}.metrics.handshake.buckets.${buckets_handshake}`](#a776bd5ce3e92e90ab77eab274028521)
  * [`market-front-unified.nginx2.v2.${service_checkout}.dc.splits.${dc}.${code}.metrics.handshake.quantiles`](#5121516e3355a05f15e040cad71275bd)
  * [`market-front-unified.nginx2.v2.${service_checkout}.dc.splits.${dc}.${code}.metrics.req_time.buckets.${buckets_req_time}`](#127f1f6e795a4486cb1737675c8ef151)
  * [`market-front-unified.nginx2.v2.${service_checkout}.dc.splits.${dc}.${code}.metrics.req_time.quantiles`](#6242969f8655db43563aedd9368926c0)
  * [`market-front-unified.nginx2.v2.${service_checkout}.dc.splits.${dc}.${code}.metrics.rps`](#a62957fab941423e480e46014362243f)
  * [`market-front-unified.nginx2.v2.${service_checkout}.dc.splits.${dc}.${code}.metrics.ttlb.buckets.${buckets_ttlb}`](#d6b42d5f1f9b0bc62c2b481065fdd136)
  * [`market-front-unified.nginx2.v2.${service_checkout}.dc.splits.${dc}.${code}.metrics.ttlb.quantiles`](#d7b3f294459fc91d7f552896dfde00fc)
  * [`market-front-unified.nginx2.v2.${service_checkout}.host.page.splits.${host}.${page}.${code}.metrics.bytes_send.quantiles`](#956776365d62c5fcc3b560932fad4f40)
  * [`market-front-unified.nginx2.v2.${service_checkout}.host.page.splits.${host}.${page}.${code}.metrics.handshake.quantiles`](#a22424871299f0e857ecf5f993b67020)
  * [`market-front-unified.nginx2.v2.${service_checkout}.host.page.splits.${host}.${page}.${code}.metrics.req_time.quantiles`](#e9074c8d90911437497a2e9309938cd0)
  * [`market-front-unified.nginx2.v2.${service_checkout}.host.page.splits.${host}.${page}.${code}.metrics.rps`](#b4e003a8c8730f61232fe0b2e9ef03ea)
  * [`market-front-unified.nginx2.v2.${service_checkout}.host.page.splits.${host}.${page}.${code}.metrics.ttlb.quantiles`](#57d2f59981f645716f98177debcb8456)
  * [`market-front-unified.nginx2.v2.${service_checkout}.host.resolver.splits.${host}.${resolver}.${code}.metrics.bytes_send.quantiles`](#a882a2860dd1e32db9cea0d651c4f9d4)
  * [`market-front-unified.nginx2.v2.${service_checkout}.host.resolver.splits.${host}.${resolver}.${code}.metrics.handshake.quantiles`](#0633b4a5a1e8ac13d305d664ae43efc7)
  * [`market-front-unified.nginx2.v2.${service_checkout}.host.resolver.splits.${host}.${resolver}.${code}.metrics.req_time.quantiles`](#50f541ede5ebf73d954c446fc8606504)
  * [`market-front-unified.nginx2.v2.${service_checkout}.host.resolver.splits.${host}.${resolver}.${code}.metrics.rps`](#49864c4be548ad66d405781842eb7c8e)
  * [`market-front-unified.nginx2.v2.${service_checkout}.host.resolver.splits.${host}.${resolver}.${code}.metrics.ttlb.quantiles`](#812ae22a460a34f56b4022f980e7da7d)
  * [`market-front-unified.nginx2.v2.${service_checkout}.host.splits.${host}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}`](#2f878c78dadda27be6b03b26b73f3bb7)
  * [`market-front-unified.nginx2.v2.${service_checkout}.host.splits.${host}.${code}.metrics.bytes_send.quantiles`](#4db40e3c5b81e6edf379ad51390de432)
  * [`market-front-unified.nginx2.v2.${service_checkout}.host.splits.${host}.${code}.metrics.handshake.buckets.${buckets_handshake}`](#b140ee5957d8aa0db2492a80491d5026)
  * [`market-front-unified.nginx2.v2.${service_checkout}.host.splits.${host}.${code}.metrics.handshake.quantiles`](#679e546acce7801fe3167469c37bc8d3)
  * [`market-front-unified.nginx2.v2.${service_checkout}.host.splits.${host}.${code}.metrics.req_time.buckets.${buckets_req_time}`](#8f5f88f424ae26c919a467f1a03505dd)
  * [`market-front-unified.nginx2.v2.${service_checkout}.host.splits.${host}.${code}.metrics.req_time.quantiles`](#586195e50c6f6d6863e42c22ff5d2160)
  * [`market-front-unified.nginx2.v2.${service_checkout}.host.splits.${host}.${code}.metrics.rps`](#d82d120c8c818e50316af105118443a4)
  * [`market-front-unified.nginx2.v2.${service_checkout}.host.splits.${host}.${code}.metrics.ttlb.buckets.${buckets_ttlb}`](#0903d76d4808f1b64b761291b70ad35f)
  * [`market-front-unified.nginx2.v2.${service_checkout}.host.splits.${host}.${code}.metrics.ttlb.quantiles`](#cdfd4d4adc98da76477a79aa3920441c)
  * [`market-front-unified.nginx2.v2.${service_checkout}.page.splits.${page}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}`](#59040a57613f28ca96a5b1c937955c30)
  * [`market-front-unified.nginx2.v2.${service_checkout}.page.splits.${page}.${code}.metrics.bytes_send.quantiles`](#3040ddec60f066c8a924f2e15672b629)
  * [`market-front-unified.nginx2.v2.${service_checkout}.page.splits.${page}.${code}.metrics.handshake.buckets.${buckets_handshake}`](#445505ca0a014ca8019aaaa0768a926e)
  * [`market-front-unified.nginx2.v2.${service_checkout}.page.splits.${page}.${code}.metrics.handshake.quantiles`](#93f911492988cdbab165c01d0c5175ff)
  * [`market-front-unified.nginx2.v2.${service_checkout}.page.splits.${page}.${code}.metrics.req_time.buckets.${buckets_req_time}`](#64e8a176bc1693632fb7a1c27ead5e31)
  * [`market-front-unified.nginx2.v2.${service_checkout}.page.splits.${page}.${code}.metrics.req_time.quantiles`](#a09d97cab93bc5e6a70a659238379fb4)
  * [`market-front-unified.nginx2.v2.${service_checkout}.page.splits.${page}.${code}.metrics.rps`](#529972aa4bf998b2cb669981c3e85f5a)
  * [`market-front-unified.nginx2.v2.${service_checkout}.page.splits.${page}.${code}.metrics.ttlb.buckets.${buckets_ttlb}`](#6689d2c21fda26f1ecdb8b3e2d707946)
  * [`market-front-unified.nginx2.v2.${service_checkout}.page.splits.${page}.${code}.metrics.ttlb.quantiles`](#1c966686b697014a6e1e1c1e0115f91d)
  * [`market-front-unified.nginx2.v2.${service_checkout}.requester.dc.splits.${requester}.${dc}.${code}.metrics.bytes_send.quantiles`](#cb386c05b94baad4fc59a558cd711f9a)
  * [`market-front-unified.nginx2.v2.${service_checkout}.requester.dc.splits.${requester}.${dc}.${code}.metrics.handshake.quantiles`](#a2b58c585971d747481d8dbf1490fcbb)
  * [`market-front-unified.nginx2.v2.${service_checkout}.requester.dc.splits.${requester}.${dc}.${code}.metrics.req_time.quantiles`](#f0a6dc35918714d8b6bc09fbc0575441)
  * [`market-front-unified.nginx2.v2.${service_checkout}.requester.dc.splits.${requester}.${dc}.${code}.metrics.rps`](#61115155736f856b5c34c67ded447e2e)
  * [`market-front-unified.nginx2.v2.${service_checkout}.requester.dc.splits.${requester}.${dc}.${code}.metrics.ttlb.quantiles`](#9ffda5fe8ec79fe46e0ed6e7fca768e5)
  * [`market-front-unified.nginx2.v2.${service_checkout}.requester.host.splits.${requester}.${host}.${code}.metrics.bytes_send.quantiles`](#0f83b82f1170c48f17d5d60d6a2fc8ee)
  * [`market-front-unified.nginx2.v2.${service_checkout}.requester.host.splits.${requester}.${host}.${code}.metrics.handshake.quantiles`](#1bde3bd0fb78096f4dd443572afd00ed)
  * [`market-front-unified.nginx2.v2.${service_checkout}.requester.host.splits.${requester}.${host}.${code}.metrics.req_time.quantiles`](#0a0e1e9524992a0d3cec251f31f1de04)
  * [`market-front-unified.nginx2.v2.${service_checkout}.requester.host.splits.${requester}.${host}.${code}.metrics.rps`](#ccdbb19c23ca490f00df5a6cc5bb485a)
  * [`market-front-unified.nginx2.v2.${service_checkout}.requester.host.splits.${requester}.${host}.${code}.metrics.ttlb.quantiles`](#c61dfbc5810168a01dcaa9d43200985f)
  * [`market-front-unified.nginx2.v2.${service_checkout}.requester.page.splits.${requester}.${page}.${code}.metrics.bytes_send.quantiles`](#bc17753bfa28889a6b2295632e5986a1)
  * [`market-front-unified.nginx2.v2.${service_checkout}.requester.page.splits.${requester}.${page}.${code}.metrics.handshake.quantiles`](#878a49e8c2b7edefbe6e336197980d24)
  * [`market-front-unified.nginx2.v2.${service_checkout}.requester.page.splits.${requester}.${page}.${code}.metrics.req_time.quantiles`](#ccfdbb45dd94b533cdad84088c73ba87)
  * [`market-front-unified.nginx2.v2.${service_checkout}.requester.page.splits.${requester}.${page}.${code}.metrics.rps`](#97023c57f202f26134209f18d4ef10af)
  * [`market-front-unified.nginx2.v2.${service_checkout}.requester.page.splits.${requester}.${page}.${code}.metrics.ttlb.quantiles`](#7ec726030000bb731c9794e5ca0992cf)
  * [`market-front-unified.nginx2.v2.${service_checkout}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.bytes_send.quantiles`](#d2fe030d0886ca22b8129184aeb47c5d)
  * [`market-front-unified.nginx2.v2.${service_checkout}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.handshake.quantiles`](#8e51ec23e7386b7b2875eb0d75525665)
  * [`market-front-unified.nginx2.v2.${service_checkout}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.req_time.quantiles`](#7ac1264d3df8fd0ebbc0e94833119c79)
  * [`market-front-unified.nginx2.v2.${service_checkout}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.rps`](#d23becf25901f22d4046354ee302edb8)
  * [`market-front-unified.nginx2.v2.${service_checkout}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.ttlb.quantiles`](#76205edee0ccda5ef0674876b159ddd4)
  * [`market-front-unified.nginx2.v2.${service_checkout}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.bytes_send.quantiles`](#9a1cd4f2f67a1c5c9e77d242c0858984)
  * [`market-front-unified.nginx2.v2.${service_checkout}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.handshake.quantiles`](#db30c7b68e208fb20463073b639beb75)
  * [`market-front-unified.nginx2.v2.${service_checkout}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.req_time.quantiles`](#35ac1be055aaec52202b9d978902f3f9)
  * [`market-front-unified.nginx2.v2.${service_checkout}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.rps`](#a39513d24f5f9732a7cae5114ee5ba71)
  * [`market-front-unified.nginx2.v2.${service_checkout}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.ttlb.quantiles`](#1fbab6d834c879f169f491dcb108091d)
  * [`market-front-unified.nginx2.v2.${service_checkout}.requester.splits.${requester}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}`](#1194ee833665316058af9260f1592e4e)
  * [`market-front-unified.nginx2.v2.${service_checkout}.requester.splits.${requester}.${code}.metrics.bytes_send.quantiles`](#1a38a8dc127a07e323c91eb0c1ca2ab1)
  * [`market-front-unified.nginx2.v2.${service_checkout}.requester.splits.${requester}.${code}.metrics.handshake.buckets.${buckets_handshake}`](#a8a1d5e6feba1c4e782a3a41c865827c)
  * [`market-front-unified.nginx2.v2.${service_checkout}.requester.splits.${requester}.${code}.metrics.handshake.quantiles`](#aa9ab9d03f84ee706c167dff11611826)
  * [`market-front-unified.nginx2.v2.${service_checkout}.requester.splits.${requester}.${code}.metrics.req_time.buckets.${buckets_req_time}`](#a4757b780753457e913a076c491a2f1d)
  * [`market-front-unified.nginx2.v2.${service_checkout}.requester.splits.${requester}.${code}.metrics.req_time.quantiles`](#e60ca04334f2493dddbdcd70513190ab)
  * [`market-front-unified.nginx2.v2.${service_checkout}.requester.splits.${requester}.${code}.metrics.rps`](#71256c41d36227994f05b33a98b9e177)
  * [`market-front-unified.nginx2.v2.${service_checkout}.requester.splits.${requester}.${code}.metrics.ttlb.buckets.${buckets_ttlb}`](#5cf6229a0fa3691a3740c54aeea9d299)
  * [`market-front-unified.nginx2.v2.${service_checkout}.requester.splits.${requester}.${code}.metrics.ttlb.quantiles`](#1146238fcd0ce52a351bd195e6d2ad68)
  * [`market-front-unified.nginx2.v2.${service_checkout}.resolver.splits.${resolver}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}`](#1ec50a22229d9dd7017b29b03404fe1b)
  * [`market-front-unified.nginx2.v2.${service_checkout}.resolver.splits.${resolver}.${code}.metrics.bytes_send.quantiles`](#ab34649ff0af3e6c966b0f8fcb397914)
  * [`market-front-unified.nginx2.v2.${service_checkout}.resolver.splits.${resolver}.${code}.metrics.handshake.buckets.${buckets_handshake}`](#569c20204d47b3c19676294d9a83f574)
  * [`market-front-unified.nginx2.v2.${service_checkout}.resolver.splits.${resolver}.${code}.metrics.handshake.quantiles`](#3f48f0be8ed07b2e11b49f09bcaea1be)
  * [`market-front-unified.nginx2.v2.${service_checkout}.resolver.splits.${resolver}.${code}.metrics.req_time.buckets.${buckets_req_time}`](#7cf26dac3e9b1fed3b64d5ed5afba279)
  * [`market-front-unified.nginx2.v2.${service_checkout}.resolver.splits.${resolver}.${code}.metrics.req_time.quantiles`](#87819c61fad8b0ad643dfeca394a4b18)
  * [`market-front-unified.nginx2.v2.${service_checkout}.resolver.splits.${resolver}.${code}.metrics.rps`](#6f8eac0f6d64388dd2aab4b8b4c72877)
  * [`market-front-unified.nginx2.v2.${service_checkout}.resolver.splits.${resolver}.${code}.metrics.ttlb.buckets.${buckets_ttlb}`](#119fe9c4d5645015c2281f40d3a53df3)
  * [`market-front-unified.nginx2.v2.${service_checkout}.resolver.splits.${resolver}.${code}.metrics.ttlb.quantiles`](#dfcc1230c4b95699efd3f9db526a3975)
  * [`market-front-unified.nginx2.v2.${service_checkout}.resourceType.splits.${resource-type}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}`](#6c83a1ecbdfd04e858e964e581fe39af)
  * [`market-front-unified.nginx2.v2.${service_checkout}.resourceType.splits.${resource-type}.${code}.metrics.bytes_send.quantiles`](#c394773a018de9a47b69344d806b766d)
  * [`market-front-unified.nginx2.v2.${service_checkout}.resourceType.splits.${resource-type}.${code}.metrics.handshake.buckets.${buckets_handshake}`](#234170e41c83347340f902f0287111f3)
  * [`market-front-unified.nginx2.v2.${service_checkout}.resourceType.splits.${resource-type}.${code}.metrics.handshake.quantiles`](#e789f4895be4b5216a88dc5e569158cb)
  * [`market-front-unified.nginx2.v2.${service_checkout}.resourceType.splits.${resource-type}.${code}.metrics.req_time.buckets.${buckets_req_time}`](#4ba20fd630122aefc0a11e6244243e34)
  * [`market-front-unified.nginx2.v2.${service_checkout}.resourceType.splits.${resource-type}.${code}.metrics.req_time.quantiles`](#0e8247469e4de9d39ee6c6a1223c8a03)
  * [`market-front-unified.nginx2.v2.${service_checkout}.resourceType.splits.${resource-type}.${code}.metrics.rps`](#7c713613e940d2de3265f558e5f97128)
  * [`market-front-unified.nginx2.v2.${service_checkout}.resourceType.splits.${resource-type}.${code}.metrics.ttlb.buckets.${buckets_ttlb}`](#6a23b0818dfe7d9c614b9415b08246a4)
  * [`market-front-unified.nginx2.v2.${service_checkout}.resourceType.splits.${resource-type}.${code}.metrics.ttlb.quantiles`](#71392e7c7118172d61506746e493195c)
  * [`market-front-unified.nginx2.v2.${service_checkout}.robot.dc.splits.${robot}.${dc}.${code}.metrics.bytes_send.quantiles`](#d2b9305eee81add739d96a0ec02112ab)
  * [`market-front-unified.nginx2.v2.${service_checkout}.robot.dc.splits.${robot}.${dc}.${code}.metrics.handshake.quantiles`](#7483ae3c3ff9b2781b48ec32e9e533e3)
  * [`market-front-unified.nginx2.v2.${service_checkout}.robot.dc.splits.${robot}.${dc}.${code}.metrics.req_time.quantiles`](#7c45288910b5e573b53c55dea86dedeb)
  * [`market-front-unified.nginx2.v2.${service_checkout}.robot.dc.splits.${robot}.${dc}.${code}.metrics.rps`](#7e4e14905bdc31f5fbeae9a334499b49)
  * [`market-front-unified.nginx2.v2.${service_checkout}.robot.dc.splits.${robot}.${dc}.${code}.metrics.ttlb.quantiles`](#d664ce4d74e354713839d62e545edf04)
  * [`market-front-unified.nginx2.v2.${service_checkout}.robot.host.splits.${robot}.${host}.${code}.metrics.bytes_send.quantiles`](#531af30c3d7f7a25fe96b7e1a8f169db)
  * [`market-front-unified.nginx2.v2.${service_checkout}.robot.host.splits.${robot}.${host}.${code}.metrics.handshake.quantiles`](#2038934153f6318044d8f14fa85eb628)
  * [`market-front-unified.nginx2.v2.${service_checkout}.robot.host.splits.${robot}.${host}.${code}.metrics.req_time.quantiles`](#e359c3cae7a992c9b994b7672588f07d)
  * [`market-front-unified.nginx2.v2.${service_checkout}.robot.host.splits.${robot}.${host}.${code}.metrics.rps`](#801c9a84128e45836c39f2cf1d762ad6)
  * [`market-front-unified.nginx2.v2.${service_checkout}.robot.host.splits.${robot}.${host}.${code}.metrics.ttlb.quantiles`](#e04f2fb5c9f9623b3fa77deac17e0c01)
  * [`market-front-unified.nginx2.v2.${service_checkout}.robot.page.splits.${robot}.${page}.${code}.metrics.bytes_send.quantiles`](#72a20d09b29a08ca0a3d676005b9d9ab)
  * [`market-front-unified.nginx2.v2.${service_checkout}.robot.page.splits.${robot}.${page}.${code}.metrics.handshake.quantiles`](#ecb5eab50b17d51f21506927bfa0e308)
  * [`market-front-unified.nginx2.v2.${service_checkout}.robot.page.splits.${robot}.${page}.${code}.metrics.req_time.quantiles`](#a09285d5df5c37a1ef91a90e83b34855)
  * [`market-front-unified.nginx2.v2.${service_checkout}.robot.page.splits.${robot}.${page}.${code}.metrics.rps`](#05828f91e816fed1c993cab256f8706b)
  * [`market-front-unified.nginx2.v2.${service_checkout}.robot.page.splits.${robot}.${page}.${code}.metrics.ttlb.quantiles`](#b9b5dff258cb2408f73fc97f2664835c)
  * [`market-front-unified.nginx2.v2.${service_checkout}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.bytes_send.quantiles`](#18fce3eca7ae6148b11847a26d5f4b66)
  * [`market-front-unified.nginx2.v2.${service_checkout}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.handshake.quantiles`](#9c382a64661cbe86fbfef724073abfa0)
  * [`market-front-unified.nginx2.v2.${service_checkout}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.req_time.quantiles`](#4322f1424b46854606897eeec0b6ddc6)
  * [`market-front-unified.nginx2.v2.${service_checkout}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.rps`](#59b316f3e704308a7ed6b5463e10ca7f)
  * [`market-front-unified.nginx2.v2.${service_checkout}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.ttlb.quantiles`](#00389c75e1f696b85737af1348e58993)
  * [`market-front-unified.nginx2.v2.${service_checkout}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.bytes_send.quantiles`](#fac1241921276c965591102ba6e0c736)
  * [`market-front-unified.nginx2.v2.${service_checkout}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.handshake.quantiles`](#c2010d3b6041fc0ef8666aede231ced9)
  * [`market-front-unified.nginx2.v2.${service_checkout}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.req_time.quantiles`](#2a647ed746c0e25d257f9b59a5b76010)
  * [`market-front-unified.nginx2.v2.${service_checkout}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.rps`](#5bce6745553071032d72941a07cdeaab)
  * [`market-front-unified.nginx2.v2.${service_checkout}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.ttlb.quantiles`](#0e71bd587fbc0cc70ca9dfb433161205)
  * [`market-front-unified.nginx2.v2.${service_checkout}.robot.splits.${robot}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}`](#383f64b415e1bd5be9760784ee6be994)
  * [`market-front-unified.nginx2.v2.${service_checkout}.robot.splits.${robot}.${code}.metrics.bytes_send.quantiles`](#428e6f1fb0a4f2a66ef9c22e872354f7)
  * [`market-front-unified.nginx2.v2.${service_checkout}.robot.splits.${robot}.${code}.metrics.handshake.buckets.${buckets_handshake}`](#1b86ee3c66bd86ed2bbc1db21daf1e65)
  * [`market-front-unified.nginx2.v2.${service_checkout}.robot.splits.${robot}.${code}.metrics.handshake.quantiles`](#f7f759f774e03f7ceb6449185cbdcf1d)
  * [`market-front-unified.nginx2.v2.${service_checkout}.robot.splits.${robot}.${code}.metrics.req_time.buckets.${buckets_req_time}`](#42bb27e4a67b5b8da4a57241b89e2479)
  * [`market-front-unified.nginx2.v2.${service_checkout}.robot.splits.${robot}.${code}.metrics.req_time.quantiles`](#b0bbbc06bd55e8083bf1e6568e4ce5ce)
  * [`market-front-unified.nginx2.v2.${service_checkout}.robot.splits.${robot}.${code}.metrics.rps`](#dac5ecc7124a504b9acec34c0e7b1dba)
  * [`market-front-unified.nginx2.v2.${service_checkout}.robot.splits.${robot}.${code}.metrics.ttlb.buckets.${buckets_ttlb}`](#ee6e96ac1c29d5c378ee99b8925addc1)
  * [`market-front-unified.nginx2.v2.${service_checkout}.robot.splits.${robot}.${code}.metrics.ttlb.quantiles`](#27daa321421d2bbf602087505bc173b1)
  * [`market-front-unified.nginx2.v2.${service_checkout}.total.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}`](#c36138dc65736a85f717fd4ecd335a71)
  * [`market-front-unified.nginx2.v2.${service_checkout}.total.${code}.metrics.bytes_send.quantiles`](#e9133ef4b23691edf4bbe9a892420090)
  * [`market-front-unified.nginx2.v2.${service_checkout}.total.${code}.metrics.handshake.buckets.${buckets_handshake}`](#622b98ec8ad7663486228ba054fdf184)
  * [`market-front-unified.nginx2.v2.${service_checkout}.total.${code}.metrics.handshake.quantiles`](#97b4fe6dceebbbe3a5f25702480a0691)
  * [`market-front-unified.nginx2.v2.${service_checkout}.total.${code}.metrics.req_time.buckets.${buckets_req_time}`](#1807b8936718d2df6b385388e1270138)
  * [`market-front-unified.nginx2.v2.${service_checkout}.total.${code}.metrics.req_time.quantiles`](#0f62401796cc264d5705381460af3d35)
  * [`market-front-unified.nginx2.v2.${service_checkout}.total.${code}.metrics.rps`](#dc0d8a686b304c4619c474cf11a5574c)
  * [`market-front-unified.nginx2.v2.${service_checkout}.total.${code}.metrics.ttlb.buckets.${buckets_ttlb}`](#8fed552c8b3ebae6bb2493a6e10982fc)
  * [`market-front-unified.nginx2.v2.${service_checkout}.total.${code}.metrics.ttlb.quantiles`](#c2c41d45674cfcd35186bedd20838cdf)

## Metrics

#### <a id='dc0d8a686b304c4619c474cf11a5574c'></a>market-front-unified.nginx2.v2.${service_checkout}.total.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.total.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.total.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='8fed552c8b3ebae6bb2493a6e10982fc'></a>market-front-unified.nginx2.v2.${service_checkout}.total.${code}.metrics.ttlb.buckets.${buckets_ttlb}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_ttlb%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    code,
    buckets_ttlb

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.total.%24%7Bcode%7D.metrics.ttlb.buckets.%24%7Bbuckets_ttlb%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_ttlb%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.total.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        code,
        buckets_ttlb
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='1807b8936718d2df6b385388e1270138'></a>market-front-unified.nginx2.v2.${service_checkout}.total.${code}.metrics.req_time.buckets.${buckets_req_time}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_req_time%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    code,
    buckets_req_time

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.total.%24%7Bcode%7D.metrics.req_time.buckets.%24%7Bbuckets_req_time%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_req_time%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.total.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        code,
        buckets_req_time
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='622b98ec8ad7663486228ba054fdf184'></a>market-front-unified.nginx2.v2.${service_checkout}.total.${code}.metrics.handshake.buckets.${buckets_handshake}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_handshake%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    code,
    buckets_handshake

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.total.%24%7Bcode%7D.metrics.handshake.buckets.%24%7Bbuckets_handshake%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_handshake%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.total.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        code,
        buckets_handshake
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='c36138dc65736a85f717fd4ecd335a71'></a>market-front-unified.nginx2.v2.${service_checkout}.total.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_bytes_send%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    code,
    buckets_bytes_send

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.total.%24%7Bcode%7D.metrics.bytes_send.buckets.%24%7Bbuckets_bytes_send%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_bytes_send%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.total.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        code,
        buckets_bytes_send
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='a62957fab941423e480e46014362243f'></a>market-front-unified.nginx2.v2.${service_checkout}.dc.splits.${dc}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.dc.splits.%24%7Bdc%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.dc.splits.${dc}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='d6b42d5f1f9b0bc62c2b481065fdd136'></a>market-front-unified.nginx2.v2.${service_checkout}.dc.splits.${dc}.${code}.metrics.ttlb.buckets.${buckets_ttlb}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_ttlb%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    dc,
    code,
    buckets_ttlb

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.dc.splits.%24%7Bdc%7D.%24%7Bcode%7D.metrics.ttlb.buckets.%24%7Bbuckets_ttlb%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_ttlb%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.dc.splits.${dc}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        dc,
        code,
        buckets_ttlb
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='127f1f6e795a4486cb1737675c8ef151'></a>market-front-unified.nginx2.v2.${service_checkout}.dc.splits.${dc}.${code}.metrics.req_time.buckets.${buckets_req_time}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_req_time%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    dc,
    code,
    buckets_req_time

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.dc.splits.%24%7Bdc%7D.%24%7Bcode%7D.metrics.req_time.buckets.%24%7Bbuckets_req_time%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_req_time%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.dc.splits.${dc}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        dc,
        code,
        buckets_req_time
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='a776bd5ce3e92e90ab77eab274028521'></a>market-front-unified.nginx2.v2.${service_checkout}.dc.splits.${dc}.${code}.metrics.handshake.buckets.${buckets_handshake}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_handshake%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    dc,
    code,
    buckets_handshake

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.dc.splits.%24%7Bdc%7D.%24%7Bcode%7D.metrics.handshake.buckets.%24%7Bbuckets_handshake%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_handshake%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.dc.splits.${dc}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        dc,
        code,
        buckets_handshake
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='959d8c25c35869b302edcfabf746228f'></a>market-front-unified.nginx2.v2.${service_checkout}.dc.splits.${dc}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_bytes_send%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    dc,
    code,
    buckets_bytes_send

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.dc.splits.%24%7Bdc%7D.%24%7Bcode%7D.metrics.bytes_send.buckets.%24%7Bbuckets_bytes_send%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_bytes_send%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.dc.splits.${dc}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        dc,
        code,
        buckets_bytes_send
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='d82d120c8c818e50316af105118443a4'></a>market-front-unified.nginx2.v2.${service_checkout}.host.splits.${host}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.host.splits.%24%7Bhost%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.host.splits.${host}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='0903d76d4808f1b64b761291b70ad35f'></a>market-front-unified.nginx2.v2.${service_checkout}.host.splits.${host}.${code}.metrics.ttlb.buckets.${buckets_ttlb}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_ttlb%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    host,
    code,
    buckets_ttlb

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.host.splits.%24%7Bhost%7D.%24%7Bcode%7D.metrics.ttlb.buckets.%24%7Bbuckets_ttlb%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_ttlb%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.host.splits.${host}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        host,
        code,
        buckets_ttlb
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='8f5f88f424ae26c919a467f1a03505dd'></a>market-front-unified.nginx2.v2.${service_checkout}.host.splits.${host}.${code}.metrics.req_time.buckets.${buckets_req_time}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_req_time%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    host,
    code,
    buckets_req_time

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.host.splits.%24%7Bhost%7D.%24%7Bcode%7D.metrics.req_time.buckets.%24%7Bbuckets_req_time%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_req_time%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.host.splits.${host}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        host,
        code,
        buckets_req_time
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='b140ee5957d8aa0db2492a80491d5026'></a>market-front-unified.nginx2.v2.${service_checkout}.host.splits.${host}.${code}.metrics.handshake.buckets.${buckets_handshake}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_handshake%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    host,
    code,
    buckets_handshake

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.host.splits.%24%7Bhost%7D.%24%7Bcode%7D.metrics.handshake.buckets.%24%7Bbuckets_handshake%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_handshake%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.host.splits.${host}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        host,
        code,
        buckets_handshake
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='2f878c78dadda27be6b03b26b73f3bb7'></a>market-front-unified.nginx2.v2.${service_checkout}.host.splits.${host}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_bytes_send%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    host,
    code,
    buckets_bytes_send

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.host.splits.%24%7Bhost%7D.%24%7Bcode%7D.metrics.bytes_send.buckets.%24%7Bbuckets_bytes_send%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_bytes_send%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.host.splits.${host}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        host,
        code,
        buckets_bytes_send
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='71256c41d36227994f05b33a98b9e177'></a>market-front-unified.nginx2.v2.${service_checkout}.requester.splits.${requester}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    requester,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.requester.splits.%24%7Brequester%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.requester.splits.${requester}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        requester,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='5cf6229a0fa3691a3740c54aeea9d299'></a>market-front-unified.nginx2.v2.${service_checkout}.requester.splits.${requester}.${code}.metrics.ttlb.buckets.${buckets_ttlb}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_ttlb%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    requester,
    code,
    buckets_ttlb

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.requester.splits.%24%7Brequester%7D.%24%7Bcode%7D.metrics.ttlb.buckets.%24%7Bbuckets_ttlb%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_ttlb%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.requester.splits.${requester}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        requester,
        code,
        buckets_ttlb
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='a4757b780753457e913a076c491a2f1d'></a>market-front-unified.nginx2.v2.${service_checkout}.requester.splits.${requester}.${code}.metrics.req_time.buckets.${buckets_req_time}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_req_time%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    requester,
    code,
    buckets_req_time

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.requester.splits.%24%7Brequester%7D.%24%7Bcode%7D.metrics.req_time.buckets.%24%7Bbuckets_req_time%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_req_time%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.requester.splits.${requester}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        requester,
        code,
        buckets_req_time
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='a8a1d5e6feba1c4e782a3a41c865827c'></a>market-front-unified.nginx2.v2.${service_checkout}.requester.splits.${requester}.${code}.metrics.handshake.buckets.${buckets_handshake}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_handshake%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    requester,
    code,
    buckets_handshake

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.requester.splits.%24%7Brequester%7D.%24%7Bcode%7D.metrics.handshake.buckets.%24%7Bbuckets_handshake%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_handshake%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.requester.splits.${requester}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        requester,
        code,
        buckets_handshake
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='1194ee833665316058af9260f1592e4e'></a>market-front-unified.nginx2.v2.${service_checkout}.requester.splits.${requester}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_bytes_send%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    requester,
    code,
    buckets_bytes_send

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.requester.splits.%24%7Brequester%7D.%24%7Bcode%7D.metrics.bytes_send.buckets.%24%7Bbuckets_bytes_send%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_bytes_send%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.requester.splits.${requester}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        requester,
        code,
        buckets_bytes_send
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='7c713613e940d2de3265f558e5f97128'></a>market-front-unified.nginx2.v2.${service_checkout}.resourceType.splits.${resource-type}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.resourceType.splits.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.resourceType.splits.${resource-type}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='6a23b0818dfe7d9c614b9415b08246a4'></a>market-front-unified.nginx2.v2.${service_checkout}.resourceType.splits.${resource-type}.${code}.metrics.ttlb.buckets.${buckets_ttlb}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_ttlb%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    resource_type,
    code,
    buckets_ttlb

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.resourceType.splits.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.ttlb.buckets.%24%7Bbuckets_ttlb%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_ttlb%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.resourceType.splits.${resource-type}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        resource_type,
        code,
        buckets_ttlb
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='4ba20fd630122aefc0a11e6244243e34'></a>market-front-unified.nginx2.v2.${service_checkout}.resourceType.splits.${resource-type}.${code}.metrics.req_time.buckets.${buckets_req_time}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_req_time%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    resource_type,
    code,
    buckets_req_time

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.resourceType.splits.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.req_time.buckets.%24%7Bbuckets_req_time%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_req_time%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.resourceType.splits.${resource-type}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        resource_type,
        code,
        buckets_req_time
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='234170e41c83347340f902f0287111f3'></a>market-front-unified.nginx2.v2.${service_checkout}.resourceType.splits.${resource-type}.${code}.metrics.handshake.buckets.${buckets_handshake}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_handshake%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    resource_type,
    code,
    buckets_handshake

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.resourceType.splits.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.handshake.buckets.%24%7Bbuckets_handshake%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_handshake%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.resourceType.splits.${resource-type}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        resource_type,
        code,
        buckets_handshake
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='6c83a1ecbdfd04e858e964e581fe39af'></a>market-front-unified.nginx2.v2.${service_checkout}.resourceType.splits.${resource-type}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_bytes_send%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    resource_type,
    code,
    buckets_bytes_send

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.resourceType.splits.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.bytes_send.buckets.%24%7Bbuckets_bytes_send%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_bytes_send%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.resourceType.splits.${resource-type}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        resource_type,
        code,
        buckets_bytes_send
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='61115155736f856b5c34c67ded447e2e'></a>market-front-unified.nginx2.v2.${service_checkout}.requester.dc.splits.${requester}.${dc}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    requester,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.requester.dc.splits.%24%7Brequester%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.requester.dc.splits.${requester}.${dc}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        requester,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='ccdbb19c23ca490f00df5a6cc5bb485a'></a>market-front-unified.nginx2.v2.${service_checkout}.requester.host.splits.${requester}.${host}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    requester,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.requester.host.splits.%24%7Brequester%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.requester.host.splits.${requester}.${host}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        requester,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='a39513d24f5f9732a7cae5114ee5ba71'></a>market-front-unified.nginx2.v2.${service_checkout}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    requester,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.requester.resourceType.splits.%24%7Brequester%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        requester,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='dac5ecc7124a504b9acec34c0e7b1dba'></a>market-front-unified.nginx2.v2.${service_checkout}.robot.splits.${robot}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    robot,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.robot.splits.%24%7Brobot%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.robot.splits.${robot}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        robot,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='ee6e96ac1c29d5c378ee99b8925addc1'></a>market-front-unified.nginx2.v2.${service_checkout}.robot.splits.${robot}.${code}.metrics.ttlb.buckets.${buckets_ttlb}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_ttlb%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    robot,
    code,
    buckets_ttlb

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.robot.splits.%24%7Brobot%7D.%24%7Bcode%7D.metrics.ttlb.buckets.%24%7Bbuckets_ttlb%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_ttlb%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.robot.splits.${robot}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        robot,
        code,
        buckets_ttlb
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='42bb27e4a67b5b8da4a57241b89e2479'></a>market-front-unified.nginx2.v2.${service_checkout}.robot.splits.${robot}.${code}.metrics.req_time.buckets.${buckets_req_time}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_req_time%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    robot,
    code,
    buckets_req_time

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.robot.splits.%24%7Brobot%7D.%24%7Bcode%7D.metrics.req_time.buckets.%24%7Bbuckets_req_time%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_req_time%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.robot.splits.${robot}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        robot,
        code,
        buckets_req_time
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='1b86ee3c66bd86ed2bbc1db21daf1e65'></a>market-front-unified.nginx2.v2.${service_checkout}.robot.splits.${robot}.${code}.metrics.handshake.buckets.${buckets_handshake}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_handshake%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    robot,
    code,
    buckets_handshake

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.robot.splits.%24%7Brobot%7D.%24%7Bcode%7D.metrics.handshake.buckets.%24%7Bbuckets_handshake%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_handshake%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.robot.splits.${robot}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        robot,
        code,
        buckets_handshake
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='383f64b415e1bd5be9760784ee6be994'></a>market-front-unified.nginx2.v2.${service_checkout}.robot.splits.${robot}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_bytes_send%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    robot,
    code,
    buckets_bytes_send

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.robot.splits.%24%7Brobot%7D.%24%7Bcode%7D.metrics.bytes_send.buckets.%24%7Bbuckets_bytes_send%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_bytes_send%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.robot.splits.${robot}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        robot,
        code,
        buckets_bytes_send
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='7e4e14905bdc31f5fbeae9a334499b49'></a>market-front-unified.nginx2.v2.${service_checkout}.robot.dc.splits.${robot}.${dc}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    robot,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.robot.dc.splits.%24%7Brobot%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.robot.dc.splits.${robot}.${dc}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        robot,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='801c9a84128e45836c39f2cf1d762ad6'></a>market-front-unified.nginx2.v2.${service_checkout}.robot.host.splits.${robot}.${host}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    robot,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.robot.host.splits.%24%7Brobot%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.robot.host.splits.${robot}.${host}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        robot,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='5bce6745553071032d72941a07cdeaab'></a>market-front-unified.nginx2.v2.${service_checkout}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    robot,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.robot.resourceType.splits.%24%7Brobot%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        robot,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='529972aa4bf998b2cb669981c3e85f5a'></a>market-front-unified.nginx2.v2.${service_checkout}.page.splits.${page}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.page.splits.%24%7Bpage%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.page.splits.${page}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='6689d2c21fda26f1ecdb8b3e2d707946'></a>market-front-unified.nginx2.v2.${service_checkout}.page.splits.${page}.${code}.metrics.ttlb.buckets.${buckets_ttlb}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_ttlb%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    page,
    code,
    buckets_ttlb

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.page.splits.%24%7Bpage%7D.%24%7Bcode%7D.metrics.ttlb.buckets.%24%7Bbuckets_ttlb%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_ttlb%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.page.splits.${page}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        page,
        code,
        buckets_ttlb
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='64e8a176bc1693632fb7a1c27ead5e31'></a>market-front-unified.nginx2.v2.${service_checkout}.page.splits.${page}.${code}.metrics.req_time.buckets.${buckets_req_time}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_req_time%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    page,
    code,
    buckets_req_time

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.page.splits.%24%7Bpage%7D.%24%7Bcode%7D.metrics.req_time.buckets.%24%7Bbuckets_req_time%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_req_time%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.page.splits.${page}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        page,
        code,
        buckets_req_time
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='445505ca0a014ca8019aaaa0768a926e'></a>market-front-unified.nginx2.v2.${service_checkout}.page.splits.${page}.${code}.metrics.handshake.buckets.${buckets_handshake}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_handshake%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    page,
    code,
    buckets_handshake

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.page.splits.%24%7Bpage%7D.%24%7Bcode%7D.metrics.handshake.buckets.%24%7Bbuckets_handshake%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_handshake%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.page.splits.${page}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        page,
        code,
        buckets_handshake
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='59040a57613f28ca96a5b1c937955c30'></a>market-front-unified.nginx2.v2.${service_checkout}.page.splits.${page}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_bytes_send%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    page,
    code,
    buckets_bytes_send

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.page.splits.%24%7Bpage%7D.%24%7Bcode%7D.metrics.bytes_send.buckets.%24%7Bbuckets_bytes_send%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_bytes_send%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.page.splits.${page}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        page,
        code,
        buckets_bytes_send
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='0c3ff0d7bdf75a886b6117b5b929ebfe'></a>market-front-unified.nginx2.v2.${service_checkout}.dc.page.splits.${dc}.${page}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    dc,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.dc.page.splits.%24%7Bdc%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.dc.page.splits.${dc}.${page}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        dc,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='b4e003a8c8730f61232fe0b2e9ef03ea'></a>market-front-unified.nginx2.v2.${service_checkout}.host.page.splits.${host}.${page}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20host%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    host,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    host as host,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.host.page.splits.%24%7Bhost%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.host.page.splits.${host}.${page}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        host,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        host as host,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='97023c57f202f26134209f18d4ef10af'></a>market-front-unified.nginx2.v2.${service_checkout}.requester.page.splits.${requester}.${page}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    requester,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.requester.page.splits.%24%7Brequester%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.requester.page.splits.${requester}.${page}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        requester,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='6f8eac0f6d64388dd2aab4b8b4c72877'></a>market-front-unified.nginx2.v2.${service_checkout}.resolver.splits.${resolver}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.resolver.splits.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.resolver.splits.${resolver}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='119fe9c4d5645015c2281f40d3a53df3'></a>market-front-unified.nginx2.v2.${service_checkout}.resolver.splits.${resolver}.${code}.metrics.ttlb.buckets.${buckets_ttlb}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_ttlb%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    resolver,
    code,
    buckets_ttlb

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.resolver.splits.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.ttlb.buckets.%24%7Bbuckets_ttlb%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_ttlb%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.resolver.splits.${resolver}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        resolver,
        code,
        buckets_ttlb
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='7cf26dac3e9b1fed3b64d5ed5afba279'></a>market-front-unified.nginx2.v2.${service_checkout}.resolver.splits.${resolver}.${code}.metrics.req_time.buckets.${buckets_req_time}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_req_time%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    resolver,
    code,
    buckets_req_time

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.resolver.splits.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.req_time.buckets.%24%7Bbuckets_req_time%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_req_time%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.resolver.splits.${resolver}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        resolver,
        code,
        buckets_req_time
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='569c20204d47b3c19676294d9a83f574'></a>market-front-unified.nginx2.v2.${service_checkout}.resolver.splits.${resolver}.${code}.metrics.handshake.buckets.${buckets_handshake}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_handshake%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    resolver,
    code,
    buckets_handshake

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.resolver.splits.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.handshake.buckets.%24%7Bbuckets_handshake%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_handshake%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.resolver.splits.${resolver}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        resolver,
        code,
        buckets_handshake
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='1ec50a22229d9dd7017b29b03404fe1b'></a>market-front-unified.nginx2.v2.${service_checkout}.resolver.splits.${resolver}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_bytes_send%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    resolver,
    code,
    buckets_bytes_send

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.resolver.splits.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.bytes_send.buckets.%24%7Bbuckets_bytes_send%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_bytes_send%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.resolver.splits.${resolver}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        resolver,
        code,
        buckets_bytes_send
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='321831f86d12486a93ae6f01e7b94cfc'></a>market-front-unified.nginx2.v2.${service_checkout}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    dc,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.dc.resolver.splits.%24%7Bdc%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        dc,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='49864c4be548ad66d405781842eb7c8e'></a>market-front-unified.nginx2.v2.${service_checkout}.host.resolver.splits.${host}.${resolver}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20host%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    host,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    host as host,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.host.resolver.splits.%24%7Bhost%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.host.resolver.splits.${host}.${resolver}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        host,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        host as host,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='d23becf25901f22d4046354ee302edb8'></a>market-front-unified.nginx2.v2.${service_checkout}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    requester,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.requester.resolver.splits.%24%7Brequester%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        requester,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='05828f91e816fed1c993cab256f8706b'></a>market-front-unified.nginx2.v2.${service_checkout}.robot.page.splits.${robot}.${page}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    robot,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.robot.page.splits.%24%7Brobot%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.robot.page.splits.${robot}.${page}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        robot,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='59b316f3e704308a7ed6b5463e10ca7f'></a>market-front-unified.nginx2.v2.${service_checkout}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_checkout,
    robot,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.robot.resolver.splits.%24%7Brobot%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_checkout,
        robot,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='c2c41d45674cfcd35186bedd20838cdf'></a>market-front-unified.nginx2.v2.${service_checkout}.total.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
    service_checkout,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.total.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.total.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
        service_checkout,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='d7b3f294459fc91d7f552896dfde00fc'></a>market-front-unified.nginx2.v2.${service_checkout}.dc.splits.${dc}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
    service_checkout,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.dc.splits.%24%7Bdc%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.dc.splits.${dc}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
        service_checkout,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='cdfd4d4adc98da76477a79aa3920441c'></a>market-front-unified.nginx2.v2.${service_checkout}.host.splits.${host}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
    service_checkout,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.host.splits.%24%7Bhost%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.host.splits.${host}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
        service_checkout,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='1146238fcd0ce52a351bd195e6d2ad68'></a>market-front-unified.nginx2.v2.${service_checkout}.requester.splits.${requester}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
    service_checkout,
    requester,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.requester.splits.%24%7Brequester%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.requester.splits.${requester}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
        service_checkout,
        requester,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='71392e7c7118172d61506746e493195c'></a>market-front-unified.nginx2.v2.${service_checkout}.resourceType.splits.${resource-type}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
    service_checkout,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.resourceType.splits.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.resourceType.splits.${resource-type}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
        service_checkout,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='9ffda5fe8ec79fe46e0ed6e7fca768e5'></a>market-front-unified.nginx2.v2.${service_checkout}.requester.dc.splits.${requester}.${dc}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
    service_checkout,
    requester,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.requester.dc.splits.%24%7Brequester%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.requester.dc.splits.${requester}.${dc}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
        service_checkout,
        requester,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='c61dfbc5810168a01dcaa9d43200985f'></a>market-front-unified.nginx2.v2.${service_checkout}.requester.host.splits.${requester}.${host}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
    service_checkout,
    requester,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.requester.host.splits.%24%7Brequester%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.requester.host.splits.${requester}.${host}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
        service_checkout,
        requester,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='1fbab6d834c879f169f491dcb108091d'></a>market-front-unified.nginx2.v2.${service_checkout}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
    service_checkout,
    requester,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.requester.resourceType.splits.%24%7Brequester%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
        service_checkout,
        requester,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='27daa321421d2bbf602087505bc173b1'></a>market-front-unified.nginx2.v2.${service_checkout}.robot.splits.${robot}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0,
    service_checkout,
    robot,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.robot.splits.%24%7Brobot%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.robot.splits.${robot}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0,
        service_checkout,
        robot,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='d664ce4d74e354713839d62e545edf04'></a>market-front-unified.nginx2.v2.${service_checkout}.robot.dc.splits.${robot}.${dc}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0,
    service_checkout,
    robot,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.robot.dc.splits.%24%7Brobot%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.robot.dc.splits.${robot}.${dc}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0,
        service_checkout,
        robot,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='e04f2fb5c9f9623b3fa77deac17e0c01'></a>market-front-unified.nginx2.v2.${service_checkout}.robot.host.splits.${robot}.${host}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0,
    service_checkout,
    robot,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.robot.host.splits.%24%7Brobot%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.robot.host.splits.${robot}.${host}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0,
        service_checkout,
        robot,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='0e71bd587fbc0cc70ca9dfb433161205'></a>market-front-unified.nginx2.v2.${service_checkout}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0,
    service_checkout,
    robot,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.robot.resourceType.splits.%24%7Brobot%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0,
        service_checkout,
        robot,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='1c966686b697014a6e1e1c1e0115f91d'></a>market-front-unified.nginx2.v2.${service_checkout}.page.splits.${page}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0,
    service_checkout,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.page.splits.%24%7Bpage%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.page.splits.${page}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0,
        service_checkout,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='57b0defe1a6e896f5ed89d9bf49bed4d'></a>market-front-unified.nginx2.v2.${service_checkout}.dc.page.splits.${dc}.${page}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0,
    service_checkout,
    dc,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.dc.page.splits.%24%7Bdc%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.dc.page.splits.${dc}.${page}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0,
        service_checkout,
        dc,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='57d2f59981f645716f98177debcb8456'></a>market-front-unified.nginx2.v2.${service_checkout}.host.page.splits.${host}.${page}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20host%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0,
    service_checkout,
    host,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    host as host,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.host.page.splits.%24%7Bhost%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.host.page.splits.${host}.${page}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0,
        service_checkout,
        host,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        host as host,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='7ec726030000bb731c9794e5ca0992cf'></a>market-front-unified.nginx2.v2.${service_checkout}.requester.page.splits.${requester}.${page}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0,
    service_checkout,
    requester,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.requester.page.splits.%24%7Brequester%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.requester.page.splits.${requester}.${page}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0,
        service_checkout,
        requester,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='dfcc1230c4b95699efd3f9db526a3975'></a>market-front-unified.nginx2.v2.${service_checkout}.resolver.splits.${resolver}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_checkout,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.resolver.splits.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.resolver.splits.${resolver}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_checkout,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='445c44c68cd742d37cf1d7233ae98836'></a>market-front-unified.nginx2.v2.${service_checkout}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_checkout,
    dc,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.dc.resolver.splits.%24%7Bdc%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_checkout,
        dc,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='812ae22a460a34f56b4022f980e7da7d'></a>market-front-unified.nginx2.v2.${service_checkout}.host.resolver.splits.${host}.${resolver}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20host%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_checkout,
    host,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    host as host,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.host.resolver.splits.%24%7Bhost%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.host.resolver.splits.${host}.${resolver}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_checkout,
        host,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        host as host,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='76205edee0ccda5ef0674876b159ddd4'></a>market-front-unified.nginx2.v2.${service_checkout}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_checkout,
    requester,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.requester.resolver.splits.%24%7Brequester%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_checkout,
        requester,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='b9b5dff258cb2408f73fc97f2664835c'></a>market-front-unified.nginx2.v2.${service_checkout}.robot.page.splits.${robot}.${page}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id != '') as value_0,
    service_checkout,
    robot,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.robot.page.splits.%24%7Brobot%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.robot.page.splits.${robot}.${page}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id != '') as value_0,
        service_checkout,
        robot,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='00389c75e1f696b85737af1348e58993'></a>market-front-unified.nginx2.v2.${service_checkout}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_checkout,
    robot,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.robot.resolver.splits.%24%7Brobot%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_checkout,
        robot,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='0f62401796cc264d5705381460af3d35'></a>market-front-unified.nginx2.v2.${service_checkout}.total.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
    service_checkout,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.total.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.total.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
        service_checkout,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='6242969f8655db43563aedd9368926c0'></a>market-front-unified.nginx2.v2.${service_checkout}.dc.splits.${dc}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
    service_checkout,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.dc.splits.%24%7Bdc%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.dc.splits.${dc}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
        service_checkout,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='586195e50c6f6d6863e42c22ff5d2160'></a>market-front-unified.nginx2.v2.${service_checkout}.host.splits.${host}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
    service_checkout,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.host.splits.%24%7Bhost%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.host.splits.${host}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
        service_checkout,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='e60ca04334f2493dddbdcd70513190ab'></a>market-front-unified.nginx2.v2.${service_checkout}.requester.splits.${requester}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
    service_checkout,
    requester,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.requester.splits.%24%7Brequester%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.requester.splits.${requester}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
        service_checkout,
        requester,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='0e8247469e4de9d39ee6c6a1223c8a03'></a>market-front-unified.nginx2.v2.${service_checkout}.resourceType.splits.${resource-type}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
    service_checkout,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.resourceType.splits.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.resourceType.splits.${resource-type}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
        service_checkout,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='f0a6dc35918714d8b6bc09fbc0575441'></a>market-front-unified.nginx2.v2.${service_checkout}.requester.dc.splits.${requester}.${dc}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
    service_checkout,
    requester,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.requester.dc.splits.%24%7Brequester%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.requester.dc.splits.${requester}.${dc}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
        service_checkout,
        requester,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='0a0e1e9524992a0d3cec251f31f1de04'></a>market-front-unified.nginx2.v2.${service_checkout}.requester.host.splits.${requester}.${host}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
    service_checkout,
    requester,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.requester.host.splits.%24%7Brequester%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.requester.host.splits.${requester}.${host}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
        service_checkout,
        requester,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='35ac1be055aaec52202b9d978902f3f9'></a>market-front-unified.nginx2.v2.${service_checkout}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
    service_checkout,
    requester,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.requester.resourceType.splits.%24%7Brequester%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
        service_checkout,
        requester,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='b0bbbc06bd55e8083bf1e6568e4ce5ce'></a>market-front-unified.nginx2.v2.${service_checkout}.robot.splits.${robot}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0,
    service_checkout,
    robot,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.robot.splits.%24%7Brobot%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.robot.splits.${robot}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0,
        service_checkout,
        robot,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='7c45288910b5e573b53c55dea86dedeb'></a>market-front-unified.nginx2.v2.${service_checkout}.robot.dc.splits.${robot}.${dc}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0,
    service_checkout,
    robot,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.robot.dc.splits.%24%7Brobot%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.robot.dc.splits.${robot}.${dc}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0,
        service_checkout,
        robot,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='e359c3cae7a992c9b994b7672588f07d'></a>market-front-unified.nginx2.v2.${service_checkout}.robot.host.splits.${robot}.${host}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0,
    service_checkout,
    robot,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.robot.host.splits.%24%7Brobot%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.robot.host.splits.${robot}.${host}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0,
        service_checkout,
        robot,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='2a647ed746c0e25d257f9b59a5b76010'></a>market-front-unified.nginx2.v2.${service_checkout}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0,
    service_checkout,
    robot,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.robot.resourceType.splits.%24%7Brobot%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0,
        service_checkout,
        robot,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='a09d97cab93bc5e6a70a659238379fb4'></a>market-front-unified.nginx2.v2.${service_checkout}.page.splits.${page}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0,
    service_checkout,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.page.splits.%24%7Bpage%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.page.splits.${page}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0,
        service_checkout,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='01a2661f6b32cf72771b3ff3bc74ebb6'></a>market-front-unified.nginx2.v2.${service_checkout}.dc.page.splits.${dc}.${page}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0,
    service_checkout,
    dc,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.dc.page.splits.%24%7Bdc%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.dc.page.splits.${dc}.${page}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0,
        service_checkout,
        dc,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='e9074c8d90911437497a2e9309938cd0'></a>market-front-unified.nginx2.v2.${service_checkout}.host.page.splits.${host}.${page}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20host%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0,
    service_checkout,
    host,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    host as host,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.host.page.splits.%24%7Bhost%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.host.page.splits.${host}.${page}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0,
        service_checkout,
        host,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        host as host,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='ccfdbb45dd94b533cdad84088c73ba87'></a>market-front-unified.nginx2.v2.${service_checkout}.requester.page.splits.${requester}.${page}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0,
    service_checkout,
    requester,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.requester.page.splits.%24%7Brequester%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.requester.page.splits.${requester}.${page}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0,
        service_checkout,
        requester,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='87819c61fad8b0ad643dfeca394a4b18'></a>market-front-unified.nginx2.v2.${service_checkout}.resolver.splits.${resolver}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_checkout,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.resolver.splits.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.resolver.splits.${resolver}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_checkout,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='48c8a8b26b051b8d2090c69a2438145c'></a>market-front-unified.nginx2.v2.${service_checkout}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_checkout,
    dc,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.dc.resolver.splits.%24%7Bdc%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_checkout,
        dc,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='50f541ede5ebf73d954c446fc8606504'></a>market-front-unified.nginx2.v2.${service_checkout}.host.resolver.splits.${host}.${resolver}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20host%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_checkout,
    host,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    host as host,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.host.resolver.splits.%24%7Bhost%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.host.resolver.splits.${host}.${resolver}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_checkout,
        host,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        host as host,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='7ac1264d3df8fd0ebbc0e94833119c79'></a>market-front-unified.nginx2.v2.${service_checkout}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_checkout,
    requester,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.requester.resolver.splits.%24%7Brequester%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_checkout,
        requester,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='a09285d5df5c37a1ef91a90e83b34855'></a>market-front-unified.nginx2.v2.${service_checkout}.robot.page.splits.${robot}.${page}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id != '') as value_0,
    service_checkout,
    robot,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.robot.page.splits.%24%7Brobot%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.robot.page.splits.${robot}.${page}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id != '') as value_0,
        service_checkout,
        robot,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='4322f1424b46854606897eeec0b6ddc6'></a>market-front-unified.nginx2.v2.${service_checkout}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_checkout,
    robot,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.robot.resolver.splits.%24%7Brobot%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_checkout,
        robot,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='97b4fe6dceebbbe3a5f25702480a0691'></a>market-front-unified.nginx2.v2.${service_checkout}.total.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
    service_checkout,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.total.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.total.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
        service_checkout,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='5121516e3355a05f15e040cad71275bd'></a>market-front-unified.nginx2.v2.${service_checkout}.dc.splits.${dc}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
    service_checkout,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.dc.splits.%24%7Bdc%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.dc.splits.${dc}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
        service_checkout,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='679e546acce7801fe3167469c37bc8d3'></a>market-front-unified.nginx2.v2.${service_checkout}.host.splits.${host}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
    service_checkout,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.host.splits.%24%7Bhost%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.host.splits.${host}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
        service_checkout,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='aa9ab9d03f84ee706c167dff11611826'></a>market-front-unified.nginx2.v2.${service_checkout}.requester.splits.${requester}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
    service_checkout,
    requester,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.requester.splits.%24%7Brequester%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.requester.splits.${requester}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
        service_checkout,
        requester,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='e789f4895be4b5216a88dc5e569158cb'></a>market-front-unified.nginx2.v2.${service_checkout}.resourceType.splits.${resource-type}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
    service_checkout,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.resourceType.splits.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.resourceType.splits.${resource-type}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
        service_checkout,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='a2b58c585971d747481d8dbf1490fcbb'></a>market-front-unified.nginx2.v2.${service_checkout}.requester.dc.splits.${requester}.${dc}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
    service_checkout,
    requester,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.requester.dc.splits.%24%7Brequester%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.requester.dc.splits.${requester}.${dc}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
        service_checkout,
        requester,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='1bde3bd0fb78096f4dd443572afd00ed'></a>market-front-unified.nginx2.v2.${service_checkout}.requester.host.splits.${requester}.${host}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
    service_checkout,
    requester,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.requester.host.splits.%24%7Brequester%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.requester.host.splits.${requester}.${host}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
        service_checkout,
        requester,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='db30c7b68e208fb20463073b639beb75'></a>market-front-unified.nginx2.v2.${service_checkout}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
    service_checkout,
    requester,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.requester.resourceType.splits.%24%7Brequester%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
        service_checkout,
        requester,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='f7f759f774e03f7ceb6449185cbdcf1d'></a>market-front-unified.nginx2.v2.${service_checkout}.robot.splits.${robot}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0,
    service_checkout,
    robot,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.robot.splits.%24%7Brobot%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.robot.splits.${robot}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0,
        service_checkout,
        robot,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='7483ae3c3ff9b2781b48ec32e9e533e3'></a>market-front-unified.nginx2.v2.${service_checkout}.robot.dc.splits.${robot}.${dc}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0,
    service_checkout,
    robot,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.robot.dc.splits.%24%7Brobot%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.robot.dc.splits.${robot}.${dc}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0,
        service_checkout,
        robot,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='2038934153f6318044d8f14fa85eb628'></a>market-front-unified.nginx2.v2.${service_checkout}.robot.host.splits.${robot}.${host}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0,
    service_checkout,
    robot,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.robot.host.splits.%24%7Brobot%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.robot.host.splits.${robot}.${host}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0,
        service_checkout,
        robot,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='c2010d3b6041fc0ef8666aede231ced9'></a>market-front-unified.nginx2.v2.${service_checkout}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0,
    service_checkout,
    robot,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.robot.resourceType.splits.%24%7Brobot%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0,
        service_checkout,
        robot,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='93f911492988cdbab165c01d0c5175ff'></a>market-front-unified.nginx2.v2.${service_checkout}.page.splits.${page}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0,
    service_checkout,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.page.splits.%24%7Bpage%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.page.splits.${page}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0,
        service_checkout,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='c7ae46259f505e702a4d6b53c234fa38'></a>market-front-unified.nginx2.v2.${service_checkout}.dc.page.splits.${dc}.${page}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0,
    service_checkout,
    dc,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.dc.page.splits.%24%7Bdc%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.dc.page.splits.${dc}.${page}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0,
        service_checkout,
        dc,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='a22424871299f0e857ecf5f993b67020'></a>market-front-unified.nginx2.v2.${service_checkout}.host.page.splits.${host}.${page}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20host%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0,
    service_checkout,
    host,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    host as host,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.host.page.splits.%24%7Bhost%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.host.page.splits.${host}.${page}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0,
        service_checkout,
        host,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        host as host,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='878a49e8c2b7edefbe6e336197980d24'></a>market-front-unified.nginx2.v2.${service_checkout}.requester.page.splits.${requester}.${page}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0,
    service_checkout,
    requester,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.requester.page.splits.%24%7Brequester%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.requester.page.splits.${requester}.${page}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0,
        service_checkout,
        requester,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='3f48f0be8ed07b2e11b49f09bcaea1be'></a>market-front-unified.nginx2.v2.${service_checkout}.resolver.splits.${resolver}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_checkout,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.resolver.splits.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.resolver.splits.${resolver}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_checkout,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='49f5f61a1f46a93aca6fdfe39b0a2b05'></a>market-front-unified.nginx2.v2.${service_checkout}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_checkout,
    dc,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.dc.resolver.splits.%24%7Bdc%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_checkout,
        dc,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='0633b4a5a1e8ac13d305d664ae43efc7'></a>market-front-unified.nginx2.v2.${service_checkout}.host.resolver.splits.${host}.${resolver}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20host%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_checkout,
    host,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    host as host,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.host.resolver.splits.%24%7Bhost%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.host.resolver.splits.${host}.${resolver}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_checkout,
        host,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        host as host,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='8e51ec23e7386b7b2875eb0d75525665'></a>market-front-unified.nginx2.v2.${service_checkout}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_checkout,
    requester,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.requester.resolver.splits.%24%7Brequester%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_checkout,
        requester,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='ecb5eab50b17d51f21506927bfa0e308'></a>market-front-unified.nginx2.v2.${service_checkout}.robot.page.splits.${robot}.${page}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id != '') as value_0,
    service_checkout,
    robot,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.robot.page.splits.%24%7Brobot%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.robot.page.splits.${robot}.${page}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id != '') as value_0,
        service_checkout,
        robot,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='9c382a64661cbe86fbfef724073abfa0'></a>market-front-unified.nginx2.v2.${service_checkout}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_checkout,
    robot,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.robot.resolver.splits.%24%7Brobot%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_checkout,
        robot,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='e9133ef4b23691edf4bbe9a892420090'></a>market-front-unified.nginx2.v2.${service_checkout}.total.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
    service_checkout,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.total.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.total.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
        service_checkout,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='54202ba83c22ac8a4fb5cd29dc7cdcb5'></a>market-front-unified.nginx2.v2.${service_checkout}.dc.splits.${dc}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
    service_checkout,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.dc.splits.%24%7Bdc%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.dc.splits.${dc}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
        service_checkout,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='4db40e3c5b81e6edf379ad51390de432'></a>market-front-unified.nginx2.v2.${service_checkout}.host.splits.${host}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
    service_checkout,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.host.splits.%24%7Bhost%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.host.splits.${host}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
        service_checkout,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='1a38a8dc127a07e323c91eb0c1ca2ab1'></a>market-front-unified.nginx2.v2.${service_checkout}.requester.splits.${requester}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
    service_checkout,
    requester,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.requester.splits.%24%7Brequester%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.requester.splits.${requester}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
        service_checkout,
        requester,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='c394773a018de9a47b69344d806b766d'></a>market-front-unified.nginx2.v2.${service_checkout}.resourceType.splits.${resource-type}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
    service_checkout,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.resourceType.splits.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.resourceType.splits.${resource-type}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
        service_checkout,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='cb386c05b94baad4fc59a558cd711f9a'></a>market-front-unified.nginx2.v2.${service_checkout}.requester.dc.splits.${requester}.${dc}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
    service_checkout,
    requester,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.requester.dc.splits.%24%7Brequester%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.requester.dc.splits.${requester}.${dc}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
        service_checkout,
        requester,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='0f83b82f1170c48f17d5d60d6a2fc8ee'></a>market-front-unified.nginx2.v2.${service_checkout}.requester.host.splits.${requester}.${host}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
    service_checkout,
    requester,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.requester.host.splits.%24%7Brequester%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.requester.host.splits.${requester}.${host}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
        service_checkout,
        requester,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='9a1cd4f2f67a1c5c9e77d242c0858984'></a>market-front-unified.nginx2.v2.${service_checkout}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
    service_checkout,
    requester,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.requester.resourceType.splits.%24%7Brequester%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0,
        service_checkout,
        requester,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='428e6f1fb0a4f2a66ef9c22e872354f7'></a>market-front-unified.nginx2.v2.${service_checkout}.robot.splits.${robot}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0,
    service_checkout,
    robot,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.robot.splits.%24%7Brobot%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.robot.splits.${robot}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0,
        service_checkout,
        robot,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='d2b9305eee81add739d96a0ec02112ab'></a>market-front-unified.nginx2.v2.${service_checkout}.robot.dc.splits.${robot}.${dc}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0,
    service_checkout,
    robot,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.robot.dc.splits.%24%7Brobot%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.robot.dc.splits.${robot}.${dc}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0,
        service_checkout,
        robot,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='531af30c3d7f7a25fe96b7e1a8f169db'></a>market-front-unified.nginx2.v2.${service_checkout}.robot.host.splits.${robot}.${host}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0,
    service_checkout,
    robot,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.robot.host.splits.%24%7Brobot%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.robot.host.splits.${robot}.${host}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0,
        service_checkout,
        robot,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='fac1241921276c965591102ba6e0c736'></a>market-front-unified.nginx2.v2.${service_checkout}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0,
    service_checkout,
    robot,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.robot.resourceType.splits.%24%7Brobot%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0,
        service_checkout,
        robot,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='3040ddec60f066c8a924f2e15672b629'></a>market-front-unified.nginx2.v2.${service_checkout}.page.splits.${page}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0,
    service_checkout,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.page.splits.%24%7Bpage%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.page.splits.${page}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0,
        service_checkout,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='f98403b3bb971f0bf34006c5de14afcd'></a>market-front-unified.nginx2.v2.${service_checkout}.dc.page.splits.${dc}.${page}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0,
    service_checkout,
    dc,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.dc.page.splits.%24%7Bdc%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.dc.page.splits.${dc}.${page}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0,
        service_checkout,
        dc,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='956776365d62c5fcc3b560932fad4f40'></a>market-front-unified.nginx2.v2.${service_checkout}.host.page.splits.${host}.${page}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20host%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0,
    service_checkout,
    host,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    host as host,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.host.page.splits.%24%7Bhost%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.host.page.splits.${host}.${page}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0,
        service_checkout,
        host,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        host as host,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='bc17753bfa28889a6b2295632e5986a1'></a>market-front-unified.nginx2.v2.${service_checkout}.requester.page.splits.${requester}.${page}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0,
    service_checkout,
    requester,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.requester.page.splits.%24%7Brequester%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.requester.page.splits.${requester}.${page}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0,
        service_checkout,
        requester,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='ab34649ff0af3e6c966b0f8fcb397914'></a>market-front-unified.nginx2.v2.${service_checkout}.resolver.splits.${resolver}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_checkout,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.resolver.splits.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.resolver.splits.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_checkout,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='76b4e918e651709d76fbb09484b010e8'></a>market-front-unified.nginx2.v2.${service_checkout}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_checkout,
    dc,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.dc.resolver.splits.%24%7Bdc%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_checkout,
        dc,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='a882a2860dd1e32db9cea0d651c4f9d4'></a>market-front-unified.nginx2.v2.${service_checkout}.host.resolver.splits.${host}.${resolver}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20host%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_checkout,
    host,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    host as host,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.host.resolver.splits.%24%7Bhost%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.host.resolver.splits.${host}.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_checkout,
        host,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        host as host,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='d2fe030d0886ca22b8129184aeb47c5d'></a>market-front-unified.nginx2.v2.${service_checkout}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_checkout,
    requester,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.requester.resolver.splits.%24%7Brequester%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_checkout,
        requester,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='72a20d09b29a08ca0a3d676005b9d9ab'></a>market-front-unified.nginx2.v2.${service_checkout}.robot.page.splits.${robot}.${page}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id != '') as value_0,
    service_checkout,
    robot,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.robot.page.splits.%24%7Brobot%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.robot.page.splits.${robot}.${page}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id != '') as value_0,
        service_checkout,
        robot,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='18fce3eca7ae6148b11847a26d5f4b66'></a>market-front-unified.nginx2.v2.${service_checkout}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_checkout%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_checkout,
    robot,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_checkout%7D.robot.resolver.splits.%24%7Brobot%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_checkout%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_checkout%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20%3D%20'checkout.market.yandex.ru'%2C%20'checkout_desktop'%2Cvhost%20%3D%20'm.checkout.market.yandex.ru'%2C%20'checkout_touch'%20%2C%20'undefined_service'%20)%20as%20service_checkout%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_checkout}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_checkout,
        robot,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```


## Overall Diagnostics

### Portion #1

```SQL
SELECT * FROM (
    SELECT 'market-front-unified.nginx2.v2.${service_checkout}.total.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.total.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, code, buckets_ttlb FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.total.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, code, buckets_req_time FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.total.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, code, buckets_handshake FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.total.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, code, buckets_bytes_send FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.dc.splits.${dc}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.dc.splits.${dc}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, dc, code, buckets_ttlb FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.dc.splits.${dc}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, dc, code, buckets_req_time FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.dc.splits.${dc}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, dc, code, buckets_handshake FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.dc.splits.${dc}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, dc, code, buckets_bytes_send FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.host.splits.${host}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.host.splits.${host}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, host, code, buckets_ttlb FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.host.splits.${host}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, host, code, buckets_req_time FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.host.splits.${host}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, host, code, buckets_handshake FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.host.splits.${host}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, host, code, buckets_bytes_send FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.requester.splits.${requester}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, requester, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.requester.splits.${requester}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, requester, code, buckets_ttlb FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.requester.splits.${requester}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, requester, code, buckets_req_time FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.requester.splits.${requester}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, requester, code, buckets_handshake FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.requester.splits.${requester}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, requester, code, buckets_bytes_send FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
) ORDER BY cnt DESC
```
### Portion #2

```SQL
SELECT * FROM (
    SELECT 'market-front-unified.nginx2.v2.${service_checkout}.resourceType.splits.${resource-type}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.resourceType.splits.${resource-type}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, resource_type, code, buckets_ttlb FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.resourceType.splits.${resource-type}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, resource_type, code, buckets_req_time FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.resourceType.splits.${resource-type}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, resource_type, code, buckets_handshake FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.resourceType.splits.${resource-type}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, resource_type, code, buckets_bytes_send FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.requester.dc.splits.${requester}.${dc}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, requester, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.requester.host.splits.${requester}.${host}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, requester, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, requester, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.robot.splits.${robot}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, robot, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.robot.splits.${robot}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, robot, code, buckets_ttlb FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.robot.splits.${robot}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, robot, code, buckets_req_time FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.robot.splits.${robot}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, robot, code, buckets_handshake FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.robot.splits.${robot}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, robot, code, buckets_bytes_send FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.robot.dc.splits.${robot}.${dc}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, robot, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.robot.host.splits.${robot}.${host}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, robot, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, robot, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.page.splits.${page}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.page.splits.${page}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, page, code, buckets_ttlb FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.page.splits.${page}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, page, code, buckets_req_time FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.page.splits.${page}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, page, code, buckets_handshake FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
) ORDER BY cnt DESC
```
### Portion #3

```SQL
SELECT * FROM (
    SELECT 'market-front-unified.nginx2.v2.${service_checkout}.page.splits.${page}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, page, code, buckets_bytes_send FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.dc.page.splits.${dc}.${page}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, dc, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.host.page.splits.${host}.${page}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, host, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, host as host, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.requester.page.splits.${requester}.${page}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, requester, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.resolver.splits.${resolver}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.resolver.splits.${resolver}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, resolver, code, buckets_ttlb FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.resolver.splits.${resolver}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, resolver, code, buckets_req_time FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.resolver.splits.${resolver}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, resolver, code, buckets_handshake FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.resolver.splits.${resolver}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, resolver, code, buckets_bytes_send FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, dc, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.host.resolver.splits.${host}.${resolver}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, host, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, host as host, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, requester, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.robot.page.splits.${robot}.${page}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, robot, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_checkout, robot, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.total.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0, service_checkout, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.dc.splits.${dc}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0, service_checkout, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.host.splits.${host}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0, service_checkout, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.requester.splits.${requester}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0, service_checkout, requester, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.resourceType.splits.${resource-type}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0, service_checkout, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.requester.dc.splits.${requester}.${dc}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0, service_checkout, requester, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
) ORDER BY cnt DESC
```
### Portion #4

```SQL
SELECT * FROM (
    SELECT 'market-front-unified.nginx2.v2.${service_checkout}.requester.host.splits.${requester}.${host}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0, service_checkout, requester, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0, service_checkout, requester, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.robot.splits.${robot}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0, service_checkout, robot, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.robot.dc.splits.${robot}.${dc}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0, service_checkout, robot, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.robot.host.splits.${robot}.${host}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0, service_checkout, robot, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0, service_checkout, robot, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.page.splits.${page}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0, service_checkout, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.dc.page.splits.${dc}.${page}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0, service_checkout, dc, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.host.page.splits.${host}.${page}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0, service_checkout, host, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, host as host, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.requester.page.splits.${requester}.${page}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0, service_checkout, requester, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.resolver.splits.${resolver}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_checkout, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_checkout, dc, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.host.resolver.splits.${host}.${resolver}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_checkout, host, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, host as host, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_checkout, requester, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.robot.page.splits.${robot}.${page}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id != '') as value_0, service_checkout, robot, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_checkout, robot, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.total.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0, service_checkout, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.dc.splits.${dc}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0, service_checkout, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.host.splits.${host}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0, service_checkout, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.requester.splits.${requester}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0, service_checkout, requester, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
) ORDER BY cnt DESC
```
### Portion #5

```SQL
SELECT * FROM (
    SELECT 'market-front-unified.nginx2.v2.${service_checkout}.resourceType.splits.${resource-type}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0, service_checkout, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.requester.dc.splits.${requester}.${dc}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0, service_checkout, requester, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.requester.host.splits.${requester}.${host}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0, service_checkout, requester, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0, service_checkout, requester, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.robot.splits.${robot}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0, service_checkout, robot, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.robot.dc.splits.${robot}.${dc}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0, service_checkout, robot, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.robot.host.splits.${robot}.${host}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0, service_checkout, robot, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0, service_checkout, robot, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.page.splits.${page}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0, service_checkout, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.dc.page.splits.${dc}.${page}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0, service_checkout, dc, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.host.page.splits.${host}.${page}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0, service_checkout, host, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, host as host, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.requester.page.splits.${requester}.${page}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0, service_checkout, requester, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.resolver.splits.${resolver}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_checkout, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_checkout, dc, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.host.resolver.splits.${host}.${resolver}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_checkout, host, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, host as host, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_checkout, requester, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.robot.page.splits.${robot}.${page}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id != '') as value_0, service_checkout, robot, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_checkout, robot, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.total.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0, service_checkout, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.dc.splits.${dc}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0, service_checkout, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
) ORDER BY cnt DESC
```
### Portion #6

```SQL
SELECT * FROM (
    SELECT 'market-front-unified.nginx2.v2.${service_checkout}.host.splits.${host}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0, service_checkout, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.requester.splits.${requester}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0, service_checkout, requester, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.resourceType.splits.${resource-type}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0, service_checkout, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.requester.dc.splits.${requester}.${dc}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0, service_checkout, requester, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.requester.host.splits.${requester}.${host}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0, service_checkout, requester, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0, service_checkout, requester, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.robot.splits.${robot}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0, service_checkout, robot, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.robot.dc.splits.${robot}.${dc}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0, service_checkout, robot, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.robot.host.splits.${robot}.${host}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0, service_checkout, robot, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0, service_checkout, robot, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.page.splits.${page}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0, service_checkout, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.dc.page.splits.${dc}.${page}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0, service_checkout, dc, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.host.page.splits.${host}.${page}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0, service_checkout, host, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, host as host, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.requester.page.splits.${requester}.${page}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0, service_checkout, requester, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.resolver.splits.${resolver}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_checkout, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_checkout, dc, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.host.resolver.splits.${host}.${resolver}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_checkout, host, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, host as host, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_checkout, requester, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.robot.page.splits.${robot}.${page}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id != '') as value_0, service_checkout, robot, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_checkout, robot, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
) ORDER BY cnt DESC
```
### Portion #7

```SQL
SELECT * FROM (
    SELECT 'market-front-unified.nginx2.v2.${service_checkout}.total.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0, service_checkout, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.dc.splits.${dc}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0, service_checkout, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.host.splits.${host}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0, service_checkout, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.requester.splits.${requester}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0, service_checkout, requester, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.resourceType.splits.${resource-type}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0, service_checkout, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.requester.dc.splits.${requester}.${dc}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0, service_checkout, requester, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.requester.host.splits.${requester}.${host}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0, service_checkout, requester, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') as value_0, service_checkout, requester, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.robot.splits.${robot}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0, service_checkout, robot, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.robot.dc.splits.${robot}.${dc}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0, service_checkout, robot, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.robot.host.splits.${robot}.${host}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0, service_checkout, robot, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') as value_0, service_checkout, robot, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.page.splits.${page}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0, service_checkout, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.dc.page.splits.${dc}.${page}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0, service_checkout, dc, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.host.page.splits.${host}.${page}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0, service_checkout, host, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, host as host, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.requester.page.splits.${requester}.${page}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') as value_0, service_checkout, requester, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.resolver.splits.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_checkout, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_checkout, dc, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.host.resolver.splits.${host}.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_checkout, host, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, host as host, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_checkout, requester, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
) ORDER BY cnt DESC
```
### Portion #8

```SQL
SELECT * FROM (
    SELECT 'market-front-unified.nginx2.v2.${service_checkout}.robot.page.splits.${robot}.${page}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id != '') as value_0, service_checkout, robot, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id != '') GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_checkout}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_checkout, robot, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_checkout != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost = 'checkout.market.yandex.ru', 'checkout_desktop',vhost = 'm.checkout.market.yandex.ru', 'checkout_touch' , 'undefined_service' ) as service_checkout, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
) ORDER BY cnt DESC
```

